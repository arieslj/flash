# -- 取SN码
# select
#     sa.clientid
#     ,sa.device_sn_code
# from staff_account sa
# where
#     sa.clientid in ('16203385549921620338555013', '16620382663641662038266366', '865881042765039520032205919528', '869881014003803520044034632552', '16349150961421634915096143', '8621220493684661669995177774', '862122049207003520002018812517', '75b8018421cc5782', '16442814214101644281421411', '16632408955401663240895540', '16553450225111655345022514', '16487274914661648727491466', '16741961444741674196144475', '16775115495741677511549577', '16676588205731667658820575', '12623048393981262304839398', '16629931162381662993116238', '16731725772771673172577283', '16583677563401658367756341', '05cd31000d24ea1c', '16461346685831646134668584', '16611405558281661140555828', '16754329642911675432964298', '358145091489527520033402859409', '111fd3a2441d7851', '16497228350651649722835069', '16621306194021662130619402', '16753084578851675308457886', '16391913922471639191392252', '16712783574371671278357445', '16242808422771624280842283', '16564282304111656428230414', '16689909817651668990981765', '16343661090221634366109023', '16494623011981649462301204', '16665738190271666573819033', '16676583456821667658345682', '16303938607091630393860743', '16702921802831670292180283', '16735740451861673574045194', '860986041711333520002070492327', '16688596221151668859622121', '16592750563171659275056317', '867615049879510520050321942230', '869881013220036520002011471617', 'bed82a8b3181eb4a', '16579641489541657964148970', '21e3404e618968c0', '16768002206061676800220607', '865209047221214520002047159176', '16779385438051677938543805', '16543571638131654357163814', '16549097435811654909743582', '16680421921641668042192176', '869193044147026520050808895046', '16061253345481606125334549', '16487390024041648739002405', '2d1159d6aec3046f', '865209047036455520030506707919', '12623040514791262304051480', '16232856897361623285689737', '16335784299831633578429983', '16345268298841634526829884', '16468224008601646822400861', '16471319970771647131997095', '16784915326031678491532608', '16799228268361679922826836', '8658810443216821670155784809', '16233311342151623331134216', '16310299098651631029909866', '16395643835281639564383529', '16651919083121665191908322', '16760218133291676021813330', '1a3e484ab1a3b9a8', '862122049181042520002023950378', '865881043539326520002083793439', '869881013711307520002011788124', '9001b1bfe5253461', '12623041656351262304165636', '16657346796421665734679643', '16689949529461668994952947', '16707303572861670730357286', '16777172288611677717228871', '564ed869500ae935', '6ca52e01c5a857dc', '861244040631063520002093338135', '863818021418117460007492463416', '865881041046100520030506839236', '865881043083127520002006025693', '869167039774085520030309270420', '869881012276088520002051420875', '869881014205515520002012308236', 'e385f284a06cfff0')
# group by 1,2
# ;


select
    t.staff_info_id
    ,pick.num '日均揽收量 pick up/day'
    ,scan.num '日均交接量 scan/day'
    ,del.num '日均妥投量 delivery/day'
from tmpale.tmp_th_staff_0404 t
left join
    (
        select
            pi.ticket_pickup_staff_info_id
            ,count(distinct pi.pno)/count(distinct date(convert_tz(pi.created_at, '+00:00', '+07:00'))) num
        from fle_staging.parcel_info pi
        join tmpale.tmp_th_staff_0404 t on t.staff_info_id = pi.ticket_pickup_staff_info_id
        where
            pi.created_at >= '2023-02-28 17:00:00'
            and pi.created_at < '2023-03-31 17:00:00'
        group by 1
    ) pick on pick.ticket_pickup_staff_info_id = t.staff_info_id
left join
    (
        select
            pr.staff_info_id
            ,count(distinct pr.pno)/count(distinct date(convert_tz(pr.routed_at, '+00:00', '+07:00'))) num
        from rot_pro.parcel_route pr
        join tmpale.tmp_th_staff_0404 t on t.staff_info_id = pr.staff_info_id
        where
            pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
            and pr.routed_at >= '2023-02-28 17:00:00'
            and pr.routed_at < '2023-03-31 17:00:00'
        group by 1
    ) scan on scan.staff_info_id = t.staff_info_id
left join
    (
        select
            pi.ticket_pickup_staff_info_id
            ,count(distinct pi.pno)/count(distinct date(convert_tz(pi.finished_at, '+00:00', '+07:00'))) num
        from fle_staging.parcel_info pi
        join tmpale.tmp_th_staff_0404 t on t.staff_info_id = pi.ticket_delivery_staff_info_id
        where
            pi.finished_at >= '2023-02-28 17:00:00'
            and pi.finished_at < '2023-03-31 17:00:00'
            and pi.state = 5
        group by 1
    ) del on del.ticket_pickup_staff_info_id = t.staff_info_id

;

select
    pi.ticket_pickup_staff_info_id
#             ,count(distinct pi.pno)/count(distinct date(convert_tz(pi.finished_at, '+00:00', '+07:00'))) num
    ,date(convert_tz(pi.created_at, '+00:00', '+07:00')) date_d
    ,pi.pno
from fle_staging.parcel_info pi
# join tmpale.tmp_th_staff_0404 t on t.staff_info_id = pi.ticket_delivery_staff_info_id
where
    pi.created_at >= '2023-02-28 17:00:00'
    and pi.created_at < '2023-03-31 17:00:00'
#     and pi.state = 5
    and pi.ticket_pickup_staff_info_id = '619414'