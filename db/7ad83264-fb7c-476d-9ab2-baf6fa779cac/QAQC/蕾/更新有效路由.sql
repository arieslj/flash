select
    a.pno
    ,case a.state
        when '1' then '已揽收'
        when '2' then '运输中'
        when '3' then '派送中'
        when '4' then '已滞留'
        when '5' then '已签收'
        when '6' then '疑难件处理中'
        when '7' then '已退件'
        when '8' then '异常关闭'
        when '9' then '已撤销'
    end as `包裹状态`
    ,a.CN_element
    ,convert_tz(a.routed_at, '+00:00', '+08:00') 路由时间
from
    (
        select
            pi.pno
            ,pr.route_action
            ,pr.routed_at
            ,pi.state
            ,ddd.CN_element
            ,row_number() over (partition by pr.pno order by pr.routed_at desc) rk
        from ph_staging.parcel_route pr
        left join ph_staging.parcel_info pi on pi.pno = pr.pno
        left join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.fieldname = 'route_action'
        where
            pr.pno in ('P21022E65D6AD','P21022CJD4DAD','PT210223JQCE5AB','P21022EFUJWAD','P21022DWWYFAD','P21022HGCD2AD','P21022GGSYSAH','P21022FPTPPAD','P21022DNQP3AD','P21022C4DXVAD','P21022EWTCBAD','PT210223NM9C5AD','PT210223RMEH7AC','PT210223NUVE3AC','P21022CPJX6AD','PT210223KPEW3AC','P21022E9RYNAD','P21022DPG1XAH','P21022CW5QTAH','P21022EUZY1AD','PT210223H5PY1AD','P21022B1S2KAD','P21022F5HYZAH','P21022DQPAFAD','P21022F2BPCAD','P21022GDA1QAD','P21022DJJVRAD','P21022FVZHKAD','P21022EUV7WAD','PT210223GDHA9AO','PT210223P5136AC','PT210223MRHX8AC','P21022FN1UVAD','P21022DDANBAD','P21022EYNEPAD','P210228WN1KAD','PT210223S01E2AC','P21022E7DEKAH','P21022DJ0CQAD','P21022FKFPSAD','P21022E3RSWAD','P21022FTGV1AD','P210228XABKAD','P21022F364GAH','P21022BXP7FAD','P21022EA72NAH','P21022DQRCNAD','PT210223BJ4Z6AD','PD21022FPU3DAD','P21022F6R37AD','P21022CA3F3AD','PD21022EGMJDAD','P21022EK1AVAD','PT210223JAV42AD','P21022GGHPWAH','P21022ENV00AD','P21022AXGGUAD','P21022GG4VDAD','PT210223HQ3E8AD','P21022FG54QAD','PT210223GX5C8AD','P21022BS3FBAD','PT611823U3Q01EK','P21022965QUAD','PT210223NUQV7AD','P21022BR0BXAD','P21022E8R8AAH','P21022FT0VKAD','PT210223N0F29AI','P21022E2RTCAD','P21022D3BMVAH','P21022FU09AAH','P21022GH4KTAH','PT210223MV5J0AD','P21022GSVRJAD','P21022FN8ZSAH','PT210223NEEW0AB','P21022C74KGAD','PT210223NJCZ9AD','P21022FM00PAD','P21022ENJECAD','P21022C8UKQAD','PT210223NKSG3AI','P21022B99XNAD','P21022G9P2KAD','P21022F24PRAD','P21022FVZ3XAD','P21022EVE5JAD','P210229JY3UAD','P21022C3M8VAD','PT210223HE7Q2AC','P21022C3DJUAD','PT210223N4711AH','P210228YKA1AD','P21022C0UZ6AD','P21022B1567AD','PT210223GVP64AD','PD21022C7WCCAD','P21022EJ1EWAD','PT210223GEDN5AG','P21022FHTQYAD','P21022ENHDRAD','P21022FDG8SAD','P21022GDP1DAH','P21022DX69JAD','PT6118236A3T4EZ','PT210223MVZD3AD','PT210223NP1E5AJ','PT210223GDEP7AC','PT210223AUFN6AD','P21022EYX12AD','P21022FT6YUAD','P21022FSX46AD','P21022DVJC3AD','P21022FWMPUAD','P21022F190JAH','P21022F83VGAD','P21022F81CWAH','PT210223P0739AD','PD21022FS502AD','P21022CP7PHAD','P21022DK89WAD','P21022FGZSPAH','PT210223MNF17AD','P21022DTDQ1AH','PT210223NK418AB','P21022FHSKUAH','P21022E18PRAD','P21022BC0S7AH','P21022F404DAD','P21022CPJW0AD','P21022CAK7UAD','P21022EUEZEAD','P21022EZU7AAH','PT210223NYB41AB','P21022C5TDHAD','PT210223J59V7AD','PT210223NVMU6AD','PT210223FRHB9AC','P21022DWDZ0AD','PT210223G9WJ0AD','PT210223MY059AD','PT210223REPT4AC','P21022EU9MMAD','PT612523SSE13BE','PT210223NDMF9AB','P21022E6P4AAH','P21022EKDPQAD','P21022FSXG7AH','P21022G53XGAD','PT210223J6W20AD','P21022GASY0AD','P21022FRCB0AD','PT210223MW3W5AD','P21022BRMD9AD','P21022E0R94AD','P21022FJFAWAD','P21022G1KQ5AD','P21022DNSWZAH','P21022DTA08AD','P21022F5ES9AD','PT210223QGUG8AK','P21022FPJ39AF','PT210223N7SZ1AF','P21022D4377AF','P21022F7F37AF','P21022F67TPAF','P21022DCHHPAF','P21022AUB56AF','P21022AVH0XAF','P21022ET2TRAF','P21022F0YJAAE','P21022FW5Y5AF','P21022F5JKCAE','PT211423TUZS0AD','P21022FGS3HAF','P21022GHW3WAE','P21022G241GAE','P21022G1QDCAF','P21022H233SAF','P21022G0FAHAF','PT210223JJR56AE','P21022FJQ4CAF','P21022CE49GAF','P21022GK4CYAF','PT210223EEYB1AF','P21022CQXPQAF','P21022DM9SAAF','P21022F57C9AF','PT211423TUZT2AD')
            and pr.route_action in ('RECEIVED'
           ,'RECEIVE_WAREHOUSE_SCAN'
           ,'SORTING_SCAN'
           ,'DELIVERY_TICKET_CREATION_SCAN'
           ,'ARRIVAL_WAREHOUSE_SCAN'
           ,'SHIPMENT_WAREHOUSE_SCAN'
           ,'DETAIN_WAREHOUSE'
           ,'DELIVERY_CONFIRM'
           ,'DIFFICULTY_HANDOVER'
           ,'DELIVERY_MARKER'
           ,'REPLACE_PNO'
           ,'SEAL'
           ,'UNSEAL'
           ,'PARCEL_HEADLESS_PRINTED'
           ,'STAFF_INFO_UPDATE_WEIGHT'
           ,'STORE_KEEPER_UPDATE_WEIGHT'
           ,'STORE_SORTER_UPDATE_WEIGHT'
           ,'DISCARD_RETURN_BKK'
           ,'DELIVERY_TRANSFER'
           ,'PICKUP_RETURN_RECEIPT'
           ,'FLASH_HOME_SCAN'
           ,'seal.ARRIVAL_WAREHOUSE_SCAN'
           ,'INVENTORY'
           ,'SORTING_SCAN'
           ,'PHONE'
           )
    ) a
where
    a.rk = 1