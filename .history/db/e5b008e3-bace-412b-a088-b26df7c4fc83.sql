select
    pr.pno
    ,convert_tz(pr.routed_at, '+00:00', '+08:00') scan_time
    ,if(coalesce(pi3.cod_enabled, pi.cod_enabled) = 1, 'COD', 'NO_COD') COD_OR_NOT
    ,case pi.state
        when 1 then 'RECEIVED'
        when 2 then 'IN_TRANSIT'
        when 3 then 'DELIVERING'
        when 4 then 'STRANDED'
        when 5 then 'SIGNED'
        when 6 then 'IN_DIFFICULTY'
        when 7 then 'RETURNED'
        when 8 then 'ABNORMAL_CLOSED'
        when 9 then 'CANCEL'
    end shipment_status
    ,pi.returned_pno
    ,case pi2.state
        when 1 then 'RECEIVED'
        when 2 then 'IN_TRANSIT'
        when 3 then 'DELIVERING'
        when 4 then 'STRANDED'
        when 5 then 'SIGNED'
        when 6 then 'IN_DIFFICULTY'
        when 7 then 'RETURNED'
        when 8 then 'ABNORMAL_CLOSED'
        when 9 then 'CANCEL'
    end returned_pno_shipment_status
from ph_staging.parcel_route pr
left join ph_staging.parcel_info pi on pi.pno = pr.pno
left join ph_staging.parcel_info pi2 on pi2.pno = pi.returned_pno
left join ph_staging.parcel_info pi3 on pi3.returned_pno = pi.pno
where
    pr.routed_at >= '2023-07-31 16:00:00'
    and pr.staff_info_id = 160732;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-08-31'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-08-31'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-08-31', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with d as
    (
        select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-08-31'
    )
    , t as
    (
        select
             ds.store_id
            ,ds.pno
            ,ds.stat_date
        from d ds
        left join
            (
                select
                    pr.pno
                    ,ds.stat_date
                    ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
                from ph_staging.parcel_route pr
                join d ds on pr.pno = ds.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                    and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and pr.marker_category in (42,43) ##岛屿,偏远地区
                group by 1,2
            ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
        left join
            (
                select
                   pr.pno
                    ,ds.stat_date
                   ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
                   ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
                from ph_staging.parcel_route pr
                join d ds on ds.pno = pr.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                    and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                    and pr.marker_category in (9,14,70) ##客户改约时间
            ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
        left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
        where
            case
                when pr1.pno is not null then 'N'
                when pr2.pno is not null then 'N'
                when ds1.pno is not null  then 'N'  else 'Y'
            end = 'Y'
    )
    select
        a.stat_date 日期
        ,a.store_id 网点ID
        ,dp.store_name 网点名称
        ,dp.opening_at 开业时间
        ,case
            when dp.region_name in ('Area3', 'Area6') then '彭万松'
            when dp.region_name in ('Area4', 'Area9') then '韩钥'
            when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
            when dp.region_name in ( 'Area8') then '黄勇'
            when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
        end 区域
        ,dp.region_name 大区
        ,dp.piece_name 片区
        ,a.应交接
        ,a.已交接
        ,concat(round(a.交接率*100,2),'%') as 交接率
        ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
        ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
        ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
        ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
        ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
    from
        (
            select
                t1.store_id
                ,t1.stat_date
                ,count(t1.pno) 应交接
                ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
            from t t1
            left join
                (
                    select
                        sc.*
                    from
                        (
                            select
                                pr.pno
                                ,pr.store_id
                                ,pr.store_name
                                ,t1.stat_date
                                ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                            from ph_staging.parcel_route pr
                            join t t1 on t1.pno = pr.pno
                            where
                                pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                               and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                              and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                        ) sc
                    where
                        sc.rk = 1
                ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
            group by 1,2
        ) a
    join
        (
            select
                sd.store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.store_id is not null
            group by 1

            union all

            select
                sd.separation_store_id store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.separation_store_id is not null
            group by 1
        ) sd on sd.store_id = a.store_id
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    where
        dp.store_category in (1,10);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-08-31'
        and pr.routed_at >= date_sub('2023-08-31', interval 8 hour )
        and pr.routed_at < date_add('2023-08-31', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,if(a3.self_staff_num + other_staff_num > coalesce(sdb.code_num, 0),
           case
            when a2.avg_staff_code < 2 then 'A'
            when a2.avg_staff_code >= 2 and a2.avg_staff_code < 3 then 'B'
            when a2.avg_staff_code >= 3 and a2.avg_staff_code < 4 then 'C'
            when a2.avg_staff_code >= 4 then 'D'
        end,
           case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end ) 评级
#         ,a2.code_num
#         ,a2.staff_code_num
#         ,a2.staff_num
#         ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) avg_staff_code
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-31'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-08-31')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-08-31'
        and pi.finished_at >= date_sub('2023-08-31', interval 8 hour )
        and pi.finished_at < date_add('2023-08-31', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-08-31'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
select
    td.pno
    ,ss.name 网点
    ,convert_tz(pi.created_at, '+00:00', '+08:00') 揽收时间
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,case td.state
        when 0 then '待完成'
        when 1 then '已完成'
        when 2 then '已终止'
        when 3 then '已关闭'
    end 任务状态
from ph_staging.ticket_delivery td
left join ph_staging.parcel_info pi on pi.pno = td.pno
left join ph_staging.sys_store ss on ss.id = td.store_id
where
    td.created_at <= '2023-08-31 16:00:00'
    and td.delivery_opt = 4
    and td.state = 0
#     and pi.state = 3
    and td.store_id in ('PH77190100','PH73090800','PH73020100','PH77030100','PH77050A00','PH76120H00','PH74060200','PH76090C00','PH74010100','PH76040A00','PH73030300','PH76190100','PH74120A00','PH75060200','PH51050301','PH47170100','PH51050500','PH49040100','PH51030400','PH51020J00','PH47140200','PH49040102','PH47210100','PH51100100','PH47080301','PH51080100','PH49040101','PH47070A00','PH47200600','PH47120100','PH47150100','PH51080101','PH51120B01','PH45210101','PH45212600','PH50100100','PH46020100','PH45130F00','PH46050101','PH45200H00','PH44020100','PH44180100','PH46150100','PH45210100','PH45010100','PH44010T00','PH50100200','PH45140300','PH14010F00','PH14010F00','PH22130500','PH23100300');
;-- -. . -..- - / . -. - .-. -.--
select
    td.pno
    ,ss.name 网点
    ,convert_tz(pi.created_at, '+00:00', '+08:00') 揽收时间
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,case td.state
        when 0 then '待完成'
        when 1 then '已完成'
        when 2 then '已终止'
        when 3 then '已关闭'
    end 任务状态
from ph_staging.ticket_delivery td
left join ph_staging.parcel_info pi on pi.pno = td.pno
left join ph_staging.sys_store ss on ss.id = td.store_id
where
    td.created_at <= '2023-09-01 16:00:00'
    and td.delivery_opt = 4
    and td.state = 0
#     and pi.state = 3
    and td.store_id in ('PH77190100','PH73090800','PH73020100','PH77030100','PH77050A00','PH76120H00','PH74060200','PH76090C00','PH74010100','PH76040A00','PH73030300','PH76190100','PH74120A00','PH75060200','PH51050301','PH47170100','PH51050500','PH49040100','PH51030400','PH51020J00','PH47140200','PH49040102','PH47210100','PH51100100','PH47080301','PH51080100','PH49040101','PH47070A00','PH47200600','PH47120100','PH47150100','PH51080101','PH51120B01','PH45210101','PH45212600','PH50100100','PH46020100','PH45130F00','PH46050101','PH45200H00','PH44020100','PH44180100','PH46150100','PH45210100','PH45010100','PH44010T00','PH50100200','PH45140300','PH14010F00','PH14010F00','PH22130500','PH23100300');
;-- -. . -..- - / . -. - .-. -.--
select
    td.pno
    ,ss.name 网点
    ,convert_tz(pi.created_at, '+00:00', '+08:00') 揽收时间
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,case td.state
        when 0 then '待完成'
        when 1 then '已完成'
        when 2 then '已终止'
        when 3 then '已关闭'
    end 任务状态
from ph_staging.ticket_delivery td
left join ph_staging.parcel_info pi on pi.pno = td.pno
left join ph_staging.sys_store ss on ss.id = td.store_id
where
    td.created_at <= '2023-09-01 16:00:00'
    and td.delivery_opt = 4
#     and td.state = 0
    and pi.state = 3
    and td.store_id in ('PH77190100','PH73090800','PH73020100','PH77030100','PH77050A00','PH76120H00','PH74060200','PH76090C00','PH74010100','PH76040A00','PH73030300','PH76190100','PH74120A00','PH75060200','PH51050301','PH47170100','PH51050500','PH49040100','PH51030400','PH51020J00','PH47140200','PH49040102','PH47210100','PH51100100','PH47080301','PH51080100','PH49040101','PH47070A00','PH47200600','PH47120100','PH47150100','PH51080101','PH51120B01','PH45210101','PH45212600','PH50100100','PH46020100','PH45130F00','PH46050101','PH45200H00','PH44020100','PH44180100','PH46150100','PH45210100','PH45010100','PH44010T00','PH50100200','PH45140300','PH14010F00','PH14010F00','PH22130500','PH23100300');
;-- -. . -..- - / . -. - .-. -.--
select
    td.pno
    ,ss.name 网点
    ,convert_tz(pi.created_at, '+00:00', '+08:00') 揽收时间
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,case td.state
        when 0 then '待完成'
        when 1 then '已完成'
        when 2 then '已终止'
        when 3 then '已关闭'
    end 任务状态
from ph_staging.ticket_delivery td
left join ph_staging.parcel_info pi on pi.pno = td.pno
left join ph_staging.sys_store ss on ss.id = td.store_id
where
    td.created_at <= date_add(curdate(), interval 1 day )
    and td.delivery_opt = 4
    and td.state = 0
#     and pi.state = 3
    and td.store_id in ('PH77190100','PH73090800','PH73020100','PH77030100','PH77050A00','PH76120H00','PH74060200','PH76090C00','PH74010100','PH76040A00','PH73030300','PH76190100','PH74120A00','PH75060200','PH51050301','PH47170100','PH51050500','PH49040100','PH51030400','PH51020J00','PH47140200','PH49040102','PH47210100','PH51100100','PH47080301','PH51080100','PH49040101','PH47070A00','PH47200600','PH47120100','PH47150100','PH51080101','PH51120B01','PH45210101','PH45212600','PH50100100','PH46020100','PH45130F00','PH46050101','PH45200H00','PH44020100','PH44180100','PH46150100','PH45210100','PH45010100','PH44010T00','PH50100200','PH45140300','PH14010F00','PH14010F00','PH22130500','PH23100300');
;-- -. . -..- - / . -. - .-. -.--
select
    td.pno
    ,ss.name 网点
    ,convert_tz(pi.created_at, '+00:00', '+08:00') 揽收时间
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,case td.state
        when 0 then '待完成'
        when 1 then '已完成'
        when 2 then '已终止'
        when 3 then '已关闭'
    end 任务状态
from ph_staging.ticket_delivery td
left join ph_staging.parcel_info pi on pi.pno = td.pno
left join ph_staging.sys_store ss on ss.id = td.store_id
where
    td.created_at <= date_add(curdate(), interval 1 day )
    and td.delivery_opt = 4
#     and td.state = 0
#     and pi.state = 3
    and td.store_id in ('PH77190100','PH73090800','PH73020100','PH77030100','PH77050A00','PH76120H00','PH74060200','PH76090C00','PH74010100','PH76040A00','PH73030300','PH76190100','PH74120A00','PH75060200','PH51050301','PH47170100','PH51050500','PH49040100','PH51030400','PH51020J00','PH47140200','PH49040102','PH47210100','PH51100100','PH47080301','PH51080100','PH49040101','PH47070A00','PH47200600','PH47120100','PH47150100','PH51080101','PH51120B01','PH45210101','PH45212600','PH50100100','PH46020100','PH45130F00','PH46050101','PH45200H00','PH44020100','PH44180100','PH46150100','PH45210100','PH45010100','PH44010T00','PH50100200','PH45140300','PH14010F00','PH14010F00','PH22130500','PH23100300');
;-- -. . -..- - / . -. - .-. -.--
select
    td.pno
    ,ss.name 网点
    ,convert_tz(pi.created_at, '+00:00', '+08:00') 揽收时间
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,case td.state
        when 0 then '待完成'
        when 1 then '已完成'
        when 2 then '已终止'
        when 3 then '已关闭'
    end 任务状态
from ph_staging.ticket_delivery td
left join ph_staging.parcel_info pi on pi.pno = td.pno
left join ph_staging.sys_store ss on ss.id = td.store_id
where
    td.created_at <= date_sub(date_add(curdate(), interval 1 day ), interval 8 hour )
    and td.delivery_opt = 4
#     and td.state = 0
    and pi.state = 3
    and td.store_id in ('PH77190100','PH73090800','PH73020100','PH77030100','PH77050A00','PH76120H00','PH74060200','PH76090C00','PH74010100','PH76040A00','PH73030300','PH76190100','PH74120A00','PH75060200','PH51050301','PH47170100','PH51050500','PH49040100','PH51030400','PH51020J00','PH47140200','PH49040102','PH47210100','PH51100100','PH47080301','PH51080100','PH49040101','PH47070A00','PH47200600','PH47120100','PH47150100','PH51080101','PH51120B01','PH45210101','PH45212600','PH50100100','PH46020100','PH45130F00','PH46050101','PH45200H00','PH44020100','PH44180100','PH46150100','PH45210100','PH45010100','PH44010T00','PH50100200','PH45140300','PH14010F00','PH14010F00','PH22130500','PH23100300');
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-01'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-01'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-09-01', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with d as
    (
        select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-09-01'
    )
    , t as
    (
        select
             ds.store_id
            ,ds.pno
            ,ds.stat_date
        from d ds
        left join
            (
                select
                    pr.pno
                    ,ds.stat_date
                    ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
                from ph_staging.parcel_route pr
                join d ds on pr.pno = ds.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                    and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and pr.marker_category in (42,43) ##岛屿,偏远地区
                group by 1,2
            ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
        left join
            (
                select
                   pr.pno
                    ,ds.stat_date
                   ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
                   ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
                from ph_staging.parcel_route pr
                join d ds on ds.pno = pr.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                    and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                    and pr.marker_category in (9,14,70) ##客户改约时间
            ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
        left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
        where
            case
                when pr1.pno is not null then 'N'
                when pr2.pno is not null then 'N'
                when ds1.pno is not null  then 'N'  else 'Y'
            end = 'Y'
    )
    select
        a.stat_date 日期
        ,a.store_id 网点ID
        ,dp.store_name 网点名称
        ,dp.opening_at 开业时间
        ,case
            when dp.region_name in ('Area3', 'Area6') then '彭万松'
            when dp.region_name in ('Area4', 'Area9') then '韩钥'
            when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
            when dp.region_name in ( 'Area8') then '黄勇'
            when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
        end 区域
        ,dp.region_name 大区
        ,dp.piece_name 片区
        ,a.应交接
        ,a.已交接
        ,concat(round(a.交接率*100,2),'%') as 交接率
        ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
        ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
        ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
        ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
        ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
    from
        (
            select
                t1.store_id
                ,t1.stat_date
                ,count(t1.pno) 应交接
                ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
            from t t1
            left join
                (
                    select
                        sc.*
                    from
                        (
                            select
                                pr.pno
                                ,pr.store_id
                                ,pr.store_name
                                ,t1.stat_date
                                ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                            from ph_staging.parcel_route pr
                            join t t1 on t1.pno = pr.pno
                            where
                                pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                               and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                              and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                        ) sc
                    where
                        sc.rk = 1
                ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
            group by 1,2
        ) a
    join
        (
            select
                sd.store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.store_id is not null
            group by 1

            union all

            select
                sd.separation_store_id store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.separation_store_id is not null
            group by 1
        ) sd on sd.store_id = a.store_id
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    where
        dp.store_category in (1,10);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-02'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-02'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-09-02', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with d as
    (
        select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-09-02'
    )
    , t as
    (
        select
             ds.store_id
            ,ds.pno
            ,ds.stat_date
        from d ds
        left join
            (
                select
                    pr.pno
                    ,ds.stat_date
                    ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
                from ph_staging.parcel_route pr
                join d ds on pr.pno = ds.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                    and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and pr.marker_category in (42,43) ##岛屿,偏远地区
                group by 1,2
            ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
        left join
            (
                select
                   pr.pno
                    ,ds.stat_date
                   ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
                   ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
                from ph_staging.parcel_route pr
                join d ds on ds.pno = pr.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                    and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                    and pr.marker_category in (9,14,70) ##客户改约时间
            ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
        left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
        where
            case
                when pr1.pno is not null then 'N'
                when pr2.pno is not null then 'N'
                when ds1.pno is not null  then 'N'  else 'Y'
            end = 'Y'
    )
    select
        a.stat_date 日期
        ,a.store_id 网点ID
        ,dp.store_name 网点名称
        ,dp.opening_at 开业时间
        ,case
            when dp.region_name in ('Area3', 'Area6') then '彭万松'
            when dp.region_name in ('Area4', 'Area9') then '韩钥'
            when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
            when dp.region_name in ( 'Area8') then '黄勇'
            when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
        end 区域
        ,dp.region_name 大区
        ,dp.piece_name 片区
        ,a.应交接
        ,a.已交接
        ,concat(round(a.交接率*100,2),'%') as 交接率
        ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
        ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
        ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
        ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
        ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
    from
        (
            select
                t1.store_id
                ,t1.stat_date
                ,count(t1.pno) 应交接
                ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
            from t t1
            left join
                (
                    select
                        sc.*
                    from
                        (
                            select
                                pr.pno
                                ,pr.store_id
                                ,pr.store_name
                                ,t1.stat_date
                                ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                            from ph_staging.parcel_route pr
                            join t t1 on t1.pno = pr.pno
                            where
                                pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                               and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                              and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                        ) sc
                    where
                        sc.rk = 1
                ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
            group by 1,2
        ) a
    join
        (
            select
                sd.store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.store_id is not null
            group by 1

            union all

            select
                sd.separation_store_id store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.separation_store_id is not null
            group by 1
        ) sd on sd.store_id = a.store_id
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    where
        dp.store_category in (1,10);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-02'
        and pr.routed_at >= date_sub('2023-09-02', interval 8 hour )
        and pr.routed_at < date_add('2023-09-02', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,if(a3.self_staff_num + other_staff_num > coalesce(sdb.code_num, 0),
           case
            when a2.avg_staff_code < 2 then 'A'
            when a2.avg_staff_code >= 2 and a2.avg_staff_code < 3 then 'B'
            when a2.avg_staff_code >= 3 and a2.avg_staff_code < 4 then 'C'
            when a2.avg_staff_code >= 4 then 'D'
        end,
           case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end ) 评级
#         ,a2.code_num
#         ,a2.staff_code_num
#         ,a2.staff_num
#         ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) avg_staff_code
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-09-02'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-09-02')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-09-02'
        and pi.finished_at >= date_sub('2023-09-02', interval 8 hour )
        and pi.finished_at < date_add('2023-09-02', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-09-02'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-03'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-03'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-09-03', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with d as
    (
        select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-09-03'
    )
    , t as
    (
        select
             ds.store_id
            ,ds.pno
            ,ds.stat_date
        from d ds
        left join
            (
                select
                    pr.pno
                    ,ds.stat_date
                    ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
                from ph_staging.parcel_route pr
                join d ds on pr.pno = ds.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                    and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and pr.marker_category in (42,43) ##岛屿,偏远地区
                group by 1,2
            ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
        left join
            (
                select
                   pr.pno
                    ,ds.stat_date
                   ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
                   ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
                from ph_staging.parcel_route pr
                join d ds on ds.pno = pr.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                    and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                    and pr.marker_category in (9,14,70) ##客户改约时间
            ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
        left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
        where
            case
                when pr1.pno is not null then 'N'
                when pr2.pno is not null then 'N'
                when ds1.pno is not null  then 'N'  else 'Y'
            end = 'Y'
    )
    select
        a.stat_date 日期
        ,a.store_id 网点ID
        ,dp.store_name 网点名称
        ,dp.opening_at 开业时间
        ,case
            when dp.region_name in ('Area3', 'Area6') then '彭万松'
            when dp.region_name in ('Area4', 'Area9') then '韩钥'
            when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
            when dp.region_name in ( 'Area8') then '黄勇'
            when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
        end 区域
        ,dp.region_name 大区
        ,dp.piece_name 片区
        ,a.应交接
        ,a.已交接
        ,concat(round(a.交接率*100,2),'%') as 交接率
        ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
        ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
        ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
        ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
        ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
    from
        (
            select
                t1.store_id
                ,t1.stat_date
                ,count(t1.pno) 应交接
                ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
            from t t1
            left join
                (
                    select
                        sc.*
                    from
                        (
                            select
                                pr.pno
                                ,pr.store_id
                                ,pr.store_name
                                ,t1.stat_date
                                ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                            from ph_staging.parcel_route pr
                            join t t1 on t1.pno = pr.pno
                            where
                                pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                               and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                              and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                        ) sc
                    where
                        sc.rk = 1
                ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
            group by 1,2
        ) a
    join
        (
            select
                sd.store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.store_id is not null
            group by 1

            union all

            select
                sd.separation_store_id store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.separation_store_id is not null
            group by 1
        ) sd on sd.store_id = a.store_id
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    where
        dp.store_category in (1,10);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-03'
        and pr.routed_at >= date_sub('2023-09-03', interval 8 hour )
        and pr.routed_at < date_add('2023-09-03', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,if(a3.self_staff_num + other_staff_num > coalesce(sdb.code_num, 0),
           case
            when a2.avg_staff_code < 2 then 'A'
            when a2.avg_staff_code >= 2 and a2.avg_staff_code < 3 then 'B'
            when a2.avg_staff_code >= 3 and a2.avg_staff_code < 4 then 'C'
            when a2.avg_staff_code >= 4 then 'D'
        end,
           case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end ) 评级
#         ,a2.code_num
#         ,a2.staff_code_num
#         ,a2.staff_num
#         ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) avg_staff_code
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-09-03'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-09-03')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-09-03'
        and pi.finished_at >= date_sub('2023-09-03', interval 8 hour )
        and pi.finished_at < date_add('2023-09-03', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-09-03'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
SELECT
	plt.`pno`  运单号
    ,plt.created_at 任务生成时间
    ,CONCAT('SSRD',plt.`id`) 任务ID
    ,case plt.`vip_enable`
    when 0 then '普通客户'
    when 1 then 'KAM客户'
    end as 客户类型
    ,plt.`client_id` 客户ID
    ,ss.`name` 始发地
    ,ss1.`name` 目的地
    ,if(plt.`fleet_routeids` is null,'一致','不一致') 解封车是否异常
    ,plt.`fleet_stores` 异常区间
    ,ft.`line_name`  异常车线
    ,plt.`parcel_created_at` 揽收时间
    ,case plt.`last_valid_action`
    when 'ARRIVAL_GOODS_VAN_CHECK_SCAN' then '车货关联到港'
 when 'ARRIVAL_WAREHOUSE_SCAN' then '到件入仓扫描'
 when 'CANCEL_ARRIVAL_WAREHOUSE_SCAN' then '取消到件入仓扫描'
 when 'CANCEL_PARCEL' then '撤销包裹'
 when 'CANCEL_SHIPMENT_WAREHOUSE' then '取消发件出仓'
 when 'CHANGE_PARCEL_CANCEL' then '修改包裹为撤销'
 when 'CHANGE_PARCEL_CLOSE' then '修改包裹为异常关闭'
 when 'CHANGE_PARCEL_IN_TRANSIT' then '修改包裹为运输中'
 when 'CHANGE_PARCEL_INFO' then '修改包裹信息'
 when 'CHANGE_PARCEL_SIGNED' then '修改包裹为签收'
 when 'CLAIMS_CLOSE' then '理赔关闭'
 when 'CLAIMS_COMPLETE' then '理赔完成'
 when 'CLAIMS_CONTACT' then '已联系客户'
 when 'CLAIMS_TRANSFER_CS' then '转交总部cs处理'
 when 'CLOSE_ORDER' then '关闭订单'
 when 'CONTINUE_TRANSPORT' then '疑难件继续配送'
 when 'CREATE_WORK_ORDER' then '创建工单'
 when 'CUSTOMER_CHANGE_PARCEL_INFO' then '客户修改包裹信息'
 when 'CUSTOMER_OPERATING_RETURN' then '客户操作退回寄件人'
 when 'DELIVERY_CONFIRM' then '确认妥投'
 when 'DELIVERY_MARKER' then '派件标记'
 when 'DELIVERY_PICKUP_STORE_SCAN' then '自提取件扫描'
 when 'DELIVERY_TICKET_CREATION_SCAN' then '交接扫描'
 when 'DELIVERY_TRANSFER' then '派件转单'
 when 'DEPARTURE_GOODS_VAN_CK_SCAN' then '车货关联出港'
 when 'DETAIN_WAREHOUSE' then '货件留仓'
 when 'DIFFICULTY_FINISH_INDEMNITY' then '疑难件支付赔偿'
 when 'DIFFICULTY_HANDOVER' then '疑难件交接'
 when 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE' then '疑难件交接货件留仓'
 when 'DIFFICULTY_RE_TRANSIT' then '疑难件退回区域总部/重启运送'
 when 'DIFFICULTY_RETURN' then '疑难件退回寄件人'
 when 'DIFFICULTY_SEAL' then '集包异常'
 when 'DISCARD_RETURN_BKK' then '丢弃包裹的，换单后寄回BKK'
 when 'DISTRIBUTION_INVENTORY' then '分拨盘库'
 when 'DWS_WEIGHT_IMAGE' then 'DWS复秤照片'
 when 'EXCHANGE_PARCEL' then '换货'
 when 'FAKE_CANCEL_HANDLE' then '虚假撤销判责'
 when 'FLASH_HOME_SCAN' then 'FH交接扫描'
 when 'FORCE_TAKE_PHOTO' then '强制拍照路由'
 when 'HAVE_HAIR_SCAN_NO_TO' then '有发无到'
 when 'HURRY_PARCEL' then '催单'
 when 'INCOMING_CALL' then '来电接听'
 when 'INTERRUPT_PARCEL_AND_RETURN' then '中断运输并退回'
 when 'INVENTORY' then '盘库'
 when 'LOSE_PARCEL_TEAM_OPERATION' then '丢失件团队处理'
 when 'MANUAL_REMARK' then '添加备注'
 when 'MISS_PICKUP_HANDLE' then '漏包裹揽收判责'
 when 'MISSING_PARCEL_SCAN' then '丢失件包裹操作'
 when 'NOTICE_LOST_PARTS_TEAM' then '已通知丢失件团队'
 when 'PARCEL_HEADLESS_CLAIMED' then '无头件包裹已认领'
 when 'PARCEL_HEADLESS_PRINTED' then '无头件包裹已打单'
 when 'PENDING_RETURN' then '待退件'
 when 'PHONE' then '电话联系'
 when 'PICK_UP_STORE' then '待自提取件'
 when 'PICKUP_RETURN_RECEIPT' then '签回单揽收'
 when 'PRINTING' then '打印面单'
 when 'QAQC_OPERATION' then 'QAQC判责'
 when 'RECEIVE_WAREHOUSE_SCAN' then '收件入仓'
 when 'RECEIVED' then '已揽收,初始化动作，实际情况并没有作用'
 when 'REFUND_CONFIRM' then '退件妥投'
 when 'REPAIRED' then '上报问题修复路由'
 when 'REPLACE_PNO' then '换单'
 when 'REPLY_WORK_ORDER' then '回复工单'
 when 'REVISION_TIME' then '改约时间'
 when 'SEAL' then '集包'
 when 'SEAL_NUMBER_CHANGE' then '集包件数变化'
 when 'SHIPMENT_WAREHOUSE_SCAN' then '发件出仓扫描'
 when 'SORTER_WEIGHT_IMAGE' then '分拣机复秤照片'
 when 'SORTING_SCAN' then '分拣扫描'
 when 'STAFF_INFO_UPDATE_WEIGHT' then '快递员修改重量'
 when 'STORE_KEEPER_UPDATE_WEIGHT' then '仓管员复秤'
 when 'STORE_SORTER_UPDATE_WEIGHT' then '分拣机复秤'
 when 'SYSTEM_AUTO_RETURN' then '系统自动退件'
 when 'TAKE_PHOTO' then '异常打单拍照'
 when 'THIRD_EXPRESS_ROUTE' then '第三方公司路由'
 when 'THIRD_PARTY_REASON_DETAIN' then '第三方原因滞留'
 when 'TICKET_WEIGHT_IMAGE' then '揽收称重照片'
 when 'TRANSFER_LOST_PARTS_TEAM' then '已转交丢失件团队'
 when 'TRANSFER_QAQC' then '转交QAQC处理'
 when 'UNSEAL' then '拆包'
 when 'UNSEAL_NO_PARCEL' then '上报包裹不在集包里'
 when 'UNSEAL_NOT_SCANNED' then '集包已拆包，本包裹未被扫描'
 when 'VEHICLE_ACCIDENT_REG' then '车辆车祸登记'
 when 'VEHICLE_ACCIDENT_REGISTRATION' then '车辆车祸登记'
 when 'VEHICLE_WET_DAMAGE_REG' then '车辆湿损登记'
 when 'VEHICLE_WET_DAMAGE_REGISTRATION' then '车辆湿损登记'
end as '最后有效路由'
 ,plt.`last_valid_staff_info_id` 最后操作人
 ,ss2.`name` 最后有效路由操作网点
 ,if(plt.`is_abnormal`=1,'是','否')  是否异常
 ,pr.`next_store_name`  下一站点
 ,wo.`order_no` 工单号
 ,case  plt.`source`
        WHEN 1 THEN 'A-问题件-丢失'
        WHEN 2 THEN 'B-记录本-丢失'
        WHEN 3 THEN 'C-包裹状态未更新'
        WHEN 4 THEN 'D-问题件-破损/短少'
        WHEN 5 THEN 'E-记录本-索赔-丢失'
        WHEN 6 THEN 'F-记录本-索赔-破损/短少'
        WHEN 7 THEN 'G-记录本-索赔-其他'
        WHEN 8 THEN 'H-包裹状态未更新-IPC计数'
        WHEN 9 THEN 'I-问题件-外包装破损险'
        WHEN 10 THEN 'J-问题记录本-外包装破损险'
		END AS '问题件来源渠道'
  ,case plt.`state`
  when 1 then '待处理'
  when 2 then '待处理'
  when 3 then '待处理'
  when 4 then '待处理'
  when 5 then '包裹未丢失'
  when 6 then '丢失件处理完成'
  end as '状态'
  ,plt.`operator_id` 处理人
  ,plt.`updated_at` 处理时间
FROM  `ph_bi`.`parcel_lose_task` plt
LEFT JOIN `ph_staging`.`parcel_info`  pi on pi.pno = plt.pno
LEFT JOIN `ph_bi`.`sys_store` ss on ss.id = pi.`ticket_pickup_store_id`
LEFT JOIN `ph_bi`.`sys_store` ss1 on ss1.id = pi.`dst_store_id`
LEFT JOIN `ph_bi`.`sys_store` ss2 on ss2.id = plt.`last_valid_store_id`
LEFT JOIN `ph_staging`.`parcel_route` pr on pr.`pno` = plt.`pno` and pr.`store_id` = plt.`last_valid_store_id`
LEFT JOIN `ph_bi`.`work_order` wo on wo.`loseparcel_task_id` = plt.`id`
LEFT JOIN ph_bi.`fleet_time` ft on ft.`proof_id` =LEFT (plt.`fleet_routeids`,11)
where 1=1 and plt.`state` in (1,2,3,4)
and  DATE_FORMAT(plt.created_at ,'%Y%m%d')=curdate();
;-- -. . -..- - / . -. - .-. -.--
SELECT DISTINCT
	plt.`pno`  运单号
    ,t.cod
    ,t.cogs
	,plt.created_at 任务生成时间
    ,CONCAT('SSRD',plt.`id`) 任务ID
	,case plt.`vip_enable`
    when 0 then '普通客户'
    when 1 then 'KAM客户'
    end as 客户类型
	,case plt.`duty_result`
	when 1 then '丢失'
	when 2 then '破损'
	end as '判责类型'
	,t.`t_value` 原因
	,plt.`client_id` 客户ID
	,if(plt.`fleet_routeids` is null,'一致','不一致') 解封车是否异常
    ,plt.`fleet_stores` 异常区间
    ,ft.`line_name`  异常车线
        ,plt.`parcel_created_at` 揽收时间
    ,case plt.`last_valid_action`
    when 'ARRIVAL_GOODS_VAN_CHECK_SCAN' then '车货关联到港'
 when 'ARRIVAL_WAREHOUSE_SCAN' then '到件入仓扫描'
 when 'CANCEL_ARRIVAL_WAREHOUSE_SCAN' then '取消到件入仓扫描'
 when 'CANCEL_PARCEL' then '撤销包裹'
 when 'CANCEL_SHIPMENT_WAREHOUSE' then '取消发件出仓'
 when 'CHANGE_PARCEL_CANCEL' then '修改包裹为撤销'
 when 'CHANGE_PARCEL_CLOSE' then '修改包裹为异常关闭'
 when 'CHANGE_PARCEL_IN_TRANSIT' then '修改包裹为运输中'
 when 'CHANGE_PARCEL_INFO' then '修改包裹信息'
 when 'CHANGE_PARCEL_SIGNED' then '修改包裹为签收'
 when 'CLAIMS_CLOSE' then '理赔关闭'
 when 'CLAIMS_COMPLETE' then '理赔完成'
 when 'CLAIMS_CONTACT' then '已联系客户'
 when 'CLAIMS_TRANSFER_CS' then '转交总部cs处理'
 when 'CLOSE_ORDER' then '关闭订单'
 when 'CONTINUE_TRANSPORT' then '疑难件继续配送'
 when 'CREATE_WORK_ORDER' then '创建工单'
 when 'CUSTOMER_CHANGE_PARCEL_INFO' then '客户修改包裹信息'
 when 'CUSTOMER_OPERATING_RETURN' then '客户操作退回寄件人'
 when 'DELIVERY_CONFIRM' then '确认妥投'
 when 'DELIVERY_MARKER' then '派件标记'
 when 'DELIVERY_PICKUP_STORE_SCAN' then '自提取件扫描'
 when 'DELIVERY_TICKET_CREATION_SCAN' then '交接扫描'
 when 'DELIVERY_TRANSFER' then '派件转单'
 when 'DEPARTURE_GOODS_VAN_CK_SCAN' then '车货关联出港'
 when 'DETAIN_WAREHOUSE' then '货件留仓'
 when 'DIFFICULTY_FINISH_INDEMNITY' then '疑难件支付赔偿'
 when 'DIFFICULTY_HANDOVER' then '疑难件交接'
 when 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE' then '疑难件交接货件留仓'
 when 'DIFFICULTY_RE_TRANSIT' then '疑难件退回区域总部/重启运送'
 when 'DIFFICULTY_RETURN' then '疑难件退回寄件人'
 when 'DIFFICULTY_SEAL' then '集包异常'
 when 'DISCARD_RETURN_BKK' then '丢弃包裹的，换单后寄回BKK'
 when 'DISTRIBUTION_INVENTORY' then '分拨盘库'
 when 'DWS_WEIGHT_IMAGE' then 'DWS复秤照片'
 when 'EXCHANGE_PARCEL' then '换货'
 when 'FAKE_CANCEL_HANDLE' then '虚假撤销判责'
 when 'FLASH_HOME_SCAN' then 'FH交接扫描'
 when 'FORCE_TAKE_PHOTO' then '强制拍照路由'
 when 'HAVE_HAIR_SCAN_NO_TO' then '有发无到'
 when 'HURRY_PARCEL' then '催单'
 when 'INCOMING_CALL' then '来电接听'
 when 'INTERRUPT_PARCEL_AND_RETURN' then '中断运输并退回'
 when 'INVENTORY' then '盘库'
 when 'LOSE_PARCEL_TEAM_OPERATION' then '丢失件团队处理'
 when 'MANUAL_REMARK' then '添加备注'
 when 'MISS_PICKUP_HANDLE' then '漏包裹揽收判责'
 when 'MISSING_PARCEL_SCAN' then '丢失件包裹操作'
 when 'NOTICE_LOST_PARTS_TEAM' then '已通知丢失件团队'
 when 'PARCEL_HEADLESS_CLAIMED' then '无头件包裹已认领'
 when 'PARCEL_HEADLESS_PRINTED' then '无头件包裹已打单'
 when 'PENDING_RETURN' then '待退件'
 when 'PHONE' then '电话联系'
 when 'PICK_UP_STORE' then '待自提取件'
 when 'PICKUP_RETURN_RECEIPT' then '签回单揽收'
 when 'PRINTING' then '打印面单'
 when 'QAQC_OPERATION' then 'QAQC判责'
 when 'RECEIVE_WAREHOUSE_SCAN' then '收件入仓'
 when 'RECEIVED' then '已揽收,初始化动作，实际情况并没有作用'
 when 'REFUND_CONFIRM' then '退件妥投'
 when 'REPAIRED' then '上报问题修复路由'
 when 'REPLACE_PNO' then '换单'
 when 'REPLY_WORK_ORDER' then '回复工单'
 when 'REVISION_TIME' then '改约时间'
 when 'SEAL' then '集包'
 when 'SEAL_NUMBER_CHANGE' then '集包件数变化'
 when 'SHIPMENT_WAREHOUSE_SCAN' then '发件出仓扫描'
 when 'SORTER_WEIGHT_IMAGE' then '分拣机复秤照片'
 when 'SORTING_SCAN' then '分拣扫描'
 when 'STAFF_INFO_UPDATE_WEIGHT' then '快递员修改重量'
 when 'STORE_KEEPER_UPDATE_WEIGHT' then '仓管员复秤'
 when 'STORE_SORTER_UPDATE_WEIGHT' then '分拣机复秤'
 when 'SYSTEM_AUTO_RETURN' then '系统自动退件'
 when 'TAKE_PHOTO' then '异常打单拍照'
 when 'THIRD_EXPRESS_ROUTE' then '第三方公司路由'
 when 'THIRD_PARTY_REASON_DETAIN' then '第三方原因滞留'
 when 'TICKET_WEIGHT_IMAGE' then '揽收称重照片'
 when 'TRANSFER_LOST_PARTS_TEAM' then '已转交丢失件团队'
 when 'TRANSFER_QAQC' then '转交QAQC处理'
 when 'UNSEAL' then '拆包'
 when 'UNSEAL_NO_PARCEL' then '上报包裹不在集包里'
 when 'UNSEAL_NOT_SCANNED' then '集包已拆包，本包裹未被扫描'
 when 'VEHICLE_ACCIDENT_REG' then '车辆车祸登记'
 when 'VEHICLE_ACCIDENT_REGISTRATION' then '车辆车祸登记'
 when 'VEHICLE_WET_DAMAGE_REG' then '车辆湿损登记'
 when 'VEHICLE_WET_DAMAGE_REGISTRATION' then '车辆湿损登记'
end as '最后有效路由'
 ,ss2.`name` 最后有效路由操作网点
 ,if(plt.`is_abnormal`=1,'是','否')  是否异常
 ,pr.`next_store_name`  下一站点
	,wo.`order_no` 工单号
	,case  plt.`source`
        WHEN 1 THEN 'A-问题件-丢失'
        WHEN 2 THEN 'B-记录本-丢失'
        WHEN 3 THEN 'C-包裹状态未更新'
        WHEN 4 THEN 'D-问题件-破损/短少'
        WHEN 5 THEN 'E-记录本-索赔-丢失'
        WHEN 6 THEN 'F-记录本-索赔-破损/短少'
        WHEN 7 THEN 'G-记录本-索赔-其他'
        WHEN 8 THEN 'H-包裹状态未更新-IPC计数'
        WHEN 9 THEN 'I-问题件-外包装破损险'
        WHEN 10 THEN 'J-问题记录本-外包装破损险'
		END AS '问题件来源渠道'
	,case plt.`state`
	when 5 then '无需追责'
	when 6 then '责任人已认定'
	end  状态
	,plt.`operator_id` 处理人
	,plt.`updated_at` 处理时间
	,case if(plt.state= 6,pld.`duty_type`,null)
	when 1 then	'快递员100%套餐'
	when 10	 then	'双黄套餐(计数网点仓管40%计数网点主管10%对接分拨仓管40%对接分拨主管10%)'
	when 19	 then	'双黄套餐(计数网点仓管40%计数网点主管10%对接分拨仓管40%对接分拨主管10%)'
	when 2	 then	'仓9主1套餐(仓管90%主管10%)'
	when 20	 then	'加盟商双黄套餐（加盟商50%网点仓管45%主管5%)'
	when 3	 then	'仓9主1套餐(仓管90%主管10%)'
	when 4	 then	'双黄套餐(A网点仓管40%主管10%B网点仓管40%主管10%)'
	when 5	 then	'快递员721套餐(快递员70%仓管20%主管10%)'
	when 6	 then	'仓管721套餐(仓管70%快递员20%主管10%)'
	when 7	 then	'其他(仅勾选“该运单的责任人需要特殊处理”时才能使用该项)'
	when 8	 then	'LH全责（LH100%)'
	when 9	 then	'加盟商套餐'
	end as '套餐'
	,group_concat(distinct ss3.name) 责任网点
FROM  `ph_bi`.`parcel_lose_task` plt
LEFT JOIN `ph_staging`.`parcel_info`  pi on pi.pno = plt.pno
LEFT JOIN `ph_bi`.`sys_store` ss on ss.id = pi.`ticket_pickup_store_id`
LEFT JOIN `ph_bi`.`sys_store` ss1 on ss1.id = pi.`dst_store_id`
LEFT JOIN `ph_bi`.`sys_store` ss2 on ss2.id = plt.`last_valid_store_id`
LEFT JOIN `ph_staging`.`parcel_route` pr on pr.`pno` = plt.`pno` and pr.`store_id` = plt.`last_valid_store_id`
LEFT JOIN `ph_bi`.`work_order` wo on wo.`loseparcel_task_id` = plt.`id`
LEFT JOIN `ph_bi`.`fleet_time` ft on ft.`proof_id` =LEFT (plt.`fleet_routeids`,11)
LEFT JOIN `ph_bi`.`parcel_lose_stat_detail` pld on pld. `lose_task_id`=plt.`id`
LEFT JOIN `ph_bi`.`parcel_lose_responsible` plr on plr.`lose_task_id`=plt.`id`
LEFT JOIN `ph_bi`.`sys_store` ss3 on ss3.id = plr.store_id
LEFT JOIN `ph_bi`.`translations` t ON plt.duty_reasons = t.t_key AND t.`lang` = 'zh-CN'
join tmpale.tmp_ph_pno_lj_0904 t on t.pno = plt.pno
where
    1=1
    and plt.`state` in (5,6)
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    pr.pno
    ,pi.cod_amount/100 cod
from ph_staging.parcel_route pr
left join ph_staging.parcel_info pi on pi.pno = pr.pno
where
    pr.staff_info_id = '145208'
    and pr.routed_at > '2023-08-31 16:00:00'
    and pr.routed_at < '2023-09-01 16:00:00';
;-- -. . -..- - / . -. - .-. -.--
select
    pr.pno
    ,pi.cod_amount/100 cod
from ph_staging.parcel_route pr
left join ph_staging.parcel_info pi on pi.pno = pr.pno
where
    pr.staff_info_id = '145208'
    and pr.routed_at > '2023-08-31 16:00:00'
    and pr.routed_at < '2023-09-01 16:00:00'
    and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
group by 1,2;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-04'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 10
                    or (t1.total =  5 and t1.leave_time_type = 2)

                union all

                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 5
                    and t1.leave_time_type = 1 -- 上午请假
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-04'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 10
                                    or (t1.total =  5 and t1.leave_time_type = 2)

                                union all

                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 5
                                    and t1.leave_time_type = 1 -- 上午请假
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-09-04', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with d as
    (
        select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-09-04'
    )
    , t as
    (
        select
             ds.store_id
            ,ds.pno
            ,ds.stat_date
        from d ds
        left join
            (
                select
                    pr.pno
                    ,ds.stat_date
                    ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
                from ph_staging.parcel_route pr
                join d ds on pr.pno = ds.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                    and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and pr.marker_category in (42,43) ##岛屿,偏远地区
                group by 1,2
            ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
        left join
            (
                select
                   pr.pno
                    ,ds.stat_date
                   ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
                   ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
                from ph_staging.parcel_route pr
                join d ds on ds.pno = pr.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                    and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                    and pr.marker_category in (9,14,70) ##客户改约时间
            ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
        left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
        where
            case
                when pr1.pno is not null then 'N'
                when pr2.pno is not null then 'N'
                when ds1.pno is not null  then 'N'  else 'Y'
            end = 'Y'
    )
    select
        a.stat_date 日期
        ,a.store_id 网点ID
        ,dp.store_name 网点名称
        ,dp.opening_at 开业时间
        ,case
            when dp.region_name in ('Area3', 'Area6') then '彭万松'
            when dp.region_name in ('Area4', 'Area9') then '韩钥'
            when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
            when dp.region_name in ( 'Area8') then '黄勇'
            when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
        end 区域
        ,dp.region_name 大区
        ,dp.piece_name 片区
        ,a.应交接
        ,a.已交接
        ,concat(round(a.交接率*100,2),'%') as 交接率
        ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
        ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
        ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
        ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
        ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
    from
        (
            select
                t1.store_id
                ,t1.stat_date
                ,count(t1.pno) 应交接
                ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
            from t t1
            left join
                (
                    select
                        sc.*
                    from
                        (
                            select
                                pr.pno
                                ,pr.store_id
                                ,pr.store_name
                                ,t1.stat_date
                                ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                            from ph_staging.parcel_route pr
                            join t t1 on t1.pno = pr.pno
                            where
                                pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                               and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                              and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                        ) sc
                    where
                        sc.rk = 1
                ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
            group by 1,2
        ) a
    join
        (
            select
                sd.store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.store_id is not null
            group by 1

            union all

            select
                sd.separation_store_id store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.separation_store_id is not null
            group by 1
        ) sd on sd.store_id = a.store_id
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    where
        dp.store_category in (1,10);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-04'
        and pr.routed_at >= date_sub('2023-09-04', interval 8 hour )
        and pr.routed_at < date_add('2023-09-04', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,if(a3.self_staff_num + other_staff_num > coalesce(sdb.code_num, 0),
           case
            when a2.avg_staff_code < 2 then 'A'
            when a2.avg_staff_code >= 2 and a2.avg_staff_code < 3 then 'B'
            when a2.avg_staff_code >= 3 and a2.avg_staff_code < 4 then 'C'
            when a2.avg_staff_code >= 4 then 'D'
        end,
           case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end ) 评级
#         ,a2.code_num
#         ,a2.staff_code_num
#         ,a2.staff_num
#         ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) avg_staff_code
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-09-04'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-09-04')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-09-04'
        and pi.finished_at >= date_sub('2023-09-04', interval 8 hour )
        and pi.finished_at < date_add('2023-09-04', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-09-04'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
select
    *
from
    (
                select
            pr.pno
            ,ps.third_sorting_code
            ,row_number() over (partition by pr.pno order by ps.created_at desc ) rk
        from ph_staging.parcel_route pr
        join ph_drds.parcel_sorting_code_info ps on ps.pno = pr.pno
        where
            pr.staff_info_id = '159022'
            and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    ) a
where
    a.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
select
    *
from
    (
                select
            pr.pno
            ,ps.third_sorting_code
            ,row_number() over (partition by pr.pno order by ps.created_at desc ) rk
        from ph_staging.parcel_route pr
        join ph_drds.parcel_sorting_code_info ps on ps.pno = pr.pno
        where
            pr.staff_info_id = '159022'
            and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
            and pr.routed_at >= '2023-09-03 16:00:00'
            and pr.routed_at < '2023-09-04 16:00:00'
    ) a
where
    a.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
select
    *
from  tmpale.tmp_th_tgt_pop;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-05'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 10
                    or (t1.total =  5 and t1.leave_time_type = 2)

                union all

                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 5
                    and t1.leave_time_type = 1 -- 上午请假
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-05'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 10
                                    or (t1.total =  5 and t1.leave_time_type = 2)

                                union all

                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 5
                                    and t1.leave_time_type = 1 -- 上午请假
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-09-05', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-09-05';
;-- -. . -..- - / . -. - .-. -.--
with d as
    (
        select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-09-05'
    )
    , t as
    (
        select
             ds.store_id
            ,ds.pno
            ,ds.stat_date
        from d ds
        left join
            (
                select
                    pr.pno
                    ,ds.stat_date
                    ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
                from ph_staging.parcel_route pr
                join d ds on pr.pno = ds.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                    and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and pr.marker_category in (42,43) ##岛屿,偏远地区
                group by 1,2
            ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
        left join
            (
                select
                   pr.pno
                    ,ds.stat_date
                   ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
                   ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
                from ph_staging.parcel_route pr
                join d ds on ds.pno = pr.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                    and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                    and pr.marker_category in (9,14,70) ##客户改约时间
            ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
        left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
        where
            case
                when pr1.pno is not null then 'N'
                when pr2.pno is not null then 'N'
                when ds1.pno is not null  then 'N'  else 'Y'
            end = 'Y'
    )
    select
        a.stat_date 日期
        ,a.store_id 网点ID
        ,dp.store_name 网点名称
        ,dp.opening_at 开业时间
        ,case
            when dp.region_name in ('Area3', 'Area6') then '彭万松'
            when dp.region_name in ('Area4', 'Area9') then '韩钥'
            when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
            when dp.region_name in ( 'Area8') then '黄勇'
            when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
        end 区域
        ,dp.region_name 大区
        ,dp.piece_name 片区
        ,a.应交接
        ,a.已交接
        ,concat(round(a.交接率*100,2),'%') as 交接率
        ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
        ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
        ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
        ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
        ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
    from
        (
            select
                t1.store_id
                ,t1.stat_date
                ,count(t1.pno) 应交接
                ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
            from t t1
            left join
                (
                    select
                        sc.*
                    from
                        (
                            select
                                pr.pno
                                ,pr.store_id
                                ,pr.store_name
                                ,t1.stat_date
                                ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                            from ph_staging.parcel_route pr
                            join t t1 on t1.pno = pr.pno
                            where
                                pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                               and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                              and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                        ) sc
                    where
                        sc.rk = 1
                ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
            group by 1,2
        ) a
    join
        (
            select
                sd.store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.store_id is not null
            group by 1

            union all

            select
                sd.separation_store_id store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.separation_store_id is not null
            group by 1
        ) sd on sd.store_id = a.store_id
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    where
        dp.store_category in (1,10);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-05'
        and pr.routed_at >= date_sub('2023-09-05', interval 8 hour )
        and pr.routed_at < date_add('2023-09-05', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,if(a3.self_staff_num + other_staff_num > coalesce(sdb.code_num, 0),
           case
            when a2.avg_staff_code < 2 then 'A'
            when a2.avg_staff_code >= 2 and a2.avg_staff_code < 3 then 'B'
            when a2.avg_staff_code >= 3 and a2.avg_staff_code < 4 then 'C'
            when a2.avg_staff_code >= 4 then 'D'
        end,
           case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end ) 评级
#         ,a2.code_num
#         ,a2.staff_code_num
#         ,a2.staff_num
#         ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) avg_staff_code
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-09-05'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-09-05')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-09-05'
        and pi.finished_at >= date_sub('2023-09-05', interval 8 hour )
        and pi.finished_at < date_add('2023-09-05', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-09-05'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
select
    case
        when bc.`client_id` is not null then bc.client_name
        when kp.id is not null and bc.id is null then '普通ka'
        when kp.`id` is null then '小c'
    end as 客户类型
    ,plt.updated_at 判责时间
    ,plt.pno
    ,case plt.source
        WHEN 1 THEN 'A-问题件-丢失'
        WHEN 2 THEN 'B-记录本-丢失'
        WHEN 3 THEN 'C-包裹状态未更新'
        WHEN 4 THEN 'D-问题件-破损/短少'
        WHEN 5 THEN 'E-记录本-索赔-丢失'
        WHEN 6 THEN 'F-记录本-索赔-破损/短少'
        WHEN 7 THEN 'G-记录本-索赔-其他'
        WHEN 8 THEN 'H-包裹状态未更新-IPC计数'
        WHEN 9 THEN 'I-问题件-外包装破损险'
        WHEN 10 THEN 'J-问题记录本-外包装破损险'
        when 11 then 'K-超时效包裹'
        when 12 then 'L-高度疑似丢失'
    end 问题来源渠道
    ,ss.name 责任网点
from ph_bi.parcel_lose_task plt
left join ph_bi.parcel_lose_responsible plr on plr.lose_task_id = plt.id
left join ph_staging.ka_profile kp on kp.id = plt.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = plt.client_id
left join ph_staging.sys_store ss on ss.id = plr.store_id
where
    plt.state = 6
    and plt.updated_at >= '2023-06-01'
    and plt.updated_at < '2023-09-01'
    and ss.category = 6
group by 1,2,3,4;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-06'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 10
                    or (t1.total =  5 and t1.leave_time_type = 2)

                union all

                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 5
                    and t1.leave_time_type = 1 -- 上午请假
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-06'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 10
                                    or (t1.total =  5 and t1.leave_time_type = 2)

                                union all

                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 5
                                    and t1.leave_time_type = 1 -- 上午请假
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-09-06', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with d as
    (
        select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-09-06'
    )
    , t as
    (
        select
             ds.store_id
            ,ds.pno
            ,ds.stat_date
        from d ds
        left join
            (
                select
                    pr.pno
                    ,ds.stat_date
                    ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
                from ph_staging.parcel_route pr
                join d ds on pr.pno = ds.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                    and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and pr.marker_category in (42,43) ##岛屿,偏远地区
                group by 1,2
            ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
        left join
            (
                select
                   pr.pno
                    ,ds.stat_date
                   ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
                   ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
                from ph_staging.parcel_route pr
                join d ds on ds.pno = pr.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                    and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                    and pr.marker_category in (9,14,70) ##客户改约时间
            ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
        left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
        where
            case
                when pr1.pno is not null then 'N'
                when pr2.pno is not null then 'N'
                when ds1.pno is not null  then 'N'  else 'Y'
            end = 'Y'
    )
    select
        a.stat_date 日期
        ,a.store_id 网点ID
        ,dp.store_name 网点名称
        ,dp.opening_at 开业时间
        ,case
            when dp.region_name in ('Area3', 'Area6') then '彭万松'
            when dp.region_name in ('Area4', 'Area9') then '韩钥'
            when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
            when dp.region_name in ( 'Area8') then '黄勇'
            when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
        end 区域
        ,dp.region_name 大区
        ,dp.piece_name 片区
        ,a.应交接
        ,a.已交接
        ,concat(round(a.交接率*100,2),'%') as 交接率
        ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
        ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
        ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
        ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
        ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
    from
        (
            select
                t1.store_id
                ,t1.stat_date
                ,count(t1.pno) 应交接
                ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
            from t t1
            left join
                (
                    select
                        sc.*
                    from
                        (
                            select
                                pr.pno
                                ,pr.store_id
                                ,pr.store_name
                                ,t1.stat_date
                                ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                            from ph_staging.parcel_route pr
                            join t t1 on t1.pno = pr.pno
                            where
                                pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                               and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                              and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                        ) sc
                    where
                        sc.rk = 1
                ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
            group by 1,2
        ) a
    join
        (
            select
                sd.store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.store_id is not null
            group by 1

            union all

            select
                sd.separation_store_id store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.separation_store_id is not null
            group by 1
        ) sd on sd.store_id = a.store_id
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    where
        dp.store_category in (1,10);
;-- -. . -..- - / . -. - .-. -.--


    ,ifnull(tt.1pai_hour_8_fished_counts/tt.1pai_counts,0) 一派8点前扫描占比
    ,ifnull(tt.1pai_hour_8ban_fished_counts/tt.1pai_counts,0) 一派8点半前扫描占比
    ,ifnull(tt.1pai_hour_9_fished_counts/tt.1pai_counts,0) 一派9点前扫描占比
    ,ifnull(tt.1pai_hour_9ban_fished_counts/tt.1pai_counts,0) 一派9点半前扫描占比
	,if(tt2.late_proof_counts is null , '否', '是') 是否有迟到超过规划时间20分钟的常规车
    ,tt2.max_real_arrive_time_normal 一派常规车最晚实际到达时间
#     ,tt2.max_real_arrive_proof_id 一派常规车最晚实际到达车线
#     ,tt2.max_real_arrive_vol 一派常规车最晚实际到达车线包裹量
    ,tt2.line_1_latest_plan_arrive_time 一派常规车最晚规划到达时间
    ,tt2.max_real_arrive_time_innormal 一派加班车最晚实际到达时间
#     ,tt2.max_real_arrive_innormal_proof_id  一派加班车最晚实际到达车线
#     ,tt2.max_real_arrive_innormal_vol  一派加班车最晚实际到达包裹量
    ,tt2.max_actual_plan_arrive_time_innormal 一派加班车最晚规划到达时间


from
(
    select
       base.store_id
       ,base.store_name
       ,base.store_type
       ,base.piece_name
       ,base.region_name
       ,count(distinct base.pno) shoud_counts
       ,count(distinct case when base.min_fenjian_scan_time is not null then base.pno else null end ) scan_fished_counts
       ,count(distinct case when base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then base.pno else null end ) youxiao_counts

       ,count(distinct case when base.type='一派' then  base.pno else null end ) 1pai_counts
       ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null then  base.pno else null end ) 1pai_scan_fished_counts
       ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then  base.pno else null end ) 1pai_youxiao_counts

       ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:00:00' then base.pno else null end) 1pai_hour_8_fished_counts
       ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:30:00' then base.pno else null end) 1pai_hour_8ban_fished_counts
       ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:00:00' then base.pno else null end) 1pai_hour_9_fished_counts
       ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:30:00' then base.pno else null end) 1pai_hour_9ban_fished_counts

    from
    (
       select
       t.*,
       case when t.should_delevry_type='1派应派包裹' then '一派' else null end 'type'
       from dwm.dwd_ph_dc_should_be_delivery_sort_scan t
       join ph_staging.sys_store ss
       on t.store_id =ss.id
    ) base
    group by base.store_id,base.store_name,base.store_type,base.piece_name,base.region_name
) tt

left join
(
    select
       bl.store_id
       ,bl.max_real_arrive_time_normal
       ,bl.max_real_arrive_proof_id
       ,bl.max_real_arrive_vol
       ,bl.line_1_latest_plan_arrive_time
       ,bl.max_actual_plan_arrive_time_innormal
       ,bl.max_actual_plan_arrive_innormal_proof_id
       ,bl.max_actual_plan_arrive_innormal_vol
       ,bl.max_real_arrive_time_innormal
       ,bl.max_real_arrive_innormal_proof_id
       ,bl.max_real_arrive_innormal_vol
	   ,late_proof_counts
    from dwm.fleet_real_detail_today bl
    group by 1,2,3,4,5,6,7,8,9,10,11
) tt2 on tt.store_id=tt2.store_id;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-06'
        and pr.routed_at >= date_sub('2023-09-06', interval 8 hour )
        and pr.routed_at < date_add('2023-09-06', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,if(a3.self_staff_num + other_staff_num > coalesce(sdb.code_num, 0),
           case
            when a2.avg_staff_code < 2 then 'A'
            when a2.avg_staff_code >= 2 and a2.avg_staff_code < 3 then 'B'
            when a2.avg_staff_code >= 3 and a2.avg_staff_code < 4 then 'C'
            when a2.avg_staff_code >= 4 then 'D'
        end,
           case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end ) 评级
#         ,a2.code_num
#         ,a2.staff_code_num
#         ,a2.staff_num
#         ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) avg_staff_code
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-09-06'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-09-06')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-09-06'
        and pi.finished_at >= date_sub('2023-09-06', interval 8 hour )
        and pi.finished_at < date_add('2023-09-06', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-09-06'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        pi.pno
        ,case
            when bc.`client_id` is not null then bc.client_name
            when kp.id is not null and bc.client_id is null then '普通ka'
            when kp.`id` is null then '小c'
        end as client_type
        ,ss.name pick_store
        ,ss.id storeid
    from ph_staging.parcel_info pi
    left join ph_staging.sys_store ss on ss.id = pi.ticket_pickup_store_id
    left join ph_staging.ka_profile kp on kp.id = pi.client_id
    left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
    where
        pi.created_at >= '2023-05-31 16:00:00'
        and pi.created_at < '2023-08-31 16:00:00'
        and ss.category = 6 -- FH
        and pi.state < 9
),
res as
    (
        select
            t1.*
            ,min(pr.routed_at) min_route_at
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno and pr.route_action = 'RECEIVE_WAREHOUSE_SCAN' and pr.store_id = t1.storeid
        where
            pr.routed_at > '2023-05-31 16:00:00'
        group by t1.pno
    )

select
    t1.pno 包裹
    ,t1.client_type 客户类型
    ,t1.pick_store 揽收网点
    ,convert_tz(t2.min_route_at, '+00:00', '+08:00')  收件入仓时间
    ,a.route_action 收件入仓后第一个有效路由
    ,convert_tz(a.routed_at, '+00:00', '+08:00')  收件入仓后第一个有效路由时间
    ,case
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 < 24 then 0
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 >= 24 and timestampdiff(minute , t2.min_route_at, a.routed_at)/60 < 48 then 1
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 >= 48 and timestampdiff(minute , t2.min_route_at, a.routed_at)/60 < 72 then 2
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 > 72 then 3
     end 收件入仓与后续第一个路由时间差
from t t1
left join res t2 on t2.pno = t1.pno
left join
    (
        select
            t2.*
            ,pr.route_action
            ,pr.routed_at
            ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        from ph_staging.parcel_route pr
        join res t2 on t2.pno = pr.pno
        join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action
        where
            pr.routed_at > t2.min_route_at
            and pr.routed_at > '2023-05-31 16:00:00'
    ) a on a.pno = t1.pno and a.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        pi.pno
        ,case
            when bc.`client_id` is not null then bc.client_name
            when kp.id is not null and bc.client_id is null then '普通ka'
            when kp.`id` is null then '小c'
        end as client_type
        ,ss.name pick_store
        ,ss.id storeid
    from ph_staging.parcel_info pi
    left join ph_staging.sys_store ss on ss.id = pi.ticket_pickup_store_id
    left join ph_staging.ka_profile kp on kp.id = pi.client_id
    left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
    where
        pi.created_at >= '2023-05-31 16:00:00'
        and pi.created_at < '2023-08-31 16:00:00'
        and ss.category = 6 -- FH
        and pi.state < 9
),
res as
    (
        select
            t1.*
            ,min(pr.routed_at) min_route_at
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno and pr.route_action = 'RECEIVE_WAREHOUSE_SCAN' and pr.store_id = t1.storeid
        where
            pr.routed_at > '2023-05-31 16:00:00'
        group by 1,2,3,4
    )

select
    t1.pno 包裹
    ,t1.client_type 客户类型
    ,t1.pick_store 揽收网点
    ,convert_tz(t2.min_route_at, '+00:00', '+08:00')  收件入仓时间
    ,a.route_action 收件入仓后第一个有效路由
    ,convert_tz(a.routed_at, '+00:00', '+08:00')  收件入仓后第一个有效路由时间
    ,case
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 < 24 then 0
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 >= 24 and timestampdiff(minute , t2.min_route_at, a.routed_at)/60 < 48 then 1
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 >= 48 and timestampdiff(minute , t2.min_route_at, a.routed_at)/60 < 72 then 2
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 > 72 then 3
     end 收件入仓与后续第一个路由时间差
from t t1
left join res t2 on t2.pno = t1.pno
left join
    (
        select
            t2.*
            ,pr.route_action
            ,pr.routed_at
            ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        from ph_staging.parcel_route pr
        join res t2 on t2.pno = pr.pno
        join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action
        where
            pr.routed_at > t2.min_route_at
            and pr.routed_at > '2023-05-31 16:00:00'
    ) a on a.pno = t1.pno and a.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        pi.pno
        ,case
            when bc.`client_id` is not null then bc.client_name
            when kp.id is not null and bc.client_id is null then '普通ka'
            when kp.`id` is null then '小c'
        end as client_type
        ,ss.name pick_store
        ,ss.id storeid
    from ph_staging.parcel_info pi
    left join ph_staging.sys_store ss on ss.id = pi.ticket_pickup_store_id
    left join ph_staging.ka_profile kp on kp.id = pi.client_id
    left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
    where
        pi.created_at >= '2023-05-31 16:00:00'
        and pi.created_at < '2023-08-31 16:00:00'
        and ss.category = 6 -- FH
        and pi.state < 9
),
res as
    (
        select
            t1.*
            ,min(pr.routed_at) min_route_at
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno and pr.route_action = 'RECEIVE_WAREHOUSE_SCAN' and pr.store_id = t1.storeid
        where
            pr.routed_at > '2023-05-31 16:00:00'
        group by 1,2,3,4
    )

select
    t1.pno 包裹
    ,t1.client_type 客户类型
    ,t1.pick_store 揽收网点
    ,convert_tz(t2.min_route_at, '+00:00', '+08:00')  收件入仓时间
    ,a.route_action 收件入仓后第一个有效路由
    ,a.store_name 收件入仓后第一个有效路由网点
    ,convert_tz(a.routed_at, '+00:00', '+08:00')  收件入仓后第一个有效路由时间
    ,case
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 < 24 then 0
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 >= 24 and timestampdiff(minute , t2.min_route_at, a.routed_at)/60 < 48 then 1
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 >= 48 and timestampdiff(minute , t2.min_route_at, a.routed_at)/60 < 72 then 2
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 > 72 then 3
     end 收件入仓与后续第一个路由时间差
from t t1
left join res t2 on t2.pno = t1.pno
left join
    (
        select
            t2.*
            ,pr.route_action
            ,pr.store_id pr_store_id
            ,pr.store_name
            ,pr.routed_at
            ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        from ph_staging.parcel_route pr
        join res t2 on t2.pno = pr.pno
        join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action
        where
            pr.routed_at > t2.min_route_at
            and pr.routed_at > '2023-05-31 16:00:00'
            and pr.store_id != t2.storeid
    ) a on a.pno = t1.pno and a.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
select
    count(pi.pno)
from ph_staging.parcel_info pi
left join ph_staging.sys_store ss on ss.id = pi.ticket_pickup_store_id
where
    pi.created_at >= '2023-07-31 16:00:00'
    and pi.created_at < '2023-08-31 16:00:00'
    and ss.category = 6 -- FH
    and pi.state < 9;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        pi.pno
        ,case
            when bc.`client_id` is not null then bc.client_name
            when kp.id is not null and bc.client_id is null then '普通ka'
            when kp.`id` is null then '小c'
        end as client_type
        ,ss.name pick_store
        ,ss.id storeid
    from ph_staging.parcel_info pi
    left join ph_staging.sys_store ss on ss.id = pi.ticket_pickup_store_id
    left join ph_staging.ka_profile kp on kp.id = pi.client_id
    left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
    where
        pi.created_at >= '2023-07-31 16:00:00'
        and pi.created_at < '2023-08-31 16:00:00'
        and ss.category = 6 -- FH
        and pi.state < 9
),
res as
    (
        select
            t1.*
            ,min(pr.routed_at) min_route_at
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno and pr.route_action = 'RECEIVE_WAREHOUSE_SCAN' and pr.store_id = t1.storeid
        where
            pr.routed_at > '2023-07-31 16:00:00'
        group by 1,2,3,4
    )

select
    t1.pno 包裹
    ,t1.client_type 客户类型
    ,t1.pick_store 揽收网点
    ,convert_tz(t2.min_route_at, '+00:00', '+08:00')  收件入仓时间
    ,a.route_action 收件入仓后第一个有效路由
    ,a.store_name 收件入仓后第一个有效路由网点
    ,convert_tz(a.routed_at, '+00:00', '+08:00')  收件入仓后第一个有效路由时间
    ,case
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 < 24 then 0
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 >= 24 and timestampdiff(minute , t2.min_route_at, a.routed_at)/60 < 48 then 1
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 >= 48 and timestampdiff(minute , t2.min_route_at, a.routed_at)/60 < 72 then 2
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 > 72 then 3
     end 收件入仓与后续第一个路由时间差
from t t1
left join res t2 on t2.pno = t1.pno
left join
    (
        select
            t2.*
            ,pr.route_action
            ,pr.store_id pr_store_id
            ,pr.store_name
            ,pr.routed_at
            ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        from ph_staging.parcel_route pr
        join res t2 on t2.pno = pr.pno
        join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action
        where
            pr.routed_at > t2.min_route_at
            and pr.routed_at > '2023-07-31 16:00:00'
            and pr.store_id != t2.storeid
    ) a on a.pno = t1.pno and a.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
select
    case
        when bc.`client_id` is not null then bc.client_name
        when kp.id is not null and bc.client_id is null then '普通ka'
        when kp.`id` is null then '小c'
    end as 客户类型
    ,plt.updated_at 判责时间
    ,plt.pno
    ,case plt.source
        WHEN 1 THEN 'A-问题件-丢失'
        WHEN 2 THEN 'B-记录本-丢失'
        WHEN 3 THEN 'C-包裹状态未更新'
        WHEN 4 THEN 'D-问题件-破损/短少'
        WHEN 5 THEN 'E-记录本-索赔-丢失'
        WHEN 6 THEN 'F-记录本-索赔-破损/短少'
        WHEN 7 THEN 'G-记录本-索赔-其他'
        WHEN 8 THEN 'H-包裹状态未更新-IPC计数'
        WHEN 9 THEN 'I-问题件-外包装破损险'
        WHEN 10 THEN 'J-问题记录本-外包装破损险'
        when 11 then 'K-超时效包裹'
        when 12 then 'L-高度疑似丢失'
    end 问题来源渠道
    ,ss.name 责任网点
from ph_bi.parcel_lose_task plt
left join ph_bi.parcel_lose_responsible plr on plr.lose_task_id = plt.id
left join ph_staging.ka_profile kp on kp.id = plt.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = plt.client_id
left join ph_staging.sys_store ss on ss.id = plr.store_id
where
    plt.state = 6
    and plt.updated_at >= '2023-06-01'
    and plt.updated_at < '2023-09-01'
    and ss.category = 6
group by 1,2,3,4;
;-- -. . -..- - / . -. - .-. -.--
select
    a.*
    ,case
        when timestampdiff(minute , a.created_at, a.第一次回复时间)/60 < 24 then 0
        when timestampdiff(minute , a.created_at, a.第一次回复时间)/60 >= 24 and timestampdiff(minute , a.created_at, a.第一次回复时间)/60 < 48 then 1
        when timestampdiff(minute , a.created_at, a.第一次回复时间)/60 >= 48 and timestampdiff(minute , a.created_at, a.第一次回复时间)/60 < 72 then 2
        when timestampdiff(minute , a.created_at, a.第一次回复时间)/60 > 72 then 3
    end  回复时间
    ,case
        when timestampdiff(minute , a.created_at, a.工单关闭时间)/60 < 24 then 0
        when timestampdiff(minute , a.created_at, a.工单关闭时间)/60 >= 24 and timestampdiff(minute , a.created_at, a.工单关闭时间)/60 < 48 then 1
        when timestampdiff(minute , a.created_at, a.工单关闭时间)/60 >= 48 and timestampdiff(minute , a.created_at, a.工单关闭时间)/60 < 72 then 2
        when timestampdiff(minute , a.created_at, a.工单关闭时间)/60 > 72 then 3
    end  关闭时间
from
    (
        select
            wo.order_no 工单编号
            ,fp.id 加盟商ID
            ,wo.created_at
            ,case wo.order_type
                when 1 then '查找运单'
                when 2 then '加快处理'
                when 3 then '调查员工'
                when 4 then '其他'
                when 5 then '网点信息维护提醒'
                when 6 then '培训指导'
                when 7 then '异常业务询问'
                when 8 then '包裹丢失'
                when 9 then '包裹破损'
                when 10 then '货物短少'
                when 11 then '催单'
                when 12 then '有发无到'
                when 13 then '上报包裹不在集包里'
                when 16 then '漏揽收'
                when 50 then '虚假撤销'
                when 17 then '已签收未收到'
                when 18 then '客户投诉'
                when 19 then '修改包裹信息'
                when 20 then '修改 COD 金额'
                when 21 then '解锁包裹'
                when 22 then '申请索赔'
                when 23 then 'MS 问题反馈'
                when 24 then 'FBI 问题反馈'
                when 25 then 'KA System 问题反馈'
                when 26 then 'App 问题反馈'
                when 27 then 'KIT 问题反馈'
                when 28 then 'Backyard 问题反馈'
                when 29 then 'BS/FH 问题反馈'
                when 30 then '系统建议'
                when 31 then '申诉罚款'
                else wo.order_type
            end  工单类型
            ,pi.client_id
            ,coalesce(ss2.name, sd.name) 发起部门
            ,wo.closed_at 工单关闭时间
            ,min(wor.created_at) 第一次回复时间
        from ph_bi.work_order wo
        left join ph_staging.sys_store ss on ss.id = wo.store_id
        left join ph_staging.franchisee_profile fp on fp.id= ss.franchisee_id -- 加盟商ID
        left join ph_staging.parcel_info pi on pi.pno = wo.pnos
        left join ph_staging.sys_store ss2 on ss2.id = wo.created_store_id
        left join ph_staging.sys_department sd on sd.id = wo.created_store_id
        left join ph_bi.work_order_reply wor on wo.id = wor.order_id
        where
            ss.category = 6
            and wo.created_at >= '2023-06-01'
            and wo.created_at < '2023-09-01'
        group by 1
    ) a;
;-- -. . -..- - / . -. - .-. -.--
select
        t.*
    from tmpale.tmp_ph_courier_0907 t;
;-- -. . -..- - / . -. - .-. -.--
with a as
(
    select
        t.*
    from tmpale.tmp_ph_courier_0907 t
    where
        t.courier is not null
)
, mw as
(
    select
        mw.staff_info_id
        ,mw.id
        ,mw.created_at
        ,row_number() over (partition by mw.staff_info_id order by mw.created_at) rk
        ,count(id) over (partition by mw.staff_info_id) warn_num
    from ph_backyard.message_warning mw
    join
        (
            select
                a1.courier report_id
            from a a1
            group by 1
        )a1 on a1.report_id = mw.staff_info_id
    where
        mw.is_delete = 0
)
select
    hsi.staff_info_id 工号
    ,a1.id 举报记录ID
    ,a1.submitter_id 举报人工号
    ,a1.submitter_name 举报人姓名
    ,a1.submitter_job 举报人职位
    ,hsi.name 被举报人姓名
    ,date(hsi.hire_date) 入职日期
    ,hjt.job_name 岗位
    ,a1.event_date 违规日期
    ,a1.reason 举报原因
    ,a1.remark 事情描述
    ,a1.picture 图片
    ,hsi.mobile 手机号

    ,sc.num 员工当日交接量
    ,del.num 员工当日妥投量
    ,pick.num 员工当日揽件量
    ,mw1.warn_num 历史警告信次数
    ,mw1.created_at 第一次警告信时间
    ,mw2.created_at 第二次警告信时间
    ,mw3.created_at 第三次警告信时间

    ,ss2.name 网点
    ,smp.name 片区
    ,smr.name 大区
    ,case
        when smr.name in ('Area3', 'Area6') then '彭万松'
        when smr.name in ('Area4', 'Area9') then '韩钥'
        when smr.name in ('Area7', 'Area8','Area10', 'Area11','FHome') then '张可新'
        when smr.name in ('Area1', 'Area2','Area5', 'Area12') then '李俊'
    end 负责人
    ,emp_cnt.staf_num 现有快递员数
    ,shl_del.sh_del_num 网点当日应派件量
    ,shl_del.delivery_rate 当日妥投率
    ,att.atd_emp_cnt 网点当日出勤人数_快递员
    ,fin.fin_pno 网点当日妥投量
    ,last30.warn_num 过去30天警告信数量
    ,last30.warn_staff_num 过去30天警告信人数
    ,last7.warn_num 过去7天警告信数量
    ,last7.warn_staff_num 过去7天警告信人数
    ,coalesce(concat(round(last_month.当月离职人数*100/last_month.当月总人数 ,2), '%') ,0) 上月离职率
from ph_bi.hr_staff_info hsi
join a a1 on a1.courier = hsi.staff_info_id
left join ph_staging.sys_store ss2 on ss2.id = hsi.sys_store_id
left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
left join ph_bi.hr_job_title hjt on hjt.id = hsi.job_title
left join mw mw1 on mw1.staff_info_id = a1.courier and mw1.rk = 1
left join mw mw2 on mw2.staff_info_id = a1.courier and mw2.rk = 2
left join mw mw3 on mw3.staff_info_id = a1.courier and mw3.rk = 3
left join
    (
        select
            pr.staff_info_id
            ,a1.event_date
            ,count(distinct pr.pno) num
        from ph_staging.parcel_route pr
        join a a1 on a1.courier = pr.staff_info_id
        where
            pr.routed_at >= date_sub(a1.event_date, interval 8 hour)
            and pr.routed_at < date_add(a1.event_date, interval 16 hour)
            and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
        group by 1
    ) sc on sc.staff_info_id = a1.courier and sc.event_date = a1.event_date
left join
    (
        select
            pr.staff_info_id
            ,a1.event_date
            ,count(distinct pr.pno) num
        from ph_staging.parcel_route pr
        join a a1 on a1.courier = pr.staff_info_id
        where
            pr.routed_at >= date_sub(a1.event_date, interval 8 hour)
            and pr.routed_at < date_add(a1.event_date, interval 16 hour)
            and pr.route_action = 'DELIVERY_CONFIRM'
        group by 1
    ) del on del.staff_info_id = a1.courier and del.event_date = a1.event_date
left join
    (
        select
            pr.staff_info_id
            ,a1.event_date
            ,count(distinct pr.pno) num
        from ph_staging.parcel_route pr
        join a a1 on a1.courier = pr.staff_info_id
        where
            pr.routed_at >= date_sub(a1.event_date, interval 8 hour)
            and pr.routed_at < date_add(a1.event_date, interval 16 hour)
            and pr.route_action = 'RECEIVED'
        group by 1
    ) pick on pick.staff_info_id = a1.courier and pick.event_date = a1.event_date
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        join a a1 on a1.sys_store_id = hr.sys_store_id
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a1.sys_store_id
left join
    (
        select
            a1.sys_store_id
            ,a1.event_date
            ,count(distinct dc.pno) sh_del_num
            ,count(distinct if(pi2.state = 5, dc.pno, null)) sh_del_del_num
            ,concat(round(count(distinct if(pi2.state = 5, dc.pno, null))*100/count(distinct dc.pno) ,2) ,'%') delivery_rate
        from ph_bi.dc_should_delivery_today  dc
        join
            (
                select
                    a1.sys_store_id
                    ,a1.event_date
                from a a1
                group by 1
            )  a1 on a1.event_date = dc.stat_date and a1.sys_store_id = dc.store_id
        left join ph_staging.parcel_info pi2 on pi2.pno = dc.pno
        group by 1,2
    ) shl_del on shl_del.event_date = a1.event_date and shl_del.sys_store_id = a1.sys_store_id
left join
    (
        select
           ad.sys_store_id
           ,a1.event_date
           ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
       from ph_bi.attendance_data_v2 ad
       left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
       join
            (
                select
                    a1.sys_store_id
                    ,a1.event_date
                from a a1
                group by 1
            ) a1 on a1.sys_store_id = ad.sys_store_id and a1.event_date = ad.stat_date
       where
           (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
            and hr.job_title in (13,110,1000)
       group by 1,2
    ) att on att.sys_store_id = a1.sys_store_id and att.event_date = a1.event_date
left join
    (
        select
            a1.sys_store_id
            ,a1.event_date
            ,count(distinct pi.pno) fin_pno
        from ph_staging.parcel_info pi
        join
            (
                select
                    a1.sys_store_id
                    ,a1.event_date
                from a a1
                group by 1
            ) a1 on a1.sys_store_id = pi.ticket_delivery_store_id
        where
            pi.state = 5
            and pi.finished_at >= date_sub(a1.event_date, interval 8 hour)
            and pi.finished_at < date_add(a1.event_date, interval 16 hour)
        group by 1,2
    ) fin on fin.sys_store_id = a1.sys_store_id and fin.event_date = a1.event_date
left join
    (
        select
            hsi2.sys_store_id
            ,count(distinct mw.id) warn_num
            ,count(distinct mw.staff_info_id) warn_staff_num
        from ph_backyard.message_warning mw
        left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = mw.staff_info_id
        join
            (
                select
                    a1.sys_store_id
                from a a1
                group by 1
            ) a on hsi2.sys_store_id = a.sys_store_id
        where
            mw.created_at >= date_sub(curdate(), interval 30 day)
        group by 1
    ) last30 on last30.sys_store_id = a1.sys_store_id
left join
    (
        select
            hsi2.sys_store_id
            ,count(distinct mw.id) warn_num
            ,count(distinct mw.staff_info_id) warn_staff_num
        from ph_backyard.message_warning mw
        left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = mw.staff_info_id
        join
            (
                select
                    a1.sys_store_id
                from a a1
                group by 1
            ) a on hsi2.sys_store_id = a.sys_store_id
        where
            mw.created_at >= date_sub(curdate(), interval 7 day)
        group by 1
    ) last7 on last7.sys_store_id = a1.sys_store_id
left join
    (
        select
            hsi.sys_store_id
            ,ss.name
            ,count(distinct if(hsi.state in (1,3) ,hsi.staff_info_id ,null)) + count(distinct if(hsi.state = 2 and left(hsi.leave_date ,7) = date_format(date_sub(curdate(), interval 1 month),'%Y-%m') ,hsi.staff_info_id ,null)) '当月总人数'
            ,count(distinct if(hsi.state = 2 and left(hsi.leave_date ,7) = date_format(date_sub(curdate(), interval 1 month),'%Y-%m') ,hsi.staff_info_id ,null)) '当月离职人数'
        from ph_bi.hr_staff_info hsi
        left join ph_staging.sys_store ss  on ss.id =hsi.sys_store_id
        where
            hsi.formal = 1
            and hsi.is_sub_staff = 0
            and hsi.job_title in (13,110,1000,37)
            and ss.category in (1,10,13,14)
            and hsi.hire_date < date_format(now(), '%y-%m-01')
        group by 1
    ) last_month on last_month.sys_store_id = a1.sys_store_id;
;-- -. . -..- - / . -. - .-. -.--
with a as
(
    select
        t.*
    from tmpale.tmp_ph_courier_0907 t
    where
        t.courier is not null
)
, mw as
(
    select
        mw.staff_info_id
        ,mw.id
        ,mw.created_at
        ,row_number() over (partition by mw.staff_info_id order by mw.created_at) rk
        ,count(id) over (partition by mw.staff_info_id) warn_num
    from ph_backyard.message_warning mw
    join
        (
            select
                a1.courier report_id
            from a a1
            group by 1
        )a1 on a1.report_id = mw.staff_info_id
    where
        mw.is_delete = 0
)
select
    hsi.staff_info_id 工号

    ,hsi.name 被举报人姓名
    ,date(hsi.hire_date) 入职日期
    ,hjt.job_name 岗位
    ,a1.event_date 违规日期


    ,hsi.mobile 手机号

    ,sc.num 员工当日交接量
    ,del.num 员工当日妥投量
    ,pick.num 员工当日揽件量
    ,mw1.warn_num 历史警告信次数
    ,mw1.created_at 第一次警告信时间
    ,mw2.created_at 第二次警告信时间
    ,mw3.created_at 第三次警告信时间

    ,ss2.name 网点
    ,smp.name 片区
    ,smr.name 大区
    ,case
        when smr.name in ('Area3', 'Area6') then '彭万松'
        when smr.name in ('Area4', 'Area9') then '韩钥'
        when smr.name in ('Area7', 'Area8','Area10', 'Area11','FHome') then '张可新'
        when smr.name in ('Area1', 'Area2','Area5', 'Area12') then '李俊'
    end 负责人
    ,emp_cnt.staf_num 现有快递员数
    ,shl_del.sh_del_num 网点当日应派件量
    ,shl_del.delivery_rate 当日妥投率
    ,att.atd_emp_cnt 网点当日出勤人数_快递员
    ,fin.fin_pno 网点当日妥投量
    ,last30.warn_num 过去30天警告信数量
    ,last30.warn_staff_num 过去30天警告信人数
    ,last7.warn_num 过去7天警告信数量
    ,last7.warn_staff_num 过去7天警告信人数
    ,coalesce(concat(round(last_month.当月离职人数*100/last_month.当月总人数 ,2), '%') ,0) 上月离职率
from ph_bi.hr_staff_info hsi
join a a1 on a1.courier = hsi.staff_info_id
left join ph_staging.sys_store ss2 on ss2.id = hsi.sys_store_id
left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
left join ph_bi.hr_job_title hjt on hjt.id = hsi.job_title
left join mw mw1 on mw1.staff_info_id = a1.courier and mw1.rk = 1
left join mw mw2 on mw2.staff_info_id = a1.courier and mw2.rk = 2
left join mw mw3 on mw3.staff_info_id = a1.courier and mw3.rk = 3
left join
    (
        select
            pr.staff_info_id
            ,a1.event_date
            ,count(distinct pr.pno) num
        from ph_staging.parcel_route pr
        join a a1 on a1.courier = pr.staff_info_id
        where
            pr.routed_at >= date_sub(a1.event_date, interval 8 hour)
            and pr.routed_at < date_add(a1.event_date, interval 16 hour)
            and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
        group by 1
    ) sc on sc.staff_info_id = a1.courier and sc.event_date = a1.event_date
left join
    (
        select
            pr.staff_info_id
            ,a1.event_date
            ,count(distinct pr.pno) num
        from ph_staging.parcel_route pr
        join a a1 on a1.courier = pr.staff_info_id
        where
            pr.routed_at >= date_sub(a1.event_date, interval 8 hour)
            and pr.routed_at < date_add(a1.event_date, interval 16 hour)
            and pr.route_action = 'DELIVERY_CONFIRM'
        group by 1
    ) del on del.staff_info_id = a1.courier and del.event_date = a1.event_date
left join
    (
        select
            pr.staff_info_id
            ,a1.event_date
            ,count(distinct pr.pno) num
        from ph_staging.parcel_route pr
        join a a1 on a1.courier = pr.staff_info_id
        where
            pr.routed_at >= date_sub(a1.event_date, interval 8 hour)
            and pr.routed_at < date_add(a1.event_date, interval 16 hour)
            and pr.route_action = 'RECEIVED'
        group by 1
    ) pick on pick.staff_info_id = a1.courier and pick.event_date = a1.event_date
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        join a a1 on a1.sys_store_id = hr.sys_store_id
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a1.sys_store_id
left join
    (
        select
            a1.sys_store_id
            ,a1.event_date
            ,count(distinct dc.pno) sh_del_num
            ,count(distinct if(pi2.state = 5, dc.pno, null)) sh_del_del_num
            ,concat(round(count(distinct if(pi2.state = 5, dc.pno, null))*100/count(distinct dc.pno) ,2) ,'%') delivery_rate
        from ph_bi.dc_should_delivery_today  dc
        join
            (
                select
                    a1.sys_store_id
                    ,a1.event_date
                from a a1
                group by 1
            )  a1 on a1.event_date = dc.stat_date and a1.sys_store_id = dc.store_id
        left join ph_staging.parcel_info pi2 on pi2.pno = dc.pno
        group by 1,2
    ) shl_del on shl_del.event_date = a1.event_date and shl_del.sys_store_id = a1.sys_store_id
left join
    (
        select
           ad.sys_store_id
           ,a1.event_date
           ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
       from ph_bi.attendance_data_v2 ad
       left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
       join
            (
                select
                    a1.sys_store_id
                    ,a1.event_date
                from a a1
                group by 1
            ) a1 on a1.sys_store_id = ad.sys_store_id and a1.event_date = ad.stat_date
       where
           (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
            and hr.job_title in (13,110,1000)
       group by 1,2
    ) att on att.sys_store_id = a1.sys_store_id and att.event_date = a1.event_date
left join
    (
        select
            a1.sys_store_id
            ,a1.event_date
            ,count(distinct pi.pno) fin_pno
        from ph_staging.parcel_info pi
        join
            (
                select
                    a1.sys_store_id
                    ,a1.event_date
                from a a1
                group by 1
            ) a1 on a1.sys_store_id = pi.ticket_delivery_store_id
        where
            pi.state = 5
            and pi.finished_at >= date_sub(a1.event_date, interval 8 hour)
            and pi.finished_at < date_add(a1.event_date, interval 16 hour)
        group by 1,2
    ) fin on fin.sys_store_id = a1.sys_store_id and fin.event_date = a1.event_date
left join
    (
        select
            hsi2.sys_store_id
            ,count(distinct mw.id) warn_num
            ,count(distinct mw.staff_info_id) warn_staff_num
        from ph_backyard.message_warning mw
        left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = mw.staff_info_id
        join
            (
                select
                    a1.sys_store_id
                from a a1
                group by 1
            ) a on hsi2.sys_store_id = a.sys_store_id
        where
            mw.created_at >= date_sub(curdate(), interval 30 day)
        group by 1
    ) last30 on last30.sys_store_id = a1.sys_store_id
left join
    (
        select
            hsi2.sys_store_id
            ,count(distinct mw.id) warn_num
            ,count(distinct mw.staff_info_id) warn_staff_num
        from ph_backyard.message_warning mw
        left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = mw.staff_info_id
        join
            (
                select
                    a1.sys_store_id
                from a a1
                group by 1
            ) a on hsi2.sys_store_id = a.sys_store_id
        where
            mw.created_at >= date_sub(curdate(), interval 7 day)
        group by 1
    ) last7 on last7.sys_store_id = a1.sys_store_id
left join
    (
        select
            hsi.sys_store_id
            ,ss.name
            ,count(distinct if(hsi.state in (1,3) ,hsi.staff_info_id ,null)) + count(distinct if(hsi.state = 2 and left(hsi.leave_date ,7) = date_format(date_sub(curdate(), interval 1 month),'%Y-%m') ,hsi.staff_info_id ,null)) '当月总人数'
            ,count(distinct if(hsi.state = 2 and left(hsi.leave_date ,7) = date_format(date_sub(curdate(), interval 1 month),'%Y-%m') ,hsi.staff_info_id ,null)) '当月离职人数'
        from ph_bi.hr_staff_info hsi
        left join ph_staging.sys_store ss  on ss.id =hsi.sys_store_id
        where
            hsi.formal = 1
            and hsi.is_sub_staff = 0
            and hsi.job_title in (13,110,1000,37)
            and ss.category in (1,10,13,14)
            and hsi.hire_date < date_format(now(), '%y-%m-01')
        group by 1
    ) last_month on last_month.sys_store_id = a1.sys_store_id;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-07'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 10
                    or (t1.total =  5 and t1.leave_time_type = 2)

                union all

                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 5
                    and t1.leave_time_type = 1 -- 上午请假
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-07'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 10
                                    or (t1.total =  5 and t1.leave_time_type = 2)

                                union all

                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 5
                                    and t1.leave_time_type = 1 -- 上午请假
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-09-07', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with d as
    (
        select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-09-07'
    )
    , t as
    (
        select
             ds.store_id
            ,ds.pno
            ,ds.stat_date
        from d ds
        left join
            (
                select
                    pr.pno
                    ,ds.stat_date
                    ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
                from ph_staging.parcel_route pr
                join d ds on pr.pno = ds.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                    and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and pr.marker_category in (42,43) ##岛屿,偏远地区
                group by 1,2
            ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
        left join
            (
                select
                   pr.pno
                    ,ds.stat_date
                   ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
                   ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
                from ph_staging.parcel_route pr
                join d ds on ds.pno = pr.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                    and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                    and pr.marker_category in (9,14,70) ##客户改约时间
            ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
        left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
        where
            case
                when pr1.pno is not null then 'N'
                when pr2.pno is not null then 'N'
                when ds1.pno is not null  then 'N'  else 'Y'
            end = 'Y'
    )
    select
        a.stat_date 日期
        ,a.store_id 网点ID
        ,dp.store_name 网点名称
        ,dp.opening_at 开业时间
        ,case
            when dp.region_name in ('Area3', 'Area6') then '彭万松'
            when dp.region_name in ('Area4', 'Area9') then '韩钥'
            when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
            when dp.region_name in ( 'Area8') then '黄勇'
            when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
        end 区域
        ,dp.region_name 大区
        ,dp.piece_name 片区
        ,a.应交接
        ,a.已交接
        ,concat(round(a.交接率*100,2),'%') as 交接率
        ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
        ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
        ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
        ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
        ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
    from
        (
            select
                t1.store_id
                ,t1.stat_date
                ,count(t1.pno) 应交接
                ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
            from t t1
            left join
                (
                    select
                        sc.*
                    from
                        (
                            select
                                pr.pno
                                ,pr.store_id
                                ,pr.store_name
                                ,t1.stat_date
                                ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                            from ph_staging.parcel_route pr
                            join t t1 on t1.pno = pr.pno
                            where
                                pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                               and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                              and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                        ) sc
                    where
                        sc.rk = 1
                ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
            group by 1,2
        ) a
    join
        (
            select
                sd.store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.store_id is not null
            group by 1

            union all

            select
                sd.separation_store_id store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.separation_store_id is not null
            group by 1
        ) sd on sd.store_id = a.store_id
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    where
        dp.store_category in (1,10);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-07'
        and pr.routed_at >= date_sub('2023-09-07', interval 8 hour )
        and pr.routed_at < date_add('2023-09-07', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,if(a3.self_staff_num + other_staff_num > coalesce(sdb.code_num, 0),
           case
            when a2.avg_staff_code < 2 then 'A'
            when a2.avg_staff_code >= 2 and a2.avg_staff_code < 3 then 'B'
            when a2.avg_staff_code >= 3 and a2.avg_staff_code < 4 then 'C'
            when a2.avg_staff_code >= 4 then 'D'
        end,
           case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end ) 评级
#         ,a2.code_num
#         ,a2.staff_code_num
#         ,a2.staff_num
#         ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) avg_staff_code
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-09-07'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-09-07')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-09-07'
        and pi.finished_at >= date_sub('2023-09-07', interval 8 hour )
        and pi.finished_at < date_add('2023-09-07', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-09-07'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
from ph_staging.parcel_info pi
where
    pi.ticket_delivery_staff_info_id = '119309'
    and pi.created_at >= '2023-08-30 16:00:00'
    and  pi.created_at >= '2023-08-31 16:00:00';
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
from ph_staging.parcel_info pi
where
    pi.ticket_delivery_staff_info_id = '119309'
    and pi.finished_at >= '2023-08-30 16:00:00'
    and  pi.finished_at >= '2023-08-31 16:00:00';
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
from ph_staging.parcel_info pi
where
    pi.ticket_delivery_staff_info_id = '119309'
    and pi.finished_at >= '2023-08-30 16:00:00'
    and  pi.finished_at >= '2023-08-31 16:00:00'
    and pi.state = 5;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
from ph_staging.parcel_info pi
where
    pi.ticket_delivery_staff_info_id = '119309'
    and pi.finished_at >= '2023-08-30 16:00:00'
    and  pi.finished_at < '2023-08-31 16:00:00'
    and pi.state = 5;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
    ,pi.returned
from ph_staging.parcel_info pi
where
    pi.ticket_delivery_staff_info_id = '119309'
    and pi.finished_at >= '2023-08-30 16:00:00'
    and  pi.finished_at < '2023-08-31 16:00:00'
    and pi.state = 5;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
    ,pi.returned
from ph_staging.parcel_info pi
where
    pi.ticket_delivery_staff_info_id = '136472'
    and pi.finished_at >= '2023-08-30 16:00:00'
    and  pi.finished_at < '2023-08-31 16:00:00'
    and pi.state = 5;
;-- -. . -..- - / . -. - .-. -.--
with staff_id as (
##快递员当日出勤情况
select
    v2.stat_date              ##日期
    ,v2.staff_info_id         ##工号
    ,mr.name manage_region              #归属大区
    ,mp.name manage_piece               ##归属片区
    ,v2.sys_store_id          ##归属网点id
    ,ss.name                  ##归属网点名称
    ,ss.category              ##网点类型
    ,v2.attendance_started_at ##上班打卡时间
    ,v2.attendance_end_at     ##下班打卡时间
    ,v2.shift_start           ##班次开始时间
    ,v2.shift_end             ##班次结束时间
    ##,case when v2.attendance_time + v2.BT + v2.BT_Y + v2.AB = 10 then '应出勤' else '无需出勤' end as plan##培训假删掉
    ,case when (v2.attendance_time + v2.BT + v2.BT_Y + v2.AB) > 0 then '应出勤' else '无需出勤' end as plan##培训假删掉
    ,v2.shift_id
    ,case when v2.AB = 10 then '缺勤一天'
        when v2.AB = 5 then '缺勤半天'
        when v2.AB = 0 then '全勤'
    else v2.AB end as is_AB
    ,case when (v2.attendance_time + v2.BT + v2.BT_Y + v2.AB) <= 0 then '排休无需打卡'
        when  (v2.attendance_time + v2.BT + v2.BT_Y + v2.AB) > 0 and v2.attendance_started_at is null then '无上班打卡时间'
        when timestampdiff(SECOND,CONCAT(v2.stat_date," ",v2.shift_start),v2.attendance_started_at) <= 59 then '未迟到'
        when timestampdiff(SECOND,CONCAT(v2.stat_date," ",v2.shift_start),v2.attendance_started_at) <= 359 then '迟到5min内'
        #when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 659 then '迟到5-10min'
        #when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 959 then '迟到10-15min'
        #when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 1259 then '迟到15-20min'
        #when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 1559 then '迟到20-25min'
        when timestampdiff(SECOND,CONCAT(v2.stat_date," ",v2.shift_start),v2.attendance_started_at) <= 1859 then '迟到5-30min'
    else '迟到30min以上' end as chidao_ty
from ph_bi.attendance_data_v2 v2##研发刘春华，黄华
left join ph_staging.sys_store ss on ss.id = v2.sys_store_id ##网点编码
left join ph_staging.sys_manage_piece mp on mp.id = ss.manage_piece ##管理片区
left join ph_staging.sys_manage_region mr on mr.id = ss.manage_region ##管理大区
where date(v2.stat_date) = date_sub(curdate(),interval 1 day)
group by v2.stat_date
    ,v2.staff_info_id
    ,mr.name                  ##作业大区
    ,mp.name                  ##作业片区
    ,v2.sys_store_id          ##作业网点id
    ,ss.name                  ##作业网点名称
    ,v2.attendance_started_at ##上班打卡时间
    ,v2.attendance_end_at     ##下班打卡时间
    ,v2.shift_start           ##班次开始时间
    ,v2.shift_end             ##班次结束时间
    ,v2.shift_id
    ,case when v2.AB = 10 then '缺勤一天'
        when v2.AB = 5 then '缺勤半天'
        when v2.AB = 0 then '全勤'
    else v2.AB end
    ,case when (v2.attendance_time + v2.BT + v2.BT_Y + v2.AB) <= 0 then '排休无需打卡'
        when  (v2.attendance_time + v2.BT + v2.BT_Y + v2.AB) > 0 and v2.attendance_started_at is null then '无上班打卡时间'
        when timestampdiff(SECOND,CONCAT(v2.stat_date," ",v2.shift_start),v2.attendance_started_at) <= 59 then '未迟到'
        when timestampdiff(SECOND,CONCAT(v2.stat_date," ",v2.shift_start),v2.attendance_started_at) <= 359 then '迟到5min内'
        #when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 659 then '迟到5-10min'
        #when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 959 then '迟到10-15min'
        #when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 1259 then '迟到15-20min'
        #when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 1559 then '迟到20-25min'
        when timestampdiff(SECOND,CONCAT(v2.stat_date," ",v2.shift_start),v2.attendance_started_at) <= 1859 then '迟到5-30min'
    else '迟到30min以上' end
)


,staff_absence as (
#近14天排班的一个情况
select t1.staff_info_id
    ,count(distinct if(t1.attendance_type in ('迟到30min以上'), t1.stat_date,null)) as late_30min
    ,count(distinct if(t1.is_AB in ('缺勤一天','缺勤半天'), t1.stat_date,null)) as absence
from (
select
    v2.stat_date              ##日期
    ,v2.staff_info_id         ##工号
    ,mr.name manage_region              #归属大区
    ,mp.name manage_piece               ##归属片区
    ,v2.sys_store_id          ##归属网点id
    ,ss.name                  ##归属网点名称
    ,ss.category              ##网点类型
    ,v2.attendance_started_at ##上班打卡时间
    ,v2.attendance_end_at     ##下班打卡时间
    ,v2.shift_start           ##班次开始时间
    ,v2.shift_end             ##班次结束时间
    ,case when v2.attendance_started_at is null then '无上班打卡时间'
        when timestampdiff(SECOND,CONCAT(v2.stat_date," ",v2.shift_start),v2.attendance_started_at) <= 1859 then '迟到30min以内'
    else '迟到30min以上' end as attendance_type#迟到情况
    ,case when v2.AB = 10 then '缺勤一天'
        when v2.AB = 5 then '缺勤半天'
        when v2.AB = 0 then '全勤'
    else v2.AB end as is_AB
    ,ROW_NUMBER() OVER (PARTITION by v2.staff_info_id order by v2.stat_date desc) as rn
from ph_bi.attendance_data_v2 v2##研发刘春华，黄华
left join ph_staging.sys_store ss on ss.id = v2.sys_store_id ##网点编码
left join ph_staging.sys_manage_piece mp on mp.id = ss.manage_piece ##管理片区
left join ph_staging.sys_manage_region mr on mr.id = ss.manage_region ##管理大区
where date(v2.stat_date) >= date_sub(curdate(),interval 30 day)
    and date(v2.stat_date) <= date_sub(curdate(),interval 1 day)
    ##and v2.attendance_time + v2.BT + v2.BT_Y + v2.AB = 10 ##排班应出勤
    and (v2.attendance_time + v2.BT + v2.BT_Y + v2.AB) > 0
    and v2.job_title in (13,110,1000)
    and v2.state in (1)
    ##and hi.staff_info_id in ('118890','363229')
group by 1,2,3,4,5,6,7,8,9,10,11,12,13
)t1
where t1.rn <= 14
group by 1
)

,ticket_delivery_min5 as (
##前五件的时间
select n1.staff_info_id
    ,max(case when n1.rn = 1 then n1.created_time else null end) as time_one
    ,max(case when n1.rn = 2 then n1.created_time else null end) as time_two
    ,max(case when n1.rn = 3 then n1.created_time else null end) as time_three
    ,max(case when n1.rn = 4 then n1.created_time else null end) as time_four
    ,max(case when n1.rn = 5 then n1.created_time else null end) as time_five
from
(
    select n.staff_info_id
        ,n.created_time
        ,ROW_NUMBER() OVER (PARTITION by n.staff_info_id order by n.created_time asc) as rn
    from (
    select td.staff_info_id,convert_tz(td.created_at,'+00:00','+08:00') as created_time
    from ph_staging.ticket_delivery td
    WHERE 1=1
        and td.created_at >= date_sub(date_sub(curdate(), interval 1 day), interval 8 hour )
        and td.created_at < date_sub(curdate(), interval 8 hour)##正常的时间剪掉8h
        AND td.state <> 3 # stata=3(已关闭)
    GROUP BY 1,2
    )n
    group by 1,2
)n1
group by n1.staff_info_id
)


,delivery_percentage as (
##90%的包裹在两个小时之内交接完
##最早交接时间+2h时间内交接包裹量占总交接量的比例
#员工、交接时间、最早交接时间+2h，pno
#date_format(date_add(ft.arrive_time_first,interval 150 minute),'%H:%i')
select t2.staff_info_id
    ,t2.delivery_min
    ,t2.delivery_max
    ,count(distinct if(t2.created_time <= concat(date_format(date_sub(curdate(), interval 1 day),'%Y-%m-%d'),' 12:00:00'),t2.pno,null)) as 12_pnos
    ,count(distinct if(t2.created_time <= date_format(date_add(t2.delivery_min,interval 180 minute),'%Y-%m-%d %H:%i:%s'),t2.pno,null)) as 2h_pnos
    ,count(distinct t2.pno) as pnos
    ,round(count(distinct if(t2.created_time <= date_format(date_add(t2.delivery_min,interval 180 minute),'%Y-%m-%d %H:%i:%s'),t2.pno,null))/count(distinct t2.pno),2) 2h_percentage
    ,round(count(distinct if(t2.created_time <= concat(date_format(date_sub(curdate(), interval 1 day),'%Y-%m-%d'),' 12:00:00'),t2.pno,null))/count(distinct t2.pno),2) 12_percentage

from (

        select
            td.staff_info_id
            ,date(convert_tz(td.created_at,'+00:00','+08:00')) as created_dt
            ,convert_tz(td.created_at,'+00:00','+08:00') as created_time
            ,td.pno
            ,t1.delivery_min ##最早交接时间
            ,t1.delivery_max ##最晚交接时间

        from ph_staging.ticket_delivery td

        left join (
            select
                td.staff_info_id
                ,MIN(convert_tz(td.created_at,'+00:00','+08:00')) AS delivery_min ##最早交接时间
                ,MAX(convert_tz(td.created_at,'+00:00','+08:00')) AS delivery_max ##最晚交接时间

            from ph_staging.ticket_delivery td
            where 1=1
                and td.created_at >= date_sub(date_sub(curdate(), interval 1 day), interval 8 hour )
                and td.created_at < date_sub(curdate(), interval 8 hour)##正常的时间剪掉8h
                AND td.state <> 3 # stata=3(已关闭)
            group by 1
        )t1
        on td.staff_info_id = t1.staff_info_id

        WHERE 1=1
            and td.created_at >= date_sub(date_sub(curdate(), interval 1 day), interval 8 hour )
            and td.created_at < date_sub(curdate(), interval 8 hour)##正常的时间剪掉8h
            AND td.state <> 3 # stata=3(已关闭)
        GROUP BY 1,2,3,4,5,6
)t2
group by 1,2,3
)


,main as (

SELECT
*
,COUNT(tt.staff_info_id) over (PARTITION by tt.work_store_id) 网点当日派件人数
,ROW_NUMBER() OVER (PARTITION by tt.work_store_id order by tt.当天派件数 desc) 人效排名
from
(
    SELECT
    ##IFNULL(swa.attendance_date,DATE(convert_tz(NOW(),'+08:00','+08:00'))) 统计日期
    swa.stat_date
    ,swa.staff_info_id
    ,swa.staff_name
    ,swa.state_desc #状态描述
    ,case when swa.wait_leave_state in ('0') then '非待离职'
        when swa.wait_leave_state in ('1') then '待离职'
    else swa.wait_leave_state end as wait_leave_state #是否待离职
    ,swa.attendance_started_at #上班打卡时间
    ,swa.attendance_end_at     #下班打卡时间
    ,swa.attendance_hour       #工作时长
    ,ROUND(time_to_sec(timediff(swa.shift_start,date_format(swa.attendance_started_at,"%H:%i:%s"))) /60,2) 迟到时长
    ,case when swa.is_plan_rest = 1 then '排休无需打卡'
        when  swa.is_plan_rest = 0 and swa.attendance_started_at is null then '无上班打卡时间'
        when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 59 then '未迟到'
        when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 359 then '迟到5min内'
        #when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 659 then '迟到5-10min'
        #when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 959 then '迟到10-15min'
        #when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 1259 then '迟到15-20min'
        #when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 1559 then '迟到20-25min'
        when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 1859 then '迟到5-30min'
    else '迟到30min以上' end as 迟到情况
    ,case when swa.is_outsource = 1 then '是' else '否' end as is_outsource#是否外协
    ,case when swa.is_plan_rest = 1 then '是' else '否' end as is_plan_rest#是否排休
    ,swa.hire_days      #在职天数
    ,swa.job_title      #岗位
    ,swa.store_id       #归属网点ID
    ,swa.store_name     #归属网点名称
    ,swa.store_category_desc   #网点类型描述
    ,swa.region_name           #归属大区
    ,swa.piece_name            #归属片区
    ,tiktok_area.area_name tiktok_area
    ,swa.staff_attr
    ,case when swa.supply_store_id is null then swa.store_id else swa.supply_store_id end as work_store_id #当日所属网点
    ,case when swa.supply_store_id is not null then ss.name
        when swa.supply_store_id is null then swa.store_name
    end as work_store_name #当日所属网点

    ,lanshou.揽件量
    ,jiaojie.交接量
    ,tuotou.当天派件数
    ,pp.拒收包裹数
    ,pp.运力不足包裹数
    ,pp.改约包裹数
    ,pp.客户不在家_电话无人接听包裹数
    ,pp.收件人号码空号包裹数
    ,pp.收件人号码错误包裹数
    ,pp.收件人地址不清晰或不正确包裹数
    ,pp.货物丢失包裹数
    ,pp.货物短少包裹数
    ,pp.货物破损包裹数
    ,pp.外包装破损包裹数
    ,pp.禁运品包裹数
    ,pp.其他派件标记包裹数

    ,IF(tuotou.当天派件数=1,TIMESTAMPDIFF(MINUTE,tuotou.finished_min,tuotou.finished_max),ROUND(TIMESTAMPDIFF(MINUTE,tuotou.finished_min,tuotou.finished_max) / (tuotou.当天派件数-1),2)) '派件间隔(分钟)'
    ,ROUND(tuotou.当天派件数 / jiaojie.交接量,2) '派件/交接'
    ,jiaojie.'交接5KG以上'
    ,tuotou.'妥投5KG以上'
    ,tuotou.tuotou_num_50 as '网点50米内派件量'
    ,jiaojie.delivery_min 最早交接时间
    ,jiaojie.delivery_max 最近交接时间
    ,ROUND(TIMESTAMPDIFF(MINUTE,jiaojie.delivery_min,jiaojie.delivery_max)/60,2) '交接工作时间'
    ,tuotou.finished_min  最早派件时间
    ,tuotou.finished_max  最近派件时间
    ,ROUND(TIMESTAMPDIFF(MINUTE,tuotou.finished_min,tuotou.finished_max)/60,2) '派件工作时间'
    ,lanshou.created_min  最早揽件时间
    ,lanshou.created_max  最近揽件时间
    ,ROUND(TIMESTAMPDIFF(MINUTE,lanshou.created_min,lanshou.created_max)/60,2) '揽件工作时间'


    ,swa.handover_par_cnt
    ,swa.handover_start_at
    ,swa.handover_end_at
    ,swa.handover_hour
    ,swa.delivery_par_cnt
    ,swa.delivery_start_at
    ,swa.delivery_end_at
    ,swa.delivery_hour
    ,swa.delivery_end_at2
    ,swa.delivery_hour2


    ##FROM ph_bi.hr_staff_info hsi

    ##left join ph_backyard.staff_work_attendance swa
    ##on swa.staff_info_id=hsi.staff_info_id
    ##and swa.attendance_date = date(convert_tz(now(),'+08:00','+08:00'))


    from dwm.dws_ph_staff_wide_s swa

    left join ph_bi.hr_staff_info hsi
    on swa.staff_info_id=hsi.staff_info_id

    left join ph_staging.sys_store ssd
    on swa.store_id = ssd.id

    left join ph_staging.sys_store ss
    on swa.supply_store_id = ss.id
    #on ss.category in (1,10) and
    ##on swa.started_store_id = ss.id

    left join ph_staging.sys_manage_piece smp
    on smp.id=ss.manage_piece

    left join ph_staging.sys_manage_region smr
    on smr.id=ss.manage_region

    left join
    (
        select distinct
            tiktok_area.dst_province_code province_code
            ,case tiktok_area.dst_area_code
                when 'MM' then 'MM'
                when 'GMA' then 'GMA'
                when 'LUZON 1' then 'Luz 1'
                when 'LUZON 2' then 'Luz 2'
                when 'LUZON 3' then 'Luz 3'
                when 'LUZON 4' then 'Luz 4'
                when 'MINDANAO 1' then 'Min 1'
                when 'MINDANAO 2' then 'Min 2'
                when 'VISAYAS 1' then 'Vis 1'
                when 'VISAYAS 2' then 'Vis 2'
            end area_name
        from dwm.dwd_ph_dict_tiktok_period_rules tiktok_area
    ) tiktok_area
    on ssd.province_code = tiktok_area.province_code

    left join
    (
        select
            td2.staff_info_id
            ,COUNT(DISTINCT td2.pno) '交接量'
            ,COUNT(DISTINCT CASE WHEN (pi.exhibition_length + pi.exhibition_width + pi.exhibition_height > 80 OR pi.exhibition_weight > 5000) THEN td2.pno ELSE NULL END)'交接5KG以上'
            ##,MIN(DATE_FORMAT(convert_tz(td2.created_at,'+00:00','+08:00'),'%T')) AS delivery_min ##最早交接时间
            ##,MAX(DATE_FORMAT(convert_tz(td2.created_at,'+00:00','+08:00'),'%T')) AS delivery_max ##最近交接时间
            ,MIN(convert_tz(td2.created_at,'+00:00','+08:00')) AS delivery_min ##最早交接时间
            ,MAX(convert_tz(td2.created_at,'+00:00','+08:00')) AS delivery_max ##最近交接时间

        from ph_staging.ticket_delivery td2
        left join ph_staging.parcel_info pi
        ON pi.pno = td2.pno
        WHERE 1=1
            and td2.created_at >= date_sub(date_sub(curdate(), interval 1 day), interval 8 hour )
            and td2.created_at < date_sub(curdate(), interval 8 hour)##正常的时间剪掉8h
            AND td2.state <> 3 # stata=3(已关闭)
        GROUP BY 1
    ) jiaojie # 交接量
    ON jiaojie.staff_info_id = hsi.staff_info_id

    LEFT JOIN
    (
        SELECT
            pi.ticket_delivery_staff_info_id
            ,date(convert_tz(pi.finished_at,'+00:00','+08:00')) as finished_dt
            ,MIN((convert_tz(pi.finished_at,'+00:00','+08:00')))  AS finished_min ##派件开始时间
            ,MAX((convert_tz(pi.finished_at,'+00:00','+08:00')))  AS finished_max ##派件结束时间
            ,COUNT(DISTINCT if(ROUND(st_distance_sphere(point(pi.ticket_delivery_staff_lng,pi.ticket_delivery_staff_lat), point(ss.lng,ss.lat)),0) < 50,pi.pno,null))  as tuotou_num_50
            ,IFNULL(COUNT(DISTINCT pi.pno),0) '当天派件数'
            ,COUNT(DISTINCT CASE WHEN (pi.exhibition_length + pi.exhibition_width + pi.exhibition_height > 80 OR pi.exhibition_weight > 5000) THEN pi.pno ELSE NULL END) as 妥投5KG以上
            ##,CASE WHEN ROUND(st_distance_sphere(point(pi.ticket_delivery_staff_lng,pi.ticket_delivery_staff_lat), point(ss.lng,ss.lat)),0) >= 50 THEN MIN((convert_tz(pi.finished_at,'+00:00','+08:00'))) END AS 派件开始时间
            ##,CASE WHEN ROUND(st_distance_sphere(point(pi.ticket_delivery_staff_lng,pi.ticket_delivery_staff_lat), point(ss.lng,ss.lat)),0) >= 50 THEN MAX((convert_tz(pi.finished_at,'+00:00','+08:00'))) END AS 派件结束时间

        ##FROM tmpale.parcel_in_warehouse_today dsdt  ##在仓表

        from ph_staging.parcel_info pi
        ##ON dsdt.pno = pi.pno

        LEFT JOIN ph_staging.sys_store ss
        on ss.id = pi.dst_store_id

        WHERE  1=1
            and pi.finished_at >= date_sub(date_sub(curdate(), interval 1 day), interval 8 hour )
            and pi.finished_at < date_sub(curdate(), interval 8 hour)##正常的时间剪掉8h
            and pi.state in ('5')
        GROUP BY 1
    )tuotou # 妥投
    ON tuotou.ticket_delivery_staff_info_id = hsi.staff_info_id

    LEFT JOIN
    (
        SELECT
            pi.ticket_pickup_staff_info_id
            ,date(convert_tz(pi.created_at,'+00:00','+08:00')) as created_at
            ,COUNT(DISTINCT(pi.pno))  '揽件量'
            ,MIN((convert_tz(pi.created_at,'+00:00','+08:00'))) AS created_min ##揽件开始时间
            ,MAX((convert_tz(pi.created_at,'+00:00','+08:00'))) AS created_max ##揽件结束时间

        FROM ph_staging.parcel_info pi

        WHERE 1=1
            and pi.state <> 9
            and pi.returned = 0
            and pi.created_at >= date_sub(date_sub(curdate(), interval 1 day), interval 8 hour )
            and pi.created_at < date_sub(curdate(), interval 8 hour)##正常的时间剪掉8h
        GROUP BY 1
    ) lanshou # 揽收量
    ON lanshou.ticket_pickup_staff_info_id = hsi.staff_info_id

    LEFT JOIN
    (
        SELECT
            pr.staff_info_id
            ,date(convert_tz(pr.routed_at,'+00:00','+08:00')) as routed_at
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (2)    THEN pr.pno ELSE NULL END)) 拒收包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (70) THEN pr.pno ELSE NULL END)) 改约包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (71)   THEN pr.pno ELSE NULL END)) 运力不足包裹数
            ##,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (8,16)    THEN pr.pno ELSE NULL END)) 联系不上包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (1)    THEN pr.pno ELSE NULL END))  客户不在家_电话无人接听包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (78)   THEN pr.pno ELSE NULL END)) 收件人号码空号包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (75)   THEN pr.pno ELSE NULL END)) 收件人号码错误包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (73)   THEN pr.pno ELSE NULL END)) 收件人地址不清晰或不正确包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (7)    THEN pr.pno ELSE NULL END)) 货物丢失包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (6)    THEN pr.pno ELSE NULL END)) 货物短少包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (5)    THEN pr.pno ELSE NULL END)) 货物破损包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (4)    THEN pr.pno ELSE NULL END)) 外包装破损包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (69)    THEN pr.pno ELSE NULL END)) 禁运品包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category not IN (1,2,4,5,6,7,69,70,71,73,75,78)    THEN pr.pno ELSE NULL END)) 其他派件标记包裹数


        ##FROM tmpale.parcel_in_warehouse_today dsdt

        from ph_staging.parcel_route pr
        left join ph_staging.parcel_info pi
        ON pi.pno = pr.pno

        WHERE 1=1
            AND pr.route_action = 'DELIVERY_MARKER' #派件标记
            and pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day), interval 8 hour )
            and pr.routed_at < date_sub(curdate(), interval 8 hour)##正常的时间剪掉8h
        GROUP BY 1
    )pp #问题包裹数
    ON pp.staff_info_id = hsi.staff_info_id

    WHERE 1=1
    AND DATE(swa.stat_date) = date_sub(curdate(),interval 1 day)
    AND swa.store_category IN (1,10,14) # 网点类型 1,10
    and hsi.state = 1
    and swa.job_title IN (13,110,1000)

)tt


)


, car_arrive  as (
##网点正班车到达时间
select date(ft.real_arrive_time) as proof_dt##日期
    ,ft.next_store_id
    ,ft.next_store_name
    ,ft33.plan_arrive_dt as plan_arrive_first##正班车第一趟计划到达时间
    ,ft11.real_arrive_time as arrive_time_first##正班车第一趟到达时间
    ,ft22.real_arrive_time as arrive_time_last##正班车最后一趟到达时间
    ,case when ft11.real_arrive_time = ft22.real_arrive_time then '只有一趟正班车' else '多趟正班车' end as proof_num
    ,case when date_format(ft11.real_arrive_time,'%H:%i') is null then '10:00'
          when date_format(ft11.real_arrive_time,'%H:%i') < '07:00' then '09:30'
          when date_format(ft11.real_arrive_time,'%H:%i') between '07:00' and '09:00' then date_format(date_add(ft11.real_arrive_time,interval 150 minute),'%H:%i')
          when date_format(ft11.real_arrive_time,'%H:%i') > '09:00' then '10:00'
    else '其他' end as min_tuotou_time

from (
        select next_store_id
            ,next_store_name
            ,real_arrive_time
            ,date(real_arrive_time) as real_arrive_dt
            ,proof_id
        from ph_bi.fleet_time
        where 1=1
            and line_mode =1##正班车
            and arrive_type in ('3','5')
            and fleet_status in ('1')
            and date(real_arrive_time) = date_sub(curdate(),interval 1 day)

) ft

left join
(##最早到达时间
    select ft1.next_store_id
        ,ft1.next_store_name
        ,ft1.real_arrive_time
        ,ft1.real_arrive_dt
        ,ft1.proof_id
        ,ft1.rn
    from
    (
        select next_store_id
            ,next_store_name
            ,real_arrive_time
            ,date(real_arrive_time) as real_arrive_dt
            ,proof_id
            ,row_number() over (partition by date(real_arrive_time),next_store_id,next_store_name order by real_arrive_time asc) as rn
        from ph_bi.fleet_time
        where 1=1
            and line_mode =1##正班车
            and arrive_type in ('3','5')
            and fleet_status in ('1')
            and date(real_arrive_time) = date_sub(curdate(),interval 1 day)
    )ft1
    where ft1.rn = 1
)ft11
on ft11.next_store_id = ft.next_store_id and ft11.real_arrive_dt = ft.real_arrive_dt
left join (
    ##最晚到达时间
    select ft2.next_store_id
        ,ft2.next_store_name
        ,ft2.real_arrive_time
        ,ft2.real_arrive_dt
        ,ft2.proof_id
        ,ft2.rn
    from (
        select next_store_id
            ,next_store_name
            ,real_arrive_time
            ,date(real_arrive_time) as real_arrive_dt
            ,proof_id
            ,row_number() over (partition by date(real_arrive_time),next_store_id,next_store_name order by real_arrive_time desc) as rn
        from ph_bi.fleet_time
        where 1=1
            and line_mode =1
            and arrive_type in ('3','5')
            and fleet_status in ('1')
            and date(real_arrive_time) = date_sub(curdate(),interval 1 day)
    )ft2
    where ft2.rn = 1
)ft22
on ft22.next_store_id = ft.next_store_id and ft22.real_arrive_dt = ft.real_arrive_dt

left join(
##第一趟正班车计划到达时间
    select ft1.next_store_id
        ,ft1.next_store_name
        ,ft1.plan_arrive_time
        ,ft1.plan_arrive_dt
        ,ft1.proof_id
        ,ft1.rn
    from
    (
        select next_store_id
            ,next_store_name
            ,plan_arrive_time
            ,date(plan_arrive_time) as plan_arrive_dt
            ,proof_id
            ,row_number() over (partition by date(plan_arrive_time),next_store_id,next_store_name order by plan_arrive_time asc) as rn
        from ph_bi.fleet_time
        where 1=1
            and line_mode =1##正班车
            and arrive_type in ('3','5')
            and fleet_status in ('1')
            and date(plan_arrive_time) = date_sub(curdate(),interval 1 day)
    )ft1
    where rn = 1

)ft33
on ft33.next_store_id = ft.next_store_id and ft33.plan_arrive_dt = ft.real_arrive_dt

where 1=1
    and date(ft.real_arrive_time) = date_sub(curdate(),interval 1 day)
    and ft11.real_arrive_time is not null
    and ft22.real_arrive_time is not null
group by 1,2,3,4,5,6,7,8
)


,staff_delivery_code as (
# 快递员绑定情况
select
    t.store_id
    ,t.name
    ,t.staff_info_id
    ,count(distinct t.delivery_code) 三段码绑定数量
    ,group_concat(distinct t.delivery_code SEPARATOR ' / ') 三段码绑定情况
    ,count(distinct t.district_code) barangay绑定数量
    ,group_concat(concat(t.delivery_code,':',t.barangay_name) order by t.delivery_code SEPARATOR ' / ') 绑定明细情况
from
    (
    select
        sdbsi.store_id # 网点id
        ,ss.name # 网点名称
        ,sdbsi.staff_info_id # 员工id
        ,sdbsi.delivery_code # 绑定的三段码
        ,sdbsi.district_code # 绑定的barangayID
        ,sd.name barangay_name # 绑定的barangay名称
    from ph_staging.store_delivery_barangay_staff_info sdbsi
    left join ph_staging.sys_district sd
    on sdbsi.district_code  = sd.code
    left join ph_staging.sys_store ss
    on sdbsi.store_id  = ss.id
    where 1=1
        and sdbsi.deleted = 0 # 非剔除记录
        and ss.category  = 1 # SP网点
    group by 1,2,3,4,5,6
    )t
group by 1,2,3
)


,handover_14days as (
##各区域近14天人均交接量
select m1.area_name
    ,m1.manage_region
    ,round(sum(avg_decnt)/14,0) per_capita_handover
    ,round((sum(avg_decnt)/14)*0.8,0) per_capita_h

from (
select
    date(convert_tz(td.created_at,"+00:00","+08:00")) stat_date
    ##,case when tiktok_area.area_name in ('MM') and mr.name in ('Area1') then 'MM_Area1'
    ##    when tiktok_area.area_name in ('GMA') and mr.name in ('Area1') then 'GMA_Area1'
    ##    when tiktok_area.area_name in ('Luz 3') and mr.name in ('Area1') then 'Luz3_Area1'
    ##else mr.name end as area
    ,tiktok_area.area_name
    ,mr.name manage_region
    ,COUNT(distinct td.pno)  pnos
    #,COUNT(DISTINCT CASE WHEN (pi.exhibition_length + pi.exhibition_width + pi.exhibition_height > 80 OR pi.exhibition_weight > 5000) THEN dc.pno ELSE NULL END) delivery_5KG
    ,count(distinct td.staff_info_id ) staff_cut
    ,round(COUNT(distinct td.pno)/count(distinct td.staff_info_id ) ,0) avg_decnt
FROM ph_staging.ticket_delivery td

##left join ph_staging.ticket_delivery td
##on td.pno =dc.pno and dc.stat_date =date(convert_tz(td.delivery_at,"+00:00","+08:00")) and td.state in (0,1,2)

left join ph_staging.parcel_info pi
ON td.pno = pi.pno

left join ph_bi.sys_store ssd
on ssd.id = pi.dst_store_id

left join dwm.dwd_ph_dict_lazada_period_rules lazada_area
on ssd.province_code = lazada_area.province_code

left join ph_staging.shopee_period_limitation_rules_area shopee_area
on ssd.province_code = shopee_area.province_code

left join
(
    select distinct
        tiktok_area.dst_province_code province_code
        ,case tiktok_area.dst_area_code
            when 'MM' then 'MM'
            when 'GMA' then 'GMA'
            when 'LUZON 1' then 'Luz 1'
            when 'LUZON 2' then 'Luz 2'
            when 'LUZON 3' then 'Luz 3'
            when 'LUZON 4' then 'Luz 4'
            when 'MINDANAO 1' then 'Min 1'
            when 'MINDANAO 2' then 'Min 2'
            when 'VISAYAS 1' then 'Vis 1'
            when 'VISAYAS 2' then 'Vis 2'
        end area_name
    from dwm.dwd_ph_dict_tiktok_period_rules tiktok_area
) tiktok_area
on ssd.province_code = tiktok_area.province_code

LEFT JOIN ph_staging.sys_manage_region mr
ON ssd.manage_region = mr.id

LEFT JOIN ph_staging.sys_manage_piece mp
ON ssd.manage_piece = mp.id

left join ph_bi.hr_staff_info hsi
on td.staff_info_id = hsi.staff_info_id

where 1=1
    ##and date(dc.stat_date) >= date_sub(curdate(),interval 14 day)

    and td.created_at >= date_sub(date_sub(curdate(), interval 14 day), interval 8 hour )
    and td.created_at < date_sub(curdate(), interval 8 hour)##正常的时间剪掉8h

    and ssd.category =1 ##sp网点
    and mr.name not in ('FHome')
    and hsi.job_title in ('13','110','452','1000')
GROUP BY 1,2,3
)m1
group by 1,2
)


,finished_14days as (
##各区域近14天人均妥投量
select
    m1.tiktok_area as area_name
    ,m1.manage_region
    ,round(sum(avg_decnt)/14,0) per_capita_finished
    ,round((sum(avg_decnt)/14)*0.8,0) per_capita_f

from (
select
    date(convert_tz(pi.finished_at,'+00:00','+08:00')) as finished_dt
    ,mr.name manage_region
    ,tiktok_area.area_name tiktok_area
    ,count(distinct pi.pno) pnos
    ##,COUNT(DISTINCT CASE WHEN (pi.exhibition_length + pi.exhibition_width + pi.exhibition_height > 80 OR pi.exhibition_weight > 5000) THEN pi.pno ELSE NULL END) finished_5KG
    ,count(distinct pi.ticket_delivery_staff_info_id) staff_info_id
    ,round(COUNT(distinct pi.pno)/count(distinct pi.ticket_delivery_staff_info_id) ,0) avg_decnt

from ph_staging.parcel_info pi

left join ph_staging.sys_store ssd
on pi.dst_store_id = ssd.id

left join dwm.dwd_ph_dict_lazada_period_rules lazada_area
on ssd.province_code = lazada_area.province_code

left join ph_staging.shopee_period_limitation_rules_area shopee_area
on ssd.province_code = shopee_area.province_code

left join
(
    select distinct
        tiktok_area.dst_province_code province_code
        ,case tiktok_area.dst_area_code
            when 'MM' then 'MM'
            when 'GMA' then 'GMA'
            when 'LUZON 1' then 'Luz 1'
            when 'LUZON 2' then 'Luz 2'
            when 'LUZON 3' then 'Luz 3'
            when 'LUZON 4' then 'Luz 4'
            when 'MINDANAO 1' then 'Min 1'
            when 'MINDANAO 2' then 'Min 2'
            when 'VISAYAS 1' then 'Vis 1'
            when 'VISAYAS 2' then 'Vis 2'
        end area_name
    from dwm.dwd_ph_dict_tiktok_period_rules tiktok_area
) tiktok_area
on ssd.province_code = tiktok_area.province_code

LEFT JOIN ph_staging.sys_manage_region mr
ON ssd.manage_region = mr.id

LEFT JOIN ph_staging.sys_manage_piece mp
ON ssd.manage_piece = mp.id

left join ph_bi.hr_staff_info hsi
on pi.ticket_delivery_staff_info_id = hsi.staff_info_id

where 1=1
    and pi.finished_at >= date_sub(date_sub(curdate(), interval 14 day), interval 8 hour )
    and pi.finished_at < date_sub(curdate(), interval 8 hour)##正常的时间剪掉8h
    and ssd.category =1 ##sp网点
    and pi.state = 5
    and mr.name not in ('FHome')
    and hsi.job_title in ('13','110','452','1000')
group by 1,2,3
)m1
group by 1,2
)

,should_delivery as
(#网点人均可交接
    select
        date(dc.stat_date) stat_date
        ,dc.store_id
        ,ss.name
        ,COUNT(distinct dc.`pno`)  cnt
        ,count(distinct td.`staff_info_id` ) staff_cut
        ,round(COUNT(distinct dc.`pno`)/count(distinct td.`staff_info_id` ) ,0) avg_decnt
    ##FROM dwm.dwd_ph_dc_should_delivery_d dc
    from ph_bi.dc_should_delivery_today dc
    left join `ph_staging`.`ticket_delivery` td
    on td.`pno` =dc.`pno` and dc.`stat_date` =date(convert_tz(td.`delivery_at`,"+00:00","+08:00")) and td.`state`in (0,1,2)
    left join ph_bi.`sys_store` ss on ss.`id` =dc.`store_id`
    where dc.`stat_date` = date_sub(CURRENT_DATE ,interval 1 day)
        and ss.`category` =1
        and dc.`state` <6
    GROUP BY 1,2,3
)

,area_delivery as (
    select
    t1.员工ID
    ,t1.交接区域数量_all
    ,t1.交接区域数量
    ,t1.交接数_all
    ,t1.交接数
    ,t1.第二区域交接数
    ,t1.交接情况
    ,t2.妥投区域数量
    ,t2.妥投数
    ,t2.妥投情况
    from
    (
        select
            tt.员工ID
            ,count(distinct tt.三段码) 交接区域数量_all
            ,count(distinct if(tt.`交接包裹数` > 3,tt.三段码,null)) 交接区域数量
            ,sum(tt.交接包裹数) 交接数_all
            ,sum(if(tt.`交接包裹数` > 3,tt.交接包裹数,0)) as 交接数
            ,group_concat(concat(tt.网点名称,':',tt.三段码,':',tt.交接包裹数,'(',tt.当日在仓,')') order by tt.交接包裹数 desc SEPARATOR ' / ') 交接情况
            ,tt.第二区域交接数
        from
        (
            select
                date(convert_tz(td.created_at,'+00:00','+08:00')) as delivery_dt
                ,mr.name `大区`
                ,mp.name `片区`
                ,dsdt.dst_store_id
                ,ssd.name `网点名称`
                ,tiktok_area.area_name tiktok_area
                ,lazada_area.area_name lazada_area
                ,case shopee_area.area_id when 1 then 'MM'  when 2 then 'GMA '  when 3 then 'Luz 1'  when 4 then 'Luz 2'  when 5 then 'Luz 3' when 6 then 'Vis 1'  when 7 then 'Vis 2'  when 8 then 'Min 1'  when 9 then 'Min 2'  when 10 then 'Luz 4' end as shopee_area
                ,hsi.name `快递员姓名`
                ,td.staff_info_id `员工ID`
                ,if(hsi.job_title = 13,'BIKE',if(hsi.job_title = 110,'VAN',if(hsi.job_title = 452,'BOAT',if(hsi.job_title = 1000,'Tricycle','other')))) `快递员职位`
                ,ddpsci.third_sorting_code `三段码`
                ,sdmzc.当日在仓
                ,count(distinct td.pno) `交接包裹数`
                ,nth_value(count(distinct td.pno),2) over(partition by ssd.name,td.staff_info_id order by count(distinct td.pno) desc) 第二区域交接数

            from ph_staging.ticket_delivery td

            ##left join ph_staging.parcel_info pi
            ##on pi.pno = td.pno

            left join dwm.dwd_ph_non_end_pno_detl_d dsdt
            on td.pno = dsdt.pno

            left join
            (
                select
                    ddpsci.pno
                    ,ddpsci.third_sorting_code
                    ,row_number() over(partition by ddpsci.pno order by ddpsci.created_at desc) rk
                from ph_drds.parcel_sorting_code_info ddpsci
                where 1=1
                    and ddpsci.created_at >= date_sub(current_date(),91)
            ) ddpsci
            on dsdt.pno = ddpsci.pno and ddpsci.rk = 1

            left join ph_staging.sys_store ssd
            on dsdt.dst_store_id = ssd.id

            left join dwm.dwd_ph_dict_lazada_period_rules lazada_area
            on ssd.province_code = lazada_area.province_code

            left join ph_staging.shopee_period_limitation_rules_area shopee_area
            on ssd.province_code = shopee_area.province_code

            left join

            (
                select distinct
                    tiktok_area.dst_province_code province_code
                    ,case tiktok_area.dst_area_code
                        when 'MM' then 'MM'
                        when 'GMA' then 'GMA'
                        when 'LUZON 1' then 'Luz 1'
                        when 'LUZON 2' then 'Luz 2'
                        when 'LUZON 3' then 'Luz 3'
                        when 'LUZON 4' then 'Luz 4'
                        when 'MINDANAO 1' then 'Min 1'
                        when 'MINDANAO 2' then 'Min 2'
                        when 'VISAYAS 1' then 'Vis 1'
                        when 'VISAYAS 2' then 'Vis 2'
                    end area_name
                from dwm.dwd_ph_dict_tiktok_period_rules tiktok_area
            ) tiktok_area
            on ssd.province_code = tiktok_area.province_code

            LEFT JOIN ph_staging.sys_manage_region mr
            ON ssd.manage_region = mr.id

            LEFT JOIN ph_staging.sys_manage_piece mp
            ON ssd.manage_piece = mp.id

            left join ph_bi.hr_staff_info hsi
            on td.staff_info_id = hsi.staff_info_id

            left join
            (#网点各三段码在仓、已交接、积压
                SELECT
                    dsdt.stat_date
                    ,ssd.id `store_id`
                    ,ssd.name `网点名称`
                    ,ddpsci.third_sorting_code `区域编码`

                    ,count(dsdt.pno) '当日在仓'
                    ,count(case when dsdt.is_handover = 1 then dsdt.pno else null end)  `已交接量`
                    ,count(case when dsdt.state not in ('已签收','疑难件','已退件','异常关闭') then dsdt.pno else null end) `积压件量`

                FROM dwm.dwd_ph_non_end_pno_detl_d dsdt

                left join ph_staging.parcel_info pi
                on dsdt.pno = pi.pno

                left join
                (
                    select
                        ddpsci.pno
                        ,ddpsci.third_sorting_code
                        ,row_number() over(partition by ddpsci.pno order by ddpsci.created_at desc) rk
                    from ph_drds.parcel_sorting_code_info ddpsci
                    where 1=1
                        and ddpsci.created_at >= date_sub(current_date(),91)
                ) ddpsci
                on pi.pno = ddpsci.pno
                and ddpsci.rk = 1

                left join ph_staging.sys_store ssd
                on dsdt.dst_store_id = ssd.id

                where 1=1
                    and dsdt.stat_date  = date_sub(curdate(),interval 1 day)
                    and ssd.category in ('1','10')##SP  网点
                GROUP BY 1,2,3,4
                order by 1,2,3,4
            )sdmzc
            on sdmzc.store_id = ssd.id
            and sdmzc.区域编码 = ddpsci.third_sorting_code

            where 1=1
                and td.created_at >= date_sub(date_sub(curdate(), interval 1 day), interval 8 hour )
                and td.created_at < date_sub(curdate(), interval 8 hour)##正常的时间剪掉8h
                and td.state <> 3
            group by 1,2,3,4,5,6,7,8,9,10,11,12,13
        ) tt
        group by 1
    ) t1

    left join

    (
        select
            tt.员工ID
            ,count(distinct tt.三段码) 妥投区域数量
            ,sum(tt.妥投包裹数) 妥投数
            ,group_concat(concat(tt.网点名称,':',tt.三段码,':',tt.妥投包裹数) order by tt.妥投包裹数 desc SEPARATOR ' / ') 妥投情况
        from
        (
            select date(convert_tz(pi.finished_at,'+00:00','+08:00')) as finished_dt
                ,mr.name `大区`
                ,mp.name `片区`
                ,ssd.sorting_no `分拣大区`
                ,dsdt.dst_store_id
                ,ssd.name `网点名称`
                ,tiktok_area.area_name tiktok_area
                ,lazada_area.area_name lazada_area
                ,case shopee_area.area_id when 1 then 'MM'  when 2 then 'GMA '  when 3 then 'Luz 1'  when 4 then 'Luz 2'  when 5 then 'Luz 3' when 6 then 'Vis 1'  when 7 then 'Vis 2'  when 8 then 'Min 1'  when 9 then 'Min 2'  when 10 then 'Luz 4' end as shopee_area
                ,hsi.name `快递员姓名`
                ,pi.ticket_delivery_staff_info_id `员工ID`
                ,if(hsi.job_title = 13,'BIKE',if(hsi.job_title = 110,'VAN',if(hsi.job_title = 452,'BOAT',if(hsi.job_title = 1000,'Tricycle','other')))) `快递员职位`
                ,ddpsci.third_sorting_code `三段码`
                ,count(distinct pi.pno) `妥投包裹数`

            from ph_staging.parcel_info pi

            left join dwm.dwd_ph_non_end_pno_detl_d dsdt
            on pi.pno = dsdt.pno

            left join
            (
                select
                    ddpsci.pno
                    ,ddpsci.third_sorting_code
                    ,row_number() over(partition by ddpsci.pno order by ddpsci.created_at desc) rk
                from ph_drds.parcel_sorting_code_info ddpsci
                where 1=1
                    and ddpsci.created_at >= date_sub(current_date(),91)
            ) ddpsci
            on dsdt.pno = ddpsci.pno and ddpsci.rk = 1

            left join ph_staging.sys_store ssd
            on dsdt.dst_store_id = ssd.id

            left join dwm.dwd_ph_dict_lazada_period_rules lazada_area
            on ssd.province_code = lazada_area.province_code

            left join ph_staging.shopee_period_limitation_rules_area shopee_area
            on ssd.province_code = shopee_area.province_code

            left join

            (
                select distinct
                    tiktok_area.dst_province_code province_code
                    ,case tiktok_area.dst_area_code
                        when 'MM' then 'MM'
                        when 'GMA' then 'GMA'
                        when 'LUZON 1' then 'Luz 1'
                        when 'LUZON 2' then 'Luz 2'
                        when 'LUZON 3' then 'Luz 3'
                        when 'LUZON 4' then 'Luz 4'
                        when 'MINDANAO 1' then 'Min 1'
                        when 'MINDANAO 2' then 'Min 2'
                        when 'VISAYAS 1' then 'Vis 1'
                        when 'VISAYAS 2' then 'Vis 2'
                    end area_name
                from dwm.dwd_ph_dict_tiktok_period_rules tiktok_area
            ) tiktok_area
            on ssd.province_code = tiktok_area.province_code

            LEFT JOIN ph_staging.sys_manage_region mr
            ON ssd.manage_region = mr.id

            LEFT JOIN ph_staging.sys_manage_piece mp
            ON ssd.manage_piece = mp.id

            left join ph_bi.hr_staff_info hsi
            on pi.ticket_delivery_staff_info_id = hsi.staff_info_id

            where 1=1
            and pi.finished_at >= date_sub(date_sub(curdate(), interval 1 day), interval 8 hour )
            and pi.finished_at < date_sub(curdate(), interval 8 hour)##正常的时间剪掉8h
            and pi.state = 5
            group by 1,2,3,4,5,6,7,8,9,10,11,12,13
        ) tt
        group by 1
    ) t2

    on t1.员工ID = t2.员工ID
)


,staff_de as (
select
    t1.staff_info_id
    ,count(distinct t1.delivery_code) delivery_delivery_num##交接区域数量
    ,count(distinct t1.pno) delivery_num##交接数量
    ,count(distinct if(t2.pno_code is not null,t1.pno,null)) delivery_pnos_correct#绑定码的交接数量
    ,count(distinct if(t2.pno_code is null, t1.pno,null)) delivery_pnos_wrong #非绑定码的交接数量
    ,round(count(distinct if(t2.pno_code is null, t1.pno,null))/count(distinct t1.pno) ,2) as pnos_wrong_bili


from (
##包裹实际交接情况
select
    td.pno
    ,date(convert_tz(td.created_at,'+00:00','+08:00')) as delivery_dt
    ,mr.name region_name
    ,mp.name piece_name
    ,dsdt.dst_store_id store_id
    ,ssd.name store_name
    ,case when ssd.category = '1' then 'SP' when ssd.category = '10' then 'BDC' end DC_type
    ,tiktok_area.area_name tiktok_area
    ,lazada_area.area_name lazada_area
    ,case shopee_area.area_id when 1 then 'MM'  when 2 then 'GMA '  when 3 then 'Luz 1'  when 4 then 'Luz 2'  when 5 then 'Luz 3' when 6 then 'Vis 1'  when 7 then 'Vis 2'  when 8 then 'Min 1'  when 9 then 'Min 2'  when 10 then 'Luz 4' end as shopee_area
    ,hsi.name staff_name
    ,td.staff_info_id staff_info_id
    ,sd.province_code as province_code
    ,sp.name as province_name
    ,sd.city_code as city_code
    ,sc.name as city_name
    ,sd.code barangay_code
    ,sd.name barangay_name
    ,if(hsi.job_title = 13,'BIKE',if(hsi.job_title = 110,'VAN',if(hsi.job_title = 452,'BOAT',if(hsi.job_title = 1000,'Tricycle','other')))) job_title
    ,ddpsci.third_sorting_code as delivery_code
    ,CONCAT(td.staff_info_id,"-",ddpsci.sorting_code) pno_code
    ##,sdmzc.当日在仓
    ##,count(distinct td.pno) delivery_pnos
    ##,nth_value(count(distinct td.pno),2) over(partition by ssd.name,td.staff_info_id order by count(distinct td.pno) desc) 第二区域交接数

from ph_staging.ticket_delivery td

##left join ph_staging.parcel_info pi
##on pi.pno = td.pno

join dwm.dwd_ph_non_end_pno_detl_d dsdt##在仓表
on td.pno = dsdt.pno and date(convert_tz(td.created_at,'+00:00','+08:00')) = date(dsdt.stat_date)

left join ph_staging.parcel_info pi
on pi.pno = dsdt.pno

left join ph_staging.sys_district sd ##brgy的码
on pi.dst_district_code = sd.code

left join ph_bi.sys_city sc
on sc.code = sd.city_code

left join ph_bi.sys_province sp
on sp.code = sd.province_code

left join
(
    select
        ddpsci.pno
        ,ddpsci.dst_store_id
        ,ddpsci.dst_province_code
        ,ddpsci.dst_city_code
        ,ddpsci.dst_district_code
        ,ddpsci.third_sorting_code
        ,ddpsci.sorting_code
        ,row_number() over(partition by ddpsci.pno order by ddpsci.created_at desc) rk
    from ph_drds.parcel_sorting_code_info ddpsci
    where 1=1
        and ddpsci.created_at >= date_sub(current_date(),91)
) ddpsci
on dsdt.pno = ddpsci.pno and ddpsci.rk = 1


left join ph_staging.sys_store ssd
on dsdt.dst_store_id = ssd.id

left join dwm.dwd_ph_dict_lazada_period_rules lazada_area
on ssd.province_code = lazada_area.province_code

left join ph_staging.shopee_period_limitation_rules_area shopee_area
on ssd.province_code = shopee_area.province_code

left join
(
    select distinct
        tiktok_area.dst_province_code province_code
        ,case tiktok_area.dst_area_code
            when 'MM' then 'MM'
            when 'GMA' then 'GMA'
            when 'LUZON 1' then 'Luz 1'
            when 'LUZON 2' then 'Luz 2'
            when 'LUZON 3' then 'Luz 3'
            when 'LUZON 4' then 'Luz 4'
            when 'MINDANAO 1' then 'Min 1'
            when 'MINDANAO 2' then 'Min 2'
            when 'VISAYAS 1' then 'Vis 1'
            when 'VISAYAS 2' then 'Vis 2'
        end area_name
    from dwm.dwd_ph_dict_tiktok_period_rules tiktok_area
) tiktok_area
on ssd.province_code = tiktok_area.province_code

LEFT JOIN ph_staging.sys_manage_region mr
ON ssd.manage_region = mr.id

LEFT JOIN ph_staging.sys_manage_piece mp
ON ssd.manage_piece = mp.id

left join ph_bi.hr_staff_info hsi
on td.staff_info_id = hsi.staff_info_id

left join
(#网点各三段码在仓、已交接、积压
    SELECT
        dsdt.stat_date
        ,ssd.id `store_id`
        ,ssd.name `网点名称`
        ,ddpsci.third_sorting_code `区域编码`

        ,count(dsdt.pno) '当日在仓'
        ,count(case when dsdt.is_handover = 1 then dsdt.pno else null end)  `已交接量`
        ,count(case when dsdt.state not in ('已签收','疑难件','已退件','异常关闭') then dsdt.pno else null end) `积压件量`

    FROM dwm.dwd_ph_non_end_pno_detl_d dsdt

    left join ph_staging.parcel_info pi
    on dsdt.pno = pi.pno

    left join
    (
        select
            ddpsci.pno
            ,ddpsci.third_sorting_code
            ,row_number() over(partition by ddpsci.pno order by ddpsci.created_at desc) rk
        from ph_drds.parcel_sorting_code_info ddpsci
        where 1=1
            and ddpsci.created_at >= date_sub(current_date(),91)
    ) ddpsci
    on pi.pno = ddpsci.pno
    and ddpsci.rk = 1

    left join ph_staging.sys_store ssd
    on dsdt.dst_store_id = ssd.id

    where 1=1
        and dsdt.stat_date = date_sub(curdate(),interval 1 day)
        and ssd.category in ('1','10')##SP网点
    GROUP BY 1,2,3,4
    order by 1,2,3,4
)sdmzc
on sdmzc.store_id = ssd.id and sdmzc.区域编码 = ddpsci.third_sorting_code

where 1=1
    and td.created_at >= date_sub(date_sub(curdate(), interval 1 day), interval 8 hour )
    and td.created_at < date_sub(curdate(), interval 8 hour)##正常的时间剪掉8h
    and td.state <> 3
group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21

)t1

left join
(
#包裹理论交接情况，快递员绑定情况
select td.pno
    ,date(convert_tz(td.created_at,'+00:00','+08:00')) as delivery_dt
    ,dsdt.dst_store_id store_id
    ,ss.name store_name
    ,mr.name region_name
    ,mp.name piece_name
    ,tiktok_area.area_name tiktok_area
    ,lazada_area.area_name lazada_area
    ,case shopee_area.area_id when 1 then 'MM'  when 2 then 'GMA '  when 3 then 'Luz 1'  when 4 then 'Luz 2'  when 5 then 'Luz 3' when 6 then 'Vis 1'  when 7 then 'Vis 2'  when 8 then 'Min 1'  when 9 then 'Min 2'  when 10 then 'Luz 4' end as shopee_area
    ,case when ss.category = '1' then 'SP' when ss.category = '10' then 'BDC' end DC_type
    ,sd.province_code as province_code
    ,sp.name as province_name
    ,sd.city_code as city_code
    ,sc.name as city_name
    ,sd.code barangay_code
    ,sd.name barangay_name
    ,sdbsi.delivery_code delivery_code
    ,sdbsi.staff_info_id as staff_info_id
    ,CONCAT(sdbsi.staff_info_id,"-",ddpsci.sorting_code) pno_code
    ##,count(distinct t.delivery_code) 三段码绑定数量
    ##,group_concat(distinct t.delivery_code SEPARATOR ' / ') 三段码绑定情况
    ##,count(distinct t.district_code) barangay绑定数量
    ##,group_concat(concat(t.delivery_code,':',t.barangay_name) order by t.delivery_code SEPARATOR ' / ') 绑定明细情况

    from ph_staging.ticket_delivery td

    join dwm.dwd_ph_non_end_pno_detl_d dsdt##在仓表
    on td.pno = dsdt.pno and date(convert_tz(td.created_at,'+00:00','+08:00')) = date(dsdt.stat_date)

    ##left join ph_staging.parcel_info pi
    ##on pi.pno = td.pno

    left join
    (
        select
            ddpsci.pno
            ,ddpsci.dst_store_id
            ,ddpsci.dst_province_code
            ,ddpsci.dst_city_code
            ,ddpsci.dst_district_code
            ,ddpsci.third_sorting_code
            ,ddpsci.sorting_code
            ,row_number() over(partition by ddpsci.pno order by ddpsci.created_at desc) rk
        from ph_drds.parcel_sorting_code_info ddpsci
        where 1=1
            and ddpsci.created_at >= date_sub(current_date(),91)
    ) ddpsci
    on dsdt.pno = ddpsci.pno and ddpsci.rk = 1

    left join (
        select
            store_id
            ,delivery_code
            ,district_code
            ,staff_info_id
            ,deleted
        from  ph_staging.store_delivery_barangay_staff_info
        where deleted = 0
        group by
            store_id
            ,delivery_code
            ,district_code
            ,staff_info_id
            ,deleted
        )sdbsi
    on ddpsci.dst_store_id = sdbsi.store_id #网点
    and ddpsci.third_sorting_code = sdbsi.delivery_code #派送码
    and ddpsci.dst_district_code = sdbsi.district_code #barangay code

    left join ph_staging.sys_district sd
    on sdbsi.district_code  = sd.code

    left join ph_bi.sys_city sc
    on sc.code = sd.city_code

    left join ph_bi.sys_province sp
    on sp.code = sd.province_code

    left join ph_staging.sys_store ss
    on sdbsi.store_id  = ss.id

    LEFT JOIN ph_staging.sys_manage_region mr
    ON ss.manage_region = mr.id

    LEFT JOIN ph_staging.sys_manage_piece mp
    ON ss.manage_piece = mp.id

    left join dwm.dwd_ph_dict_lazada_period_rules lazada_area
    on ss.province_code = lazada_area.province_code

    left join ph_staging.shopee_period_limitation_rules_area shopee_area
    on ss.province_code = shopee_area.province_code

    left join

    (
        select distinct
        tiktok_area.dst_province_code province_code
        ,case tiktok_area.dst_area_code
        when 'MM' then 'MM'
        when 'GMA' then 'GMA'
        when 'LUZON 1' then 'Luz 1'
        when 'LUZON 2' then 'Luz 2'
        when 'LUZON 3' then 'Luz 3'
        when 'LUZON 4' then 'Luz 4'
        when 'MINDANAO 1' then 'Min 1'
        when 'MINDANAO 2' then 'Min 2'
        when 'VISAYAS 1' then 'Vis 1'
        when 'VISAYAS 2' then 'Vis 2'
        end area_name
        from dwm.dwd_ph_dict_tiktok_period_rules tiktok_area
    ) tiktok_area
    on ss.province_code = tiktok_area.province_code

where 1=1
    and td.created_at >= date_sub(date_sub(curdate(), interval 1 day), interval 8 hour )
    and td.created_at < date_sub(curdate(), interval 8 hour)##正常的时间剪掉8h
    and td.state <> 3
    and sdbsi.deleted = 0 # 非剔除记录
    and ss.category  = 1 # SP网点
group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19

)t2

on t1.pno_code = t2.pno_code

group by 1
)

,prout as (

select p1.staff_info_id
from (
SELECT
    date(convert_tz(pr.routed_at , '+00:00', '+08:00' ) )  routed_at #路由日期
    ,convert_tz(pr.routed_at , '+00:00', '+08:00' ) routed_time #路由时间
    ,lead(convert_tz(pr.routed_at , '+00:00', '+08:00' )) over (PARTITION by pr.staff_info_id,date(convert_tz(pr.routed_at , '+00:00', '+08:00' ) )    order by convert_tz(pr.routed_at , '+00:00', '+08:00' ))   下一条路由
    ,lead(pr.route_action) over (PARTITION by pr.staff_info_id,date(convert_tz(pr.routed_at , '+00:00', '+08:00' ) )    order by convert_tz(pr.routed_at , '+00:00', '+08:00' ))   下一条路由动作
    ,timestampdiff(hour,convert_tz(pr.routed_at , '+00:00', '+08:00' ),lead(convert_tz(pr.routed_at , '+00:00', '+08:00' )) over (PARTITION by pr.staff_info_id,date(convert_tz(pr.routed_at , '+00:00', '+08:00' ) )    order by convert_tz(pr.routed_at , '+00:00', '+08:00' )))  路由间隔时间
    ##,pr.pno
    ,pr.route_action
    ,case when route_action='ACCEPT_PARCEL'  then  '接件扫描'
        when route_action='ARRIVAL_GOODS_VAN_CHECK_SCAN'  then  '车货关联到港'
        when route_action='ARRIVAL_WAREHOUSE_SCAN'  then  '到件入仓扫描'
        when route_action='CANCEL_ARRIVAL_WAREHOUSE_SCAN'  then  '取消到件入仓扫描'
        when route_action='CANCEL_PARCEL'  then  '撤销包裹'
        when route_action='CANCEL_SHIPMENT_WAREHOUSE'  then  '取消发件出仓'
        when route_action='CHANGE_PARCEL_CANCEL'  then  '修改包裹为撤销'
        when route_action='CHANGE_PARCEL_CLOSE'  then  '修改包裹为异常关闭'
        when route_action='CHANGE_PARCEL_IN_TRANSIT'  then  '修改包裹为运输中'
        when route_action='CHANGE_PARCEL_INFO'  then  '修改包裹信息'
        when route_action='CHANGE_PARCEL_SIGNED'  then  '修改包裹为签收'
        when route_action='CLAIMS_CLOSE'  then  '理赔关闭'
        when route_action='CLAIMS_COMPLETE'  then  '理赔完成'
        when route_action='CLAIMS_CONTACT'  then  '已联系客户'
        when route_action='CLAIMS_TRANSFER_CS'  then  '转交总部cs处理'
        when route_action='CLOSE_ORDER'  then  '关闭订单'
        when route_action='CONTINUE_TRANSPORT'  then  '疑难件继续配送'
        when route_action='CREATE_WORK_ORDER'  then  '创建工单'
        when route_action='CUSTOMER_CHANGE_PARCEL_INFO'  then  '客户修改包裹信息'
        when route_action='CUSTOMER_OPERATING_RETURN'  then  '客户操作退回寄件人'
        when route_action='DELIVERY_CONFIRM'  then  '确认妥投'
        when route_action='DELIVERY_MARKER'  then  '派件标记'
        when route_action='DELIVERY_PICKUP_STORE_SCAN'  then  '自提取件扫描'
        when route_action='DELIVERY_TICKET_CREATION_SCAN'  then  '交接扫描'
        when route_action='DELIVERY_TRANSFER'  then  '派件转单'
        when route_action='DEPARTURE_GOODS_VAN_CK_SCAN'  then  '车货关联出港'
        when route_action='DETAIN_WAREHOUSE'  then  '货件留仓'
        when route_action='DIFFICULTY_FINISH_INDEMNITY'  then  '疑难件支付赔偿'
        when route_action='DIFFICULTY_HANDOVER'  then  '疑难件交接'
        when route_action='DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE'  then  '疑难件交接货件留仓'
        when route_action='DIFFICULTY_RE_TRANSIT'  then  '疑难件退回区域总部/重启运送'
        when route_action='DIFFICULTY_RETURN'  then  '疑难件退回寄件人'
        when route_action='DIFFICULTY_SEAL'  then  '集包异常'
        when route_action='DISCARD_RETURN_BKK'  then  '丢弃包裹的，换单后寄回BKK'
        when route_action='DISTRIBUTION_INVENTORY'  then  '分拨盘库'
        when route_action='DWS_WEIGHT_IMAGE'  then  'DWS复秤照片'
        when route_action='EXCHANGE_PARCEL'  then  '换货'
        when route_action='FAKE_CANCEL_HANDLE'  then  '虚假撤销判责'
        when route_action='FLASH_HOME_SCAN'  then  'FH交接扫描'
        when route_action='FORCE_TAKE_PHOTO'  then  '强制拍照路由'
        when route_action='HAVE_HAIR_SCAN_NO_TO'  then  '有发无到'
        when route_action='HURRY_PARCEL'  then  '催单'
        when route_action='INCOMING_CALL'  then  '来电接听'
        when route_action='INTERRUPT_PARCEL_AND_RETURN'  then  '中断运输并退回'
        when route_action='INVENTORY'  then  '盘库'
        when route_action='LOSE_PARCEL_TEAM_OPERATION'  then  '丢失件团队处理'
        when route_action='MANUAL_REMARK'  then  '添加备注'
        when route_action='MISS_PICKUP_HANDLE'  then  '漏包裹揽收判责'
        when route_action='MISSING_PARCEL_SCAN'  then  '丢失件包裹操作'
        when route_action='NOTICE_LOST_PARTS_TEAM'  then  '已通知丢失件团队'
        when route_action='PARCEL_HEADLESS_CLAIMED'  then  '无头件包裹已认领'
        when route_action='PARCEL_HEADLESS_PRINTED'  then  '无头件包裹已打单'
        when route_action='PENDING_RETURN'  then  '待退件'
        when route_action='PHONE'  then  '电话联系'
        when route_action='PICK_UP_STORE'  then  '待自提取件'
        when route_action='PICKUP_RETURN_RECEIPT'  then  '签回单揽收'
        when route_action='PRINTING'  then  '打印面单'
        when route_action='QAQC_OPERATION'  then  'QAQC判责'
        when route_action='RECEIVE_WAREHOUSE_SCAN'  then  '收件入仓'
        when route_action='RECEIVED'  then  '已揽收,初始化动作，实际情况并没有作用'
        when route_action='REFUND_CONFIRM'  then  '退件妥投'
        when route_action='REPAIRED'  then  '上报问题修复路由'
        when route_action='REPLACE_PNO'  then  '换单'
        when route_action='REPLY_WORK_ORDER'  then  '回复工单'
        when route_action='REVISION_TIME'  then  '改约时间'
        when route_action='SEAL'  then  '集包'
        when route_action='SEAL_NUMBER_CHANGE'  then  '集包件数变化'
        when route_action='SHIPMENT_WAREHOUSE_SCAN'  then  '发件出仓扫描'
        when route_action='SORTER_WEIGHT_IMAGE'  then  '分拣机复秤照片'
        when route_action='SORTING_SCAN'  then  '分拣扫描'
        when route_action='STAFF_INFO_UPDATE_WEIGHT'  then  '快递员修改重量'
        when route_action='STORE_KEEPER_UPDATE_WEIGHT'  then  '仓管员复秤'
        when route_action='STORE_SORTER_UPDATE_WEIGHT'  then  '分拣机复秤'
        when route_action='SYSTEM_AUTO_RETURN'  then  '系统自动退件'
        when route_action='TAKE_PHOTO'  then  '异常打单拍照'
        when route_action='THIRD_EXPRESS_ROUTE'  then  '第三方公司路由'
        when route_action='THIRD_PARTY_REASON_DETAIN'  then  '第三方原因滞留'
        when route_action='TICKET_WEIGHT_IMAGE'  then  '揽收称重照片'
        when route_action='TRANSFER_LOST_PARTS_TEAM'  then  '已转交丢失件团队'
        when route_action='TRANSFER_QAQC'  then  '转交QAQC处理'
        when route_action='UNSEAL'  then  '拆包'
        when route_action='UNSEAL_NO_PARCEL'  then  '上报包裹不在集包里'
        when route_action='UNSEAL_NOT_SCANNED'  then  '集包已拆包，本包裹未被扫描'
        when route_action='VEHICLE_ACCIDENT_REG'  then  '车辆车祸登记'
        when route_action='VEHICLE_ACCIDENT_REGISTRATION'  then  '车辆车祸登记'
        when route_action='VEHICLE_WET_DAMAGE_REG'  then  '车辆湿损登记'
        when route_action='VEHICLE_WET_DAMAGE_REGISTRATION'  then  '车辆湿损登记'

    end 路由动作
    ,pr.staff_info_id
    ,case WHEN hr.job_title =13 THEN 'Bike'
          WHEN hr.job_title =110 THEN 'Van'
          WHEN hr.job_title =452 THEN 'Boat'
          when hr.job_title=1000 then 'Tricycle'
    end as 岗位
    ,pr.store_id 路由发生网点
    ,hr.store_id 员工归属网点
    ,ss.name 员工归属网点名称
    ,sr.name as 员工归属网点名称area_name -- 大区,
    ,sp.name as 员工归属网点名称region_name -- 片区,

from ph_staging.parcel_route pr

join
(
    SELECT
        hr.`sys_store_id` as store_id,
        hr.staff_info_id,
        hr.job_title
    FROM `ph_bi`.`hr_staff_info` hr
    where hr.`is_sub_staff`= 0
        and hr.`state`= 1
        and  hr.job_title in ( '13', '110','1000')
        and hr.hire_date <= date_sub(CURRENT_DATE,interval 0 day)
) hr
on hr.staff_info_id=pr.staff_info_id

left join ph_staging.sys_store ss
on ss.id=hr.store_id

left join ph_staging.sys_manage_piece sp
on ss.manage_piece= sp.id

left join ph_staging.sys_manage_region sr
on ss.manage_region= sr.id

where pr.routed_at>=DATE_ADD(date_sub(convert_tz(CURRENT_DATE,'+08:00', '+00:00' ), interval 1 day),interval 6 hour)  #由于会出现十二点后由路由动作的情况，因此限制为6点过后的路由时间
    and pr.routed_at<date_sub(convert_tz(CURRENT_DATE,'+08:00', '+00:00' ), interval 0 day)
    and ss.state=1
)p1
where  p1.路由间隔时间 > 5
group by p1.staff_info_id
)



##晚上八点以后操作
,eight_act as (
##快递员、8点后首次联系在距离网点100米内并标记联系不上、拒收、改约、妥投总计包裹量、普遍的响铃时长（众数这个值）

#############求众数
###排序
select
    t1.路由日期
    ,t1.staff_info_id
    ,t1.总响铃包裹数
    ,t1.diaboloDuration
from (
SELECT
*
##,rank() over(PARTITION by 路由日期,staff_info_id  order by  diaboloDuration,次数_diaboloDuration desc )  rk
,row_number() over(PARTITION by 路由日期,staff_info_id  order by  次数_diaboloDuration desc )  rk

from (
###响铃时长计数
select
    temp.路由日期

    ,temp.staff_info_id
    ,temp.diaboloDuration##响铃时长（rk=1,众数）
    ,total_diaboloDuration.总响铃包裹数##晚上八点回网点联系的包裹量
    ,count(1)  次数_diaboloDuration##响铃时长对应的次数
    ,count(distinct temp.pno) 响铃包裹数##对应多少个包裹
    ,sum(count(1)) over(PARTITION  by temp.路由日期,temp.staff_info_id)  总次数_diaboloDuratio##累计联系次数
    #,count(distinct pno)   总响铃包裹数


from (
####半夜操作明细#############
    SELECT
        date(convert_tz(pr.routed_at , '+00:00', '+08:00' ) )  路由日期
        ,convert_tz(pr.routed_at , '+00:00', '+08:00' ) 路由时间
        ,st_distance_sphere(point(replace(json_extract(pr.extra_value, '$.lng'),'\"','')+0 ,replace(json_extract(pr.extra_value, '$.lat'),'\"','')+0),point(ss.lng,ss.lat))/1000 as 距离网点_直线距离_公里
        ,replace(json_extract(pr.extra_value, '$.diaboloDuration'),'\"','')  diaboloDuration
        ,replace(json_extract(pr.extra_value, '$.callDuration'),'\"','')   callDuration
        ,pr.pno
        ,pr.route_action
        ,pr.staff_info_id
        ,f_call.路由时间  当天该快递员第一次电话时间
        ,f_call.距离网点_直线距离_公里  当天该快递员第一次电话时间_距离网点_直线距离_公里

        ,case WHEN hr.job_title =13 THEN 'Bike'
            WHEN hr.job_title =110 THEN 'Van'
            WHEN hr.job_title =452 THEN 'Boat'
            when hr.job_title=1000 then 'Tricycle'
            end as 岗位
        ,pr.store_id 路由发生网点
        ,hr.store_id 员工归属网点
        ,ss.name 员工归属网点名称
        ,sr.name as 员工归属网点名称area_name -- 大区,
        ,sp.name as 员工归属网点名称region_name -- 片区,

    from ph_staging.parcel_route pr

     join
    (
     SELECT
          hr.`sys_store_id` as store_id,
          hr.staff_info_id,
          hr.job_title
      FROM `ph_bi`.`hr_staff_info` hr
      where hr.`is_sub_staff`= 0
          and hr.`formal`= 1
          and hr.`state`= 1
          and  hr.job_title in ( '13', '110','1000')
          and hr.hire_date <= date_sub(CURRENT_DATE,interval 0 day)
    ) hr
    on hr.staff_info_id=pr.staff_info_id

    #标记为联系不上客户,八点后标记，且离网点五百米内
    join
    (
        select *
        from (
            SELECT
                pr.staff_info_id
                ,date(convert_tz(pr.routed_at,'+00:00','+08:00')) as routed_at
                ,pr.pno
                ,st_distance_sphere(point(replace(json_extract(pr.extra_value, '$.lng'),'\"','')+0 ,replace(json_extract(pr.extra_value, '$.lat'),'\"','')+0),point(ss.lng,ss.lat))/1000 as 距离网点_直线距离_公里
            from ph_staging.parcel_route pr

            left join ph_staging.parcel_info pi
            ON pi.pno = pr.pno

            left join ph_staging.sys_store ss
            on ss.id=pi.dst_store_id
            WHERE 1=1
              ##AND pr.marker_category IN (2,17,9,14,70,15,71,16,1,40,29,78,25,75,23,73,7,22,6,21,5,20,4,19) # 2 17拒收 9 14 70 改约 15 71 运力不足
              AND pr.route_action = 'DELIVERY_MARKER' #派件标记
              and pr.routed_at>=DATE_ADD(date_sub(convert_tz(CURRENT_DATE,'+08:00', '+00:00' ), interval 1 day),interval 20 hour)  #20点过后的路由时间
              and pr.routed_at<DATE_ADD(date_sub(convert_tz(CURRENT_DATE,'+08:00', '+00:00' ), interval 0 day) ,interval 1 hour)
              and   pr.marker_category in ('1','2','70','71')##=1  #'联系不上包裹数'
              and ss.state=1
        )temp
        where temp.距离网点_直线距离_公里<0.1
    )  DELIVERY_MARKER
    on DELIVERY_MARKER.pno=pr.pno
    and DELIVERY_MARKER.routed_at=date(convert_tz(pr.routed_at , '+00:00', '+08:00' ) )
    and DELIVERY_MARKER.staff_info_id=pr.staff_info_id

    left join ph_staging.sys_store ss
    on ss.id=hr.store_id

    left join ph_staging.sys_manage_piece sp
    on ss.manage_piece= sp.id

    left join ph_staging.sys_manage_region sr
    on ss.manage_region= sr.id

    left join (
    #####包裹第一次电话联系时间
        select *
        from (
            SELECT
                date(convert_tz(pr.routed_at , '+00:00', '+08:00' ) )  路由日期
                ,convert_tz(pr.routed_at , '+00:00', '+08:00' ) 路由时间
                ,st_distance_sphere(point(replace(json_extract(pr.extra_value, '$.lng'),'\"','')+0 ,replace(json_extract(pr.extra_value, '$.lat'),'\"','')+0),point(ss.lng,ss.lat))/1000 as 距离网点_直线距离_公里
                ,replace(json_extract(pr.extra_value, '$.diaboloDuration'),'\"','')  diaboloDuration
                ,replace(json_extract(pr.extra_value, '$.callDuration'),'\"','')   callDuration
                ,pr.pno
                ,pr.staff_info_id
                ,case WHEN hr.job_title =13 THEN 'Bike'
                WHEN hr.job_title =110 THEN 'Van'
                WHEN hr.job_title =452 THEN 'Boat'
                when hr.job_title=1000 then 'Tricycle'
                end as 岗位
                ,pr.store_id 路由发生网点
                ,hr.store_id 员工归属网点
                ,ss.name 员工归属网点名称
                ,sr.name as 员工归属网点名称area_name -- 大区,
                ,sp.name as 员工归属网点名称region_name -- 片区,
                ,rank() over(PARTITION by pr.staff_info_id ,pr.pno ,date(convert_tz(pr.routed_at , '+00:00', '+08:00' ) )  order by pr.routed_at)  rk
            from ph_staging.parcel_route pr
            join
                (
                 SELECT
                      hr.`sys_store_id` as store_id,
                      hr.staff_info_id,
                      hr.job_title
                  FROM `ph_bi`.`hr_staff_info` hr
                  where hr.`is_sub_staff`= 0
                      and hr.`formal`= 1
                      and hr.`state`= 1
                      and  hr.job_title in ( '13', '110','1000')
                      and hr.hire_date <= date_sub(CURRENT_DATE,interval 0 day)
                ) hr
                on hr.staff_info_id=pr.staff_info_id
            left join ph_staging.sys_store ss
            on ss.id=hr.store_id
            left join ph_staging.sys_manage_piece sp
            on ss.manage_piece= sp.id
            left join ph_staging.sys_manage_region sr
            on ss.manage_region= sr.id
            where pr.routed_at>=DATE_ADD(date_sub(convert_tz(CURRENT_DATE,'+08:00', '+00:00' ), interval 1 day),interval 6 hour)  #6点过后的路由时间
              and pr.routed_at<DATE_ADD(date_sub(convert_tz(CURRENT_DATE,'+08:00', '+00:00' ), interval 0 day) ,interval 1 hour)
              and ss.state=1
              and pr.route_action='PHONE'
        )pr
        where pr.rk=1
    )  f_call
    on f_call.路由日期=date(convert_tz(pr.routed_at , '+00:00', '+08:00' ) )
    and f_call.staff_info_id=pr.staff_info_id
    and f_call.pno=pr.pno


    where pr.routed_at>=DATE_ADD(date_sub(convert_tz(CURRENT_DATE,'+08:00', '+00:00' ), interval 1 day),interval 20 hour)  #20点过后的路由时间
      and pr.routed_at<DATE_ADD(date_sub(convert_tz(CURRENT_DATE,'+08:00', '+00:00' ), interval 0 day) ,interval 1 hour)
      and ss.state=1
      and pr.route_action="PHONE"
      #第一电话是再网点打的，且八点后
      and  f_call.距离网点_直线距离_公里<0.1
      and hour(f_call.路由时间)>=20
) temp


#总响铃包裹数，第一电话是再网点打的，且八点后
left join (
    ###响铃时长计数
    select
    路由日期
    ,staff_info_id
    ,count(distinct pno) 总响铃包裹数
    from
    (
    ####半夜操作明细#############
    SELECT
        date(convert_tz(pr.routed_at , '+00:00', '+08:00' ) )  路由日期
        ,convert_tz(pr.routed_at , '+00:00', '+08:00' ) 路由时间
        ,st_distance_sphere(point(replace(json_extract(pr.extra_value, '$.lng'),'\"','')+0 ,replace(json_extract(pr.extra_value, '$.lat'),'\"','')+0),point(ss.lng,ss.lat))/1000 as 距离网点_直线距离_公里
        ,replace(json_extract(pr.extra_value, '$.diaboloDuration'),'\"','')  diaboloDuration
        ,replace(json_extract(pr.extra_value, '$.callDuration'),'\"','')   callDuration
        ,pr.pno
        ,pr.route_action
        ,pr.staff_info_id
        ,f_call.路由时间  当天该快递员第一次电话时间
        ,f_call.距离网点_直线距离_公里  当天该快递员第一次电话时间_距离网点_直线距离_公里

        ,case WHEN hr.job_title =13 THEN 'Bike'
        WHEN hr.job_title =110 THEN 'Van'
        WHEN hr.job_title =452 THEN 'Boat'
        when hr.job_title=1000 then 'Tricycle'
        end as 岗位
        ,pr.store_id 路由发生网点
        ,hr.store_id 员工归属网点
        ,ss.name 员工归属网点名称

    from ph_staging.parcel_route pr

    join (
        SELECT
            hr.`sys_store_id` as store_id,
            hr.staff_info_id,
            hr.job_title
        FROM `ph_bi`.`hr_staff_info` hr
        where hr.`is_sub_staff`= 0
          and hr.`formal`= 1
          and hr.`state`= 1
          and  hr.job_title in ( '13', '110','1000')
          and hr.hire_date <= date_sub(CURRENT_DATE,interval 0 day)
    ) hr
    on hr.staff_info_id=pr.staff_info_id

    #标记为联系不上客户,八点后标记，且离网点五百米内
    join
    (

        select
        *
        from (

            SELECT

                pr.staff_info_id
                ,date(convert_tz(pr.routed_at,'+00:00','+08:00')) as routed_at
                ,pr.pno
                ,st_distance_sphere(point(replace(json_extract(pr.extra_value, '$.lng'),'\"','')+0 ,replace(json_extract(pr.extra_value, '$.lat'),'\"','')+0),point(ss.lng,ss.lat))/1000 as 距离网点_直线距离_公里

            from ph_staging.parcel_route pr

            left join ph_staging.parcel_info pi
            ON pi.pno = pr.pno

            left join ph_staging.sys_store ss
            on ss.id=pi.dst_store_id

            WHERE 1=1
                ##AND pr.marker_category IN (2,17,9,14,70,15,71,16,1,40,29,78,25,75,23,73,7,22,6,21,5,20,4,19) # 2 17拒收 9 14 70 改约 15 71 运力不足
                AND pr.route_action = 'DELIVERY_MARKER' #派件标记
                and pr.routed_at>=DATE_ADD(date_sub(convert_tz(CURRENT_DATE,'+08:00', '+00:00' ), interval 1 day),interval 20 hour)  #20点过后的路由时间
                and pr.routed_at<DATE_ADD(date_sub(convert_tz(CURRENT_DATE,'+08:00', '+00:00' ), interval 0 day) ,interval 1 hour)
                and   pr.marker_category in ('1','2','70','71') #=1  #'联系不上包裹数'
                and ss.state=1
            )temp
            where temp.距离网点_直线距离_公里<0.1
    )  DELIVERY_MARKER
    on DELIVERY_MARKER.pno=pr.pno
    and DELIVERY_MARKER.routed_at=date(convert_tz(pr.routed_at , '+00:00', '+08:00' ) )
    and DELIVERY_MARKER.staff_info_id=pr.staff_info_id



    left join ph_staging.sys_store ss
    on ss.id=hr.store_id

    left join ph_staging.sys_manage_piece sp
    on ss.manage_piece= sp.id

    left join ph_staging.sys_manage_region sr
    on ss.manage_region= sr.id

    left join (
    #####包裹第一次电话联系时间
    select
    *
    from (
        SELECT
        date(convert_tz(pr.routed_at , '+00:00', '+08:00' ) )  路由日期
        ,convert_tz(pr.routed_at , '+00:00', '+08:00' ) 路由时间
        ,st_distance_sphere(point(replace(json_extract(pr.extra_value, '$.lng'),'\"','')+0 ,replace(json_extract(pr.extra_value, '$.lat'),'\"','')+0),point(ss.lng,ss.lat))/1000 as 距离网点_直线距离_公里
        ,replace(json_extract(pr.extra_value, '$.diaboloDuration'),'\"','')  diaboloDuration
        ,replace(json_extract(pr.extra_value, '$.callDuration'),'\"','')   callDuration
        ,pr.pno

        ,pr.staff_info_id
        ,case WHEN hr.job_title =13 THEN 'Bike'
        WHEN hr.job_title =110 THEN 'Van'
        WHEN hr.job_title =452 THEN 'Boat'
        when hr.job_title=1000 then 'Tricycle'
        end as 岗位
        ,pr.store_id 路由发生网点
        ,hr.store_id 员工归属网点
        ,ss.name 员工归属网点名称
        ,sr.name as 员工归属网点名称area_name -- 大区,
        ,sp.name as 员工归属网点名称region_name -- 片区,
        ,rank() over(PARTITION by pr.staff_info_id ,pr.pno ,date(convert_tz(pr.routed_at , '+00:00', '+08:00' ) )  order by pr.routed_at)  rk

        from ph_staging.parcel_route pr

         join
        (
         SELECT
                         hr.`sys_store_id` as store_id,
                       hr.staff_info_id,
                       hr.job_title
                   FROM `ph_bi`.`hr_staff_info` hr
                   where hr.`is_sub_staff`= 0
                   and hr.`formal`= 1
                   and hr.`state`= 1
                   and  hr.job_title in ( '13', '110','1000')
                   and hr.hire_date <= date_sub(CURRENT_DATE,interval 0 day)
        ) hr
        on hr.staff_info_id=pr.staff_info_id

        left join ph_staging.sys_store ss
        on ss.id=hr.store_id

        left join ph_staging.sys_manage_piece sp
                on ss.manage_piece= sp.id
                left join ph_staging.sys_manage_region sr
                on ss.manage_region= sr.id

        where

        pr.routed_at>=DATE_ADD(date_sub(convert_tz(CURRENT_DATE,'+08:00', '+00:00' ), interval 1 day),interval 6 hour)  #6点过后的路由时间
        and pr.routed_at<DATE_ADD(date_sub(convert_tz(CURRENT_DATE,'+08:00', '+00:00' ), interval 0 day) ,interval 1 hour)

        and ss.state=1
        and pr.route_action='PHONE'
        )
        pr
        where pr.rk=1
    )  f_call
    on f_call.路由日期=date(convert_tz(pr.routed_at , '+00:00', '+08:00' ) )
    and f_call.staff_info_id=pr.staff_info_id
    and f_call.pno=pr.pno


    where pr.routed_at>=DATE_ADD(date_sub(convert_tz(CURRENT_DATE,'+08:00', '+00:00' ), interval 1 day),interval 20 hour)  #20点过后的路由时间
        and pr.routed_at<DATE_ADD(date_sub(convert_tz(CURRENT_DATE,'+08:00', '+00:00' ), interval 0 day) ,interval 1 hour)

        and ss.state=1
        and pr.route_action="PHONE"
        #第一电话是再网点打的，且八点后
        and  f_call.距离网点_直线距离_公里<0.1
        and hour(f_call.路由时间)>=20
    )
    group by 1,2
) total_diaboloDuration
on total_diaboloDuration.路由日期=temp.路由日期 and total_diaboloDuration.staff_info_id=temp.staff_info_id

group by 1,2,3,4

)temp

)t1
where t1.rk = 1
group by t1.路由日期
    ,t1.staff_info_id
    ,t1.总响铃包裹数
    ,t1.diaboloDuration

)



select m1.*
,if(m1.是否应出勤 in ('应出勤') and m1.近14天排班旷工次数 >= 3 ,0.05,0) as 旷工_系数
,if(m1.是否应出勤 not in ('无需出勤') and m1.迟到情况 in ('迟到30min以上') and m1.近14天排班迟到30min以上次数 >= 3 ,0.05,0) as 迟到_系数
,if(m1.最早交接时间晚 in ('交接晚_第一趟正班车8:30分前到港_最早交接时间晚于10:00','交接晚_第一趟正班车到港后1.5h后未开始交接'),0.1,0) as 最早交接时间晚_系数
,if(m1.交接2h包裹比例 in ('2h内交接包裹量低于90') and m1.截至12点交接包裹比例 < 0.4 ,0.1,0) as 交接时间长_系数
,if(m1.交接量少 in ('低于同级别区域人均交接量的20%') ,0.1,0) as 交接量少_系数
,if(m1.交接非绑定区域包裹量比例  <= 0.2 ,0,0.1) as 乱交接_系数
,if(m1.出门晚 in ('最早妥投时间晚于比武规定时间') ,0.1,0) as 出门晚_系数
,if(m1.派件结束早 in ('15点前结束派件&妥投率低于70%'),0.1,0) as 派件结束早_系数
,if(m1.妥投量少 in ('低于同级别区域人均妥投量的20%'),0.1,0) as 妥投量少_系数
,if(m1.疑似存在偷懒 in ('存在5h以上无路由动作') ,0.05,0) as 疑似存在偷懒_系数
,if(m1.当日标记问题件数量多 in ('当日标记问题件数（拒收、运力不足、改约、联系不上）为交接包裹量的30%以上'),0.1,0) as 标记问题件多_系数
,if(m1.当日20点之后在网点100内进行首次联系的包裹量  > 15 ,0.05,0) as 回网点批量操作_系数

from (

SELECT
swrd.stat_date            统计日期
,swrd.staff_info_id       员工ID
,swrd.staff_name          员工姓名
,swrd.store_id            归属网点ID
,swrd.store_name          归属网点名称
,swrd.store_category_desc 网点类型描述
,swrd.tiktok_area         区域TT
,swrd.region_name         归属大区
,case
    when swrd.region_name in ('Area3', 'Area6') then '彭万松'
    when swrd.region_name in ('Area4', 'Area9') then '韩钥'
    when swrd.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
    when swrd.region_name in ( 'Area8') then '黄勇'
    when swrd.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
end                       管理者
,swrd.piece_name          归属片区
,swrd.staff_attr          员工属性
,CASE
        WHEN swrd.job_title = 13  THEN 'Bike'
        WHEN swrd.job_title = 110 THEN 'VAN'
        WHEN swrd.job_title = 452 THEN 'Boat'
        WHEN swrd.job_title = 1000 THEN 'Tricycle'
    END AS      员工岗位
,swrd.hire_days           员工在职天数
,swrd.work_store_id       工作网点ID
,swrd.work_store_name     工作网点名称
,swrd.state_desc                状态描述
,swrd.wait_leave_state          是否待离职
##,swa.shift_start                班次开始时间
##,swa.shift_end                  班次结束时间
,if(swa.shift_start is not null,swa.shift_start,staff_id.shift_start)     班次开始时间
,if(swa.shift_end is not null,swa.shift_end,staff_id.shift_end)           班次结束时间

##,swrd.is_plan_rest              是否排休
,swrd.attendance_started_at     上班打卡时间
,swrd.attendance_end_at         下班打卡时间
,swrd.attendance_hour           打卡时长
,swrd.迟到时长                   迟到时长

,staff_id.plan                  是否应出勤
,staff_id.is_AB                 出勤情况
,if(staff_absence.staff_info_id is not null,staff_absence.absence,null) 近14天排班旷工次数

##,swrd.迟到情况                   迟到情况
,staff_id.chidao_ty             迟到情况
,if(staff_absence.staff_info_id is not null,staff_absence.late_30min,null) 近14天排班迟到30min以上次数

,tdm.time_one                   交接第1件包裹时间
,tdm.time_two                   交接第2件包裹时间
,tdm.time_three                 交接第3件包裹时间
,tdm.time_four                  交接第4件包裹时间
,tdm.time_five                  交接第5件包裹时间
,case when date_format(ft.plan_arrive_first,'%Y-%m-%d %H:%i') is not null and date_format(ft.arrive_time_first,'%Y-%m-%d %H:%i') is null then '规划但无正班车到达'
    when date_format(ft.plan_arrive_first,'%Y-%m-%d %H:%i') is null and date_format(ft.arrive_time_first,'%Y-%m-%d %H:%i') is null then '未规划&无正班车到达'
    when date_format(ft.arrive_time_first,'%Y-%m-%d %H:%i') is null then '无正班车'
    when date_format(ft.arrive_time_first,'%H:%i') <= '08:30' and date_format(swrd.最早交接时间,'%H:%i') > '10:00' then '交接晚_第一趟正班车8:30分前到港_最早交接时间晚于10:00'
    when date_format(ft.arrive_time_first,'%H:%i') > '08:30' and date_format(swrd.最早交接时间,'%H:%i') >  date_format(date_add(ft.arrive_time_first,interval 150 minute),'%H:%i') then '交接晚_第一趟正班车到港后1.5h后未开始交接'
else '其他' end                 最早交接时间晚
,case when dp.2h_percentage = 0 or dp.2h_percentage is null then 'null'
    when dp.2h_percentage < 0.9 then '2h内交接包裹量低于90%'
else '2h内交接包裹量高于90%' end as 交接2h包裹比例
,dp.12_percentage 截至12点交接包裹比例
,swrd.交接量
##,swrd.handover_par_cnt
,area_delivery.交接区域数量_all 交接区域数量
,area_delivery.交接区域数量     交接区域数量_提除交接少于4的区域
,area_delivery.交接情况         交接区域情况
,sde.pnos_wrong_bili      交接非绑定区域包裹量比例

,h14.per_capita_handover      近14天人均交接量
,case when swrd.交接量 < h14.per_capita_h then '低于同级别区域人均交接量的20%' else null end as 交接量少
,sdbsi.三段码绑定数量
,sdbsi.三段码绑定情况
,sdbsi.barangay绑定数量
,sdbsi.绑定明细情况

,swrd.最早派件时间       最早妥投时间
,swrd.delivery_end_at2 倒数第二件妥投时间
,swrd.最近派件时间       最晚妥投时间
,case when time(swrd.最早派件时间) > ft.min_tuotou_time then '最早妥投时间晚于比武规定时间' else null end as 出门晚
,case when swrd.`派件/交接` < 0.7 and date_format(swrd.最近派件时间,'%H:%i') < '15:00' then '15点前结束派件&妥投率低于70%' else null end as 派件结束早
,swrd.当天派件数 as 妥投量
,f14.per_capita_finished 近14天人均妥投量
,case when swrd.当天派件数 < f14.per_capita_f then '低于同级别区域人均妥投量的20%' else null end as 妥投量少


,case when prout.staff_info_id is not null then '存在5h以上无路由动作'  else null end as 疑似存在偷懒
,CASE WHEN (swrd.work_store_name like '%_SP%'
    and ((
        ifnull(swrd.拒收包裹数,0)
        +ifnull(swrd.运力不足包裹数,0)
        +ifnull(swrd.改约包裹数,0)
        +ifnull(swrd.客户不在家_电话无人接听包裹数,0)
        )/swrd.交接量) > 0.3)
    THEN '当日标记问题件数（拒收、运力不足、改约、联系不上）为交接包裹量的30%以上'
    END 当日标记问题件数量多
,ea.总响铃包裹数 当日20点之后在网点100内进行首次联系的包裹量
,ea.diaboloDuration 电话联系响铃时长（众数）

,swrd.拒收包裹数
,swrd.运力不足包裹数
,swrd.改约包裹数
,swrd.客户不在家_电话无人接听包裹数
,swrd.收件人号码空号包裹数
,swrd.收件人号码错误包裹数
,swrd.收件人地址不清晰或不正确包裹数
,swrd.货物丢失包裹数
,swrd.货物短少包裹数
,swrd.货物破损包裹数
,swrd.外包装破损包裹数
,swrd.禁运品包裹数
,swrd.其他派件标记包裹数

,nwrd.当日应派  as 网点当日应派包裹量
,nwrd.当日到件入仓量
,nwrd.当日应派交接 as 网点当日应派交接包裹量
,nwrd.当日应派妥投 as 网点当日应派妥投包裹量
,nwrd.应派交接率   as 网点当日应派交接率
,nwrd.妥投率      as 网点当日应派妥投率
,nwrd.积压量
,nwrd.未交接量
,swrd.`网点当日派件人数`
,a.staff_cut 网点当日交接的快递员人数
,a.avg_decnt 网点人均可交接量


,swrd.`派件间隔(分钟)` '派件间隔(分钟)'
,swrd.`派件/交接` '妥投率'
,swrd.`交接5KG以上`
,swrd.`妥投5KG以上`
,swrd.`网点50米内派件量`
,swrd.`人效排名`



FROM main as swrd ## 快递员每日工作情况播报

LEFT JOIN tmpale.network_work_report_daily nwrd ## 网点每日工作情况播报
on swrd.work_store_name = nwrd.网点

##left join ph_bi.hr_staff_info hsi ##员工表
##on swrd.staff_info_id = hsi.staff_info_id

##left join ph_staging.sys_store ss ##网点表
##on hsi.sys_store_id = ss.id
##left join ph_staging.sys_manage_piece smp ##大区
##on smp.id=ss.manage_piece
##left join ph_staging.sys_manage_region smr ##片区
##on smr.id=ss.manage_region

LEFT JOIN ph_backyard.staff_work_attendance swa ##员工考勤表
ON swa.staff_info_id = swrd.staff_info_id and swa.attendance_date = swrd.stat_date
##AND swa.attendance_date = DATE(convert_tz(NOW(),'+08:00','+08:00'))


left join should_delivery as a
on a.store_id = swrd.work_store_id and a.stat_date=swrd.stat_date


left join car_arrive as ft
##日期+网点关联
on ft.next_store_id = swrd.work_store_id  and ft.proof_dt = swrd.stat_date

left join staff_delivery_code as sdbsi
# 快递员绑定情况
on sdbsi.store_id = swrd.store_id and sdbsi.staff_info_id = swrd.staff_info_id

left join staff_de sde on sde.staff_info_id = swrd.staff_info_id

#left join staff_delivery as m1
#on m1.delivery_dt = swrd.stat_date and m1.staff_info_id = swrd.staff_info_id and m1.store_name = swrd.当日所属网点

left join area_delivery on swrd.staff_info_id = area_delivery.员工ID


left join staff_id on staff_id.stat_date = swrd.stat_date and staff_id.staff_info_id = swrd.staff_info_id

left join staff_absence on staff_absence.staff_info_id = swrd.staff_info_id

left join ticket_delivery_min5 tdm on tdm.staff_info_id = swrd.staff_info_id

left join delivery_percentage dp on dp.staff_info_id = swrd.staff_info_id

left join handover_14days h14 on h14.area_name = swrd.tiktok_area and h14.manage_region = swrd.region_name

left join finished_14days f14 on f14.area_name = swrd.tiktok_area and f14.manage_region = swrd.region_name

left join eight_act as ea on ea.staff_info_id = swrd.staff_info_id and  ea.路由日期 = swrd.stat_date

left join prout on prout.staff_info_id = swrd.staff_info_id

WHERE date(swrd.stat_date) = date_sub(curdate(),interval 1 day)
and date(nwrd.统计日期) = date_sub(curdate(),interval 1 day)
and swrd.job_title in ('13','110','452','1000')

group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41
,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81
,82,83,84,85,86,87,88,89
)m1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        hsi.staff_info_id
        ,hsi.sys_store_id
        ,dp.on_emp_cnt
    from ph_bi.hr_staff_info hsi
    left join dwm.dwm_ph_network_wide_s dp on dp.store_id = hsi.sys_store_id and dp.stat_date = '2023-09-07'
    where
        hsi.staff_info_id in ('164967','164542','162414','164122','144323','161538','163540','164178','157428','158174','144145','162218','144557','165049','151151','152733','146976','155599','128331','158200','141418','143131','162964','161256','141319','163163','159579','130732','148142','155212','162836','155596','134588','154872','129689','162177','144776','161197','148083','156689','159242','153953','156346','152375','157321','153879','162281','144316','152683','154768','163634','162220','142365','157347','162207','162558','159003','143614','155128','160443','166347','127509','166085','166379','152108','121489','163011','161741','153174','147088','154865','155840','160778','159006','145826','139753','132687','159114','153066','151761','160258','157649','159824','162573','155835','164744','166179','120239','133206','159130','134802','160890','162811','165273','160019','147962','146632','143238','161094','155172','150100','150598','158727','132530','155259','145964','152922','150338','149692','159550','147911','163933','152055','162811','149799','148178','143422','162675','152387','142343','149274','141419','163312','164695','160485','166338','146817','164972','156965','155162','164335','125995','135476','164552','153874','150640','153948','150193','160763','145386','150384','137240','159939')
)
select
    t1.staff_info_id
    ,t1.sys_store_id 所属网点ID
    ,t1.on_emp_cnt 所属网点快递员数
    ,a.pi_count 揽收量
    ,a.no_return_count 正向揽收量
from t t1
left join
    (
        select
            t1.staff_info_id
            ,count(pi.pno) pi_count
            ,count(if(pi.returned = 0, pi.pno, null)) no_return_count
        from ph_staging.parcel_info pi
        join t t1 on t1.staff_info_id = pi.ticket_pickup_staff_info_id
        where
            pi.created_at >= '2023-09-06 16:00:00'
            and pi.created_at < '2023-09-07 16:00:00'
            and pi.state < 9
        group by 1
    ) a on a.staff_info_id = t1.staff_info_id;
;-- -. . -..- - / . -. - .-. -.--
select
    hsi.staff_info_id
    ,dp.store_name
    ,dp.piece_name
    ,dp.region_name
from ph_bi.hr_staff_info hsi
left join  dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi.sys_store_id and dp.stat_date = '2023-09-07'
where
    hsi.staff_info_id in ('143570','136488','127380','151910','122893','120156','120770','147668','164159','141652','141328','165936','161812','145180','143571','160280','164557','148940','133833','161313','156661','120611','141195','148356','166003','128792','143325','146366','165973','162934','145884','156086','128873','153606','163124','150635','142155','122788','147416','146856','138134','148747','148111','162743','165598','162519','133407','158301','156107','149787','159239','165834','158922','121928','122624','136312','138703','151162','139391','150162','151987','139480','148654','141384','119309','135218','129357','163686','165051','129003','152703','155262','125915','127043','140249','142850','120213','135239','157514','158830','158717','160793','149035','131010','149004','128031','159995','160559','155575','120323','143997','153933','128295','139295','165765','147973','121314','163778','139853','134272','164985','156634','165129','160807','136970','126451','121270','151961','154735','126897','144055','134601','146209','128306','147008','147592','120144','141102','119381','151102','136244','154612','131470','147364','141280','129468','130494','158205','130236','156307','165610','124359','155169','157685','156469','163691','165296','148727','164785','155435','147889','160428','138691','144437','141914','129483','119625','128730','162440','165962','138279','128144','131805','144949','136254','155367','136418','149547','127834','128139','152571','163528','149229','135031','127118','164712','126411','142725','128667','139185','149194','138913','147053','151436','147902','122749','126789','131076','164568','155146','142663','144438','119895','142162','136576','163929','165616','126311','165590','156466','147186','165237','146196','160814','164238','156675','157658','157855','124237','148287','137930','150181','125275','157225','162492','159332','131774','150940','128428','151797','151972','142203','146657','158994','163440','135544','151657','157060','157431','151613','161041','134123','122576','156568','126198','165785','155620','148396','127225','120658','157033','156857','141574','133888','163270','154827','160246','135787','149910','122302','146737','162424','164373','162919','161717','156367','148955','150281','163397','164570','120252','122483','122833','161562','133840','157671','152990','142685','140925','143703','123276','138360','163104','162113','163025','127931','155637','150677','132280','120914','135622','120471','157692','163108','131033','135785','123682','163169','164679','151144','122961','121364','158293','132246','158075','149374','147626','153538','164347','147958','165992','162477','145191','122855','146101','136854','143969','127910','129197','156087','136318','166308','148346','163805','121592','148847','146813','141932','130533','162679','119839','146172','165536','148797','129521','127909','121755','126685','152374','130109','150760','159753','161523','158139','162334','165576','138143','164651','120007','137809','151773','120307','131039','133430','164798','156730','146277','133728','134171','143694','128622','122404','139740','138243','163625','146215','124578','149358','164744','142592','126484','163540','145223','158995','150594','164970','127775','162977','154250','133689','121412','129363');
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-08'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 10
                    or (t1.total =  5 and t1.leave_time_type = 2)

                union all

                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 5
                    and t1.leave_time_type = 1 -- 上午请假
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-08'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 10
                                    or (t1.total =  5 and t1.leave_time_type = 2)

                                union all

                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 5
                                    and t1.leave_time_type = 1 -- 上午请假
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-09-08', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with d as
    (
        select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-09-08'
    )
    , t as
    (
        select
             ds.store_id
            ,ds.pno
            ,ds.stat_date
        from d ds
        left join
            (
                select
                    pr.pno
                    ,ds.stat_date
                    ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
                from ph_staging.parcel_route pr
                join d ds on pr.pno = ds.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                    and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and pr.marker_category in (42,43) ##岛屿,偏远地区
                group by 1,2
            ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
        left join
            (
                select
                   pr.pno
                    ,ds.stat_date
                   ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
                   ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
                from ph_staging.parcel_route pr
                join d ds on ds.pno = pr.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                    and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                    and pr.marker_category in (9,14,70) ##客户改约时间
            ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
        left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
        where
            case
                when pr1.pno is not null then 'N'
                when pr2.pno is not null then 'N'
                when ds1.pno is not null  then 'N'  else 'Y'
            end = 'Y'
    )
    select
        a.stat_date 日期
        ,a.store_id 网点ID
        ,dp.store_name 网点名称
        ,dp.opening_at 开业时间
        ,case
            when dp.region_name in ('Area3', 'Area6') then '彭万松'
            when dp.region_name in ('Area4', 'Area9') then '韩钥'
            when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
            when dp.region_name in ( 'Area8') then '黄勇'
            when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
        end 区域
        ,dp.region_name 大区
        ,dp.piece_name 片区
        ,a.应交接
        ,a.已交接
        ,concat(round(a.交接率*100,2),'%') as 交接率
        ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
        ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
        ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
        ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
        ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
    from
        (
            select
                t1.store_id
                ,t1.stat_date
                ,count(t1.pno) 应交接
                ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
            from t t1
            left join
                (
                    select
                        sc.*
                    from
                        (
                            select
                                pr.pno
                                ,pr.store_id
                                ,pr.store_name
                                ,t1.stat_date
                                ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                            from ph_staging.parcel_route pr
                            join t t1 on t1.pno = pr.pno
                            where
                                pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                               and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                              and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                        ) sc
                    where
                        sc.rk = 1
                ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
            group by 1,2
        ) a
    join
        (
            select
                sd.store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.store_id is not null
            group by 1

            union all

            select
                sd.separation_store_id store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.separation_store_id is not null
            group by 1
        ) sd on sd.store_id = a.store_id
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    where
        dp.store_category in (1,10);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-08'
        and pr.routed_at >= date_sub('2023-09-08', interval 8 hour )
        and pr.routed_at < date_add('2023-09-08', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,if(a3.self_staff_num + other_staff_num > coalesce(sdb.code_num, 0),
           case
            when a2.avg_staff_code < 2 then 'A'
            when a2.avg_staff_code >= 2 and a2.avg_staff_code < 3 then 'B'
            when a2.avg_staff_code >= 3 and a2.avg_staff_code < 4 then 'C'
            when a2.avg_staff_code >= 4 then 'D'
        end,
           case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end ) 评级
#         ,a2.code_num
#         ,a2.staff_code_num
#         ,a2.staff_num
#         ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) avg_staff_code
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-09-08'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-09-08')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-09-08'
        and pi.finished_at >= date_sub('2023-09-08', interval 8 hour )
        and pi.finished_at < date_add('2023-09-08', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-09-08'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        pi.pno
        ,case
            when bc.`client_id` is not null then bc.client_name
            when kp.id is not null and bc.client_id is null then '普通ka'
            when kp.`id` is null then '小c'
        end as client_type
        ,ss.name pick_store
        ,ss.id storeid
    from ph_staging.parcel_info pi
    left join ph_staging.sys_store ss on ss.id = pi.ticket_pickup_store_id
    left join ph_staging.ka_profile kp on kp.id = pi.client_id
    left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
    where
        pi.created_at >= '2023-07-31 16:00:00'
        and pi.created_at < '2023-08-31 16:00:00'
        and ss.category = 6 -- FH
        and pi.state < 9
),
res as
    (
        select
            t1.*
            ,min(pr.routed_at) min_route_at
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno and pr.route_action = 'RECEIVED' and pr.store_id = t1.storeid
        where
            pr.routed_at > '2023-07-31 16:00:00'
        group by 1,2,3,4
    )

select
    t1.pno 包裹
    ,t1.client_type 客户类型
    ,t1.pick_store 揽收网点
    ,convert_tz(t2.min_route_at, '+00:00', '+08:00')  收件入仓时间
    ,a.route_action 揽收后第一个有效路由
    ,a.store_name 揽收后第一个有效路由网点
    ,convert_tz(a.routed_at, '+00:00', '+08:00')  揽收后第一个有效路由时间
    ,case
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 < 24 then 0
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 >= 24 and timestampdiff(minute , t2.min_route_at, a.routed_at)/60 < 48 then 1
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 >= 48 and timestampdiff(minute , t2.min_route_at, a.routed_at)/60 < 72 then 2
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 > 72 then 3
     end 揽收与后续第一个路由时间差
from t t1
left join res t2 on t2.pno = t1.pno
left join
    (
        select
            t2.*
            ,pr.route_action
            ,pr.store_id pr_store_id
            ,pr.store_name
            ,pr.routed_at
            ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        from ph_staging.parcel_route pr
        join res t2 on t2.pno = pr.pno
        join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action
        where
            pr.routed_at > t2.min_route_at
            and pr.routed_at > '2023-07-31 16:00:00'
            and pr.store_id != t2.storeid
    ) a on a.pno = t1.pno and a.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
select
    pr.pno
    ,case
        when bc.`client_id` is not null then bc.client_name
        when kp.id is not null and bc.client_id is null then '普通ka'
        when kp.`id` is null then '小c'
    end as 客户类型
    ,convert_tz(pr.routed_at, '+00:00', '+08:00') 操作时间
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end 包裹状态
from ph_staging.parcel_route pr
left join ph_staging.parcel_info pi on pi.pno = pr.pno
left join ph_staging.ka_profile kp on kp.id = pi.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
where
    pr.staff_info_id = '149733'
    and pr.routed_at >= '2023-009-07 16:00:00'
    and pr.routed_at < '2023-09-07 16:00:00'
    and pr.route_action = 'PRINT';
;-- -. . -..- - / . -. - .-. -.--
select
    pr.pno
    ,case
        when bc.`client_id` is not null then bc.client_name
        when kp.id is not null and bc.client_id is null then '普通ka'
        when kp.`id` is null then '小c'
    end as 客户类型
    ,convert_tz(pr.routed_at, '+00:00', '+08:00') 操作时间
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end 包裹状态
from ph_staging.parcel_route pr
left join ph_staging.parcel_info pi on pi.pno = pr.pno
left join ph_staging.ka_profile kp on kp.id = pi.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
where
    pr.staff_info_id = '149733'
    and pr.routed_at >= '2023-009-07 16:00:00'
    and pr.routed_at < '2023-09-07 16:00:00'
    and pr.route_action = 'PRINTING';
;-- -. . -..- - / . -. - .-. -.--
select
    pr.pno
    ,case
        when bc.`client_id` is not null then bc.client_name
        when kp.id is not null and bc.client_id is null then '普通ka'
        when kp.`id` is null then '小c'
    end as 客户类型
    ,convert_tz(pr.routed_at, '+00:00', '+08:00') 操作时间
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end 包裹状态
from ph_staging.parcel_route pr
left join ph_staging.parcel_info pi on pi.pno = pr.pno
left join ph_staging.ka_profile kp on kp.id = pi.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
where
    pr.staff_info_id = '149733'
    and pr.routed_at >= '2023-009-07 16:00:00'
    and pr.routed_at < '2023-09-08 16:00:00'
    and pr.route_action = 'PRINTING';
;-- -. . -..- - / . -. - .-. -.--
select
    pr.pno
    ,case
        when bc.`client_id` is not null then bc.client_name
        when kp.id is not null and bc.client_id is null then '普通ka'
        when kp.`id` is null then '小c'
    end as 客户类型
    ,convert_tz(pr.routed_at, '+00:00', '+08:00') 操作时间
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end 包裹状态
from ph_staging.parcel_route pr
left join ph_staging.parcel_info pi on pi.pno = pr.pno
left join ph_staging.ka_profile kp on kp.id = pi.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
where
    pr.staff_info_id = '149733'
    and pr.routed_at >= '2023-09-07 16:00:00'
    and pr.routed_at < '2023-09-08 16:00:00'
    and pr.route_action = 'PRINTING';
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-09'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 10
                    or (t1.total =  5 and t1.leave_time_type = 2)

                union all

                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 5
                    and t1.leave_time_type = 1 -- 上午请假
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '22023-09-09'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 10
                                    or (t1.total =  5 and t1.leave_time_type = 2)

                                union all

                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 5
                                    and t1.leave_time_type = 1 -- 上午请假
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('22023-09-09', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-09'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 10
                                    or (t1.total =  5 and t1.leave_time_type = 2)

                                union all

                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 5
                                    and t1.leave_time_type = 1 -- 上午请假
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-09-09', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with d as
    (
        select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-09-09'
    )
    , t as
    (
        select
             ds.store_id
            ,ds.pno
            ,ds.stat_date
        from d ds
        left join
            (
                select
                    pr.pno
                    ,ds.stat_date
                    ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
                from ph_staging.parcel_route pr
                join d ds on pr.pno = ds.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                    and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and pr.marker_category in (42,43) ##岛屿,偏远地区
                group by 1,2
            ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
        left join
            (
                select
                   pr.pno
                    ,ds.stat_date
                   ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
                   ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
                from ph_staging.parcel_route pr
                join d ds on ds.pno = pr.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                    and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                    and pr.marker_category in (9,14,70) ##客户改约时间
            ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
        left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
        where
            case
                when pr1.pno is not null then 'N'
                when pr2.pno is not null then 'N'
                when ds1.pno is not null  then 'N'  else 'Y'
            end = 'Y'
    )
    select
        a.stat_date 日期
        ,a.store_id 网点ID
        ,dp.store_name 网点名称
        ,dp.opening_at 开业时间
        ,case
            when dp.region_name in ('Area3', 'Area6') then '彭万松'
            when dp.region_name in ('Area4', 'Area9') then '韩钥'
            when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
            when dp.region_name in ( 'Area8') then '黄勇'
            when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
        end 区域
        ,dp.region_name 大区
        ,dp.piece_name 片区
        ,a.应交接
        ,a.已交接
        ,concat(round(a.交接率*100,2),'%') as 交接率
        ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
        ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
        ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
        ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
        ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
    from
        (
            select
                t1.store_id
                ,t1.stat_date
                ,count(t1.pno) 应交接
                ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
            from t t1
            left join
                (
                    select
                        sc.*
                    from
                        (
                            select
                                pr.pno
                                ,pr.store_id
                                ,pr.store_name
                                ,t1.stat_date
                                ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                            from ph_staging.parcel_route pr
                            join t t1 on t1.pno = pr.pno
                            where
                                pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                               and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                              and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                        ) sc
                    where
                        sc.rk = 1
                ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
            group by 1,2
        ) a
    join
        (
            select
                sd.store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.store_id is not null
            group by 1

            union all

            select
                sd.separation_store_id store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.separation_store_id is not null
            group by 1
        ) sd on sd.store_id = a.store_id
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    where
        dp.store_category in (1,10);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-09'
        and pr.routed_at >= date_sub('2023-09-09', interval 8 hour )
        and pr.routed_at < date_add('2023-09-09', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,if(a3.self_staff_num + other_staff_num > coalesce(sdb.code_num, 0),
           case
            when a2.avg_staff_code < 2 then 'A'
            when a2.avg_staff_code >= 2 and a2.avg_staff_code < 3 then 'B'
            when a2.avg_staff_code >= 3 and a2.avg_staff_code < 4 then 'C'
            when a2.avg_staff_code >= 4 then 'D'
        end,
           case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end ) 评级
#         ,a2.code_num
#         ,a2.staff_code_num
#         ,a2.staff_num
#         ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) avg_staff_code
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-09-09'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-09-09')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-09-09'
        and pi.finished_at >= date_sub('2023-09-09', interval 8 hour )
        and pi.finished_at < date_add('2023-09-09', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-09-09'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        hsi.staff_info_id
        ,hsi.sys_store_id
        ,dp.on_emp_cnt
    from ph_bi.hr_staff_info hsi
    left join dwm.dwm_ph_network_wide_s dp on dp.store_id = hsi.sys_store_id and dp.stat_date = '2023-09-08'
    where
        hsi.staff_info_id in ('162111','142269','162250','154819','127556','154394','158716','163312','154811','158031','159605','136187','162206','165787','149314','154880','145278','149274','164799','163655','152639','158335','163540','161053','157797','142928','159232','122661','158006','162167','166156','161019','159142','158452','128350','156346','152683','132720','148257','154261','144316','150502','162328','149102','163291','143224','159038','143822','141563','157322','158886','144776','156563','145655','154872','159363','153485','162407','144810','160747','154768','162220','159237','128337','130753','137624','159200','164428','161745','144557','165024','155212','136832','154831','166532','125426','145528','119296','153470','133823','163489','154034','161451','164876','147595','156556','149728','156733','164372','147053','141024','158174','141431','162513','163103','123253','154579','155840','151761','139697','145445','148488','143958','155247','152741','139796','161867','140269','162702','147217','160184','163800','143637','159222','161403','132682','153417','152555','136363','153365','161741','144240','163149','152389','156832','162273','159824','153416','132322','156659','150598','152922','163478','159945','160019','162655','140194','164818','161996','163669','143515','132226','133206','159360','151491')
)
select
    t1.staff_info_id
    ,t1.sys_store_id 所属网点ID
    ,t1.on_emp_cnt 所属网点快递员数
    ,a.pi_count 揽收量
    ,a.no_return_count 正向揽收量
from t t1
left join
    (
        select
            t1.staff_info_id
            ,count(pi.pno) pi_count
            ,count(if(pi.returned = 0, pi.pno, null)) no_return_count
        from ph_staging.parcel_info pi
        join t t1 on t1.staff_info_id = pi.ticket_pickup_staff_info_id
        where
            pi.created_at >= '2023-09-07 16:00:00'
            and pi.created_at < '2023-09-08 16:00:00'
            and pi.state < 9
        group by 1
    ) a on a.staff_info_id = t1.staff_info_id;
;-- -. . -..- - / . -. - .-. -.--
select
     oi.client_id as '客户ID client_id'
    , oi.ka_warehouse_id as '仓库ID warehouse_id'
    , kw.out_client_id as '卖家ID_Seller_ID'
    , oi.src_name as '卖家名称 Seller_name'
	, bpt.tracking_no as '回调系统运单号 system TN'
	, bpt.pno as '内部运单号 internal TN'
    , if(pi.returned=1,'退件单','正向单') as '是否退件单号 if return TN'
    , case when pi.state = 1 then '已揽收'
	    when pi.state = 2 then '运输中'
	    when pi.state = 3 then '派送中'
	    when pi.state = 4 then '已滞留'
	    when pi.state = 5 then '已签收'
	    when pi.state = 6 then '疑难件处理中'
	    when pi.state = 7 then '已退件'
	    when pi.state = 8 then '异常关闭'
	    when pi.state = 9 then '已撤销'
		end as '包裹最新状态 latest parcel status'
    , di.疑难件上报时间 as '疑难件上报时间 problematic parcel reporting time'
    , di.疑难件原因 as  '疑难件原因 problematic resaon'
    , di.疑难件处理机构  as '疑难件处理机构 problematic department'
    , di.疑难件处理情况 as '疑难件处理情况 problematic status'

    , ssd.src_store as '揽收网点 pickup DC'
    , ssd.src_piece as '揽收片区 pickup piece'
    , ssd.src_region as '揽收大区 pickup area'
     ,ssd.src_area_name as  '寄件人所在时效区域 area1'

    , sp1.name as '寄件人所在省份 seller_province'
    , ct1.name '寄件人所在城市 seller_city'
	, sd1.name '寄件人人所在的乡 seller_barangay'

    ,tpr.dst_area_code as '目的地网点所在时效区域 destination_area'
	 ,tpr.dst_province_name as '目的地网点所在省 destination province'
    , ssd.dst_store as '目的网点 destination DC'
    , ssd.dst_piece as '目的片区 destination district'
    , ssd.dst_region as '目的大区 destination area'


    ,ssd.dst_area_name as '收件人所在时效区域 consignee_area1'
    , sp2.name '收件人所在省 consignee province'
    , ct2.name '收件人所在城市 consignee city'
	, sd2.name '收件人所在的区域 consignee district'
    , pi.dst_phone as 收件人电话
    , pi.dst_name as 收件人姓名
   	, tt.dst_routed_at as '到达目的地网点时间 arrive destionation DC time'
     ,datediff(date(now()),date(convert_tz(tt.dst_routed_at,'+00:00','+08:00'))) as  '到目的地网点时间_天 datediff_now_dst_store'
    , datediff(date(convert_tz(tt.dst_routed_at,'+00:00','+08:00')),date(convert_tz(pi.created_at,'+00:00','+08:00'))) as  '揽收到目的地网点时间_天 datediff_pcikup_dst_store'
    , case when tt.dst_routed_at is not null then '在仓' when tt.dst_routed_at is null then '在途' else 'null' end as '在仓_or_在途 in DC or in transit'

    , concat(ssd.src_area_name,' to ',ssd.dst_area_name) as '流向 direction'
    , convert_tz(bpt.pickup_created_at,'+00:00','+08:00') as '回调揽收时间 callback pickup time'
    , date(convert_tz(bpt.pickup_created_at,'+00:00','+08:00') )as '回调揽收日期 callback pickup date'

    , ssd.sla as '时效天数 SLA'
    , ssd.end_date as '包裹普通超时时效截止日_整体 last day of SLA'
    ,if( ssd.end_7_date is null,ssd.end_date,ssd.end_7_date) as '包裹严重超时时效截止日_整体 last day of SLA+7/ 2sla+7'
    , pi.cod_amount/1000 as 'cod金额 cod amount'
	, convert_tz(bpt.latest_created_at,'+00:00','+08:00') as '回调最后一条路由时间last movement time'
	, bpt.action_code as '回调最后一条路由动作 last movement'
	, ifnull(bpt.delivery_attempt_num,0)as '回调尝试次数 callback attempt_times'
	, bpt.delivery_attempt_num as '回调第三次尝试时间 delivery_attempt_num'
	, pc.third_sorting_code as '三段码 delivery code'
    , convert_tz(pr2.routed_at,'+00:00','+08:00') as '最后一次交接时间 last handover time'
    , if(date(convert_tz(pr2.routed_at,'+00:00','+08:00'))=current_date,'是','否') as '是否当日交接 handover dateimte '
    , pr2.staff_info_id as '最后一次交接人 last handover courier'
    ,case when pi.dst_district_code in('PH180302','PH18030T','PH18030U','PH18030V','PH18030W','PH18030A','PH18030Z','PH180310','PH18030C','PH180313','PH180314','PH18030F','PH18031F','PH18031G','PH18030G','PH18031H','PH18031J','PH18031K','PH18031L','PH18031M','PH18031N','PH18031P','PH18030H','PH18031Q','PH18030N','PH18031W','PH18031X','PH18031Y','PH18031Z',
		'PH180320','PH180321','PH18030P','PH180322','PH180323','PH180324','PH180325') then 'flashhome代派' else '网点自派' end as '派送归属 belong_delivery'
    , case when tt.dst_routed_at is not null and tt.last_store_name<>ssd.dst_store then ssd.dst_store else tt.last_store_name end as '当前网点 current DC'
    , tt.last_route_time as '最后一次有效路由时间 last movement time'
    , tt.last_route_action as '最后一次有效路由动作 last vlid movement'
	, prlm.last_marker_time as '最后一次派件标记时间 last delivery mark time'
	, prlm.last_marker as '最后一次派件标记原因 last delivery mark'
	#, if(pi.discard_enabled=0,'否','是') as '是否丢弃 if discard'
    , di3.created_at as '最后一次进入闪速系统判责时间 latest Lost task system time'
    , if(di3.state is not null,'闪速系统判责中',null)  as '最后一次进入闪速系统判责进度 latest Lost task system process'
	, prm.SYSTEM_AUTO_RETURN_time as  '标记系统自动退件时间 auto return time'
	, prm.wait_return_time as '标记待打印退件时间 time of reprint waybill'
	, case when ssd.end_date>=current_date then '未超时效'
	    when ssd.end_date<current_date  and if( ssd.end_7_date is null,ssd.end_date,ssd.end_7_date) >=current_date then '普通超时效'
	    when if( ssd.end_7_date is null,ssd.end_date,ssd.end_7_date) <current_date then '严重超时效' else null end as '时效类别判断SLA category'
    , if(ssd.end_date<current_date,'已超时效','未超时效') as '是否超时效 if breach SLA'
    , datediff(ssd.end_date,current_date) as '距离超时效天数 breach in days'
    , case when datediff(ssd.end_date,current_date)<0 then '已超时效'
            when datediff(ssd.end_date,current_date)=0 then '即将超时效_距离超时效0天'
            when datediff(ssd.end_date,current_date)=1 then '即将超时效_距离超时效1天'
            when datediff(ssd.end_date,current_date)=2 then '即将超时效_距离超时效2天'
            when datediff(ssd.end_date,current_date)>2 then '即将超时效_距离超时效>2天'
        else null end as '超时风险类型 risk type of breach SLA'
	, datediff(current_date, date(convert_tz(bpt.latest_created_at,'+00:00','+08:00'))) as '最后一条回调距离今日的天数差 days from last callback until now'
	, case  when di3.state is not null then '丢失破损闪速判责中'
	        when  prm.SYSTEM_AUTO_RETURN_time is not null then '待退件'
	    	when  prm.wait_return_time is not null then '待退件'
	        when ifnull(bpt.delivery_attempt_num,0) >=3 then '满足三次尝试派送'
	        when datediff(date(now()),date(convert_tz(tt.dst_routed_at,'+00:00','+08:00')))>=3 and  ifnull(bpt.delivery_attempt_num,0) =2 and date(prlm.last_marker_time)=current_date then '满足三次尝试派送'
	    	when di2.pno is not null then '地址错分导致延迟'
	        when di.疑难件原因 is not null then '疑难件处理中'
	    	when  datediff(date(now()),date(convert_tz(tt.dst_routed_at,'+00:00','+08:00')))<3 and  datediff(date(now()),date(convert_tz(tt.dst_routed_at,'+00:00','+08:00')))>0 then '到目的地网点后不够三次尝试'
	        when datediff(date(now()),date(convert_tz(tt.dst_routed_at,'+00:00','+08:00')))>=3 and  ifnull(bpt.delivery_attempt_num,0) =2 and date(prlm.last_marker_time)<current_date then '包裹到网点>=3天但尝试次数<3'
	        when  datediff(date(now()),date(convert_tz(tt.dst_routed_at,'+00:00','+08:00')))>=3 and ifnull(bpt.delivery_attempt_num,0) <2  then '包裹到网点>=3天但尝试次数<3'
			else null end as '滞留分析'
from tmpale.tmp_backlog_parcel_tiktok  bpt
left join ph_staging.order_info oi on bpt.tracking_no=oi.pno
left join ph_staging.parcel_info pi on bpt.pno=pi.pno
left join ph_staging.ka_warehouse kw on oi.ka_warehouse_id=kw.id
left join dwm.dwd_ex_ph_tiktok_sla_detail ssd on bpt.pno=ssd.pno
left join ph_staging.sys_store ss3 on ssd.dst_store_id=ss3.id


# 寄件人区域
left join ph_staging.sys_province sp1 on sp1.code=pi.src_province_code
left join ph_staging.sys_city ct1 on ct1.code=pi.src_city_code
left join ph_staging.sys_district sd1 on sd1.code=pi.src_district_code

# 收件人区域
left join ph_staging.sys_province sp2 on sp2.code=pi.dst_province_code
left join ph_staging.sys_city ct2 on ct2.code=pi.dst_city_code
left join ph_staging.sys_district sd2 on sd2.code=pi.dst_district_code


left join
(
	  select
	      distinct
		 tpr.dst_province_code
	    ,sp.name as dst_province_name
		 ,tpr.dst_area_code
	   from dwm.dwd_ph_dict_tiktok_period_rules tpr
	   join ph_staging.sys_province sp on tpr.dst_province_code=sp.code
	   where  tpr.sla_version='v2'
)tpr on ss3.province_code=tpr.dst_province_code # 收件人区域，寄件人区域

left join dwm.dwd_ex_ph_parcel_details tt on bpt.pno=tt.pno
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = tt.last_store_id and dp.stat_date =date_sub(current_date,interval 1 day)
left join ph_staging.sys_province sp on dp.province_code=sp.code
left join
	(
		select
		        dt.pno
		        ,dt.staff_info_id
		        ,dt.created_at as delivery_created_at
		        ,tdt2.cn_element as last_marker
		        ,convert_tz(dm.created_at,'+00:00','+08:00') last_marker_time
		        ,row_number() over (partition by  dt.pno order by dt.created_at desc) as rk
		from ph_staging.ticket_delivery dt
		join tmpale.tmp_backlog_parcel_tiktok  dw on dt.pno=dw.pno
		left join ph_staging.ticket_delivery_marker dm on dt.id=dm.delivery_id
		left join dwm.dwd_dim_dict tdt2 on dm.marker_id= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category'
	) prlm on bpt.pno = prlm.pno and prlm.rk = 1 /*最后一条派件标记*/
left join
    (
			select
		        di.pno
		        ,di.staff_info_id
		        ,tdt2.cn_element as 疑难件原因
		         , convert_tz(di.created_at,'+00:00','+08:00') as 疑难件上报时间
			    ,if(cdt.operator_id=10001,'回访批量导入/自动处理',sd.name) as 疑难件处理机构
	          #  ,cdt.operator_id '客服操作人ID'
			    ,case cdt.state
					  when 0 then '未处理'
					  when 1 then '已处理'
					  when 2 then '正在沟通中'
					  when 3 then '财务驳回'
					  when 4 then '客户未处理'
					  when 5 then '转交闪速系统'
					  when 6 then '转交QAQC'
					  end '疑难件处理情况'
			 ,row_number() over (partition by di.pno order by convert_tz(di.created_at,'+00:00','+08:00') desc) as rk
		from tmpale.tmp_backlog_parcel_tiktok tt
		join ph_staging.diff_info di on tt.pno=di.pno
		left join dwm.dwd_dim_dict tdt2 on di.diff_marker_category= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category'
		left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id=di.id and cdt.organization_type=2
		left join ph_bi.hr_staff_info hi2 on hi2.staff_info_id=cdt.operator_id #疑难件处理人对应网点
		left join ph_bi.sys_department sd on sd.id=hi2.node_department_id # 待处理人部门
        where di.state=0
	)di on bpt.pno=di.pno and di.rk=1 /*疑难件原因*/
left join
    (
        select
	        di.pno
	        ,tdt2.cn_element as 疑难件原因
	        ,convert_tz(di.created_at,'+00:00','+08:00') as 疑难件上报时间
             ,row_number() over (partition by di.pno order by convert_tz(di.created_at,'+00:00','+08:00') desc) as rk
		from tmpale.tmp_backlog_parcel_tiktok tt
		join ph_staging.diff_info di on tt.pno=di.pno
		left join dwm.dwd_dim_dict tdt2 on di.diff_marker_category= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category'
		left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id=di.id and cdt.organization_type=2
        where di.state=1 and tdt2.element in(30,31,79,73,23)
    )di2 on bpt.pno=di2.pno and di2.rk=1  /*错分疑难件原因*/
left join
	(
	    select
			lt.pno
	        ,lt.created_at as created_at
	        ,lt.state
			,row_number() over (partition by lt.pno order by lt.created_at desc) as rk
		   from tmpale.tmp_backlog_parcel_tiktok tt
		  join ph_bi.parcel_lose_task lt on tt.pno=lt.pno
		   where lt.created_at>date_sub(CURRENT_DATE ,interval 30 day)
		   and lt.created_at < current_date()
		   and lt.state not in(5,6)
    )di3 on bpt.pno=di3.pno and di3.rk=1  /*丢失*/
left join
    (
	    select
	        pr.store_id
	        ,pr.pno
	        ,pr.store_name
	        ,pr.routed_at
	        ,pr.staff_info_id
	        ,pr.route_action
	    from
	        (
	            select
	                pr.pno
	                ,pr.store_id
	                ,pr.routed_at
	                ,pr.route_action
	                ,pr.store_name
	                ,pr.staff_info_id
	                ,row_number() over(partition by pr.pno order by pr.routed_at DESC ) as rn
	         from ph_staging.parcel_route pr
	         join tmpale.tmp_backlog_parcel_tiktok  bpt on pr.pno=bpt.pno
	         where pr.routed_at>= date_sub(now(),interval 1 month)
	         and pr.route_action in('DELIVERY_TICKET_CREATION_SCAN')
	        )pr
	    where pr.rn = 1
    ) pr2 on pr2.pno =bpt.pno -- 最后一次交接
left join
    (
	    select
			pc.pno
			,pc.sorting_code
	        ,pc.third_sorting_code
	        ,pc.line_code
	        ,row_number()over(partition by pc.pno order by pc.created_at desc) as rn
		from ph_drds.parcel_sorting_code_info pc
		join tmpale.tmp_backlog_parcel_tiktok  bpt on pc.pno=bpt.pno
	)pc on pc.pno =bpt.pno and pc.rn=1 -- 包裹最新派件码
left join
    (
           select
           pr.pno
           ,max(if(pr.route_action = 'SYSTEM_AUTO_RETURN',date(convert_tz(pr.routed_at, '+00:00', '+08:00')),null)) as SYSTEM_AUTO_RETURN_time
           ,max(if(pr.route_action in( 'PENDING_RETURN','DELAY_RETURN'),date(convert_tz(pr.routed_at, '+00:00', '+08:00')),null)) as wait_return_time
           from ph_staging.parcel_route pr
           join tmpale.tmp_backlog_parcel_tiktok  bpt on pr.pno=bpt.pno
           where pr.route_action in( 'SYSTEM_AUTO_RETURN','PENDING_RETURN','DELAY_RETURN')
           and pr.routed_at >= date_sub(now(),interval 3 month)
           group by 1
    )prm on bpt.pno=prm.pno  -- 打印退件和待退件
left join
    (
           select
                pr.pno
           from ph_staging.parcel_route pr
           join tmpale.tmp_backlog_parcel_tiktok  bpt on pr.pno=bpt.pno
           where pr.route_action ='REFUND_CONFIRM'
           and pr.routed_at >= date_sub(now(),interval 10 month)
           group by 1
    )prm2 on bpt.pno=prm2.pno
where  datediff(ssd.end_date,current_date)<=0 and prm2.pno is null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-10'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 10
                    or (t1.total =  5 and t1.leave_time_type = 2)

                union all

                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 5
                    and t1.leave_time_type = 1 -- 上午请假
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-10'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 10
                                    or (t1.total =  5 and t1.leave_time_type = 2)

                                union all

                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 5
                                    and t1.leave_time_type = 1 -- 上午请假
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-09-10', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-10'
        and pr.routed_at >= date_sub('2023-09-10', interval 8 hour )
        and pr.routed_at < date_add('2023-09-10', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,if(a3.self_staff_num + other_staff_num > coalesce(sdb.code_num, 0),
           case
            when a2.avg_staff_code < 2 then 'A'
            when a2.avg_staff_code >= 2 and a2.avg_staff_code < 3 then 'B'
            when a2.avg_staff_code >= 3 and a2.avg_staff_code < 4 then 'C'
            when a2.avg_staff_code >= 4 then 'D'
        end,
           case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end ) 评级
#         ,a2.code_num
#         ,a2.staff_code_num
#         ,a2.staff_num
#         ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) avg_staff_code
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with d as
    (
        select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-09-10'
    )
    , t as
    (
        select
             ds.store_id
            ,ds.pno
            ,ds.stat_date
        from d ds
        left join
            (
                select
                    pr.pno
                    ,ds.stat_date
                    ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
                from ph_staging.parcel_route pr
                join d ds on pr.pno = ds.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                    and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and pr.marker_category in (42,43) ##岛屿,偏远地区
                group by 1,2
            ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
        left join
            (
                select
                   pr.pno
                    ,ds.stat_date
                   ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
                   ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
                from ph_staging.parcel_route pr
                join d ds on ds.pno = pr.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                    and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                    and pr.marker_category in (9,14,70) ##客户改约时间
            ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
        left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
        where
            case
                when pr1.pno is not null then 'N'
                when pr2.pno is not null then 'N'
                when ds1.pno is not null  then 'N'  else 'Y'
            end = 'Y'
    )
    select
        a.stat_date 日期
        ,a.store_id 网点ID
        ,dp.store_name 网点名称
        ,dp.opening_at 开业时间
        ,case
            when dp.region_name in ('Area3', 'Area6') then '彭万松'
            when dp.region_name in ('Area4', 'Area9') then '韩钥'
            when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
            when dp.region_name in ( 'Area8') then '黄勇'
            when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
        end 区域
        ,dp.region_name 大区
        ,dp.piece_name 片区
        ,a.应交接
        ,a.已交接
        ,concat(round(a.交接率*100,2),'%') as 交接率
        ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
        ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
        ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
        ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
        ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
    from
        (
            select
                t1.store_id
                ,t1.stat_date
                ,count(t1.pno) 应交接
                ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
            from t t1
            left join
                (
                    select
                        sc.*
                    from
                        (
                            select
                                pr.pno
                                ,pr.store_id
                                ,pr.store_name
                                ,t1.stat_date
                                ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                            from ph_staging.parcel_route pr
                            join t t1 on t1.pno = pr.pno
                            where
                                pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                               and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                              and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                        ) sc
                    where
                        sc.rk = 1
                ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
            group by 1,2
        ) a
    join
        (
            select
                sd.store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.store_id is not null
            group by 1

            union all

            select
                sd.separation_store_id store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.separation_store_id is not null
            group by 1
        ) sd on sd.store_id = a.store_id
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    where
        dp.store_category in (1,10);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-09-10'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-09-10')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-09-10'
        and pi.finished_at >= date_sub('2023-09-10', interval 8 hour )
        and pi.finished_at < date_add('2023-09-10', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-09-10'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
select
    fn.region_name as 大区
	,fn.piece_name as 片区
	,fn.store_name as 网点
    ,fn.staff_info_id as 员工ID
	,count(distinct fn.pno) as '今日交接量(最后一次交接人为准)'
    ,count(distinct if(fn.pi_state = 5, fn.pno, null)) 今日交接妥投量
	,count(distinct if(fn.handover_type='17点前交接' ,fn.pno, null)) as 17点前交接量
    ,count(distinct if(fn.handover_type='17点前交接' and fn.pi_state = 5,fn.pno,null)) 17点前交接包裹妥投量
    ,count(distinct if(fn.handover_type='17点前交接' and fn.pi_state = 7,fn.pno,null)) 17点前交接包裹退件量
    ,count(distinct if(fn.handover_type='17点前交接' and fn.pi_state = 8,fn.pno,null)) 17点前交接包裹异常关闭量

    ,count(distinct if(fn.handover_type='17点前交接' and fn.pi_state not in (5,7,8,9),fn.pno,null)) 17点前交接包裹未终态量

	,count(distinct case when fn.handover_type='17点前交接' and fn.pi_state not in (5,7,8,9) and fn.before_17_calltimes is null then fn.pno else null end) as 17点前交接包裹未妥投且未拨打电话量
	,count(distinct case when fn.handover_type='17点前交接'  and fn.pi_state not in (5,7,8,9) and fn.before_17_calltimes = 1 then fn.pno else null end) as 17点前交接包裹未妥投且拨打电话1次量
	,count(distinct case when fn.handover_type='17点前交接'  and fn.pi_state not in (5,7,8,9) and fn.before_17_calltimes = 2 then fn.pno else null end) as 17点前交接包裹未妥投且拨打电话2次量
	,count(distinct case when fn.handover_type='17点前交接'  and fn.pi_state not in (5,7,8,9) and fn.before_17_calltimes = 3 then fn.pno else null end) as 17点前交接包裹未妥投且拨打电话3次量
	,count(distinct case when fn.handover_type='17点前交接'  and fn.pi_state not in (5,7,8,9) and fn.before_17_calltimes > 3 then fn.pno else null end) as 17点前交接包裹未妥投且拨打电话3次以上量
from
    (
        select
            pr.pno
            ,pr.store_id
            ,pr.store_name
            ,pr.piece_name
            ,pr.region_name
            ,pr.routed_date
            ,pr.pi_state
            ,pr.staff_info_id
            ,pr.handover_type
            ,pr.finished_at
            ,pr2.before_17_calltimes
        from
            ( # 所有交接包裹
                select
                    pr.*
                    ,if(hour(pr.routed_at) < 17, '17点前交接', '17点后交接') handover_type
                from
                    (
                        select
                            pr.pno
                            ,pr.staff_info_id
                            ,pr.store_id
                            ,dp.store_name
                            ,dp.piece_name
                            ,dp.region_name
                            ,pi.state pi_state
                            ,convert_tz(pr.routed_at,'+00:00','+08:00') as routed_at
                            ,convert_tz(pi.finished_at,'+00:00','+08:00') as finished_at
                            ,date(convert_tz(pr.routed_at,'+00:00','+08:00'))  as routed_date
                            ,row_number() over(partition by pr.pno,date(convert_tz(pr.routed_at,'+00:00','+08:00')) order by convert_tz(pr.routed_at,'+00:00','+08:00') desc) as rnk
                        from ph_staging.parcel_route pr
                        left join dwm.dim_ph_sys_store_rd dp on dp.store_id = pr.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
                        left join ph_staging.parcel_info pi on pr.pno = pi.pno
                        where
                            pr.routed_at >= date_sub(curdate(), interval 8 hour)
                            and pr.routed_at < date_add(curdate(), interval 16 hour)
                            and pr.route_action in ('DELIVERY_TICKET_CREATION_SCAN')
                            and dp.store_category = 1 -- 限制SP
                    ) pr
                where
                    pr.rnk=1
            ) pr
        left join
            (
                select
                    pr.pno
                    ,count(pr.call_datetime) as before_17_calltimes
                from
                    (
                            select
                                pr.pno
                                ,pr.staff_info_id
                                ,convert_tz(pr.routed_at,'+00:00','+08:00')  as call_datetime
                         from ph_staging.parcel_route pr
                         left join ph_staging.parcel_info pi on pr.pno=pi.pno
                         where
                            pr.routed_at >= date_sub(curdate(), interval 8 hour)
                            and pr.routed_at < date_add(curdate(), interval 9 hour)
                            and pr.route_action in ('PHONE')
                    )pr
                group by 1
            )pr2 on pr.pno = pr2.pno
    )fn
group by 1,2,3,4
order by 1,2,3;
;-- -. . -..- - / . -. - .-. -.--
select datediff(now(),now());
;-- -. . -..- - / . -. - .-. -.--
select
            ds.dst_store_id
            ,count(distinct ds.pno) in_house_count
            ,count(distinct if(pi.exhibition_weight > 5000 or pi.exhibition_length + pi.exhibition_width + pi.exhibition_height > 80, ds.pno, null)) big_in_house_count
            ,count(distinct if(bc.client_id is not null, ds.pno, null)) big_client_count
            ,count(distinct if(bc.client_id is null, ds.pno, null)) small_client_count
            ,count(distinct if(datediff(now(), ds.first_valid_routed_at) <= 3 and bc.client_id is not null, ds.pno, null)) 3_within_backlog_bigclient
            ,count(distinct if(datediff(now(), ds.first_valid_routed_at) > 3 and datediff(now(), ds.first_valid_routed_at) <= 5 and bc.client_id is not null, ds.pno, null)) 3_5_backlog_bigclient
            ,count(distinct if(datediff(now(), ds.first_valid_routed_at) > 5 and bc.client_id is not null, ds.pno, null)) 5_more_backlog_bigclient
        from dwm.dwd_ph_dc_should_be_delivery ds
        join ph_staging.parcel_info pi on pi.pno = ds.pno
        left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
        where
            pi.state not in (5,7,8,9)
            and ds.p_date = '2023-09-11'
        group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    fn.region_name as 大区
	,fn.piece_name as 片区
	,fn.store_name as 网点
    ,fn.staff_info_id as 员工ID

	,count(distinct if(fn.handover_type='17点前交接', fn.pno ,null)) as 17点前交接量
    ,count(distinct if(fn.handover_type='17点前交接' and fn.pi_state = 5 ,fn.pno ,null)) 17点前交接包裹妥投量
    ,count(distinct if(fn.handover_type='17点前交接' and fn.pi_state = 7 ,fn.pno ,null)) 17点前交接包裹退件量
    ,count(distinct if(fn.handover_type='17点前交接' and fn.pi_state = 8 ,fn.pno ,null)) 17点前交接包裹异常关闭量

    ,count(distinct if(fn.handover_type='17点前交接' and fn.pi_state not in (5,7,8,9),fn.pno,null)) 17点前交接包裹未终态量

	,count(distinct case when fn.handover_type='17点前交接' and fn.pi_state not in (5,7,8,9) and fn.before_17_calltimes is null then fn.pno else null end) as 17点前交接包裹未妥投且未拨打电话量
	,count(distinct case when fn.handover_type='17点前交接'  and fn.pi_state not in (5,7,8,9) and fn.before_17_calltimes = 1 then fn.pno else null end) as 17点前交接包裹未妥投且拨打电话1次量
	,count(distinct case when fn.handover_type='17点前交接'  and fn.pi_state not in (5,7,8,9) and fn.before_17_calltimes = 2 then fn.pno else null end) as 17点前交接包裹未妥投且拨打电话2次量
	,count(distinct case when fn.handover_type='17点前交接'  and fn.pi_state not in (5,7,8,9) and fn.before_17_calltimes = 3 then fn.pno else null end) as 17点前交接包裹未妥投且拨打电话3次量
	,count(distinct case when fn.handover_type='17点前交接'  and fn.pi_state not in (5,7,8,9) and fn.before_17_calltimes > 3 then fn.pno else null end) as 17点前交接包裹未妥投且拨打电话3次以上量
from
    (
        select
            pr.pno
            ,pr.store_id
            ,pr.store_name
            ,pr.piece_name
            ,pr.region_name
            ,pr.routed_date
            ,pr.pi_state
            ,pr.staff_info_id
            ,pr.handover_type
            ,pr.finished_at
            ,pr2.before_17_calltimes
        from
            ( # 所有交接包裹
                select
                    pr.*
                    ,if(hour(pr.routed_at) < 17, '17点前交接', '17点后交接') handover_type
                from
                    (
                        select
                            pr.pno
                            ,pr.staff_info_id
                            ,pr.store_id
                            ,dp.store_name
                            ,dp.piece_name
                            ,dp.region_name
                            ,pi.state pi_state
                            ,convert_tz(pr.routed_at,'+00:00','+08:00') as routed_at
                            ,convert_tz(pi.finished_at,'+00:00','+08:00') as finished_at
                            ,date(convert_tz(pr.routed_at,'+00:00','+08:00'))  as routed_date
                            ,row_number() over(partition by pr.pno,date(convert_tz(pr.routed_at,'+00:00','+08:00')) order by convert_tz(pr.routed_at,'+00:00','+08:00') desc) as rnk
                        from ph_staging.parcel_route pr
                        left join dwm.dim_ph_sys_store_rd dp on dp.store_id = pr.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
                        left join ph_staging.parcel_info pi on pr.pno = pi.pno
                        where
                            pr.routed_at >= date_sub(curdate(), interval 8 hour)
                            and pr.routed_at < date_add(curdate(), interval 16 hour)
                            and pr.route_action in ('DELIVERY_TICKET_CREATION_SCAN')
                            and dp.store_category = 1 -- 限制SP
                    ) pr
                where
                    pr.rnk=1
            ) pr
        left join
            (
                select
                    pr.pno
                    ,count(pr.call_datetime) as before_17_calltimes
                from
                    (
                            select
                                pr.pno
                                ,pr.staff_info_id
                                ,convert_tz(pr.routed_at,'+00:00','+08:00')  as call_datetime
                         from ph_staging.parcel_route pr
                         left join ph_staging.parcel_info pi on pr.pno=pi.pno
                         where
                            pr.routed_at >= date_sub(curdate(), interval 8 hour)
                            and pr.routed_at < date_add(curdate(), interval 9 hour)
                            and pr.route_action in ('PHONE')
                    )pr
                group by 1
            )pr2 on pr.pno = pr2.pno
    ) fn
group by 1,2,3,4
order by 1,2,3;
;-- -. . -..- - / . -. - .-. -.--
SELECT DATE_SUB(CURTIME(), INTERVAL (MINUTE(CURTIME()) + SECOND(CURTIME()) / 60) MINUTE) AS previous_hour;
;-- -. . -..- - / . -. - .-. -.--
SELECT DATE_SUB(CURTIME(), INTERVAL (MINUTE(CURTIME()) + SECOND(CURTIME()) / 60) MINUTE);
;-- -. . -..- - / . -. - .-. -.--
SELECT DATE_SUB(now(), INTERVAL (MINUTE(ow()) + SECOND(ow()) / 60) MINUTE);
;-- -. . -..- - / . -. - .-. -.--
SELECT DATE_SUB(now(), INTERVAL (MINUTE(now()) + SECOND(now()) / 60) MINUTE);
;-- -. . -..- - / . -. - .-. -.--
SELECT DATE_SUB(now(), INTERVAL (MINUTE(now())*60 + SECOND(now())) second );
;-- -. . -..- - / . -. - .-. -.--
SELECT date_add(date_sub(now(), interval (minute(now())*60 + second(now())) second), interval  8 hour);
;-- -. . -..- - / . -. - .-. -.--
SELECT date_sub(date_sub(now(), interval (minute(now())*60 + second(now())) second), interval  8 hour);
;-- -. . -..- - / . -. - .-. -.--
select date_sub(now(), interval (minute(now())*60 + second(now())) second);
;-- -. . -..- - / . -. - .-. -.--
select date_sub(date_sub(now(), interval (minute(now())*60 + second(now())) second), interval  8 hour);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-11'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 10
                    or (t1.total =  5 and t1.leave_time_type = 2)

                union all

                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 5
                    and t1.leave_time_type = 1 -- 上午请假
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-11'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 10
                                    or (t1.total =  5 and t1.leave_time_type = 2)

                                union all

                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 5
                                    and t1.leave_time_type = 1 -- 上午请假
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-09-11', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with d as
    (
        select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-09-11'
    )
    , t as
    (
        select
             ds.store_id
            ,ds.pno
            ,ds.stat_date
        from d ds
        left join
            (
                select
                    pr.pno
                    ,ds.stat_date
                    ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
                from ph_staging.parcel_route pr
                join d ds on pr.pno = ds.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                    and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and pr.marker_category in (42,43) ##岛屿,偏远地区
                group by 1,2
            ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
        left join
            (
                select
                   pr.pno
                    ,ds.stat_date
                   ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
                   ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
                from ph_staging.parcel_route pr
                join d ds on ds.pno = pr.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                    and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                    and pr.marker_category in (9,14,70) ##客户改约时间
            ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
        left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
        where
            case
                when pr1.pno is not null then 'N'
                when pr2.pno is not null then 'N'
                when ds1.pno is not null  then 'N'  else 'Y'
            end = 'Y'
    )
    select
        a.stat_date 日期
        ,a.store_id 网点ID
        ,dp.store_name 网点名称
        ,dp.opening_at 开业时间
        ,case
            when dp.region_name in ('Area3', 'Area6') then '彭万松'
            when dp.region_name in ('Area4', 'Area9') then '韩钥'
            when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
            when dp.region_name in ( 'Area8') then '黄勇'
            when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
        end 区域
        ,dp.region_name 大区
        ,dp.piece_name 片区
        ,a.应交接
        ,a.已交接
        ,concat(round(a.交接率*100,2),'%') as 交接率
        ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
        ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
        ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
        ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
        ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
    from
        (
            select
                t1.store_id
                ,t1.stat_date
                ,count(t1.pno) 应交接
                ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
            from t t1
            left join
                (
                    select
                        sc.*
                    from
                        (
                            select
                                pr.pno
                                ,pr.store_id
                                ,pr.store_name
                                ,t1.stat_date
                                ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                            from ph_staging.parcel_route pr
                            join t t1 on t1.pno = pr.pno
                            where
                                pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                               and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                              and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                        ) sc
                    where
                        sc.rk = 1
                ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
            group by 1,2
        ) a
    join
        (
            select
                sd.store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.store_id is not null
            group by 1

            union all

            select
                sd.separation_store_id store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.separation_store_id is not null
            group by 1
        ) sd on sd.store_id = a.store_id
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    where
        dp.store_category in (1,10);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-11'
        and pr.routed_at >= date_sub('2023-09-11', interval 8 hour )
        and pr.routed_at < date_add('2023-09-11', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,if(a3.self_staff_num + other_staff_num > coalesce(sdb.code_num, 0),
           case
            when a2.avg_staff_code < 2 then 'A'
            when a2.avg_staff_code >= 2 and a2.avg_staff_code < 3 then 'B'
            when a2.avg_staff_code >= 3 and a2.avg_staff_code < 4 then 'C'
            when a2.avg_staff_code >= 4 then 'D'
        end,
           case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end ) 评级
#         ,a2.code_num
#         ,a2.staff_code_num
#         ,a2.staff_num
#         ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) avg_staff_code
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
select -- 基于当日应派取扫描率
    tt.store_id 网点ID
    ,tt.store_name 网点名称
    ,tt.store_type 网点分类
    ,tt.piece_name 片区
    ,tt.region_name 大区
    ,tt.shoud_counts 应派总数
    ,tt.scan_fished_counts 分拣扫描数
    ,ifnull(tt.scan_fished_counts/shoud_counts,0) 分拣扫描率

    ,tt.youxiao_counts 有效分拣扫描数
    ,ifnull(tt.youxiao_counts/tt.scan_fished_counts,0) 有效分拣扫描率

    ,tt.1pai_counts 一派应派数
    ,tt.1pai_scan_fished_counts 一派分拣扫描数
    ,ifnull(tt.1pai_scan_fished_counts/tt.1pai_counts,0) 一派分拣扫描率

    ,tt.1pai_youxiao_counts 一派有效分拣扫描数
    ,ifnull(tt.1pai_youxiao_counts/tt.1pai_scan_fished_counts,0) 一派有效分拣扫描率

    ,case
	    when tt.1pai_youxiao_counts/tt.1pai_counts>=0.95 then 'A'
	    when tt.1pai_youxiao_counts/tt.1pai_counts>=0.90 then 'B'
	    when tt.1pai_youxiao_counts/tt.1pai_counts>=0.85 then 'C'
	    when tt.1pai_youxiao_counts/tt.1pai_counts>=0.80 then 'D'
	    else 'E'
	 end 一派有效分拣评级 -- 一派有效分拣

	 ,case
        when tt.1pai_hour_8_fished_counts/tt.1pai_counts>=0.95  then 'A'
        when tt.1pai_hour_8ban_fished_counts/tt.1pai_counts>=0.95  then 'B'
        when tt.1pai_hour_9_fished_counts/tt.1pai_counts>=0.95  then 'C'
        when tt.1pai_hour_9ban_fished_counts/tt.1pai_counts>=0.95  then 'D'
        else 'E'
    end 一派分拣评级

    ,ifnull(tt.1pai_hour_8_fished_counts/tt.1pai_counts,0) 一派8点前扫描占比
    ,ifnull(tt.1pai_hour_8ban_fished_counts/tt.1pai_counts,0) 一派8点半前扫描占比
    ,ifnull(tt.1pai_hour_9_fished_counts/tt.1pai_counts,0) 一派9点前扫描占比
    ,ifnull(tt.1pai_hour_9ban_fished_counts/tt.1pai_counts,0) 一派9点半前扫描占比
	,if(tt2.late_proof_counts is null , '否', '是') 是否有迟到超过规划时间20分钟的常规车
    ,tt2.max_real_arrive_time_normal 一派常规车最晚实际到达时间
#     ,tt2.max_real_arrive_proof_id 一派常规车最晚实际到达车线
#     ,tt2.max_real_arrive_vol 一派常规车最晚实际到达车线包裹量
    ,tt2.line_1_latest_plan_arrive_time 一派常规车最晚规划到达时间
    ,tt2.max_real_arrive_time_innormal 一派加班车最晚实际到达时间
#     ,tt2.max_real_arrive_innormal_proof_id  一派加班车最晚实际到达车线
#     ,tt2.max_real_arrive_innormal_vol  一派加班车最晚实际到达包裹量
    ,tt2.max_actual_plan_arrive_time_innormal 一派加班车最晚规划到达时间


from
(
    select
       base.store_id
       ,base.store_name
       ,base.store_type
       ,base.piece_name
       ,base.region_name
       ,count(distinct base.pno) shoud_counts
       ,count(distinct case when base.min_fenjian_scan_time is not null then base.pno else null end ) scan_fished_counts
       ,count(distinct case when base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then base.pno else null end ) youxiao_counts

       ,count(distinct case when base.type='一派' then  base.pno else null end ) 1pai_counts
       ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null then  base.pno else null end ) 1pai_scan_fished_counts
       ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then  base.pno else null end ) 1pai_youxiao_counts

       ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:00:00' then base.pno else null end) 1pai_hour_8_fished_counts
       ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:30:00' then base.pno else null end) 1pai_hour_8ban_fished_counts
       ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:00:00' then base.pno else null end) 1pai_hour_9_fished_counts
       ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:30:00' then base.pno else null end) 1pai_hour_9ban_fished_counts

    from
    (
       select
       t.*,
       case when t.should_delevry_type='1派应派包裹' then '一派' else null end 'type'
       from dwm.dwd_ph_dc_should_be_delivery_sort_scan t
       join ph_staging.sys_store ss
       on t.store_id =ss.id
    ) base
    group by base.store_id,base.store_name,base.store_type,base.piece_name,base.region_name
) tt

left join
(
    select
       bl.store_id
       ,bl.max_real_arrive_time_normal
       ,bl.max_real_arrive_proof_id
       ,bl.max_real_arrive_vol
       ,bl.line_1_latest_plan_arrive_time
       ,bl.max_actual_plan_arrive_time_innormal
       ,bl.max_actual_plan_arrive_innormal_proof_id
       ,bl.max_actual_plan_arrive_innormal_vol
       ,bl.max_real_arrive_time_innormal
       ,bl.max_real_arrive_innormal_proof_id
       ,bl.max_real_arrive_innormal_vol
	   ,late_proof_counts
    from dwm.fleet_real_detail_today bl
    group by 1,2,3,4,5,6,7,8,9,10,11
) tt2 on tt.store_id=tt2.store_id;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-09-11'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-09-11')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-09-11'
        and pi.finished_at >= date_sub('2023-09-11', interval 8 hour )
        and pi.finished_at < date_add('2023-09-11', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数

    ,coalesce(backlog.in_house_count, 0) 在仓包裹数
    ,coalesce(backlog.big_in_house_count, 0) 在仓大件包裹数
    ,coalesce(backlog.big_client_count, 0) 在仓平台客户包裹数
    ,coalesce(backlog.small_client_count, 0) 在仓非平台客户包裹数
    ,coalesce(backlog.3_within_backlog_bigclient, 0) 平台客户在仓积压3天内包裹数
    ,coalesce(backlog.3_5_backlog_bigclient, 0) 平台客户在仓积压3_5天内包裹数
    ,coalesce(backlog.5_more_backlog_bigclient, 0) 平台客户在仓积压5天以上包裹数
    ,coalesce(backlog.tt_overtime_count, 0) tiktok超时效包裹数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-09-11'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) in_house_count
            ,count(distinct if(pi.exhibition_weight > 5000 or pi.exhibition_length + pi.exhibition_width + pi.exhibition_height > 80, ds.pno, null)) big_in_house_count
            ,count(distinct if(bc.client_id is not null, ds.pno, null)) big_client_count
            ,count(distinct if(bc.client_id is null, ds.pno, null)) small_client_count
            ,count(distinct if(datediff(now(), ds.first_valid_routed_at) <= 3 and bc.client_id is not null, ds.pno, null)) 3_within_backlog_bigclient
            ,count(distinct if(datediff(now(), ds.first_valid_routed_at) > 3 and datediff(now(), ds.first_valid_routed_at) <= 5 and bc.client_id is not null, ds.pno, null)) 3_5_backlog_bigclient
            ,count(distinct if(datediff(now(), ds.first_valid_routed_at) > 5 and bc.client_id is not null, ds.pno, null)) 5_more_backlog_bigclient
            ,count(distinct if(tsd.end_date < curdate(), ds.pno, null)) tt_overtime_count
        from dwm.dwd_ph_dc_should_be_delivery ds
        join ph_staging.parcel_info pi on pi.pno = ds.pno and pi.state not in (5,7,8,9)
        left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
        left join dwm.dwd_ex_ph_tiktok_sla_detail tsd on tsd.pno = ds.pno
        where
            ds.p_date = '2023-09-11'
        group by 1
    ) backlog on backlog.dst_store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
with t as
    (
        select
            pi.pno
            ,pi.client_id
            ,pi.finished_at
            ,pi.ticket_delivery_staff_lng
            ,pi.ticket_delivery_staff_lat
            ,pi.dst_store_id
        from ph_staging.parcel_info pi
        where
            pi.state = 5
            and pi.finished_at >= '2023-06-30 16:00:00'
            and pi.finished_at < '2023-08-31 16:00:00'
    )
select
    date(convert_tz(t1.finished_at, '+00:00', '+08:00')) 妥投日期
    ,t1.client_id 客户ID
    ,case
        when bc.client_id is not null then bc.client_name
        when bc.client_id is null and kp.id is not null then '普通KA'
        else '小c'
    end 客户类型
    ,st_distance_sphere(point(t1.ticket_delivery_staff_lng, t1.ticket_delivery_staff_lat), point(ss.lng, ss.lat)) 妥投距离网点距离
    ,case
        when json_extract(ph.extra_value, '$.callDuration') >= 1 and json_extract(ph.extra_value, '$.callDuration') < 9 then '1-8'
        when json_extract(ph.extra_value, '$.callDuration') >= 9 and json_extract(ph.extra_value, '$.callDuration') < 11 then '9-10'
        when json_extract(ph.extra_value, '$.callDuration') >= 11 and json_extract(ph.extra_value, '$.callDuration') < 16 then '11-15'
        when json_extract(ph.extra_value, '$.callDuration') >= 16 and json_extract(ph.extra_value, '$.callDuration') < 21 then '16-20'
        when json_extract(ph.extra_value, '$.callDuration') >= 21 then '21以上'
        else '1以内'
    end 通话时长
    ,if(acc.pno is null, '否', '是') 是否有虚假投妥投诉
    ,count(distinct t1.pno) 包裹数
from t t1
left join
    (
        select
            pr.pno
            ,pr.extra_value
            ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno
        where
            pr.route_action = 'PHONE'
            and pr.routed_at < t1.finished_at
            and pr.routed_at > date_sub(curdate(), interval 90 day )
    ) ph on ph.pno = t1.pno and ph.rk = 1
left join ph_staging.sys_store ss on ss.id = t1.dst_store_id
left join ph_bi.abnormal_customer_complaint acc on acc.pno = t1.pno and acc.complaints_type = 1 -- 虚假妥投类
left join dwm.dwd_dim_bigClient bc on bc.client_id = t1.client_id
left join ph_staging.ka_profile kp on kp.id = t1.client_id
group by 1,2,3,4,5,6;
;-- -. . -..- - / . -. - .-. -.--
select * from tmpale.tmp_ph_client_visit_info;
;-- -. . -..- - / . -. - .-. -.--
select
    ssd.should_delevry_type
from dwm.dwd_ph_dc_should_be_delivery_sort_scan_d ssd
# where
#     ssd.
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
    ,pssn.store_name
    ,count(pssn.store_id) hub_count
from ph_staging.parcel_info pi
left join dw_dmd.parcel_store_stage_new pssn on pssn.pno = pi.pno
where
    pssn.valid_store_order is not null
    and pssn.store_category in (8,12)
having count(pssn.store_id) >= 2;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
    ,pssn.store_name
    ,count(pssn.store_id) hub_count
from ph_staging.parcel_info pi
left join dw_dmd.parcel_store_stage_new pssn on pssn.pno = pi.pno
where
    pssn.valid_store_order is not null
    and pssn.store_category in (8,12)
group by 1,2
having count(pssn.store_id) >= 2;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
    ,pssn.store_name
    ,count(pssn.store_id) hub_count
from ph_staging.parcel_info pi
left join dw_dmd.parcel_store_stage_new pssn on pssn.pno = pi.pno
where
    pssn.valid_store_order is not null
    and pssn.store_category in (8,12)
    and pi.state not in (5,7,8,9)
    and pi.created_at >= '2023-07-31 16:00:00'
group by 1,2
having count(pssn.store_id) >= 2;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-11'
        and pr.routed_at >= date_sub('2023-09-11', interval 8 hour )
        and pr.routed_at < date_add('2023-09-11', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,if(a3.self_staff_num + other_staff_num > coalesce(sdb.code_num, 0),
           case
            when a2.avg_staff_code < 2 then 'A'
            when a2.avg_staff_code >= 2 and a2.avg_staff_code < 3 then 'B'
            when a2.avg_staff_code >= 3 and a2.avg_staff_code < 4 then 'C'
            when a2.avg_staff_code >= 4 then 'D'
        end,
           case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end ) 评级
#         ,a2.code_num
#         ,a2.staff_code_num
#         ,a2.staff_num
#         ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) avg_staff_code
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
            ,count(distinct sdb.district_code) barangay_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-11'
        and pr.routed_at >= date_sub('2023-09-11', interval 8 hour )
        and pr.routed_at < date_add('2023-09-11', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)

select
    a1.store_id
    ,ss.name 网点
    ,a1.staff_info_id
    ,a1.job_title
    ,hjt.job_name 岗位
    ,count(distinct a1.third_sorting_code) 交接三段码数
    ,group_concat(distinct a1.third_sorting_code) 交接三段码
from
    (
        select
            a1.*
        from
            (
                select
                    t1.store_id
                    ,t1.pno
                    ,t1.staff_info_id
                    ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                    ,t1.state
                    ,t1.job_title
                    ,ps.third_sorting_code
                    ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                from t t1
                join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
            ) a1
        where
            a1.rk = 1
    ) a1
left join ph_staging.sys_store ss on ss.id = a1.store_id
left join ph_bi.hr_job_title hjt on hjt.id = a1.job_title
where
    a1.job_title in (13,110,1000) -- 快递员
group by 3;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-11'
        and pr.routed_at >= date_sub('2023-09-11', interval 8 hour )
        and pr.routed_at < date_add('2023-09-11', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)

select
    a1.store_id
    ,ss.name 网点
    ,ss2.staff_count 交接员工数
    ,sdb.code_num 网点现有三段码数
    ,sdb.barangay_num 网点绑定三段码barangay数
    ,a1.staff_info_id
    ,if(a1.is_self = 'y', '本网点', '非本网点') 员工归属
    ,hjt.job_name 岗位
    ,count(distinct a1.third_sorting_code) 交接三段码数
    ,group_concat(distinct a1.third_sorting_code) 交接三段码
from
    (
        select
            a1.*
        from
            (
                select
                    t1.store_id
                    ,t1.pno
                    ,t1.staff_info_id
                    ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                    ,t1.state
                    ,t1.job_title
                    ,ps.third_sorting_code
                    ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                from t t1
                join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
            ) a1
        where
            a1.rk = 1
    ) a1
left join ph_staging.sys_store ss on ss.id = a1.store_id
left join ph_bi.hr_job_title hjt on hjt.id = a1.job_title
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
            ,count(distinct sdb.district_code) barangay_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a1.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.staff_info_id) staff_count
        from t t1
        where
            t1.job_title in (13,110,1000)
        group by 1
    ) ss2 on ss2.id = a1.store_id
where
    a1.job_title in (13,110,1000) -- 快递员
group by 3;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-11'
        and pr.routed_at >= date_sub('2023-09-11', interval 8 hour )
        and pr.routed_at < date_add('2023-09-11', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)

select
    a1.store_id
    ,ss.name 网点
    ,ss2.staff_count 交接员工数
    ,sdb.code_num 网点现有三段码数
    ,sdb.barangay_num 网点绑定三段码barangay数
    ,a1.staff_info_id
    ,if(a1.is_self = 'y', '本网点', '非本网点') 员工归属
    ,hjt.job_name 岗位
    ,count(distinct a1.third_sorting_code) 交接三段码数
    ,group_concat(distinct a1.third_sorting_code) 交接三段码
from
    (
        select
            a1.*
        from
            (
                select
                    t1.store_id
                    ,t1.pno
                    ,t1.staff_info_id
                    ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                    ,t1.state
                    ,t1.job_title
                    ,ps.third_sorting_code
                    ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                from t t1
                join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
            ) a1
        where
            a1.rk = 1
    ) a1
left join ph_staging.sys_store ss on ss.id = a1.store_id
left join ph_bi.hr_job_title hjt on hjt.id = a1.job_title
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
            ,count(distinct sdb.district_code) barangay_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a1.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.staff_info_id) staff_count
        from t t1
        where
            t1.job_title in (13,110,1000)
        group by 1
    ) ss2 on ss2.store_id = a1.store_id
where
    a1.job_title in (13,110,1000) -- 快递员
group by 3;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-11'
        and pr.routed_at >= date_sub('2023-09-11', interval 8 hour )
        and pr.routed_at < date_add('2023-09-11', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)

select
    a1.store_id
    ,ss.name 网点
    ,ss2.staff_count 交接员工数
    ,sdb.code_num 网点现有三段码数
    ,sdb.barangay_num 网点绑定三段码barangay数
    ,a1.staff_info_id
    ,if(a1.is_self = 'y', '本网点', '非本网点') 员工归属
    ,hjt.job_name 岗位
    ,count(distinct a1.third_sorting_code) 交接三段码数
    ,group_concat(distinct a1.third_sorting_code) 交接三段码
from
    (
        select
            a1.*
        from
            (
                select
                    t1.store_id
                    ,t1.pno
                    ,t1.staff_info_id
                    ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                    ,t1.state
                    ,t1.job_title
                    ,ps.third_sorting_code
                    ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                from t t1
                join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
            ) a1
        where
            a1.rk = 1
    ) a1
left join ph_staging.sys_store ss on ss.id = a1.store_id
left join ph_bi.hr_job_title hjt on hjt.id = a1.job_title
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
            ,count(distinct sdb.district_code) barangay_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a1.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.staff_info_id) staff_count
        from t t1
        where
            t1.job_title in (13,110,1000)
        group by 1
    ) ss2 on ss2.store_id = a1.store_id
where
    a1.job_title in (13,110,1000) -- 快递员
group by 1,2,3,4,5,6;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-11'
        and pr.routed_at >= date_sub('2023-09-11', interval 8 hour )
        and pr.routed_at < date_add('2023-09-11', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)

select
    a1.store_id
    ,ss.name 网点
    ,ss2.staff_count 交接员工数
    ,sdb.code_num 网点现有三段码数
    ,if(ss2.staff_count > sdb.code_num, '人比码多', '码比人多') 人码对比
    ,sdb.barangay_num 网点绑定三段码barangay数
    ,a1.staff_info_id
    ,if(a1.is_self = 'y', '本网点', '非本网点') 员工归属
    ,hjt.job_name 岗位
    ,count(distinct a1.third_sorting_code) 交接三段码数
    ,group_concat(distinct a1.third_sorting_code) 交接三段码
from
    (
        select
            a1.*
        from
            (
                select
                    t1.store_id
                    ,t1.pno
                    ,t1.staff_info_id
                    ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                    ,t1.state
                    ,t1.job_title
                    ,ps.third_sorting_code
                    ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                from t t1
                join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
            ) a1
        where
            a1.rk = 1
    ) a1
left join ph_staging.sys_store ss on ss.id = a1.store_id
left join ph_bi.hr_job_title hjt on hjt.id = a1.job_title
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
            ,count(distinct sdb.district_code) barangay_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a1.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.staff_info_id) staff_count
        from t t1
        where
            t1.job_title in (13,110,1000)
        group by 1
    ) ss2 on ss2.store_id = a1.store_id
where
    a1.job_title in (13,110,1000) -- 快递员
group by 1,2,3,4,5,6,7;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-11'
        and pr.routed_at >= date_sub('2023-09-11', interval 8 hour )
        and pr.routed_at < date_add('2023-09-11', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)

select
    a1.store_id
    ,ss.name 网点
    ,ss2.staff_count 交接员工数
    ,sdb.code_num 网点现有三段码数
    ,if(ss2.staff_count > sdb.code_num, '人比码多', '码比人多') 人码对比
    ,sdb.barangay_num 网点绑定三段码barangay数
    ,a1.third_sorting_code
#     ,if(a1.is_self = 'y', '本网点', '非本网点') 员工归属
    ,hjt.job_name 岗位
    ,count(distinct a1.staff_info_id) 交接三段码数
    ,group_concat(distinct a1.staff_info_id) 交接三段码
from
    (
        select
            a1.*
        from
            (
                select
                    t1.store_id
                    ,t1.pno
                    ,t1.staff_info_id
                    ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                    ,t1.state
                    ,t1.job_title
                    ,ps.third_sorting_code
                    ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                from t t1
                join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
            ) a1
        where
            a1.rk = 1
    ) a1
left join ph_staging.sys_store ss on ss.id = a1.store_id
left join ph_bi.hr_job_title hjt on hjt.id = a1.job_title
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
            ,count(distinct sdb.district_code) barangay_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a1.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.staff_info_id) staff_count
        from t t1
        where
            t1.job_title in (13,110,1000)
        group by 1
    ) ss2 on ss2.store_id = a1.store_id
where
    a1.job_title in (13,110,1000) -- 快递员
group by 1,2,3,4,5,6,7;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-11'
        and pr.routed_at >= date_sub('2023-09-11', interval 8 hour )
        and pr.routed_at < date_add('2023-09-11', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)

select
    a1.store_id
    ,ss.name 网点
    ,ss2.staff_count 交接员工数
    ,sdb.code_num 网点现有三段码数
    ,if(ss2.staff_count > sdb.code_num, '人比码多', '码比人多') 人码对比
    ,sdb.barangay_num 网点绑定三段码barangay数
    ,a1.third_sorting_code
#     ,if(a1.is_self = 'y', '本网点', '非本网点') 员工归属
#     ,hjt.job_name 岗位
    ,count(distinct a1.staff_info_id) 交接三段码数
    ,group_concat(distinct a1.staff_info_id) 交接三段码
from
    (
        select
            a1.*
        from
            (
                select
                    t1.store_id
                    ,t1.pno
                    ,t1.staff_info_id
                    ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                    ,t1.state
                    ,t1.job_title
                    ,ps.third_sorting_code
                    ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                from t t1
                join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
            ) a1
        where
            a1.rk = 1
    ) a1
left join ph_staging.sys_store ss on ss.id = a1.store_id
left join ph_bi.hr_job_title hjt on hjt.id = a1.job_title
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
            ,count(distinct sdb.district_code) barangay_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a1.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.staff_info_id) staff_count
        from t t1
        where
            t1.job_title in (13,110,1000)
        group by 1
    ) ss2 on ss2.store_id = a1.store_id
where
    a1.job_title in (13,110,1000) -- 快递员
group by 1,2,3,4,5,6,7;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-12'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 10
                    or (t1.total =  5 and t1.leave_time_type = 2)

                union all

                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 5
                    and t1.leave_time_type = 1 -- 上午请假
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-12'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 10
                                    or (t1.total =  5 and t1.leave_time_type = 2)

                                union all

                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 5
                                    and t1.leave_time_type = 1 -- 上午请假
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-09-12', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with d as
    (
        select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-09-12'
    )
    , t as
    (
        select
             ds.store_id
            ,ds.pno
            ,ds.stat_date
        from d ds
        left join
            (
                select
                    pr.pno
                    ,ds.stat_date
                    ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
                from ph_staging.parcel_route pr
                join d ds on pr.pno = ds.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                    and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and pr.marker_category in (42,43) ##岛屿,偏远地区
                group by 1,2
            ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
        left join
            (
                select
                   pr.pno
                    ,ds.stat_date
                   ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
                   ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
                from ph_staging.parcel_route pr
                join d ds on ds.pno = pr.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                    and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                    and pr.marker_category in (9,14,70) ##客户改约时间
            ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
        left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
        where
            case
                when pr1.pno is not null then 'N'
                when pr2.pno is not null then 'N'
                when ds1.pno is not null  then 'N'  else 'Y'
            end = 'Y'
    )
    select
        a.stat_date 日期
        ,a.store_id 网点ID
        ,dp.store_name 网点名称
        ,dp.opening_at 开业时间
        ,case
            when dp.region_name in ('Area3', 'Area6') then '彭万松'
            when dp.region_name in ('Area4', 'Area9') then '韩钥'
            when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
            when dp.region_name in ( 'Area8') then '黄勇'
            when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
        end 区域
        ,dp.region_name 大区
        ,dp.piece_name 片区
        ,a.应交接
        ,a.已交接
        ,concat(round(a.交接率*100,2),'%') as 交接率
        ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
        ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
        ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
        ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
        ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
    from
        (
            select
                t1.store_id
                ,t1.stat_date
                ,count(t1.pno) 应交接
                ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
            from t t1
            left join
                (
                    select
                        sc.*
                    from
                        (
                            select
                                pr.pno
                                ,pr.store_id
                                ,pr.store_name
                                ,t1.stat_date
                                ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                            from ph_staging.parcel_route pr
                            join t t1 on t1.pno = pr.pno
                            where
                                pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                               and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                              and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                        ) sc
                    where
                        sc.rk = 1
                ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
            group by 1,2
        ) a
    join
        (
            select
                sd.store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.store_id is not null
            group by 1

            union all

            select
                sd.separation_store_id store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.separation_store_id is not null
            group by 1
        ) sd on sd.store_id = a.store_id
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    where
        dp.store_category in (1,10);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-12'
        and pr.routed_at >= date_sub('2023-09-12', interval 8 hour )
        and pr.routed_at < date_add('2023-09-12', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,if(a3.self_staff_num + other_staff_num > coalesce(sdb.code_num, 0),
           case
            when a2.avg_staff_code < 2 then 'A'
            when a2.avg_staff_code >= 2 and a2.avg_staff_code < 3 then 'B'
            when a2.avg_staff_code >= 3 and a2.avg_staff_code < 4 then 'C'
            when a2.avg_staff_code >= 4 then 'D'
        end,
           case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end ) 评级
#         ,a2.code_num
#         ,a2.staff_code_num
#         ,a2.staff_num
#         ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) avg_staff_code
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
            ,count(distinct sdb.district_code) barangay_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-12'
        and pr.routed_at >= date_sub('2023-09-12', interval 8 hour )
        and pr.routed_at < date_add('2023-09-12', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)

select
    a1.store_id
    ,ss.name 网点
    ,ss2.staff_count 交接员工数
    ,sdb.code_num 网点现有三段码数
    ,if(ss2.staff_count > sdb.code_num, '人比码多', '码比人多') 人码对比
    ,sdb.barangay_num 网点绑定三段码barangay数
    ,a1.third_sorting_code
#     ,if(a1.is_self = 'y', '本网点', '非本网点') 员工归属
#     ,hjt.job_name 岗位
    ,count(distinct a1.staff_info_id) 交接三段码数
    ,group_concat(distinct a1.staff_info_id) 交接三段码
from
    (
        select
            a1.*
        from
            (
                select
                    t1.store_id
                    ,t1.pno
                    ,t1.staff_info_id
                    ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                    ,t1.state
                    ,t1.job_title
                    ,ps.third_sorting_code
                    ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                from t t1
                join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
            ) a1
        where
            a1.rk = 1
    ) a1
left join ph_staging.sys_store ss on ss.id = a1.store_id
left join ph_bi.hr_job_title hjt on hjt.id = a1.job_title
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
            ,count(distinct sdb.district_code) barangay_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a1.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.staff_info_id) staff_count
        from t t1
        where
            t1.job_title in (13,110,1000)
        group by 1
    ) ss2 on ss2.store_id = a1.store_id
where
    a1.job_title in (13,110,1000) -- 快递员
group by 1,2,3,4,5,6,7;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-09-12'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-09-12')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-09-12'
        and pi.finished_at >= date_sub('2023-09-12', interval 8 hour )
        and pi.finished_at < date_add('2023-09-12', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数

    ,coalesce(backlog.in_house_count, 0) 在仓包裹数
    ,coalesce(backlog.big_in_house_count, 0) 在仓大件包裹数
    ,coalesce(backlog.big_client_count, 0) 在仓平台客户包裹数
    ,coalesce(backlog.small_client_count, 0) 在仓非平台客户包裹数
    ,coalesce(backlog.3_within_backlog_bigclient, 0) 平台客户在仓积压3天内包裹数
    ,coalesce(backlog.3_5_backlog_bigclient, 0) 平台客户在仓积压3_5天内包裹数
    ,coalesce(backlog.5_more_backlog_bigclient, 0) 平台客户在仓积压5天以上包裹数
    ,coalesce(backlog.tt_overtime_count, 0) tiktok超时效包裹数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-09-12'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) in_house_count
            ,count(distinct if(pi.exhibition_weight > 5000 or pi.exhibition_length + pi.exhibition_width + pi.exhibition_height > 80, ds.pno, null)) big_in_house_count
            ,count(distinct if(bc.client_id is not null, ds.pno, null)) big_client_count
            ,count(distinct if(bc.client_id is null, ds.pno, null)) small_client_count
            ,count(distinct if(datediff(now(), ds.first_valid_routed_at) <= 3 and bc.client_id is not null, ds.pno, null)) 3_within_backlog_bigclient
            ,count(distinct if(datediff(now(), ds.first_valid_routed_at) > 3 and datediff(now(), ds.first_valid_routed_at) <= 5 and bc.client_id is not null, ds.pno, null)) 3_5_backlog_bigclient
            ,count(distinct if(datediff(now(), ds.first_valid_routed_at) > 5 and bc.client_id is not null, ds.pno, null)) 5_more_backlog_bigclient
            ,count(distinct if(tsd.end_date < curdate(), ds.pno, null)) tt_overtime_count
        from dwm.dwd_ph_dc_should_be_delivery ds
        join ph_staging.parcel_info pi on pi.pno = ds.pno and pi.state not in (5,7,8,9)
        left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
        left join dwm.dwd_ex_ph_tiktok_sla_detail tsd on tsd.pno = ds.pno
        where
            ds.p_date = '2023-09-12'
        group by 1
    ) backlog on backlog.dst_store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
select
    hsi.staff_info_id
    ,max(hst.stat_date) change_date
from ph_bi.hr_staff_info hsi
join ph_bi.hr_staff_transfer hst on hst.staff_info_id = hsi.staff_info_id and hst.job_title = 13
where
    hsi.job_title = 110 -- van
    and hsi.state = 1
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    de.pno 运单号
    ,de.src_store 揽件网点
    ,de.src_piece 片区
    ,de.src_region 大区
    ,de.client_id 客户ID
    ,de.pickup_time 揽件时间
    ,de.dst_store 目的网点
    ,case pi.article_category
        when '0' then '文件'
        when '1' then '干燥食品'
        when '10' then '家居用具'
        when '11' then '水果'
        when '2' then '日用品'
        when '3' then '数码产品'
        when '4' then '衣物'
        when '5' then '书刊'
        when '6' then '汽车配件'
        when '7' then '鞋包'
        when '8' then '体育器材'
        when '9' then '化妆品'
        when '99' then '其它'
    end  as 物品类型
    ,pi.exhibition_weight 物品重量
    ,pi.exhibition_length*pi.exhibition_width*pi.exhibition_height 物品体积
    ,pi.cod_amount/100 COD金额
    ,de.last_cn_route_action 最后一步有效路由
    ,de.last_route_time 操作时间
    ,de.last_staff_info_id 操作ID
#     ,'普通' type
from dwm.dwd_ex_ph_parcel_details de
left join ph_staging.parcel_info pi on pi.pno = de.pno
left join ph_staging.parcel_route pr on pr.pno = pi.pno and pr.store_id = pi.ticket_pickup_store_id and pr.route_action = 'SHIPMENT_WAREHOUSE_SCAN'
left join ph_staging.sys_store ss on ss.id = de.src_store_id
where
    pr.routed_at is null
    and de.pickup_time < curdate()
    and de.dst_store != de.src_store -- 剔除自揽自派
    and pi.state not in (5,7,8,9)
    and de.client_id != 'AA0038' -- 物料仓
    and ss.category != 6
    and de.last_store_id = de.src_store_id

union
-- 物料仓
select
     de.pno 运单号
    ,de.src_store 揽件网点
    ,de.src_piece 片区
    ,de.src_region 大区
    ,de.client_id 客户ID
    ,de.pickup_time 揽件时间
    ,de.dst_store 目的网点
    ,case pi.article_category
        when '0' then '文件'
        when '1' then '干燥食品'
        when '10' then '家居用具'
        when '11' then '水果'
        when '2' then '日用品'
        when '3' then '数码产品'
        when '4' then '衣物'
        when '5' then '书刊'
        when '6' then '汽车配件'
        when '7' then '鞋包'
        when '8' then '体育器材'
        when '9' then '化妆品'
        when '99' then '其它'
    end  as 物品类型
    ,pi.exhibition_weight 物品重量
    ,pi.exhibition_length*pi.exhibition_width*pi.exhibition_height 物品体积
    ,pi.cod_amount/100 COD金额
    ,de.last_cn_route_action 最后一步有效路由
    ,de.last_route_time 操作时间
    ,de.last_staff_info_id 操作ID
#     ,'物料' type
from dwm.dwd_ex_ph_parcel_details de
left join ph_staging.parcel_info pi on pi.pno = de.pno
# left join ph_staging.parcel_route pr on pr.pno = pi.pno and pr.store_id = pi.ticket_pickup_store_id and pr.route_action = 'SHIPMENT_WAREHOUSE_SCAN'
left join ph_staging.sys_store ss on ss.id = de.src_store_id
where
    de.src_hub_out_time is null
    and de.pickup_time < curdate()
    and de.dst_store != de.src_store -- 剔除自揽自派
    and pi.state not in (5,7,8,9)
    and de.client_id = 'AA0038' -- 物料仓
    and ss.category != 6 -- 非FH

union all

select
    de.pno 运单号
    ,de.src_store 揽件网点
    ,de.src_piece 片区
    ,de.src_region 大区
    ,de.client_id 客户ID
    ,de.pickup_time 揽件时间
    ,de.dst_store 目的网点
    ,case pi.article_category
        when '0' then '文件'
        when '1' then '干燥食品'
        when '10' then '家居用具'
        when '11' then '水果'
        when '2' then '日用品'
        when '3' then '数码产品'
        when '4' then '衣物'
        when '5' then '书刊'
        when '6' then '汽车配件'
        when '7' then '鞋包'
        when '8' then '体育器材'
        when '9' then '化妆品'
        when '99' then '其它'
    end  as 物品类型
    ,pi.exhibition_weight 物品重量
    ,pi.exhibition_length*pi.exhibition_width*pi.exhibition_height 物品体积
    ,pi.cod_amount/100 COD金额
    ,de.last_cn_route_action 最后一步有效路由
    ,de.last_route_time 操作时间
    ,de.last_staff_info_id 操作ID
#     ,'fh' type
from dwm.dwd_ex_ph_parcel_details de
left join ph_staging.parcel_info pi on pi.pno = de.pno
left join ph_staging.parcel_route pr on pr.pno = pi.pno and pr.store_id = pi.ticket_pickup_store_id and pr.route_action = 'SHIPMENT_WAREHOUSE_SCAN'
left join ph_staging.parcel_route pr2 on pr2.pno = pi.pno and pr2.route_action = 'FLASH_HOME_SCAN'
left join ph_staging.sys_store ss on ss.id = de.src_store_id
where
    coalesce(pr.routed_at, pr2.routed_at) is null
    and de.pickup_time < curdate()
    and de.dst_store != de.src_store -- 剔除自揽自派
    and de.last_store_id = pi.ticket_pickup_store_id
    and pi.state not in (5,7,8,9)
    and de.client_id != 'AA0038' -- 物料仓
    and ss.category = 6;
;-- -. . -..- - / . -. - .-. -.--
select left(sa.object_key,26) from ph_backyard.sys_attachment sa where  sa.id = 'f4466fd8fac9de316946d9d0a64340c1';
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        hsi.staff_info_id
        ,max(hst.stat_date) change_date
    from ph_bi.hr_staff_info hsi
    join ph_bi.hr_staff_transfer hst on hst.staff_info_id = hsi.staff_info_id and hst.job_title = 13
    where
        hsi.job_title = 110 -- van
        and hsi.state = 1
    group by 1
)
select
    t1.staff_info_id
    ,t1.change_date bike转van日期
    ,a1.in_work_pic 转职第一天上班照片
    ,a1.out_work_pic 转职第一天下班照片
    ,a2.in_work_pic 昨天上班照片
    ,a2.out_work_pic 昨天下班照片
from t t1
left join
    (
        select
            smr.staff_info_id
            ,smr.mileage_date
            ,concat('https://fex-ph-asset-pro.oss-ap-southeast-1.aliyuncs.com/',sa.object_key) in_work_pic
            ,concat('https://fex-ph-asset-pro.oss-ap-southeast-1.aliyuncs.com/',sa2.object_key) out_work_pic
        from ph_backyard.staff_mileage_record smr
        join t t1 on smr.staff_info_id = t1.staff_info_id and smr.mileage_date = date_add(t1.change_date, interval 1 day)
        left join ph_backyard.sys_attachment sa on sa.oss_bucket_key = smr.id and left(sa.object_key, 26) = 'staffMileageWorkRecord/SMI' -- 上班里程
        left join ph_backyard.sys_attachment sa2 on sa2.oss_bucket_key = smr.id and left(sa2.object_key, 26) = 'staffMileageWorkRecord/EMI' -- 下班里程
    ) a1 on a1.staff_info_id = t1.staff_info_id
left join
    (
        select
            smr.staff_info_id
            ,smr.mileage_date
            ,concat('https://fex-ph-asset-pro.oss-ap-southeast-1.aliyuncs.com/',sa.object_key) in_work_pic
            ,concat('https://fex-ph-asset-pro.oss-ap-southeast-1.aliyuncs.com/',sa2.object_key) out_work_pic
        from ph_backyard.staff_mileage_record smr
        join t t1 on smr.staff_info_id = t1.staff_info_id and smr.mileage_date = date_sub(curdate(), interval 1 day)
        left join ph_backyard.sys_attachment sa on sa.oss_bucket_key = smr.id and left(sa.object_key, 26) = 'staffMileageWorkRecord/SMI' -- 上班里程
        left join ph_backyard.sys_attachment sa2 on sa2.oss_bucket_key = smr.id and left(sa2.object_key, 26) = 'staffMileageWorkRecord/EMI' -- 下班里程
    ) a2 on a2.staff_info_id = t1.staff_info_id;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        hsi.staff_info_id
        ,max(hst.stat_date) change_date
    from ph_bi.hr_staff_info hsi
    join ph_bi.hr_staff_transfer hst on hst.staff_info_id = hsi.staff_info_id and hst.job_title = 13
    where
        hsi.job_title = 110 -- van
        and hsi.state = 1
    group by 1
)
select
    t1.staff_info_id
    ,t1.change_date bike转van日期
    ,t1.change_date 转职日期
    ,a1.mileage_date 转职后第一天上班日期
    ,a1.in_work_pic 转职后第一天上班照片
    ,a1.out_work_pic 转职后第一天下班照片
    ,a2.mileage_date 最近一天上班日期
    ,a2.in_work_pic 最近一天上班照片
    ,a2.out_work_pic 最近一天下班照片
from t t1
left join
    (
        select
            smr.staff_info_id
            ,smr.mileage_date
            ,concat('https://fex-ph-asset-pro.oss-ap-southeast-1.aliyuncs.com/',sa.object_key) in_work_pic
            ,concat('https://fex-ph-asset-pro.oss-ap-southeast-1.aliyuncs.com/',sa2.object_key) out_work_pic
            ,row_number() over (partition by smr.staff_info_id order by smr.mileage_date) rk
        from ph_backyard.staff_mileage_record smr
        join t t1 on smr.staff_info_id = t1.staff_info_id and smr.mileage_date > change_date
        left join ph_backyard.sys_attachment sa on sa.oss_bucket_key = smr.id and left(sa.object_key, 26) = 'staffMileageWorkRecord/SMI' -- 上班里程
        left join ph_backyard.sys_attachment sa2 on sa2.oss_bucket_key = smr.id and left(sa2.object_key, 26) = 'staffMileageWorkRecord/EMI' -- 下班里程
    ) a1 on a1.staff_info_id = t1.staff_info_id and a1.rk = 1
left join
    (
        select
            smr.staff_info_id
            ,smr.mileage_date
            ,concat('https://fex-ph-asset-pro.oss-ap-southeast-1.aliyuncs.com/',sa.object_key) in_work_pic
            ,concat('https://fex-ph-asset-pro.oss-ap-southeast-1.aliyuncs.com/',sa2.object_key) out_work_pic
            ,row_number() over (partition by smr.staff_info_id order by smr.mileage_date desc) rk
        from ph_backyard.staff_mileage_record smr
        join t t1 on smr.staff_info_id = t1.staff_info_id and smr.mileage_date < curdate()
        left join ph_backyard.sys_attachment sa on sa.oss_bucket_key = smr.id and left(sa.object_key, 26) = 'staffMileageWorkRecord/SMI' -- 上班里程
        left join ph_backyard.sys_attachment sa2 on sa2.oss_bucket_key = smr.id and left(sa2.object_key, 26) = 'staffMileageWorkRecord/EMI' -- 下班里程
    ) a2 on a2.staff_info_id = t1.staff_info_id and a2.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        hsi.staff_info_id
        ,max(hst.stat_date) change_date
    from ph_bi.hr_staff_info hsi
    join ph_bi.hr_staff_transfer hst on hst.staff_info_id = hsi.staff_info_id and hst.job_title = 1000
    where
        hsi.job_title = 110 -- van
        and hsi.state = 1
    group by 1
)
select
    t1.staff_info_id
    ,t1.change_date bike转van日期
    ,t1.change_date 转职日期
    ,a1.mileage_date 转职后第一天上班日期
    ,a1.in_work_pic 转职后第一天上班照片
    ,a1.out_work_pic 转职后第一天下班照片
    ,a2.mileage_date 最近一天上班日期
    ,a2.in_work_pic 最近一天上班照片
    ,a2.out_work_pic 最近一天下班照片
from t t1
left join
    (
        select
            smr.staff_info_id
            ,smr.mileage_date
            ,concat('https://fex-ph-asset-pro.oss-ap-southeast-1.aliyuncs.com/',sa.object_key) in_work_pic
            ,concat('https://fex-ph-asset-pro.oss-ap-southeast-1.aliyuncs.com/',sa2.object_key) out_work_pic
            ,row_number() over (partition by smr.staff_info_id order by smr.mileage_date) rk
        from ph_backyard.staff_mileage_record smr
        join t t1 on smr.staff_info_id = t1.staff_info_id and smr.mileage_date > change_date
        left join ph_backyard.sys_attachment sa on sa.oss_bucket_key = smr.id and left(sa.object_key, 26) = 'staffMileageWorkRecord/SMI' -- 上班里程
        left join ph_backyard.sys_attachment sa2 on sa2.oss_bucket_key = smr.id and left(sa2.object_key, 26) = 'staffMileageWorkRecord/EMI' -- 下班里程
    ) a1 on a1.staff_info_id = t1.staff_info_id and a1.rk = 1
left join
    (
        select
            smr.staff_info_id
            ,smr.mileage_date
            ,concat('https://fex-ph-asset-pro.oss-ap-southeast-1.aliyuncs.com/',sa.object_key) in_work_pic
            ,concat('https://fex-ph-asset-pro.oss-ap-southeast-1.aliyuncs.com/',sa2.object_key) out_work_pic
            ,row_number() over (partition by smr.staff_info_id order by smr.mileage_date desc) rk
        from ph_backyard.staff_mileage_record smr
        join t t1 on smr.staff_info_id = t1.staff_info_id and smr.mileage_date < curdate()
        left join ph_backyard.sys_attachment sa on sa.oss_bucket_key = smr.id and left(sa.object_key, 26) = 'staffMileageWorkRecord/SMI' -- 上班里程
        left join ph_backyard.sys_attachment sa2 on sa2.oss_bucket_key = smr.id and left(sa2.object_key, 26) = 'staffMileageWorkRecord/EMI' -- 下班里程
    ) a2 on a2.staff_info_id = t1.staff_info_id and a2.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-13'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 10
                                    or (t1.total =  5 and t1.leave_time_type = 2)

                                union all

                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 5
                                    and t1.leave_time_type = 1 -- 上午请假
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-09-13', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with d as
    (
        select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-09-13'
    )
    , t as
    (
        select
             ds.store_id
            ,ds.pno
            ,ds.stat_date
        from d ds
        left join
            (
                select
                    pr.pno
                    ,ds.stat_date
                    ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
                from ph_staging.parcel_route pr
                join d ds on pr.pno = ds.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                    and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and pr.marker_category in (42,43) ##岛屿,偏远地区
                group by 1,2
            ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
        left join
            (
                select
                   pr.pno
                    ,ds.stat_date
                   ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
                   ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
                from ph_staging.parcel_route pr
                join d ds on ds.pno = pr.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                    and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                    and pr.marker_category in (9,14,70) ##客户改约时间
            ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
        left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
        where
            case
                when pr1.pno is not null then 'N'
                when pr2.pno is not null then 'N'
                when ds1.pno is not null  then 'N'  else 'Y'
            end = 'Y'
    )
    select
        a.stat_date 日期
        ,a.store_id 网点ID
        ,dp.store_name 网点名称
        ,dp.opening_at 开业时间
        ,case
            when dp.region_name in ('Area3', 'Area6') then '彭万松'
            when dp.region_name in ('Area4', 'Area9') then '韩钥'
            when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
            when dp.region_name in ( 'Area8') then '黄勇'
            when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
        end 区域
        ,dp.region_name 大区
        ,dp.piece_name 片区
        ,a.应交接
        ,a.已交接
        ,concat(round(a.交接率*100,2),'%') as 交接率
        ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
        ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
        ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
        ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
        ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
    from
        (
            select
                t1.store_id
                ,t1.stat_date
                ,count(t1.pno) 应交接
                ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
            from t t1
            left join
                (
                    select
                        sc.*
                    from
                        (
                            select
                                pr.pno
                                ,pr.store_id
                                ,pr.store_name
                                ,t1.stat_date
                                ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                            from ph_staging.parcel_route pr
                            join t t1 on t1.pno = pr.pno
                            where
                                pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                               and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                              and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                        ) sc
                    where
                        sc.rk = 1
                ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
            group by 1,2
        ) a
    join
        (
            select
                sd.store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.store_id is not null
            group by 1

            union all

            select
                sd.separation_store_id store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.separation_store_id is not null
            group by 1
        ) sd on sd.store_id = a.store_id
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    where
        dp.store_category in (1,10);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-13'
        and pr.routed_at >= date_sub('2023-09-13', interval 8 hour )
        and pr.routed_at < date_add('2023-09-13', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,if(a3.self_staff_num + other_staff_num > coalesce(sdb.code_num, 0),
           case
            when a2.avg_staff_code < 2 then 'A'
            when a2.avg_staff_code >= 2 and a2.avg_staff_code < 3 then 'B'
            when a2.avg_staff_code >= 3 and a2.avg_staff_code < 4 then 'C'
            when a2.avg_staff_code >= 4 then 'D'
        end,
           case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end ) 评级
#         ,a2.code_num
#         ,a2.staff_code_num
#         ,a2.staff_num
#         ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) avg_staff_code
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
            ,count(distinct sdb.district_code) barangay_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-09-13'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-09-13')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-09-13'
        and pi.finished_at >= date_sub('2023-09-13', interval 8 hour )
        and pi.finished_at < date_add('2023-09-13', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数

    ,coalesce(backlog.in_house_count, 0) 在仓包裹数
    ,coalesce(backlog.big_in_house_count, 0) 在仓大件包裹数
    ,coalesce(backlog.big_client_count, 0) 在仓平台客户包裹数
    ,coalesce(backlog.small_client_count, 0) 在仓非平台客户包裹数
    ,coalesce(backlog.3_within_backlog_bigclient, 0) 平台客户在仓积压3天内包裹数
    ,coalesce(backlog.3_5_backlog_bigclient, 0) 平台客户在仓积压3_5天内包裹数
    ,coalesce(backlog.5_more_backlog_bigclient, 0) 平台客户在仓积压5天以上包裹数
    ,coalesce(backlog.tt_overtime_count, 0) tiktok超时效包裹数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-09-13'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) in_house_count
            ,count(distinct if(pi.exhibition_weight > 5000 or pi.exhibition_length + pi.exhibition_width + pi.exhibition_height > 80, ds.pno, null)) big_in_house_count
            ,count(distinct if(bc.client_id is not null, ds.pno, null)) big_client_count
            ,count(distinct if(bc.client_id is null, ds.pno, null)) small_client_count
            ,count(distinct if(datediff(now(), ds.first_valid_routed_at) <= 3 and bc.client_id is not null, ds.pno, null)) 3_within_backlog_bigclient
            ,count(distinct if(datediff(now(), ds.first_valid_routed_at) > 3 and datediff(now(), ds.first_valid_routed_at) <= 5 and bc.client_id is not null, ds.pno, null)) 3_5_backlog_bigclient
            ,count(distinct if(datediff(now(), ds.first_valid_routed_at) > 5 and bc.client_id is not null, ds.pno, null)) 5_more_backlog_bigclient
            ,count(distinct if(tsd.end_date < curdate(), ds.pno, null)) tt_overtime_count
        from dwm.dwd_ph_dc_should_be_delivery ds
        join ph_staging.parcel_info pi on pi.pno = ds.pno and pi.state not in (5,7,8,9)
        left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
        left join dwm.dwd_ex_ph_tiktok_sla_detail tsd on tsd.pno = ds.pno
        where
            ds.p_date = '2023-09-13'
        group by 1
    ) backlog on backlog.dst_store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
with t as
    (
        select
            pi.pno
            ,pi.client_id
            ,pi.finished_at
            ,pi.ticket_delivery_staff_lng
            ,pi.ticket_delivery_staff_lat
            ,pi.dst_store_id
        from ph_staging.parcel_info pi
        where
            pi.state = 5
            and pi.finished_at >= '2023-06-30 16:00:00'
            and pi.finished_at < '2023-08-31 16:00:00'
    )
select
    date(convert_tz(t1.finished_at, '+00:00', '+08:00')) 妥投日期
    ,t1.client_id 客户ID
    ,case
        when bc.client_id is not null then bc.client_name
        when bc.client_id is null and kp.id is not null then '普通KA'
        else '小c'
    end 客户类型
    ,case
        when st_distance_sphere(point(t1.ticket_delivery_staff_lng, t1.ticket_delivery_staff_lat), point(ss.lng, ss.lat)) <= 100 then '0-100'
        when st_distance_sphere(point(t1.ticket_delivery_staff_lng, t1.ticket_delivery_staff_lat), point(ss.lng, ss.lat)) > 100 and st_distance_sphere(point(t1.ticket_delivery_staff_lng, t1.ticket_delivery_staff_lat), point(ss.lng, ss.lat)) <= 200 then '100-200'
        when st_distance_sphere(point(t1.ticket_delivery_staff_lng, t1.ticket_delivery_staff_lat), point(ss.lng, ss.lat)) > 100 and st_distance_sphere(point(t1.ticket_delivery_staff_lng, t1.ticket_delivery_staff_lat), point(ss.lng, ss.lat)) <= 200 then '200-300'
        when st_distance_sphere(point(t1.ticket_delivery_staff_lng, t1.ticket_delivery_staff_lat), point(ss.lng, ss.lat)) > 100 and st_distance_sphere(point(t1.ticket_delivery_staff_lng, t1.ticket_delivery_staff_lat), point(ss.lng, ss.lat)) <= 200 then '300-400'
        when st_distance_sphere(point(t1.ticket_delivery_staff_lng, t1.ticket_delivery_staff_lat), point(ss.lng, ss.lat)) > 400 and st_distance_sphere(point(t1.ticket_delivery_staff_lng, t1.ticket_delivery_staff_lat), point(ss.lng, ss.lat)) <= 500 then '400-500'
        when st_distance_sphere(point(t1.ticket_delivery_staff_lng, t1.ticket_delivery_staff_lat), point(ss.lng, ss.lat)) > 500 then '500以上'
     end 妥投距离网点距离
    ,case
        when json_extract(ph.extra_value, '$.callDuration') >= 1 and json_extract(ph.extra_value, '$.callDuration') < 9 then '1-8'
        when json_extract(ph.extra_value, '$.callDuration') >= 9 and json_extract(ph.extra_value, '$.callDuration') < 11 then '9-10'
        when json_extract(ph.extra_value, '$.callDuration') >= 11 and json_extract(ph.extra_value, '$.callDuration') < 16 then '11-15'
        when json_extract(ph.extra_value, '$.callDuration') >= 16 and json_extract(ph.extra_value, '$.callDuration') < 21 then '16-20'
        when json_extract(ph.extra_value, '$.callDuration') >= 21 then '21以上'
        else '1以内'
    end 通话时长
    ,if(acc.pno is null, '否', '是') 是否有虚假投妥投诉
    ,count(distinct t1.pno) 包裹数
from t t1
left join
    (
        select
            pr.pno
            ,pr.extra_value
            ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno
        where
            pr.route_action = 'PHONE'
            and pr.routed_at < t1.finished_at
            and pr.routed_at > date_sub(curdate(), interval 90 day )
    ) ph on ph.pno = t1.pno and ph.rk = 1
left join ph_staging.sys_store ss on ss.id = t1.dst_store_id
left join ph_bi.abnormal_customer_complaint acc on acc.pno = t1.pno and acc.complaints_type = 1 -- 虚假妥投类
left join dwm.dwd_dim_bigClient bc on bc.client_id = t1.client_id
left join ph_staging.ka_profile kp on kp.id = t1.client_id
group by 1,2,3,4,5,6;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
    ,pi.cod_amount/100 cod金额
from ph_staging.parcel_info pi
where
    pi.pno in ('P14112464VVAK','P14162493WGAD','P141624YSXJAD','P1416254G67AI','PT1416235EX42AB','P1416272HV1AB','P14162695TQBI','P140125RKK5BC','P110725ES5MAG','P110724SN7NAQ','P6118265EERFL','PT6118233YBG8CC','P611825P91MDG','P611824DNRVEV','P612325JSZ9AG','P612325JANVAW','P612324J7F0AW','P612324J7CBAW','P612324HFB4AW','P61232468SFAG','P612025KGJRGI','P612025JN6ZGW','P612025HV4TGI','P612025HBUMGI','P612024SQK0GJ','P612024J9Q0GW','P612024BGUGGI','P612024A45HGO','P61202468BFGW','P6120269131CX','P6120264UM4CX','P612026914GDB','P612026H7W2CY','P6120269KC2GF','P612026FZKQDA','P6120265K02CZ','P61202698ZKGF','P612026WTBTFE','P61202738K5FT','PT6121236F475AO','PT6120236R4X1GC','P612026VEXJGG','PD612026RPACDB','P612026KKRPFB','P612026U2SSGD','P612026TQ47DC','P612026NBCUGD','P612026WCGKGA','P612026VE0GGH','P612026JGV5GE','P140124PC6QAR','PT14012314TQ4BF','P140125PC1SAD','P140125PGJ4AK','P140126H02FAP','PT1401235XMT4BD','P140625GQ95AN','P120825BE4CAF','P120826N5D9AL','PT6118233S250DS','PT6118233VMM7BQ','PT611822ZVQ69AV','P611824QF7MAV','PT611823190S0AV','PT1210230YE14BS','PT61182341NK1BO','P6118264HBZDA','PT61182342888DA','PT6118233SXW9DA','PT6118233AGR4BT','PT611823349H7BT','PT61182333217DA','PT61182332VA5CR','P611825SZ65BT','P611825BBC1BT','P6118269GXGBT','P611826912GBT','PT611823608X9DA','P611826A45WDA','P611824NNP1CP','P611826TD1PCP','P611826KG3WCP','P611826SY8YCP','P611826KG3CCP','P6118268A6WCP','P611826SPX7CP','P611826K27XDA','P6118269436CP','P611826RP8FCP','P611826MMJGCR','P611826A1WACP','P6118269K8MDQ','P611826SY9JCP','P611826SYE8CP','P611826VYH6CP','P6118268DWKCP','P6121250ZZGAS','P611726BV5SAO','P140126JFCYBF','PT1401234EVN5AO','P452124WJ24DQ','P140223QSF5AE','P140224BDMEAD','P141824H16HAJ','P15162710RDBM','P6101250RZBEY','P610624SPX8GE','P610124HM95IV','P610124ZM9KHG','P611825B15RAT','P61182594CQBY','P611825K2RJDD','P612326XK8JAT','PT61182334UZ2CX','PT6118232X8A0DR','P611825R7T9DR','P6118254R98EZ');
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        a.*
    from
        (
            select
                pr.pno
                ,pr.staff_info_id
                ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
            from ph_staging.parcel_route pr
            where
                pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                -- and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天
                and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN' -- 交接扫描
                and pr.routed_at < date_sub(curdate(), interval 15 hour) -- 昨天17点
            group by 1,2
        ) a
    where
        a.rk = 1
)
select
    t1.staff_info_id
    ,dp.store_name
    ,dp.piece_name
    ,dp.region_name
    ,count(distinct t1.pno) sacn_count
    ,count(distinct if(ph.pno is null , t1.pno, null)) nocall_count
    ,count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) nocall_rate
from t t1
left join
    (
        select
            pr.pno
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno
        where
            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
            and pr.routed_at < date_sub(curdate(), interval 15 hour)
            and pr.route_action = 'PHONE'
        group by 1
    ) ph on ph.pno = t1.pno
left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = t1.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
group by 1,2,3,4
having count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) >= 0.5;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        a.*
    from
        (
            select
                pr.pno
                ,pr.staff_info_id
                ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
            from ph_staging.parcel_route pr
            where
                pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                -- and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天
                and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN' -- 交接扫描
                and pr.routed_at < date_sub(curdate(), interval 15 hour) -- 昨天17点
        ) a
    where
        a.rk = 1
)
select
    t1.staff_info_id
    ,dp.store_name
    ,dp.piece_name
    ,dp.region_name
    ,count(distinct t1.pno) sacn_count
    ,count(distinct if(ph.pno is null , t1.pno, null)) nocall_count
    ,count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) nocall_rate
from t t1
left join
    (
        select
            pr.pno
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno
        where
            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
            and pr.routed_at < date_sub(curdate(), interval 15 hour)
            and pr.route_action = 'PHONE'
        group by 1
    ) ph on ph.pno = t1.pno
left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = t1.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
group by 1,2,3,4
having count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) >= 0.5;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        a.*
    from
        (
            select
                pr.pno
                ,pr.staff_info_id
                ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
            from ph_staging.parcel_route pr
            where
                pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                -- and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天
                and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN' -- 交接扫描
                and pr.routed_at < date_sub(curdate(), interval 15 hour) -- 昨天17点
        ) a
    where
        a.rk = 1
)
select
    t1.staff_info_id
    ,dp.store_name
    ,dp.piece_name
    ,dp.region_name
    ,count(distinct t1.pno) sacn_count
    ,count(distinct if(ph.pno is null , t1.pno, null)) nocall_count
    ,count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) nocall_rate
from t t1
left join
    (
        select
            pr.pno
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno
        where
            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
            and pr.routed_at < date_sub(curdate(), interval 15 hour)
            and pr.route_action = 'PHONE'
        group by 1
    ) ph on ph.pno = t1.pno
left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = t1.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
where
    hsi.state = 1
group by 1,2,3,4
having count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) >= 0.5;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        a.*
    from
        (
            select
                pr.pno
                ,pr.staff_info_id
                ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
            from ph_staging.parcel_route pr
            where
                pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                -- and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天
                and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN' -- 交接扫描
                and pr.routed_at < date_sub(curdate(), interval 15 hour) -- 昨天17点
        ) a
    where
        a.rk = 1
)
select
    t1.staff_info_id
    ,dp.store_name
    ,dp.piece_name
    ,dp.region_name
    ,count(distinct t1.pno) sacn_count
    ,count(distinct if(ph.pno is null , t1.pno, null)) nocall_count
    ,count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) nocall_rate
from t t1
left join
    (
        select
            pr.pno
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno
        where
            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
            and pr.routed_at < date_sub(curdate(), interval 15 hour)
            and pr.route_action = 'PHONE'
        group by 1
    ) ph on ph.pno = t1.pno
left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = t1.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
where
    hsi.state = 1
group by 1,2,3,4
having count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) >= 0.6;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        a.*
    from
        (
            select
                pr.pno
                ,pr.staff_info_id
                ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
            from ph_staging.parcel_route pr
            where
                pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                -- and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天
                and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN' -- 交接扫描
                and pr.routed_at < date_sub(curdate(), interval 15 hour) -- 昨天17点
        ) a
    where
        a.rk = 1
)
select
    t1.staff_info_id
    ,dp.store_name
    ,dp.piece_name
    ,dp.region_name
    ,count(distinct t1.pno) sacn_count
    ,count(distinct if(ph.pno is null , t1.pno, null)) nocall_count
    ,count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) nocall_rate
from t t1
left join
    (
        select
            pr.pno
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno
        where
            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
            and pr.routed_at < date_sub(curdate(), interval 15 hour)
            and pr.route_action = 'PHONE'
        group by 1
    ) ph on ph.pno = t1.pno
left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = t1.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
where
    hsi.state = 1
group by 1,2,3,4
having count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) >= 0.7;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        a.*
    from
        (
            select
                pr.pno
                ,pr.staff_info_id
                ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
            from ph_staging.parcel_route pr
            where
                pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                -- and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天
                and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN' -- 交接扫描
                and pr.routed_at < date_sub(curdate(), interval 15 hour) -- 昨天17点
        ) a
    where
        a.rk = 1
)
select
    t1.staff_info_id
    ,dp.store_name
    ,dp.piece_name
    ,dp.region_name
    ,count(distinct t1.pno) sacn_count
    ,count(distinct if(ph.pno is null , t1.pno, null)) nocall_count
    ,count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) nocall_rate
from t t1
left join
    (
        select
            pr.pno
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno
        where
            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
            and pr.routed_at < date_sub(curdate(), interval 15 hour)
            and pr.route_action = 'PHONE'
        group by 1
    ) ph on ph.pno = t1.pno
left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = t1.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
where
    hsi.state = 1
group by 1,2,3,4
having count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) >= 0.8;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        a.*
    from
        (
            select
                pr.pno
                ,pr.staff_info_id
                ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
            from ph_staging.parcel_route pr
            where
                pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                -- and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天
                and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN' -- 交接扫描
                and pr.routed_at < date_sub(curdate(), interval 15 hour) -- 昨天17点
        ) a
    where
        a.rk = 1
)
select
    t1.staff_info_id
    ,dp.store_name
    ,dp.piece_name
    ,dp.region_name
    ,pick.pno_count  pick_count
    ,del.pno_count del_count
    ,count(distinct t1.pno) sacn_count
    ,count(distinct if(ph.pno is null , t1.pno, null)) nocall_count
    ,count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) nocall_rate
from t t1
left join
    (
        select
            pr.pno
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno
        where
            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
            and pr.routed_at < date_sub(curdate(), interval 15 hour)
            and pr.route_action = 'PHONE'
        group by 1
    ) ph on ph.pno = t1.pno
left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = t1.staff_info_id
left join
    (
        select
            t2.staff_info_id
            ,count(pi.pno) pno_count
        from ph_staging.parcel_info pi
        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pi.ticket_pickup_staff_info_id
        where
            pi.created_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
            and pi.created_at < date_sub(curdate(), interval 8 hour) -- 昨天揽收
        group by 1
    ) pick on pick.staff_info_id = t1.staff_info_id
left join
    (
        select
            t2.staff_info_id
            ,count(distinct pr.pno) pno_count
        from ph_staging.parcel_route pr
        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pr.staff_info_id
        where
            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
            and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天签收
            and pr.route_action = 'DELIVERY_CONFIRM'
        group by 1
    ) del on del.staff_info_id = t1.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
where
    hsi.state = 1
group by 1,2,3,4,5,6;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        a.*
    from
        (
            select
                pr.pno
                ,pr.staff_info_id
                ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
            from ph_staging.parcel_route pr
            where
                pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                -- and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天
                and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN' -- 交接扫描
                and pr.routed_at < date_sub(curdate(), interval 15 hour) -- 昨天17点
        ) a
    where
        a.rk = 1
)
select
    t1.staff_info_id
    ,dp.store_name
    ,dp.piece_name
    ,dp.region_name
    ,pick.pno_count  pick_count
    ,del.pno_count del_count
    ,count(distinct t1.pno) sacn_count
    ,count(distinct if(ph.pno is null , t1.pno, null)) nocall_count
    ,count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) nocall_rate
from t t1
left join
    (
        select
            pr.pno
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno
        where
            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
            and pr.routed_at < date_sub(curdate(), interval 15 hour)
            and pr.route_action = 'PHONE'
        group by 1
    ) ph on ph.pno = t1.pno
left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = t1.staff_info_id
left join
    (
        select
            t2.staff_info_id
            ,count(pi.pno) pno_count
        from ph_staging.parcel_info pi
        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pi.ticket_pickup_staff_info_id
        where
            pi.created_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
            and pi.created_at < date_sub(curdate(), interval 8 hour) -- 昨天揽收
        group by 1
    ) pick on pick.staff_info_id = t1.staff_info_id
left join
    (
        select
            t2.staff_info_id
            ,count(distinct pr.pno) pno_count
        from ph_staging.parcel_route pr
        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pr.staff_info_id
        where
            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
            and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天签收
            and pr.route_action = 'DELIVERY_CONFIRM'
        group by 1
    ) del on del.staff_info_id = t1.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
where
    hsi.state = 1
    and hsi.formal = 1
group by 1,2,3,4,5,6;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        a.*
    from
        (
            select
                pr.pno
                ,pr.staff_info_id
                ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
            from ph_staging.parcel_route pr
            where
                pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                -- and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天
                and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN' -- 交接扫描
                and pr.routed_at < date_sub(curdate(), interval 15 hour) -- 昨天17点
        ) a
    where
        a.rk = 1
)
select
    t1.staff_info_id
    ,dp.store_name 归属网点
    ,dp.piece_name 归属片区
    ,dp.region_name 归属大区
    ,pick.pno_count  揽收量
    ,del.pno_count 妥投量
    ,del.forward_pno_count 正向包裹妥投量
    ,count(distinct t1.pno) 交接扫描量
    ,count(distinct if(ph.pno is null , t1.pno, null)) 17点前未打电话包裹量
    ,count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) 17点前未打电话占比
from t t1
left join
    (
        select
            pr.pno
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno
        where
            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
            and pr.routed_at < date_sub(curdate(), interval 15 hour)
            and pr.route_action = 'PHONE'
        group by 1
    ) ph on ph.pno = t1.pno
left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = t1.staff_info_id
left join
    (
        select
            t2.staff_info_id
            ,count(pi.pno) pno_count
        from ph_staging.parcel_info pi
        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pi.ticket_pickup_staff_info_id
        where
            pi.created_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
            and pi.created_at < date_sub(curdate(), interval 8 hour) -- 昨天揽收
        group by 1
    ) pick on pick.staff_info_id = t1.staff_info_id
left join
    (
        select
            t2.staff_info_id
            ,count(distinct pr.pno) pno_count
            ,count(distinct if(pi.returned = 0, pr.pno, null)) forward_pno_count
        from ph_staging.parcel_route pr
        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pr.staff_info_id
        left join ph_staging.parcel_info pi on pi.pno = pr.pno
        where
            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
            and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天签收
            and pr.route_action = 'DELIVERY_CONFIRM'
        group by 1
    ) del on del.staff_info_id = t1.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
where
    hsi.state = 1
    and hsi.formal = 1
group by 1,2,3,4,5,6,7;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        a.*
    from
        (
            select
                pr.pno
                ,pr.staff_info_id
                ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
            from ph_staging.parcel_route pr
            where
                pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                -- and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天
                and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN' -- 交接扫描
                and pr.routed_at < date_sub(curdate(), interval 15 hour) -- 昨天17点
        ) a
    where
        a.rk = 1
)
select
    *
from
    (
        select
            a.*
            ,row_number() over (partition by a.归属网点 order by a.17点前未打电话占比 desc ) rk
        from
            (
                select
                    t1.staff_info_id
                    ,dp.store_name 归属网点
                    ,dp.piece_name 归属片区
                    ,dp.region_name 归属大区
                    ,pick.pno_count  揽收量
                    ,del.pno_count 妥投量
                    ,del.forward_pno_count 正向包裹妥投量
                    ,count(distinct t1.pno) 交接扫描量
                    ,count(distinct if(ph.pno is null , t1.pno, null)) 17点前未打电话包裹量
                    ,count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) 17点前未打电话占比
                from t t1
                left join
                    (
                        select
                            pr.pno
                        from ph_staging.parcel_route pr
                        join t t1 on t1.pno = pr.pno
                        where
                            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pr.routed_at < date_sub(curdate(), interval 15 hour)
                            and pr.route_action = 'PHONE'
                        group by 1
                    ) ph on ph.pno = t1.pno
                left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = t1.staff_info_id
                left join
                    (
                        select
                            t2.staff_info_id
                            ,count(pi.pno) pno_count
                        from ph_staging.parcel_info pi
                        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pi.ticket_pickup_staff_info_id
                        where
                            pi.created_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pi.created_at < date_sub(curdate(), interval 8 hour) -- 昨天揽收
                        group by 1
                    ) pick on pick.staff_info_id = t1.staff_info_id
                left join
                    (
                        select
                            t2.staff_info_id
                            ,count(distinct pr.pno) pno_count
                            ,count(distinct if(pi.returned = 0, pr.pno, null)) forward_pno_count
                        from ph_staging.parcel_route pr
                        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pr.staff_info_id
                        left join ph_staging.parcel_info pi on pi.pno = pr.pno
                        where
                            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天签收
                            and pr.route_action = 'DELIVERY_CONFIRM'
                        group by 1
                    ) del on del.staff_info_id = t1.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
                where
                    hsi.state = 1
                    and hsi.formal = 1
                group by 1,2,3,4,5,6,7
                having count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) >= 0.5
            ) a
    ) a1
where
    a1.rk <= 3;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        a.*
    from
        (
            select
                pr.pno
                ,pr.staff_info_id
                ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
            from ph_staging.parcel_route pr
            where
                pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                -- and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天
                and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN' -- 交接扫描
                and pr.routed_at < date_sub(curdate(), interval 15 hour) -- 昨天17点
        ) a
    where
        a.rk = 1
)
select
    a1.归属大区
    ,count(if(a1.rk <= 3, a1.staff_info_id, null)) top3
    ,count(if(a1.rk <= 2, a1.staff_info_id, null)) top2
    ,count(if(a1.rk <= 1, a1.staff_info_id, null)) top1
from
    (
        select
            a.*
            ,row_number() over (partition by a.归属网点 order by a.17点前未打电话占比 desc ) rk
        from
            (
                select
                    t1.staff_info_id
                    ,dp.store_name 归属网点
                    ,dp.piece_name 归属片区
                    ,dp.region_name 归属大区
                    ,pick.pno_count  揽收量
                    ,del.pno_count 妥投量
                    ,del.forward_pno_count 正向包裹妥投量
                    ,count(distinct t1.pno) 交接扫描量
                    ,count(distinct if(ph.pno is null , t1.pno, null)) 17点前未打电话包裹量
                    ,count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) 17点前未打电话占比
                from t t1
                left join
                    (
                        select
                            pr.pno
                        from ph_staging.parcel_route pr
                        join t t1 on t1.pno = pr.pno
                        where
                            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pr.routed_at < date_sub(curdate(), interval 15 hour)
                            and pr.route_action = 'PHONE'
                        group by 1
                    ) ph on ph.pno = t1.pno
                left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = t1.staff_info_id
                left join
                    (
                        select
                            t2.staff_info_id
                            ,count(pi.pno) pno_count
                        from ph_staging.parcel_info pi
                        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pi.ticket_pickup_staff_info_id
                        where
                            pi.created_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pi.created_at < date_sub(curdate(), interval 8 hour) -- 昨天揽收
                        group by 1
                    ) pick on pick.staff_info_id = t1.staff_info_id
                left join
                    (
                        select
                            t2.staff_info_id
                            ,count(distinct pr.pno) pno_count
                            ,count(distinct if(pi.returned = 0, pr.pno, null)) forward_pno_count
                        from ph_staging.parcel_route pr
                        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pr.staff_info_id
                        left join ph_staging.parcel_info pi on pi.pno = pr.pno
                        where
                            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天签收
                            and pr.route_action = 'DELIVERY_CONFIRM'
                        group by 1
                    ) del on del.staff_info_id = t1.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
                where
                    hsi.state = 1
                    and hsi.formal = 1
                group by 1,2,3,4,5,6,7
                having count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) >= 0.5
            ) a
    ) a1
group by 1
with rollup;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        a.*
    from
        (
            select
                pr.pno
                ,pr.staff_info_id
                ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
            from ph_staging.parcel_route pr
            where
                pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                -- and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天
                and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN' -- 交接扫描
                and pr.routed_at < date_sub(curdate(), interval 15 hour) -- 昨天17点
        ) a
    where
        a.rk = 1
)
select
    a1.归属大区
    ,count(if(a1.rk <= 3, a1.staff_info_id, null)) top3
    ,count(if(a1.rk <= 2, a1.staff_info_id, null)) top2
    ,count(if(a1.rk <= 1, a1.staff_info_id, null)) top1
from
    (
        select
            a.*
            ,row_number() over (partition by a.归属网点 order by a.17点前未打电话占比 desc ) rk
        from
            (
                select
                    t1.staff_info_id
                    ,dp.store_name 归属网点
                    ,dp.piece_name 归属片区
                    ,dp.region_name 归属大区
                    ,pick.pno_count  揽收量
                    ,del.pno_count 妥投量
                    ,del.forward_pno_count 正向包裹妥投量
                    ,count(distinct t1.pno) 交接扫描量
                    ,count(distinct if(ph.pno is null , t1.pno, null)) 17点前未打电话包裹量
                    ,count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) 17点前未打电话占比
                from t t1
                left join
                    (
                        select
                            pr.pno
                        from ph_staging.parcel_route pr
                        join t t1 on t1.pno = pr.pno
                        where
                            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pr.routed_at < date_sub(curdate(), interval 15 hour)
                            and pr.route_action = 'PHONE'
                        group by 1
                    ) ph on ph.pno = t1.pno
                left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = t1.staff_info_id
                left join
                    (
                        select
                            t2.staff_info_id
                            ,count(pi.pno) pno_count
                        from ph_staging.parcel_info pi
                        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pi.ticket_pickup_staff_info_id
                        where
                            pi.created_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pi.created_at < date_sub(curdate(), interval 8 hour) -- 昨天揽收
                        group by 1
                    ) pick on pick.staff_info_id = t1.staff_info_id
                left join
                    (
                        select
                            t2.staff_info_id
                            ,count(distinct pr.pno) pno_count
                            ,count(distinct if(pi.returned = 0, pr.pno, null)) forward_pno_count
                        from ph_staging.parcel_route pr
                        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pr.staff_info_id
                        left join ph_staging.parcel_info pi on pi.pno = pr.pno
                        where
                            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天签收
                            and pr.route_action = 'DELIVERY_CONFIRM'
                        group by 1
                    ) del on del.staff_info_id = t1.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
                where
                    hsi.state = 1
                    and hsi.formal = 1
                group by 1,2,3,4,5,6,7
                having count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) >= 0.6
            ) a
    ) a1
group by 1
with rollup;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        a.*
    from
        (
            select
                pr.pno
                ,pr.staff_info_id
                ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
            from ph_staging.parcel_route pr
            where
                pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                -- and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天
                and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN' -- 交接扫描
                and pr.routed_at < date_sub(curdate(), interval 15 hour) -- 昨天17点
        ) a
    where
        a.rk = 1
)
select
    a1.归属大区
    ,count(if(a1.rk <= 3, a1.staff_info_id, null)) top3
    ,count(if(a1.rk <= 2, a1.staff_info_id, null)) top2
    ,count(if(a1.rk <= 1, a1.staff_info_id, null)) top1
from
    (
        select
            a.*
            ,row_number() over (partition by a.归属网点 order by a.17点前未打电话占比 desc ) rk
        from
            (
                select
                    t1.staff_info_id
                    ,dp.store_name 归属网点
                    ,dp.piece_name 归属片区
                    ,dp.region_name 归属大区
                    ,pick.pno_count  揽收量
                    ,del.pno_count 妥投量
                    ,del.forward_pno_count 正向包裹妥投量
                    ,count(distinct t1.pno) 交接扫描量
                    ,count(distinct if(ph.pno is null , t1.pno, null)) 17点前未打电话包裹量
                    ,count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) 17点前未打电话占比
                from t t1
                left join
                    (
                        select
                            pr.pno
                        from ph_staging.parcel_route pr
                        join t t1 on t1.pno = pr.pno
                        where
                            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pr.routed_at < date_sub(curdate(), interval 15 hour)
                            and pr.route_action = 'PHONE'
                        group by 1
                    ) ph on ph.pno = t1.pno
                left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = t1.staff_info_id
                left join
                    (
                        select
                            t2.staff_info_id
                            ,count(pi.pno) pno_count
                        from ph_staging.parcel_info pi
                        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pi.ticket_pickup_staff_info_id
                        where
                            pi.created_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pi.created_at < date_sub(curdate(), interval 8 hour) -- 昨天揽收
                        group by 1
                    ) pick on pick.staff_info_id = t1.staff_info_id
                left join
                    (
                        select
                            t2.staff_info_id
                            ,count(distinct pr.pno) pno_count
                            ,count(distinct if(pi.returned = 0, pr.pno, null)) forward_pno_count
                        from ph_staging.parcel_route pr
                        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pr.staff_info_id
                        left join ph_staging.parcel_info pi on pi.pno = pr.pno
                        where
                            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天签收
                            and pr.route_action = 'DELIVERY_CONFIRM'
                        group by 1
                    ) del on del.staff_info_id = t1.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
                where
                    hsi.state = 1
                    and hsi.formal = 1
                group by 1,2,3,4,5,6,7
                having count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) >= 0.7
            ) a
    ) a1
group by 1
with rollup;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        a.*
    from
        (
            select
                pr.pno
                ,pr.staff_info_id
                ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
            from ph_staging.parcel_route pr
            where
                pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                -- and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天
                and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN' -- 交接扫描
                and pr.routed_at < date_sub(curdate(), interval 15 hour) -- 昨天17点
        ) a
    where
        a.rk = 1
)
select
    a1.归属大区
    ,count(if(a1.rk <= 3, a1.staff_info_id, null)) top3
    ,count(if(a1.rk <= 2, a1.staff_info_id, null)) top2
    ,count(if(a1.rk <= 1, a1.staff_info_id, null)) top1
from
    (
        select
            a.*
            ,row_number() over (partition by a.归属网点 order by a.17点前未打电话占比 desc ) rk
        from
            (
                select
                    t1.staff_info_id
                    ,dp.store_name 归属网点
                    ,dp.piece_name 归属片区
                    ,dp.region_name 归属大区
                    ,pick.pno_count  揽收量
                    ,del.pno_count 妥投量
                    ,del.forward_pno_count 正向包裹妥投量
                    ,count(distinct t1.pno) 交接扫描量
                    ,count(distinct if(ph.pno is null , t1.pno, null)) 17点前未打电话包裹量
                    ,count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) 17点前未打电话占比
                from t t1
                left join
                    (
                        select
                            pr.pno
                        from ph_staging.parcel_route pr
                        join t t1 on t1.pno = pr.pno
                        where
                            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pr.routed_at < date_sub(curdate(), interval 15 hour)
                            and pr.route_action = 'PHONE'
                        group by 1
                    ) ph on ph.pno = t1.pno
                left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = t1.staff_info_id
                left join
                    (
                        select
                            t2.staff_info_id
                            ,count(pi.pno) pno_count
                        from ph_staging.parcel_info pi
                        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pi.ticket_pickup_staff_info_id
                        where
                            pi.created_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pi.created_at < date_sub(curdate(), interval 8 hour) -- 昨天揽收
                        group by 1
                    ) pick on pick.staff_info_id = t1.staff_info_id
                left join
                    (
                        select
                            t2.staff_info_id
                            ,count(distinct pr.pno) pno_count
                            ,count(distinct if(pi.returned = 0, pr.pno, null)) forward_pno_count
                        from ph_staging.parcel_route pr
                        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pr.staff_info_id
                        left join ph_staging.parcel_info pi on pi.pno = pr.pno
                        where
                            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天签收
                            and pr.route_action = 'DELIVERY_CONFIRM'
                        group by 1
                    ) del on del.staff_info_id = t1.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
                where
                    hsi.state = 1
                    and hsi.formal = 1
                group by 1,2,3,4,5,6,7
                having count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) >= 0.8
            ) a
    ) a1
group by 1
with rollup;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        a.*
    from
        (
            select
                pr.pno
                ,pr.staff_info_id
                ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
            from ph_staging.parcel_route pr
            where
                pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                -- and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天
                and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN' -- 交接扫描
                and pr.routed_at < date_sub(curdate(), interval 15 hour) -- 昨天17点
        ) a
    where
        a.rk = 1
)
select
#     a1.归属大区
#     ,count(if(a1.rk <= 3, a1.staff_info_id, null)) top3
#     ,count(if(a1.rk <= 2, a1.staff_info_id, null)) top2
#     ,count(if(a1.rk <= 1, a1.staff_info_id, null)) top1
    *
from
    (
        select
            a.*
            ,row_number() over (partition by a.归属网点 order by a.17点前未打电话占比 desc ) rk
        from
            (
                select
                    t1.staff_info_id
                    ,dp.store_name 归属网点
                    ,dp.piece_name 归属片区
                    ,dp.region_name 归属大区
                    ,pick.pno_count  揽收量
                    ,del.pno_count 妥投量
                    ,del.forward_pno_count 正向包裹妥投量
                    ,count(distinct t1.pno) 交接扫描量
                    ,count(distinct if(ph.pno is null , t1.pno, null)) 17点前未打电话包裹量
                    ,count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) 17点前未打电话占比
                from t t1
                left join
                    (
                        select
                            pr.pno
                        from ph_staging.parcel_route pr
                        join t t1 on t1.pno = pr.pno
                        where
                            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pr.routed_at < date_sub(curdate(), interval 15 hour)
                            and pr.route_action = 'PHONE'
                        group by 1
                    ) ph on ph.pno = t1.pno
                left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = t1.staff_info_id
                left join
                    (
                        select
                            t2.staff_info_id
                            ,count(pi.pno) pno_count
                        from ph_staging.parcel_info pi
                        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pi.ticket_pickup_staff_info_id
                        where
                            pi.created_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pi.created_at < date_sub(curdate(), interval 8 hour) -- 昨天揽收
                        group by 1
                    ) pick on pick.staff_info_id = t1.staff_info_id
                left join
                    (
                        select
                            t2.staff_info_id
                            ,count(distinct pr.pno) pno_count
                            ,count(distinct if(pi.returned = 0, pr.pno, null)) forward_pno_count
                        from ph_staging.parcel_route pr
                        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pr.staff_info_id
                        left join ph_staging.parcel_info pi on pi.pno = pr.pno
                        where
                            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天签收
                            and pr.route_action = 'DELIVERY_CONFIRM'
                        group by 1
                    ) del on del.staff_info_id = t1.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
                where
                    hsi.state = 1
                    and hsi.formal = 1
                group by 1,2,3,4,5,6,7
                having count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) >= 0.8
            ) a
    ) a1
where
    a1.rk =  1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        a.*
    from
        (
            select
                pr.pno
                ,pr.staff_info_id
                ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
            from ph_staging.parcel_route pr
            where
                pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                -- and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天
                and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN' -- 交接扫描
                and pr.routed_at < date_sub(curdate(), interval 15 hour) -- 昨天17点
        ) a
    where
        a.rk = 1
)
select
    a1.归属大区
    ,count(if(a1.rk <= 3, a1.staff_info_id, null)) top3
    ,count(if(a1.rk <= 2, a1.staff_info_id, null)) top2
    ,count(if(a1.rk <= 1, a1.staff_info_id, null)) top1

from
    (
        select
            a.*
            ,row_number() over (partition by a.归属网点 order by a.17点前未打电话占比 desc ) rk
        from
            (
                select
                    t1.staff_info_id
                    ,dp.store_name 归属网点
                    ,dp.piece_name 归属片区
                    ,dp.region_name 归属大区
                    ,pick.pno_count  揽收量
                    ,del.pno_count 妥投量
                    ,del.forward_pno_count 正向包裹妥投量
                    ,count(distinct t1.pno) 交接扫描量
                    ,count(distinct if(ph.pno is null , t1.pno, null)) 17点前未打电话包裹量
                    ,count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) 17点前未打电话占比
                from t t1
                left join
                    (
                        select
                            pr.pno
                        from ph_staging.parcel_route pr
                        join t t1 on t1.pno = pr.pno
                        where
                            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pr.routed_at < date_sub(curdate(), interval 15 hour)
                            and pr.route_action = 'PHONE'
                        group by 1
                    ) ph on ph.pno = t1.pno
                left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = t1.staff_info_id
                left join
                    (
                        select
                            t2.staff_info_id
                            ,count(pi.pno) pno_count
                        from ph_staging.parcel_info pi
                        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pi.ticket_pickup_staff_info_id
                        where
                            pi.created_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pi.created_at < date_sub(curdate(), interval 8 hour) -- 昨天揽收
                        group by 1
                    ) pick on pick.staff_info_id = t1.staff_info_id
                left join
                    (
                        select
                            t2.staff_info_id
                            ,count(distinct pr.pno) pno_count
                            ,count(distinct if(pi.returned = 0, pr.pno, null)) forward_pno_count
                        from ph_staging.parcel_route pr
                        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pr.staff_info_id
                        left join ph_staging.parcel_info pi on pi.pno = pr.pno
                        where
                            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天签收
                            and pr.route_action = 'DELIVERY_CONFIRM'
                        group by 1
                    ) del on del.staff_info_id = t1.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
                where
                    hsi.state = 1
                    and hsi.formal = 1
                    and dp.store_category = 1
                    and coalesce(pick.pno_count, 0) + coalesce(del.pno_count) < 50
                group by 1,2,3,4,5,6,7
                having count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) >= 0.8
            ) a
    ) a1
where
    a1.rk =  1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        a.*
    from
        (
            select
                pr.pno
                ,pr.staff_info_id
                ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
            from ph_staging.parcel_route pr
            where
                pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                -- and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天
                and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN' -- 交接扫描
                and pr.routed_at < date_sub(curdate(), interval 15 hour) -- 昨天17点
        ) a
    where
        a.rk = 1
)
select
    a1.归属大区
    ,count(if(a1.rk <= 3, a1.staff_info_id, null)) top3
    ,count(if(a1.rk <= 2, a1.staff_info_id, null)) top2
    ,count(if(a1.rk <= 1, a1.staff_info_id, null)) top1

from
    (
        select
            a.*
            ,row_number() over (partition by a.归属网点 order by a.17点前未打电话占比 desc ) rk
        from
            (
                select
                    t1.staff_info_id
                    ,dp.store_name 归属网点
                    ,dp.piece_name 归属片区
                    ,dp.region_name 归属大区
                    ,pick.pno_count  揽收量
                    ,del.pno_count 妥投量
                    ,del.forward_pno_count 正向包裹妥投量
                    ,count(distinct t1.pno) 交接扫描量
                    ,count(distinct if(ph.pno is null , t1.pno, null)) 17点前未打电话包裹量
                    ,count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) 17点前未打电话占比
                from t t1
                left join
                    (
                        select
                            pr.pno
                        from ph_staging.parcel_route pr
                        join t t1 on t1.pno = pr.pno
                        where
                            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pr.routed_at < date_sub(curdate(), interval 15 hour)
                            and pr.route_action = 'PHONE'
                        group by 1
                    ) ph on ph.pno = t1.pno
                left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = t1.staff_info_id
                left join
                    (
                        select
                            t2.staff_info_id
                            ,count(pi.pno) pno_count
                        from ph_staging.parcel_info pi
                        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pi.ticket_pickup_staff_info_id
                        where
                            pi.created_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pi.created_at < date_sub(curdate(), interval 8 hour) -- 昨天揽收
                        group by 1
                    ) pick on pick.staff_info_id = t1.staff_info_id
                left join
                    (
                        select
                            t2.staff_info_id
                            ,count(distinct pr.pno) pno_count
                            ,count(distinct if(pi.returned = 0, pr.pno, null)) forward_pno_count
                        from ph_staging.parcel_route pr
                        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pr.staff_info_id
                        left join ph_staging.parcel_info pi on pi.pno = pr.pno
                        where
                            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天签收
                            and pr.route_action = 'DELIVERY_CONFIRM'
                        group by 1
                    ) del on del.staff_info_id = t1.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
                where
                    hsi.state = 1
                    and hsi.formal = 1
                    and dp.store_category = 1
                    and coalesce(pick.pno_count, 0) + coalesce(del.pno_count) < 50
                group by 1,2,3,4,5,6,7
                having count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) >= 0.8
            ) a
    ) a1
where
    a1.rk =  1
group by 1
with rollup;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        a.*
    from
        (
            select
                pr.pno
                ,pr.staff_info_id
                ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
            from ph_staging.parcel_route pr
            where
                pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                -- and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天
                and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN' -- 交接扫描
                and pr.routed_at < date_sub(curdate(), interval 15 hour) -- 昨天17点
        ) a
    where
        a.rk = 1
)
select
    a1.归属大区
    ,count(if(a1.rk <= 3, a1.staff_info_id, null)) top3
    ,count(if(a1.rk <= 2, a1.staff_info_id, null)) top2
    ,count(if(a1.rk <= 1, a1.staff_info_id, null)) top1

from
    (
        select
            a.*
            ,row_number() over (partition by a.归属网点 order by a.17点前未打电话占比 desc ) rk
        from
            (
                select
                    t1.staff_info_id
                    ,dp.store_name 归属网点
                    ,dp.piece_name 归属片区
                    ,dp.region_name 归属大区
                    ,pick.pno_count  揽收量
                    ,del.pno_count 妥投量
                    ,del.forward_pno_count 正向包裹妥投量
                    ,count(distinct t1.pno) 交接扫描量
                    ,count(distinct if(ph.pno is null , t1.pno, null)) 17点前未打电话包裹量
                    ,count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) 17点前未打电话占比
                from t t1
                left join
                    (
                        select
                            pr.pno
                        from ph_staging.parcel_route pr
                        join t t1 on t1.pno = pr.pno
                        where
                            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pr.routed_at < date_sub(curdate(), interval 15 hour)
                            and pr.route_action = 'PHONE'
                        group by 1
                    ) ph on ph.pno = t1.pno
                left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = t1.staff_info_id
                left join
                    (
                        select
                            t2.staff_info_id
                            ,count(pi.pno) pno_count
                        from ph_staging.parcel_info pi
                        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pi.ticket_pickup_staff_info_id
                        where
                            pi.created_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pi.created_at < date_sub(curdate(), interval 8 hour) -- 昨天揽收
                        group by 1
                    ) pick on pick.staff_info_id = t1.staff_info_id
                left join
                    (
                        select
                            t2.staff_info_id
                            ,count(distinct pr.pno) pno_count
                            ,count(distinct if(pi.returned = 0, pr.pno, null)) forward_pno_count
                        from ph_staging.parcel_route pr
                        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pr.staff_info_id
                        left join ph_staging.parcel_info pi on pi.pno = pr.pno
                        where
                            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天签收
                            and pr.route_action = 'DELIVERY_CONFIRM'
                        group by 1
                    ) del on del.staff_info_id = t1.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
                where
                    hsi.state = 1
                    and hsi.formal = 1
                    and dp.store_category = 1
                    and coalesce(pick.pno_count, 0) + coalesce(del.pno_count) < 50
                group by 1,2,3,4,5,6,7
                having count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) >= 0.7
            ) a
    ) a1
where
    a1.rk =  1
group by 1
with rollup;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        a.*
    from
        (
            select
                pr.pno
                ,pr.staff_info_id
                ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
            from ph_staging.parcel_route pr
            where
                pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                -- and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天
                and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN' -- 交接扫描
                and pr.routed_at < date_sub(curdate(), interval 15 hour) -- 昨天17点
        ) a
    where
        a.rk = 1
)
select
    a1.归属大区
    ,count(if(a1.rk <= 3, a1.staff_info_id, null)) top3
    ,count(if(a1.rk <= 2, a1.staff_info_id, null)) top2
    ,count(if(a1.rk <= 1, a1.staff_info_id, null)) top1

from
    (
        select
            a.*
            ,row_number() over (partition by a.归属网点 order by a.17点前未打电话占比 desc ) rk
        from
            (
                select
                    t1.staff_info_id
                    ,dp.store_name 归属网点
                    ,dp.piece_name 归属片区
                    ,dp.region_name 归属大区
                    ,pick.pno_count  揽收量
                    ,del.pno_count 妥投量
                    ,del.forward_pno_count 正向包裹妥投量
                    ,count(distinct t1.pno) 交接扫描量
                    ,count(distinct if(ph.pno is null , t1.pno, null)) 17点前未打电话包裹量
                    ,count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) 17点前未打电话占比
                from t t1
                left join
                    (
                        select
                            pr.pno
                        from ph_staging.parcel_route pr
                        join t t1 on t1.pno = pr.pno
                        where
                            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pr.routed_at < date_sub(curdate(), interval 15 hour)
                            and pr.route_action = 'PHONE'
                        group by 1
                    ) ph on ph.pno = t1.pno
                left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = t1.staff_info_id
                left join
                    (
                        select
                            t2.staff_info_id
                            ,count(pi.pno) pno_count
                        from ph_staging.parcel_info pi
                        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pi.ticket_pickup_staff_info_id
                        where
                            pi.created_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pi.created_at < date_sub(curdate(), interval 8 hour) -- 昨天揽收
                        group by 1
                    ) pick on pick.staff_info_id = t1.staff_info_id
                left join
                    (
                        select
                            t2.staff_info_id
                            ,count(distinct pr.pno) pno_count
                            ,count(distinct if(pi.returned = 0, pr.pno, null)) forward_pno_count
                        from ph_staging.parcel_route pr
                        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pr.staff_info_id
                        left join ph_staging.parcel_info pi on pi.pno = pr.pno
                        where
                            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天签收
                            and pr.route_action = 'DELIVERY_CONFIRM'
                        group by 1
                    ) del on del.staff_info_id = t1.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
                where
                    hsi.state = 1
                    and hsi.formal = 1
                    and dp.store_category = 1
                    and coalesce(pick.pno_count, 0) + coalesce(del.pno_count) < 50
                group by 1,2,3,4,5,6,7
                having count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) >= 0.6
            ) a
    ) a1
where
    a1.rk =  1
group by 1
with rollup;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        a.*
    from
        (
            select
                pr.pno
                ,pr.staff_info_id
                ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
            from ph_staging.parcel_route pr
            where
                pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                -- and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天
                and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN' -- 交接扫描
                and pr.routed_at < date_sub(curdate(), interval 15 hour) -- 昨天17点
        ) a
    where
        a.rk = 1
)
select
    a1.归属大区
    ,count(if(a1.rk <= 3, a1.staff_info_id, null)) top3
    ,count(if(a1.rk <= 2, a1.staff_info_id, null)) top2
    ,count(if(a1.rk <= 1, a1.staff_info_id, null)) top1

from
    (
        select
            a.*
            ,row_number() over (partition by a.归属网点 order by a.17点前未打电话占比 desc ) rk
        from
            (
                select
                    t1.staff_info_id
                    ,dp.store_name 归属网点
                    ,dp.piece_name 归属片区
                    ,dp.region_name 归属大区
                    ,pick.pno_count  揽收量
                    ,del.pno_count 妥投量
                    ,del.forward_pno_count 正向包裹妥投量
                    ,count(distinct t1.pno) 交接扫描量
                    ,count(distinct if(ph.pno is null , t1.pno, null)) 17点前未打电话包裹量
                    ,count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) 17点前未打电话占比
                from t t1
                left join
                    (
                        select
                            pr.pno
                        from ph_staging.parcel_route pr
                        join t t1 on t1.pno = pr.pno
                        where
                            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pr.routed_at < date_sub(curdate(), interval 15 hour)
                            and pr.route_action = 'PHONE'
                        group by 1
                    ) ph on ph.pno = t1.pno
                left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = t1.staff_info_id
                left join
                    (
                        select
                            t2.staff_info_id
                            ,count(pi.pno) pno_count
                        from ph_staging.parcel_info pi
                        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pi.ticket_pickup_staff_info_id
                        where
                            pi.created_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pi.created_at < date_sub(curdate(), interval 8 hour) -- 昨天揽收
                        group by 1
                    ) pick on pick.staff_info_id = t1.staff_info_id
                left join
                    (
                        select
                            t2.staff_info_id
                            ,count(distinct pr.pno) pno_count
                            ,count(distinct if(pi.returned = 0, pr.pno, null)) forward_pno_count
                        from ph_staging.parcel_route pr
                        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pr.staff_info_id
                        left join ph_staging.parcel_info pi on pi.pno = pr.pno
                        where
                            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天签收
                            and pr.route_action = 'DELIVERY_CONFIRM'
                        group by 1
                    ) del on del.staff_info_id = t1.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
                where
                    hsi.state = 1
                    and hsi.formal = 1
                    and dp.store_category = 1
                    and coalesce(pick.pno_count, 0) + coalesce(del.pno_count) < 50
                group by 1,2,3,4,5,6,7
                having count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) >= 0.5
            ) a
    ) a1
where
    a1.rk =  1
group by 1
with rollup;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        a.*
    from
        (
            select
                pr.pno
                ,pr.staff_info_id
                ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
            from ph_staging.parcel_route pr
            where
                pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                -- and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天
                and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN' -- 交接扫描
                and pr.routed_at < date_sub(curdate(), interval 15 hour) -- 昨天17点
        ) a
    where
        a.rk = 1
)
select
    a1.归属大区
    ,count(if(a1.rk <= 3, a1.staff_info_id, null)) top3
    ,count(if(a1.rk <= 2, a1.staff_info_id, null)) top2
    ,count(if(a1.rk <= 1, a1.staff_info_id, null)) top1

from
    (
        select
            a.*
            ,row_number() over (partition by a.归属网点 order by a.17点前未打电话占比 desc ) rk
        from
            (
                select
                    t1.staff_info_id
                    ,dp.store_name 归属网点
                    ,dp.piece_name 归属片区
                    ,dp.region_name 归属大区
                    ,pick.pno_count  揽收量
                    ,del.pno_count 妥投量
                    ,del.forward_pno_count 正向包裹妥投量
                    ,count(distinct t1.pno) 交接扫描量
                    ,count(distinct if(ph.pno is null , t1.pno, null)) 17点前未打电话包裹量
                    ,count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) 17点前未打电话占比
                from t t1
                left join
                    (
                        select
                            pr.pno
                        from ph_staging.parcel_route pr
                        join t t1 on t1.pno = pr.pno
                        where
                            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pr.routed_at < date_sub(curdate(), interval 15 hour)
                            and pr.route_action = 'PHONE'
                        group by 1
                    ) ph on ph.pno = t1.pno
                left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = t1.staff_info_id
                left join
                    (
                        select
                            t2.staff_info_id
                            ,count(pi.pno) pno_count
                        from ph_staging.parcel_info pi
                        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pi.ticket_pickup_staff_info_id
                        where
                            pi.created_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pi.created_at < date_sub(curdate(), interval 8 hour) -- 昨天揽收
                        group by 1
                    ) pick on pick.staff_info_id = t1.staff_info_id
                left join
                    (
                        select
                            t2.staff_info_id
                            ,count(distinct pr.pno) pno_count
                            ,count(distinct if(pi.returned = 0, pr.pno, null)) forward_pno_count
                        from ph_staging.parcel_route pr
                        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pr.staff_info_id
                        left join ph_staging.parcel_info pi on pi.pno = pr.pno
                        where
                            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天签收
                            and pr.route_action = 'DELIVERY_CONFIRM'
                        group by 1
                    ) del on del.staff_info_id = t1.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
                where
                    hsi.state = 1
                    and hsi.formal = 1
                    and dp.store_category = 1
                    and coalesce(pick.pno_count, 0) + coalesce(del.pno_count) < 50
                group by 1,2,3,4,5,6,7
                having count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) >= 0.5
            ) a
    ) a1
group by 1
with rollup;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        a.*
    from
        (
            select
                pr.pno
                ,pr.staff_info_id
                ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
            from ph_staging.parcel_route pr
            where
                pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                -- and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天
                and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN' -- 交接扫描
                and pr.routed_at < date_sub(curdate(), interval 15 hour) -- 昨天17点
        ) a
    where
        a.rk = 1
)
select
    a1.归属大区
    ,count(if(a1.rk <= 3, a1.staff_info_id, null)) top3
    ,count(if(a1.rk <= 2, a1.staff_info_id, null)) top2
    ,count(if(a1.rk <= 1, a1.staff_info_id, null)) top1

from
    (
        select
            a.*
            ,row_number() over (partition by a.归属网点 order by a.17点前未打电话占比 desc ) rk
        from
            (
                select
                    t1.staff_info_id
                    ,dp.store_name 归属网点
                    ,dp.piece_name 归属片区
                    ,dp.region_name 归属大区
                    ,pick.pno_count  揽收量
                    ,del.pno_count 妥投量
                    ,del.forward_pno_count 正向包裹妥投量
                    ,count(distinct t1.pno) 交接扫描量
                    ,count(distinct if(ph.pno is null , t1.pno, null)) 17点前未打电话包裹量
                    ,count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) 17点前未打电话占比
                from t t1
                left join
                    (
                        select
                            pr.pno
                        from ph_staging.parcel_route pr
                        join t t1 on t1.pno = pr.pno
                        where
                            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pr.routed_at < date_sub(curdate(), interval 15 hour)
                            and pr.route_action = 'PHONE'
                        group by 1
                    ) ph on ph.pno = t1.pno
                left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = t1.staff_info_id
                left join
                    (
                        select
                            t2.staff_info_id
                            ,count(pi.pno) pno_count
                        from ph_staging.parcel_info pi
                        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pi.ticket_pickup_staff_info_id
                        where
                            pi.created_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pi.created_at < date_sub(curdate(), interval 8 hour) -- 昨天揽收
                        group by 1
                    ) pick on pick.staff_info_id = t1.staff_info_id
                left join
                    (
                        select
                            t2.staff_info_id
                            ,count(distinct pr.pno) pno_count
                            ,count(distinct if(pi.returned = 0, pr.pno, null)) forward_pno_count
                        from ph_staging.parcel_route pr
                        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pr.staff_info_id
                        left join ph_staging.parcel_info pi on pi.pno = pr.pno
                        where
                            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天签收
                            and pr.route_action = 'DELIVERY_CONFIRM'
                        group by 1
                    ) del on del.staff_info_id = t1.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
                where
                    hsi.state = 1
                    and hsi.formal = 1
                    and dp.store_category = 1
                    and coalesce(pick.pno_count, 0) + coalesce(del.pno_count) < 50
                group by 1,2,3,4,5,6,7
                having count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) >= 0.6
            ) a
    ) a1
group by 1
with rollup;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        a.*
    from
        (
            select
                pr.pno
                ,pr.staff_info_id
                ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
            from ph_staging.parcel_route pr
            where
                pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                -- and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天
                and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN' -- 交接扫描
                and pr.routed_at < date_sub(curdate(), interval 15 hour) -- 昨天17点
        ) a
    where
        a.rk = 1
)
select
    a1.归属大区
    ,count(if(a1.rk <= 3, a1.staff_info_id, null)) top3
    ,count(if(a1.rk <= 2, a1.staff_info_id, null)) top2
    ,count(if(a1.rk <= 1, a1.staff_info_id, null)) top1

from
    (
        select
            a.*
            ,row_number() over (partition by a.归属网点 order by a.17点前未打电话占比 desc ) rk
        from
            (
                select
                    t1.staff_info_id
                    ,dp.store_name 归属网点
                    ,dp.piece_name 归属片区
                    ,dp.region_name 归属大区
                    ,pick.pno_count  揽收量
                    ,del.pno_count 妥投量
                    ,del.forward_pno_count 正向包裹妥投量
                    ,count(distinct t1.pno) 交接扫描量
                    ,count(distinct if(ph.pno is null , t1.pno, null)) 17点前未打电话包裹量
                    ,count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) 17点前未打电话占比
                from t t1
                left join
                    (
                        select
                            pr.pno
                        from ph_staging.parcel_route pr
                        join t t1 on t1.pno = pr.pno
                        where
                            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pr.routed_at < date_sub(curdate(), interval 15 hour)
                            and pr.route_action = 'PHONE'
                        group by 1
                    ) ph on ph.pno = t1.pno
                left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = t1.staff_info_id
                left join
                    (
                        select
                            t2.staff_info_id
                            ,count(pi.pno) pno_count
                        from ph_staging.parcel_info pi
                        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pi.ticket_pickup_staff_info_id
                        where
                            pi.created_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pi.created_at < date_sub(curdate(), interval 8 hour) -- 昨天揽收
                        group by 1
                    ) pick on pick.staff_info_id = t1.staff_info_id
                left join
                    (
                        select
                            t2.staff_info_id
                            ,count(distinct pr.pno) pno_count
                            ,count(distinct if(pi.returned = 0, pr.pno, null)) forward_pno_count
                        from ph_staging.parcel_route pr
                        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pr.staff_info_id
                        left join ph_staging.parcel_info pi on pi.pno = pr.pno
                        where
                            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天签收
                            and pr.route_action = 'DELIVERY_CONFIRM'
                        group by 1
                    ) del on del.staff_info_id = t1.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
                where
                    hsi.state = 1
                    and hsi.formal = 1
                    and dp.store_category = 1
                    and coalesce(pick.pno_count, 0) + coalesce(del.pno_count) < 50
                group by 1,2,3,4,5,6,7
                having count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) >= 0.7
            ) a
    ) a1
group by 1
with rollup;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        a.*
    from
        (
            select
                pr.pno
                ,pr.staff_info_id
                ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
            from ph_staging.parcel_route pr
            where
                pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                -- and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天
                and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN' -- 交接扫描
                and pr.routed_at < date_sub(curdate(), interval 15 hour) -- 昨天17点
        ) a
    where
        a.rk = 1
)
select
    a1.归属大区
    ,count(if(a1.rk <= 3, a1.staff_info_id, null)) top3
    ,count(if(a1.rk <= 2, a1.staff_info_id, null)) top2
    ,count(if(a1.rk <= 1, a1.staff_info_id, null)) top1

from
    (
        select
            a.*
            ,row_number() over (partition by a.归属网点 order by a.17点前未打电话占比 desc ) rk
        from
            (
                select
                    t1.staff_info_id
                    ,dp.store_name 归属网点
                    ,dp.piece_name 归属片区
                    ,dp.region_name 归属大区
                    ,pick.pno_count  揽收量
                    ,del.pno_count 妥投量
                    ,del.forward_pno_count 正向包裹妥投量
                    ,count(distinct t1.pno) 交接扫描量
                    ,count(distinct if(ph.pno is null , t1.pno, null)) 17点前未打电话包裹量
                    ,count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) 17点前未打电话占比
                from t t1
                left join
                    (
                        select
                            pr.pno
                        from ph_staging.parcel_route pr
                        join t t1 on t1.pno = pr.pno
                        where
                            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pr.routed_at < date_sub(curdate(), interval 15 hour)
                            and pr.route_action = 'PHONE'
                        group by 1
                    ) ph on ph.pno = t1.pno
                left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = t1.staff_info_id
                left join
                    (
                        select
                            t2.staff_info_id
                            ,count(pi.pno) pno_count
                        from ph_staging.parcel_info pi
                        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pi.ticket_pickup_staff_info_id
                        where
                            pi.created_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pi.created_at < date_sub(curdate(), interval 8 hour) -- 昨天揽收
                        group by 1
                    ) pick on pick.staff_info_id = t1.staff_info_id
                left join
                    (
                        select
                            t2.staff_info_id
                            ,count(distinct pr.pno) pno_count
                            ,count(distinct if(pi.returned = 0, pr.pno, null)) forward_pno_count
                        from ph_staging.parcel_route pr
                        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pr.staff_info_id
                        left join ph_staging.parcel_info pi on pi.pno = pr.pno
                        where
                            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天签收
                            and pr.route_action = 'DELIVERY_CONFIRM'
                        group by 1
                    ) del on del.staff_info_id = t1.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
                where
                    hsi.state = 1
                    and hsi.formal = 1
                    and dp.store_category = 1
                    and coalesce(pick.pno_count, 0) + coalesce(del.pno_count) < 50
                group by 1,2,3,4,5,6,7
                having count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) >= 0.8
            ) a
    ) a1
group by 1
with rollup;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        a.*
    from
        (
            select
                pr.pno
                ,pr.staff_info_id
                ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
            from ph_staging.parcel_route pr
            left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = pr.staff_info_id
            where
                pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                -- and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天
                and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN' -- 交接扫描
                and pr.routed_at < date_sub(curdate(), interval 15 hour) -- 昨天17点
                and hsi2.job_title in (13,110,1000)
        ) a
    where
        a.rk = 1
)
select
    a1.归属大区
    ,count(if(a1.rk <= 3, a1.staff_info_id, null)) top3
    ,count(if(a1.rk <= 2, a1.staff_info_id, null)) top2
    ,count(if(a1.rk <= 1, a1.staff_info_id, null)) top1

from
    (
        select
            a.*
            ,row_number() over (partition by a.归属网点 order by a.17点前未打电话占比 desc ) rk
        from
            (
                select
                    t1.staff_info_id
                    ,dp.store_name 归属网点
                    ,dp.piece_name 归属片区
                    ,dp.region_name 归属大区
                    ,pick.pno_count  揽收量
                    ,del.pno_count 妥投量
                    ,del.forward_pno_count 正向包裹妥投量
                    ,count(distinct t1.pno) 交接扫描量
                    ,count(distinct if(ph.pno is null , t1.pno, null)) 17点前未打电话包裹量
                    ,count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) 17点前未打电话占比
                from t t1
                left join
                    (
                        select
                            pr.pno
                        from ph_staging.parcel_route pr
                        join t t1 on t1.pno = pr.pno
                        where
                            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pr.routed_at < date_sub(curdate(), interval 15 hour)
                            and pr.route_action = 'PHONE'
                        group by 1
                    ) ph on ph.pno = t1.pno
                left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = t1.staff_info_id
                left join
                    (
                        select
                            t2.staff_info_id
                            ,count(pi.pno) pno_count
                        from ph_staging.parcel_info pi
                        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pi.ticket_pickup_staff_info_id
                        where
                            pi.created_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pi.created_at < date_sub(curdate(), interval 8 hour) -- 昨天揽收
                        group by 1
                    ) pick on pick.staff_info_id = t1.staff_info_id
                left join
                    (
                        select
                            t2.staff_info_id
                            ,count(distinct pr.pno) pno_count
                            ,count(distinct if(pi.returned = 0, pr.pno, null)) forward_pno_count
                        from ph_staging.parcel_route pr
                        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pr.staff_info_id
                        left join ph_staging.parcel_info pi on pi.pno = pr.pno
                        where
                            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天签收
                            and pr.route_action = 'DELIVERY_CONFIRM'
                        group by 1
                    ) del on del.staff_info_id = t1.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
                where
                    hsi.state = 1
                    and hsi.formal = 1
                    and dp.store_category = 1
                    and coalesce(pick.pno_count, 0) + coalesce(del.pno_count) < 50
                group by 1,2,3,4,5,6,7
                having count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) >= 0.7
            ) a
    ) a1
group by 1
with rollup;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        a.*
    from
        (
            select
                pr.pno
                ,pr.staff_info_id
                ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
            from ph_staging.parcel_route pr
            left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = pr.staff_info_id
            where
                pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                -- and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天
                and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN' -- 交接扫描
                and pr.routed_at < date_sub(curdate(), interval 15 hour) -- 昨天17点
                and hsi2.job_title in (13,110,1000)
        ) a
    where
        a.rk = 1
)
select
    a1.归属大区
    ,count(if(a1.rk <= 3, a1.staff_info_id, null)) top3
    ,count(if(a1.rk <= 2, a1.staff_info_id, null)) top2
    ,count(if(a1.rk <= 1, a1.staff_info_id, null)) top1

from
    (
        select
            a.*
            ,row_number() over (partition by a.归属网点 order by a.17点前未打电话占比 desc ) rk
        from
            (
                select
                    t1.staff_info_id
                    ,dp.store_name 归属网点
                    ,dp.piece_name 归属片区
                    ,dp.region_name 归属大区
                    ,pick.pno_count  揽收量
                    ,del.pno_count 妥投量
                    ,del.forward_pno_count 正向包裹妥投量
                    ,count(distinct t1.pno) 交接扫描量
                    ,count(distinct if(ph.pno is null , t1.pno, null)) 17点前未打电话包裹量
                    ,count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) 17点前未打电话占比
                from t t1
                left join
                    (
                        select
                            pr.pno
                        from ph_staging.parcel_route pr
                        join t t1 on t1.pno = pr.pno
                        where
                            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pr.routed_at < date_sub(curdate(), interval 15 hour)
                            and pr.route_action = 'PHONE'
                        group by 1
                    ) ph on ph.pno = t1.pno
                left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = t1.staff_info_id
                left join
                    (
                        select
                            t2.staff_info_id
                            ,count(pi.pno) pno_count
                        from ph_staging.parcel_info pi
                        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pi.ticket_pickup_staff_info_id
                        where
                            pi.created_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pi.created_at < date_sub(curdate(), interval 8 hour) -- 昨天揽收
                        group by 1
                    ) pick on pick.staff_info_id = t1.staff_info_id
                left join
                    (
                        select
                            t2.staff_info_id
                            ,count(distinct pr.pno) pno_count
                            ,count(distinct if(pi.returned = 0, pr.pno, null)) forward_pno_count
                        from ph_staging.parcel_route pr
                        join ( select t1.staff_info_id from t t1 group by 1) t2 on t2.staff_info_id = pr.staff_info_id
                        left join ph_staging.parcel_info pi on pi.pno = pr.pno
                        where
                            pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day ), interval 8 hour)
                            and pr.routed_at < date_sub(curdate(), interval 8 hour) -- 昨天签收
                            and pr.route_action = 'DELIVERY_CONFIRM'
                        group by 1
                    ) del on del.staff_info_id = t1.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
                where
                    hsi.state = 1
                    and hsi.formal = 1
                    and dp.store_category = 1
                    and coalesce(pick.pno_count, 0) + coalesce(del.pno_count) < 50
                group by 1,2,3,4,5,6,7
                having count(distinct if(ph.pno is null , t1.pno, null))/count(distinct t1.pno) >= 0.6
            ) a
    ) a1
group by 1
with rollup;
;-- -. . -..- - / . -. - .-. -.--
select
    *
from
    (
        select
            pi.pno
            ,pi.ticket_pickup_store_id
            ,pi.finished_at
            ,pi.ticket_delivery_staff_info_id
            ,pi.ticket_delivery_store_id
            ,pi.created_at
            ,pi.dst_store_id
            ,pr.route_action
            ,lag(pr.route_action, 1) over (order by pr.routed_at) last_action
        from ph_staging.parcel_info pi
        join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
        left join ph_staging.parcel_route pr on pr.pno = pi.pno
        where
            pi.state = 5
            and bc.client_name = 'shein'
            and pi.created_at > '2023-08-01'
    ) a
where
    a.route_action = 'DELIVERY_CONFIRM'
    and a.last_action in ('DELIVERY_TICKET_CREATION_SCAN', 'SORTING_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'UNSEAL', 'SHIPMENT_WAREHOUSE_SCAN', 'INVENTORY', 'DETAIN_WAREHOUSE');
;-- -. . -..- - / . -. - .-. -.--
select
    *
from
    (
        select
            pi.pno
            ,pi.ticket_pickup_store_id
            ,pi.finished_at
            ,pi.ticket_delivery_staff_info_id
            ,pi.ticket_delivery_store_id
            ,pi.created_at
            ,pi.dst_store_id
            ,pr.route_action
            ,lag(pr.route_action, 1) over (partition by pr.pno order by pr.routed_at) last_action
        from ph_staging.parcel_info pi
        join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
        left join ph_staging.parcel_route pr on pr.pno = pi.pno
        where
            pi.state = 5
            and bc.client_name = 'shein'
            and pi.created_at > '2023-08-01'
            and pr.routed_at > '2023-08-01'
    ) a
where
    a.route_action = 'DELIVERY_CONFIRM'
    and a.last_action in ('DELIVERY_TICKET_CREATION_SCAN', 'SORTING_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'UNSEAL', 'SHIPMENT_WAREHOUSE_SCAN', 'INVENTORY', 'DETAIN_WAREHOUSE');
;-- -. . -..- - / . -. - .-. -.--
select
        pi.pno
        ,sum(json_extract(pr.extra_value, '$.callDuration')) call_sum
    from ph_staging.parcel_info pi
    join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id and bc.client_name = 'shein'
    left join ph_staging.parcel_route pr on pr.pno = pi.pno and pr.route_action = 'PHONE' and pr.routed_at < pi.finished_at
    where
        pi.state = 5
        and pi.created_at > '2023-08-01'
        and pr.pno is not null
    group by 1
    having sum(json_extract(pr.extra_value, '$.callDuration') ) = 0;
;-- -. . -..- - / . -. - .-. -.--
select
        pi.pno
        ,'未打电话' type
    from ph_staging.parcel_info pi
    join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id and bc.client_name = 'shein'
    left join ph_staging.parcel_route pr on pr.pno = pi.pno and pr.route_action = 'PHONE' and pr.routed_at < pi.finished_at
    where
        pi.state = 5
        and pi.created_at > '2023-08-01'
        and pr.pno is null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        pi.pno
        ,'未打电话' type
        ,pi.ticket_pickup_store_id
        ,pi.finished_at
        ,pi.ticket_delivery_staff_info_id
        ,pi.ticket_delivery_store_id
        ,pi.created_at
        ,pi.dst_store_id
        ,pi.dst_province_code
        ,pi.cod_enabled
    from ph_staging.parcel_info pi
    join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id and bc.client_name = 'shein'
    left join ph_staging.parcel_route pr on pr.pno = pi.pno and pr.route_action = 'PHONE' and pr.routed_at < pi.finished_at
    where
        pi.state = 5
        and pi.created_at > '2023-08-01'
        and pr.pno is null

    union all

    select
        pi.pno
        ,'未打通电话' type
        ,pi.ticket_pickup_store_id
        ,pi.finished_at
        ,pi.ticket_delivery_staff_info_id
        ,pi.ticket_delivery_store_id
        ,pi.created_at
        ,pi.dst_store_id
        ,pi.dst_province_code
        ,pi.cod_enabled
#         ,sum(json_extract(pr.extra_value, '$.callDuration')) call_sum
    from ph_staging.parcel_info pi
    join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id and bc.client_name = 'shein'
    left join ph_staging.parcel_route pr on pr.pno = pi.pno and pr.route_action = 'PHONE' and pr.routed_at < pi.finished_at
    where
        pi.state = 5
        and pi.created_at > '2023-08-01'
        and pr.pno is not null
    group by 1
    having sum(json_extract(pr.extra_value, '$.callDuration') ) = 0


)
select
    a.pno
    ,a.type 类型
    ,convert_tz(oi.created_at, '+00:00', '+08:00') 下单时间
    ,convert_tz(a.created_at, '+00:00', '+08:00') 揽收时间
    ,convert_tz(a.finished_at, '+00:00', '+08:00') 妥投时间
    ,dp3.area_name 目的地区域
    ,sp.name 目的地省
    ,dp.region_name 目的大区
    ,dp.store_name 目的网点
    ,dp2.store_name 派件网点
    ,dp2.region_name 派件大区
    ,a.ticket_delivery_staff_info_id 派件快递员工号
    ,a.last_action 妥投前路由状态
    ,oi.cogs_amount/100 cogs金额
    ,if(a.cod_enabled = 1, 'y', 'n') 是否COD
from
    (
        select
            t1.*
            ,pr.route_action
            ,lag(pr.route_action, 1) over (partition by pr.pno order by pr.routed_at) last_action
        from t t1
        left join ph_staging.parcel_route pr on pr.pno = t1.pno
        where
            pr.routed_at > '2023-08-01'
    ) a
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.ticket_pickup_store_id and dp.stat_date = date_sub(curdate(), interval 1 day )
left join dwm.dim_ph_sys_store_rd dp2 on dp2.store_id = a.ticket_delivery_store_id and dp2.stat_date = date_sub(curdate(), interval 1 day )
left join dwm.dim_ph_sys_store_rd dp3 on dp3.store_id = a.dst_store_id and dp3.stat_date = date_sub(curdate(), interval 1 day )
left join ph_staging.order_info oi on oi.pno = a.pno
left join ph_staging.sys_province sp on sp.code = a.dst_province_code
where
    a.route_action = 'DELIVERY_CONFIRM'
    and a.last_action in ('DELIVERY_TICKET_CREATION_SCAN', 'SORTING_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'UNSEAL', 'SHIPMENT_WAREHOUSE_SCAN', 'INVENTORY', 'DETAIN_WAREHOUSE');
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        pi.pno
        ,'未打电话' type
        ,pi.ticket_pickup_store_id
        ,pi.finished_at
        ,pi.ticket_delivery_staff_info_id
        ,pi.ticket_delivery_store_id
        ,pi.created_at
        ,pi.dst_store_id
        ,pi.dst_province_code
        ,pi.cod_enabled
        ,pi.returned
    from ph_staging.parcel_info pi
    join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id and bc.client_name = 'shein'
    left join ph_staging.parcel_route pr on pr.pno = pi.pno and pr.route_action = 'PHONE' and pr.routed_at < pi.finished_at
    where
        pi.state = 5
        and pi.created_at > '2023-08-01'
        and pr.pno is null

    union all

    select
        pi.pno
        ,'未打通电话' type
        ,pi.ticket_pickup_store_id
        ,pi.finished_at
        ,pi.ticket_delivery_staff_info_id
        ,pi.ticket_delivery_store_id
        ,pi.created_at
        ,pi.dst_store_id
        ,pi.dst_province_code
        ,pi.cod_enabled
        ,pi.returned
#         ,sum(json_extract(pr.extra_value, '$.callDuration')) call_sum
    from ph_staging.parcel_info pi
    join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id and bc.client_name = 'shein'
    left join ph_staging.parcel_route pr on pr.pno = pi.pno and pr.route_action = 'PHONE' and pr.routed_at < pi.finished_at
    where
        pi.state = 5
        and pi.created_at > '2023-08-01'
        and pr.pno is not null
    group by 1
    having sum(json_extract(pr.extra_value, '$.callDuration') ) = 0


)
select
    a.pno
    ,a.type 类型
    ,convert_tz(oi.created_at, '+00:00', '+08:00') 下单时间
    ,convert_tz(a.created_at, '+00:00', '+08:00') 揽收时间
    ,convert_tz(a.finished_at, '+00:00', '+08:00') 妥投时间
    ,dp3.area_name 目的地区域
    ,sp.name 目的地省
    ,dp.region_name 目的大区
    ,dp.store_name 目的网点
    ,dp2.store_name 派件网点
    ,dp2.region_name 派件大区
    ,a.ticket_delivery_staff_info_id 派件快递员工号
    ,a.last_action 妥投前路由状态
    ,oi.cogs_amount/100 cogs金额
    ,if(a.cod_enabled = 1, 'y', 'n') 是否COD
    ,if(a.returned = 1, 'y', 'n') 是否退件
from
    (
        select
            t1.*
            ,pr.route_action
            ,lag(pr.route_action, 1) over (partition by pr.pno order by pr.routed_at) last_action
        from t t1
        left join ph_staging.parcel_route pr on pr.pno = t1.pno
        where
            pr.routed_at > '2023-08-01'
    ) a
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.ticket_pickup_store_id and dp.stat_date = date_sub(curdate(), interval 1 day )
left join dwm.dim_ph_sys_store_rd dp2 on dp2.store_id = a.ticket_delivery_store_id and dp2.stat_date = date_sub(curdate(), interval 1 day )
left join dwm.dim_ph_sys_store_rd dp3 on dp3.store_id = a.dst_store_id and dp3.stat_date = date_sub(curdate(), interval 1 day )
left join ph_staging.order_info oi on oi.pno = a.pno
left join ph_staging.sys_province sp on sp.code = a.dst_province_code
where
    a.route_action = 'DELIVERY_CONFIRM'
    and a.last_action in ('DELIVERY_TICKET_CREATION_SCAN', 'SORTING_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'UNSEAL', 'SHIPMENT_WAREHOUSE_SCAN', 'INVENTORY', 'DETAIN_WAREHOUSE');
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-14'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 10
                    or (t1.total =  5 and t1.leave_time_type = 2)

                union all

                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 5
                    and t1.leave_time_type = 1 -- 上午请假
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-14'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 10
                                    or (t1.total =  5 and t1.leave_time_type = 2)

                                union all

                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 5
                                    and t1.leave_time_type = 1 -- 上午请假
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-09-14', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with d as
    (
        select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-09-14'
    )
    , t as
    (
        select
             ds.store_id
            ,ds.pno
            ,ds.stat_date
        from d ds
        left join
            (
                select
                    pr.pno
                    ,ds.stat_date
                    ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
                from ph_staging.parcel_route pr
                join d ds on pr.pno = ds.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                    and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and pr.marker_category in (42,43) ##岛屿,偏远地区
                group by 1,2
            ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
        left join
            (
                select
                   pr.pno
                    ,ds.stat_date
                   ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
                   ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
                from ph_staging.parcel_route pr
                join d ds on ds.pno = pr.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                    and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                    and pr.marker_category in (9,14,70) ##客户改约时间
            ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
        left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
        where
            case
                when pr1.pno is not null then 'N'
                when pr2.pno is not null then 'N'
                when ds1.pno is not null  then 'N'  else 'Y'
            end = 'Y'
    )
    select
        a.stat_date 日期
        ,a.store_id 网点ID
        ,dp.store_name 网点名称
        ,dp.opening_at 开业时间
        ,case
            when dp.region_name in ('Area3', 'Area6') then '彭万松'
            when dp.region_name in ('Area4', 'Area9') then '韩钥'
            when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
            when dp.region_name in ( 'Area8') then '黄勇'
            when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
        end 区域
        ,dp.region_name 大区
        ,dp.piece_name 片区
        ,a.应交接
        ,a.已交接
        ,concat(round(a.交接率*100,2),'%') as 交接率
        ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
        ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
        ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
        ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
        ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
    from
        (
            select
                t1.store_id
                ,t1.stat_date
                ,count(t1.pno) 应交接
                ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
            from t t1
            left join
                (
                    select
                        sc.*
                    from
                        (
                            select
                                pr.pno
                                ,pr.store_id
                                ,pr.store_name
                                ,t1.stat_date
                                ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                            from ph_staging.parcel_route pr
                            join t t1 on t1.pno = pr.pno
                            where
                                pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                               and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                              and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                        ) sc
                    where
                        sc.rk = 1
                ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
            group by 1,2
        ) a
    join
        (
            select
                sd.store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.store_id is not null
            group by 1

            union all

            select
                sd.separation_store_id store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.separation_store_id is not null
            group by 1
        ) sd on sd.store_id = a.store_id
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    where
        dp.store_category in (1,10);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-14'
        and pr.routed_at >= date_sub('2023-09-14', interval 8 hour )
        and pr.routed_at < date_add('2023-09-14', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,if(a3.self_staff_num + other_staff_num > coalesce(sdb.code_num, 0),
           case
            when a2.avg_staff_code < 2 then 'A'
            when a2.avg_staff_code >= 2 and a2.avg_staff_code < 3 then 'B'
            when a2.avg_staff_code >= 3 and a2.avg_staff_code < 4 then 'C'
            when a2.avg_staff_code >= 4 then 'D'
        end,
           case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end ) 评级
#         ,a2.code_num
#         ,a2.staff_code_num
#         ,a2.staff_num
#         ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) avg_staff_code
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
            ,count(distinct sdb.district_code) barangay_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-14'
        and pr.routed_at >= date_sub('2023-09-14', interval 8 hour )
        and pr.routed_at < date_add('2023-09-14', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)

select
    a1.store_id
    ,ss.name 网点
    ,ss2.staff_count 交接员工数
    ,sdb.code_num 网点现有三段码数
    ,if(ss2.staff_count > sdb.code_num, '人比码多', '码比人多') 人码对比
    ,sdb.barangay_num 网点绑定三段码barangay数
    ,a1.third_sorting_code
#     ,if(a1.is_self = 'y', '本网点', '非本网点') 员工归属
#     ,hjt.job_name 岗位
    ,count(distinct a1.staff_info_id) 交接三段码数
    ,group_concat(distinct a1.staff_info_id) 交接三段码
from
    (
        select
            a1.*
        from
            (
                select
                    t1.store_id
                    ,t1.pno
                    ,t1.staff_info_id
                    ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                    ,t1.state
                    ,t1.job_title
                    ,ps.third_sorting_code
                    ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                from t t1
                join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
            ) a1
        where
            a1.rk = 1
    ) a1
left join ph_staging.sys_store ss on ss.id = a1.store_id
left join ph_bi.hr_job_title hjt on hjt.id = a1.job_title
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
            ,count(distinct sdb.district_code) barangay_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a1.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.staff_info_id) staff_count
        from t t1
        where
            t1.job_title in (13,110,1000)
        group by 1
    ) ss2 on ss2.store_id = a1.store_id
where
    a1.job_title in (13,110,1000) -- 快递员
group by 1,2,3,4,5,6,7;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-09-14'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-09-14')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-09-14'
        and pi.finished_at >= date_sub('2023-09-14', interval 8 hour )
        and pi.finished_at < date_add('2023-09-14', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数

    ,coalesce(backlog.in_house_count, 0) 在仓包裹数
    ,coalesce(backlog.big_in_house_count, 0) 在仓大件包裹数
    ,coalesce(backlog.big_client_count, 0) 在仓平台客户包裹数
    ,coalesce(backlog.small_client_count, 0) 在仓非平台客户包裹数
    ,coalesce(backlog.3_within_backlog_bigclient, 0) 平台客户在仓积压3天内包裹数
    ,coalesce(backlog.3_5_backlog_bigclient, 0) 平台客户在仓积压3_5天内包裹数
    ,coalesce(backlog.5_more_backlog_bigclient, 0) 平台客户在仓积压5天以上包裹数
    ,coalesce(backlog.tt_overtime_count, 0) tiktok超时效包裹数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-09-14'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) in_house_count
            ,count(distinct if(pi.exhibition_weight > 5000 or pi.exhibition_length + pi.exhibition_width + pi.exhibition_height > 80, ds.pno, null)) big_in_house_count
            ,count(distinct if(bc.client_id is not null, ds.pno, null)) big_client_count
            ,count(distinct if(bc.client_id is null, ds.pno, null)) small_client_count
            ,count(distinct if(datediff(now(), ds.first_valid_routed_at) <= 3 and bc.client_id is not null, ds.pno, null)) 3_within_backlog_bigclient
            ,count(distinct if(datediff(now(), ds.first_valid_routed_at) > 3 and datediff(now(), ds.first_valid_routed_at) <= 5 and bc.client_id is not null, ds.pno, null)) 3_5_backlog_bigclient
            ,count(distinct if(datediff(now(), ds.first_valid_routed_at) > 5 and bc.client_id is not null, ds.pno, null)) 5_more_backlog_bigclient
            ,count(distinct if(tsd.end_date < curdate(), ds.pno, null)) tt_overtime_count
        from dwm.dwd_ph_dc_should_be_delivery ds
        join ph_staging.parcel_info pi on pi.pno = ds.pno and pi.state not in (5,7,8,9)
        left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
        left join dwm.dwd_ex_ph_tiktok_sla_detail tsd on tsd.pno = ds.pno
        where
            ds.p_date = '2023-09-14'
        group by 1
    ) backlog on backlog.dst_store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-15'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 10
                    or (t1.total =  5 and t1.leave_time_type = 2)

                union all

                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 5
                    and t1.leave_time_type = 1 -- 上午请假
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-15'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 10
                                    or (t1.total =  5 and t1.leave_time_type = 2)

                                union all

                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 5
                                    and t1.leave_time_type = 1 -- 上午请假
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-09-15', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-15'
        and pr.routed_at >= date_sub('2023-09-15', interval 8 hour )
        and pr.routed_at < date_add('2023-09-15', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,if(a3.self_staff_num + other_staff_num > coalesce(sdb.code_num, 0),
           case
            when a2.avg_staff_code < 2 then 'A'
            when a2.avg_staff_code >= 2 and a2.avg_staff_code < 3 then 'B'
            when a2.avg_staff_code >= 3 and a2.avg_staff_code < 4 then 'C'
            when a2.avg_staff_code >= 4 then 'D'
        end,
           case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end ) 评级
#         ,a2.code_num
#         ,a2.staff_code_num
#         ,a2.staff_num
#         ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) avg_staff_code
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
            ,count(distinct sdb.district_code) barangay_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-15'
        and pr.routed_at >= date_sub('2023-09-15', interval 8 hour )
        and pr.routed_at < date_add('2023-09-15', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)

select
    a1.store_id
    ,ss.name 网点
    ,ss2.staff_count 交接员工数
    ,sdb.code_num 网点现有三段码数
    ,if(ss2.staff_count > sdb.code_num, '人比码多', '码比人多') 人码对比
    ,sdb.barangay_num 网点绑定三段码barangay数
    ,a1.third_sorting_code
#     ,if(a1.is_self = 'y', '本网点', '非本网点') 员工归属
#     ,hjt.job_name 岗位
    ,count(distinct a1.staff_info_id) 交接三段码数
    ,group_concat(distinct a1.staff_info_id) 交接三段码
from
    (
        select
            a1.*
        from
            (
                select
                    t1.store_id
                    ,t1.pno
                    ,t1.staff_info_id
                    ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                    ,t1.state
                    ,t1.job_title
                    ,ps.third_sorting_code
                    ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                from t t1
                join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
            ) a1
        where
            a1.rk = 1
    ) a1
left join ph_staging.sys_store ss on ss.id = a1.store_id
left join ph_bi.hr_job_title hjt on hjt.id = a1.job_title
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
            ,count(distinct sdb.district_code) barangay_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a1.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.staff_info_id) staff_count
        from t t1
        where
            t1.job_title in (13,110,1000)
        group by 1
    ) ss2 on ss2.store_id = a1.store_id
where
    a1.job_title in (13,110,1000) -- 快递员
group by 1,2,3,4,5,6,7;
;-- -. . -..- - / . -. - .-. -.--
with d as
    (
        select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-09-15'
    )
    , t as
    (
        select
             ds.store_id
            ,ds.pno
            ,ds.stat_date
        from d ds
        left join
            (
                select
                    pr.pno
                    ,ds.stat_date
                    ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
                from ph_staging.parcel_route pr
                join d ds on pr.pno = ds.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                    and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and pr.marker_category in (42,43) ##岛屿,偏远地区
                group by 1,2
            ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
        left join
            (
                select
                   pr.pno
                    ,ds.stat_date
                   ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
                   ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
                from ph_staging.parcel_route pr
                join d ds on ds.pno = pr.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                    and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                    and pr.marker_category in (9,14,70) ##客户改约时间
            ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
        left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
        where
            case
                when pr1.pno is not null then 'N'
                when pr2.pno is not null then 'N'
                when ds1.pno is not null  then 'N'  else 'Y'
            end = 'Y'
    )
    select
        a.stat_date 日期
        ,a.store_id 网点ID
        ,dp.store_name 网点名称
        ,dp.opening_at 开业时间
        ,case
            when dp.region_name in ('Area3', 'Area6') then '彭万松'
            when dp.region_name in ('Area4', 'Area9') then '韩钥'
            when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
            when dp.region_name in ( 'Area8') then '黄勇'
            when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
        end 区域
        ,dp.region_name 大区
        ,dp.piece_name 片区
        ,a.应交接
        ,a.已交接
        ,concat(round(a.交接率*100,2),'%') as 交接率
        ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
        ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
        ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
        ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
        ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
    from
        (
            select
                t1.store_id
                ,t1.stat_date
                ,count(t1.pno) 应交接
                ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
            from t t1
            left join
                (
                    select
                        sc.*
                    from
                        (
                            select
                                pr.pno
                                ,pr.store_id
                                ,pr.store_name
                                ,t1.stat_date
                                ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                            from ph_staging.parcel_route pr
                            join t t1 on t1.pno = pr.pno
                            where
                                pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                               and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                              and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                        ) sc
                    where
                        sc.rk = 1
                ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
            group by 1,2
        ) a
    join
        (
            select
                sd.store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.store_id is not null
            group by 1

            union all

            select
                sd.separation_store_id store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.separation_store_id is not null
            group by 1
        ) sd on sd.store_id = a.store_id
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    where
        dp.store_category in (1,10);
;-- -. . -..- - / . -. - .-. -.--
select
    ssd.p_date 统计日期
    ,ssd.pno
    ,ssd.store_id
    ,ssd.store_name 网点
    ,ssd.piece_name  片区
    ,ssd.region_name 大区
    ,ssd.should_delevry_type 派送类型
    ,ssd.parcel_type 包裹分类
    ,ssd.min_fenjian_scan_time 当日最早分拣时间
    ,ssd.tiaozheng_scan_deadline_time 有效分拣截止时间
from dwm.dwd_ph_dc_should_be_delivery_sort_scan_d ssd
where
    ssd.should_delevry_type in ('1派应派包裹', '今日应派_妥投')
    and ssd.p_date = '2023-09-11'
    and ( ssd.min_fenjian_scan_time is null or ssd.min_fenjian_scan_time >= ssd.tiaozheng_scan_deadline_time );
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-09-15'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-09-15')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-09-15'
        and pi.finished_at >= date_sub('2023-09-15', interval 8 hour )
        and pi.finished_at < date_add('2023-09-15', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数

    ,coalesce(backlog.in_house_count, 0) 在仓包裹数
    ,coalesce(backlog.big_in_house_count, 0) 在仓大件包裹数
    ,coalesce(backlog.big_client_count, 0) 在仓平台客户包裹数
    ,coalesce(backlog.small_client_count, 0) 在仓非平台客户包裹数
    ,coalesce(backlog.3_within_backlog_bigclient, 0) 平台客户在仓积压3天内包裹数
    ,coalesce(backlog.3_5_backlog_bigclient, 0) 平台客户在仓积压3_5天内包裹数
    ,coalesce(backlog.5_more_backlog_bigclient, 0) 平台客户在仓积压5天以上包裹数
    ,coalesce(backlog.tt_overtime_count, 0) tiktok超时效包裹数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-09-15'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) in_house_count
            ,count(distinct if(pi.exhibition_weight > 5000 or pi.exhibition_length + pi.exhibition_width + pi.exhibition_height > 80, ds.pno, null)) big_in_house_count
            ,count(distinct if(bc.client_id is not null, ds.pno, null)) big_client_count
            ,count(distinct if(bc.client_id is null, ds.pno, null)) small_client_count
            ,count(distinct if(datediff(now(), ds.first_valid_routed_at) <= 3 and bc.client_id is not null, ds.pno, null)) 3_within_backlog_bigclient
            ,count(distinct if(datediff(now(), ds.first_valid_routed_at) > 3 and datediff(now(), ds.first_valid_routed_at) <= 5 and bc.client_id is not null, ds.pno, null)) 3_5_backlog_bigclient
            ,count(distinct if(datediff(now(), ds.first_valid_routed_at) > 5 and bc.client_id is not null, ds.pno, null)) 5_more_backlog_bigclient
            ,count(distinct if(tsd.end_date < curdate(), ds.pno, null)) tt_overtime_count
        from dwm.dwd_ph_dc_should_be_delivery ds
        join ph_staging.parcel_info pi on pi.pno = ds.pno and pi.state not in (5,7,8,9)
        left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
        left join dwm.dwd_ex_ph_tiktok_sla_detail tsd on tsd.pno = ds.pno
        where
            ds.p_date = '2023-09-15'
        group by 1
    ) backlog on backlog.dst_store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
select
            am.staff_info_id
            ,'投诉' type
            ,count(distinct if(acc.complaints_type = 2, acc.id, null)) 揽件虚假量
            ,count(distinct if(acc.complaints_type = 1, acc.id, null)) 妥投虚假量
            ,count(distinct if(acc.complaints_type = 3, acc.id, null)) 派件标记虚假量
        from ph_bi.abnormal_customer_complaint acc
        left join ph_bi.abnormal_message am on am.id = acc.abnormal_message_id
        where
            acc.state = 1
            and acc.updated_at >= date_sub(date_sub(curdate(), interval 1 day), interval 7 hour)
            and acc.updated_at < date_add(date_sub(curdate(), interval 1 day), interval 17 hour) -- 昨天
            and acc.complaints_type in (1,2,3)
        group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
            am.staff_info_id
            ,'投诉' type
            ,count(distinct if(acc.complaints_type = 2, acc.id, null)) 揽件虚假量
            ,count(distinct if(acc.complaints_type = 1, acc.id, null)) 妥投虚假量
            ,count(distinct if(acc.complaints_type = 3, acc.id, null)) 派件标记虚假量
        from ph_bi.abnormal_customer_complaint acc
        left join ph_bi.abnormal_message am on am.id = acc.abnormal_message_id
        where
            acc.state = 1
            and acc.updated_at >= date_sub(date_sub(curdate(), interval 1 day), interval 8 hour)
            and acc.updated_at < date_add(date_sub(curdate(), interval 1 day), interval 16 hour) -- 昨天
            and acc.complaints_type in (1,2,3)
            and acc.qaqc_callback_result in (3,4,5,6)
        group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    a.staff_info_id
    ,sum(a.揽件虚假量) 虚假揽件量
    ,sum(a.妥投虚假量) 虚假妥投量
    ,sum(a.派件标记虚假量) 虚假派件标记量
from
    (
        select
        #     case vrv.type
        #         when 1 then '揽件任务异常取消'
        #         when 2 then '虚假妥投'
        #         when 3 then '收件人拒收'
        #         when 4 then '标记客户改约时间'
        #         when 5 then 'KA现场不揽收'
        #         when 6 then '包裹未准备好'
        #         when 7 then '上报错分未妥投'
        #         when 8 then '多次尝试派送失败'
        #     end 回访类型
            vrv.staff_info_id
            ,'回访' type
            ,count(distinct if(vrv.visit_result  in (6), vrv.link_id, null)) 妥投虚假量
            ,count(distinct if(vrv.visit_result in (18,8,19,20,21,31,32,22,23,24), vrv.link_id, null)) 派件标记虚假量
        #     ,count(distinct if(vrv.visit_result in (23,24), vrv.link_id, null)) 虚假改约量
            ,count(distinct if(vrv.visit_result in (37,39,3), vrv.link_id, null)) 揽件虚假量
        #     ,count(distinct if(vrv.visit_result in (39), vrv.link_id, null)) 虚假未准备好标记量
        #     ,count(distinct if(vrv.visit_result in (3), vrv.link_id, null)) 虚假取消揽件任务
        from nl_production.violation_return_visit vrv
        where
            vrv.visit_state = 4
            and vrv.updated_at >= date_sub(date_sub(curdate(), interval 1 day), interval 8 hour)
            and vrv.updated_at < date_add(date_sub(curdate(), interval 1 day), interval 16 hour) -- 昨天
            and vrv.visit_staff_id not in (10000,10001) -- 非ivr回访
            and vrv.type in (1,2,3,4,5,6)
        group by 1

        union all

        select
            am.staff_info_id
            ,'投诉' type
            ,count(distinct if(acc.complaints_type = 2, acc.id, null)) 揽件虚假量
            ,count(distinct if(acc.complaints_type = 1, acc.id, null)) 妥投虚假量
            ,count(distinct if(acc.complaints_type = 3, acc.id, null)) 派件标记虚假量
        from ph_bi.abnormal_customer_complaint acc
        left join ph_bi.abnormal_message am on am.id = acc.abnormal_message_id
        where
            acc.state = 1
            and acc.updated_at >= date_sub(date_sub(curdate(), interval 1 day), interval 8 hour)
            and acc.updated_at < date_add(date_sub(curdate(), interval 1 day), interval 16 hour) -- 昨天
            and acc.complaints_type in (1,2,3)
            and acc.qaqc_callback_result in (3,4,5,6)
        group by 1
    ) a
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
        #     case vrv.type
        #         when 1 then '揽件任务异常取消'
        #         when 2 then '虚假妥投'
        #         when 3 then '收件人拒收'
        #         when 4 then '标记客户改约时间'
        #         when 5 then 'KA现场不揽收'
        #         when 6 then '包裹未准备好'
        #         when 7 then '上报错分未妥投'
        #         when 8 then '多次尝试派送失败'
        #     end 回访类型
            vrv.staff_info_id
            ,'回访' type
            ,count(distinct if(vrv.visit_result  in (6), vrv.link_id, null)) 妥投虚假量
            ,count(distinct if(vrv.visit_result in (18,8,19,20,21,31,32,22,23,24), vrv.link_id, null)) 派件标记虚假量
        #     ,count(distinct if(vrv.visit_result in (23,24), vrv.link_id, null)) 虚假改约量
            ,count(distinct if(vrv.visit_result in (37,39,3), vrv.link_id, null)) 揽件虚假量
        #     ,count(distinct if(vrv.visit_result in (39), vrv.link_id, null)) 虚假未准备好标记量
        #     ,count(distinct if(vrv.visit_result in (3), vrv.link_id, null)) 虚假取消揽件任务
        from nl_production.violation_return_visit vrv
        where
            vrv.visit_state = 4
            and vrv.updated_at >= date_sub(date_sub(curdate(), interval 1 day), interval 8 hour)
            and vrv.updated_at < date_add(date_sub(curdate(), interval 1 day), interval 16 hour) -- 昨天
            and vrv.visit_staff_id not in (10000,10001) -- 非ivr回访
            and vrv.type in (1,2,3,4,5,6)
        group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    a.staff_info_id
    ,sum(a.揽件虚假量) 虚假揽件量
    ,sum(a.妥投虚假量) 虚假妥投量
    ,sum(a.派件标记虚假量) 虚假派件标记量
from
    (
        select
        #     case vrv.type
        #         when 1 then '揽件任务异常取消'
        #         when 2 then '虚假妥投'
        #         when 3 then '收件人拒收'
        #         when 4 then '标记客户改约时间'
        #         when 5 then 'KA现场不揽收'
        #         when 6 then '包裹未准备好'
        #         when 7 then '上报错分未妥投'
        #         when 8 then '多次尝试派送失败'
        #     end 回访类型
            vrv.staff_info_id
            ,'回访' type
            ,count(distinct if(vrv.visit_result  in (6), vrv.link_id, null)) 妥投虚假量
            ,count(distinct if(vrv.visit_result in (18,8,19,20,21,31,32,22,23,24), vrv.link_id, null)) 派件标记虚假量
        #     ,count(distinct if(vrv.visit_result in (23,24), vrv.link_id, null)) 虚假改约量
            ,count(distinct if(vrv.visit_result in (37,39,3), vrv.link_id, null)) 揽件虚假量
        #     ,count(distinct if(vrv.visit_result in (39), vrv.link_id, null)) 虚假未准备好标记量
        #     ,count(distinct if(vrv.visit_result in (3), vrv.link_id, null)) 虚假取消揽件任务
        from nl_production.violation_return_visit vrv
        where
            vrv.visit_state = 4
            and vrv.updated_at >= date_sub(date_sub(curdate(), interval 1 day), interval 8 hour)
            and vrv.updated_at < date_add(date_sub(curdate(), interval 1 day), interval 16 hour) -- 昨天
            and vrv.visit_staff_id not in (10000,10001) -- 非ivr回访
            and vrv.type in (1,2,3,4,5,6)
        group by 1

        union all

        select
            am.staff_info_id
            ,'投诉' type
            ,count(distinct if(acc.complaints_type = 2, acc.id, null)) 揽件虚假量
            ,count(distinct if(acc.complaints_type = 1, acc.id, null)) 妥投虚假量
            ,count(distinct if(acc.complaints_type = 3, acc.id, null)) 派件标记虚假量
        from ph_bi.abnormal_customer_complaint acc
        left join ph_bi.abnormal_message am on am.id = acc.abnormal_message_id
        where
            acc.state = 1
            and acc.updated_at >= date_sub(date_sub(curdate(), interval 1 day), interval 8 hour)
            and acc.updated_at < date_add(date_sub(curdate(), interval 1 day), interval 16 hour) -- 昨天
            and acc.complaints_type in (1,2,3)
            and acc.qaqc_callback_result in (3,4,5,6)
        group by 1
    ) a
where
    a.妥投虚假量 + a.妥投虚假量 + a.派件标记虚假量 > 0
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    a.staff_info_id
    ,sum(a.揽件虚假量) 虚假揽件量
    ,sum(a.妥投虚假量) 虚假妥投量
    ,sum(a.派件标记虚假量) 虚假派件标记量
from
    (
        select
        #     case vrv.type
        #         when 1 then '揽件任务异常取消'
        #         when 2 then '虚假妥投'
        #         when 3 then '收件人拒收'
        #         when 4 then '标记客户改约时间'
        #         when 5 then 'KA现场不揽收'
        #         when 6 then '包裹未准备好'
        #         when 7 then '上报错分未妥投'
        #         when 8 then '多次尝试派送失败'
        #     end 回访类型
            vrv.staff_info_id
            ,'回访' type
            ,count(distinct if(vrv.visit_result  in (6), vrv.link_id, null)) 妥投虚假量
            ,count(distinct if(vrv.visit_result in (18,8,19,20,21,31,32,22,23,24), vrv.link_id, null)) 派件标记虚假量
        #     ,count(distinct if(vrv.visit_result in (23,24), vrv.link_id, null)) 虚假改约量
            ,count(distinct if(vrv.visit_result in (37,39,3), vrv.link_id, null)) 揽件虚假量
        #     ,count(distinct if(vrv.visit_result in (39), vrv.link_id, null)) 虚假未准备好标记量
        #     ,count(distinct if(vrv.visit_result in (3), vrv.link_id, null)) 虚假取消揽件任务
        from nl_production.violation_return_visit vrv
        where
            vrv.visit_state = 4
            and vrv.updated_at >= date_sub(date_sub(curdate(), interval 1 day), interval 8 hour)
            and vrv.updated_at < date_add(date_sub(curdate(), interval 1 day), interval 16 hour) -- 昨天
            and vrv.visit_staff_id not in (10000,10001) -- 非ivr回访
            and vrv.type in (1,2,3,4,5,6)
            and vrv.visit_result in (6,18,8,19,20,21,31,32,22,23,24,37,39,3)
        group by 1

        union all

        select
            am.staff_info_id
            ,'投诉' type
            ,count(distinct if(acc.complaints_type = 2, acc.id, null)) 揽件虚假量
            ,count(distinct if(acc.complaints_type = 1, acc.id, null)) 妥投虚假量
            ,count(distinct if(acc.complaints_type = 3, acc.id, null)) 派件标记虚假量
        from ph_bi.abnormal_customer_complaint acc
        left join ph_bi.abnormal_message am on am.id = acc.abnormal_message_id
        where
            acc.state = 1
            and acc.updated_at >= date_sub(date_sub(curdate(), interval 1 day), interval 8 hour)
            and acc.updated_at < date_add(date_sub(curdate(), interval 1 day), interval 16 hour) -- 昨天
            and acc.complaints_type in (1,2,3)
            and acc.qaqc_callback_result in (3,4,5,6)
        group by 1
    ) a
group by 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-17'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 10
                    or (t1.total =  5 and t1.leave_time_type = 2)

                union all

                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 5
                    and t1.leave_time_type = 1 -- 上午请假
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-17'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 10
                                    or (t1.total =  5 and t1.leave_time_type = 2)

                                union all

                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 5
                                    and t1.leave_time_type = 1 -- 上午请假
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-09-17', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with d as
    (
        select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-09-17'
    )
    , t as
    (
        select
             ds.store_id
            ,ds.pno
            ,ds.stat_date
        from d ds
        left join
            (
                select
                    pr.pno
                    ,ds.stat_date
                    ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
                from ph_staging.parcel_route pr
                join d ds on pr.pno = ds.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                    and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and pr.marker_category in (42,43) ##岛屿,偏远地区
                group by 1,2
            ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
        left join
            (
                select
                   pr.pno
                    ,ds.stat_date
                   ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
                   ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
                from ph_staging.parcel_route pr
                join d ds on ds.pno = pr.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                    and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                    and pr.marker_category in (9,14,70) ##客户改约时间
            ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
        left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
        where
            case
                when pr1.pno is not null then 'N'
                when pr2.pno is not null then 'N'
                when ds1.pno is not null  then 'N'  else 'Y'
            end = 'Y'
    )
    select
        a.stat_date 日期
        ,a.store_id 网点ID
        ,dp.store_name 网点名称
        ,dp.opening_at 开业时间
        ,case
            when dp.region_name in ('Area3', 'Area6') then '彭万松'
            when dp.region_name in ('Area4', 'Area9') then '韩钥'
            when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
            when dp.region_name in ( 'Area8') then '黄勇'
            when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
        end 区域
        ,dp.region_name 大区
        ,dp.piece_name 片区
        ,a.应交接
        ,a.已交接
        ,concat(round(a.交接率*100,2),'%') as 交接率
        ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
        ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
        ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
        ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
        ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
    from
        (
            select
                t1.store_id
                ,t1.stat_date
                ,count(t1.pno) 应交接
                ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
            from t t1
            left join
                (
                    select
                        sc.*
                    from
                        (
                            select
                                pr.pno
                                ,pr.store_id
                                ,pr.store_name
                                ,t1.stat_date
                                ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                            from ph_staging.parcel_route pr
                            join t t1 on t1.pno = pr.pno
                            where
                                pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                               and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                              and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                        ) sc
                    where
                        sc.rk = 1
                ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
            group by 1,2
        ) a
    join
        (
            select
                sd.store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.store_id is not null
            group by 1

            union all

            select
                sd.separation_store_id store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.separation_store_id is not null
            group by 1
        ) sd on sd.store_id = a.store_id
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    where
        dp.store_category in (1,10);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-17'
        and pr.routed_at >= date_sub('2023-09-17', interval 8 hour )
        and pr.routed_at < date_add('2023-09-17', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,if(a3.self_staff_num + other_staff_num > coalesce(sdb.code_num, 0),
           case
            when a2.avg_staff_code < 2 then 'A'
            when a2.avg_staff_code >= 2 and a2.avg_staff_code < 3 then 'B'
            when a2.avg_staff_code >= 3 and a2.avg_staff_code < 4 then 'C'
            when a2.avg_staff_code >= 4 then 'D'
        end,
           case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end ) 评级
#         ,a2.code_num
#         ,a2.staff_code_num
#         ,a2.staff_num
#         ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) avg_staff_code
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
            ,count(distinct sdb.district_code) barangay_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-17'
        and pr.routed_at >= date_sub('2023-09-17', interval 8 hour )
        and pr.routed_at < date_add('2023-09-17', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)

select
    a1.store_id
    ,ss.name 网点
    ,ss2.staff_count 交接员工数
    ,sdb.code_num 网点现有三段码数
    ,if(ss2.staff_count > sdb.code_num, '人比码多', '码比人多') 人码对比
    ,sdb.barangay_num 网点绑定三段码barangay数
    ,a1.third_sorting_code
#     ,if(a1.is_self = 'y', '本网点', '非本网点') 员工归属
#     ,hjt.job_name 岗位
    ,count(distinct a1.staff_info_id) 交接三段码数
    ,group_concat(distinct a1.staff_info_id) 交接三段码
from
    (
        select
            a1.*
        from
            (
                select
                    t1.store_id
                    ,t1.pno
                    ,t1.staff_info_id
                    ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                    ,t1.state
                    ,t1.job_title
                    ,ps.third_sorting_code
                    ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                from t t1
                join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
            ) a1
        where
            a1.rk = 1
    ) a1
left join ph_staging.sys_store ss on ss.id = a1.store_id
left join ph_bi.hr_job_title hjt on hjt.id = a1.job_title
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
            ,count(distinct sdb.district_code) barangay_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a1.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.staff_info_id) staff_count
        from t t1
        where
            t1.job_title in (13,110,1000)
        group by 1
    ) ss2 on ss2.store_id = a1.store_id
where
    a1.job_title in (13,110,1000) -- 快递员
group by 1,2,3,4,5,6,7;
;-- -. . -..- - / . -. - .-. -.--
select
    case
        when a.del_rate < 0.4 then '<40%'
        when a.del_rate >= 0.4 and a.del_rate < 0.5 then '40%-50%'
        when a.del_rate >= 0.5 and a.del_rate < 0.6 then '50%-60%'
        when a.del_rate >= 0.6 and a.del_rate < 0.7 then '60%-70%'
        when a.del_rate >= 0.7 and a.del_rate < 0.8 then '70%-80%'
        when a.del_rate >= 0.8 and a.del_rate <= 1 then '80%-100%'
    end 妥投率
    ,count(distinct a.网点ID) 总数
    ,count(distinct if(a.一派有效分拣评级 = 'A', a.网点ID, null))/count(distinct a.网点ID) 评级A
    ,count(distinct if(a.一派有效分拣评级 = 'B', a.网点ID, null))/count(distinct a.网点ID) 评级B
    ,count(distinct if(a.一派有效分拣评级 = 'C', a.网点ID, null))/count(distinct a.网点ID) 评级C
    ,count(distinct if(a.一派有效分拣评级 = 'D', a.网点ID, null))/count(distinct a.网点ID) 评级D
    ,count(distinct if(a.一派有效分拣评级 = 'E', a.网点ID, null))/count(distinct a.网点ID) 评级E
    ,count(distinct if(a.一派有效分拣评级 = 'A', a.网点ID, null)) 评级A数量
    ,count(distinct if(a.一派有效分拣评级 = 'B', a.网点ID, null)) 评级B数量
    ,count(distinct if(a.一派有效分拣评级 = 'C', a.网点ID, null)) 评级C数量
    ,count(distinct if(a.一派有效分拣评级 = 'D', a.网点ID, null)) 评级D数量
    ,count(distinct if(a.一派有效分拣评级 = 'E', a.网点ID, null)) 评级E数量
from
    (

        select -- 基于当日应派取扫描率
            tt.store_id 网点ID
            ,tt.store_name 网点名称
            ,tt.store_type 网点分类
            ,tt.piece_name 片区
            ,tt.region_name 大区
            ,tt.shoud_counts 应派总数
            ,tt.scan_fished_counts 分拣扫描数
            ,ifnull(tt.scan_fished_counts/shoud_counts,0) 分拣扫描率

            ,tt.youxiao_counts 有效分拣扫描数
            ,ifnull(tt.youxiao_counts/tt.shoud_counts,0) 有效分拣扫描率

            ,tt.1pai_counts 一派应派数
            ,tt.1pai_scan_fished_counts 一派分拣扫描数
            ,ifnull(tt.1pai_scan_fished_counts/tt.1pai_counts,0) 一派分拣扫描率

            ,tt.1pai_youxiao_counts 一派有效分拣扫描数
            ,ifnull(tt.1pai_youxiao_counts/tt.1pai_counts,0) 一派有效分拣扫描率

            ,case
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.95 then 'A'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.90 then 'B'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.85 then 'C'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.80 then 'D'
                else 'E'
             end 一派有效分拣评级 -- 一派有效分拣

             ,case
                when tt.1pai_hour_8_fished_counts/tt.1pai_counts>=0.95  then 'A'
                when tt.1pai_hour_8ban_fished_counts/tt.1pai_counts>=0.95  then 'B'
                when tt.1pai_hour_9_fished_counts/tt.1pai_counts>=0.95  then 'C'
                when tt.1pai_hour_9ban_fished_counts/tt.1pai_counts>=0.95  then 'D'
                else 'E'
            end 一派分拣评级

            ,ifnull(tt.1pai_hour_8_fished_counts/tt.1pai_counts,0) 一派8点前扫描占比
            ,ifnull(tt.1pai_hour_8ban_fished_counts/tt.1pai_counts,0) 一派8点半前扫描占比
            ,ifnull(tt.1pai_hour_9_fished_counts/tt.1pai_counts,0) 一派9点前扫描占比
            ,ifnull(tt.1pai_hour_9ban_fished_counts/tt.1pai_counts,0) 一派9点半前扫描占比
            ,if(tt2.late_proof_counts is null , '否', '是') 是否有迟到超过规划时间20分钟的常规车
            ,tt2.max_real_arrive_time_normal 一派常规车最晚实际到达时间
        #     ,tt2.max_real_arrive_proof_id 一派常规车最晚实际到达车线
        #     ,tt2.max_real_arrive_vol 一派常规车最晚实际到达车线包裹量
            ,tt2.line_1_latest_plan_arrive_time 一派常规车最晚规划到达时间
            ,tt2.max_real_arrive_time_innormal 一派加班车最晚实际到达时间
        #     ,tt2.max_real_arrive_innormal_proof_id  一派加班车最晚实际到达车线
        #     ,tt2.max_real_arrive_innormal_vol  一派加班车最晚实际到达包裹量
            ,tt2.max_actual_plan_arrive_time_innormal 一派加班车最晚规划到达时间
            ,del.del_rate
            ,del.pno_num
            ,del.del_pno_num
        from
            (
                select
                   base.store_id
                   ,base.store_name
                   ,base.store_type
                   ,base.piece_name
                   ,base.region_name
                   ,count(distinct base.pno) shoud_counts
                   ,count(distinct case when base.min_fenjian_scan_time is not null then base.pno else null end ) scan_fished_counts
                   ,count(distinct case when base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then base.pno else null end ) youxiao_counts

                   ,count(distinct case when base.type='一派' then  base.pno else null end ) 1pai_counts
                   ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null then  base.pno else null end ) 1pai_scan_fished_counts
                   ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then  base.pno else null end ) 1pai_youxiao_counts

                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:00:00' then base.pno else null end) 1pai_hour_8_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:30:00' then base.pno else null end) 1pai_hour_8ban_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:00:00' then base.pno else null end) 1pai_hour_9_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:30:00' then base.pno else null end) 1pai_hour_9ban_fished_counts

                from
                (
                   select
                   t.*,
                   case when t.should_delevry_type='1派应派包裹' then '一派' else null end 'type'
                   from dwm.dwd_ph_dc_should_be_delivery_sort_scan t
                   join ph_staging.sys_store ss
                   on t.store_id =ss.id
                ) base
                group by base.store_id,base.store_name,base.store_type,base.piece_name,base.region_name
            ) tt

        left join
            (
                select
                   bl.store_id
                   ,bl.max_real_arrive_time_normal
                   ,bl.max_real_arrive_proof_id
                   ,bl.max_real_arrive_vol
                   ,bl.line_1_latest_plan_arrive_time
                   ,bl.max_actual_plan_arrive_time_innormal
                   ,bl.max_actual_plan_arrive_innormal_proof_id
                   ,bl.max_actual_plan_arrive_innormal_vol
                   ,bl.max_real_arrive_time_innormal
                   ,bl.max_real_arrive_innormal_proof_id
                   ,bl.max_real_arrive_innormal_vol
                   ,late_proof_counts
                from dwm.fleet_real_detail_today bl
                group by 1,2,3,4,5,6,7,8,9,10,11
            ) tt2 on tt.store_id=tt2.store_id
        left join
            (
                select
                    ds.dst_store_id
                    ,count(distinct ds.pno) pno_num
                    ,count(if(pi.pno is not null, ds.pno, null)) del_pno_num
                    ,count(if(pi.pno is not null, ds.pno, null))/count(distinct ds.pno) del_rate
                from dwm.dwd_ph_dc_should_be_delivery ds
                left join ph_staging.parcel_info pi on pi.pno = ds.pno and pi.state = 5 and pi.finished_at >= date_sub('2023-09-17', interval 8 hour ) and pi.finished_at < date_add('2023-09-17', interval 16 hour)
                where
                    ds.p_date = '2023-09-17'
                    and ds.should_delevry_type != '非当日应派'
                group by 1
            ) del on del.dst_store_id = tt.store_id
    ) a
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    case
        when a.一派9点半前扫描占比 < 0.4 then '<40%'
        when a.一派9点半前扫描占比 >= 0.4 and a.一派9点半前扫描占比 < 0.5 then '40%-50%'
        when a.一派9点半前扫描占比 >= 0.5 and a.一派9点半前扫描占比 < 0.6 then '50%-60%'
        when a.一派9点半前扫描占比 >= 0.6 and a.一派9点半前扫描占比 < 0.7 then '60%-70%'
        when a.一派9点半前扫描占比 >= 0.7 and a.一派9点半前扫描占比 < 0.8 then '70%-80%'
        when a.一派9点半前扫描占比 >= 0.8 and a.一派9点半前扫描占比 < 0.9 then '80%-90%'
        when a.del_rate >= 0.9 and a.del_rate <= 1 then '90%-100%'
    end 0930前分拣扫描占比
    ,count(distinct a.网点ID) 总数
    ,sum(a.del_pno_num)/sum(a.pno_num) 妥投率
from
    (

        select -- 基于当日应派取扫描率
            tt.store_id 网点ID
            ,tt.store_name 网点名称
            ,tt.store_type 网点分类
            ,tt.piece_name 片区
            ,tt.region_name 大区
            ,tt.shoud_counts 应派总数
            ,tt.scan_fished_counts 分拣扫描数
            ,ifnull(tt.scan_fished_counts/shoud_counts,0) 分拣扫描率

            ,tt.youxiao_counts 有效分拣扫描数
            ,ifnull(tt.youxiao_counts/tt.shoud_counts,0) 有效分拣扫描率

            ,tt.1pai_counts 一派应派数
            ,tt.1pai_scan_fished_counts 一派分拣扫描数
            ,ifnull(tt.1pai_scan_fished_counts/tt.1pai_counts,0) 一派分拣扫描率

            ,tt.1pai_youxiao_counts 一派有效分拣扫描数
            ,ifnull(tt.1pai_youxiao_counts/tt.1pai_counts,0) 一派有效分拣扫描率

            ,case
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.95 then 'A'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.90 then 'B'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.85 then 'C'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.80 then 'D'
                else 'E'
             end 一派有效分拣评级 -- 一派有效分拣

             ,case
                when tt.1pai_hour_8_fished_counts/tt.1pai_counts>=0.95  then 'A'
                when tt.1pai_hour_8ban_fished_counts/tt.1pai_counts>=0.95  then 'B'
                when tt.1pai_hour_9_fished_counts/tt.1pai_counts>=0.95  then 'C'
                when tt.1pai_hour_9ban_fished_counts/tt.1pai_counts>=0.95  then 'D'
                else 'E'
            end 一派分拣评级

            ,ifnull(tt.1pai_hour_8_fished_counts/tt.1pai_counts,0) 一派8点前扫描占比
            ,ifnull(tt.1pai_hour_8ban_fished_counts/tt.1pai_counts,0) 一派8点半前扫描占比
            ,ifnull(tt.1pai_hour_9_fished_counts/tt.1pai_counts,0) 一派9点前扫描占比
            ,ifnull(tt.1pai_hour_9ban_fished_counts/tt.1pai_counts,0) 一派9点半前扫描占比
            ,if(tt2.late_proof_counts is null , '否', '是') 是否有迟到超过规划时间20分钟的常规车
            ,tt2.max_real_arrive_time_normal 一派常规车最晚实际到达时间
        #     ,tt2.max_real_arrive_proof_id 一派常规车最晚实际到达车线
        #     ,tt2.max_real_arrive_vol 一派常规车最晚实际到达车线包裹量
            ,tt2.line_1_latest_plan_arrive_time 一派常规车最晚规划到达时间
            ,tt2.max_real_arrive_time_innormal 一派加班车最晚实际到达时间
        #     ,tt2.max_real_arrive_innormal_proof_id  一派加班车最晚实际到达车线
        #     ,tt2.max_real_arrive_innormal_vol  一派加班车最晚实际到达包裹量
            ,tt2.max_actual_plan_arrive_time_innormal 一派加班车最晚规划到达时间
            ,del.del_rate
            ,del.pno_num
            ,del.del_pno_num
        from
            (
                select
                   base.store_id
                   ,base.store_name
                   ,base.store_type
                   ,base.piece_name
                   ,base.region_name
                   ,count(distinct base.pno) shoud_counts
                   ,count(distinct case when base.min_fenjian_scan_time is not null then base.pno else null end ) scan_fished_counts
                   ,count(distinct case when base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then base.pno else null end ) youxiao_counts

                   ,count(distinct case when base.type='一派' then  base.pno else null end ) 1pai_counts
                   ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null then  base.pno else null end ) 1pai_scan_fished_counts
                   ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then  base.pno else null end ) 1pai_youxiao_counts

                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:00:00' then base.pno else null end) 1pai_hour_8_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:30:00' then base.pno else null end) 1pai_hour_8ban_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:00:00' then base.pno else null end) 1pai_hour_9_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:30:00' then base.pno else null end) 1pai_hour_9ban_fished_counts

                from
                (
                   select
                   t.*,
                   case when t.should_delevry_type='1派应派包裹' then '一派' else null end 'type'
                   from dwm.dwd_ph_dc_should_be_delivery_sort_scan t
                   join ph_staging.sys_store ss
                   on t.store_id =ss.id
                ) base
                group by base.store_id,base.store_name,base.store_type,base.piece_name,base.region_name
            ) tt

        left join
            (
                select
                   bl.store_id
                   ,bl.max_real_arrive_time_normal
                   ,bl.max_real_arrive_proof_id
                   ,bl.max_real_arrive_vol
                   ,bl.line_1_latest_plan_arrive_time
                   ,bl.max_actual_plan_arrive_time_innormal
                   ,bl.max_actual_plan_arrive_innormal_proof_id
                   ,bl.max_actual_plan_arrive_innormal_vol
                   ,bl.max_real_arrive_time_innormal
                   ,bl.max_real_arrive_innormal_proof_id
                   ,bl.max_real_arrive_innormal_vol
                   ,late_proof_counts
                from dwm.fleet_real_detail_today bl
                group by 1,2,3,4,5,6,7,8,9,10,11
            ) tt2 on tt.store_id=tt2.store_id
        left join
            (
                select
                    ds.dst_store_id
                    ,count(distinct ds.pno) pno_num
                    ,count(if(pi.pno is not null, ds.pno, null)) del_pno_num
                    ,count(if(pi.pno is not null, ds.pno, null))/count(distinct ds.pno) del_rate
                from dwm.dwd_ph_dc_should_be_delivery ds
                left join ph_staging.parcel_info pi on pi.pno = ds.pno and pi.state = 5 and pi.finished_at >= date_sub('2023-09-17', interval 8 hour ) and pi.finished_at < date_add('2023-09-17', interval 16 hour)
                where
                    ds.p_date = '2023-09-17'
                    and ds.should_delevry_type != '非当日应派'
                group by 1
            ) del on del.dst_store_id = tt.store_id
    ) a
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    a.负责人
    ,a.大区
    ,count(distinct a.网点ID) 总网点数
    ,count(distinct if(a.一派9点半前扫描占比 < 0.8, a.网点ID, null)) 问题网点数
    ,count(distinct if(a.一派9点半前扫描占比 < 0.8, a.网点ID, null))/count(distinct a.网点ID)  问题比例
from
    (

        select -- 基于当日应派取扫描率
            tt.store_id 网点ID
            ,tt.store_name 网点名称
            ,tt.store_type 网点分类
            ,tt.piece_name 片区
            ,tt.region_name 大区
            ,case
                when tt.region_name in ('Area3', 'Area6') then '彭万松'
                when tt.region_name in ('Area4', 'Area9') then '韩钥'
                when tt.region_name in ('Area7','Area10', 'Area11','FHome','Area14') then '张可新'
                when tt.region_name in ('Area8') then '黄勇'
                when tt.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
            end 负责人
            ,tt.shoud_counts 应派总数
            ,tt.scan_fished_counts 分拣扫描数
            ,ifnull(tt.scan_fished_counts/shoud_counts,0) 分拣扫描率

            ,tt.youxiao_counts 有效分拣扫描数
            ,ifnull(tt.youxiao_counts/tt.shoud_counts,0) 有效分拣扫描率

            ,tt.1pai_counts 一派应派数
            ,tt.1pai_scan_fished_counts 一派分拣扫描数
            ,ifnull(tt.1pai_scan_fished_counts/tt.1pai_counts,0) 一派分拣扫描率

            ,tt.1pai_youxiao_counts 一派有效分拣扫描数
            ,ifnull(tt.1pai_youxiao_counts/tt.1pai_counts,0) 一派有效分拣扫描率

            ,case
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.95 then 'A'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.90 then 'B'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.85 then 'C'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.80 then 'D'
                else 'E'
             end 一派有效分拣评级 -- 一派有效分拣

             ,case
                when tt.1pai_hour_8_fished_counts/tt.1pai_counts>=0.95  then 'A'
                when tt.1pai_hour_8ban_fished_counts/tt.1pai_counts>=0.95  then 'B'
                when tt.1pai_hour_9_fished_counts/tt.1pai_counts>=0.95  then 'C'
                when tt.1pai_hour_9ban_fished_counts/tt.1pai_counts>=0.95  then 'D'
                else 'E'
            end 一派分拣评级

            ,ifnull(tt.1pai_hour_8_fished_counts/tt.1pai_counts,0) 一派8点前扫描占比
            ,ifnull(tt.1pai_hour_8ban_fished_counts/tt.1pai_counts,0) 一派8点半前扫描占比
            ,ifnull(tt.1pai_hour_9_fished_counts/tt.1pai_counts,0) 一派9点前扫描占比
            ,ifnull(tt.1pai_hour_9ban_fished_counts/tt.1pai_counts,0) 一派9点半前扫描占比
            ,if(tt2.late_proof_counts is null , '否', '是') 是否有迟到超过规划时间20分钟的常规车
            ,tt2.max_real_arrive_time_normal 一派常规车最晚实际到达时间
        #     ,tt2.max_real_arrive_proof_id 一派常规车最晚实际到达车线
        #     ,tt2.max_real_arrive_vol 一派常规车最晚实际到达车线包裹量
            ,tt2.line_1_latest_plan_arrive_time 一派常规车最晚规划到达时间
            ,tt2.max_real_arrive_time_innormal 一派加班车最晚实际到达时间
        #     ,tt2.max_real_arrive_innormal_proof_id  一派加班车最晚实际到达车线
        #     ,tt2.max_real_arrive_innormal_vol  一派加班车最晚实际到达包裹量
            ,tt2.max_actual_plan_arrive_time_innormal 一派加班车最晚规划到达时间
            ,del.del_rate
            ,del.pno_num
            ,del.del_pno_num
        from
            (
                select
                   base.store_id
                   ,base.store_name
                   ,base.store_type
                   ,base.piece_name
                   ,base.region_name
                   ,count(distinct base.pno) shoud_counts
                   ,count(distinct case when base.min_fenjian_scan_time is not null then base.pno else null end ) scan_fished_counts
                   ,count(distinct case when base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then base.pno else null end ) youxiao_counts

                   ,count(distinct case when base.type='一派' then  base.pno else null end ) 1pai_counts
                   ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null then  base.pno else null end ) 1pai_scan_fished_counts
                   ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then  base.pno else null end ) 1pai_youxiao_counts

                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:00:00' then base.pno else null end) 1pai_hour_8_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:30:00' then base.pno else null end) 1pai_hour_8ban_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:00:00' then base.pno else null end) 1pai_hour_9_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:30:00' then base.pno else null end) 1pai_hour_9ban_fished_counts

                from
                (
                   select
                   t.*,
                   case when t.should_delevry_type='1派应派包裹' then '一派' else null end 'type'
                   from dwm.dwd_ph_dc_should_be_delivery_sort_scan t
                   join ph_staging.sys_store ss
                   on t.store_id =ss.id
                ) base
                group by base.store_id,base.store_name,base.store_type,base.piece_name,base.region_name
            ) tt

        left join
            (
                select
                   bl.store_id
                   ,bl.max_real_arrive_time_normal
                   ,bl.max_real_arrive_proof_id
                   ,bl.max_real_arrive_vol
                   ,bl.line_1_latest_plan_arrive_time
                   ,bl.max_actual_plan_arrive_time_innormal
                   ,bl.max_actual_plan_arrive_innormal_proof_id
                   ,bl.max_actual_plan_arrive_innormal_vol
                   ,bl.max_real_arrive_time_innormal
                   ,bl.max_real_arrive_innormal_proof_id
                   ,bl.max_real_arrive_innormal_vol
                   ,late_proof_counts
                from dwm.fleet_real_detail_today bl
                group by 1,2,3,4,5,6,7,8,9,10,11
            ) tt2 on tt.store_id=tt2.store_id
        left join
            (
                select
                    ds.dst_store_id
                    ,count(distinct ds.pno) pno_num
                    ,count(if(pi.pno is not null, ds.pno, null)) del_pno_num
                    ,count(if(pi.pno is not null, ds.pno, null))/count(distinct ds.pno) del_rate
                from dwm.dwd_ph_dc_should_be_delivery ds
                left join ph_staging.parcel_info pi on pi.pno = ds.pno and pi.state = 5 and pi.finished_at >= date_sub('2023-09-17', interval 8 hour ) and pi.finished_at < date_add('2023-09-17', interval 16 hour)
                where
                    ds.p_date = '2023-09-17'
                    and ds.should_delevry_type != '非当日应派'
                group by 1
            ) del on del.dst_store_id = tt.store_id
    ) a
group by 1,2;
;-- -. . -..- - / . -. - .-. -.--
select
    a.负责人
#     ,a.大区
    ,count(distinct a.网点ID) 总网点数
    ,count(distinct if(a.一派9点半前扫描占比 < 0.8, a.网点ID, null)) 问题网点数
    ,count(distinct if(a.一派9点半前扫描占比 < 0.8, a.网点ID, null))/count(distinct a.网点ID)  问题比例
from
    (

        select -- 基于当日应派取扫描率
            tt.store_id 网点ID
            ,tt.store_name 网点名称
            ,tt.store_type 网点分类
            ,tt.piece_name 片区
            ,tt.region_name 大区
            ,case
                when tt.region_name in ('Area3', 'Area6') then '彭万松'
                when tt.region_name in ('Area4', 'Area9') then '韩钥'
                when tt.region_name in ('Area7','Area10', 'Area11','FHome','Area14') then '张可新'
                when tt.region_name in ('Area8') then '黄勇'
                when tt.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
            end 负责人
            ,tt.shoud_counts 应派总数
            ,tt.scan_fished_counts 分拣扫描数
            ,ifnull(tt.scan_fished_counts/shoud_counts,0) 分拣扫描率

            ,tt.youxiao_counts 有效分拣扫描数
            ,ifnull(tt.youxiao_counts/tt.shoud_counts,0) 有效分拣扫描率

            ,tt.1pai_counts 一派应派数
            ,tt.1pai_scan_fished_counts 一派分拣扫描数
            ,ifnull(tt.1pai_scan_fished_counts/tt.1pai_counts,0) 一派分拣扫描率

            ,tt.1pai_youxiao_counts 一派有效分拣扫描数
            ,ifnull(tt.1pai_youxiao_counts/tt.1pai_counts,0) 一派有效分拣扫描率

            ,case
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.95 then 'A'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.90 then 'B'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.85 then 'C'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.80 then 'D'
                else 'E'
             end 一派有效分拣评级 -- 一派有效分拣

             ,case
                when tt.1pai_hour_8_fished_counts/tt.1pai_counts>=0.95  then 'A'
                when tt.1pai_hour_8ban_fished_counts/tt.1pai_counts>=0.95  then 'B'
                when tt.1pai_hour_9_fished_counts/tt.1pai_counts>=0.95  then 'C'
                when tt.1pai_hour_9ban_fished_counts/tt.1pai_counts>=0.95  then 'D'
                else 'E'
            end 一派分拣评级

            ,ifnull(tt.1pai_hour_8_fished_counts/tt.1pai_counts,0) 一派8点前扫描占比
            ,ifnull(tt.1pai_hour_8ban_fished_counts/tt.1pai_counts,0) 一派8点半前扫描占比
            ,ifnull(tt.1pai_hour_9_fished_counts/tt.1pai_counts,0) 一派9点前扫描占比
            ,ifnull(tt.1pai_hour_9ban_fished_counts/tt.1pai_counts,0) 一派9点半前扫描占比
            ,if(tt2.late_proof_counts is null , '否', '是') 是否有迟到超过规划时间20分钟的常规车
            ,tt2.max_real_arrive_time_normal 一派常规车最晚实际到达时间
        #     ,tt2.max_real_arrive_proof_id 一派常规车最晚实际到达车线
        #     ,tt2.max_real_arrive_vol 一派常规车最晚实际到达车线包裹量
            ,tt2.line_1_latest_plan_arrive_time 一派常规车最晚规划到达时间
            ,tt2.max_real_arrive_time_innormal 一派加班车最晚实际到达时间
        #     ,tt2.max_real_arrive_innormal_proof_id  一派加班车最晚实际到达车线
        #     ,tt2.max_real_arrive_innormal_vol  一派加班车最晚实际到达包裹量
            ,tt2.max_actual_plan_arrive_time_innormal 一派加班车最晚规划到达时间
            ,del.del_rate
            ,del.pno_num
            ,del.del_pno_num
        from
            (
                select
                   base.store_id
                   ,base.store_name
                   ,base.store_type
                   ,base.piece_name
                   ,base.region_name
                   ,count(distinct base.pno) shoud_counts
                   ,count(distinct case when base.min_fenjian_scan_time is not null then base.pno else null end ) scan_fished_counts
                   ,count(distinct case when base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then base.pno else null end ) youxiao_counts

                   ,count(distinct case when base.type='一派' then  base.pno else null end ) 1pai_counts
                   ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null then  base.pno else null end ) 1pai_scan_fished_counts
                   ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then  base.pno else null end ) 1pai_youxiao_counts

                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:00:00' then base.pno else null end) 1pai_hour_8_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:30:00' then base.pno else null end) 1pai_hour_8ban_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:00:00' then base.pno else null end) 1pai_hour_9_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:30:00' then base.pno else null end) 1pai_hour_9ban_fished_counts

                from
                (
                   select
                   t.*,
                   case when t.should_delevry_type='1派应派包裹' then '一派' else null end 'type'
                   from dwm.dwd_ph_dc_should_be_delivery_sort_scan t
                   join ph_staging.sys_store ss
                   on t.store_id =ss.id
                ) base
                group by base.store_id,base.store_name,base.store_type,base.piece_name,base.region_name
            ) tt

        left join
            (
                select
                   bl.store_id
                   ,bl.max_real_arrive_time_normal
                   ,bl.max_real_arrive_proof_id
                   ,bl.max_real_arrive_vol
                   ,bl.line_1_latest_plan_arrive_time
                   ,bl.max_actual_plan_arrive_time_innormal
                   ,bl.max_actual_plan_arrive_innormal_proof_id
                   ,bl.max_actual_plan_arrive_innormal_vol
                   ,bl.max_real_arrive_time_innormal
                   ,bl.max_real_arrive_innormal_proof_id
                   ,bl.max_real_arrive_innormal_vol
                   ,late_proof_counts
                from dwm.fleet_real_detail_today bl
                group by 1,2,3,4,5,6,7,8,9,10,11
            ) tt2 on tt.store_id=tt2.store_id
        left join
            (
                select
                    ds.dst_store_id
                    ,count(distinct ds.pno) pno_num
                    ,count(if(pi.pno is not null, ds.pno, null)) del_pno_num
                    ,count(if(pi.pno is not null, ds.pno, null))/count(distinct ds.pno) del_rate
                from dwm.dwd_ph_dc_should_be_delivery ds
                left join ph_staging.parcel_info pi on pi.pno = ds.pno and pi.state = 5 and pi.finished_at >= date_sub('2023-09-17', interval 8 hour ) and pi.finished_at < date_add('2023-09-17', interval 16 hour)
                where
                    ds.p_date = '2023-09-17'
                    and ds.should_delevry_type != '非当日应派'
                group by 1
            ) del on del.dst_store_id = tt.store_id
    ) a
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    a.负责人
    ,a.大区
    ,count(distinct a.网点ID) 总网点数
    ,count(distinct if(a.一派有效分拣评级 = 'E', a.网点ID, null)) 问题网点数
    ,count(distinct if(a.一派有效分拣评级 = 'E', a.网点ID, null))/count(distinct a.网点ID)  问题比例
from
    (

        select -- 基于当日应派取扫描率
            tt.store_id 网点ID
            ,tt.store_name 网点名称
            ,tt.store_type 网点分类
            ,tt.piece_name 片区
            ,tt.region_name 大区
            ,case
                when tt.region_name in ('Area3', 'Area6') then '彭万松'
                when tt.region_name in ('Area4', 'Area9') then '韩钥'
                when tt.region_name in ('Area7','Area10', 'Area11','FHome','Area14') then '张可新'
                when tt.region_name in ('Area8') then '黄勇'
                when tt.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
            end 负责人
            ,tt.shoud_counts 应派总数
            ,tt.scan_fished_counts 分拣扫描数
            ,ifnull(tt.scan_fished_counts/shoud_counts,0) 分拣扫描率

            ,tt.youxiao_counts 有效分拣扫描数
            ,ifnull(tt.youxiao_counts/tt.shoud_counts,0) 有效分拣扫描率

            ,tt.1pai_counts 一派应派数
            ,tt.1pai_scan_fished_counts 一派分拣扫描数
            ,ifnull(tt.1pai_scan_fished_counts/tt.1pai_counts,0) 一派分拣扫描率

            ,tt.1pai_youxiao_counts 一派有效分拣扫描数
            ,ifnull(tt.1pai_youxiao_counts/tt.1pai_counts,0) 一派有效分拣扫描率

            ,case
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.95 then 'A'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.90 then 'B'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.85 then 'C'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.80 then 'D'
                else 'E'
             end 一派有效分拣评级 -- 一派有效分拣

             ,case
                when tt.1pai_hour_8_fished_counts/tt.1pai_counts>=0.95  then 'A'
                when tt.1pai_hour_8ban_fished_counts/tt.1pai_counts>=0.95  then 'B'
                when tt.1pai_hour_9_fished_counts/tt.1pai_counts>=0.95  then 'C'
                when tt.1pai_hour_9ban_fished_counts/tt.1pai_counts>=0.95  then 'D'
                else 'E'
            end 一派分拣评级

            ,ifnull(tt.1pai_hour_8_fished_counts/tt.1pai_counts,0) 一派8点前扫描占比
            ,ifnull(tt.1pai_hour_8ban_fished_counts/tt.1pai_counts,0) 一派8点半前扫描占比
            ,ifnull(tt.1pai_hour_9_fished_counts/tt.1pai_counts,0) 一派9点前扫描占比
            ,ifnull(tt.1pai_hour_9ban_fished_counts/tt.1pai_counts,0) 一派9点半前扫描占比
            ,if(tt2.late_proof_counts is null , '否', '是') 是否有迟到超过规划时间20分钟的常规车
            ,tt2.max_real_arrive_time_normal 一派常规车最晚实际到达时间
        #     ,tt2.max_real_arrive_proof_id 一派常规车最晚实际到达车线
        #     ,tt2.max_real_arrive_vol 一派常规车最晚实际到达车线包裹量
            ,tt2.line_1_latest_plan_arrive_time 一派常规车最晚规划到达时间
            ,tt2.max_real_arrive_time_innormal 一派加班车最晚实际到达时间
        #     ,tt2.max_real_arrive_innormal_proof_id  一派加班车最晚实际到达车线
        #     ,tt2.max_real_arrive_innormal_vol  一派加班车最晚实际到达包裹量
            ,tt2.max_actual_plan_arrive_time_innormal 一派加班车最晚规划到达时间
            ,del.del_rate
            ,del.pno_num
            ,del.del_pno_num
        from
            (
                select
                   base.store_id
                   ,base.store_name
                   ,base.store_type
                   ,base.piece_name
                   ,base.region_name
                   ,count(distinct base.pno) shoud_counts
                   ,count(distinct case when base.min_fenjian_scan_time is not null then base.pno else null end ) scan_fished_counts
                   ,count(distinct case when base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then base.pno else null end ) youxiao_counts

                   ,count(distinct case when base.type='一派' then  base.pno else null end ) 1pai_counts
                   ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null then  base.pno else null end ) 1pai_scan_fished_counts
                   ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then  base.pno else null end ) 1pai_youxiao_counts

                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:00:00' then base.pno else null end) 1pai_hour_8_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:30:00' then base.pno else null end) 1pai_hour_8ban_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:00:00' then base.pno else null end) 1pai_hour_9_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:30:00' then base.pno else null end) 1pai_hour_9ban_fished_counts

                from
                (
                   select
                   t.*,
                   case when t.should_delevry_type='1派应派包裹' then '一派' else null end 'type'
                   from dwm.dwd_ph_dc_should_be_delivery_sort_scan t
                   join ph_staging.sys_store ss
                   on t.store_id =ss.id
                ) base
                group by base.store_id,base.store_name,base.store_type,base.piece_name,base.region_name
            ) tt

        left join
            (
                select
                   bl.store_id
                   ,bl.max_real_arrive_time_normal
                   ,bl.max_real_arrive_proof_id
                   ,bl.max_real_arrive_vol
                   ,bl.line_1_latest_plan_arrive_time
                   ,bl.max_actual_plan_arrive_time_innormal
                   ,bl.max_actual_plan_arrive_innormal_proof_id
                   ,bl.max_actual_plan_arrive_innormal_vol
                   ,bl.max_real_arrive_time_innormal
                   ,bl.max_real_arrive_innormal_proof_id
                   ,bl.max_real_arrive_innormal_vol
                   ,late_proof_counts
                from dwm.fleet_real_detail_today bl
                group by 1,2,3,4,5,6,7,8,9,10,11
            ) tt2 on tt.store_id=tt2.store_id
        left join
            (
                select
                    ds.dst_store_id
                    ,count(distinct ds.pno) pno_num
                    ,count(if(pi.pno is not null, ds.pno, null)) del_pno_num
                    ,count(if(pi.pno is not null, ds.pno, null))/count(distinct ds.pno) del_rate
                from dwm.dwd_ph_dc_should_be_delivery ds
                left join ph_staging.parcel_info pi on pi.pno = ds.pno and pi.state = 5 and pi.finished_at >= date_sub('2023-09-17', interval 8 hour ) and pi.finished_at < date_add('2023-09-17', interval 16 hour)
                where
                    ds.p_date = '2023-09-17'
                    and ds.should_delevry_type != '非当日应派'
                group by 1
            ) del on del.dst_store_id = tt.store_id
    ) a
group by 1,2;
;-- -. . -..- - / . -. - .-. -.--
select
    a.负责人
#     ,a.大区
    ,count(distinct a.网点ID) 总网点数
    ,count(distinct if(a.一派有效分拣评级 = 'E', a.网点ID, null)) 问题网点数
    ,count(distinct if(a.一派有效分拣评级 = 'E', a.网点ID, null))/count(distinct a.网点ID)  问题比例
from
    (

        select -- 基于当日应派取扫描率
            tt.store_id 网点ID
            ,tt.store_name 网点名称
            ,tt.store_type 网点分类
            ,tt.piece_name 片区
            ,tt.region_name 大区
            ,case
                when tt.region_name in ('Area3', 'Area6') then '彭万松'
                when tt.region_name in ('Area4', 'Area9') then '韩钥'
                when tt.region_name in ('Area7','Area10', 'Area11','FHome','Area14') then '张可新'
                when tt.region_name in ('Area8') then '黄勇'
                when tt.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
            end 负责人
            ,tt.shoud_counts 应派总数
            ,tt.scan_fished_counts 分拣扫描数
            ,ifnull(tt.scan_fished_counts/shoud_counts,0) 分拣扫描率

            ,tt.youxiao_counts 有效分拣扫描数
            ,ifnull(tt.youxiao_counts/tt.shoud_counts,0) 有效分拣扫描率

            ,tt.1pai_counts 一派应派数
            ,tt.1pai_scan_fished_counts 一派分拣扫描数
            ,ifnull(tt.1pai_scan_fished_counts/tt.1pai_counts,0) 一派分拣扫描率

            ,tt.1pai_youxiao_counts 一派有效分拣扫描数
            ,ifnull(tt.1pai_youxiao_counts/tt.1pai_counts,0) 一派有效分拣扫描率

            ,case
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.95 then 'A'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.90 then 'B'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.85 then 'C'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.80 then 'D'
                else 'E'
             end 一派有效分拣评级 -- 一派有效分拣

             ,case
                when tt.1pai_hour_8_fished_counts/tt.1pai_counts>=0.95  then 'A'
                when tt.1pai_hour_8ban_fished_counts/tt.1pai_counts>=0.95  then 'B'
                when tt.1pai_hour_9_fished_counts/tt.1pai_counts>=0.95  then 'C'
                when tt.1pai_hour_9ban_fished_counts/tt.1pai_counts>=0.95  then 'D'
                else 'E'
            end 一派分拣评级

            ,ifnull(tt.1pai_hour_8_fished_counts/tt.1pai_counts,0) 一派8点前扫描占比
            ,ifnull(tt.1pai_hour_8ban_fished_counts/tt.1pai_counts,0) 一派8点半前扫描占比
            ,ifnull(tt.1pai_hour_9_fished_counts/tt.1pai_counts,0) 一派9点前扫描占比
            ,ifnull(tt.1pai_hour_9ban_fished_counts/tt.1pai_counts,0) 一派9点半前扫描占比
            ,if(tt2.late_proof_counts is null , '否', '是') 是否有迟到超过规划时间20分钟的常规车
            ,tt2.max_real_arrive_time_normal 一派常规车最晚实际到达时间
        #     ,tt2.max_real_arrive_proof_id 一派常规车最晚实际到达车线
        #     ,tt2.max_real_arrive_vol 一派常规车最晚实际到达车线包裹量
            ,tt2.line_1_latest_plan_arrive_time 一派常规车最晚规划到达时间
            ,tt2.max_real_arrive_time_innormal 一派加班车最晚实际到达时间
        #     ,tt2.max_real_arrive_innormal_proof_id  一派加班车最晚实际到达车线
        #     ,tt2.max_real_arrive_innormal_vol  一派加班车最晚实际到达包裹量
            ,tt2.max_actual_plan_arrive_time_innormal 一派加班车最晚规划到达时间
            ,del.del_rate
            ,del.pno_num
            ,del.del_pno_num
        from
            (
                select
                   base.store_id
                   ,base.store_name
                   ,base.store_type
                   ,base.piece_name
                   ,base.region_name
                   ,count(distinct base.pno) shoud_counts
                   ,count(distinct case when base.min_fenjian_scan_time is not null then base.pno else null end ) scan_fished_counts
                   ,count(distinct case when base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then base.pno else null end ) youxiao_counts

                   ,count(distinct case when base.type='一派' then  base.pno else null end ) 1pai_counts
                   ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null then  base.pno else null end ) 1pai_scan_fished_counts
                   ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then  base.pno else null end ) 1pai_youxiao_counts

                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:00:00' then base.pno else null end) 1pai_hour_8_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:30:00' then base.pno else null end) 1pai_hour_8ban_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:00:00' then base.pno else null end) 1pai_hour_9_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:30:00' then base.pno else null end) 1pai_hour_9ban_fished_counts

                from
                (
                   select
                   t.*,
                   case when t.should_delevry_type='1派应派包裹' then '一派' else null end 'type'
                   from dwm.dwd_ph_dc_should_be_delivery_sort_scan t
                   join ph_staging.sys_store ss
                   on t.store_id =ss.id
                ) base
                group by base.store_id,base.store_name,base.store_type,base.piece_name,base.region_name
            ) tt

        left join
            (
                select
                   bl.store_id
                   ,bl.max_real_arrive_time_normal
                   ,bl.max_real_arrive_proof_id
                   ,bl.max_real_arrive_vol
                   ,bl.line_1_latest_plan_arrive_time
                   ,bl.max_actual_plan_arrive_time_innormal
                   ,bl.max_actual_plan_arrive_innormal_proof_id
                   ,bl.max_actual_plan_arrive_innormal_vol
                   ,bl.max_real_arrive_time_innormal
                   ,bl.max_real_arrive_innormal_proof_id
                   ,bl.max_real_arrive_innormal_vol
                   ,late_proof_counts
                from dwm.fleet_real_detail_today bl
                group by 1,2,3,4,5,6,7,8,9,10,11
            ) tt2 on tt.store_id=tt2.store_id
        left join
            (
                select
                    ds.dst_store_id
                    ,count(distinct ds.pno) pno_num
                    ,count(if(pi.pno is not null, ds.pno, null)) del_pno_num
                    ,count(if(pi.pno is not null, ds.pno, null))/count(distinct ds.pno) del_rate
                from dwm.dwd_ph_dc_should_be_delivery ds
                left join ph_staging.parcel_info pi on pi.pno = ds.pno and pi.state = 5 and pi.finished_at >= date_sub('2023-09-17', interval 8 hour ) and pi.finished_at < date_add('2023-09-17', interval 16 hour)
                where
                    ds.p_date = '2023-09-17'
                    and ds.should_delevry_type != '非当日应派'
                group by 1
            ) del on del.dst_store_id = tt.store_id
    ) a
group by 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-09-17'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-09-17')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-09-17'
        and pi.finished_at >= date_sub('2023-09-17', interval 8 hour )
        and pi.finished_at < date_add('2023-09-17', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数

    ,coalesce(backlog.in_house_count, 0) 在仓包裹数
    ,coalesce(backlog.big_in_house_count, 0) 在仓大件包裹数
    ,coalesce(backlog.big_client_count, 0) 在仓平台客户包裹数
    ,coalesce(backlog.small_client_count, 0) 在仓非平台客户包裹数
    ,coalesce(backlog.3_within_backlog_bigclient, 0) 平台客户在仓积压3天内包裹数
    ,coalesce(backlog.3_5_backlog_bigclient, 0) 平台客户在仓积压3_5天内包裹数
    ,coalesce(backlog.5_more_backlog_bigclient, 0) 平台客户在仓积压5天以上包裹数
    ,coalesce(backlog.tt_overtime_count, 0) tiktok超时效包裹数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-09-17'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) in_house_count
            ,count(distinct if(pi.exhibition_weight > 5000 or pi.exhibition_length + pi.exhibition_width + pi.exhibition_height > 80, ds.pno, null)) big_in_house_count
            ,count(distinct if(bc.client_id is not null, ds.pno, null)) big_client_count
            ,count(distinct if(bc.client_id is null, ds.pno, null)) small_client_count
            ,count(distinct if(datediff(now(), ds.first_valid_routed_at) <= 3 and bc.client_id is not null, ds.pno, null)) 3_within_backlog_bigclient
            ,count(distinct if(datediff(now(), ds.first_valid_routed_at) > 3 and datediff(now(), ds.first_valid_routed_at) <= 5 and bc.client_id is not null, ds.pno, null)) 3_5_backlog_bigclient
            ,count(distinct if(datediff(now(), ds.first_valid_routed_at) > 5 and bc.client_id is not null, ds.pno, null)) 5_more_backlog_bigclient
            ,count(distinct if(tsd.end_date < curdate(), ds.pno, null)) tt_overtime_count
        from dwm.dwd_ph_dc_should_be_delivery ds
        join ph_staging.parcel_info pi on pi.pno = ds.pno and pi.state not in (5,7,8,9)
        left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
        left join dwm.dwd_ex_ph_tiktok_sla_detail tsd on tsd.pno = ds.pno
        where
            ds.p_date = '2023-09-17'
        group by 1
    ) backlog on backlog.dst_store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
select
    case
        when a.一派9点半前扫描占比 < 0.4 then '<40%'
        when a.一派9点半前扫描占比 >= 0.4 and a.一派9点半前扫描占比 < 0.5 then '40%-50%'
        when a.一派9点半前扫描占比 >= 0.5 and a.一派9点半前扫描占比 < 0.6 then '50%-60%'
        when a.一派9点半前扫描占比 >= 0.6 and a.一派9点半前扫描占比 < 0.7 then '60%-70%'
        when a.一派9点半前扫描占比 >= 0.7 and a.一派9点半前扫描占比 < 0.8 then '70%-80%'
        when a.一派9点半前扫描占比 >= 0.8 and a.一派9点半前扫描占比 < 0.9 then '80%-90%'
        when a.del_rate >= 0.9 and a.del_rate <= 1 then '90%-100%'
        else a.一派9点半前扫描占比
    end 0930前分拣扫描占比
    ,count(distinct a.网点ID) 总数
    ,sum(a.del_pno_num)/sum(a.pno_num) 妥投率
from
    (

        select -- 基于当日应派取扫描率
            tt.store_id 网点ID
            ,tt.store_name 网点名称
            ,tt.store_type 网点分类
            ,tt.piece_name 片区
            ,tt.region_name 大区
            ,tt.shoud_counts 应派总数
            ,tt.scan_fished_counts 分拣扫描数
            ,ifnull(tt.scan_fished_counts/shoud_counts,0) 分拣扫描率

            ,tt.youxiao_counts 有效分拣扫描数
            ,ifnull(tt.youxiao_counts/tt.shoud_counts,0) 有效分拣扫描率

            ,tt.1pai_counts 一派应派数
            ,tt.1pai_scan_fished_counts 一派分拣扫描数
            ,ifnull(tt.1pai_scan_fished_counts/tt.1pai_counts,0) 一派分拣扫描率

            ,tt.1pai_youxiao_counts 一派有效分拣扫描数
            ,ifnull(tt.1pai_youxiao_counts/tt.1pai_counts,0) 一派有效分拣扫描率

            ,case
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.95 then 'A'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.90 then 'B'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.85 then 'C'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.80 then 'D'
                else 'E'
             end 一派有效分拣评级 -- 一派有效分拣

             ,case
                when tt.1pai_hour_8_fished_counts/tt.1pai_counts>=0.95  then 'A'
                when tt.1pai_hour_8ban_fished_counts/tt.1pai_counts>=0.95  then 'B'
                when tt.1pai_hour_9_fished_counts/tt.1pai_counts>=0.95  then 'C'
                when tt.1pai_hour_9ban_fished_counts/tt.1pai_counts>=0.95  then 'D'
                else 'E'
            end 一派分拣评级

            ,ifnull(tt.1pai_hour_8_fished_counts/tt.1pai_counts,0) 一派8点前扫描占比
            ,ifnull(tt.1pai_hour_8ban_fished_counts/tt.1pai_counts,0) 一派8点半前扫描占比
            ,ifnull(tt.1pai_hour_9_fished_counts/tt.1pai_counts,0) 一派9点前扫描占比
            ,ifnull(tt.1pai_hour_9ban_fished_counts/tt.1pai_counts,0) 一派9点半前扫描占比
            ,if(tt2.late_proof_counts is null , '否', '是') 是否有迟到超过规划时间20分钟的常规车
            ,tt2.max_real_arrive_time_normal 一派常规车最晚实际到达时间
        #     ,tt2.max_real_arrive_proof_id 一派常规车最晚实际到达车线
        #     ,tt2.max_real_arrive_vol 一派常规车最晚实际到达车线包裹量
            ,tt2.line_1_latest_plan_arrive_time 一派常规车最晚规划到达时间
            ,tt2.max_real_arrive_time_innormal 一派加班车最晚实际到达时间
        #     ,tt2.max_real_arrive_innormal_proof_id  一派加班车最晚实际到达车线
        #     ,tt2.max_real_arrive_innormal_vol  一派加班车最晚实际到达包裹量
            ,tt2.max_actual_plan_arrive_time_innormal 一派加班车最晚规划到达时间
            ,del.del_rate
            ,del.pno_num
            ,del.del_pno_num
        from
            (
                select
                   base.store_id
                   ,base.store_name
                   ,base.store_type
                   ,base.piece_name
                   ,base.region_name
                   ,count(distinct base.pno) shoud_counts
                   ,count(distinct case when base.min_fenjian_scan_time is not null then base.pno else null end ) scan_fished_counts
                   ,count(distinct case when base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then base.pno else null end ) youxiao_counts

                   ,count(distinct case when base.type='一派' then  base.pno else null end ) 1pai_counts
                   ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null then  base.pno else null end ) 1pai_scan_fished_counts
                   ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then  base.pno else null end ) 1pai_youxiao_counts

                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:00:00' then base.pno else null end) 1pai_hour_8_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:30:00' then base.pno else null end) 1pai_hour_8ban_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:00:00' then base.pno else null end) 1pai_hour_9_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:30:00' then base.pno else null end) 1pai_hour_9ban_fished_counts

                from
                (
                   select
                   t.*,
                   case when t.should_delevry_type='1派应派包裹' then '一派' else null end 'type'
                   from dwm.dwd_ph_dc_should_be_delivery_sort_scan t
                   join ph_staging.sys_store ss
                   on t.store_id =ss.id
                ) base
                group by base.store_id,base.store_name,base.store_type,base.piece_name,base.region_name
            ) tt

        left join
            (
                select
                   bl.store_id
                   ,bl.max_real_arrive_time_normal
                   ,bl.max_real_arrive_proof_id
                   ,bl.max_real_arrive_vol
                   ,bl.line_1_latest_plan_arrive_time
                   ,bl.max_actual_plan_arrive_time_innormal
                   ,bl.max_actual_plan_arrive_innormal_proof_id
                   ,bl.max_actual_plan_arrive_innormal_vol
                   ,bl.max_real_arrive_time_innormal
                   ,bl.max_real_arrive_innormal_proof_id
                   ,bl.max_real_arrive_innormal_vol
                   ,late_proof_counts
                from dwm.fleet_real_detail_today bl
                group by 1,2,3,4,5,6,7,8,9,10,11
            ) tt2 on tt.store_id=tt2.store_id
        left join
            (
                select
                    ds.dst_store_id
                    ,count(distinct ds.pno) pno_num
                    ,count(if(pi.pno is not null, ds.pno, null)) del_pno_num
                    ,count(if(pi.pno is not null, ds.pno, null))/count(distinct ds.pno) del_rate
                from dwm.dwd_ph_dc_should_be_delivery ds
                left join ph_staging.parcel_info pi on pi.pno = ds.pno and pi.state = 5 and pi.finished_at >= date_sub('2023-09-17', interval 8 hour ) and pi.finished_at < date_add('2023-09-17', interval 16 hour)
                where
                    ds.p_date = '2023-09-17'
                    and ds.should_delevry_type != '非当日应派'
                group by 1
            ) del on del.dst_store_id = tt.store_id
    ) a
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    case
        when a.一派9点半前扫描占比 < 0.4 then '<40%'
        when a.一派9点半前扫描占比 >= 0.4 and a.一派9点半前扫描占比 < 0.5 then '40%-50%'
        when a.一派9点半前扫描占比 >= 0.5 and a.一派9点半前扫描占比 < 0.6 then '50%-60%'
        when a.一派9点半前扫描占比 >= 0.6 and a.一派9点半前扫描占比 < 0.7 then '60%-70%'
        when a.一派9点半前扫描占比 >= 0.7 and a.一派9点半前扫描占比 < 0.8 then '70%-80%'
        when a.一派9点半前扫描占比 >= 0.8 and a.一派9点半前扫描占比 < 0.9 then '80%-90%'
        when a.del_rate >= 0.9 and a.del_rate <= 1 then '90%-100%'
#         else a.一派9点半前扫描占比
    end 0930前分拣扫描占比
    ,count(distinct a.网点ID) 总数
    ,sum(a.del_pno_num)/sum(a.pno_num) 妥投率
from
    (

        select -- 基于当日应派取扫描率
            tt.store_id 网点ID
            ,tt.store_name 网点名称
            ,tt.store_type 网点分类
            ,tt.piece_name 片区
            ,tt.region_name 大区
            ,tt.shoud_counts 应派总数
            ,tt.scan_fished_counts 分拣扫描数
            ,ifnull(tt.scan_fished_counts/shoud_counts,0) 分拣扫描率

            ,tt.youxiao_counts 有效分拣扫描数
            ,ifnull(tt.youxiao_counts/tt.shoud_counts,0) 有效分拣扫描率

            ,tt.1pai_counts 一派应派数
            ,tt.1pai_scan_fished_counts 一派分拣扫描数
            ,ifnull(tt.1pai_scan_fished_counts/tt.1pai_counts,0) 一派分拣扫描率

            ,tt.1pai_youxiao_counts 一派有效分拣扫描数
            ,ifnull(tt.1pai_youxiao_counts/tt.1pai_counts,0) 一派有效分拣扫描率

            ,case
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.95 then 'A'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.90 then 'B'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.85 then 'C'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.80 then 'D'
                else 'E'
             end 一派有效分拣评级 -- 一派有效分拣

             ,case
                when tt.1pai_hour_8_fished_counts/tt.1pai_counts>=0.95  then 'A'
                when tt.1pai_hour_8ban_fished_counts/tt.1pai_counts>=0.95  then 'B'
                when tt.1pai_hour_9_fished_counts/tt.1pai_counts>=0.95  then 'C'
                when tt.1pai_hour_9ban_fished_counts/tt.1pai_counts>=0.95  then 'D'
                else 'E'
            end 一派分拣评级

            ,ifnull(tt.1pai_hour_8_fished_counts/tt.1pai_counts,0) 一派8点前扫描占比
            ,ifnull(tt.1pai_hour_8ban_fished_counts/tt.1pai_counts,0) 一派8点半前扫描占比
            ,ifnull(tt.1pai_hour_9_fished_counts/tt.1pai_counts,0) 一派9点前扫描占比
            ,ifnull(tt.1pai_hour_9ban_fished_counts/tt.1pai_counts,0) 一派9点半前扫描占比
            ,if(tt2.late_proof_counts is null , '否', '是') 是否有迟到超过规划时间20分钟的常规车
            ,tt2.max_real_arrive_time_normal 一派常规车最晚实际到达时间
        #     ,tt2.max_real_arrive_proof_id 一派常规车最晚实际到达车线
        #     ,tt2.max_real_arrive_vol 一派常规车最晚实际到达车线包裹量
            ,tt2.line_1_latest_plan_arrive_time 一派常规车最晚规划到达时间
            ,tt2.max_real_arrive_time_innormal 一派加班车最晚实际到达时间
        #     ,tt2.max_real_arrive_innormal_proof_id  一派加班车最晚实际到达车线
        #     ,tt2.max_real_arrive_innormal_vol  一派加班车最晚实际到达包裹量
            ,tt2.max_actual_plan_arrive_time_innormal 一派加班车最晚规划到达时间
            ,del.del_rate
            ,del.pno_num
            ,del.del_pno_num
        from
            (
                select
                   base.store_id
                   ,base.store_name
                   ,base.store_type
                   ,base.piece_name
                   ,base.region_name
                   ,count(distinct base.pno) shoud_counts
                   ,count(distinct case when base.min_fenjian_scan_time is not null then base.pno else null end ) scan_fished_counts
                   ,count(distinct case when base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then base.pno else null end ) youxiao_counts

                   ,count(distinct case when base.type='一派' then  base.pno else null end ) 1pai_counts
                   ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null then  base.pno else null end ) 1pai_scan_fished_counts
                   ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then  base.pno else null end ) 1pai_youxiao_counts

                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:00:00' then base.pno else null end) 1pai_hour_8_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:30:00' then base.pno else null end) 1pai_hour_8ban_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:00:00' then base.pno else null end) 1pai_hour_9_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:30:00' then base.pno else null end) 1pai_hour_9ban_fished_counts

                from
                (
                   select
                   t.*,
                   case when t.should_delevry_type='1派应派包裹' then '一派' else null end 'type'
                   from dwm.dwd_ph_dc_should_be_delivery_sort_scan t
                   join ph_staging.sys_store ss
                   on t.store_id =ss.id
                ) base
                group by base.store_id,base.store_name,base.store_type,base.piece_name,base.region_name
            ) tt

        left join
            (
                select
                   bl.store_id
                   ,bl.max_real_arrive_time_normal
                   ,bl.max_real_arrive_proof_id
                   ,bl.max_real_arrive_vol
                   ,bl.line_1_latest_plan_arrive_time
                   ,bl.max_actual_plan_arrive_time_innormal
                   ,bl.max_actual_plan_arrive_innormal_proof_id
                   ,bl.max_actual_plan_arrive_innormal_vol
                   ,bl.max_real_arrive_time_innormal
                   ,bl.max_real_arrive_innormal_proof_id
                   ,bl.max_real_arrive_innormal_vol
                   ,late_proof_counts
                from dwm.fleet_real_detail_today bl
                group by 1,2,3,4,5,6,7,8,9,10,11
            ) tt2 on tt.store_id=tt2.store_id
        left join
            (
                select
                    ds.dst_store_id
                    ,count(distinct ds.pno) pno_num
                    ,count(if(pi.pno is not null, ds.pno, null)) del_pno_num
                    ,count(if(pi.pno is not null, ds.pno, null))/count(distinct ds.pno) del_rate
                from dwm.dwd_ph_dc_should_be_delivery ds
                left join ph_staging.parcel_info pi on pi.pno = ds.pno and pi.state = 5 and pi.finished_at >= date_sub('2023-09-17', interval 8 hour ) and pi.finished_at < date_add('2023-09-17', interval 16 hour)
                where
                    ds.p_date = '2023-09-17'
                    and ds.should_delevry_type != '非当日应派'
                group by 1
            ) del on del.dst_store_id = tt.store_id
    ) a
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    case
        when a.一派9点半前扫描占比 < 0.4 then '<40%'
        when a.一派9点半前扫描占比 >= 0.4 and a.一派9点半前扫描占比 < 0.5 then '40%-50%'
        when a.一派9点半前扫描占比 >= 0.5 and a.一派9点半前扫描占比 < 0.6 then '50%-60%'
        when a.一派9点半前扫描占比 >= 0.6 and a.一派9点半前扫描占比 < 0.7 then '60%-70%'
        when a.一派9点半前扫描占比 >= 0.7 and a.一派9点半前扫描占比 < 0.8 then '70%-80%'
        when a.一派9点半前扫描占比 >= 0.8 and a.一派9点半前扫描占比 < 0.9 then '80%-90%'
        when a.一派9点半前扫描占比 >= 0.9 and a.一派9点半前扫描占比 <= 1 then '90%-100%'
#         else a.一派9点半前扫描占比
    end 0930前分拣扫描占比
    ,count(distinct a.网点ID) 总数
    ,sum(a.del_pno_num)/sum(a.pno_num) 妥投率
from
    (

        select -- 基于当日应派取扫描率
            tt.store_id 网点ID
            ,tt.store_name 网点名称
            ,tt.store_type 网点分类
            ,tt.piece_name 片区
            ,tt.region_name 大区
            ,tt.shoud_counts 应派总数
            ,tt.scan_fished_counts 分拣扫描数
            ,ifnull(tt.scan_fished_counts/shoud_counts,0) 分拣扫描率

            ,tt.youxiao_counts 有效分拣扫描数
            ,ifnull(tt.youxiao_counts/tt.shoud_counts,0) 有效分拣扫描率

            ,tt.1pai_counts 一派应派数
            ,tt.1pai_scan_fished_counts 一派分拣扫描数
            ,ifnull(tt.1pai_scan_fished_counts/tt.1pai_counts,0) 一派分拣扫描率

            ,tt.1pai_youxiao_counts 一派有效分拣扫描数
            ,ifnull(tt.1pai_youxiao_counts/tt.1pai_counts,0) 一派有效分拣扫描率

            ,case
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.95 then 'A'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.90 then 'B'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.85 then 'C'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.80 then 'D'
                else 'E'
             end 一派有效分拣评级 -- 一派有效分拣

             ,case
                when tt.1pai_hour_8_fished_counts/tt.1pai_counts>=0.95  then 'A'
                when tt.1pai_hour_8ban_fished_counts/tt.1pai_counts>=0.95  then 'B'
                when tt.1pai_hour_9_fished_counts/tt.1pai_counts>=0.95  then 'C'
                when tt.1pai_hour_9ban_fished_counts/tt.1pai_counts>=0.95  then 'D'
                else 'E'
            end 一派分拣评级

            ,ifnull(tt.1pai_hour_8_fished_counts/tt.1pai_counts,0) 一派8点前扫描占比
            ,ifnull(tt.1pai_hour_8ban_fished_counts/tt.1pai_counts,0) 一派8点半前扫描占比
            ,ifnull(tt.1pai_hour_9_fished_counts/tt.1pai_counts,0) 一派9点前扫描占比
            ,ifnull(tt.1pai_hour_9ban_fished_counts/tt.1pai_counts,0) 一派9点半前扫描占比
            ,if(tt2.late_proof_counts is null , '否', '是') 是否有迟到超过规划时间20分钟的常规车
            ,tt2.max_real_arrive_time_normal 一派常规车最晚实际到达时间
        #     ,tt2.max_real_arrive_proof_id 一派常规车最晚实际到达车线
        #     ,tt2.max_real_arrive_vol 一派常规车最晚实际到达车线包裹量
            ,tt2.line_1_latest_plan_arrive_time 一派常规车最晚规划到达时间
            ,tt2.max_real_arrive_time_innormal 一派加班车最晚实际到达时间
        #     ,tt2.max_real_arrive_innormal_proof_id  一派加班车最晚实际到达车线
        #     ,tt2.max_real_arrive_innormal_vol  一派加班车最晚实际到达包裹量
            ,tt2.max_actual_plan_arrive_time_innormal 一派加班车最晚规划到达时间
            ,del.del_rate
            ,del.pno_num
            ,del.del_pno_num
        from
            (
                select
                   base.store_id
                   ,base.store_name
                   ,base.store_type
                   ,base.piece_name
                   ,base.region_name
                   ,count(distinct base.pno) shoud_counts
                   ,count(distinct case when base.min_fenjian_scan_time is not null then base.pno else null end ) scan_fished_counts
                   ,count(distinct case when base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then base.pno else null end ) youxiao_counts

                   ,count(distinct case when base.type='一派' then  base.pno else null end ) 1pai_counts
                   ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null then  base.pno else null end ) 1pai_scan_fished_counts
                   ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then  base.pno else null end ) 1pai_youxiao_counts

                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:00:00' then base.pno else null end) 1pai_hour_8_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:30:00' then base.pno else null end) 1pai_hour_8ban_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:00:00' then base.pno else null end) 1pai_hour_9_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:30:00' then base.pno else null end) 1pai_hour_9ban_fished_counts

                from
                (
                   select
                   t.*,
                   case when t.should_delevry_type='1派应派包裹' then '一派' else null end 'type'
                   from dwm.dwd_ph_dc_should_be_delivery_sort_scan t
                   join ph_staging.sys_store ss
                   on t.store_id =ss.id
                ) base
                group by base.store_id,base.store_name,base.store_type,base.piece_name,base.region_name
            ) tt

        left join
            (
                select
                   bl.store_id
                   ,bl.max_real_arrive_time_normal
                   ,bl.max_real_arrive_proof_id
                   ,bl.max_real_arrive_vol
                   ,bl.line_1_latest_plan_arrive_time
                   ,bl.max_actual_plan_arrive_time_innormal
                   ,bl.max_actual_plan_arrive_innormal_proof_id
                   ,bl.max_actual_plan_arrive_innormal_vol
                   ,bl.max_real_arrive_time_innormal
                   ,bl.max_real_arrive_innormal_proof_id
                   ,bl.max_real_arrive_innormal_vol
                   ,late_proof_counts
                from dwm.fleet_real_detail_today bl
                group by 1,2,3,4,5,6,7,8,9,10,11
            ) tt2 on tt.store_id=tt2.store_id
        left join
            (
                select
                    ds.dst_store_id
                    ,count(distinct ds.pno) pno_num
                    ,count(if(pi.pno is not null, ds.pno, null)) del_pno_num
                    ,count(if(pi.pno is not null, ds.pno, null))/count(distinct ds.pno) del_rate
                from dwm.dwd_ph_dc_should_be_delivery ds
                left join ph_staging.parcel_info pi on pi.pno = ds.pno and pi.state = 5 and pi.finished_at >= date_sub('2023-09-17', interval 8 hour ) and pi.finished_at < date_add('2023-09-17', interval 16 hour)
                where
                    ds.p_date = '2023-09-17'
                    and ds.should_delevry_type != '非当日应派'
                group by 1
            ) del on del.dst_store_id = tt.store_id
    ) a
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    case
        when a.del_rate < 0.4 then '<40%'
        when a.del_rate >= 0.4 and a.del_rate < 0.5 then '40%-50%'
        when a.del_rate >= 0.5 and a.del_rate < 0.6 then '50%-60%'
        when a.del_rate >= 0.6 and a.del_rate < 0.7 then '60%-70%'
        when a.del_rate >= 0.7 and a.del_rate < 0.8 then '70%-80%'
        when a.del_rate >= 0.8 and a.del_rate <= 1 then '80%-100%'
    end 妥投率
    ,count(distinct a.网点ID) 总数
    ,count(distinct if(a.一派分拣评级 = 'A', a.网点ID, null))/count(distinct a.网点ID) 评级A
    ,count(distinct if(a.一派分拣评级 = 'B', a.网点ID, null))/count(distinct a.网点ID) 评级B
    ,count(distinct if(a.一派分拣评级 = 'C', a.网点ID, null))/count(distinct a.网点ID) 评级C
    ,count(distinct if(a.一派分拣评级 = 'D', a.网点ID, null))/count(distinct a.网点ID) 评级D
    ,count(distinct if(a.一派分拣评级 = 'E', a.网点ID, null))/count(distinct a.网点ID) 评级E
    ,count(distinct if(a.一派分拣评级 = 'A', a.网点ID, null)) 评级A数量
    ,count(distinct if(a.一派分拣评级 = 'B', a.网点ID, null)) 评级B数量
    ,count(distinct if(a.一派分拣评级 = 'C', a.网点ID, null)) 评级C数量
    ,count(distinct if(a.一派分拣评级 = 'D', a.网点ID, null)) 评级D数量
    ,count(distinct if(a.一派分拣评级 = 'E', a.网点ID, null)) 评级E数量
from
    (

        select -- 基于当日应派取扫描率
            tt.store_id 网点ID
            ,tt.store_name 网点名称
            ,tt.store_type 网点分类
            ,tt.piece_name 片区
            ,tt.region_name 大区
            ,tt.shoud_counts 应派总数
            ,tt.scan_fished_counts 分拣扫描数
            ,ifnull(tt.scan_fished_counts/shoud_counts,0) 分拣扫描率

            ,tt.youxiao_counts 有效分拣扫描数
            ,ifnull(tt.youxiao_counts/tt.shoud_counts,0) 有效分拣扫描率

            ,tt.1pai_counts 一派应派数
            ,tt.1pai_scan_fished_counts 一派分拣扫描数
            ,ifnull(tt.1pai_scan_fished_counts/tt.1pai_counts,0) 一派分拣扫描率

            ,tt.1pai_youxiao_counts 一派有效分拣扫描数
            ,ifnull(tt.1pai_youxiao_counts/tt.1pai_counts,0) 一派有效分拣扫描率

            ,case
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.95 then 'A'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.90 then 'B'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.85 then 'C'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.80 then 'D'
                else 'E'
             end 一派有效分拣评级 -- 一派有效分拣

             ,case
                when tt.1pai_hour_8_fished_counts/tt.1pai_counts>=0.95  then 'A'
                when tt.1pai_hour_8ban_fished_counts/tt.1pai_counts>=0.95  then 'B'
                when tt.1pai_hour_9_fished_counts/tt.1pai_counts>=0.95  then 'C'
                when tt.1pai_hour_9ban_fished_counts/tt.1pai_counts>=0.95  then 'D'
                else 'E'
            end 一派分拣评级

            ,ifnull(tt.1pai_hour_8_fished_counts/tt.1pai_counts,0) 一派8点前扫描占比
            ,ifnull(tt.1pai_hour_8ban_fished_counts/tt.1pai_counts,0) 一派8点半前扫描占比
            ,ifnull(tt.1pai_hour_9_fished_counts/tt.1pai_counts,0) 一派9点前扫描占比
            ,ifnull(tt.1pai_hour_9ban_fished_counts/tt.1pai_counts,0) 一派9点半前扫描占比
            ,if(tt2.late_proof_counts is null , '否', '是') 是否有迟到超过规划时间20分钟的常规车
            ,tt2.max_real_arrive_time_normal 一派常规车最晚实际到达时间
        #     ,tt2.max_real_arrive_proof_id 一派常规车最晚实际到达车线
        #     ,tt2.max_real_arrive_vol 一派常规车最晚实际到达车线包裹量
            ,tt2.line_1_latest_plan_arrive_time 一派常规车最晚规划到达时间
            ,tt2.max_real_arrive_time_innormal 一派加班车最晚实际到达时间
        #     ,tt2.max_real_arrive_innormal_proof_id  一派加班车最晚实际到达车线
        #     ,tt2.max_real_arrive_innormal_vol  一派加班车最晚实际到达包裹量
            ,tt2.max_actual_plan_arrive_time_innormal 一派加班车最晚规划到达时间
            ,del.del_rate
            ,del.pno_num
            ,del.del_pno_num
        from
            (
                select
                   base.store_id
                   ,base.store_name
                   ,base.store_type
                   ,base.piece_name
                   ,base.region_name
                   ,count(distinct base.pno) shoud_counts
                   ,count(distinct case when base.min_fenjian_scan_time is not null then base.pno else null end ) scan_fished_counts
                   ,count(distinct case when base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then base.pno else null end ) youxiao_counts

                   ,count(distinct case when base.type='一派' then  base.pno else null end ) 1pai_counts
                   ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null then  base.pno else null end ) 1pai_scan_fished_counts
                   ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then  base.pno else null end ) 1pai_youxiao_counts

                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:00:00' then base.pno else null end) 1pai_hour_8_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:30:00' then base.pno else null end) 1pai_hour_8ban_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:00:00' then base.pno else null end) 1pai_hour_9_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:30:00' then base.pno else null end) 1pai_hour_9ban_fished_counts

                from
                (
                   select
                   t.*,
                   case when t.should_delevry_type='1派应派包裹' then '一派' else null end 'type'
                   from dwm.dwd_ph_dc_should_be_delivery_sort_scan t
                   join ph_staging.sys_store ss
                   on t.store_id =ss.id
                ) base
                group by base.store_id,base.store_name,base.store_type,base.piece_name,base.region_name
            ) tt

        left join
            (
                select
                   bl.store_id
                   ,bl.max_real_arrive_time_normal
                   ,bl.max_real_arrive_proof_id
                   ,bl.max_real_arrive_vol
                   ,bl.line_1_latest_plan_arrive_time
                   ,bl.max_actual_plan_arrive_time_innormal
                   ,bl.max_actual_plan_arrive_innormal_proof_id
                   ,bl.max_actual_plan_arrive_innormal_vol
                   ,bl.max_real_arrive_time_innormal
                   ,bl.max_real_arrive_innormal_proof_id
                   ,bl.max_real_arrive_innormal_vol
                   ,late_proof_counts
                from dwm.fleet_real_detail_today bl
                group by 1,2,3,4,5,6,7,8,9,10,11
            ) tt2 on tt.store_id=tt2.store_id
        left join
            (
                select
                    ds.dst_store_id
                    ,count(distinct ds.pno) pno_num
                    ,count(if(pi.pno is not null, ds.pno, null)) del_pno_num
                    ,count(if(pi.pno is not null, ds.pno, null))/count(distinct ds.pno) del_rate
                from dwm.dwd_ph_dc_should_be_delivery ds
                left join ph_staging.parcel_info pi on pi.pno = ds.pno and pi.state = 5 and pi.finished_at >= date_sub('2023-09-17', interval 8 hour ) and pi.finished_at < date_add('2023-09-17', interval 16 hour)
                where
                    ds.p_date = '2023-09-17'
                    and ds.should_delevry_type != '非当日应派'
                group by 1
            ) del on del.dst_store_id = tt.store_id
    ) a
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    a.负责人
    ,a.大区
    ,count(distinct a.网点ID) 总网点数
    ,count(distinct if(a.一派分拣评级 = 'E', a.网点ID, null)) 问题网点数
    ,count(distinct if(a.一派分拣评级 = 'E', a.网点ID, null))/count(distinct a.网点ID)  问题比例
from
    (

        select -- 基于当日应派取扫描率
            tt.store_id 网点ID
            ,tt.store_name 网点名称
            ,tt.store_type 网点分类
            ,tt.piece_name 片区
            ,tt.region_name 大区
            ,case
                when tt.region_name in ('Area3', 'Area6') then '彭万松'
                when tt.region_name in ('Area4', 'Area9') then '韩钥'
                when tt.region_name in ('Area7','Area10', 'Area11','FHome','Area14') then '张可新'
                when tt.region_name in ('Area8') then '黄勇'
                when tt.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
            end 负责人
            ,tt.shoud_counts 应派总数
            ,tt.scan_fished_counts 分拣扫描数
            ,ifnull(tt.scan_fished_counts/shoud_counts,0) 分拣扫描率

            ,tt.youxiao_counts 有效分拣扫描数
            ,ifnull(tt.youxiao_counts/tt.shoud_counts,0) 有效分拣扫描率

            ,tt.1pai_counts 一派应派数
            ,tt.1pai_scan_fished_counts 一派分拣扫描数
            ,ifnull(tt.1pai_scan_fished_counts/tt.1pai_counts,0) 一派分拣扫描率

            ,tt.1pai_youxiao_counts 一派有效分拣扫描数
            ,ifnull(tt.1pai_youxiao_counts/tt.1pai_counts,0) 一派有效分拣扫描率

            ,case
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.95 then 'A'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.90 then 'B'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.85 then 'C'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.80 then 'D'
                else 'E'
             end 一派有效分拣评级 -- 一派有效分拣

             ,case
                when tt.1pai_hour_8_fished_counts/tt.1pai_counts>=0.95  then 'A'
                when tt.1pai_hour_8ban_fished_counts/tt.1pai_counts>=0.95  then 'B'
                when tt.1pai_hour_9_fished_counts/tt.1pai_counts>=0.95  then 'C'
                when tt.1pai_hour_9ban_fished_counts/tt.1pai_counts>=0.95  then 'D'
                else 'E'
            end 一派分拣评级

            ,ifnull(tt.1pai_hour_8_fished_counts/tt.1pai_counts,0) 一派8点前扫描占比
            ,ifnull(tt.1pai_hour_8ban_fished_counts/tt.1pai_counts,0) 一派8点半前扫描占比
            ,ifnull(tt.1pai_hour_9_fished_counts/tt.1pai_counts,0) 一派9点前扫描占比
            ,ifnull(tt.1pai_hour_9ban_fished_counts/tt.1pai_counts,0) 一派9点半前扫描占比
            ,if(tt2.late_proof_counts is null , '否', '是') 是否有迟到超过规划时间20分钟的常规车
            ,tt2.max_real_arrive_time_normal 一派常规车最晚实际到达时间
        #     ,tt2.max_real_arrive_proof_id 一派常规车最晚实际到达车线
        #     ,tt2.max_real_arrive_vol 一派常规车最晚实际到达车线包裹量
            ,tt2.line_1_latest_plan_arrive_time 一派常规车最晚规划到达时间
            ,tt2.max_real_arrive_time_innormal 一派加班车最晚实际到达时间
        #     ,tt2.max_real_arrive_innormal_proof_id  一派加班车最晚实际到达车线
        #     ,tt2.max_real_arrive_innormal_vol  一派加班车最晚实际到达包裹量
            ,tt2.max_actual_plan_arrive_time_innormal 一派加班车最晚规划到达时间
            ,del.del_rate
            ,del.pno_num
            ,del.del_pno_num
        from
            (
                select
                   base.store_id
                   ,base.store_name
                   ,base.store_type
                   ,base.piece_name
                   ,base.region_name
                   ,count(distinct base.pno) shoud_counts
                   ,count(distinct case when base.min_fenjian_scan_time is not null then base.pno else null end ) scan_fished_counts
                   ,count(distinct case when base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then base.pno else null end ) youxiao_counts

                   ,count(distinct case when base.type='一派' then  base.pno else null end ) 1pai_counts
                   ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null then  base.pno else null end ) 1pai_scan_fished_counts
                   ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then  base.pno else null end ) 1pai_youxiao_counts

                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:00:00' then base.pno else null end) 1pai_hour_8_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:30:00' then base.pno else null end) 1pai_hour_8ban_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:00:00' then base.pno else null end) 1pai_hour_9_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:30:00' then base.pno else null end) 1pai_hour_9ban_fished_counts

                from
                (
                   select
                   t.*,
                   case when t.should_delevry_type='1派应派包裹' then '一派' else null end 'type'
                   from dwm.dwd_ph_dc_should_be_delivery_sort_scan t
                   join ph_staging.sys_store ss
                   on t.store_id =ss.id
                ) base
                group by base.store_id,base.store_name,base.store_type,base.piece_name,base.region_name
            ) tt

        left join
            (
                select
                   bl.store_id
                   ,bl.max_real_arrive_time_normal
                   ,bl.max_real_arrive_proof_id
                   ,bl.max_real_arrive_vol
                   ,bl.line_1_latest_plan_arrive_time
                   ,bl.max_actual_plan_arrive_time_innormal
                   ,bl.max_actual_plan_arrive_innormal_proof_id
                   ,bl.max_actual_plan_arrive_innormal_vol
                   ,bl.max_real_arrive_time_innormal
                   ,bl.max_real_arrive_innormal_proof_id
                   ,bl.max_real_arrive_innormal_vol
                   ,late_proof_counts
                from dwm.fleet_real_detail_today bl
                group by 1,2,3,4,5,6,7,8,9,10,11
            ) tt2 on tt.store_id=tt2.store_id
        left join
            (
                select
                    ds.dst_store_id
                    ,count(distinct ds.pno) pno_num
                    ,count(if(pi.pno is not null, ds.pno, null)) del_pno_num
                    ,count(if(pi.pno is not null, ds.pno, null))/count(distinct ds.pno) del_rate
                from dwm.dwd_ph_dc_should_be_delivery ds
                left join ph_staging.parcel_info pi on pi.pno = ds.pno and pi.state = 5 and pi.finished_at >= date_sub('2023-09-17', interval 8 hour ) and pi.finished_at < date_add('2023-09-17', interval 16 hour)
                where
                    ds.p_date = '2023-09-17'
                    and ds.should_delevry_type != '非当日应派'
                group by 1
            ) del on del.dst_store_id = tt.store_id
    ) a
group by 1,2;
;-- -. . -..- - / . -. - .-. -.--
select
    a.负责人
#     ,a.大区
    ,count(distinct a.网点ID) 总网点数
    ,count(distinct if(a.一派分拣评级 = 'E', a.网点ID, null)) 问题网点数
    ,count(distinct if(a.一派分拣评级 = 'E', a.网点ID, null))/count(distinct a.网点ID)  问题比例
from
    (

        select -- 基于当日应派取扫描率
            tt.store_id 网点ID
            ,tt.store_name 网点名称
            ,tt.store_type 网点分类
            ,tt.piece_name 片区
            ,tt.region_name 大区
            ,case
                when tt.region_name in ('Area3', 'Area6') then '彭万松'
                when tt.region_name in ('Area4', 'Area9') then '韩钥'
                when tt.region_name in ('Area7','Area10', 'Area11','FHome','Area14') then '张可新'
                when tt.region_name in ('Area8') then '黄勇'
                when tt.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
            end 负责人
            ,tt.shoud_counts 应派总数
            ,tt.scan_fished_counts 分拣扫描数
            ,ifnull(tt.scan_fished_counts/shoud_counts,0) 分拣扫描率

            ,tt.youxiao_counts 有效分拣扫描数
            ,ifnull(tt.youxiao_counts/tt.shoud_counts,0) 有效分拣扫描率

            ,tt.1pai_counts 一派应派数
            ,tt.1pai_scan_fished_counts 一派分拣扫描数
            ,ifnull(tt.1pai_scan_fished_counts/tt.1pai_counts,0) 一派分拣扫描率

            ,tt.1pai_youxiao_counts 一派有效分拣扫描数
            ,ifnull(tt.1pai_youxiao_counts/tt.1pai_counts,0) 一派有效分拣扫描率

            ,case
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.95 then 'A'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.90 then 'B'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.85 then 'C'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.80 then 'D'
                else 'E'
             end 一派有效分拣评级 -- 一派有效分拣

             ,case
                when tt.1pai_hour_8_fished_counts/tt.1pai_counts>=0.95  then 'A'
                when tt.1pai_hour_8ban_fished_counts/tt.1pai_counts>=0.95  then 'B'
                when tt.1pai_hour_9_fished_counts/tt.1pai_counts>=0.95  then 'C'
                when tt.1pai_hour_9ban_fished_counts/tt.1pai_counts>=0.95  then 'D'
                else 'E'
            end 一派分拣评级

            ,ifnull(tt.1pai_hour_8_fished_counts/tt.1pai_counts,0) 一派8点前扫描占比
            ,ifnull(tt.1pai_hour_8ban_fished_counts/tt.1pai_counts,0) 一派8点半前扫描占比
            ,ifnull(tt.1pai_hour_9_fished_counts/tt.1pai_counts,0) 一派9点前扫描占比
            ,ifnull(tt.1pai_hour_9ban_fished_counts/tt.1pai_counts,0) 一派9点半前扫描占比
            ,if(tt2.late_proof_counts is null , '否', '是') 是否有迟到超过规划时间20分钟的常规车
            ,tt2.max_real_arrive_time_normal 一派常规车最晚实际到达时间
        #     ,tt2.max_real_arrive_proof_id 一派常规车最晚实际到达车线
        #     ,tt2.max_real_arrive_vol 一派常规车最晚实际到达车线包裹量
            ,tt2.line_1_latest_plan_arrive_time 一派常规车最晚规划到达时间
            ,tt2.max_real_arrive_time_innormal 一派加班车最晚实际到达时间
        #     ,tt2.max_real_arrive_innormal_proof_id  一派加班车最晚实际到达车线
        #     ,tt2.max_real_arrive_innormal_vol  一派加班车最晚实际到达包裹量
            ,tt2.max_actual_plan_arrive_time_innormal 一派加班车最晚规划到达时间
            ,del.del_rate
            ,del.pno_num
            ,del.del_pno_num
        from
            (
                select
                   base.store_id
                   ,base.store_name
                   ,base.store_type
                   ,base.piece_name
                   ,base.region_name
                   ,count(distinct base.pno) shoud_counts
                   ,count(distinct case when base.min_fenjian_scan_time is not null then base.pno else null end ) scan_fished_counts
                   ,count(distinct case when base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then base.pno else null end ) youxiao_counts

                   ,count(distinct case when base.type='一派' then  base.pno else null end ) 1pai_counts
                   ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null then  base.pno else null end ) 1pai_scan_fished_counts
                   ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then  base.pno else null end ) 1pai_youxiao_counts

                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:00:00' then base.pno else null end) 1pai_hour_8_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:30:00' then base.pno else null end) 1pai_hour_8ban_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:00:00' then base.pno else null end) 1pai_hour_9_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:30:00' then base.pno else null end) 1pai_hour_9ban_fished_counts

                from
                (
                   select
                   t.*,
                   case when t.should_delevry_type='1派应派包裹' then '一派' else null end 'type'
                   from dwm.dwd_ph_dc_should_be_delivery_sort_scan t
                   join ph_staging.sys_store ss
                   on t.store_id =ss.id
                ) base
                group by base.store_id,base.store_name,base.store_type,base.piece_name,base.region_name
            ) tt

        left join
            (
                select
                   bl.store_id
                   ,bl.max_real_arrive_time_normal
                   ,bl.max_real_arrive_proof_id
                   ,bl.max_real_arrive_vol
                   ,bl.line_1_latest_plan_arrive_time
                   ,bl.max_actual_plan_arrive_time_innormal
                   ,bl.max_actual_plan_arrive_innormal_proof_id
                   ,bl.max_actual_plan_arrive_innormal_vol
                   ,bl.max_real_arrive_time_innormal
                   ,bl.max_real_arrive_innormal_proof_id
                   ,bl.max_real_arrive_innormal_vol
                   ,late_proof_counts
                from dwm.fleet_real_detail_today bl
                group by 1,2,3,4,5,6,7,8,9,10,11
            ) tt2 on tt.store_id=tt2.store_id
        left join
            (
                select
                    ds.dst_store_id
                    ,count(distinct ds.pno) pno_num
                    ,count(if(pi.pno is not null, ds.pno, null)) del_pno_num
                    ,count(if(pi.pno is not null, ds.pno, null))/count(distinct ds.pno) del_rate
                from dwm.dwd_ph_dc_should_be_delivery ds
                left join ph_staging.parcel_info pi on pi.pno = ds.pno and pi.state = 5 and pi.finished_at >= date_sub('2023-09-17', interval 8 hour ) and pi.finished_at < date_add('2023-09-17', interval 16 hour)
                where
                    ds.p_date = '2023-09-17'
                    and ds.should_delevry_type != '非当日应派'
                group by 1
            ) del on del.dst_store_id = tt.store_id
    ) a
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno 退件单号
    ,pick_ss.name  揽收网点
    ,return_ss.name 退件目的地网点
    ,pi2.src_name seller
    ,pi2.client_id 客户ID
from ph_staging.parcel_info pi
left join ph_staging.parcel_info pi2 on pi2.pno = pi.returned_pno
left join ph_staging.sys_store pick_ss on pick_ss.id = pi2.ticket_pickup_store_id  -- 揽收pdc
left join ph_staging.sys_store return_ss on return_ss.id = pi.dst_store_id
where
    pi.returned = 1
    and pi.created_at >= date_sub(date_sub(curdate(), interval 7 day), interval 8 hour )
    and pick_ss.category = 14
    and return_ss.category != 14;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno 退件单号
    ,pick_ss.name  揽收网点
    ,return_ss.name 退件目的地网点
    ,pi2.src_name seller
    ,pi2.client_id 客户ID
from ph_staging.parcel_info pi
left join ph_staging.parcel_info pi2 on pi2.returned_pno = pi.returned_pno
left join ph_staging.sys_store pick_ss on pick_ss.id = pi2.ticket_pickup_store_id  -- 揽收pdc
left join ph_staging.sys_store return_ss on return_ss.id = pi.dst_store_id
where
    pi.returned = 1
    and pi.created_at >= date_sub(date_sub(curdate(), interval 7 day), interval 8 hour )
    and pick_ss.category = 14
    and return_ss.category != 14;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno 退件单号
    ,pick_ss.name  揽收网点
    ,return_ss.name 退件目的地网点
    ,pi2.src_name seller
    ,pi2.client_id 客户ID
from ph_staging.parcel_info pi -- 退件
left join ph_staging.parcel_info pi2 on pi2.returned_pno = pi.returned_pno
left join ph_staging.sys_store pick_ss on pick_ss.id = pi2.ticket_pickup_store_id  -- 揽收pdc
left join ph_staging.sys_store return_ss on return_ss.id = pi.dst_store_id
where
    pi.returned = 1
    and pi.created_at >= date_sub(date_sub(curdate(), interval 7 day), interval 8 hour )
    and pick_ss.category = 14
    and return_ss.category != 14;
;-- -. . -..- - / . -. - .-. -.--
select
    pi2.pno 正向单号
    ,ss.name 正向揽收网点
    ,pi2.src_detail_address 正向寄件人地址
    ,pi2.client_id 客户ID
    ,pi2.src_name 寄件人姓名
    ,pi.dst_detail_address 退件包裹目的地地址
    ,ss2.name 退件目的地网点
from ph_staging.parcel_info pi
left join ph_staging.parcel_info pi2 on pi2.returned_pno = pi.pno
left join ph_staging.sys_store ss on ss.id = pi2.ticket_pickup_store_id
left join ph_staging.sys_store ss2 on ss2.id = pi.dst_store_id
where
    pi.returned = 1
    and pi.created_at >= date_sub(date_sub(curdate(), interval 7 day), interval 8 hour) -- 近一周退件
    and ss.category = 14
    and ss2.category != 14;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-18'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 10
                    or (t1.total =  5 and t1.leave_time_type = 2)

                union all

                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 5
                    and t1.leave_time_type = 1 -- 上午请假
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-18'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 10
                                    or (t1.total =  5 and t1.leave_time_type = 2)

                                union all

                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 5
                                    and t1.leave_time_type = 1 -- 上午请假
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-09-18', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
select -- 基于当日应派取扫描率
    tt.store_id 网点ID
    ,tt.store_name 网点名称
    ,tt.store_type 网点分类
    ,tt.piece_name 片区
    ,tt.region_name 大区
    ,tt.shoud_counts 应派总数
    ,tt.scan_fished_counts 分拣扫描数
    ,ifnull(tt.scan_fished_counts/shoud_counts,0) 分拣扫描率

    ,tt.youxiao_counts 有效分拣扫描数
    ,ifnull(tt.youxiao_counts/tt.shoud_counts,0) 有效分拣扫描率

    ,tt.1pai_counts 一派应派数
    ,tt.1pai_scan_fished_counts 一派分拣扫描数
    ,ifnull(tt.1pai_scan_fished_counts/tt.1pai_counts,0) 一派分拣扫描率

    ,tt.1pai_youxiao_counts 一派有效分拣扫描数
    ,ifnull(tt.1pai_youxiao_counts/tt.1pai_counts,0) 一派有效分拣扫描率

    ,case
	    when tt.1pai_youxiao_counts/tt.1pai_counts>=0.95 then 'A'
	    when tt.1pai_youxiao_counts/tt.1pai_counts>=0.90 then 'B'
	    when tt.1pai_youxiao_counts/tt.1pai_counts>=0.85 then 'C'
	    when tt.1pai_youxiao_counts/tt.1pai_counts>=0.80 then 'D'
	    else 'E'
	 end 一派有效分拣评级 -- 一派有效分拣

	 ,case
        when tt.1pai_hour_8_fished_counts/tt.1pai_counts>=0.95  then 'A'
        when tt.1pai_hour_8ban_fished_counts/tt.1pai_counts>=0.95  then 'B'
        when tt.1pai_hour_9_fished_counts/tt.1pai_counts>=0.95  then 'C'
        when tt.1pai_hour_9ban_fished_counts/tt.1pai_counts>=0.95  then 'D'
        else 'E'
    end 一派分拣评级

    ,ifnull(tt.1pai_hour_8_fished_counts/tt.1pai_counts,0) 一派8点前扫描占比
    ,ifnull(tt.1pai_hour_8ban_fished_counts/tt.1pai_counts,0) 一派8点半前扫描占比
    ,ifnull(tt.1pai_hour_9_fished_counts/tt.1pai_counts,0) 一派9点前扫描占比
    ,ifnull(tt.1pai_hour_9ban_fished_counts/tt.1pai_counts,0) 一派9点半前扫描占比
	,if(tt2.late_proof_counts is null , '否', '是') 是否有迟到超过规划时间20分钟的常规车
    ,tt2.max_real_arrive_time_normal 一派常规车最晚实际到达时间
#     ,tt2.max_real_arrive_proof_id 一派常规车最晚实际到达车线
#     ,tt2.max_real_arrive_vol 一派常规车最晚实际到达车线包裹量
    ,tt2.line_1_latest_plan_arrive_time 一派常规车最晚规划到达时间
    ,tt2.max_real_arrive_time_innormal 一派加班车最晚实际到达时间
#     ,tt2.max_real_arrive_innormal_proof_id  一派加班车最晚实际到达车线
#     ,tt2.max_real_arrive_innormal_vol  一派加班车最晚实际到达包裹量
    ,tt2.max_actual_plan_arrive_time_innormal 一派加班车最晚规划到达时间


from
(
    select
       base.store_id
       ,base.store_name
       ,base.store_type
       ,base.piece_name
       ,base.region_name
       ,count(distinct base.pno) shoud_counts
       ,count(distinct case when base.min_fenjian_scan_time is not null then base.pno else null end ) scan_fished_counts
       ,count(distinct case when base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then base.pno else null end ) youxiao_counts

       ,count(distinct case when base.type='一派' then  base.pno else null end ) 1pai_counts
       ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null then  base.pno else null end ) 1pai_scan_fished_counts
       ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then  base.pno else null end ) 1pai_youxiao_counts

       ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:00:00' then base.pno else null end) 1pai_hour_8_fished_counts
       ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:30:00' then base.pno else null end) 1pai_hour_8ban_fished_counts
       ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:00:00' then base.pno else null end) 1pai_hour_9_fished_counts
       ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:30:00' then base.pno else null end) 1pai_hour_9ban_fished_counts

    from
    (
       select
       t.*,
       case when t.should_delevry_type='1派应派包裹' then '一派' else null end 'type'
       from dwm.dwd_ph_dc_should_be_delivery_sort_scan t
       join ph_staging.sys_store ss
       on t.store_id =ss.id
    ) base
    group by base.store_id,base.store_name,base.store_type,base.piece_name,base.region_name
) tt

left join
(
    select
       bl.store_id
       ,bl.max_real_arrive_time_normal
       ,bl.max_real_arrive_proof_id
       ,bl.max_real_arrive_vol
       ,bl.line_1_latest_plan_arrive_time
       ,bl.max_actual_plan_arrive_time_innormal
       ,bl.max_actual_plan_arrive_innormal_proof_id
       ,bl.max_actual_plan_arrive_innormal_vol
       ,bl.max_real_arrive_time_innormal
       ,bl.max_real_arrive_innormal_proof_id
       ,bl.max_real_arrive_innormal_vol
	   ,late_proof_counts
    from dwm.fleet_real_detail_today bl
    group by 1,2,3,4,5,6,7,8,9,10,11
) tt2 on tt.store_id=tt2.store_id;
;-- -. . -..- - / . -. - .-. -.--
select
    case
        when a.del_rate < 0.4 then '<40%'
        when a.del_rate >= 0.4 and a.del_rate < 0.5 then '40%-50%'
        when a.del_rate >= 0.5 and a.del_rate < 0.6 then '50%-60%'
        when a.del_rate >= 0.6 and a.del_rate < 0.7 then '60%-70%'
        when a.del_rate >= 0.7 and a.del_rate < 0.8 then '70%-80%'
        when a.del_rate >= 0.8 and a.del_rate <= 1 then '80%-100%'
    end 妥投率
    ,count(distinct a.网点ID) 总数
    ,count(distinct if(a.一派分拣评级 = 'A', a.网点ID, null))/count(distinct a.网点ID) 评级A
    ,count(distinct if(a.一派分拣评级 = 'B', a.网点ID, null))/count(distinct a.网点ID) 评级B
    ,count(distinct if(a.一派分拣评级 = 'C', a.网点ID, null))/count(distinct a.网点ID) 评级C
    ,count(distinct if(a.一派分拣评级 = 'D', a.网点ID, null))/count(distinct a.网点ID) 评级D
    ,count(distinct if(a.一派分拣评级 = 'E', a.网点ID, null))/count(distinct a.网点ID) 评级E
    ,count(distinct if(a.一派分拣评级 = 'A', a.网点ID, null)) 评级A数量
    ,count(distinct if(a.一派分拣评级 = 'B', a.网点ID, null)) 评级B数量
    ,count(distinct if(a.一派分拣评级 = 'C', a.网点ID, null)) 评级C数量
    ,count(distinct if(a.一派分拣评级 = 'D', a.网点ID, null)) 评级D数量
    ,count(distinct if(a.一派分拣评级 = 'E', a.网点ID, null)) 评级E数量
from
    (

        select -- 基于当日应派取扫描率
            tt.store_id 网点ID
            ,tt.store_name 网点名称
            ,tt.store_type 网点分类
            ,tt.piece_name 片区
            ,tt.region_name 大区
            ,tt.shoud_counts 应派总数
            ,tt.scan_fished_counts 分拣扫描数
            ,ifnull(tt.scan_fished_counts/shoud_counts,0) 分拣扫描率

            ,tt.youxiao_counts 有效分拣扫描数
            ,ifnull(tt.youxiao_counts/tt.shoud_counts,0) 有效分拣扫描率

            ,tt.1pai_counts 一派应派数
            ,tt.1pai_scan_fished_counts 一派分拣扫描数
            ,ifnull(tt.1pai_scan_fished_counts/tt.1pai_counts,0) 一派分拣扫描率

            ,tt.1pai_youxiao_counts 一派有效分拣扫描数
            ,ifnull(tt.1pai_youxiao_counts/tt.1pai_counts,0) 一派有效分拣扫描率

            ,case
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.95 then 'A'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.90 then 'B'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.85 then 'C'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.80 then 'D'
                else 'E'
             end 一派有效分拣评级 -- 一派有效分拣

             ,case
                when tt.1pai_hour_8_fished_counts/tt.1pai_counts>=0.95  then 'A'
                when tt.1pai_hour_8ban_fished_counts/tt.1pai_counts>=0.95  then 'B'
                when tt.1pai_hour_9_fished_counts/tt.1pai_counts>=0.95  then 'C'
                when tt.1pai_hour_9ban_fished_counts/tt.1pai_counts>=0.95  then 'D'
                else 'E'
            end 一派分拣评级

            ,ifnull(tt.1pai_hour_8_fished_counts/tt.1pai_counts,0) 一派8点前扫描占比
            ,ifnull(tt.1pai_hour_8ban_fished_counts/tt.1pai_counts,0) 一派8点半前扫描占比
            ,ifnull(tt.1pai_hour_9_fished_counts/tt.1pai_counts,0) 一派9点前扫描占比
            ,ifnull(tt.1pai_hour_9ban_fished_counts/tt.1pai_counts,0) 一派9点半前扫描占比
            ,if(tt2.late_proof_counts is null , '否', '是') 是否有迟到超过规划时间20分钟的常规车
            ,tt2.max_real_arrive_time_normal 一派常规车最晚实际到达时间
        #     ,tt2.max_real_arrive_proof_id 一派常规车最晚实际到达车线
        #     ,tt2.max_real_arrive_vol 一派常规车最晚实际到达车线包裹量
            ,tt2.line_1_latest_plan_arrive_time 一派常规车最晚规划到达时间
            ,tt2.max_real_arrive_time_innormal 一派加班车最晚实际到达时间
        #     ,tt2.max_real_arrive_innormal_proof_id  一派加班车最晚实际到达车线
        #     ,tt2.max_real_arrive_innormal_vol  一派加班车最晚实际到达包裹量
            ,tt2.max_actual_plan_arrive_time_innormal 一派加班车最晚规划到达时间
            ,del.del_rate
            ,del.pno_num
            ,del.del_pno_num
        from
            (
                select
                   base.store_id
                   ,base.store_name
                   ,base.store_type
                   ,base.piece_name
                   ,base.region_name
                   ,count(distinct base.pno) shoud_counts
                   ,count(distinct case when base.min_fenjian_scan_time is not null then base.pno else null end ) scan_fished_counts
                   ,count(distinct case when base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then base.pno else null end ) youxiao_counts

                   ,count(distinct case when base.type='一派' then  base.pno else null end ) 1pai_counts
                   ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null then  base.pno else null end ) 1pai_scan_fished_counts
                   ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then  base.pno else null end ) 1pai_youxiao_counts

                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:00:00' then base.pno else null end) 1pai_hour_8_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:30:00' then base.pno else null end) 1pai_hour_8ban_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:00:00' then base.pno else null end) 1pai_hour_9_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:30:00' then base.pno else null end) 1pai_hour_9ban_fished_counts

                from
                (
                   select
                   t.*,
                   case when t.should_delevry_type='1派应派包裹' then '一派' else null end 'type'
                   from dwm.dwd_ph_dc_should_be_delivery_sort_scan t
                   join ph_staging.sys_store ss
                   on t.store_id =ss.id
                ) base
                group by base.store_id,base.store_name,base.store_type,base.piece_name,base.region_name
            ) tt

        left join
            (
                select
                   bl.store_id
                   ,bl.max_real_arrive_time_normal
                   ,bl.max_real_arrive_proof_id
                   ,bl.max_real_arrive_vol
                   ,bl.line_1_latest_plan_arrive_time
                   ,bl.max_actual_plan_arrive_time_innormal
                   ,bl.max_actual_plan_arrive_innormal_proof_id
                   ,bl.max_actual_plan_arrive_innormal_vol
                   ,bl.max_real_arrive_time_innormal
                   ,bl.max_real_arrive_innormal_proof_id
                   ,bl.max_real_arrive_innormal_vol
                   ,late_proof_counts
                from dwm.fleet_real_detail_today bl
                group by 1,2,3,4,5,6,7,8,9,10,11
            ) tt2 on tt.store_id=tt2.store_id
        left join
            (
                select
                    ds.dst_store_id
                    ,count(distinct ds.pno) pno_num
                    ,count(if(pi.pno is not null, ds.pno, null)) del_pno_num
                    ,count(if(pi.pno is not null, ds.pno, null))/count(distinct ds.pno) del_rate
                from dwm.dwd_ph_dc_should_be_delivery ds
                left join ph_staging.parcel_info pi on pi.pno = ds.pno and pi.state = 5 and pi.finished_at >= date_sub('2023-09-18', interval 8 hour ) and pi.finished_at < date_add('2023-09-18', interval 16 hour)
                where
                    ds.p_date = '2023-09-18'
                    and ds.should_delevry_type != '非当日应派'
                group by 1
            ) del on del.dst_store_id = tt.store_id
    ) a
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    case
        when a.一派9点半前扫描占比 < 0.4 then '<40%'
        when a.一派9点半前扫描占比 >= 0.4 and a.一派9点半前扫描占比 < 0.5 then '40%-50%'
        when a.一派9点半前扫描占比 >= 0.5 and a.一派9点半前扫描占比 < 0.6 then '50%-60%'
        when a.一派9点半前扫描占比 >= 0.6 and a.一派9点半前扫描占比 < 0.7 then '60%-70%'
        when a.一派9点半前扫描占比 >= 0.7 and a.一派9点半前扫描占比 < 0.8 then '70%-80%'
        when a.一派9点半前扫描占比 >= 0.8 and a.一派9点半前扫描占比 < 0.9 then '80%-90%'
        when a.一派9点半前扫描占比 >= 0.9 and a.一派9点半前扫描占比 <= 1 then '90%-100%'
#         else a.一派9点半前扫描占比
    end 0930前分拣扫描占比
    ,count(distinct a.网点ID) 总数
    ,sum(a.del_pno_num)/sum(a.pno_num) 妥投率
from
    (

        select -- 基于当日应派取扫描率
            tt.store_id 网点ID
            ,tt.store_name 网点名称
            ,tt.store_type 网点分类
            ,tt.piece_name 片区
            ,tt.region_name 大区
            ,tt.shoud_counts 应派总数
            ,tt.scan_fished_counts 分拣扫描数
            ,ifnull(tt.scan_fished_counts/shoud_counts,0) 分拣扫描率

            ,tt.youxiao_counts 有效分拣扫描数
            ,ifnull(tt.youxiao_counts/tt.shoud_counts,0) 有效分拣扫描率

            ,tt.1pai_counts 一派应派数
            ,tt.1pai_scan_fished_counts 一派分拣扫描数
            ,ifnull(tt.1pai_scan_fished_counts/tt.1pai_counts,0) 一派分拣扫描率

            ,tt.1pai_youxiao_counts 一派有效分拣扫描数
            ,ifnull(tt.1pai_youxiao_counts/tt.1pai_counts,0) 一派有效分拣扫描率

            ,case
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.95 then 'A'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.90 then 'B'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.85 then 'C'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.80 then 'D'
                else 'E'
             end 一派有效分拣评级 -- 一派有效分拣

             ,case
                when tt.1pai_hour_8_fished_counts/tt.1pai_counts>=0.95  then 'A'
                when tt.1pai_hour_8ban_fished_counts/tt.1pai_counts>=0.95  then 'B'
                when tt.1pai_hour_9_fished_counts/tt.1pai_counts>=0.95  then 'C'
                when tt.1pai_hour_9ban_fished_counts/tt.1pai_counts>=0.95  then 'D'
                else 'E'
            end 一派分拣评级

            ,ifnull(tt.1pai_hour_8_fished_counts/tt.1pai_counts,0) 一派8点前扫描占比
            ,ifnull(tt.1pai_hour_8ban_fished_counts/tt.1pai_counts,0) 一派8点半前扫描占比
            ,ifnull(tt.1pai_hour_9_fished_counts/tt.1pai_counts,0) 一派9点前扫描占比
            ,ifnull(tt.1pai_hour_9ban_fished_counts/tt.1pai_counts,0) 一派9点半前扫描占比
            ,if(tt2.late_proof_counts is null , '否', '是') 是否有迟到超过规划时间20分钟的常规车
            ,tt2.max_real_arrive_time_normal 一派常规车最晚实际到达时间
        #     ,tt2.max_real_arrive_proof_id 一派常规车最晚实际到达车线
        #     ,tt2.max_real_arrive_vol 一派常规车最晚实际到达车线包裹量
            ,tt2.line_1_latest_plan_arrive_time 一派常规车最晚规划到达时间
            ,tt2.max_real_arrive_time_innormal 一派加班车最晚实际到达时间
        #     ,tt2.max_real_arrive_innormal_proof_id  一派加班车最晚实际到达车线
        #     ,tt2.max_real_arrive_innormal_vol  一派加班车最晚实际到达包裹量
            ,tt2.max_actual_plan_arrive_time_innormal 一派加班车最晚规划到达时间
            ,del.del_rate
            ,del.pno_num
            ,del.del_pno_num
        from
            (
                select
                   base.store_id
                   ,base.store_name
                   ,base.store_type
                   ,base.piece_name
                   ,base.region_name
                   ,count(distinct base.pno) shoud_counts
                   ,count(distinct case when base.min_fenjian_scan_time is not null then base.pno else null end ) scan_fished_counts
                   ,count(distinct case when base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then base.pno else null end ) youxiao_counts

                   ,count(distinct case when base.type='一派' then  base.pno else null end ) 1pai_counts
                   ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null then  base.pno else null end ) 1pai_scan_fished_counts
                   ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then  base.pno else null end ) 1pai_youxiao_counts

                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:00:00' then base.pno else null end) 1pai_hour_8_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:30:00' then base.pno else null end) 1pai_hour_8ban_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:00:00' then base.pno else null end) 1pai_hour_9_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:30:00' then base.pno else null end) 1pai_hour_9ban_fished_counts

                from
                (
                   select
                   t.*,
                   case when t.should_delevry_type='1派应派包裹' then '一派' else null end 'type'
                   from dwm.dwd_ph_dc_should_be_delivery_sort_scan t
                   join ph_staging.sys_store ss
                   on t.store_id =ss.id
                ) base
                group by base.store_id,base.store_name,base.store_type,base.piece_name,base.region_name
            ) tt

        left join
            (
                select
                   bl.store_id
                   ,bl.max_real_arrive_time_normal
                   ,bl.max_real_arrive_proof_id
                   ,bl.max_real_arrive_vol
                   ,bl.line_1_latest_plan_arrive_time
                   ,bl.max_actual_plan_arrive_time_innormal
                   ,bl.max_actual_plan_arrive_innormal_proof_id
                   ,bl.max_actual_plan_arrive_innormal_vol
                   ,bl.max_real_arrive_time_innormal
                   ,bl.max_real_arrive_innormal_proof_id
                   ,bl.max_real_arrive_innormal_vol
                   ,late_proof_counts
                from dwm.fleet_real_detail_today bl
                group by 1,2,3,4,5,6,7,8,9,10,11
            ) tt2 on tt.store_id=tt2.store_id
        left join
            (
                select
                    ds.dst_store_id
                    ,count(distinct ds.pno) pno_num
                    ,count(if(pi.pno is not null, ds.pno, null)) del_pno_num
                    ,count(if(pi.pno is not null, ds.pno, null))/count(distinct ds.pno) del_rate
                from dwm.dwd_ph_dc_should_be_delivery ds
                left join ph_staging.parcel_info pi on pi.pno = ds.pno and pi.state = 5 and pi.finished_at >= date_sub('2023-09-18', interval 8 hour ) and pi.finished_at < date_add('2023-09-18', interval 16 hour)
                where
                    ds.p_date = '2023-09-18'
                    and ds.should_delevry_type != '非当日应派'
                group by 1
            ) del on del.dst_store_id = tt.store_id
    ) a
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    a.负责人
    ,a.大区
    ,count(distinct a.网点ID) 总网点数
    ,count(distinct if(a.一派9点半前扫描占比 < 0.8, a.网点ID, null)) 问题网点数
    ,count(distinct if(a.一派9点半前扫描占比 < 0.8, a.网点ID, null))/count(distinct a.网点ID)  问题比例
from
    (

        select -- 基于当日应派取扫描率
            tt.store_id 网点ID
            ,tt.store_name 网点名称
            ,tt.store_type 网点分类
            ,tt.piece_name 片区
            ,tt.region_name 大区
            ,case
                when tt.region_name in ('Area3', 'Area6') then '彭万松'
                when tt.region_name in ('Area4', 'Area9') then '韩钥'
                when tt.region_name in ('Area7','Area10', 'Area11','FHome','Area14') then '张可新'
                when tt.region_name in ('Area8') then '黄勇'
                when tt.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
            end 负责人
            ,tt.shoud_counts 应派总数
            ,tt.scan_fished_counts 分拣扫描数
            ,ifnull(tt.scan_fished_counts/shoud_counts,0) 分拣扫描率

            ,tt.youxiao_counts 有效分拣扫描数
            ,ifnull(tt.youxiao_counts/tt.shoud_counts,0) 有效分拣扫描率

            ,tt.1pai_counts 一派应派数
            ,tt.1pai_scan_fished_counts 一派分拣扫描数
            ,ifnull(tt.1pai_scan_fished_counts/tt.1pai_counts,0) 一派分拣扫描率

            ,tt.1pai_youxiao_counts 一派有效分拣扫描数
            ,ifnull(tt.1pai_youxiao_counts/tt.1pai_counts,0) 一派有效分拣扫描率

            ,case
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.95 then 'A'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.90 then 'B'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.85 then 'C'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.80 then 'D'
                else 'E'
             end 一派有效分拣评级 -- 一派有效分拣

             ,case
                when tt.1pai_hour_8_fished_counts/tt.1pai_counts>=0.95  then 'A'
                when tt.1pai_hour_8ban_fished_counts/tt.1pai_counts>=0.95  then 'B'
                when tt.1pai_hour_9_fished_counts/tt.1pai_counts>=0.95  then 'C'
                when tt.1pai_hour_9ban_fished_counts/tt.1pai_counts>=0.95  then 'D'
                else 'E'
            end 一派分拣评级

            ,ifnull(tt.1pai_hour_8_fished_counts/tt.1pai_counts,0) 一派8点前扫描占比
            ,ifnull(tt.1pai_hour_8ban_fished_counts/tt.1pai_counts,0) 一派8点半前扫描占比
            ,ifnull(tt.1pai_hour_9_fished_counts/tt.1pai_counts,0) 一派9点前扫描占比
            ,ifnull(tt.1pai_hour_9ban_fished_counts/tt.1pai_counts,0) 一派9点半前扫描占比
            ,if(tt2.late_proof_counts is null , '否', '是') 是否有迟到超过规划时间20分钟的常规车
            ,tt2.max_real_arrive_time_normal 一派常规车最晚实际到达时间
        #     ,tt2.max_real_arrive_proof_id 一派常规车最晚实际到达车线
        #     ,tt2.max_real_arrive_vol 一派常规车最晚实际到达车线包裹量
            ,tt2.line_1_latest_plan_arrive_time 一派常规车最晚规划到达时间
            ,tt2.max_real_arrive_time_innormal 一派加班车最晚实际到达时间
        #     ,tt2.max_real_arrive_innormal_proof_id  一派加班车最晚实际到达车线
        #     ,tt2.max_real_arrive_innormal_vol  一派加班车最晚实际到达包裹量
            ,tt2.max_actual_plan_arrive_time_innormal 一派加班车最晚规划到达时间
            ,del.del_rate
            ,del.pno_num
            ,del.del_pno_num
        from
            (
                select
                   base.store_id
                   ,base.store_name
                   ,base.store_type
                   ,base.piece_name
                   ,base.region_name
                   ,count(distinct base.pno) shoud_counts
                   ,count(distinct case when base.min_fenjian_scan_time is not null then base.pno else null end ) scan_fished_counts
                   ,count(distinct case when base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then base.pno else null end ) youxiao_counts

                   ,count(distinct case when base.type='一派' then  base.pno else null end ) 1pai_counts
                   ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null then  base.pno else null end ) 1pai_scan_fished_counts
                   ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then  base.pno else null end ) 1pai_youxiao_counts

                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:00:00' then base.pno else null end) 1pai_hour_8_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:30:00' then base.pno else null end) 1pai_hour_8ban_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:00:00' then base.pno else null end) 1pai_hour_9_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:30:00' then base.pno else null end) 1pai_hour_9ban_fished_counts

                from
                (
                   select
                   t.*,
                   case when t.should_delevry_type='1派应派包裹' then '一派' else null end 'type'
                   from dwm.dwd_ph_dc_should_be_delivery_sort_scan t
                   join ph_staging.sys_store ss
                   on t.store_id =ss.id
                ) base
                group by base.store_id,base.store_name,base.store_type,base.piece_name,base.region_name
            ) tt

        left join
            (
                select
                   bl.store_id
                   ,bl.max_real_arrive_time_normal
                   ,bl.max_real_arrive_proof_id
                   ,bl.max_real_arrive_vol
                   ,bl.line_1_latest_plan_arrive_time
                   ,bl.max_actual_plan_arrive_time_innormal
                   ,bl.max_actual_plan_arrive_innormal_proof_id
                   ,bl.max_actual_plan_arrive_innormal_vol
                   ,bl.max_real_arrive_time_innormal
                   ,bl.max_real_arrive_innormal_proof_id
                   ,bl.max_real_arrive_innormal_vol
                   ,late_proof_counts
                from dwm.fleet_real_detail_today bl
                group by 1,2,3,4,5,6,7,8,9,10,11
            ) tt2 on tt.store_id=tt2.store_id
        left join
            (
                select
                    ds.dst_store_id
                    ,count(distinct ds.pno) pno_num
                    ,count(if(pi.pno is not null, ds.pno, null)) del_pno_num
                    ,count(if(pi.pno is not null, ds.pno, null))/count(distinct ds.pno) del_rate
                from dwm.dwd_ph_dc_should_be_delivery ds
                left join ph_staging.parcel_info pi on pi.pno = ds.pno and pi.state = 5 and pi.finished_at >= date_sub('2023-09-18', interval 8 hour ) and pi.finished_at < date_add('2023-09-18', interval 16 hour)
                where
                    ds.p_date = '2023-09-18'
                    and ds.should_delevry_type != '非当日应派'
                group by 1
            ) del on del.dst_store_id = tt.store_id
    ) a
group by 1,2;
;-- -. . -..- - / . -. - .-. -.--
select
    a.负责人
#     ,a.大区
    ,count(distinct a.网点ID) 总网点数
    ,count(distinct if(a.一派9点半前扫描占比 < 0.8, a.网点ID, null)) 问题网点数
    ,count(distinct if(a.一派9点半前扫描占比 < 0.8, a.网点ID, null))/count(distinct a.网点ID)  问题比例
from
    (

        select -- 基于当日应派取扫描率
            tt.store_id 网点ID
            ,tt.store_name 网点名称
            ,tt.store_type 网点分类
            ,tt.piece_name 片区
            ,tt.region_name 大区
            ,case
                when tt.region_name in ('Area3', 'Area6') then '彭万松'
                when tt.region_name in ('Area4', 'Area9') then '韩钥'
                when tt.region_name in ('Area7','Area10', 'Area11','FHome','Area14') then '张可新'
                when tt.region_name in ('Area8') then '黄勇'
                when tt.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
            end 负责人
            ,tt.shoud_counts 应派总数
            ,tt.scan_fished_counts 分拣扫描数
            ,ifnull(tt.scan_fished_counts/shoud_counts,0) 分拣扫描率

            ,tt.youxiao_counts 有效分拣扫描数
            ,ifnull(tt.youxiao_counts/tt.shoud_counts,0) 有效分拣扫描率

            ,tt.1pai_counts 一派应派数
            ,tt.1pai_scan_fished_counts 一派分拣扫描数
            ,ifnull(tt.1pai_scan_fished_counts/tt.1pai_counts,0) 一派分拣扫描率

            ,tt.1pai_youxiao_counts 一派有效分拣扫描数
            ,ifnull(tt.1pai_youxiao_counts/tt.1pai_counts,0) 一派有效分拣扫描率

            ,case
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.95 then 'A'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.90 then 'B'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.85 then 'C'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.80 then 'D'
                else 'E'
             end 一派有效分拣评级 -- 一派有效分拣

             ,case
                when tt.1pai_hour_8_fished_counts/tt.1pai_counts>=0.95  then 'A'
                when tt.1pai_hour_8ban_fished_counts/tt.1pai_counts>=0.95  then 'B'
                when tt.1pai_hour_9_fished_counts/tt.1pai_counts>=0.95  then 'C'
                when tt.1pai_hour_9ban_fished_counts/tt.1pai_counts>=0.95  then 'D'
                else 'E'
            end 一派分拣评级

            ,ifnull(tt.1pai_hour_8_fished_counts/tt.1pai_counts,0) 一派8点前扫描占比
            ,ifnull(tt.1pai_hour_8ban_fished_counts/tt.1pai_counts,0) 一派8点半前扫描占比
            ,ifnull(tt.1pai_hour_9_fished_counts/tt.1pai_counts,0) 一派9点前扫描占比
            ,ifnull(tt.1pai_hour_9ban_fished_counts/tt.1pai_counts,0) 一派9点半前扫描占比
            ,if(tt2.late_proof_counts is null , '否', '是') 是否有迟到超过规划时间20分钟的常规车
            ,tt2.max_real_arrive_time_normal 一派常规车最晚实际到达时间
        #     ,tt2.max_real_arrive_proof_id 一派常规车最晚实际到达车线
        #     ,tt2.max_real_arrive_vol 一派常规车最晚实际到达车线包裹量
            ,tt2.line_1_latest_plan_arrive_time 一派常规车最晚规划到达时间
            ,tt2.max_real_arrive_time_innormal 一派加班车最晚实际到达时间
        #     ,tt2.max_real_arrive_innormal_proof_id  一派加班车最晚实际到达车线
        #     ,tt2.max_real_arrive_innormal_vol  一派加班车最晚实际到达包裹量
            ,tt2.max_actual_plan_arrive_time_innormal 一派加班车最晚规划到达时间
            ,del.del_rate
            ,del.pno_num
            ,del.del_pno_num
        from
            (
                select
                   base.store_id
                   ,base.store_name
                   ,base.store_type
                   ,base.piece_name
                   ,base.region_name
                   ,count(distinct base.pno) shoud_counts
                   ,count(distinct case when base.min_fenjian_scan_time is not null then base.pno else null end ) scan_fished_counts
                   ,count(distinct case when base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then base.pno else null end ) youxiao_counts

                   ,count(distinct case when base.type='一派' then  base.pno else null end ) 1pai_counts
                   ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null then  base.pno else null end ) 1pai_scan_fished_counts
                   ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then  base.pno else null end ) 1pai_youxiao_counts

                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:00:00' then base.pno else null end) 1pai_hour_8_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:30:00' then base.pno else null end) 1pai_hour_8ban_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:00:00' then base.pno else null end) 1pai_hour_9_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:30:00' then base.pno else null end) 1pai_hour_9ban_fished_counts

                from
                (
                   select
                   t.*,
                   case when t.should_delevry_type='1派应派包裹' then '一派' else null end 'type'
                   from dwm.dwd_ph_dc_should_be_delivery_sort_scan t
                   join ph_staging.sys_store ss
                   on t.store_id =ss.id
                ) base
                group by base.store_id,base.store_name,base.store_type,base.piece_name,base.region_name
            ) tt

        left join
            (
                select
                   bl.store_id
                   ,bl.max_real_arrive_time_normal
                   ,bl.max_real_arrive_proof_id
                   ,bl.max_real_arrive_vol
                   ,bl.line_1_latest_plan_arrive_time
                   ,bl.max_actual_plan_arrive_time_innormal
                   ,bl.max_actual_plan_arrive_innormal_proof_id
                   ,bl.max_actual_plan_arrive_innormal_vol
                   ,bl.max_real_arrive_time_innormal
                   ,bl.max_real_arrive_innormal_proof_id
                   ,bl.max_real_arrive_innormal_vol
                   ,late_proof_counts
                from dwm.fleet_real_detail_today bl
                group by 1,2,3,4,5,6,7,8,9,10,11
            ) tt2 on tt.store_id=tt2.store_id
        left join
            (
                select
                    ds.dst_store_id
                    ,count(distinct ds.pno) pno_num
                    ,count(if(pi.pno is not null, ds.pno, null)) del_pno_num
                    ,count(if(pi.pno is not null, ds.pno, null))/count(distinct ds.pno) del_rate
                from dwm.dwd_ph_dc_should_be_delivery ds
                left join ph_staging.parcel_info pi on pi.pno = ds.pno and pi.state = 5 and pi.finished_at >= date_sub('2023-09-18', interval 8 hour ) and pi.finished_at < date_add('2023-09-18', interval 16 hour)
                where
                    ds.p_date = '2023-09-18'
                    and ds.should_delevry_type != '非当日应派'
                group by 1
            ) del on del.dst_store_id = tt.store_id
    ) a
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    a.负责人
    ,a.大区
    ,count(distinct a.网点ID) 总网点数
    ,count(distinct if(a.一派分拣评级 = 'E', a.网点ID, null)) 问题网点数
    ,count(distinct if(a.一派分拣评级 = 'E', a.网点ID, null))/count(distinct a.网点ID)  问题比例
from
    (

        select -- 基于当日应派取扫描率
            tt.store_id 网点ID
            ,tt.store_name 网点名称
            ,tt.store_type 网点分类
            ,tt.piece_name 片区
            ,tt.region_name 大区
            ,case
                when tt.region_name in ('Area3', 'Area6') then '彭万松'
                when tt.region_name in ('Area4', 'Area9') then '韩钥'
                when tt.region_name in ('Area7','Area10', 'Area11','FHome','Area14') then '张可新'
                when tt.region_name in ('Area8') then '黄勇'
                when tt.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
            end 负责人
            ,tt.shoud_counts 应派总数
            ,tt.scan_fished_counts 分拣扫描数
            ,ifnull(tt.scan_fished_counts/shoud_counts,0) 分拣扫描率

            ,tt.youxiao_counts 有效分拣扫描数
            ,ifnull(tt.youxiao_counts/tt.shoud_counts,0) 有效分拣扫描率

            ,tt.1pai_counts 一派应派数
            ,tt.1pai_scan_fished_counts 一派分拣扫描数
            ,ifnull(tt.1pai_scan_fished_counts/tt.1pai_counts,0) 一派分拣扫描率

            ,tt.1pai_youxiao_counts 一派有效分拣扫描数
            ,ifnull(tt.1pai_youxiao_counts/tt.1pai_counts,0) 一派有效分拣扫描率

            ,case
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.95 then 'A'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.90 then 'B'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.85 then 'C'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.80 then 'D'
                else 'E'
             end 一派有效分拣评级 -- 一派有效分拣

             ,case
                when tt.1pai_hour_8_fished_counts/tt.1pai_counts>=0.95  then 'A'
                when tt.1pai_hour_8ban_fished_counts/tt.1pai_counts>=0.95  then 'B'
                when tt.1pai_hour_9_fished_counts/tt.1pai_counts>=0.95  then 'C'
                when tt.1pai_hour_9ban_fished_counts/tt.1pai_counts>=0.95  then 'D'
                else 'E'
            end 一派分拣评级

            ,ifnull(tt.1pai_hour_8_fished_counts/tt.1pai_counts,0) 一派8点前扫描占比
            ,ifnull(tt.1pai_hour_8ban_fished_counts/tt.1pai_counts,0) 一派8点半前扫描占比
            ,ifnull(tt.1pai_hour_9_fished_counts/tt.1pai_counts,0) 一派9点前扫描占比
            ,ifnull(tt.1pai_hour_9ban_fished_counts/tt.1pai_counts,0) 一派9点半前扫描占比
            ,if(tt2.late_proof_counts is null , '否', '是') 是否有迟到超过规划时间20分钟的常规车
            ,tt2.max_real_arrive_time_normal 一派常规车最晚实际到达时间
        #     ,tt2.max_real_arrive_proof_id 一派常规车最晚实际到达车线
        #     ,tt2.max_real_arrive_vol 一派常规车最晚实际到达车线包裹量
            ,tt2.line_1_latest_plan_arrive_time 一派常规车最晚规划到达时间
            ,tt2.max_real_arrive_time_innormal 一派加班车最晚实际到达时间
        #     ,tt2.max_real_arrive_innormal_proof_id  一派加班车最晚实际到达车线
        #     ,tt2.max_real_arrive_innormal_vol  一派加班车最晚实际到达包裹量
            ,tt2.max_actual_plan_arrive_time_innormal 一派加班车最晚规划到达时间
            ,del.del_rate
            ,del.pno_num
            ,del.del_pno_num
        from
            (
                select
                   base.store_id
                   ,base.store_name
                   ,base.store_type
                   ,base.piece_name
                   ,base.region_name
                   ,count(distinct base.pno) shoud_counts
                   ,count(distinct case when base.min_fenjian_scan_time is not null then base.pno else null end ) scan_fished_counts
                   ,count(distinct case when base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then base.pno else null end ) youxiao_counts

                   ,count(distinct case when base.type='一派' then  base.pno else null end ) 1pai_counts
                   ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null then  base.pno else null end ) 1pai_scan_fished_counts
                   ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then  base.pno else null end ) 1pai_youxiao_counts

                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:00:00' then base.pno else null end) 1pai_hour_8_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:30:00' then base.pno else null end) 1pai_hour_8ban_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:00:00' then base.pno else null end) 1pai_hour_9_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:30:00' then base.pno else null end) 1pai_hour_9ban_fished_counts

                from
                (
                   select
                   t.*,
                   case when t.should_delevry_type='1派应派包裹' then '一派' else null end 'type'
                   from dwm.dwd_ph_dc_should_be_delivery_sort_scan t
                   join ph_staging.sys_store ss
                   on t.store_id =ss.id
                ) base
                group by base.store_id,base.store_name,base.store_type,base.piece_name,base.region_name
            ) tt

        left join
            (
                select
                   bl.store_id
                   ,bl.max_real_arrive_time_normal
                   ,bl.max_real_arrive_proof_id
                   ,bl.max_real_arrive_vol
                   ,bl.line_1_latest_plan_arrive_time
                   ,bl.max_actual_plan_arrive_time_innormal
                   ,bl.max_actual_plan_arrive_innormal_proof_id
                   ,bl.max_actual_plan_arrive_innormal_vol
                   ,bl.max_real_arrive_time_innormal
                   ,bl.max_real_arrive_innormal_proof_id
                   ,bl.max_real_arrive_innormal_vol
                   ,late_proof_counts
                from dwm.fleet_real_detail_today bl
                group by 1,2,3,4,5,6,7,8,9,10,11
            ) tt2 on tt.store_id=tt2.store_id
        left join
            (
                select
                    ds.dst_store_id
                    ,count(distinct ds.pno) pno_num
                    ,count(if(pi.pno is not null, ds.pno, null)) del_pno_num
                    ,count(if(pi.pno is not null, ds.pno, null))/count(distinct ds.pno) del_rate
                from dwm.dwd_ph_dc_should_be_delivery ds
                left join ph_staging.parcel_info pi on pi.pno = ds.pno and pi.state = 5 and pi.finished_at >= date_sub('2023-09-18', interval 8 hour ) and pi.finished_at < date_add('2023-09-18', interval 16 hour)
                where
                    ds.p_date = '2023-09-18'
                    and ds.should_delevry_type != '非当日应派'
                group by 1
            ) del on del.dst_store_id = tt.store_id
    ) a
group by 1,2;
;-- -. . -..- - / . -. - .-. -.--
select
    a.负责人
#     ,a.大区
    ,count(distinct a.网点ID) 总网点数
    ,count(distinct if(a.一派分拣评级 = 'E', a.网点ID, null)) 问题网点数
    ,count(distinct if(a.一派分拣评级 = 'E', a.网点ID, null))/count(distinct a.网点ID)  问题比例
from
    (

        select -- 基于当日应派取扫描率
            tt.store_id 网点ID
            ,tt.store_name 网点名称
            ,tt.store_type 网点分类
            ,tt.piece_name 片区
            ,tt.region_name 大区
            ,case
                when tt.region_name in ('Area3', 'Area6') then '彭万松'
                when tt.region_name in ('Area4', 'Area9') then '韩钥'
                when tt.region_name in ('Area7','Area10', 'Area11','FHome','Area14') then '张可新'
                when tt.region_name in ('Area8') then '黄勇'
                when tt.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
            end 负责人
            ,tt.shoud_counts 应派总数
            ,tt.scan_fished_counts 分拣扫描数
            ,ifnull(tt.scan_fished_counts/shoud_counts,0) 分拣扫描率

            ,tt.youxiao_counts 有效分拣扫描数
            ,ifnull(tt.youxiao_counts/tt.shoud_counts,0) 有效分拣扫描率

            ,tt.1pai_counts 一派应派数
            ,tt.1pai_scan_fished_counts 一派分拣扫描数
            ,ifnull(tt.1pai_scan_fished_counts/tt.1pai_counts,0) 一派分拣扫描率

            ,tt.1pai_youxiao_counts 一派有效分拣扫描数
            ,ifnull(tt.1pai_youxiao_counts/tt.1pai_counts,0) 一派有效分拣扫描率

            ,case
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.95 then 'A'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.90 then 'B'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.85 then 'C'
                when tt.1pai_youxiao_counts/tt.1pai_counts>=0.80 then 'D'
                else 'E'
             end 一派有效分拣评级 -- 一派有效分拣

             ,case
                when tt.1pai_hour_8_fished_counts/tt.1pai_counts>=0.95  then 'A'
                when tt.1pai_hour_8ban_fished_counts/tt.1pai_counts>=0.95  then 'B'
                when tt.1pai_hour_9_fished_counts/tt.1pai_counts>=0.95  then 'C'
                when tt.1pai_hour_9ban_fished_counts/tt.1pai_counts>=0.95  then 'D'
                else 'E'
            end 一派分拣评级

            ,ifnull(tt.1pai_hour_8_fished_counts/tt.1pai_counts,0) 一派8点前扫描占比
            ,ifnull(tt.1pai_hour_8ban_fished_counts/tt.1pai_counts,0) 一派8点半前扫描占比
            ,ifnull(tt.1pai_hour_9_fished_counts/tt.1pai_counts,0) 一派9点前扫描占比
            ,ifnull(tt.1pai_hour_9ban_fished_counts/tt.1pai_counts,0) 一派9点半前扫描占比
            ,if(tt2.late_proof_counts is null , '否', '是') 是否有迟到超过规划时间20分钟的常规车
            ,tt2.max_real_arrive_time_normal 一派常规车最晚实际到达时间
        #     ,tt2.max_real_arrive_proof_id 一派常规车最晚实际到达车线
        #     ,tt2.max_real_arrive_vol 一派常规车最晚实际到达车线包裹量
            ,tt2.line_1_latest_plan_arrive_time 一派常规车最晚规划到达时间
            ,tt2.max_real_arrive_time_innormal 一派加班车最晚实际到达时间
        #     ,tt2.max_real_arrive_innormal_proof_id  一派加班车最晚实际到达车线
        #     ,tt2.max_real_arrive_innormal_vol  一派加班车最晚实际到达包裹量
            ,tt2.max_actual_plan_arrive_time_innormal 一派加班车最晚规划到达时间
            ,del.del_rate
            ,del.pno_num
            ,del.del_pno_num
        from
            (
                select
                   base.store_id
                   ,base.store_name
                   ,base.store_type
                   ,base.piece_name
                   ,base.region_name
                   ,count(distinct base.pno) shoud_counts
                   ,count(distinct case when base.min_fenjian_scan_time is not null then base.pno else null end ) scan_fished_counts
                   ,count(distinct case when base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then base.pno else null end ) youxiao_counts

                   ,count(distinct case when base.type='一派' then  base.pno else null end ) 1pai_counts
                   ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null then  base.pno else null end ) 1pai_scan_fished_counts
                   ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then  base.pno else null end ) 1pai_youxiao_counts

                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:00:00' then base.pno else null end) 1pai_hour_8_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:30:00' then base.pno else null end) 1pai_hour_8ban_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:00:00' then base.pno else null end) 1pai_hour_9_fished_counts
                   ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:30:00' then base.pno else null end) 1pai_hour_9ban_fished_counts

                from
                (
                   select
                   t.*,
                   case when t.should_delevry_type='1派应派包裹' then '一派' else null end 'type'
                   from dwm.dwd_ph_dc_should_be_delivery_sort_scan t
                   join ph_staging.sys_store ss
                   on t.store_id =ss.id
                ) base
                group by base.store_id,base.store_name,base.store_type,base.piece_name,base.region_name
            ) tt

        left join
            (
                select
                   bl.store_id
                   ,bl.max_real_arrive_time_normal
                   ,bl.max_real_arrive_proof_id
                   ,bl.max_real_arrive_vol
                   ,bl.line_1_latest_plan_arrive_time
                   ,bl.max_actual_plan_arrive_time_innormal
                   ,bl.max_actual_plan_arrive_innormal_proof_id
                   ,bl.max_actual_plan_arrive_innormal_vol
                   ,bl.max_real_arrive_time_innormal
                   ,bl.max_real_arrive_innormal_proof_id
                   ,bl.max_real_arrive_innormal_vol
                   ,late_proof_counts
                from dwm.fleet_real_detail_today bl
                group by 1,2,3,4,5,6,7,8,9,10,11
            ) tt2 on tt.store_id=tt2.store_id
        left join
            (
                select
                    ds.dst_store_id
                    ,count(distinct ds.pno) pno_num
                    ,count(if(pi.pno is not null, ds.pno, null)) del_pno_num
                    ,count(if(pi.pno is not null, ds.pno, null))/count(distinct ds.pno) del_rate
                from dwm.dwd_ph_dc_should_be_delivery ds
                left join ph_staging.parcel_info pi on pi.pno = ds.pno and pi.state = 5 and pi.finished_at >= date_sub('2023-09-18', interval 8 hour ) and pi.finished_at < date_add('2023-09-18', interval 16 hour)
                where
                    ds.p_date = '2023-09-18'
                    and ds.should_delevry_type != '非当日应派'
                group by 1
            ) del on del.dst_store_id = tt.store_id
    ) a
group by 1;
;-- -. . -..- - / . -. - .-. -.--
with d as
    (
        select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-09-18'
    )
    , t as
    (
        select
             ds.store_id
            ,ds.pno
            ,ds.stat_date
        from d ds
        left join
            (
                select
                    pr.pno
                    ,ds.stat_date
                    ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
                from ph_staging.parcel_route pr
                join d ds on pr.pno = ds.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                    and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and pr.marker_category in (42,43) ##岛屿,偏远地区
                group by 1,2
            ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
        left join
            (
                select
                   pr.pno
                    ,ds.stat_date
                   ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
                   ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
                from ph_staging.parcel_route pr
                join d ds on ds.pno = pr.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                    and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                    and pr.marker_category in (9,14,70) ##客户改约时间
            ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
        left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
        where
            case
                when pr1.pno is not null then 'N'
                when pr2.pno is not null then 'N'
                when ds1.pno is not null  then 'N'  else 'Y'
            end = 'Y'
    )
    select
        a.stat_date 日期
        ,a.store_id 网点ID
        ,dp.store_name 网点名称
        ,dp.opening_at 开业时间
        ,case
            when dp.region_name in ('Area3', 'Area6') then '彭万松'
            when dp.region_name in ('Area4', 'Area9') then '韩钥'
            when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
            when dp.region_name in ( 'Area8') then '黄勇'
            when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
        end 区域
        ,dp.region_name 大区
        ,dp.piece_name 片区
        ,a.应交接
        ,a.已交接
        ,concat(round(a.交接率*100,2),'%') as 交接率
        ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
        ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
        ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
        ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
        ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
    from
        (
            select
                t1.store_id
                ,t1.stat_date
                ,count(t1.pno) 应交接
                ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
            from t t1
            left join
                (
                    select
                        sc.*
                    from
                        (
                            select
                                pr.pno
                                ,pr.store_id
                                ,pr.store_name
                                ,t1.stat_date
                                ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                            from ph_staging.parcel_route pr
                            join t t1 on t1.pno = pr.pno
                            where
                                pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                               and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                              and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                        ) sc
                    where
                        sc.rk = 1
                ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
            group by 1,2
        ) a
    join
        (
            select
                sd.store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.store_id is not null
            group by 1

            union all

            select
                sd.separation_store_id store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.separation_store_id is not null
            group by 1
        ) sd on sd.store_id = a.store_id
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    where
        dp.store_category in (1,10);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-18'
        and pr.routed_at >= date_sub('2023-09-18', interval 8 hour )
        and pr.routed_at < date_add('2023-09-18', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,if(a3.self_staff_num + other_staff_num > coalesce(sdb.code_num, 0),
           case
            when a2.avg_staff_code < 2 then 'A'
            when a2.avg_staff_code >= 2 and a2.avg_staff_code < 3 then 'B'
            when a2.avg_staff_code >= 3 and a2.avg_staff_code < 4 then 'C'
            when a2.avg_staff_code >= 4 then 'D'
        end,
           case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end ) 评级
#         ,a2.code_num
#         ,a2.staff_code_num
#         ,a2.staff_num
#         ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) avg_staff_code
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
            ,count(distinct sdb.district_code) barangay_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-18'
        and pr.routed_at >= date_sub('2023-09-18', interval 8 hour )
        and pr.routed_at < date_add('2023-09-18', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)

select
    a1.store_id
    ,ss.name 网点
    ,ss2.staff_count 交接员工数
    ,sdb.code_num 网点现有三段码数
    ,if(ss2.staff_count > sdb.code_num, '人比码多', '码比人多') 人码对比
    ,sdb.barangay_num 网点绑定三段码barangay数
    ,a1.third_sorting_code
#     ,if(a1.is_self = 'y', '本网点', '非本网点') 员工归属
#     ,hjt.job_name 岗位
    ,count(distinct a1.staff_info_id) 交接三段码数
    ,group_concat(distinct a1.staff_info_id) 交接三段码
from
    (
        select
            a1.*
        from
            (
                select
                    t1.store_id
                    ,t1.pno
                    ,t1.staff_info_id
                    ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                    ,t1.state
                    ,t1.job_title
                    ,ps.third_sorting_code
                    ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                from t t1
                join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
            ) a1
        where
            a1.rk = 1
    ) a1
left join ph_staging.sys_store ss on ss.id = a1.store_id
left join ph_bi.hr_job_title hjt on hjt.id = a1.job_title
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
            ,count(distinct sdb.district_code) barangay_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a1.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.staff_info_id) staff_count
        from t t1
        where
            t1.job_title in (13,110,1000)
        group by 1
    ) ss2 on ss2.store_id = a1.store_id
where
    a1.job_title in (13,110,1000) -- 快递员
group by 1,2,3,4,5,6,7;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-09-18'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-09-18')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-09-18'
        and pi.finished_at >= date_sub('2023-09-18', interval 8 hour )
        and pi.finished_at < date_add('2023-09-18', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数

    ,coalesce(backlog.in_house_count, 0) 在仓包裹数
    ,coalesce(backlog.big_in_house_count, 0) 在仓大件包裹数
    ,coalesce(backlog.big_client_count, 0) 在仓平台客户包裹数
    ,coalesce(backlog.small_client_count, 0) 在仓非平台客户包裹数
    ,coalesce(backlog.3_within_backlog_bigclient, 0) 平台客户在仓积压3天内包裹数
    ,coalesce(backlog.3_5_backlog_bigclient, 0) 平台客户在仓积压3_5天内包裹数
    ,coalesce(backlog.5_more_backlog_bigclient, 0) 平台客户在仓积压5天以上包裹数
    ,coalesce(backlog.tt_overtime_count, 0) tiktok超时效包裹数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-09-18'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) in_house_count
            ,count(distinct if(pi.exhibition_weight > 5000 or pi.exhibition_length + pi.exhibition_width + pi.exhibition_height > 80, ds.pno, null)) big_in_house_count
            ,count(distinct if(bc.client_id is not null, ds.pno, null)) big_client_count
            ,count(distinct if(bc.client_id is null, ds.pno, null)) small_client_count
            ,count(distinct if(datediff(now(), ds.first_valid_routed_at) <= 3 and bc.client_id is not null, ds.pno, null)) 3_within_backlog_bigclient
            ,count(distinct if(datediff(now(), ds.first_valid_routed_at) > 3 and datediff(now(), ds.first_valid_routed_at) <= 5 and bc.client_id is not null, ds.pno, null)) 3_5_backlog_bigclient
            ,count(distinct if(datediff(now(), ds.first_valid_routed_at) > 5 and bc.client_id is not null, ds.pno, null)) 5_more_backlog_bigclient
            ,count(distinct if(tsd.end_date < curdate(), ds.pno, null)) tt_overtime_count
        from dwm.dwd_ph_dc_should_be_delivery ds
        join ph_staging.parcel_info pi on pi.pno = ds.pno and pi.state not in (5,7,8,9)
        left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
        left join dwm.dwd_ex_ph_tiktok_sla_detail tsd on tsd.pno = ds.pno
        where
            ds.p_date = '2023-09-18'
        group by 1
    ) backlog on backlog.dst_store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
select
    pi2.pno 正向单号
    ,ss.name 正向揽收网点
    ,pi2.src_detail_address 正向寄件人地址
    ,pi2.client_id 客户ID
    ,pi2.src_name 寄件人姓名
    ,pi.dst_detail_address 退件包裹目的地地址
    ,ss2.name 退件目的地网点
    ,convert_tz(pi.created_at, '+00:00', '+08:00') 退件包裹揽收时间
from ph_staging.parcel_info pi
left join ph_staging.parcel_info pi2 on pi2.returned_pno = pi.pno
left join ph_staging.sys_store ss on ss.id = pi2.ticket_pickup_store_id
left join ph_staging.sys_store ss2 on ss2.id = pi.dst_store_id
where
    pi.returned = 1
    and pi.created_at >= date_sub(date_sub(curdate(), interval 7 day), interval 8 hour) -- 近一周退件
    and ss.category = 14
    and ss2.category != 14;
;-- -. . -..- - / . -. - .-. -.--
with t as
    (
        select
            pi.pno
            ,pi.client_id
            ,pi.finished_at
            ,pi.ticket_delivery_staff_lng
            ,pi.ticket_delivery_staff_lat
            ,pi.dst_store_id
        from ph_staging.parcel_info pi
        where
            pi.state = 5
            and pi.returned = 0
            and pi.finished_at >= '2023-06-30 16:00:00'
            and pi.finished_at < '2023-08-31 16:00:00'
    )
select
    date(convert_tz(t1.finished_at, '+00:00', '+08:00')) 妥投日期
    ,t1.client_id 客户ID
    ,case
        when bc.client_id is not null then bc.client_name
        when bc.client_id is null and kp.id is not null then '普通KA'
        else '小c'
    end 客户类型
    ,case
        when st_distance_sphere(point(t1.ticket_delivery_staff_lng, t1.ticket_delivery_staff_lat), point(ss.lng, ss.lat)) <= 100 then '0-100'
        when st_distance_sphere(point(t1.ticket_delivery_staff_lng, t1.ticket_delivery_staff_lat), point(ss.lng, ss.lat)) > 100 and st_distance_sphere(point(t1.ticket_delivery_staff_lng, t1.ticket_delivery_staff_lat), point(ss.lng, ss.lat)) <= 200 then '100-200'
        when st_distance_sphere(point(t1.ticket_delivery_staff_lng, t1.ticket_delivery_staff_lat), point(ss.lng, ss.lat)) > 100 and st_distance_sphere(point(t1.ticket_delivery_staff_lng, t1.ticket_delivery_staff_lat), point(ss.lng, ss.lat)) <= 200 then '200-300'
        when st_distance_sphere(point(t1.ticket_delivery_staff_lng, t1.ticket_delivery_staff_lat), point(ss.lng, ss.lat)) > 100 and st_distance_sphere(point(t1.ticket_delivery_staff_lng, t1.ticket_delivery_staff_lat), point(ss.lng, ss.lat)) <= 200 then '300-400'
        when st_distance_sphere(point(t1.ticket_delivery_staff_lng, t1.ticket_delivery_staff_lat), point(ss.lng, ss.lat)) > 400 and st_distance_sphere(point(t1.ticket_delivery_staff_lng, t1.ticket_delivery_staff_lat), point(ss.lng, ss.lat)) <= 500 then '400-500'
        when st_distance_sphere(point(t1.ticket_delivery_staff_lng, t1.ticket_delivery_staff_lat), point(ss.lng, ss.lat)) > 500 then '500以上'
     end 妥投距离网点距离
    ,case
        when json_extract(ph.extra_value, '$.callDuration') >= 1 and json_extract(ph.extra_value, '$.callDuration') < 9 then '1-8'
        when json_extract(ph.extra_value, '$.callDuration') >= 9 and json_extract(ph.extra_value, '$.callDuration') < 11 then '9-10'
        when json_extract(ph.extra_value, '$.callDuration') >= 11 and json_extract(ph.extra_value, '$.callDuration') < 16 then '11-15'
        when json_extract(ph.extra_value, '$.callDuration') >= 16 and json_extract(ph.extra_value, '$.callDuration') < 21 then '16-20'
        when json_extract(ph.extra_value, '$.callDuration') >= 21 then '21以上'
        else '1以内'
    end 通话时长
    ,if(acc.pno is null, '否', '是') 是否有虚假投妥投诉
    ,count(distinct t1.pno) 包裹数
from t t1
left join
    (
        select
            pr.pno
            ,pr.extra_value
            ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno
        where
            pr.route_action = 'PHONE'
            and pr.routed_at < t1.finished_at
            and pr.routed_at > date_sub(curdate(), interval 90 day )
    ) ph on ph.pno = t1.pno and ph.rk = 1
left join ph_staging.sys_store ss on ss.id = t1.dst_store_id
left join ph_bi.abnormal_customer_complaint acc on acc.pno = t1.pno and acc.complaints_type = 1 -- 虚假妥投类
left join dwm.dwd_dim_bigClient bc on bc.client_id = t1.client_id
left join ph_staging.ka_profile kp on kp.id = t1.client_id
group by 1,2,3,4,5,6;
;-- -. . -..- - / . -. - .-. -.--
select
    date(vrv.created_at) 日期
    ,bc.client_name 客户类型
    ,count(distinct vrv.id) 回访继续派送包裹量
    ,count(if(datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), vrv.updated_at) = 1, vrv.id, null)) 回访后次日派送妥投成功
    ,count(if(datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), vrv.updated_at) = 2, vrv.id, null)) 回访后第二天派送妥投成功
    ,count(if(datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), vrv.updated_at) = 3, vrv.id, null)) 回访后第三天派送妥投成功
    ,count(if(datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), vrv.updated_at) > 3, vrv.id, null)) 回访后第三天以上派送妥投成功
    ,count(if(datediff(convert_tz(rep.created_at, '+00:00', '+08:00'), vrv.updated_at) = 1, vrv.id, null)) 回访后次日尝试派送退件
    ,count(if(datediff(convert_tz(rep.created_at, '+00:00', '+08:00'), vrv.updated_at) = 2, vrv.id, null)) 回访后第二天尝试派送退件
    ,count(if(datediff(convert_tz(rep.created_at, '+00:00', '+08:00'), vrv.updated_at) = 3, vrv.id, null)) 回访后第三天派送退件
    ,count(if(datediff(convert_tz(rep.created_at, '+00:00', '+08:00'), vrv.updated_at) > 3, vrv.id, null)) 回访后第三天以上以上尝试派送退件
from nl_production.violation_return_visit vrv
join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id and bc.client_name in ('tiktok', 'shopee')
left join ph_staging.parcel_info pi on pi.pno = vrv.link_id and pi.state = 5
left join ph_staging.parcel_info rep on rep.pno = pi.returned_pno
where
    vrv.type = 8 -- 多次尝试失败回访
    and vrv.created_at >= '2023-09-11'
    and vrv.created_at < '2023-09-16'
    and vrv.visit_result = 43 -- 回访继续派送
group by 1,2;
;-- -. . -..- - / . -. - .-. -.--
select
    date(vrv.created_at) 日期
    ,bc.client_name 客户类型
    ,count(distinct vrv.id) 回访继续派送包裹量
    ,count(if(datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), vrv.updated_at) = 1 and pi.state = 5, vrv.id, null)) 回访后次日派送妥投成功
    ,count(if(datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), vrv.updated_at) = 2 and pi.state = 5, vrv.id, null)) 回访后第二天派送妥投成功
    ,count(if(datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), vrv.updated_at) = 3 and pi.state = 5, vrv.id, null)) 回访后第三天派送妥投成功
    ,count(if(datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), vrv.updated_at) > 3 and pi.state = 5, vrv.id, null)) 回访后第三天以上派送妥投成功
    ,count(if(datediff(convert_tz(rep.created_at, '+00:00', '+08:00'), vrv.updated_at) = 1 and pi.state = 7, vrv.id, null)) 回访后次日尝试派送退件
    ,count(if(datediff(convert_tz(rep.created_at, '+00:00', '+08:00'), vrv.updated_at) = 2 and pi.state = 7, vrv.id, null)) 回访后第二天尝试派送退件
    ,count(if(datediff(convert_tz(rep.created_at, '+00:00', '+08:00'), vrv.updated_at) = 3 and pi.state = 7, vrv.id, null)) 回访后第三天派送退件
    ,count(if(datediff(convert_tz(rep.created_at, '+00:00', '+08:00'), vrv.updated_at) > 3 and pi.state = 7, vrv.id, null)) 回访后第三天以上以上尝试派送退件
from nl_production.violation_return_visit vrv
join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id and bc.client_name in ('tiktok', 'shopee')
left join ph_staging.parcel_info pi on pi.pno = vrv.link_id
left join ph_staging.parcel_info rep on rep.pno = pi.returned_pno
where
    vrv.type = 8 -- 多次尝试失败回访
    and vrv.created_at >= '2023-09-11'
    and vrv.created_at < '2023-09-16'
    and vrv.visit_result = 43 -- 回访继续派送
group by 1,2;
;-- -. . -..- - / . -. - .-. -.--
select
    date(vrv.created_at) 回访任务创建日期
    ,bc.client_name 客户类型
    ,pi.pno 单号
    ,pi.cod_amount/100 cod金额
    ,oi.cogs_amount/100 cogs金额
    ,pi.dst_phone 收件人手机号
from nl_production.violation_return_visit vrv
join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id and bc.client_name in ('tiktok', 'shopee')
left join ph_staging.parcel_info pi on pi.pno = vrv.link_id
left join ph_staging.order_info oi on oi.pno = pi.pno
# left join ph_staging.parcel_info rep on rep.pno = pi.returned_pno
where
    vrv.type = 8 -- 多次尝试失败回访
    and vrv.created_at >= '2023-09-11'
    and vrv.created_at < '2023-09-16'
    and vrv.visit_result = 43 -- 回访继续派送
    and pi.state = 5;
;-- -. . -..- - / . -. - .-. -.--
select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-09-21'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-09-21')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-09-21'
        and pi.finished_at >= date_sub('2023-09-21', interval 8 hour )
        and pi.finished_at < date_add('2023-09-21', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
        and ds.dst_store_id = 'PH18030101';
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-09-21'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-09-21')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-09-21'
        and pi.finished_at >= date_sub('2023-09-21', interval 8 hour )
        and pi.finished_at < date_add('2023-09-21', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
        and ds.dst_store_id = 'PH18030101'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数

    ,coalesce(backlog.in_house_count, 0) 在仓包裹数
    ,coalesce(backlog.big_in_house_count, 0) 在仓大件包裹数
    ,coalesce(backlog.big_client_count, 0) 在仓平台客户包裹数
    ,coalesce(backlog.small_client_count, 0) 在仓非平台客户包裹数
    ,coalesce(backlog.3_within_backlog_bigclient, 0) 平台客户在仓积压3天内包裹数
    ,coalesce(backlog.3_5_backlog_bigclient, 0) 平台客户在仓积压3_5天内包裹数
    ,coalesce(backlog.5_more_backlog_bigclient, 0) 平台客户在仓积压5天以上包裹数
    ,coalesce(backlog.tt_overtime_count, 0) tiktok超时效包裹数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-09-21'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) in_house_count
            ,count(distinct if(pi.exhibition_weight > 5000 or pi.exhibition_length + pi.exhibition_width + pi.exhibition_height > 80, ds.pno, null)) big_in_house_count
            ,count(distinct if(bc.client_id is not null, ds.pno, null)) big_client_count
            ,count(distinct if(bc.client_id is null, ds.pno, null)) small_client_count
            ,count(distinct if(datediff(now(), ds.first_valid_routed_at) <= 3 and bc.client_id is not null, ds.pno, null)) 3_within_backlog_bigclient
            ,count(distinct if(datediff(now(), ds.first_valid_routed_at) > 3 and datediff(now(), ds.first_valid_routed_at) <= 5 and bc.client_id is not null, ds.pno, null)) 3_5_backlog_bigclient
            ,count(distinct if(datediff(now(), ds.first_valid_routed_at) > 5 and bc.client_id is not null, ds.pno, null)) 5_more_backlog_bigclient
            ,count(distinct if(tsd.end_date < curdate(), ds.pno, null)) tt_overtime_count
        from dwm.dwd_ph_dc_should_be_delivery ds
        join ph_staging.parcel_info pi on pi.pno = ds.pno and pi.state not in (5,7,8,9)
        left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
        left join dwm.dwd_ex_ph_tiktok_sla_detail tsd on tsd.pno = ds.pno
        where
            ds.p_date = '2023-09-21'
        group by 1
    ) backlog on backlog.dst_store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-09-21'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-09-21')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-09-21'
        and pi.finished_at >= date_sub('2023-09-21', interval 8 hour )
        and pi.finished_at < date_add('2023-09-21', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
        and ds.dst_store_id = 'PH18030101'
)

select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
#         ds.dst_store_id store_id
#         ,ss.name
#         ,ds.pno
#         ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
#         ,pi.ticket_delivery_staff_info_id
#         ,pi.state
#         ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
#         ,coalesce(hsi.job_title, hs.job_title) job_title
#         ,coalesce(hsi.formal, hs.formal) formal
#         ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
#         ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    count(distinct si.id)
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-09-21'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-09-21')
    left join ph_backyard.staff_info si on si.id = pi.ticket_delivery_staff_info_id
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-09-21'
        and pi.finished_at >= date_sub('2023-09-21', interval 8 hour )
        and pi.finished_at < date_add('2023-09-21', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
        and si.hire_type = 12;
;-- -. . -..- - / . -. - .-. -.--
select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
#     count(distinct si.id)
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-09-21'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-09-21')
    left join ph_backyard.staff_info si on si.id = pi.ticket_delivery_staff_info_id
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-09-21'
        and pi.finished_at >= date_sub('2023-09-21', interval 8 hour )
        and pi.finished_at < date_add('2023-09-21', interval 16 hour)
        and ds.should_delevry_type != '非当日应派';
;-- -. . -..- - / . -. - .-. -.--
select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,case si.hire_type
            when 1 then '正式员工'
            when 2 then '日薪制特殊合同工'
            when 3 then '日薪制特殊合同工'
            when 4 then '时薪制特殊合同工'
            when 5 then '实习生'
            when 11 then '是普通外协'
            when 12 then '是众包外协'
        end 类型
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
#     count(distinct si.id)
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-09-21'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-09-21')
    left join ph_backyard.staff_info si on si.id = pi.ticket_delivery_staff_info_id
    left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-09-21'
        and pi.finished_at >= date_sub('2023-09-21', interval 8 hour )
        and pi.finished_at < date_add('2023-09-21', interval 16 hour)
        and ds.should_delevry_type != '非当日应派';
;-- -. . -..- - / . -. - .-. -.--
select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,case si.hire_type
            when 1 then '正式员工'
            when 2 then '日薪制特殊合同工'
            when 3 then '日薪制特殊合同工'
            when 4 then '时薪制特殊合同工'
            when 5 then '实习生'
            when 11 then '是普通外协'
            when 12 then '是众包外协'
        end 类型
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
#     count(distinct si.id)
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-09-21'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-09-21')
    left join ph_backyard.staff_info si on si.id = pi.ticket_delivery_staff_info_id
#     left join ph_bi.hr_staff_info hsi2 on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-09-21'
        and pi.finished_at >= date_sub('2023-09-21', interval 8 hour )
        and pi.finished_at < date_add('2023-09-21', interval 16 hour)
        and ds.should_delevry_type != '非当日应派';
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-21'
        and pr.routed_at >= date_sub('2023-09-21', interval 8 hour )
        and pr.routed_at < date_add('2023-09-21', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,if(a3.self_staff_num + other_staff_num > coalesce(sdb.code_num, 0),
           case
            when a2.avg_staff_code < 2 then 'A'
            when a2.avg_staff_code >= 2 and a2.avg_staff_code < 3 then 'B'
            when a2.avg_staff_code >= 3 and a2.avg_staff_code < 4 then 'C'
            when a2.avg_staff_code >= 4 then 'D'
        end,
           case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end ) 评级
#         ,a2.code_num
#         ,a2.staff_code_num
#         ,a2.staff_num
#         ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) avg_staff_code
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
            ,count(distinct sdb.district_code) barangay_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
select
    count(plt.pno)
from ph_bi.parcel_lose_task plt
left join ph_staging.parcel_info pi on pi.pno = plt.pno
where
    plt.state = 6
    and plt.duty_result in (1,2)
    and pi.state not in (5,7,8,9);
;-- -. . -..- - / . -. - .-. -.--
with t as
    (
        select
            pi.pno
            ,pi.returned
            ,pi.state
            ,plt.duty_result
            ,plt.updated_at
            ,plt.client_id
        from ph_bi.parcel_lose_task plt
        left join ph_staging.parcel_info pi on pi.pno = plt.pno
        where
            plt.state = 6
            and plt.duty_result in (1,2)
            and pi.state not in (5,7,8,9)
    )
select
    t1.pno
    ,if(t1.returned = 0, '正向', '逆向') 包裹流向
    ,t1.client_id 客户ID
    ,case t1.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,case t1.`duty_result`
        when 1 then '丢失'
        when 2 then '破损'
        when 3 then '超时效'
	end 判责类型
    ,t1.updated_at 判责日期
    ,t2.store_name 最后一次有效路由网点
    ,convert_tz(t2.routed_at, '+00:00', '+08:00')  最后一次有效路由时间
from t t1
left join
    (
        select
            pr.pno
            ,pr.store_id
            ,pr.store_name
            ,pr.routed_at
            ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno
        join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.fieldname = 'route_action' and ddd.remark = 'valid'
        where
            pr.routed_at >= '2023-01-01'
    ) t2 on t2.pno = t1.pno and t2.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
    (
        select
            pi.pno
            ,pi.returned
            ,pi.state
            ,plt.duty_result
            ,plt.updated_at
            ,plt.client_id
        from ph_bi.parcel_lose_task plt
        left join ph_staging.parcel_info pi on pi.pno = plt.pno
        where
            plt.state = 6
            and plt.duty_result in (1,2)
            and pi.state not in (5,7,8,9)
    )
select
    t1.pno
    ,if(t1.returned = 0, '正向', '逆向') 包裹流向
    ,t1.client_id 客户ID
    ,case t1.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,case t1.`duty_result`
        when 1 then '丢失'
        when 2 then '破损'
        when 3 then '超时效'
	end 判责类型
    ,t1.updated_at 判责日期
    ,t2.store_name 最后一次有效路由网点
    ,convert_tz(t2.routed_at, '+00:00', '+08:00')  最后一次有效路由时间
from t t1
left join
    (
        select
            pr.pno
            ,pr.store_id
            ,pr.store_name
            ,pr.routed_at
            ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno
        join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.fieldname = 'route_action' and ddd.remark = 'valid'
        where
            pr.routed_at >= '2023-03-01'
            and pr.organization_type = 1
    ) t2 on t2.pno = t1.pno and t2.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
select
            pi.pno
            ,pi.returned
            ,pi.state
            ,plt.duty_result
            ,plt.updated_at
            ,plt.client_id
        from ph_bi.parcel_lose_task plt
        left join ph_staging.parcel_info pi on pi.pno = plt.pno
        where
            plt.state = 6
            and plt.duty_result in (1,2)
            and pi.state not in (5,7,8,9);
;-- -. . -..- - / . -. - .-. -.--
select
            pr.pno
            ,pr.store_id
            ,pr.store_name
            ,pr.routed_at
            ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno
        join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.fieldname = 'route_action' and ddd.remark = 'valid'
        where
            pr.routed_at >= '2023-03-01'
            and pr.organization_type = 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
    (
        select
            pi.pno
            ,pi.returned
            ,pi.state
            ,plt.duty_result
            ,plt.updated_at
            ,plt.client_id
        from ph_bi.parcel_lose_task plt
        left join ph_staging.parcel_info pi on pi.pno = plt.pno
        where
            plt.state = 6
            and plt.duty_result in (1,2)
            and pi.state not in (5,7,8,9)
    )
# select
#     t1.pno
#     ,if(t1.returned = 0, '正向', '逆向') 包裹流向
#     ,t1.client_id 客户ID
#     ,case t1.state
#         when 1 then '已揽收'
#         when 2 then '运输中'
#         when 3 then '派送中'
#         when 4 then '已滞留'
#         when 5 then '已签收'
#         when 6 then '疑难件处理中'
#         when 7 then '已退件'
#         when 8 then '异常关闭'
#         when 9 then '已撤销'
#     end as 包裹状态
#     ,case t1.`duty_result`
#         when 1 then '丢失'
#         when 2 then '破损'
#         when 3 then '超时效'
# 	end 判责类型
#     ,t1.updated_at 判责日期
#     ,t2.store_name 最后一次有效路由网点
#     ,convert_tz(t2.routed_at, '+00:00', '+08:00')  最后一次有效路由时间
# from t t1
# left join
#     (
        select
            pr.pno
            ,pr.store_id
            ,pr.store_name
            ,pr.routed_at
            ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno
        join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.fieldname = 'route_action' and ddd.remark = 'valid'
        where
            pr.routed_at >= '2023-03-01'
            and pr.organization_type = 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
    (
        select
            pi.pno
            ,pi.returned
            ,pi.state
            ,plt.duty_result
            ,plt.updated_at
            ,plt.client_id
        from ph_bi.parcel_lose_task plt
        left join ph_staging.parcel_info pi on pi.pno = plt.pno
        where
            plt.state = 6
            and plt.duty_result in (1,2)
            and pi.state not in (5,7,8,9)
    )
select
    t1.pno
    ,if(t1.returned = 0, '正向', '逆向') 包裹流向
    ,t1.client_id 客户ID
    ,case t1.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,case t1.`duty_result`
        when 1 then '丢失'
        when 2 then '破损'
        when 3 then '超时效'
	end 判责类型
    ,t1.updated_at 判责日期
    ,t2.store_name 最后一次有效路由网点
    ,convert_tz(t2.routed_at, '+00:00', '+08:00')  最后一次有效路由时间
from t t1
left join
    (
        select
            pr.pno
            ,pr.store_id
            ,pr.store_name
            ,pr.routed_at
            ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno
        join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.fieldname = 'route_action' and ddd.remark = 'valid'
        where
            pr.routed_at >= '2023-04-01'
            and pr.organization_type = 1
    ) t2 on t2.pno = t1.pno and t2.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
    (
        select
            pi.pno
            ,pi.returned
            ,pi.state
            ,plt.duty_result
            ,plt.updated_at
            ,plt.client_id
        from ph_bi.parcel_lose_task plt
        left join ph_staging.parcel_info pi on pi.pno = plt.pno
        where
            plt.state = 6
            and plt.duty_result in (1,2)
            and pi.state not in (5,7,8,9)
    )
select
    t1.pno
    ,if(t1.returned = 0, '正向', '逆向') 包裹流向
    ,t1.client_id 客户ID
    ,case t1.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,case t1.`duty_result`
        when 1 then '丢失'
        when 2 then '破损'
        when 3 then '超时效'
	end 判责类型
    ,t1.updated_at 判责日期
    ,t2.store_name 最后一次有效路由网点
    ,convert_tz(t2.routed_at, '+00:00', '+08:00')  最后一次有效路由时间
from t t1
left join
    (
        select
            pr.pno
            ,pr.store_id
            ,pr.store_name
            ,pr.routed_at
            ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno
        join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.fieldname = 'route_action' and ddd.remark = 'valid'
        where
            pr.routed_at >= '2023-05-01'
            and pr.organization_type = 1
    ) t2 on t2.pno = t1.pno and t2.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
    (
        select
            pi.pno
            ,pi.returned
            ,pi.state
            ,plt.duty_result
            ,plt.updated_at
            ,plt.client_id
        from ph_bi.parcel_lose_task plt
        left join ph_staging.parcel_info pi on pi.pno = plt.pno
        where
            plt.state = 6
            and plt.duty_result in (1,2)
            and pi.state not in (5,7,8,9)
    )
select
    t1.pno
    ,if(t1.returned = 0, '正向', '逆向') 包裹流向
    ,t1.client_id 客户ID
    ,case t1.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,case t1.`duty_result`
        when 1 then '丢失'
        when 2 then '破损'
        when 3 then '超时效'
	end 判责类型
    ,t1.updated_at 判责日期
    ,t2.store_name 最后一次有效路由网点
    ,convert_tz(t2.routed_at, '+00:00', '+08:00')  最后一次有效路由时间
from t t1
left join
    (
        select
            pr.pno
            ,pr.store_id
            ,pr.store_name
            ,pr.routed_at
            ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno
#         join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.fieldname = 'route_action' and ddd.remark = 'valid'
        where
            pr.routed_at >= '2023-01-01'
            and pr.organization_type = 1
            and pr.route_action in ('RECEIVED','RECEIVE_WAREHOUSE_SCAN','SORTING_SCAN','DELIVERY_TICKET_CREATION_SCAN',
                                   'ARRIVAL_WAREHOUSE_SCAN','SHIPMENT_WAREHOUSE_SCAN','DETAIN_WAREHOUSE','DELIVERY_CONFIRM',
                                   'DIFFICULTY_HANDOVER','DELIVERY_MARKER','REPLACE_PNO','SEAL','UNSEAL','PARCEL_HEADLESS_PRINTED',
                                   'STAFF_INFO_UPDATE_WEIGHT','STORE_KEEPER_UPDATE_WEIGHT','STORE_SORTER_UPDATE_WEIGHT',
                                   'DISCARD_RETURN_BKK','DELIVERY_TRANSFER','PICKUP_RETURN_RECEIPT','FLASH_HOME_SCAN',
                                   'ARRIVAL_WAREHOUSE_SCAN','SORTING_SCAN', 'INVENTORY')
    ) t2 on t2.pno = t1.pno and t2.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
select
    pi2.pno 正向单号
    ,pi.pno 退件单号
    ,ss.name 正向揽收网点
    ,pi2.src_detail_address 正向寄件人地址
    ,pi2.client_id 客户ID
    ,pi2.src_name 寄件人姓名
    ,pi.dst_detail_address 退件包裹目的地地址
    ,ss2.name 退件目的地网点
    ,convert_tz(pi.created_at, '+00:00', '+08:00') 退件包裹揽收时间
from ph_staging.parcel_info pi
left join ph_staging.parcel_info pi2 on pi2.returned_pno = pi.pno
left join ph_staging.sys_store ss on ss.id = pi2.ticket_pickup_store_id
left join ph_staging.sys_store ss2 on ss2.id = pi.dst_store_id
where
    pi.returned = 1
    and pi.created_at >= date_sub(date_sub(curdate(), interval 7 day), interval 8 hour) -- 近一周退件
    and ss.category = 14
    and ss2.category != 14;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ssp.pno
        ,ssp.stat_date
        ,ssp.inventory_class
        ,ssp.resp_store_id
        ,ssp.last_valid_action_route_at
        ,ddd2.CN_element
    from ph_bi.should_stocktaking_parcel_info_recently ssp
    left join dwm.dwd_dim_dict ddd2 on ddd2.element = ssp.last_valid_action and  ddd2.db = 'ph_staging' and ddd2.tablename = 'parcel_route'
    where
        ssp.stat_date = curdate()
        and ssp.hour = hour(now())
        and hour(now()) <= 23

    union all

    select
        ssp.pno
        ,ssp.stat_date
        ,ssp.inventory_class
        ,ssp.resp_store_id
        ,ssp.last_valid_action_route_at
        ,ddd2.CN_element
    from ph_bi.should_stocktaking_parcel_info_recently ssp
    left join dwm.dwd_dim_dict ddd2 on ddd2.element = ssp.last_valid_action and  ddd2.db = 'ph_staging' and ddd2.tablename = 'parcel_route'
    where
        ssp.stat_date = date_sub(curdate(), interval 1 day)
        and ssp.hour = 24
        and hour(now()) = 0


)
select
    t1.pno
    ,case t1.inventory_class
        when 1 then '今日应到包裹未入仓'
        when 2 then '历史应到包裹未更新'
        when 3 then '今日应盘留仓件'
        when 4 then '今日应盘问题件'
    end 应盘类型
    ,pi.src_name 寄件人姓名
    ,pi.src_detail_address 寄件人地址
    ,pi.dst_name 收件人姓名
    ,pi.dst_detail_address 收件人地址
    ,pi.dst_phone 收件人电话
    ,pi.dst_home_phone 收件人家庭电话
    ,dp.store_name 当前网点
    ,dp.piece_name 当前片区
    ,dp.region_name 当前大区
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end 当前状态
    ,if(pi.returned = 1, '退件', '正向') 流向
    ,if(de.client_id in ('AA0050','AA0121','AA0139','AA0051','AA0080'), oi.insure_declare_value/100, oi.cogs_amount/100) 正向物品价值
    ,oi.cod_amount/100 COD金额
    ,convert_tz(pi.created_at, '+00:00', '+08:00') 揽收时间
    ,dp2.store_name 揽收网点
    ,dp2.piece_name 揽收片区
    ,dp2.region_name 揽收大区
    ,ss.name 目的地网点
    ,t1.CN_element 最后一条有效路由
    ,t1.last_valid_action_route_at 最后一条有效路由时间
    ,if(pi.state = 1, datediff(now(), convert_tz(pi.created_at, '+00:00', '+08:00')), datediff(now(), de.dst_routed_at)) 在仓天数
    ,de.discard_enabled 是否为丢弃
    ,de.inventorys 盘库次数
    ,convert_tz(pr2.routed_at, '+00:00', '+08:00') 最后一次盘库时间
    ,date(convert_tz(pr2.routed_at, '+00:00', '+08:00')) 最后一次盘库日期
    ,if(pr2.routed_at > date_add(t1.stat_date, interval 8 hour), '是', '否') 是否有效盘库
    ,if(pr2.routed_at > date_sub(t1.stat_date, interval 8 hour), convert_tz(pr2.routed_at, '+00:00', '+08:00'), null) 今日最后一次盘库时间
from  t t1
left join dwm.dwd_ex_ph_parcel_details de on de.pno = t1.pno
left join ph_staging.parcel_info pi on pi.pno = t1.pno
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = t1.resp_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
left join ph_staging.order_info oi on if(pi.returned = 1, pi.customary_pno, pi.pno) = oi.pno
left join dwm.dim_ph_sys_store_rd dp2 on dp2.store_id = pi.ticket_pickup_store_id and dp2.stat_date = date_sub(curdate(), interval 1 day)
left join ph_staging.sys_store ss on ss.id = pi.dst_store_id
left join
    (
        select
            b.*
        from
            (
                select
                    pr.pno
                    ,pr.routed_at
                    ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rn
                from ph_staging.parcel_route pr
                join t t1 on t1.pno = pr.pno
                where
                    pr.route_action = 'INVENTORY'
            ) b
        where
            b.rn = 1
    ) pr2 on pr2.pno = t1.pno;
;-- -. . -..- - / . -. - .-. -.--
select
    count(pi.pno)
from ph_staging.parcel_info pi
where
    pi.state not in (5,7,8,9)
    and pi.created_at < date_sub(now(), interval 56 hour );
;-- -. . -..- - / . -. - .-. -.--
select
    count(a1.pno)
from
    (
        select
            a.*
        from
            (
                select
                    pi.pno
                    ,pi.returned
                    ,pi.client_id
                    ,pr.store_id
                    ,pr.route_action
                    ,pr.routed_at
                    ,row_number() over (partition by pr.pno order by pr.routed_at desc) rk
                from ph_staging.parcel_info pi
                left join ph_staging.parcel_route pr on pr.pno = pi.pno
                where
                    pi.state not in (5,7,8,9)
                    and pi.created_at < date_sub(now(), interval 56 hour)
            ) a
        where
            a.rk = 1
    ) a1
where
    a1.routed_at < date_sub(now(), interval 56 hour);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
            select
            a1.*
        from
            (
                select
                    a.*
                from
                    (
                        select
                            pi.pno
                            ,pi.returned
                            ,pi.client_id
                            ,pi.state
                            ,pi.customary_pno
                            ,pr.store_name
                            ,pr.store_id
                            ,pi.interrupt_category
                            ,pr.route_action
                            ,pr.routed_at
                            ,row_number() over (partition by pr.pno order by pr.routed_at desc) rk
                        from ph_staging.parcel_info pi
                        left join ph_staging.parcel_route pr on pr.pno = pi.pno
                        where
                            pi.state not in (5,7,8,9)
                            and pi.created_at < date_sub(now(), interval 56 hour)
                    ) a
                where
                    a.rk = 1
            ) a1
        where
            a1.routed_at < date_sub(now(), interval 56 hour)
)
select
    t1.pno
    ,if(t1.returned = 0, '正向', '退件') 包裹流向
    ,t1.client_id
    ,case t1.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,case a2.duty_result
        when 1 then '丢失'
        when 2 then '破损'
        when 3 then '超时效'
    end 判责类型
    ,a2.updated_at 判责日期
    ,t1.route_action
    ,case pr.route_action # 路由动作
         when 'ACCEPT_PARCEL' then '接件扫描'
         when 'ARRIVAL_GOODS_VAN_CHECK_SCAN' then '车货关联到港'
         when 'ARRIVAL_WAREHOUSE_SCAN' then '到件入仓扫描'
         when 'CANCEL_ARRIVAL_WAREHOUSE_SCAN' then '取消到件入仓扫描'
         when 'CANCEL_PARCEL' then '撤销包裹'
         when 'CANCEL_SHIPMENT_WAREHOUSE' then '取消发件出仓'
         when 'CHANGE_PARCEL_CANCEL' then '修改包裹为撤销'
         when 'CHANGE_PARCEL_CLOSE' then '修改包裹为异常关闭'
         when 'CHANGE_PARCEL_IN_TRANSIT' then '修改包裹为运输中'
         when 'CHANGE_PARCEL_INFO' then '修改包裹信息'
         when 'CHANGE_PARCEL_SIGNED' then '修改包裹为签收'
         when 'CLAIMS_CLOSE' then '理赔关闭'
         when 'CLAIMS_COMPLETE' then '理赔完成'
         when 'CLAIMS_CONTACT' then '已联系客户'
         when 'CLAIMS_TRANSFER_CS' then '转交总部cs处理'
         when 'CLOSE_ORDER' then '关闭订单'
         when 'CONTINUE_TRANSPORT' then '疑难件继续配送'
         when 'CREATE_WORK_ORDER' then '创建工单'
         when 'CUSTOMER_CHANGE_PARCEL_INFO' then '客户修改包裹信息'
         when 'CUSTOMER_OPERATING_RETURN' then '客户操作退回寄件人'
         when 'DELIVERY_CONFIRM' then '确认妥投'
         when 'DELIVERY_MARKER' then '派件标记'
         when 'DELIVERY_PICKUP_STORE_SCAN' then '自提取件扫描'
         when 'DELIVERY_TICKET_CREATION_SCAN' then '交接扫描'
         when 'DELIVERY_TRANSFER' then '派件转单'
         when 'DEPARTURE_GOODS_VAN_CK_SCAN' then '车货关联出港'
         when 'DETAIN_WAREHOUSE' then '货件留仓'
         when 'DIFFICULTY_FINISH_INDEMNITY' then '疑难件支付赔偿'
         when 'DIFFICULTY_HANDOVER' then '疑难件交接'
         when 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE' then '疑难件交接货件留仓'
         when 'DIFFICULTY_RE_TRANSIT' then '疑难件退回区域总部/重启运送'
         when 'DIFFICULTY_RETURN' then '疑难件退回寄件人'
         when 'DIFFICULTY_SEAL' then '集包异常'
         when 'DISCARD_RETURN_BKK' then '丢弃包裹的，换单后寄回BKK'
         when 'DISTRIBUTION_INVENTORY' then '分拨盘库'
         when 'DWS_WEIGHT_IMAGE' then 'DWS复秤照片'
         when 'EXCHANGE_PARCEL' then '换货'
         when 'FAKE_CANCEL_HANDLE' then '虚假撤销判责'
         when 'FLASH_HOME_SCAN' then 'FH交接扫描'
         when 'FORCE_TAKE_PHOTO' then '强制拍照路由'
         when 'HAVE_HAIR_SCAN_NO_TO' then '有发无到'
         when 'HURRY_PARCEL' then '催单'
         when 'INCOMING_CALL' then '来电接听'
         when 'INTERRUPT_PARCEL_AND_RETURN' then '中断运输并退回'
         when 'INVENTORY' then '盘库'
         when 'LOSE_PARCEL_TEAM_OPERATION' then '丢失件团队处理'
         when 'MANUAL_REMARK' then '添加备注'
         when 'MISS_PICKUP_HANDLE' then '漏包裹揽收判责'
         when 'MISSING_PARCEL_SCAN' then '丢失件包裹操作'
         when 'NOTICE_LOST_PARTS_TEAM' then '已通知丢失件团队'
         when 'PARCEL_HEADLESS_CLAIMED' then '无头件包裹已认领'
         when 'PARCEL_HEADLESS_PRINTED' then '无头件包裹已打单'
         when 'PENDING_RETURN' then '待退件'
         when 'PHONE' then '电话联系'
         when 'PICK_UP_STORE' then '待自提取件'
         when 'PICKUP_RETURN_RECEIPT' then '签回单揽收'
         when 'PRINTING' then '打印面单'
         when 'QAQC_OPERATION' then 'QAQC判责'
         when 'RECEIVE_WAREHOUSE_SCAN' then '收件入仓'
         when 'RECEIVED' then '已揽收,初始化动作，实际情况并没有作用'
         when 'REFUND_CONFIRM' then '退件妥投'
         when 'REPAIRED' then '上报问题修复路由'
         when 'REPLACE_PNO' then '换单'
         when 'REPLY_WORK_ORDER' then '回复工单'
         when 'REVISION_TIME' then '改约时间'
         when 'SEAL' then '集包'
         when 'SEAL_NUMBER_CHANGE' then '集包件数变化'
         when 'SHIPMENT_WAREHOUSE_SCAN' then '发件出仓扫描'
         when 'SORTER_WEIGHT_IMAGE' then '分拣机复秤照片'
         when 'SORTING_SCAN' then '分拣扫描'
         when 'STAFF_INFO_UPDATE_WEIGHT' then '快递员修改重量'
         when 'STORE_KEEPER_UPDATE_WEIGHT' then '仓管员复秤'
         when 'STORE_SORTER_UPDATE_WEIGHT' then '分拣机复秤'
         when 'SYSTEM_AUTO_RETURN' then '系统自动退件'
         when 'TAKE_PHOTO' then '异常打单拍照'
         when 'THIRD_EXPRESS_ROUTE' then '第三方公司路由'
         when 'THIRD_PARTY_REASON_DETAIN' then '第三方原因滞留'
         when 'TICKET_WEIGHT_IMAGE' then '揽收称重照片'
         when 'TRANSFER_LOST_PARTS_TEAM' then '已转交丢失件团队'
         when 'TRANSFER_QAQC' then '转交QAQC处理'
         when 'UNSEAL' then '拆包'
         when 'UNSEAL_NO_PARCEL' then '上报包裹不在集包里'
         when 'UNSEAL_NOT_SCANNED' then '集包已拆包，本包裹未被扫描'
         when 'VEHICLE_ACCIDENT_REG' then '车辆车祸登记'
         when 'VEHICLE_ACCIDENT_REGISTRATION' then '车辆车祸登记'
         when 'VEHICLE_WET_DAMAGE_REG' then '车辆湿损登记'
         when 'VEHICLE_WET_DAMAGE_REGISTRATION' then '车辆湿损登记'
    end as 最后一次有效路由操作
    ,t1.store_name 最后一次有效路由网点
    ,convert_tz(ss.routed_at, '+00:00', '+08:00') 到达网点时间
    ,date(convert_tz(t1.routed_at, '+00:00', '+08:00')) 最后一次有效路由时间
    ,timestampdiff(hour, convert_tz(t1.routed_at, '+00:00', '+08:00'), now()) 最近一次有效路由至今小时数
    ,if(t1.returned = 0, dai.returned_delivery_attempt_num, dai.delivery_attempt_num) 尝试派送次数
    ,if(t1.interrupt_category = 3, '是', '否') 是否有待退件标记
    ,case
        when t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139') and curdate() > laz.delievey_end_date then '是'
        when t1.client_id in ('AA0131', 'AA0132') and curdate() > tik.end_date then '是'
        when t1.client_id in ('AA0090', 'AA0128','AA0089') and curdate() > sho.end_date then '是'
        when t1.client_id in ('AA0149', 'AA0148') and curdate() > she.delievey_end_date then '是'
        else null
    end 是否已经超时
    ,case
        when t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139') and curdate() > laz.delievey_end_date then datediff(curdate(), laz.delievey_end_date)
        when t1.client_id in ('AA0131', 'AA0132') and curdate() > tik.end_date then datediff(curdate(), tik.end_date)
        when t1.client_id in ('AA0090', 'AA0128','AA0089') and curdate() > sho.end_date then datediff(curdate(), sho.end_date)
        when t1.client_id in ('AA0149', 'AA0148') and curdate() > she.delievey_end_date then datediff(curdate(), she.delievey_end_date)
        else null
    end  超时天数
    ,if(t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139'), oi.insure_declare_value/100, oi.cogs_amount/100) cogs金额
from t t1
left join
    (
        select
            plt.pno
            ,plt.updated_at
            ,plt.duty_result
        from ph_bi.parcel_lose_task plt
        join t t1 on t1.pno = plt.pno
        where
            plt.state = 5
    ) a2 on a2.pno = t1.pno
left join dwm.dwd_ex_ph_lazada_pno_period laz on laz.pno = t1.pno
left join dwm.dwd_ex_shopee_pno_period sho on sho.pno = t1.pno
left join dwm.dwd_ex_ph_tiktok_sla_detail tik on tik.pno = t1.pno
left join dwm.dwd_ex_ph_shein_sla_detail she on she.pno = t1.pno
left join ph_staging.delivery_attempt_info dai on dai.pno = if(t1.returned = 0, t1.pno, t1.customary_pno)
left join
    (
        select
            pr.routed_at
            ,pr.pno
            ,row_number() over (partition by pr.pno order by pr.routed_at ) rk
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno and pr.store_id = t1.store_id
        where
            pr.route_action in ('INVENTORY','RECEIVED' ,'RECEIVE_WAREHOUSE_SCAN', 'SORTING_SCAN', 'DELIVERY_TICKET_CREATION_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SHIPMENT_WAREHOUSE_SCAN', 'DETAIN_WAREHOUSE', 'DELIVERY_CONFIRM', 'DIFFICULTY_HANDOVER', 'DELIVERY_MARKER', 'REPLACE_PNO','SEAL', 'UNSEAL', 'STAFF_INFO_UPDATE_WEIGHT', 'STORE_KEEPER_UPDATE_WEIGHT', 'STORE_SORTER_UPDATE_WEIGHT', 'DISCARD_RETURN_BKK', 'DELIVERY_TRANSFER', 'PICKUP_RETURN_RECEIPT', 'FLASH_HOME_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SORTING_SCAN ', 'DELIVERY_PICKUP_STORE_SCAN', 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE', 'REFUND_CONFIRM', 'ACCEPT_PARCEL')
    ) ss on ss.pno = t1.pno and ss.rk = 1
left join ph_staging.order_info oi on oi.pno = t1.pno;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
            select
            a1.*
        from
            (
                select
                    a.*
                from
                    (
                        select
                            pi.pno
                            ,pi.returned
                            ,pi.client_id
                            ,pi.state
                            ,pi.customary_pno
                            ,pr.store_name
                            ,pr.store_id
                            ,pi.interrupt_category
                            ,pr.route_action
                            ,pr.routed_at
                            ,row_number() over (partition by pr.pno order by pr.routed_at desc) rk
                        from ph_staging.parcel_info pi
                        left join ph_staging.parcel_route pr on pr.pno = pi.pno
                        where
                            pi.state not in (5,7,8,9)
                            and pi.created_at < date_sub(now(), interval 56 hour)
                    ) a
                where
                    a.rk = 1
            ) a1
        where
            a1.routed_at < date_sub(now(), interval 56 hour)
)
select
    t1.pno
    ,if(t1.returned = 0, '正向', '退件') 包裹流向
    ,t1.client_id
    ,case t1.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,case a2.duty_result
        when 1 then '丢失'
        when 2 then '破损'
        when 3 then '超时效'
    end 判责类型
    ,a2.updated_at 判责日期
    ,t1.route_action
    ,case t1.route_action # 路由动作
         when 'ACCEPT_PARCEL' then '接件扫描'
         when 'ARRIVAL_GOODS_VAN_CHECK_SCAN' then '车货关联到港'
         when 'ARRIVAL_WAREHOUSE_SCAN' then '到件入仓扫描'
         when 'CANCEL_ARRIVAL_WAREHOUSE_SCAN' then '取消到件入仓扫描'
         when 'CANCEL_PARCEL' then '撤销包裹'
         when 'CANCEL_SHIPMENT_WAREHOUSE' then '取消发件出仓'
         when 'CHANGE_PARCEL_CANCEL' then '修改包裹为撤销'
         when 'CHANGE_PARCEL_CLOSE' then '修改包裹为异常关闭'
         when 'CHANGE_PARCEL_IN_TRANSIT' then '修改包裹为运输中'
         when 'CHANGE_PARCEL_INFO' then '修改包裹信息'
         when 'CHANGE_PARCEL_SIGNED' then '修改包裹为签收'
         when 'CLAIMS_CLOSE' then '理赔关闭'
         when 'CLAIMS_COMPLETE' then '理赔完成'
         when 'CLAIMS_CONTACT' then '已联系客户'
         when 'CLAIMS_TRANSFER_CS' then '转交总部cs处理'
         when 'CLOSE_ORDER' then '关闭订单'
         when 'CONTINUE_TRANSPORT' then '疑难件继续配送'
         when 'CREATE_WORK_ORDER' then '创建工单'
         when 'CUSTOMER_CHANGE_PARCEL_INFO' then '客户修改包裹信息'
         when 'CUSTOMER_OPERATING_RETURN' then '客户操作退回寄件人'
         when 'DELIVERY_CONFIRM' then '确认妥投'
         when 'DELIVERY_MARKER' then '派件标记'
         when 'DELIVERY_PICKUP_STORE_SCAN' then '自提取件扫描'
         when 'DELIVERY_TICKET_CREATION_SCAN' then '交接扫描'
         when 'DELIVERY_TRANSFER' then '派件转单'
         when 'DEPARTURE_GOODS_VAN_CK_SCAN' then '车货关联出港'
         when 'DETAIN_WAREHOUSE' then '货件留仓'
         when 'DIFFICULTY_FINISH_INDEMNITY' then '疑难件支付赔偿'
         when 'DIFFICULTY_HANDOVER' then '疑难件交接'
         when 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE' then '疑难件交接货件留仓'
         when 'DIFFICULTY_RE_TRANSIT' then '疑难件退回区域总部/重启运送'
         when 'DIFFICULTY_RETURN' then '疑难件退回寄件人'
         when 'DIFFICULTY_SEAL' then '集包异常'
         when 'DISCARD_RETURN_BKK' then '丢弃包裹的，换单后寄回BKK'
         when 'DISTRIBUTION_INVENTORY' then '分拨盘库'
         when 'DWS_WEIGHT_IMAGE' then 'DWS复秤照片'
         when 'EXCHANGE_PARCEL' then '换货'
         when 'FAKE_CANCEL_HANDLE' then '虚假撤销判责'
         when 'FLASH_HOME_SCAN' then 'FH交接扫描'
         when 'FORCE_TAKE_PHOTO' then '强制拍照路由'
         when 'HAVE_HAIR_SCAN_NO_TO' then '有发无到'
         when 'HURRY_PARCEL' then '催单'
         when 'INCOMING_CALL' then '来电接听'
         when 'INTERRUPT_PARCEL_AND_RETURN' then '中断运输并退回'
         when 'INVENTORY' then '盘库'
         when 'LOSE_PARCEL_TEAM_OPERATION' then '丢失件团队处理'
         when 'MANUAL_REMARK' then '添加备注'
         when 'MISS_PICKUP_HANDLE' then '漏包裹揽收判责'
         when 'MISSING_PARCEL_SCAN' then '丢失件包裹操作'
         when 'NOTICE_LOST_PARTS_TEAM' then '已通知丢失件团队'
         when 'PARCEL_HEADLESS_CLAIMED' then '无头件包裹已认领'
         when 'PARCEL_HEADLESS_PRINTED' then '无头件包裹已打单'
         when 'PENDING_RETURN' then '待退件'
         when 'PHONE' then '电话联系'
         when 'PICK_UP_STORE' then '待自提取件'
         when 'PICKUP_RETURN_RECEIPT' then '签回单揽收'
         when 'PRINTING' then '打印面单'
         when 'QAQC_OPERATION' then 'QAQC判责'
         when 'RECEIVE_WAREHOUSE_SCAN' then '收件入仓'
         when 'RECEIVED' then '已揽收,初始化动作，实际情况并没有作用'
         when 'REFUND_CONFIRM' then '退件妥投'
         when 'REPAIRED' then '上报问题修复路由'
         when 'REPLACE_PNO' then '换单'
         when 'REPLY_WORK_ORDER' then '回复工单'
         when 'REVISION_TIME' then '改约时间'
         when 'SEAL' then '集包'
         when 'SEAL_NUMBER_CHANGE' then '集包件数变化'
         when 'SHIPMENT_WAREHOUSE_SCAN' then '发件出仓扫描'
         when 'SORTER_WEIGHT_IMAGE' then '分拣机复秤照片'
         when 'SORTING_SCAN' then '分拣扫描'
         when 'STAFF_INFO_UPDATE_WEIGHT' then '快递员修改重量'
         when 'STORE_KEEPER_UPDATE_WEIGHT' then '仓管员复秤'
         when 'STORE_SORTER_UPDATE_WEIGHT' then '分拣机复秤'
         when 'SYSTEM_AUTO_RETURN' then '系统自动退件'
         when 'TAKE_PHOTO' then '异常打单拍照'
         when 'THIRD_EXPRESS_ROUTE' then '第三方公司路由'
         when 'THIRD_PARTY_REASON_DETAIN' then '第三方原因滞留'
         when 'TICKET_WEIGHT_IMAGE' then '揽收称重照片'
         when 'TRANSFER_LOST_PARTS_TEAM' then '已转交丢失件团队'
         when 'TRANSFER_QAQC' then '转交QAQC处理'
         when 'UNSEAL' then '拆包'
         when 'UNSEAL_NO_PARCEL' then '上报包裹不在集包里'
         when 'UNSEAL_NOT_SCANNED' then '集包已拆包，本包裹未被扫描'
         when 'VEHICLE_ACCIDENT_REG' then '车辆车祸登记'
         when 'VEHICLE_ACCIDENT_REGISTRATION' then '车辆车祸登记'
         when 'VEHICLE_WET_DAMAGE_REG' then '车辆湿损登记'
         when 'VEHICLE_WET_DAMAGE_REGISTRATION' then '车辆湿损登记'
    end as 最后一次有效路由操作
    ,t1.store_name 最后一次有效路由网点
    ,convert_tz(ss.routed_at, '+00:00', '+08:00') 到达网点时间
    ,date(convert_tz(t1.routed_at, '+00:00', '+08:00')) 最后一次有效路由时间
    ,timestampdiff(hour, convert_tz(t1.routed_at, '+00:00', '+08:00'), now()) 最近一次有效路由至今小时数
    ,if(t1.returned = 0, dai.returned_delivery_attempt_num, dai.delivery_attempt_num) 尝试派送次数
    ,if(t1.interrupt_category = 3, '是', '否') 是否有待退件标记
    ,case
        when t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139') and curdate() > laz.delievey_end_date then '是'
        when t1.client_id in ('AA0131', 'AA0132') and curdate() > tik.end_date then '是'
        when t1.client_id in ('AA0090', 'AA0128','AA0089') and curdate() > sho.end_date then '是'
        when t1.client_id in ('AA0149', 'AA0148') and curdate() > she.delievey_end_date then '是'
        else null
    end 是否已经超时
    ,case
        when t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139') and curdate() > laz.delievey_end_date then datediff(curdate(), laz.delievey_end_date)
        when t1.client_id in ('AA0131', 'AA0132') and curdate() > tik.end_date then datediff(curdate(), tik.end_date)
        when t1.client_id in ('AA0090', 'AA0128','AA0089') and curdate() > sho.end_date then datediff(curdate(), sho.end_date)
        when t1.client_id in ('AA0149', 'AA0148') and curdate() > she.delievey_end_date then datediff(curdate(), she.delievey_end_date)
        else null
    end  超时天数
    ,if(t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139'), oi.insure_declare_value/100, oi.cogs_amount/100) cogs金额
from t t1
left join
    (
        select
            plt.pno
            ,plt.updated_at
            ,plt.duty_result
        from ph_bi.parcel_lose_task plt
        join t t1 on t1.pno = plt.pno
        where
            plt.state = 5
    ) a2 on a2.pno = t1.pno
left join dwm.dwd_ex_ph_lazada_pno_period laz on laz.pno = t1.pno
left join dwm.dwd_ex_shopee_pno_period sho on sho.pno = t1.pno
left join dwm.dwd_ex_ph_tiktok_sla_detail tik on tik.pno = t1.pno
left join dwm.dwd_ex_ph_shein_sla_detail she on she.pno = t1.pno
left join ph_staging.delivery_attempt_info dai on dai.pno = if(t1.returned = 0, t1.pno, t1.customary_pno)
left join
    (
        select
            pr.routed_at
            ,pr.pno
            ,row_number() over (partition by pr.pno order by pr.routed_at ) rk
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno and pr.store_id = t1.store_id
        where
            pr.route_action in ('INVENTORY','RECEIVED' ,'RECEIVE_WAREHOUSE_SCAN', 'SORTING_SCAN', 'DELIVERY_TICKET_CREATION_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SHIPMENT_WAREHOUSE_SCAN', 'DETAIN_WAREHOUSE', 'DELIVERY_CONFIRM', 'DIFFICULTY_HANDOVER', 'DELIVERY_MARKER', 'REPLACE_PNO','SEAL', 'UNSEAL', 'STAFF_INFO_UPDATE_WEIGHT', 'STORE_KEEPER_UPDATE_WEIGHT', 'STORE_SORTER_UPDATE_WEIGHT', 'DISCARD_RETURN_BKK', 'DELIVERY_TRANSFER', 'PICKUP_RETURN_RECEIPT', 'FLASH_HOME_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SORTING_SCAN ', 'DELIVERY_PICKUP_STORE_SCAN', 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE', 'REFUND_CONFIRM', 'ACCEPT_PARCEL')
    ) ss on ss.pno = t1.pno and ss.rk = 1
left join ph_staging.order_info oi on oi.pno = t1.pno;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ssp.pno
        ,ssp.stat_date
        ,ssp.inventory_class
        ,ssp.resp_store_id
        ,ssp.last_valid_action_route_at
        ,ddd2.CN_element
    from ph_bi.should_stocktaking_parcel_info_recently ssp
    left join dwm.dwd_dim_dict ddd2 on ddd2.element = ssp.last_valid_action and  ddd2.db = 'ph_staging' and ddd2.tablename = 'parcel_route'
    where
        ssp.stat_date = curdate()
        and ssp.hour = hour(now())
        and hour(now()) <= 23

    union all

    select
        ssp.pno
        ,ssp.stat_date
        ,ssp.inventory_class
        ,ssp.resp_store_id
        ,ssp.last_valid_action_route_at
        ,ddd2.CN_element
    from ph_bi.should_stocktaking_parcel_info_recently ssp
    left join dwm.dwd_dim_dict ddd2 on ddd2.element = ssp.last_valid_action and  ddd2.db = 'ph_staging' and ddd2.tablename = 'parcel_route'
    where
        ssp.stat_date = date_sub(curdate(), interval 1 day)
        and ssp.hour = 24
        and hour(now()) = 0


)
select
    t1.pno
    ,case t1.inventory_class
        when 1 then '今日应到包裹未入仓'
        when 2 then '历史应到包裹未更新'
        when 3 then '今日应盘留仓件'
        when 4 then '今日应盘问题件'
    end 应盘类型
    ,pi.src_name 寄件人姓名
    ,pi.src_detail_address 寄件人地址
    ,pi.dst_name 收件人姓名
    ,pi.dst_detail_address 收件人地址
    ,pi.dst_phone 收件人电话
    ,pi.dst_home_phone 收件人家庭电话
    ,dp.store_name 当前网点
    ,dp.piece_name 当前片区
    ,dp.region_name 当前大区
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end 当前状态
    ,if(pi.returned = 1, '退件', '正向') 流向
    ,if(de.client_id in ('AA0050','AA0121','AA0139','AA0051','AA0080'), oi.insure_declare_value/100, oi.cogs_amount/100) 正向物品价值
    ,oi.cod_amount/100 COD金额
    ,convert_tz(pi.created_at, '+00:00', '+08:00') 揽收时间
    ,dp2.store_name 揽收网点
    ,dp2.piece_name 揽收片区
    ,dp2.region_name 揽收大区
    ,ss.name 目的地网点
    ,t1.CN_element 最后一条有效路由
    ,t1.last_valid_action_route_at 最后一条有效路由时间
    ,if(pi.state = 1, datediff(now(), convert_tz(pi.created_at, '+00:00', '+08:00')), datediff(now(), de.dst_routed_at)) 在仓天数
    ,de.discard_enabled 是否为丢弃
    ,de.inventorys 盘库次数
    ,convert_tz(pr2.routed_at, '+00:00', '+08:00') 最后一次盘库时间
    ,date(convert_tz(pr2.routed_at, '+00:00', '+08:00')) 最后一次盘库日期
    ,if(pr2.routed_at > date_sub(t1.stat_date, interval 8 hour), '是', '否') 今日是否盘库
    ,if(pr2.routed_at > date_sub(t1.stat_date, interval 8 hour), convert_tz(pr2.routed_at, '+00:00', '+08:00'), null) 今日最后一次盘库时间
from  t t1
left join dwm.dwd_ex_ph_parcel_details de on de.pno = t1.pno
left join ph_staging.parcel_info pi on pi.pno = t1.pno
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = t1.resp_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
left join ph_staging.order_info oi on if(pi.returned = 1, pi.customary_pno, pi.pno) = oi.pno
left join dwm.dim_ph_sys_store_rd dp2 on dp2.store_id = pi.ticket_pickup_store_id and dp2.stat_date = date_sub(curdate(), interval 1 day)
left join ph_staging.sys_store ss on ss.id = pi.dst_store_id
left join
    (
        select
            b.*
        from
            (
                select
                    pr.pno
                    ,pr.routed_at
                    ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rn
                from ph_staging.parcel_route pr
                join t t1 on t1.pno = pr.pno
                where
                    pr.route_action = 'INVENTORY'
            ) b
        where
            b.rn = 1
    ) pr2 on pr2.pno = t1.pno;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
            select
            a1.*
        from
            (
                select
                    a.*
                from
                    (
                        select
                            pi.pno
                            ,pi.returned
                            ,pi.client_id
                            ,pi.state
                            ,pi.customary_pno
                            ,pr.store_name
                            ,pr.store_id
                            ,pi.interrupt_category
                            ,pr.route_action
                            ,pr.routed_at
                            ,row_number() over (partition by pr.pno order by pr.routed_at desc) rk
                        from ph_staging.parcel_info pi
                        left join ph_staging.parcel_route pr on pr.pno = pi.pno
                        where
                            pi.state not in (5,7,8,9)
                            and pi.created_at < date_sub(now(), interval 56 hour)
                    ) a
                where
                    a.rk = 1
            ) a1
        where
            a1.routed_at < date_sub(now(), interval 56 hour)
)
select
    t1.pno
    ,if(t1.returned = 0, '正向', '退件') 包裹流向
    ,t1.client_id
    ,case t1.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,case a2.duty_result
        when 1 then '丢失'
        when 2 then '破损'
        when 3 then '超时效'
    end 判责类型
    ,a2.updated_at 判责日期
#     ,t1.route_action
    ,case t1.route_action # 路由动作
         when 'ACCEPT_PARCEL' then '接件扫描'
         when 'ARRIVAL_GOODS_VAN_CHECK_SCAN' then '车货关联到港'
         when 'ARRIVAL_WAREHOUSE_SCAN' then '到件入仓扫描'
         when 'CANCEL_ARRIVAL_WAREHOUSE_SCAN' then '取消到件入仓扫描'
         when 'CANCEL_PARCEL' then '撤销包裹'
         when 'CANCEL_SHIPMENT_WAREHOUSE' then '取消发件出仓'
         when 'CHANGE_PARCEL_CANCEL' then '修改包裹为撤销'
         when 'CHANGE_PARCEL_CLOSE' then '修改包裹为异常关闭'
         when 'CHANGE_PARCEL_IN_TRANSIT' then '修改包裹为运输中'
         when 'CHANGE_PARCEL_INFO' then '修改包裹信息'
         when 'CHANGE_PARCEL_SIGNED' then '修改包裹为签收'
         when 'CLAIMS_CLOSE' then '理赔关闭'
         when 'CLAIMS_COMPLETE' then '理赔完成'
         when 'CLAIMS_CONTACT' then '已联系客户'
         when 'CLAIMS_TRANSFER_CS' then '转交总部cs处理'
         when 'CLOSE_ORDER' then '关闭订单'
         when 'CONTINUE_TRANSPORT' then '疑难件继续配送'
         when 'CREATE_WORK_ORDER' then '创建工单'
         when 'CUSTOMER_CHANGE_PARCEL_INFO' then '客户修改包裹信息'
         when 'CUSTOMER_OPERATING_RETURN' then '客户操作退回寄件人'
         when 'DELIVERY_CONFIRM' then '确认妥投'
         when 'DELIVERY_MARKER' then '派件标记'
         when 'DELIVERY_PICKUP_STORE_SCAN' then '自提取件扫描'
         when 'DELIVERY_TICKET_CREATION_SCAN' then '交接扫描'
         when 'DELIVERY_TRANSFER' then '派件转单'
         when 'DEPARTURE_GOODS_VAN_CK_SCAN' then '车货关联出港'
         when 'DETAIN_WAREHOUSE' then '货件留仓'
         when 'DIFFICULTY_FINISH_INDEMNITY' then '疑难件支付赔偿'
         when 'DIFFICULTY_HANDOVER' then '疑难件交接'
         when 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE' then '疑难件交接货件留仓'
         when 'DIFFICULTY_RE_TRANSIT' then '疑难件退回区域总部/重启运送'
         when 'DIFFICULTY_RETURN' then '疑难件退回寄件人'
         when 'DIFFICULTY_SEAL' then '集包异常'
         when 'DISCARD_RETURN_BKK' then '丢弃包裹的，换单后寄回BKK'
         when 'DISTRIBUTION_INVENTORY' then '分拨盘库'
         when 'DWS_WEIGHT_IMAGE' then 'DWS复秤照片'
         when 'EXCHANGE_PARCEL' then '换货'
         when 'FAKE_CANCEL_HANDLE' then '虚假撤销判责'
         when 'FLASH_HOME_SCAN' then 'FH交接扫描'
         when 'FORCE_TAKE_PHOTO' then '强制拍照路由'
         when 'HAVE_HAIR_SCAN_NO_TO' then '有发无到'
         when 'HURRY_PARCEL' then '催单'
         when 'INCOMING_CALL' then '来电接听'
         when 'INTERRUPT_PARCEL_AND_RETURN' then '中断运输并退回'
         when 'INVENTORY' then '盘库'
         when 'LOSE_PARCEL_TEAM_OPERATION' then '丢失件团队处理'
         when 'MANUAL_REMARK' then '添加备注'
         when 'MISS_PICKUP_HANDLE' then '漏包裹揽收判责'
         when 'MISSING_PARCEL_SCAN' then '丢失件包裹操作'
         when 'NOTICE_LOST_PARTS_TEAM' then '已通知丢失件团队'
         when 'PARCEL_HEADLESS_CLAIMED' then '无头件包裹已认领'
         when 'PARCEL_HEADLESS_PRINTED' then '无头件包裹已打单'
         when 'PENDING_RETURN' then '待退件'
         when 'PHONE' then '电话联系'
         when 'PICK_UP_STORE' then '待自提取件'
         when 'PICKUP_RETURN_RECEIPT' then '签回单揽收'
         when 'PRINTING' then '打印面单'
         when 'QAQC_OPERATION' then 'QAQC判责'
         when 'RECEIVE_WAREHOUSE_SCAN' then '收件入仓'
         when 'RECEIVED' then '已揽收,初始化动作，实际情况并没有作用'
         when 'REFUND_CONFIRM' then '退件妥投'
         when 'REPAIRED' then '上报问题修复路由'
         when 'REPLACE_PNO' then '换单'
         when 'REPLY_WORK_ORDER' then '回复工单'
         when 'REVISION_TIME' then '改约时间'
         when 'SEAL' then '集包'
         when 'SEAL_NUMBER_CHANGE' then '集包件数变化'
         when 'SHIPMENT_WAREHOUSE_SCAN' then '发件出仓扫描'
         when 'SORTER_WEIGHT_IMAGE' then '分拣机复秤照片'
         when 'SORTING_SCAN' then '分拣扫描'
         when 'STAFF_INFO_UPDATE_WEIGHT' then '快递员修改重量'
         when 'STORE_KEEPER_UPDATE_WEIGHT' then '仓管员复秤'
         when 'STORE_SORTER_UPDATE_WEIGHT' then '分拣机复秤'
         when 'SYSTEM_AUTO_RETURN' then '系统自动退件'
         when 'TAKE_PHOTO' then '异常打单拍照'
         when 'THIRD_EXPRESS_ROUTE' then '第三方公司路由'
         when 'THIRD_PARTY_REASON_DETAIN' then '第三方原因滞留'
         when 'TICKET_WEIGHT_IMAGE' then '揽收称重照片'
         when 'TRANSFER_LOST_PARTS_TEAM' then '已转交丢失件团队'
         when 'TRANSFER_QAQC' then '转交QAQC处理'
         when 'UNSEAL' then '拆包'
         when 'UNSEAL_NO_PARCEL' then '上报包裹不在集包里'
         when 'UNSEAL_NOT_SCANNED' then '集包已拆包，本包裹未被扫描'
         when 'VEHICLE_ACCIDENT_REG' then '车辆车祸登记'
         when 'VEHICLE_ACCIDENT_REGISTRATION' then '车辆车祸登记'
         when 'VEHICLE_WET_DAMAGE_REG' then '车辆湿损登记'
         when 'VEHICLE_WET_DAMAGE_REGISTRATION' then '车辆湿损登记'
    end as 最后一次有效路由操作
    ,t1.store_name 最后一次有效路由网点
    ,convert_tz(ss.routed_at, '+00:00', '+08:00') 到达网点时间
    ,date(convert_tz(t1.routed_at, '+00:00', '+08:00')) 最后一次有效路由时间
    ,timestampdiff(hour, convert_tz(t1.routed_at, '+00:00', '+08:00'), now()) 最近一次有效路由至今小时数
    ,if(t1.returned = 0, dai.returned_delivery_attempt_num, dai.delivery_attempt_num) 尝试派送次数
    ,if(t1.interrupt_category = 3, '是', '否') 是否有待退件标记
    ,case
        when t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139') and curdate() > laz.delievey_end_date then '是'
        when t1.client_id in ('AA0131', 'AA0132') and curdate() > tik.end_date then '是'
        when t1.client_id in ('AA0090', 'AA0128','AA0089') and curdate() > sho.end_date then '是'
        when t1.client_id in ('AA0149', 'AA0148') and curdate() > she.delievey_end_date then '是'
        else null
    end 是否已经超时
    ,case
        when t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139') and curdate() > laz.delievey_end_date then datediff(curdate(), laz.delievey_end_date)
        when t1.client_id in ('AA0131', 'AA0132') and curdate() > tik.end_date then datediff(curdate(), tik.end_date)
        when t1.client_id in ('AA0090', 'AA0128','AA0089') and curdate() > sho.end_date then datediff(curdate(), sho.end_date)
        when t1.client_id in ('AA0149', 'AA0148') and curdate() > she.delievey_end_date then datediff(curdate(), she.delievey_end_date)
        else null
    end  超时天数
    ,if(t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139'), oi.insure_declare_value/100, oi.cogs_amount/100) cogs金额
from t t1
left join
    (
        select
            plt.pno
            ,plt.updated_at
            ,plt.duty_result
        from ph_bi.parcel_lose_task plt
        join t t1 on t1.pno = plt.pno
        where
            plt.state = 6
    ) a2 on a2.pno = t1.pno
left join dwm.dwd_ex_ph_lazada_pno_period laz on laz.pno = t1.pno
left join dwm.dwd_ex_shopee_pno_period sho on sho.pno = t1.pno
left join dwm.dwd_ex_ph_tiktok_sla_detail tik on tik.pno = t1.pno
left join dwm.dwd_ex_ph_shein_sla_detail she on she.pno = t1.pno
left join ph_staging.delivery_attempt_info dai on dai.pno = if(t1.returned = 0, t1.pno, t1.customary_pno)
left join
    (
        select
            pr.routed_at
            ,pr.pno
            ,row_number() over (partition by pr.pno order by pr.routed_at ) rk
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno and pr.store_id = t1.store_id
        where
            pr.route_action in ('INVENTORY','RECEIVED' ,'RECEIVE_WAREHOUSE_SCAN', 'SORTING_SCAN', 'DELIVERY_TICKET_CREATION_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SHIPMENT_WAREHOUSE_SCAN', 'DETAIN_WAREHOUSE', 'DELIVERY_CONFIRM', 'DIFFICULTY_HANDOVER', 'DELIVERY_MARKER', 'REPLACE_PNO','SEAL', 'UNSEAL', 'STAFF_INFO_UPDATE_WEIGHT', 'STORE_KEEPER_UPDATE_WEIGHT', 'STORE_SORTER_UPDATE_WEIGHT', 'DISCARD_RETURN_BKK', 'DELIVERY_TRANSFER', 'PICKUP_RETURN_RECEIPT', 'FLASH_HOME_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SORTING_SCAN ', 'DELIVERY_PICKUP_STORE_SCAN', 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE', 'REFUND_CONFIRM', 'ACCEPT_PARCEL')
    ) ss on ss.pno = t1.pno and ss.rk = 1
left join ph_staging.order_info oi on oi.pno = t1.pno;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
            select
            a1.*
        from
            (
                select
                    a.*
                from
                    (
                        select
                            pi.pno
                            ,pi.returned
                            ,pi.client_id
                            ,pi.state
                            ,pi.customary_pno
                            ,pr.store_name
                            ,pr.store_id
                            ,pi.interrupt_category
                            ,pr.route_action
                            ,pr.routed_at
                            ,row_number() over (partition by pr.pno order by pr.routed_at desc) rk
                        from ph_staging.parcel_info pi
                        left join ph_staging.parcel_route pr on pr.pno = pi.pno
                        where
                            pi.state not in (5,7,8,9)
                            and pi.created_at < date_sub(now(), interval 56 hour)
                    ) a
                where
                    a.rk = 1
            ) a1
        where
            a1.routed_at < date_sub(now(), interval 56 hour)
)
select
    t1.pno
    ,if(t1.returned = 0, '正向', '退件') 包裹流向
    ,t1.client_id
    ,case t1.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,case a2.duty_result
        when 1 then '丢失'
        when 2 then '破损'
        when 3 then '超时效'
    end 判责类型
    ,a2.updated_at 判责日期
#     ,t1.route_action
    ,case t1.route_action # 路由动作
         when 'ACCEPT_PARCEL' then '接件扫描'
         when 'ARRIVAL_GOODS_VAN_CHECK_SCAN' then '车货关联到港'
         when 'ARRIVAL_WAREHOUSE_SCAN' then '到件入仓扫描'
         when 'CANCEL_ARRIVAL_WAREHOUSE_SCAN' then '取消到件入仓扫描'
         when 'CANCEL_PARCEL' then '撤销包裹'
         when 'CANCEL_SHIPMENT_WAREHOUSE' then '取消发件出仓'
         when 'CHANGE_PARCEL_CANCEL' then '修改包裹为撤销'
         when 'CHANGE_PARCEL_CLOSE' then '修改包裹为异常关闭'
         when 'CHANGE_PARCEL_IN_TRANSIT' then '修改包裹为运输中'
         when 'CHANGE_PARCEL_INFO' then '修改包裹信息'
         when 'CHANGE_PARCEL_SIGNED' then '修改包裹为签收'
         when 'CLAIMS_CLOSE' then '理赔关闭'
         when 'CLAIMS_COMPLETE' then '理赔完成'
         when 'CLAIMS_CONTACT' then '已联系客户'
         when 'CLAIMS_TRANSFER_CS' then '转交总部cs处理'
         when 'CLOSE_ORDER' then '关闭订单'
         when 'CONTINUE_TRANSPORT' then '疑难件继续配送'
         when 'CREATE_WORK_ORDER' then '创建工单'
         when 'CUSTOMER_CHANGE_PARCEL_INFO' then '客户修改包裹信息'
         when 'CUSTOMER_OPERATING_RETURN' then '客户操作退回寄件人'
         when 'DELIVERY_CONFIRM' then '确认妥投'
         when 'DELIVERY_MARKER' then '派件标记'
         when 'DELIVERY_PICKUP_STORE_SCAN' then '自提取件扫描'
         when 'DELIVERY_TICKET_CREATION_SCAN' then '交接扫描'
         when 'DELIVERY_TRANSFER' then '派件转单'
         when 'DEPARTURE_GOODS_VAN_CK_SCAN' then '车货关联出港'
         when 'DETAIN_WAREHOUSE' then '货件留仓'
         when 'DIFFICULTY_FINISH_INDEMNITY' then '疑难件支付赔偿'
         when 'DIFFICULTY_HANDOVER' then '疑难件交接'
         when 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE' then '疑难件交接货件留仓'
         when 'DIFFICULTY_RE_TRANSIT' then '疑难件退回区域总部/重启运送'
         when 'DIFFICULTY_RETURN' then '疑难件退回寄件人'
         when 'DIFFICULTY_SEAL' then '集包异常'
         when 'DISCARD_RETURN_BKK' then '丢弃包裹的，换单后寄回BKK'
         when 'DISTRIBUTION_INVENTORY' then '分拨盘库'
         when 'DWS_WEIGHT_IMAGE' then 'DWS复秤照片'
         when 'EXCHANGE_PARCEL' then '换货'
         when 'FAKE_CANCEL_HANDLE' then '虚假撤销判责'
         when 'FLASH_HOME_SCAN' then 'FH交接扫描'
         when 'FORCE_TAKE_PHOTO' then '强制拍照路由'
         when 'HAVE_HAIR_SCAN_NO_TO' then '有发无到'
         when 'HURRY_PARCEL' then '催单'
         when 'INCOMING_CALL' then '来电接听'
         when 'INTERRUPT_PARCEL_AND_RETURN' then '中断运输并退回'
         when 'INVENTORY' then '盘库'
         when 'LOSE_PARCEL_TEAM_OPERATION' then '丢失件团队处理'
         when 'MANUAL_REMARK' then '添加备注'
         when 'MISS_PICKUP_HANDLE' then '漏包裹揽收判责'
         when 'MISSING_PARCEL_SCAN' then '丢失件包裹操作'
         when 'NOTICE_LOST_PARTS_TEAM' then '已通知丢失件团队'
         when 'PARCEL_HEADLESS_CLAIMED' then '无头件包裹已认领'
         when 'PARCEL_HEADLESS_PRINTED' then '无头件包裹已打单'
         when 'PENDING_RETURN' then '待退件'
         when 'PHONE' then '电话联系'
         when 'PICK_UP_STORE' then '待自提取件'
         when 'PICKUP_RETURN_RECEIPT' then '签回单揽收'
         when 'PRINTING' then '打印面单'
         when 'QAQC_OPERATION' then 'QAQC判责'
         when 'RECEIVE_WAREHOUSE_SCAN' then '收件入仓'
         when 'RECEIVED' then '已揽收,初始化动作，实际情况并没有作用'
         when 'REFUND_CONFIRM' then '退件妥投'
         when 'REPAIRED' then '上报问题修复路由'
         when 'REPLACE_PNO' then '换单'
         when 'REPLY_WORK_ORDER' then '回复工单'
         when 'REVISION_TIME' then '改约时间'
         when 'SEAL' then '集包'
         when 'SEAL_NUMBER_CHANGE' then '集包件数变化'
         when 'SHIPMENT_WAREHOUSE_SCAN' then '发件出仓扫描'
         when 'SORTER_WEIGHT_IMAGE' then '分拣机复秤照片'
         when 'SORTING_SCAN' then '分拣扫描'
         when 'STAFF_INFO_UPDATE_WEIGHT' then '快递员修改重量'
         when 'STORE_KEEPER_UPDATE_WEIGHT' then '仓管员复秤'
         when 'STORE_SORTER_UPDATE_WEIGHT' then '分拣机复秤'
         when 'SYSTEM_AUTO_RETURN' then '系统自动退件'
         when 'TAKE_PHOTO' then '异常打单拍照'
         when 'THIRD_EXPRESS_ROUTE' then '第三方公司路由'
         when 'THIRD_PARTY_REASON_DETAIN' then '第三方原因滞留'
         when 'TICKET_WEIGHT_IMAGE' then '揽收称重照片'
         when 'TRANSFER_LOST_PARTS_TEAM' then '已转交丢失件团队'
         when 'TRANSFER_QAQC' then '转交QAQC处理'
         when 'UNSEAL' then '拆包'
         when 'UNSEAL_NO_PARCEL' then '上报包裹不在集包里'
         when 'UNSEAL_NOT_SCANNED' then '集包已拆包，本包裹未被扫描'
         when 'VEHICLE_ACCIDENT_REG' then '车辆车祸登记'
         when 'VEHICLE_ACCIDENT_REGISTRATION' then '车辆车祸登记'
         when 'VEHICLE_WET_DAMAGE_REG' then '车辆湿损登记'
         when 'VEHICLE_WET_DAMAGE_REGISTRATION' then '车辆湿损登记'
    end as 最后一次有效路由操作
    ,t1.store_name 最后一次有效路由网点
    ,convert_tz(ss.routed_at, '+00:00', '+08:00') 到达网点时间
    ,date(convert_tz(t1.routed_at, '+00:00', '+08:00')) 最后一次有效路由时间
    ,timestampdiff(hour, convert_tz(t1.routed_at, '+00:00', '+08:00'), now()) 最近一次有效路由至今小时数
    ,if(t1.returned = 0, dai.delivery_attempt_num, dai.returned_delivery_attempt_num) 尝试派送次数
    ,if(t1.interrupt_category = 3, '是', '否') 是否有待退件标记
    ,case
        when t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139') and curdate() > laz.delievey_end_date then '是'
        when t1.client_id in ('AA0131', 'AA0132') and curdate() > tik.end_date then '是'
        when t1.client_id in ('AA0090', 'AA0128','AA0089') and curdate() > sho.end_date then '是'
        when t1.client_id in ('AA0149', 'AA0148') and curdate() > she.delievey_end_date then '是'
        else null
    end 是否已经超时
    ,case
        when t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139') and curdate() > laz.delievey_end_date then datediff(curdate(), laz.delievey_end_date)
        when t1.client_id in ('AA0131', 'AA0132') and curdate() > tik.end_date then datediff(curdate(), tik.end_date)
        when t1.client_id in ('AA0090', 'AA0128','AA0089') and curdate() > sho.end_date then datediff(curdate(), sho.end_date)
        when t1.client_id in ('AA0149', 'AA0148') and curdate() > she.delievey_end_date then datediff(curdate(), she.delievey_end_date)
        else null
    end  超时天数
    ,if(t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139'), oi.insure_declare_value/100, oi.cogs_amount/100) cogs金额
from t t1
left join
    (
        select
            plt.pno
            ,plt.updated_at
            ,plt.duty_result
        from ph_bi.parcel_lose_task plt
        join t t1 on t1.pno = plt.pno
        where
            plt.state = 6
    ) a2 on a2.pno = t1.pno
left join dwm.dwd_ex_ph_lazada_pno_period laz on laz.pno = t1.pno
left join dwm.dwd_ex_shopee_pno_period sho on sho.pno = t1.pno
left join dwm.dwd_ex_ph_tiktok_sla_detail tik on tik.pno = t1.pno
left join dwm.dwd_ex_ph_shein_sla_detail she on she.pno = t1.pno
left join ph_staging.delivery_attempt_info dai on dai.pno = if(t1.returned = 0, t1.pno, t1.customary_pno)
left join
    (
        select
            pr.routed_at
            ,pr.pno
            ,row_number() over (partition by pr.pno order by pr.routed_at ) rk
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno and pr.store_id = t1.store_id
        where
            pr.route_action in ('INVENTORY','RECEIVED' ,'RECEIVE_WAREHOUSE_SCAN', 'SORTING_SCAN', 'DELIVERY_TICKET_CREATION_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SHIPMENT_WAREHOUSE_SCAN', 'DETAIN_WAREHOUSE', 'DELIVERY_CONFIRM', 'DIFFICULTY_HANDOVER', 'DELIVERY_MARKER', 'REPLACE_PNO','SEAL', 'UNSEAL', 'STAFF_INFO_UPDATE_WEIGHT', 'STORE_KEEPER_UPDATE_WEIGHT', 'STORE_SORTER_UPDATE_WEIGHT', 'DISCARD_RETURN_BKK', 'DELIVERY_TRANSFER', 'PICKUP_RETURN_RECEIPT', 'FLASH_HOME_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SORTING_SCAN ', 'DELIVERY_PICKUP_STORE_SCAN', 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE', 'REFUND_CONFIRM', 'ACCEPT_PARCEL')
    ) ss on ss.pno = t1.pno and ss.rk = 1
left join ph_staging.order_info oi on oi.pno = t1.pno;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
        select
            a1.*
        from
            (
                select
                    a.*
                from
                    (
                        select
                            pi.pno
                            ,pi.returned
                            ,pi.client_id
                            ,pi.state
                            ,pi.ticket_pickup_store_id
                            ,pi.dst_store_id
                            ,pi.customary_pno
                            ,pr.store_name
                            ,pr.store_id
                            ,pi.interrupt_category
                            ,pr.route_action
                            ,pr.routed_at
                            ,row_number() over (partition by pr.pno order by pr.routed_at desc) rk
                        from ph_staging.parcel_info pi
                        left join ph_staging.parcel_route pr on pr.pno = pi.pno
                        where
                            pi.state not in (5,7,8,9)
                            and pi.created_at < date_sub(now(), interval 56 hour)
                            and pr.route_action in ('INVENTORY','RECEIVED' ,'RECEIVE_WAREHOUSE_SCAN', 'SORTING_SCAN', 'DELIVERY_TICKET_CREATION_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SHIPMENT_WAREHOUSE_SCAN', 'DETAIN_WAREHOUSE', 'DELIVERY_CONFIRM', 'DIFFICULTY_HANDOVER', 'DELIVERY_MARKER', 'REPLACE_PNO','SEAL', 'UNSEAL', 'STAFF_INFO_UPDATE_WEIGHT', 'STORE_KEEPER_UPDATE_WEIGHT', 'STORE_SORTER_UPDATE_WEIGHT', 'DISCARD_RETURN_BKK', 'DELIVERY_TRANSFER', 'PICKUP_RETURN_RECEIPT', 'FLASH_HOME_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SORTING_SCAN ', 'DELIVERY_PICKUP_STORE_SCAN', 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE', 'REFUND_CONFIRM', 'ACCEPT_PARCEL')
                    ) a
                where
                    a.rk = 1
            ) a1
        where
            a1.routed_at < date_sub(now(), interval 56 hour)
)
select
    t1.pno
    ,if(t1.returned = 0, '正向', '退件') 包裹流向
    ,t1.client_id
    ,case t1.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,ss2.name 揽收网点
    ,ss3.name 目的地网点
    ,case a2.duty_result
        when 1 then '丢失'
        when 2 then '破损'
        when 3 then '超时效'
    end 判责类型
    ,a2.updated_at 判责日期
#     ,t1.route_action
    ,case t1.route_action # 路由动作
         when 'ACCEPT_PARCEL' then '接件扫描'
         when 'ARRIVAL_GOODS_VAN_CHECK_SCAN' then '车货关联到港'
         when 'ARRIVAL_WAREHOUSE_SCAN' then '到件入仓扫描'
         when 'CANCEL_ARRIVAL_WAREHOUSE_SCAN' then '取消到件入仓扫描'
         when 'CANCEL_PARCEL' then '撤销包裹'
         when 'CANCEL_SHIPMENT_WAREHOUSE' then '取消发件出仓'
         when 'CHANGE_PARCEL_CANCEL' then '修改包裹为撤销'
         when 'CHANGE_PARCEL_CLOSE' then '修改包裹为异常关闭'
         when 'CHANGE_PARCEL_IN_TRANSIT' then '修改包裹为运输中'
         when 'CHANGE_PARCEL_INFO' then '修改包裹信息'
         when 'CHANGE_PARCEL_SIGNED' then '修改包裹为签收'
         when 'CLAIMS_CLOSE' then '理赔关闭'
         when 'CLAIMS_COMPLETE' then '理赔完成'
         when 'CLAIMS_CONTACT' then '已联系客户'
         when 'CLAIMS_TRANSFER_CS' then '转交总部cs处理'
         when 'CLOSE_ORDER' then '关闭订单'
         when 'CONTINUE_TRANSPORT' then '疑难件继续配送'
         when 'CREATE_WORK_ORDER' then '创建工单'
         when 'CUSTOMER_CHANGE_PARCEL_INFO' then '客户修改包裹信息'
         when 'CUSTOMER_OPERATING_RETURN' then '客户操作退回寄件人'
         when 'DELIVERY_CONFIRM' then '确认妥投'
         when 'DELIVERY_MARKER' then '派件标记'
         when 'DELIVERY_PICKUP_STORE_SCAN' then '自提取件扫描'
         when 'DELIVERY_TICKET_CREATION_SCAN' then '交接扫描'
         when 'DELIVERY_TRANSFER' then '派件转单'
         when 'DEPARTURE_GOODS_VAN_CK_SCAN' then '车货关联出港'
         when 'DETAIN_WAREHOUSE' then '货件留仓'
         when 'DIFFICULTY_FINISH_INDEMNITY' then '疑难件支付赔偿'
         when 'DIFFICULTY_HANDOVER' then '疑难件交接'
         when 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE' then '疑难件交接货件留仓'
         when 'DIFFICULTY_RE_TRANSIT' then '疑难件退回区域总部/重启运送'
         when 'DIFFICULTY_RETURN' then '疑难件退回寄件人'
         when 'DIFFICULTY_SEAL' then '集包异常'
         when 'DISCARD_RETURN_BKK' then '丢弃包裹的，换单后寄回BKK'
         when 'DISTRIBUTION_INVENTORY' then '分拨盘库'
         when 'DWS_WEIGHT_IMAGE' then 'DWS复秤照片'
         when 'EXCHANGE_PARCEL' then '换货'
         when 'FAKE_CANCEL_HANDLE' then '虚假撤销判责'
         when 'FLASH_HOME_SCAN' then 'FH交接扫描'
         when 'FORCE_TAKE_PHOTO' then '强制拍照路由'
         when 'HAVE_HAIR_SCAN_NO_TO' then '有发无到'
         when 'HURRY_PARCEL' then '催单'
         when 'INCOMING_CALL' then '来电接听'
         when 'INTERRUPT_PARCEL_AND_RETURN' then '中断运输并退回'
         when 'INVENTORY' then '盘库'
         when 'LOSE_PARCEL_TEAM_OPERATION' then '丢失件团队处理'
         when 'MANUAL_REMARK' then '添加备注'
         when 'MISS_PICKUP_HANDLE' then '漏包裹揽收判责'
         when 'MISSING_PARCEL_SCAN' then '丢失件包裹操作'
         when 'NOTICE_LOST_PARTS_TEAM' then '已通知丢失件团队'
         when 'PARCEL_HEADLESS_CLAIMED' then '无头件包裹已认领'
         when 'PARCEL_HEADLESS_PRINTED' then '无头件包裹已打单'
         when 'PENDING_RETURN' then '待退件'
         when 'PHONE' then '电话联系'
         when 'PICK_UP_STORE' then '待自提取件'
         when 'PICKUP_RETURN_RECEIPT' then '签回单揽收'
         when 'PRINTING' then '打印面单'
         when 'QAQC_OPERATION' then 'QAQC判责'
         when 'RECEIVE_WAREHOUSE_SCAN' then '收件入仓'
         when 'RECEIVED' then '已揽收,初始化动作，实际情况并没有作用'
         when 'REFUND_CONFIRM' then '退件妥投'
         when 'REPAIRED' then '上报问题修复路由'
         when 'REPLACE_PNO' then '换单'
         when 'REPLY_WORK_ORDER' then '回复工单'
         when 'REVISION_TIME' then '改约时间'
         when 'SEAL' then '集包'
         when 'SEAL_NUMBER_CHANGE' then '集包件数变化'
         when 'SHIPMENT_WAREHOUSE_SCAN' then '发件出仓扫描'
         when 'SORTER_WEIGHT_IMAGE' then '分拣机复秤照片'
         when 'SORTING_SCAN' then '分拣扫描'
         when 'STAFF_INFO_UPDATE_WEIGHT' then '快递员修改重量'
         when 'STORE_KEEPER_UPDATE_WEIGHT' then '仓管员复秤'
         when 'STORE_SORTER_UPDATE_WEIGHT' then '分拣机复秤'
         when 'SYSTEM_AUTO_RETURN' then '系统自动退件'
         when 'TAKE_PHOTO' then '异常打单拍照'
         when 'THIRD_EXPRESS_ROUTE' then '第三方公司路由'
         when 'THIRD_PARTY_REASON_DETAIN' then '第三方原因滞留'
         when 'TICKET_WEIGHT_IMAGE' then '揽收称重照片'
         when 'TRANSFER_LOST_PARTS_TEAM' then '已转交丢失件团队'
         when 'TRANSFER_QAQC' then '转交QAQC处理'
         when 'UNSEAL' then '拆包'
         when 'UNSEAL_NO_PARCEL' then '上报包裹不在集包里'
         when 'UNSEAL_NOT_SCANNED' then '集包已拆包，本包裹未被扫描'
         when 'VEHICLE_ACCIDENT_REG' then '车辆车祸登记'
         when 'VEHICLE_ACCIDENT_REGISTRATION' then '车辆车祸登记'
         when 'VEHICLE_WET_DAMAGE_REG' then '车辆湿损登记'
         when 'VEHICLE_WET_DAMAGE_REGISTRATION' then '车辆湿损登记'
    end as 最后一次有效路由操作
    ,t1.store_name 最后一次有效路由网点
    ,convert_tz(ss.routed_at, '+00:00', '+08:00') 到达网点时间
    ,date(convert_tz(t1.routed_at, '+00:00', '+08:00')) 最后一次有效路由时间
    ,timestampdiff(hour, convert_tz(t1.routed_at, '+00:00', '+08:00'), now()) 最近一次有效路由至今小时数
    ,if(t1.returned = 0, dai.delivery_attempt_num, dai.returned_delivery_attempt_num) 尝试派送次数
    ,if(t1.interrupt_category = 3, '是', '否') 是否有待退件标记
    ,case
        when t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139') and curdate() > laz.delievey_end_date then '是'
        when t1.client_id in ('AA0131', 'AA0132') and curdate() > tik.end_date then '是'
        when t1.client_id in ('AA0090', 'AA0128','AA0089') and curdate() > sho.end_date then '是'
        when t1.client_id in ('AA0149', 'AA0148') and curdate() > she.delievey_end_date then '是'
        else null
    end 是否已经超时
    ,case
        when t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139') and curdate() > laz.delievey_end_date then datediff(curdate(), laz.delievey_end_date)
        when t1.client_id in ('AA0131', 'AA0132') and curdate() > tik.end_date then datediff(curdate(), tik.end_date)
        when t1.client_id in ('AA0090', 'AA0128','AA0089') and curdate() > sho.end_date then datediff(curdate(), sho.end_date)
        when t1.client_id in ('AA0149', 'AA0148') and curdate() > she.delievey_end_date then datediff(curdate(), she.delievey_end_date)
        else null
    end  超时天数
    ,if(t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139'), oi.insure_declare_value/100, oi.cogs_amount/100) cogs金额
from t t1
left join
    (
        select
            plt.pno
            ,plt.updated_at
            ,plt.duty_result
        from ph_bi.parcel_lose_task plt
        join t t1 on t1.pno = plt.pno
        where
            plt.state = 6
    ) a2 on a2.pno = t1.pno
left join dwm.dwd_ex_ph_lazada_pno_period laz on laz.pno = t1.pno
left join dwm.dwd_ex_shopee_pno_period sho on sho.pno = t1.pno
left join dwm.dwd_ex_ph_tiktok_sla_detail tik on tik.pno = t1.pno
left join dwm.dwd_ex_ph_shein_sla_detail she on she.pno = t1.pno
left join ph_staging.delivery_attempt_info dai on dai.pno = if(t1.returned = 0, t1.pno, t1.customary_pno)
left join
    (
        select
            pr.routed_at
            ,pr.pno
            ,row_number() over (partition by pr.pno order by pr.routed_at ) rk
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno and pr.store_id = t1.store_id
        where
            pr.route_action in ('INVENTORY','RECEIVED' ,'RECEIVE_WAREHOUSE_SCAN', 'SORTING_SCAN', 'DELIVERY_TICKET_CREATION_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SHIPMENT_WAREHOUSE_SCAN', 'DETAIN_WAREHOUSE', 'DELIVERY_CONFIRM', 'DIFFICULTY_HANDOVER', 'DELIVERY_MARKER', 'REPLACE_PNO','SEAL', 'UNSEAL', 'STAFF_INFO_UPDATE_WEIGHT', 'STORE_KEEPER_UPDATE_WEIGHT', 'STORE_SORTER_UPDATE_WEIGHT', 'DISCARD_RETURN_BKK', 'DELIVERY_TRANSFER', 'PICKUP_RETURN_RECEIPT', 'FLASH_HOME_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SORTING_SCAN ', 'DELIVERY_PICKUP_STORE_SCAN', 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE', 'REFUND_CONFIRM', 'ACCEPT_PARCEL')
    ) ss on ss.pno = t1.pno and ss.rk = 1
left join ph_staging.order_info oi on oi.pno = t1.pno
left join ph_staging.sys_store ss2 on ss2.id = t1.ticket_pickup_store_id
left join ph_staging.sys_store ss3 on ss3.id = t1.dst_store_id;
;-- -. . -..- - / . -. - .-. -.--
with a as
(
    -- lazada
        select
            laz.pno
            ,laz.delievey_end_date end_date
            ,pi.returned
            ,pi.client_id
            ,pi.state
            ,pi.customary_pno
            ,pi.insure_declare_value
            ,pi.ticket_pickup_store_id
            ,pi.dst_store_id
            ,pi.interrupt_category
        from dwm.dwd_ex_ph_lazada_pno_period laz
        join ph_staging.parcel_info pi on pi.pno = laz.pno
        where
            pi.state not in (5,7,8,9)
            and laz.delievey_end_date < curdate()

        union all

        select
            sho.pno
            ,sho.end_date
            ,pi.returned
            ,pi.client_id
            ,pi.state
            ,pi.customary_pno
            ,pi.insure_declare_value
            ,pi.ticket_pickup_store_id
            ,pi.dst_store_id
            ,pi.interrupt_category
        from dwm.dwd_ex_shopee_pno_period sho
        join ph_staging.parcel_info pi on pi.pno = sho.pno
        where
            pi.state not in (5,7,8,9)
            and sho.end_date < curdate()
        -- tiktok
        union all

        select
            tik.pno
            ,tik.end_date
            ,pi.returned
            ,pi.client_id
            ,pi.state
            ,pi.customary_pno
            ,pi.insure_declare_value
            ,pi.ticket_pickup_store_id
            ,pi.dst_store_id
            ,pi.interrupt_category
        from dwm.dwd_ex_ph_tiktok_sla_detail tik
        join ph_staging.parcel_info pi on pi.pno = tik.pno
        where
            pi.state not in (5,7,8,9)
            and tik.end_date < curdate()

        union all
        -- shein
        select
            shein.pno
            ,shein.delievey_end_date
            ,pi.returned
            ,pi.client_id
            ,pi.state
            ,pi.customary_pno
            ,pi.insure_declare_value
            ,pi.ticket_pickup_store_id
            ,pi.dst_store_id
            ,pi.interrupt_category
        from dwm.dwd_ex_ph_shein_sla_detail shein
        join ph_staging.parcel_info pi on pi.pno = tik.pno
        where
            pi.state not in (5,7,8,9)
            and shein.delievey_end_date < curdate()
)
, t as
(
    select
        a1.*
    from
        (
            select
                pr.pno
                ,pr.routed_at
                ,pr.route_action
                ,pr.store_name
                ,pr.store_id
                ,t1.*
                ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
            from ph_staging.parcel_route pr
            join a t1 on t1.pno = pr.pno
            where
                pr.route_action in ('INVENTORY','RECEIVED' ,'RECEIVE_WAREHOUSE_SCAN', 'SORTING_SCAN', 'DELIVERY_TICKET_CREATION_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SHIPMENT_WAREHOUSE_SCAN', 'DETAIN_WAREHOUSE', 'DELIVERY_CONFIRM', 'DIFFICULTY_HANDOVER', 'DELIVERY_MARKER', 'REPLACE_PNO','SEAL', 'UNSEAL', 'STAFF_INFO_UPDATE_WEIGHT', 'STORE_KEEPER_UPDATE_WEIGHT', 'STORE_SORTER_UPDATE_WEIGHT', 'DISCARD_RETURN_BKK', 'DELIVERY_TRANSFER', 'PICKUP_RETURN_RECEIPT', 'FLASH_HOME_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SORTING_SCAN ', 'DELIVERY_PICKUP_STORE_SCAN', 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE', 'REFUND_CONFIRM', 'ACCEPT_PARCEL')
        ) a1
    where
        a1.rk = 1
)
select
    t1.pno
    ,if(t1.returned = 0, '正向', '退件') 包裹流向
    ,t1.client_id
    ,case t1.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,ss2.name 揽收网点
    ,ss3.name 目的地网点
    ,case a2.duty_result
        when 1 then '丢失'
        when 2 then '破损'
        when 3 then '超时效'
    end 判责类型
    ,a2.updated_at 判责日期
    ,case t1.route_action # 路由动作
         when 'ACCEPT_PARCEL' then '接件扫描'
         when 'ARRIVAL_GOODS_VAN_CHECK_SCAN' then '车货关联到港'
         when 'ARRIVAL_WAREHOUSE_SCAN' then '到件入仓扫描'
         when 'CANCEL_ARRIVAL_WAREHOUSE_SCAN' then '取消到件入仓扫描'
         when 'CANCEL_PARCEL' then '撤销包裹'
         when 'CANCEL_SHIPMENT_WAREHOUSE' then '取消发件出仓'
         when 'CHANGE_PARCEL_CANCEL' then '修改包裹为撤销'
         when 'CHANGE_PARCEL_CLOSE' then '修改包裹为异常关闭'
         when 'CHANGE_PARCEL_IN_TRANSIT' then '修改包裹为运输中'
         when 'CHANGE_PARCEL_INFO' then '修改包裹信息'
         when 'CHANGE_PARCEL_SIGNED' then '修改包裹为签收'
         when 'CLAIMS_CLOSE' then '理赔关闭'
         when 'CLAIMS_COMPLETE' then '理赔完成'
         when 'CLAIMS_CONTACT' then '已联系客户'
         when 'CLAIMS_TRANSFER_CS' then '转交总部cs处理'
         when 'CLOSE_ORDER' then '关闭订单'
         when 'CONTINUE_TRANSPORT' then '疑难件继续配送'
         when 'CREATE_WORK_ORDER' then '创建工单'
         when 'CUSTOMER_CHANGE_PARCEL_INFO' then '客户修改包裹信息'
         when 'CUSTOMER_OPERATING_RETURN' then '客户操作退回寄件人'
         when 'DELIVERY_CONFIRM' then '确认妥投'
         when 'DELIVERY_MARKER' then '派件标记'
         when 'DELIVERY_PICKUP_STORE_SCAN' then '自提取件扫描'
         when 'DELIVERY_TICKET_CREATION_SCAN' then '交接扫描'
         when 'DELIVERY_TRANSFER' then '派件转单'
         when 'DEPARTURE_GOODS_VAN_CK_SCAN' then '车货关联出港'
         when 'DETAIN_WAREHOUSE' then '货件留仓'
         when 'DIFFICULTY_FINISH_INDEMNITY' then '疑难件支付赔偿'
         when 'DIFFICULTY_HANDOVER' then '疑难件交接'
         when 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE' then '疑难件交接货件留仓'
         when 'DIFFICULTY_RE_TRANSIT' then '疑难件退回区域总部/重启运送'
         when 'DIFFICULTY_RETURN' then '疑难件退回寄件人'
         when 'DIFFICULTY_SEAL' then '集包异常'
         when 'DISCARD_RETURN_BKK' then '丢弃包裹的，换单后寄回BKK'
         when 'DISTRIBUTION_INVENTORY' then '分拨盘库'
         when 'DWS_WEIGHT_IMAGE' then 'DWS复秤照片'
         when 'EXCHANGE_PARCEL' then '换货'
         when 'FAKE_CANCEL_HANDLE' then '虚假撤销判责'
         when 'FLASH_HOME_SCAN' then 'FH交接扫描'
         when 'FORCE_TAKE_PHOTO' then '强制拍照路由'
         when 'HAVE_HAIR_SCAN_NO_TO' then '有发无到'
         when 'HURRY_PARCEL' then '催单'
         when 'INCOMING_CALL' then '来电接听'
         when 'INTERRUPT_PARCEL_AND_RETURN' then '中断运输并退回'
         when 'INVENTORY' then '盘库'
         when 'LOSE_PARCEL_TEAM_OPERATION' then '丢失件团队处理'
         when 'MANUAL_REMARK' then '添加备注'
         when 'MISS_PICKUP_HANDLE' then '漏包裹揽收判责'
         when 'MISSING_PARCEL_SCAN' then '丢失件包裹操作'
         when 'NOTICE_LOST_PARTS_TEAM' then '已通知丢失件团队'
         when 'PARCEL_HEADLESS_CLAIMED' then '无头件包裹已认领'
         when 'PARCEL_HEADLESS_PRINTED' then '无头件包裹已打单'
         when 'PENDING_RETURN' then '待退件'
         when 'PHONE' then '电话联系'
         when 'PICK_UP_STORE' then '待自提取件'
         when 'PICKUP_RETURN_RECEIPT' then '签回单揽收'
         when 'PRINTING' then '打印面单'
         when 'QAQC_OPERATION' then 'QAQC判责'
         when 'RECEIVE_WAREHOUSE_SCAN' then '收件入仓'
         when 'RECEIVED' then '已揽收,初始化动作，实际情况并没有作用'
         when 'REFUND_CONFIRM' then '退件妥投'
         when 'REPAIRED' then '上报问题修复路由'
         when 'REPLACE_PNO' then '换单'
         when 'REPLY_WORK_ORDER' then '回复工单'
         when 'REVISION_TIME' then '改约时间'
         when 'SEAL' then '集包'
         when 'SEAL_NUMBER_CHANGE' then '集包件数变化'
         when 'SHIPMENT_WAREHOUSE_SCAN' then '发件出仓扫描'
         when 'SORTER_WEIGHT_IMAGE' then '分拣机复秤照片'
         when 'SORTING_SCAN' then '分拣扫描'
         when 'STAFF_INFO_UPDATE_WEIGHT' then '快递员修改重量'
         when 'STORE_KEEPER_UPDATE_WEIGHT' then '仓管员复秤'
         when 'STORE_SORTER_UPDATE_WEIGHT' then '分拣机复秤'
         when 'SYSTEM_AUTO_RETURN' then '系统自动退件'
         when 'TAKE_PHOTO' then '异常打单拍照'
         when 'THIRD_EXPRESS_ROUTE' then '第三方公司路由'
         when 'THIRD_PARTY_REASON_DETAIN' then '第三方原因滞留'
         when 'TICKET_WEIGHT_IMAGE' then '揽收称重照片'
         when 'TRANSFER_LOST_PARTS_TEAM' then '已转交丢失件团队'
         when 'TRANSFER_QAQC' then '转交QAQC处理'
         when 'UNSEAL' then '拆包'
         when 'UNSEAL_NO_PARCEL' then '上报包裹不在集包里'
         when 'UNSEAL_NOT_SCANNED' then '集包已拆包，本包裹未被扫描'
         when 'VEHICLE_ACCIDENT_REG' then '车辆车祸登记'
         when 'VEHICLE_ACCIDENT_REGISTRATION' then '车辆车祸登记'
         when 'VEHICLE_WET_DAMAGE_REG' then '车辆湿损登记'
         when 'VEHICLE_WET_DAMAGE_REGISTRATION' then '车辆湿损登记'
    end as 最后一次有效路由操作
    ,t1.store_name 最后一次有效路由网点
    ,convert_tz(ss.routed_at, '+00:00', '+08:00') 到达网点时间
    ,date(convert_tz(t1.routed_at, '+00:00', '+08:00')) 最后一次有效路由时间
    ,timestampdiff(hour, convert_tz(t1.routed_at, '+00:00', '+08:00'), now()) 最近一次有效路由至今小时数
    ,if(t1.returned = 0, dai.delivery_attempt_num, dai.returned_delivery_attempt_num) 尝试派送次数
    ,if(t1.interrupt_category = 3, '是', '否') 是否有待退件标记
#     ,case
#         when t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139') and curdate() > t1.end_date then '是'
#         when t1.client_id in ('AA0131', 'AA0132') and curdate() > tik.end_date then '是'
#         when t1.client_id in ('AA0090', 'AA0128','AA0089') and curdate() > sho.end_date then '是'
#         when t1.client_id in ('AA0149', 'AA0148') and curdate() > she.delievey_end_date then '是'
#         else null
#     end 是否已经超时
    ,case
        when t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139') and curdate() > t1.end_date then datediff(curdate(), t1.end_date)
        when t1.client_id in ('AA0131', 'AA0132') and curdate() > t1.end_date then datediff(curdate(), t1.end_date)
        when t1.client_id in ('AA0090', 'AA0128','AA0089') and curdate() > t1.end_date then datediff(curdate(), t1.end_date)
        when t1.client_id in ('AA0149', 'AA0148') and curdate() > t1.end_date then datediff(curdate(), t1.end_date)
        else null
    end  超时天数
    ,if(t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139'), oi.insure_declare_value/100, oi.cogs_amount/100) cogs金额
    ,pho.pho_count 打电话次数
    ,pho.xiangling_count 响铃未通话次数
    ,pho.tonghua_num 有效通话次数
    ,pho.8_tonghua_num 大于8秒通话次数
from t t1
left join
    (
        select
            plt.pno
            ,plt.updated_at
            ,plt.duty_result
        from ph_bi.parcel_lose_task plt
        join t t1 on t1.pno = plt.pno
        where
            plt.state = 6
    ) a2 on a2.pno = t1.pno
left join ph_staging.delivery_attempt_info dai on dai.pno = if(t1.returned = 0, t1.pno, t1.customary_pno)
left join
    (
        select
            pr.routed_at
            ,pr.pno
            ,row_number() over (partition by pr.pno order by pr.routed_at ) rk
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno and pr.store_id = t1.store_id
        where
            pr.route_action in ('INVENTORY','RECEIVED' ,'RECEIVE_WAREHOUSE_SCAN', 'SORTING_SCAN', 'DELIVERY_TICKET_CREATION_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SHIPMENT_WAREHOUSE_SCAN', 'DETAIN_WAREHOUSE', 'DELIVERY_CONFIRM', 'DIFFICULTY_HANDOVER', 'DELIVERY_MARKER', 'REPLACE_PNO','SEAL', 'UNSEAL', 'STAFF_INFO_UPDATE_WEIGHT', 'STORE_KEEPER_UPDATE_WEIGHT', 'STORE_SORTER_UPDATE_WEIGHT', 'DISCARD_RETURN_BKK', 'DELIVERY_TRANSFER', 'PICKUP_RETURN_RECEIPT', 'FLASH_HOME_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SORTING_SCAN ', 'DELIVERY_PICKUP_STORE_SCAN', 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE', 'REFUND_CONFIRM', 'ACCEPT_PARCEL')
    ) ss on ss.pno = t1.pno and ss.rk = 1
left join ph_staging.order_info oi on oi.pno = t1.pno
left join ph_staging.sys_store ss2 on ss2.id = t1.ticket_pickup_store_id
left join ph_staging.sys_store ss3 on ss3.id = t1.dst_store_id
left join
    (
        select
            a1.pno
            ,count(a1.id) pho_count
            ,count(if(a1.tonghua = 0 and a1.xiangling > 0, a1.id, null)) xiangling_count
            ,count(if(a1.tonghua > 0, a1.id, null)) tonghua_num
            ,count(if(a1.tonghua > 8, a1.id, null)) 8_tonghua_num
        from
            (
                select
                    pr2.pno
                    ,pr2.id
                    ,json_extract(pr2.extra_value, '$.callDuration') tonghua
                    ,json_extract(pr2.extra_value, '$.diaboloDuration') xiangling
                from ph_staging.parcel_route pr2
                join t t1 on pr2.pno = t1.pno
                where
                    pr2.route_action = 'PHONE'
            ) a1
        group by 1
    ) pho on pho.pno = t1.pno;
;-- -. . -..- - / . -. - .-. -.--
with a as
(
    -- lazada
        select
            laz.pno
            ,laz.delievey_end_date end_date
            ,pi.returned
            ,pi.client_id
            ,pi.state
            ,pi.customary_pno
            ,pi.insure_declare_value
            ,pi.ticket_pickup_store_id
            ,pi.dst_store_id
            ,pi.interrupt_category
        from dwm.dwd_ex_ph_lazada_pno_period laz
        join ph_staging.parcel_info pi on pi.pno = laz.pno
        where
            pi.state not in (5,7,8,9)
            and laz.delievey_end_date < curdate()

        union all

        select
            sho.pno
            ,sho.end_date
            ,pi.returned
            ,pi.client_id
            ,pi.state
            ,pi.customary_pno
            ,pi.insure_declare_value
            ,pi.ticket_pickup_store_id
            ,pi.dst_store_id
            ,pi.interrupt_category
        from dwm.dwd_ex_shopee_pno_period sho
        join ph_staging.parcel_info pi on pi.pno = sho.pno
        where
            pi.state not in (5,7,8,9)
            and sho.end_date < curdate()
        -- tiktok
        union all

        select
            tik.pno
            ,tik.end_date
            ,pi.returned
            ,pi.client_id
            ,pi.state
            ,pi.customary_pno
            ,pi.insure_declare_value
            ,pi.ticket_pickup_store_id
            ,pi.dst_store_id
            ,pi.interrupt_category
        from dwm.dwd_ex_ph_tiktok_sla_detail tik
        join ph_staging.parcel_info pi on pi.pno = tik.pno
        where
            pi.state not in (5,7,8,9)
            and tik.end_date < curdate()

        union all
        -- shein
        select
            shein.pno
            ,shein.delievey_end_date
            ,pi.returned
            ,pi.client_id
            ,pi.state
            ,pi.customary_pno
            ,pi.insure_declare_value
            ,pi.ticket_pickup_store_id
            ,pi.dst_store_id
            ,pi.interrupt_category
        from dwm.dwd_ex_ph_shein_sla_detail shein
        join ph_staging.parcel_info pi on pi.pno = shein.pno
        where
            pi.state not in (5,7,8,9)
            and shein.delievey_end_date < curdate()
)
, t as
(
    select
        a1.*
    from
        (
            select
                pr.pno
                ,pr.routed_at
                ,pr.route_action
                ,pr.store_name
                ,pr.store_id
                ,t1.*
                ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
            from ph_staging.parcel_route pr
            join a t1 on t1.pno = pr.pno
            where
                pr.route_action in ('INVENTORY','RECEIVED' ,'RECEIVE_WAREHOUSE_SCAN', 'SORTING_SCAN', 'DELIVERY_TICKET_CREATION_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SHIPMENT_WAREHOUSE_SCAN', 'DETAIN_WAREHOUSE', 'DELIVERY_CONFIRM', 'DIFFICULTY_HANDOVER', 'DELIVERY_MARKER', 'REPLACE_PNO','SEAL', 'UNSEAL', 'STAFF_INFO_UPDATE_WEIGHT', 'STORE_KEEPER_UPDATE_WEIGHT', 'STORE_SORTER_UPDATE_WEIGHT', 'DISCARD_RETURN_BKK', 'DELIVERY_TRANSFER', 'PICKUP_RETURN_RECEIPT', 'FLASH_HOME_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SORTING_SCAN ', 'DELIVERY_PICKUP_STORE_SCAN', 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE', 'REFUND_CONFIRM', 'ACCEPT_PARCEL')
        ) a1
    where
        a1.rk = 1
)
select
    t1.pno
    ,if(t1.returned = 0, '正向', '退件') 包裹流向
    ,t1.client_id
    ,case t1.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,ss2.name 揽收网点
    ,ss3.name 目的地网点
    ,case a2.duty_result
        when 1 then '丢失'
        when 2 then '破损'
        when 3 then '超时效'
    end 判责类型
    ,a2.updated_at 判责日期
    ,case t1.route_action # 路由动作
         when 'ACCEPT_PARCEL' then '接件扫描'
         when 'ARRIVAL_GOODS_VAN_CHECK_SCAN' then '车货关联到港'
         when 'ARRIVAL_WAREHOUSE_SCAN' then '到件入仓扫描'
         when 'CANCEL_ARRIVAL_WAREHOUSE_SCAN' then '取消到件入仓扫描'
         when 'CANCEL_PARCEL' then '撤销包裹'
         when 'CANCEL_SHIPMENT_WAREHOUSE' then '取消发件出仓'
         when 'CHANGE_PARCEL_CANCEL' then '修改包裹为撤销'
         when 'CHANGE_PARCEL_CLOSE' then '修改包裹为异常关闭'
         when 'CHANGE_PARCEL_IN_TRANSIT' then '修改包裹为运输中'
         when 'CHANGE_PARCEL_INFO' then '修改包裹信息'
         when 'CHANGE_PARCEL_SIGNED' then '修改包裹为签收'
         when 'CLAIMS_CLOSE' then '理赔关闭'
         when 'CLAIMS_COMPLETE' then '理赔完成'
         when 'CLAIMS_CONTACT' then '已联系客户'
         when 'CLAIMS_TRANSFER_CS' then '转交总部cs处理'
         when 'CLOSE_ORDER' then '关闭订单'
         when 'CONTINUE_TRANSPORT' then '疑难件继续配送'
         when 'CREATE_WORK_ORDER' then '创建工单'
         when 'CUSTOMER_CHANGE_PARCEL_INFO' then '客户修改包裹信息'
         when 'CUSTOMER_OPERATING_RETURN' then '客户操作退回寄件人'
         when 'DELIVERY_CONFIRM' then '确认妥投'
         when 'DELIVERY_MARKER' then '派件标记'
         when 'DELIVERY_PICKUP_STORE_SCAN' then '自提取件扫描'
         when 'DELIVERY_TICKET_CREATION_SCAN' then '交接扫描'
         when 'DELIVERY_TRANSFER' then '派件转单'
         when 'DEPARTURE_GOODS_VAN_CK_SCAN' then '车货关联出港'
         when 'DETAIN_WAREHOUSE' then '货件留仓'
         when 'DIFFICULTY_FINISH_INDEMNITY' then '疑难件支付赔偿'
         when 'DIFFICULTY_HANDOVER' then '疑难件交接'
         when 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE' then '疑难件交接货件留仓'
         when 'DIFFICULTY_RE_TRANSIT' then '疑难件退回区域总部/重启运送'
         when 'DIFFICULTY_RETURN' then '疑难件退回寄件人'
         when 'DIFFICULTY_SEAL' then '集包异常'
         when 'DISCARD_RETURN_BKK' then '丢弃包裹的，换单后寄回BKK'
         when 'DISTRIBUTION_INVENTORY' then '分拨盘库'
         when 'DWS_WEIGHT_IMAGE' then 'DWS复秤照片'
         when 'EXCHANGE_PARCEL' then '换货'
         when 'FAKE_CANCEL_HANDLE' then '虚假撤销判责'
         when 'FLASH_HOME_SCAN' then 'FH交接扫描'
         when 'FORCE_TAKE_PHOTO' then '强制拍照路由'
         when 'HAVE_HAIR_SCAN_NO_TO' then '有发无到'
         when 'HURRY_PARCEL' then '催单'
         when 'INCOMING_CALL' then '来电接听'
         when 'INTERRUPT_PARCEL_AND_RETURN' then '中断运输并退回'
         when 'INVENTORY' then '盘库'
         when 'LOSE_PARCEL_TEAM_OPERATION' then '丢失件团队处理'
         when 'MANUAL_REMARK' then '添加备注'
         when 'MISS_PICKUP_HANDLE' then '漏包裹揽收判责'
         when 'MISSING_PARCEL_SCAN' then '丢失件包裹操作'
         when 'NOTICE_LOST_PARTS_TEAM' then '已通知丢失件团队'
         when 'PARCEL_HEADLESS_CLAIMED' then '无头件包裹已认领'
         when 'PARCEL_HEADLESS_PRINTED' then '无头件包裹已打单'
         when 'PENDING_RETURN' then '待退件'
         when 'PHONE' then '电话联系'
         when 'PICK_UP_STORE' then '待自提取件'
         when 'PICKUP_RETURN_RECEIPT' then '签回单揽收'
         when 'PRINTING' then '打印面单'
         when 'QAQC_OPERATION' then 'QAQC判责'
         when 'RECEIVE_WAREHOUSE_SCAN' then '收件入仓'
         when 'RECEIVED' then '已揽收,初始化动作，实际情况并没有作用'
         when 'REFUND_CONFIRM' then '退件妥投'
         when 'REPAIRED' then '上报问题修复路由'
         when 'REPLACE_PNO' then '换单'
         when 'REPLY_WORK_ORDER' then '回复工单'
         when 'REVISION_TIME' then '改约时间'
         when 'SEAL' then '集包'
         when 'SEAL_NUMBER_CHANGE' then '集包件数变化'
         when 'SHIPMENT_WAREHOUSE_SCAN' then '发件出仓扫描'
         when 'SORTER_WEIGHT_IMAGE' then '分拣机复秤照片'
         when 'SORTING_SCAN' then '分拣扫描'
         when 'STAFF_INFO_UPDATE_WEIGHT' then '快递员修改重量'
         when 'STORE_KEEPER_UPDATE_WEIGHT' then '仓管员复秤'
         when 'STORE_SORTER_UPDATE_WEIGHT' then '分拣机复秤'
         when 'SYSTEM_AUTO_RETURN' then '系统自动退件'
         when 'TAKE_PHOTO' then '异常打单拍照'
         when 'THIRD_EXPRESS_ROUTE' then '第三方公司路由'
         when 'THIRD_PARTY_REASON_DETAIN' then '第三方原因滞留'
         when 'TICKET_WEIGHT_IMAGE' then '揽收称重照片'
         when 'TRANSFER_LOST_PARTS_TEAM' then '已转交丢失件团队'
         when 'TRANSFER_QAQC' then '转交QAQC处理'
         when 'UNSEAL' then '拆包'
         when 'UNSEAL_NO_PARCEL' then '上报包裹不在集包里'
         when 'UNSEAL_NOT_SCANNED' then '集包已拆包，本包裹未被扫描'
         when 'VEHICLE_ACCIDENT_REG' then '车辆车祸登记'
         when 'VEHICLE_ACCIDENT_REGISTRATION' then '车辆车祸登记'
         when 'VEHICLE_WET_DAMAGE_REG' then '车辆湿损登记'
         when 'VEHICLE_WET_DAMAGE_REGISTRATION' then '车辆湿损登记'
    end as 最后一次有效路由操作
    ,t1.store_name 最后一次有效路由网点
    ,convert_tz(ss.routed_at, '+00:00', '+08:00') 到达网点时间
    ,date(convert_tz(t1.routed_at, '+00:00', '+08:00')) 最后一次有效路由时间
    ,timestampdiff(hour, convert_tz(t1.routed_at, '+00:00', '+08:00'), now()) 最近一次有效路由至今小时数
    ,if(t1.returned = 0, dai.delivery_attempt_num, dai.returned_delivery_attempt_num) 尝试派送次数
    ,if(t1.interrupt_category = 3, '是', '否') 是否有待退件标记
#     ,case
#         when t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139') and curdate() > t1.end_date then '是'
#         when t1.client_id in ('AA0131', 'AA0132') and curdate() > tik.end_date then '是'
#         when t1.client_id in ('AA0090', 'AA0128','AA0089') and curdate() > sho.end_date then '是'
#         when t1.client_id in ('AA0149', 'AA0148') and curdate() > she.delievey_end_date then '是'
#         else null
#     end 是否已经超时
    ,case
        when t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139') and curdate() > t1.end_date then datediff(curdate(), t1.end_date)
        when t1.client_id in ('AA0131', 'AA0132') and curdate() > t1.end_date then datediff(curdate(), t1.end_date)
        when t1.client_id in ('AA0090', 'AA0128','AA0089') and curdate() > t1.end_date then datediff(curdate(), t1.end_date)
        when t1.client_id in ('AA0149', 'AA0148') and curdate() > t1.end_date then datediff(curdate(), t1.end_date)
        else null
    end  超时天数
    ,if(t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139'), oi.insure_declare_value/100, oi.cogs_amount/100) cogs金额
    ,pho.pho_count 打电话次数
    ,pho.xiangling_count 响铃未通话次数
    ,pho.tonghua_num 有效通话次数
    ,pho.8_tonghua_num 大于8秒通话次数
from t t1
left join
    (
        select
            plt.pno
            ,plt.updated_at
            ,plt.duty_result
        from ph_bi.parcel_lose_task plt
        join t t1 on t1.pno = plt.pno
        where
            plt.state = 6
    ) a2 on a2.pno = t1.pno
left join ph_staging.delivery_attempt_info dai on dai.pno = if(t1.returned = 0, t1.pno, t1.customary_pno)
left join
    (
        select
            pr.routed_at
            ,pr.pno
            ,row_number() over (partition by pr.pno order by pr.routed_at ) rk
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno and pr.store_id = t1.store_id
        where
            pr.route_action in ('INVENTORY','RECEIVED' ,'RECEIVE_WAREHOUSE_SCAN', 'SORTING_SCAN', 'DELIVERY_TICKET_CREATION_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SHIPMENT_WAREHOUSE_SCAN', 'DETAIN_WAREHOUSE', 'DELIVERY_CONFIRM', 'DIFFICULTY_HANDOVER', 'DELIVERY_MARKER', 'REPLACE_PNO','SEAL', 'UNSEAL', 'STAFF_INFO_UPDATE_WEIGHT', 'STORE_KEEPER_UPDATE_WEIGHT', 'STORE_SORTER_UPDATE_WEIGHT', 'DISCARD_RETURN_BKK', 'DELIVERY_TRANSFER', 'PICKUP_RETURN_RECEIPT', 'FLASH_HOME_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SORTING_SCAN ', 'DELIVERY_PICKUP_STORE_SCAN', 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE', 'REFUND_CONFIRM', 'ACCEPT_PARCEL')
    ) ss on ss.pno = t1.pno and ss.rk = 1
left join ph_staging.order_info oi on oi.pno = t1.pno
left join ph_staging.sys_store ss2 on ss2.id = t1.ticket_pickup_store_id
left join ph_staging.sys_store ss3 on ss3.id = t1.dst_store_id
left join
    (
        select
            a1.pno
            ,count(a1.id) pho_count
            ,count(if(a1.tonghua = 0 and a1.xiangling > 0, a1.id, null)) xiangling_count
            ,count(if(a1.tonghua > 0, a1.id, null)) tonghua_num
            ,count(if(a1.tonghua > 8, a1.id, null)) 8_tonghua_num
        from
            (
                select
                    pr2.pno
                    ,pr2.id
                    ,json_extract(pr2.extra_value, '$.callDuration') tonghua
                    ,json_extract(pr2.extra_value, '$.diaboloDuration') xiangling
                from ph_staging.parcel_route pr2
                join t t1 on pr2.pno = t1.pno
                where
                    pr2.route_action = 'PHONE'
            ) a1
        group by 1
    ) pho on pho.pno = t1.pno;
;-- -. . -..- - / . -. - .-. -.--
select
    a.leave_date
    ,count(distinct a.staff_info_id) 离职快递员人数
    ,count(distinct if(a.mw_count > 0, a.staff_info_id, null))/count(distinct a.staff_info_id) 有警告信占比
    ,count(distinct if(a.mw_count = 1, a.staff_info_id, null))/count(distinct a.staff_info_id) 1封警告信占比
    ,count(distinct if(a.mw_count = 2, a.staff_info_id, null))/count(distinct a.staff_info_id) 2封警告信占比
    ,count(distinct if(a.mw_count = 3, a.staff_info_id, null))/count(distinct a.staff_info_id) 3封警告信占比
    ,count(distinct if(a.mw_count > 3, a.staff_info_id, null))/count(distinct a.staff_info_id) 3封以上警告信占比
from
    (
        select
            hsi.leave_date
            ,hsi.staff_info_id
        #     ,count(distinct hsi.staff_info_id) 离职快递员人数
        #     ,count(distinct if(mw.staff_info_id is not null, hsi.staff_info_id, null)) 有警告信占比
            ,count(mw.id) mw_count
        from ph_bi.hr_staff_info hsi
        left join ph_backyard.message_warning mw on mw.staff_info_id = hsi.staff_info_id and mw.is_delete = 0
        where
            hsi.state = 2
            and hsi.job_title in (13,110,1000)
            and hsi.leave_date >= '2023-09-01'
        group by 1,2
    ) a
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
            laz.pno
            ,laz.delievey_end_date end_date
            ,pi.returned
            ,pi.client_id
            ,pi.state
            ,pi.customary_pno
            ,pi.insure_declare_value
            ,pi.ticket_pickup_store_id
            ,pi.dst_store_id
            ,pi.interrupt_category
        from dwm.dwd_ex_ph_lazada_pno_period laz
        join ph_staging.parcel_info pi on pi.pno = laz.pno
        where
            pi.state not in (5,7,8,9)
            and laz.delievey_end_date < curdate()

        union all

        select
            sho.pno
            ,sho.end_date
            ,pi.returned
            ,pi.client_id
            ,pi.state
            ,pi.customary_pno
            ,pi.insure_declare_value
            ,pi.ticket_pickup_store_id
            ,pi.dst_store_id
            ,pi.interrupt_category
        from dwm.dwd_ex_shopee_pno_period sho
        join ph_staging.parcel_info pi on pi.pno = sho.pno
        where
            pi.state not in (5,7,8,9)
            and sho.end_date < curdate()
        -- tiktok
        union all

        select
            tik.pno
            ,tik.end_date
            ,pi.returned
            ,pi.client_id
            ,pi.state
            ,pi.customary_pno
            ,pi.insure_declare_value
            ,pi.ticket_pickup_store_id
            ,pi.dst_store_id
            ,pi.interrupt_category
        from dwm.dwd_ex_ph_tiktok_sla_detail tik
        join ph_staging.parcel_info pi on pi.pno = tik.pno
        where
            pi.state not in (5,7,8,9)
            and tik.end_date < curdate()

        union all
        -- shein
        select
            shein.pno
            ,shein.delievey_end_date
            ,pi.returned
            ,pi.client_id
            ,pi.state
            ,pi.customary_pno
            ,pi.insure_declare_value
            ,pi.ticket_pickup_store_id
            ,pi.dst_store_id
            ,pi.interrupt_category
        from dwm.dwd_ex_ph_shein_sla_detail shein
        join ph_staging.parcel_info pi on pi.pno = shein.pno
        where
            pi.state not in (5,7,8,9)
            and shein.delievey_end_date < curdate();
;-- -. . -..- - / . -. - .-. -.--
with a as
(
    -- lazada
        select
            laz.pno
            ,laz.delievey_end_date end_date
            ,pi.returned
            ,pi.client_id
            ,pi.state
            ,pi.customary_pno
            ,pi.insure_declare_value
            ,pi.ticket_pickup_store_id
            ,pi.dst_store_id
            ,pi.interrupt_category
        from dwm.dwd_ex_ph_lazada_pno_period laz
        join ph_staging.parcel_info pi on pi.pno = laz.pno
        where
            pi.state not in (5,7,8,9)
            and laz.delievey_end_date < curdate()

        union all

        select
            sho.pno
            ,sho.end_date
            ,pi.returned
            ,pi.client_id
            ,pi.state
            ,pi.customary_pno
            ,pi.insure_declare_value
            ,pi.ticket_pickup_store_id
            ,pi.dst_store_id
            ,pi.interrupt_category
        from dwm.dwd_ex_shopee_pno_period sho
        join ph_staging.parcel_info pi on pi.pno = sho.pno
        where
            pi.state not in (5,7,8,9)
            and sho.end_date < curdate()
        -- tiktok
        union all

        select
            tik.pno
            ,tik.end_date
            ,pi.returned
            ,pi.client_id
            ,pi.state
            ,pi.customary_pno
            ,pi.insure_declare_value
            ,pi.ticket_pickup_store_id
            ,pi.dst_store_id
            ,pi.interrupt_category
        from dwm.dwd_ex_ph_tiktok_sla_detail tik
        join ph_staging.parcel_info pi on pi.pno = tik.pno
        where
            pi.state not in (5,7,8,9)
            and tik.end_date < curdate()

        union all
        -- shein
        select
            shein.pno
            ,shein.delievey_end_date
            ,pi.returned
            ,pi.client_id
            ,pi.state
            ,pi.customary_pno
            ,pi.insure_declare_value
            ,pi.ticket_pickup_store_id
            ,pi.dst_store_id
            ,pi.interrupt_category
        from dwm.dwd_ex_ph_shein_sla_detail shein
        join ph_staging.parcel_info pi on pi.pno = shein.pno
        where
            pi.state not in (5,7,8,9)
            and shein.delievey_end_date < curdate()
)
, t as
(
    select
        a1.*
    from
        (
            select
                pr.routed_at
                ,pr.route_action
                ,pr.store_name
                ,pr.store_id
                ,t1.*
                ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
            from ph_staging.parcel_route pr
            join a t1 on t1.pno = pr.pno
            where
                pr.route_action in ('INVENTORY','RECEIVED' ,'RECEIVE_WAREHOUSE_SCAN', 'SORTING_SCAN', 'DELIVERY_TICKET_CREATION_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SHIPMENT_WAREHOUSE_SCAN', 'DETAIN_WAREHOUSE', 'DELIVERY_CONFIRM', 'DIFFICULTY_HANDOVER', 'DELIVERY_MARKER', 'REPLACE_PNO','SEAL', 'UNSEAL', 'STAFF_INFO_UPDATE_WEIGHT', 'STORE_KEEPER_UPDATE_WEIGHT', 'STORE_SORTER_UPDATE_WEIGHT', 'DISCARD_RETURN_BKK', 'DELIVERY_TRANSFER', 'PICKUP_RETURN_RECEIPT', 'FLASH_HOME_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SORTING_SCAN ', 'DELIVERY_PICKUP_STORE_SCAN', 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE', 'REFUND_CONFIRM', 'ACCEPT_PARCEL')
        ) a1
    where
        a1.rk = 1
)
select
    t1.pno
    ,if(t1.returned = 0, '正向', '退件') 包裹流向
    ,t1.client_id
    ,case t1.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,ss2.name 揽收网点
    ,ss3.name 目的地网点
    ,case a2.duty_result
        when 1 then '丢失'
        when 2 then '破损'
        when 3 then '超时效'
    end 判责类型
    ,a2.updated_at 判责日期
    ,case t1.route_action # 路由动作
         when 'ACCEPT_PARCEL' then '接件扫描'
         when 'ARRIVAL_GOODS_VAN_CHECK_SCAN' then '车货关联到港'
         when 'ARRIVAL_WAREHOUSE_SCAN' then '到件入仓扫描'
         when 'CANCEL_ARRIVAL_WAREHOUSE_SCAN' then '取消到件入仓扫描'
         when 'CANCEL_PARCEL' then '撤销包裹'
         when 'CANCEL_SHIPMENT_WAREHOUSE' then '取消发件出仓'
         when 'CHANGE_PARCEL_CANCEL' then '修改包裹为撤销'
         when 'CHANGE_PARCEL_CLOSE' then '修改包裹为异常关闭'
         when 'CHANGE_PARCEL_IN_TRANSIT' then '修改包裹为运输中'
         when 'CHANGE_PARCEL_INFO' then '修改包裹信息'
         when 'CHANGE_PARCEL_SIGNED' then '修改包裹为签收'
         when 'CLAIMS_CLOSE' then '理赔关闭'
         when 'CLAIMS_COMPLETE' then '理赔完成'
         when 'CLAIMS_CONTACT' then '已联系客户'
         when 'CLAIMS_TRANSFER_CS' then '转交总部cs处理'
         when 'CLOSE_ORDER' then '关闭订单'
         when 'CONTINUE_TRANSPORT' then '疑难件继续配送'
         when 'CREATE_WORK_ORDER' then '创建工单'
         when 'CUSTOMER_CHANGE_PARCEL_INFO' then '客户修改包裹信息'
         when 'CUSTOMER_OPERATING_RETURN' then '客户操作退回寄件人'
         when 'DELIVERY_CONFIRM' then '确认妥投'
         when 'DELIVERY_MARKER' then '派件标记'
         when 'DELIVERY_PICKUP_STORE_SCAN' then '自提取件扫描'
         when 'DELIVERY_TICKET_CREATION_SCAN' then '交接扫描'
         when 'DELIVERY_TRANSFER' then '派件转单'
         when 'DEPARTURE_GOODS_VAN_CK_SCAN' then '车货关联出港'
         when 'DETAIN_WAREHOUSE' then '货件留仓'
         when 'DIFFICULTY_FINISH_INDEMNITY' then '疑难件支付赔偿'
         when 'DIFFICULTY_HANDOVER' then '疑难件交接'
         when 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE' then '疑难件交接货件留仓'
         when 'DIFFICULTY_RE_TRANSIT' then '疑难件退回区域总部/重启运送'
         when 'DIFFICULTY_RETURN' then '疑难件退回寄件人'
         when 'DIFFICULTY_SEAL' then '集包异常'
         when 'DISCARD_RETURN_BKK' then '丢弃包裹的，换单后寄回BKK'
         when 'DISTRIBUTION_INVENTORY' then '分拨盘库'
         when 'DWS_WEIGHT_IMAGE' then 'DWS复秤照片'
         when 'EXCHANGE_PARCEL' then '换货'
         when 'FAKE_CANCEL_HANDLE' then '虚假撤销判责'
         when 'FLASH_HOME_SCAN' then 'FH交接扫描'
         when 'FORCE_TAKE_PHOTO' then '强制拍照路由'
         when 'HAVE_HAIR_SCAN_NO_TO' then '有发无到'
         when 'HURRY_PARCEL' then '催单'
         when 'INCOMING_CALL' then '来电接听'
         when 'INTERRUPT_PARCEL_AND_RETURN' then '中断运输并退回'
         when 'INVENTORY' then '盘库'
         when 'LOSE_PARCEL_TEAM_OPERATION' then '丢失件团队处理'
         when 'MANUAL_REMARK' then '添加备注'
         when 'MISS_PICKUP_HANDLE' then '漏包裹揽收判责'
         when 'MISSING_PARCEL_SCAN' then '丢失件包裹操作'
         when 'NOTICE_LOST_PARTS_TEAM' then '已通知丢失件团队'
         when 'PARCEL_HEADLESS_CLAIMED' then '无头件包裹已认领'
         when 'PARCEL_HEADLESS_PRINTED' then '无头件包裹已打单'
         when 'PENDING_RETURN' then '待退件'
         when 'PHONE' then '电话联系'
         when 'PICK_UP_STORE' then '待自提取件'
         when 'PICKUP_RETURN_RECEIPT' then '签回单揽收'
         when 'PRINTING' then '打印面单'
         when 'QAQC_OPERATION' then 'QAQC判责'
         when 'RECEIVE_WAREHOUSE_SCAN' then '收件入仓'
         when 'RECEIVED' then '已揽收,初始化动作，实际情况并没有作用'
         when 'REFUND_CONFIRM' then '退件妥投'
         when 'REPAIRED' then '上报问题修复路由'
         when 'REPLACE_PNO' then '换单'
         when 'REPLY_WORK_ORDER' then '回复工单'
         when 'REVISION_TIME' then '改约时间'
         when 'SEAL' then '集包'
         when 'SEAL_NUMBER_CHANGE' then '集包件数变化'
         when 'SHIPMENT_WAREHOUSE_SCAN' then '发件出仓扫描'
         when 'SORTER_WEIGHT_IMAGE' then '分拣机复秤照片'
         when 'SORTING_SCAN' then '分拣扫描'
         when 'STAFF_INFO_UPDATE_WEIGHT' then '快递员修改重量'
         when 'STORE_KEEPER_UPDATE_WEIGHT' then '仓管员复秤'
         when 'STORE_SORTER_UPDATE_WEIGHT' then '分拣机复秤'
         when 'SYSTEM_AUTO_RETURN' then '系统自动退件'
         when 'TAKE_PHOTO' then '异常打单拍照'
         when 'THIRD_EXPRESS_ROUTE' then '第三方公司路由'
         when 'THIRD_PARTY_REASON_DETAIN' then '第三方原因滞留'
         when 'TICKET_WEIGHT_IMAGE' then '揽收称重照片'
         when 'TRANSFER_LOST_PARTS_TEAM' then '已转交丢失件团队'
         when 'TRANSFER_QAQC' then '转交QAQC处理'
         when 'UNSEAL' then '拆包'
         when 'UNSEAL_NO_PARCEL' then '上报包裹不在集包里'
         when 'UNSEAL_NOT_SCANNED' then '集包已拆包，本包裹未被扫描'
         when 'VEHICLE_ACCIDENT_REG' then '车辆车祸登记'
         when 'VEHICLE_ACCIDENT_REGISTRATION' then '车辆车祸登记'
         when 'VEHICLE_WET_DAMAGE_REG' then '车辆湿损登记'
         when 'VEHICLE_WET_DAMAGE_REGISTRATION' then '车辆湿损登记'
    end as 最后一次有效路由操作
    ,t1.store_name 最后一次有效路由网点
    ,convert_tz(ss.routed_at, '+00:00', '+08:00') 到达网点时间
    ,date(convert_tz(t1.routed_at, '+00:00', '+08:00')) 最后一次有效路由时间
    ,timestampdiff(hour, convert_tz(t1.routed_at, '+00:00', '+08:00'), now()) 最近一次有效路由至今小时数
    ,if(t1.returned = 0, dai.delivery_attempt_num, dai.returned_delivery_attempt_num) 尝试派送次数
    ,if(t1.interrupt_category = 3, '是', '否') 是否有待退件标记
#     ,case
#         when t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139') and curdate() > t1.end_date then '是'
#         when t1.client_id in ('AA0131', 'AA0132') and curdate() > tik.end_date then '是'
#         when t1.client_id in ('AA0090', 'AA0128','AA0089') and curdate() > sho.end_date then '是'
#         when t1.client_id in ('AA0149', 'AA0148') and curdate() > she.delievey_end_date then '是'
#         else null
#     end 是否已经超时
    ,case
        when t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139') and curdate() > t1.end_date then datediff(curdate(), t1.end_date)
        when t1.client_id in ('AA0131', 'AA0132') and curdate() > t1.end_date then datediff(curdate(), t1.end_date)
        when t1.client_id in ('AA0090', 'AA0128','AA0089') and curdate() > t1.end_date then datediff(curdate(), t1.end_date)
        when t1.client_id in ('AA0149', 'AA0148') and curdate() > t1.end_date then datediff(curdate(), t1.end_date)
        else null
    end  超时天数
    ,if(t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139'), oi.insure_declare_value/100, oi.cogs_amount/100) cogs金额
    ,pho.pho_count 打电话次数
    ,pho.xiangling_count 响铃未通话次数
    ,pho.tonghua_num 有效通话次数
    ,pho.8_tonghua_num 大于8秒通话次数
from t t1
left join
    (
        select
            plt.pno
            ,plt.updated_at
            ,plt.duty_result
        from ph_bi.parcel_lose_task plt
        join t t1 on t1.pno = plt.pno
        where
            plt.state = 6
    ) a2 on a2.pno = t1.pno
left join ph_staging.delivery_attempt_info dai on dai.pno = if(t1.returned = 0, t1.pno, t1.customary_pno)
left join
    (
        select
            pr.routed_at
            ,pr.pno
            ,row_number() over (partition by pr.pno order by pr.routed_at ) rk
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno and pr.store_id = t1.store_id
        where
            pr.route_action in ('INVENTORY','RECEIVED' ,'RECEIVE_WAREHOUSE_SCAN', 'SORTING_SCAN', 'DELIVERY_TICKET_CREATION_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SHIPMENT_WAREHOUSE_SCAN', 'DETAIN_WAREHOUSE', 'DELIVERY_CONFIRM', 'DIFFICULTY_HANDOVER', 'DELIVERY_MARKER', 'REPLACE_PNO','SEAL', 'UNSEAL', 'STAFF_INFO_UPDATE_WEIGHT', 'STORE_KEEPER_UPDATE_WEIGHT', 'STORE_SORTER_UPDATE_WEIGHT', 'DISCARD_RETURN_BKK', 'DELIVERY_TRANSFER', 'PICKUP_RETURN_RECEIPT', 'FLASH_HOME_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SORTING_SCAN ', 'DELIVERY_PICKUP_STORE_SCAN', 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE', 'REFUND_CONFIRM', 'ACCEPT_PARCEL')
    ) ss on ss.pno = t1.pno and ss.rk = 1
left join ph_staging.order_info oi on oi.pno = t1.pno
left join ph_staging.sys_store ss2 on ss2.id = t1.ticket_pickup_store_id
left join ph_staging.sys_store ss3 on ss3.id = t1.dst_store_id
left join
    (
        select
            a1.pno
            ,count(a1.id) pho_count
            ,count(if(a1.tonghua = 0 and a1.xiangling > 0, a1.id, null)) xiangling_count
            ,count(if(a1.tonghua > 0, a1.id, null)) tonghua_num
            ,count(if(a1.tonghua > 8, a1.id, null)) 8_tonghua_num
        from
            (
                select
                    pr2.pno
                    ,pr2.id
                    ,json_extract(pr2.extra_value, '$.callDuration') tonghua
                    ,json_extract(pr2.extra_value, '$.diaboloDuration') xiangling
                from ph_staging.parcel_route pr2
                join t t1 on pr2.pno = t1.pno
                where
                    pr2.route_action = 'PHONE'
            ) a1
        group by 1
    ) pho on pho.pno = t1.pno;
;-- -. . -..- - / . -. - .-. -.--
with a as
(
    -- lazada
        select
            laz.pno
            ,laz.delievey_end_date end_date
            ,pi.returned
            ,pi.client_id
            ,pi.state
            ,pi.customary_pno
            ,pi.insure_declare_value
            ,pi.ticket_pickup_store_id
            ,pi.dst_store_id
            ,pi.interrupt_category
        from dwm.dwd_ex_ph_lazada_pno_period laz
        join ph_staging.parcel_info pi on pi.pno = laz.pno
        where
            pi.state not in (5,7,8,9)
            and laz.delievey_end_date < curdate()

        union all

        select
            sho.pno
            ,sho.end_date
            ,pi.returned
            ,pi.client_id
            ,pi.state
            ,pi.customary_pno
            ,pi.insure_declare_value
            ,pi.ticket_pickup_store_id
            ,pi.dst_store_id
            ,pi.interrupt_category
        from dwm.dwd_ex_shopee_pno_period sho
        join ph_staging.parcel_info pi on pi.pno = sho.pno
        where
            pi.state not in (5,7,8,9)
            and sho.end_date < curdate()
        -- tiktok
        union all

        select
            tik.pno
            ,tik.end_date
            ,pi.returned
            ,pi.client_id
            ,pi.state
            ,pi.customary_pno
            ,pi.insure_declare_value
            ,pi.ticket_pickup_store_id
            ,pi.dst_store_id
            ,pi.interrupt_category
        from dwm.dwd_ex_ph_tiktok_sla_detail tik
        join ph_staging.parcel_info pi on pi.pno = tik.pno
        where
            pi.state not in (5,7,8,9)
            and tik.end_date < curdate()

        union all
        -- shein
        select
            shein.pno
            ,shein.delievey_end_date
            ,pi.returned
            ,pi.client_id
            ,pi.state
            ,pi.customary_pno
            ,pi.insure_declare_value
            ,pi.ticket_pickup_store_id
            ,pi.dst_store_id
            ,pi.interrupt_category
        from dwm.dwd_ex_ph_shein_sla_detail shein
        join ph_staging.parcel_info pi on pi.pno = shein.pno
        where
            pi.state not in (5,7,8,9)
            and shein.delievey_end_date < curdate()
)
, t as
(
    select
        a1.*
    from
        (
            select
                pr.routed_at
                ,pr.route_action
                ,pr.store_name
                ,pr.store_id
                ,t1.*
                ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
            from ph_staging.parcel_route pr
            join a t1 on t1.pno = pr.pno
            where
                pr.routed_at > '2023-03-01'
                and pr.route_action in ('INVENTORY','RECEIVED' ,'RECEIVE_WAREHOUSE_SCAN', 'SORTING_SCAN', 'DELIVERY_TICKET_CREATION_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SHIPMENT_WAREHOUSE_SCAN', 'DETAIN_WAREHOUSE', 'DELIVERY_CONFIRM', 'DIFFICULTY_HANDOVER', 'DELIVERY_MARKER', 'REPLACE_PNO','SEAL', 'UNSEAL', 'STAFF_INFO_UPDATE_WEIGHT', 'STORE_KEEPER_UPDATE_WEIGHT', 'STORE_SORTER_UPDATE_WEIGHT', 'DISCARD_RETURN_BKK', 'DELIVERY_TRANSFER', 'PICKUP_RETURN_RECEIPT', 'FLASH_HOME_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SORTING_SCAN ', 'DELIVERY_PICKUP_STORE_SCAN', 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE', 'REFUND_CONFIRM', 'ACCEPT_PARCEL')
        ) a1
    where
        a1.rk = 1
)
select
    t1.pno
    ,if(t1.returned = 0, '正向', '退件') 包裹流向
    ,t1.client_id
    ,case t1.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,ss2.name 揽收网点
    ,ss3.name 目的地网点
    ,case a2.duty_result
        when 1 then '丢失'
        when 2 then '破损'
        when 3 then '超时效'
    end 判责类型
    ,a2.updated_at 判责日期
    ,case t1.route_action # 路由动作
         when 'ACCEPT_PARCEL' then '接件扫描'
         when 'ARRIVAL_GOODS_VAN_CHECK_SCAN' then '车货关联到港'
         when 'ARRIVAL_WAREHOUSE_SCAN' then '到件入仓扫描'
         when 'CANCEL_ARRIVAL_WAREHOUSE_SCAN' then '取消到件入仓扫描'
         when 'CANCEL_PARCEL' then '撤销包裹'
         when 'CANCEL_SHIPMENT_WAREHOUSE' then '取消发件出仓'
         when 'CHANGE_PARCEL_CANCEL' then '修改包裹为撤销'
         when 'CHANGE_PARCEL_CLOSE' then '修改包裹为异常关闭'
         when 'CHANGE_PARCEL_IN_TRANSIT' then '修改包裹为运输中'
         when 'CHANGE_PARCEL_INFO' then '修改包裹信息'
         when 'CHANGE_PARCEL_SIGNED' then '修改包裹为签收'
         when 'CLAIMS_CLOSE' then '理赔关闭'
         when 'CLAIMS_COMPLETE' then '理赔完成'
         when 'CLAIMS_CONTACT' then '已联系客户'
         when 'CLAIMS_TRANSFER_CS' then '转交总部cs处理'
         when 'CLOSE_ORDER' then '关闭订单'
         when 'CONTINUE_TRANSPORT' then '疑难件继续配送'
         when 'CREATE_WORK_ORDER' then '创建工单'
         when 'CUSTOMER_CHANGE_PARCEL_INFO' then '客户修改包裹信息'
         when 'CUSTOMER_OPERATING_RETURN' then '客户操作退回寄件人'
         when 'DELIVERY_CONFIRM' then '确认妥投'
         when 'DELIVERY_MARKER' then '派件标记'
         when 'DELIVERY_PICKUP_STORE_SCAN' then '自提取件扫描'
         when 'DELIVERY_TICKET_CREATION_SCAN' then '交接扫描'
         when 'DELIVERY_TRANSFER' then '派件转单'
         when 'DEPARTURE_GOODS_VAN_CK_SCAN' then '车货关联出港'
         when 'DETAIN_WAREHOUSE' then '货件留仓'
         when 'DIFFICULTY_FINISH_INDEMNITY' then '疑难件支付赔偿'
         when 'DIFFICULTY_HANDOVER' then '疑难件交接'
         when 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE' then '疑难件交接货件留仓'
         when 'DIFFICULTY_RE_TRANSIT' then '疑难件退回区域总部/重启运送'
         when 'DIFFICULTY_RETURN' then '疑难件退回寄件人'
         when 'DIFFICULTY_SEAL' then '集包异常'
         when 'DISCARD_RETURN_BKK' then '丢弃包裹的，换单后寄回BKK'
         when 'DISTRIBUTION_INVENTORY' then '分拨盘库'
         when 'DWS_WEIGHT_IMAGE' then 'DWS复秤照片'
         when 'EXCHANGE_PARCEL' then '换货'
         when 'FAKE_CANCEL_HANDLE' then '虚假撤销判责'
         when 'FLASH_HOME_SCAN' then 'FH交接扫描'
         when 'FORCE_TAKE_PHOTO' then '强制拍照路由'
         when 'HAVE_HAIR_SCAN_NO_TO' then '有发无到'
         when 'HURRY_PARCEL' then '催单'
         when 'INCOMING_CALL' then '来电接听'
         when 'INTERRUPT_PARCEL_AND_RETURN' then '中断运输并退回'
         when 'INVENTORY' then '盘库'
         when 'LOSE_PARCEL_TEAM_OPERATION' then '丢失件团队处理'
         when 'MANUAL_REMARK' then '添加备注'
         when 'MISS_PICKUP_HANDLE' then '漏包裹揽收判责'
         when 'MISSING_PARCEL_SCAN' then '丢失件包裹操作'
         when 'NOTICE_LOST_PARTS_TEAM' then '已通知丢失件团队'
         when 'PARCEL_HEADLESS_CLAIMED' then '无头件包裹已认领'
         when 'PARCEL_HEADLESS_PRINTED' then '无头件包裹已打单'
         when 'PENDING_RETURN' then '待退件'
         when 'PHONE' then '电话联系'
         when 'PICK_UP_STORE' then '待自提取件'
         when 'PICKUP_RETURN_RECEIPT' then '签回单揽收'
         when 'PRINTING' then '打印面单'
         when 'QAQC_OPERATION' then 'QAQC判责'
         when 'RECEIVE_WAREHOUSE_SCAN' then '收件入仓'
         when 'RECEIVED' then '已揽收,初始化动作，实际情况并没有作用'
         when 'REFUND_CONFIRM' then '退件妥投'
         when 'REPAIRED' then '上报问题修复路由'
         when 'REPLACE_PNO' then '换单'
         when 'REPLY_WORK_ORDER' then '回复工单'
         when 'REVISION_TIME' then '改约时间'
         when 'SEAL' then '集包'
         when 'SEAL_NUMBER_CHANGE' then '集包件数变化'
         when 'SHIPMENT_WAREHOUSE_SCAN' then '发件出仓扫描'
         when 'SORTER_WEIGHT_IMAGE' then '分拣机复秤照片'
         when 'SORTING_SCAN' then '分拣扫描'
         when 'STAFF_INFO_UPDATE_WEIGHT' then '快递员修改重量'
         when 'STORE_KEEPER_UPDATE_WEIGHT' then '仓管员复秤'
         when 'STORE_SORTER_UPDATE_WEIGHT' then '分拣机复秤'
         when 'SYSTEM_AUTO_RETURN' then '系统自动退件'
         when 'TAKE_PHOTO' then '异常打单拍照'
         when 'THIRD_EXPRESS_ROUTE' then '第三方公司路由'
         when 'THIRD_PARTY_REASON_DETAIN' then '第三方原因滞留'
         when 'TICKET_WEIGHT_IMAGE' then '揽收称重照片'
         when 'TRANSFER_LOST_PARTS_TEAM' then '已转交丢失件团队'
         when 'TRANSFER_QAQC' then '转交QAQC处理'
         when 'UNSEAL' then '拆包'
         when 'UNSEAL_NO_PARCEL' then '上报包裹不在集包里'
         when 'UNSEAL_NOT_SCANNED' then '集包已拆包，本包裹未被扫描'
         when 'VEHICLE_ACCIDENT_REG' then '车辆车祸登记'
         when 'VEHICLE_ACCIDENT_REGISTRATION' then '车辆车祸登记'
         when 'VEHICLE_WET_DAMAGE_REG' then '车辆湿损登记'
         when 'VEHICLE_WET_DAMAGE_REGISTRATION' then '车辆湿损登记'
    end as 最后一次有效路由操作
    ,t1.store_name 最后一次有效路由网点
    ,convert_tz(ss.routed_at, '+00:00', '+08:00') 到达网点时间
    ,date(convert_tz(t1.routed_at, '+00:00', '+08:00')) 最后一次有效路由时间
    ,timestampdiff(hour, convert_tz(t1.routed_at, '+00:00', '+08:00'), now()) 最近一次有效路由至今小时数
    ,if(t1.returned = 0, dai.delivery_attempt_num, dai.returned_delivery_attempt_num) 尝试派送次数
    ,if(t1.interrupt_category = 3, '是', '否') 是否有待退件标记
#     ,case
#         when t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139') and curdate() > t1.end_date then '是'
#         when t1.client_id in ('AA0131', 'AA0132') and curdate() > tik.end_date then '是'
#         when t1.client_id in ('AA0090', 'AA0128','AA0089') and curdate() > sho.end_date then '是'
#         when t1.client_id in ('AA0149', 'AA0148') and curdate() > she.delievey_end_date then '是'
#         else null
#     end 是否已经超时
    ,case
        when t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139') and curdate() > t1.end_date then datediff(curdate(), t1.end_date)
        when t1.client_id in ('AA0131', 'AA0132') and curdate() > t1.end_date then datediff(curdate(), t1.end_date)
        when t1.client_id in ('AA0090', 'AA0128','AA0089') and curdate() > t1.end_date then datediff(curdate(), t1.end_date)
        when t1.client_id in ('AA0149', 'AA0148') and curdate() > t1.end_date then datediff(curdate(), t1.end_date)
        else null
    end  超时天数
    ,if(t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139'), oi.insure_declare_value/100, oi.cogs_amount/100) cogs金额
    ,pho.pho_count 打电话次数
    ,pho.xiangling_count 响铃未通话次数
    ,pho.tonghua_num 有效通话次数
    ,pho.8_tonghua_num 大于8秒通话次数
from t t1
left join
    (
        select
            plt.pno
            ,plt.updated_at
            ,plt.duty_result
        from ph_bi.parcel_lose_task plt
        join t t1 on t1.pno = plt.pno
        where
            plt.state = 6
    ) a2 on a2.pno = t1.pno
left join ph_staging.delivery_attempt_info dai on dai.pno = if(t1.returned = 0, t1.pno, t1.customary_pno)
left join
    (
        select
            pr.routed_at
            ,pr.pno
            ,row_number() over (partition by pr.pno order by pr.routed_at ) rk
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno and pr.store_id = t1.store_id
        where
            pr.routed_at > '2023-03-01'
            and pr.route_action in ('INVENTORY','RECEIVED' ,'RECEIVE_WAREHOUSE_SCAN', 'SORTING_SCAN', 'DELIVERY_TICKET_CREATION_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SHIPMENT_WAREHOUSE_SCAN', 'DETAIN_WAREHOUSE', 'DELIVERY_CONFIRM', 'DIFFICULTY_HANDOVER', 'DELIVERY_MARKER', 'REPLACE_PNO','SEAL', 'UNSEAL', 'STAFF_INFO_UPDATE_WEIGHT', 'STORE_KEEPER_UPDATE_WEIGHT', 'STORE_SORTER_UPDATE_WEIGHT', 'DISCARD_RETURN_BKK', 'DELIVERY_TRANSFER', 'PICKUP_RETURN_RECEIPT', 'FLASH_HOME_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SORTING_SCAN ', 'DELIVERY_PICKUP_STORE_SCAN', 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE', 'REFUND_CONFIRM', 'ACCEPT_PARCEL')
    ) ss on ss.pno = t1.pno and ss.rk = 1
left join ph_staging.order_info oi on oi.pno = t1.pno
left join ph_staging.sys_store ss2 on ss2.id = t1.ticket_pickup_store_id
left join ph_staging.sys_store ss3 on ss3.id = t1.dst_store_id
left join
    (
        select
            a1.pno
            ,count(a1.id) pho_count
            ,count(if(a1.tonghua = 0 and a1.xiangling > 0, a1.id, null)) xiangling_count
            ,count(if(a1.tonghua > 0, a1.id, null)) tonghua_num
            ,count(if(a1.tonghua > 8, a1.id, null)) 8_tonghua_num
        from
            (
                select
                    pr2.pno
                    ,pr2.id
                    ,json_extract(pr2.extra_value, '$.callDuration') tonghua
                    ,json_extract(pr2.extra_value, '$.diaboloDuration') xiangling
                from ph_staging.parcel_route pr2
                join t t1 on pr2.pno = t1.pno
                where
                    pr2.route_action = 'PHONE'
                    and pr2.routed_at >= '2023-03-01'
            ) a1
        group by 1
    ) pho on pho.pno = t1.pno;
;-- -. . -..- - / . -. - .-. -.--
select
            laz.pno
            ,laz.delievey_end_date end_date
            ,pi.returned
            ,pi.client_id
            ,pi.state
            ,pi.customary_pno
            ,pi.insure_declare_value
            ,pi.ticket_pickup_store_id
            ,pi.dst_store_id
            ,pi.interrupt_category
            ,pi.created_at
        from dwm.dwd_ex_ph_lazada_pno_period laz
        join ph_staging.parcel_info pi on pi.pno = laz.pno
        where
            pi.state not in (5,7,8,9)
            and laz.delievey_end_date < curdate()

        union all

        select
            sho.pno
            ,sho.end_date
            ,pi.returned
            ,pi.client_id
            ,pi.state
            ,pi.customary_pno
            ,pi.insure_declare_value
            ,pi.ticket_pickup_store_id
            ,pi.dst_store_id
            ,pi.interrupt_category
            ,pi.created_at
        from dwm.dwd_ex_shopee_pno_period sho
        join ph_staging.parcel_info pi on pi.pno = sho.pno
        where
            pi.state not in (5,7,8,9)
            and sho.end_date < curdate()
        -- tiktok
        union all

        select
            tik.pno
            ,tik.end_date
            ,pi.returned
            ,pi.client_id
            ,pi.state
            ,pi.customary_pno
            ,pi.insure_declare_value
            ,pi.ticket_pickup_store_id
            ,pi.dst_store_id
            ,pi.interrupt_category
            ,pi.created_at
        from dwm.dwd_ex_ph_tiktok_sla_detail tik
        join ph_staging.parcel_info pi on pi.pno = tik.pno
        where
            pi.state not in (5,7,8,9)
            and tik.end_date < curdate()

        union all
        -- shein
        select
            shein.pno
            ,shein.delievey_end_date
            ,pi.returned
            ,pi.client_id
            ,pi.state
            ,pi.customary_pno
            ,pi.insure_declare_value
            ,pi.ticket_pickup_store_id
            ,pi.dst_store_id
            ,pi.interrupt_category
            ,pi.created_at
        from dwm.dwd_ex_ph_shein_sla_detail shein
        join ph_staging.parcel_info pi on pi.pno = shein.pno
        where
            pi.state not in (5,7,8,9)
            and shein.delievey_end_date < curdate();
;-- -. . -..- - / . -. - .-. -.--
with a as
(
    -- lazada
        select
            laz.pno
            ,laz.delievey_end_date end_date
            ,pi.returned
            ,pi.client_id
            ,pi.state
            ,pi.customary_pno
            ,pi.insure_declare_value
            ,pi.ticket_pickup_store_id
            ,pi.dst_store_id
            ,pi.interrupt_category
            ,pi.created_at
        from dwm.dwd_ex_ph_lazada_pno_period laz
        join ph_staging.parcel_info pi on pi.pno = laz.pno
        where
            pi.state not in (5,7,8,9)
            and laz.delievey_end_date < curdate()

        union all

        select
            sho.pno
            ,sho.end_date
            ,pi.returned
            ,pi.client_id
            ,pi.state
            ,pi.customary_pno
            ,pi.insure_declare_value
            ,pi.ticket_pickup_store_id
            ,pi.dst_store_id
            ,pi.interrupt_category
            ,pi.created_at
        from dwm.dwd_ex_shopee_pno_period sho
        join ph_staging.parcel_info pi on pi.pno = sho.pno
        where
            pi.state not in (5,7,8,9)
            and sho.end_date < curdate()
        -- tiktok
        union all

        select
            tik.pno
            ,tik.end_date
            ,pi.returned
            ,pi.client_id
            ,pi.state
            ,pi.customary_pno
            ,pi.insure_declare_value
            ,pi.ticket_pickup_store_id
            ,pi.dst_store_id
            ,pi.interrupt_category
            ,pi.created_at
        from dwm.dwd_ex_ph_tiktok_sla_detail tik
        join ph_staging.parcel_info pi on pi.pno = tik.pno
        where
            pi.state not in (5,7,8,9)
            and tik.end_date < curdate()

        union all
        -- shein
        select
            shein.pno
            ,shein.delievey_end_date
            ,pi.returned
            ,pi.client_id
            ,pi.state
            ,pi.customary_pno
            ,pi.insure_declare_value
            ,pi.ticket_pickup_store_id
            ,pi.dst_store_id
            ,pi.interrupt_category
            ,pi.created_at
        from dwm.dwd_ex_ph_shein_sla_detail shein
        join ph_staging.parcel_info pi on pi.pno = shein.pno
        where
            pi.state not in (5,7,8,9)
            and shein.delievey_end_date < curdate()
)
, t as
(
    select
        a1.*
    from
        (
            select
                pr.routed_at
                ,pr.route_action
                ,pr.store_name
                ,pr.store_id
                ,t1.*
                ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
            from ph_staging.parcel_route pr
            join a t1 on t1.pno = pr.pno
            where
                pr.routed_at > '2023-07-01'
                and pr.route_action in ('INVENTORY','RECEIVED' ,'RECEIVE_WAREHOUSE_SCAN', 'SORTING_SCAN', 'DELIVERY_TICKET_CREATION_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SHIPMENT_WAREHOUSE_SCAN', 'DETAIN_WAREHOUSE', 'DELIVERY_CONFIRM', 'DIFFICULTY_HANDOVER', 'DELIVERY_MARKER', 'REPLACE_PNO','SEAL', 'UNSEAL', 'STAFF_INFO_UPDATE_WEIGHT', 'STORE_KEEPER_UPDATE_WEIGHT', 'STORE_SORTER_UPDATE_WEIGHT', 'DISCARD_RETURN_BKK', 'DELIVERY_TRANSFER', 'PICKUP_RETURN_RECEIPT', 'FLASH_HOME_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SORTING_SCAN ', 'DELIVERY_PICKUP_STORE_SCAN', 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE', 'REFUND_CONFIRM', 'ACCEPT_PARCEL')
        ) a1
    where
        a1.rk = 1
)
select
    t1.pno
    ,if(t1.returned = 0, '正向', '退件') 包裹流向
    ,t1.client_id
    ,case t1.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,ss2.name 揽收网点
    ,ss3.name 目的地网点
    ,case a2.duty_result
        when 1 then '丢失'
        when 2 then '破损'
        when 3 then '超时效'
    end 判责类型
    ,a2.updated_at 判责日期
    ,case t1.route_action # 路由动作
         when 'ACCEPT_PARCEL' then '接件扫描'
         when 'ARRIVAL_GOODS_VAN_CHECK_SCAN' then '车货关联到港'
         when 'ARRIVAL_WAREHOUSE_SCAN' then '到件入仓扫描'
         when 'CANCEL_ARRIVAL_WAREHOUSE_SCAN' then '取消到件入仓扫描'
         when 'CANCEL_PARCEL' then '撤销包裹'
         when 'CANCEL_SHIPMENT_WAREHOUSE' then '取消发件出仓'
         when 'CHANGE_PARCEL_CANCEL' then '修改包裹为撤销'
         when 'CHANGE_PARCEL_CLOSE' then '修改包裹为异常关闭'
         when 'CHANGE_PARCEL_IN_TRANSIT' then '修改包裹为运输中'
         when 'CHANGE_PARCEL_INFO' then '修改包裹信息'
         when 'CHANGE_PARCEL_SIGNED' then '修改包裹为签收'
         when 'CLAIMS_CLOSE' then '理赔关闭'
         when 'CLAIMS_COMPLETE' then '理赔完成'
         when 'CLAIMS_CONTACT' then '已联系客户'
         when 'CLAIMS_TRANSFER_CS' then '转交总部cs处理'
         when 'CLOSE_ORDER' then '关闭订单'
         when 'CONTINUE_TRANSPORT' then '疑难件继续配送'
         when 'CREATE_WORK_ORDER' then '创建工单'
         when 'CUSTOMER_CHANGE_PARCEL_INFO' then '客户修改包裹信息'
         when 'CUSTOMER_OPERATING_RETURN' then '客户操作退回寄件人'
         when 'DELIVERY_CONFIRM' then '确认妥投'
         when 'DELIVERY_MARKER' then '派件标记'
         when 'DELIVERY_PICKUP_STORE_SCAN' then '自提取件扫描'
         when 'DELIVERY_TICKET_CREATION_SCAN' then '交接扫描'
         when 'DELIVERY_TRANSFER' then '派件转单'
         when 'DEPARTURE_GOODS_VAN_CK_SCAN' then '车货关联出港'
         when 'DETAIN_WAREHOUSE' then '货件留仓'
         when 'DIFFICULTY_FINISH_INDEMNITY' then '疑难件支付赔偿'
         when 'DIFFICULTY_HANDOVER' then '疑难件交接'
         when 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE' then '疑难件交接货件留仓'
         when 'DIFFICULTY_RE_TRANSIT' then '疑难件退回区域总部/重启运送'
         when 'DIFFICULTY_RETURN' then '疑难件退回寄件人'
         when 'DIFFICULTY_SEAL' then '集包异常'
         when 'DISCARD_RETURN_BKK' then '丢弃包裹的，换单后寄回BKK'
         when 'DISTRIBUTION_INVENTORY' then '分拨盘库'
         when 'DWS_WEIGHT_IMAGE' then 'DWS复秤照片'
         when 'EXCHANGE_PARCEL' then '换货'
         when 'FAKE_CANCEL_HANDLE' then '虚假撤销判责'
         when 'FLASH_HOME_SCAN' then 'FH交接扫描'
         when 'FORCE_TAKE_PHOTO' then '强制拍照路由'
         when 'HAVE_HAIR_SCAN_NO_TO' then '有发无到'
         when 'HURRY_PARCEL' then '催单'
         when 'INCOMING_CALL' then '来电接听'
         when 'INTERRUPT_PARCEL_AND_RETURN' then '中断运输并退回'
         when 'INVENTORY' then '盘库'
         when 'LOSE_PARCEL_TEAM_OPERATION' then '丢失件团队处理'
         when 'MANUAL_REMARK' then '添加备注'
         when 'MISS_PICKUP_HANDLE' then '漏包裹揽收判责'
         when 'MISSING_PARCEL_SCAN' then '丢失件包裹操作'
         when 'NOTICE_LOST_PARTS_TEAM' then '已通知丢失件团队'
         when 'PARCEL_HEADLESS_CLAIMED' then '无头件包裹已认领'
         when 'PARCEL_HEADLESS_PRINTED' then '无头件包裹已打单'
         when 'PENDING_RETURN' then '待退件'
         when 'PHONE' then '电话联系'
         when 'PICK_UP_STORE' then '待自提取件'
         when 'PICKUP_RETURN_RECEIPT' then '签回单揽收'
         when 'PRINTING' then '打印面单'
         when 'QAQC_OPERATION' then 'QAQC判责'
         when 'RECEIVE_WAREHOUSE_SCAN' then '收件入仓'
         when 'RECEIVED' then '已揽收,初始化动作，实际情况并没有作用'
         when 'REFUND_CONFIRM' then '退件妥投'
         when 'REPAIRED' then '上报问题修复路由'
         when 'REPLACE_PNO' then '换单'
         when 'REPLY_WORK_ORDER' then '回复工单'
         when 'REVISION_TIME' then '改约时间'
         when 'SEAL' then '集包'
         when 'SEAL_NUMBER_CHANGE' then '集包件数变化'
         when 'SHIPMENT_WAREHOUSE_SCAN' then '发件出仓扫描'
         when 'SORTER_WEIGHT_IMAGE' then '分拣机复秤照片'
         when 'SORTING_SCAN' then '分拣扫描'
         when 'STAFF_INFO_UPDATE_WEIGHT' then '快递员修改重量'
         when 'STORE_KEEPER_UPDATE_WEIGHT' then '仓管员复秤'
         when 'STORE_SORTER_UPDATE_WEIGHT' then '分拣机复秤'
         when 'SYSTEM_AUTO_RETURN' then '系统自动退件'
         when 'TAKE_PHOTO' then '异常打单拍照'
         when 'THIRD_EXPRESS_ROUTE' then '第三方公司路由'
         when 'THIRD_PARTY_REASON_DETAIN' then '第三方原因滞留'
         when 'TICKET_WEIGHT_IMAGE' then '揽收称重照片'
         when 'TRANSFER_LOST_PARTS_TEAM' then '已转交丢失件团队'
         when 'TRANSFER_QAQC' then '转交QAQC处理'
         when 'UNSEAL' then '拆包'
         when 'UNSEAL_NO_PARCEL' then '上报包裹不在集包里'
         when 'UNSEAL_NOT_SCANNED' then '集包已拆包，本包裹未被扫描'
         when 'VEHICLE_ACCIDENT_REG' then '车辆车祸登记'
         when 'VEHICLE_ACCIDENT_REGISTRATION' then '车辆车祸登记'
         when 'VEHICLE_WET_DAMAGE_REG' then '车辆湿损登记'
         when 'VEHICLE_WET_DAMAGE_REGISTRATION' then '车辆湿损登记'
    end as 最后一次有效路由操作
    ,t1.store_name 最后一次有效路由网点
    ,convert_tz(ss.routed_at, '+00:00', '+08:00') 到达网点时间
    ,date(convert_tz(t1.routed_at, '+00:00', '+08:00')) 最后一次有效路由时间
    ,timestampdiff(hour, convert_tz(t1.routed_at, '+00:00', '+08:00'), now()) 最近一次有效路由至今小时数
    ,if(t1.returned = 0, dai.delivery_attempt_num, dai.returned_delivery_attempt_num) 尝试派送次数
    ,if(t1.interrupt_category = 3, '是', '否') 是否有待退件标记
#     ,case
#         when t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139') and curdate() > t1.end_date then '是'
#         when t1.client_id in ('AA0131', 'AA0132') and curdate() > tik.end_date then '是'
#         when t1.client_id in ('AA0090', 'AA0128','AA0089') and curdate() > sho.end_date then '是'
#         when t1.client_id in ('AA0149', 'AA0148') and curdate() > she.delievey_end_date then '是'
#         else null
#     end 是否已经超时
    ,case
        when t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139') and curdate() > t1.end_date then datediff(curdate(), t1.end_date)
        when t1.client_id in ('AA0131', 'AA0132') and curdate() > t1.end_date then datediff(curdate(), t1.end_date)
        when t1.client_id in ('AA0090', 'AA0128','AA0089') and curdate() > t1.end_date then datediff(curdate(), t1.end_date)
        when t1.client_id in ('AA0149', 'AA0148') and curdate() > t1.end_date then datediff(curdate(), t1.end_date)
        else null
    end  超时天数
    ,if(t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139'), oi.insure_declare_value/100, oi.cogs_amount/100) cogs金额
    ,pho.pho_count 打电话次数
    ,pho.xiangling_count 响铃未通话次数
    ,pho.tonghua_num 有效通话次数
    ,pho.8_tonghua_num 大于8秒通话次数
from t t1
left join
    (
        select
            plt.pno
            ,plt.updated_at
            ,plt.duty_result
        from ph_bi.parcel_lose_task plt
        join t t1 on t1.pno = plt.pno
        where
            plt.state = 6
            and plt.created_at > '2023-07-01'
    ) a2 on a2.pno = t1.pno
left join ph_staging.delivery_attempt_info dai on dai.pno = if(t1.returned = 0, t1.pno, t1.customary_pno)
left join
    (
        select
            pr.routed_at
            ,pr.pno
            ,row_number() over (partition by pr.pno order by pr.routed_at ) rk
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno and pr.store_id = t1.store_id
        where
            pr.routed_at > '2023-07-01'
            and pr.route_action in ('INVENTORY','RECEIVED' ,'RECEIVE_WAREHOUSE_SCAN', 'SORTING_SCAN', 'DELIVERY_TICKET_CREATION_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SHIPMENT_WAREHOUSE_SCAN', 'DETAIN_WAREHOUSE', 'DELIVERY_CONFIRM', 'DIFFICULTY_HANDOVER', 'DELIVERY_MARKER', 'REPLACE_PNO','SEAL', 'UNSEAL', 'STAFF_INFO_UPDATE_WEIGHT', 'STORE_KEEPER_UPDATE_WEIGHT', 'STORE_SORTER_UPDATE_WEIGHT', 'DISCARD_RETURN_BKK', 'DELIVERY_TRANSFER', 'PICKUP_RETURN_RECEIPT', 'FLASH_HOME_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SORTING_SCAN ', 'DELIVERY_PICKUP_STORE_SCAN', 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE', 'REFUND_CONFIRM', 'ACCEPT_PARCEL')
    ) ss on ss.pno = t1.pno and ss.rk = 1
left join ph_staging.order_info oi on oi.pno = t1.pno
left join ph_staging.sys_store ss2 on ss2.id = t1.ticket_pickup_store_id
left join ph_staging.sys_store ss3 on ss3.id = t1.dst_store_id
left join
    (
        select
            a1.pno
            ,count(a1.id) pho_count
            ,count(if(a1.tonghua = 0 and a1.xiangling > 0, a1.id, null)) xiangling_count
            ,count(if(a1.tonghua > 0, a1.id, null)) tonghua_num
            ,count(if(a1.tonghua > 8, a1.id, null)) 8_tonghua_num
        from
            (
                select
                    pr2.pno
                    ,pr2.id
                    ,json_extract(pr2.extra_value, '$.callDuration') tonghua
                    ,json_extract(pr2.extra_value, '$.diaboloDuration') xiangling
                from ph_staging.parcel_route pr2
                join t t1 on pr2.pno = t1.pno
                where
                    pr2.route_action = 'PHONE'
                    and pr2.routed_at >= '2023-07-01'
            ) a1
        group by 1
    ) pho on pho.pno = t1.pno;
;-- -. . -..- - / . -. - .-. -.--
with a as
(
    -- lazada
        select
            laz.pno
            ,laz.delievey_end_date end_date
            ,pi.returned
            ,pi.client_id
            ,pi.state
            ,pi.customary_pno
            ,pi.insure_declare_value
            ,pi.ticket_pickup_store_id
            ,pi.dst_store_id
            ,pi.interrupt_category
            ,pi.cod_amount
        from dwm.dwd_ex_ph_lazada_pno_period laz
        join ph_staging.parcel_info pi on pi.pno = laz.pno
        where
            pi.state not in (5,7,8,9)
            and laz.delievey_end_date < curdate()

        union all

        select
            sho.pno
            ,sho.end_date
            ,pi.returned
            ,pi.client_id
            ,pi.state
            ,pi.customary_pno
            ,pi.insure_declare_value
            ,pi.ticket_pickup_store_id
            ,pi.dst_store_id
            ,pi.interrupt_category
            ,pi.cod_amount
        from dwm.dwd_ex_shopee_pno_period sho
        join ph_staging.parcel_info pi on pi.pno = sho.pno
        where
            pi.state not in (5,7,8,9)
            and sho.end_date < curdate()
        -- tiktok
        union all

        select
            tik.pno
            ,tik.end_date
            ,pi.returned
            ,pi.client_id
            ,pi.state
            ,pi.customary_pno
            ,pi.insure_declare_value
            ,pi.ticket_pickup_store_id
            ,pi.dst_store_id
            ,pi.interrupt_category
            ,pi.cod_amount
        from dwm.dwd_ex_ph_tiktok_sla_detail tik
        join ph_staging.parcel_info pi on pi.pno = tik.pno
        where
            pi.state not in (5,7,8,9)
            and tik.end_date < curdate()

        union all
        -- shein
        select
            shein.pno
            ,shein.delievey_end_date
            ,pi.returned
            ,pi.client_id
            ,pi.state
            ,pi.customary_pno
            ,pi.insure_declare_value
            ,pi.ticket_pickup_store_id
            ,pi.dst_store_id
            ,pi.interrupt_category
            ,pi.cod_amount
        from dwm.dwd_ex_ph_shein_sla_detail shein
        join ph_staging.parcel_info pi on pi.pno = shein.pno
        where
            pi.state not in (5,7,8,9)
            and shein.delievey_end_date < curdate()
)
, t as
(
    select
        a1.*
    from
        (
            select
                pr.routed_at
                ,pr.route_action
                ,pr.store_name
                ,pr.store_id
                ,t1.*
                ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
            from ph_staging.parcel_route pr
            join a t1 on t1.pno = pr.pno
            where
                pr.routed_at > '2023-07-01'
                and pr.route_action in ('INVENTORY','RECEIVED' ,'RECEIVE_WAREHOUSE_SCAN', 'SORTING_SCAN', 'DELIVERY_TICKET_CREATION_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SHIPMENT_WAREHOUSE_SCAN', 'DETAIN_WAREHOUSE', 'DELIVERY_CONFIRM', 'DIFFICULTY_HANDOVER', 'DELIVERY_MARKER', 'REPLACE_PNO','SEAL', 'UNSEAL', 'STAFF_INFO_UPDATE_WEIGHT', 'STORE_KEEPER_UPDATE_WEIGHT', 'STORE_SORTER_UPDATE_WEIGHT', 'DISCARD_RETURN_BKK', 'DELIVERY_TRANSFER', 'PICKUP_RETURN_RECEIPT', 'FLASH_HOME_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SORTING_SCAN ', 'DELIVERY_PICKUP_STORE_SCAN', 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE', 'REFUND_CONFIRM', 'ACCEPT_PARCEL')
        ) a1
    where
        a1.rk = 1
)
select
    t1.pno
    ,if(t1.returned = 0, '正向', '退件') 包裹流向
    ,t1.client_id
    ,case t1.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,ss2.name 揽收网点
    ,ss3.name 目的地网点
    ,case a2.duty_result
        when 1 then '丢失'
        when 2 then '破损'
        when 3 then '超时效'
    end 判责类型
    ,a2.updated_at 判责日期
    ,case t1.route_action # 路由动作
         when 'ACCEPT_PARCEL' then '接件扫描'
         when 'ARRIVAL_GOODS_VAN_CHECK_SCAN' then '车货关联到港'
         when 'ARRIVAL_WAREHOUSE_SCAN' then '到件入仓扫描'
         when 'CANCEL_ARRIVAL_WAREHOUSE_SCAN' then '取消到件入仓扫描'
         when 'CANCEL_PARCEL' then '撤销包裹'
         when 'CANCEL_SHIPMENT_WAREHOUSE' then '取消发件出仓'
         when 'CHANGE_PARCEL_CANCEL' then '修改包裹为撤销'
         when 'CHANGE_PARCEL_CLOSE' then '修改包裹为异常关闭'
         when 'CHANGE_PARCEL_IN_TRANSIT' then '修改包裹为运输中'
         when 'CHANGE_PARCEL_INFO' then '修改包裹信息'
         when 'CHANGE_PARCEL_SIGNED' then '修改包裹为签收'
         when 'CLAIMS_CLOSE' then '理赔关闭'
         when 'CLAIMS_COMPLETE' then '理赔完成'
         when 'CLAIMS_CONTACT' then '已联系客户'
         when 'CLAIMS_TRANSFER_CS' then '转交总部cs处理'
         when 'CLOSE_ORDER' then '关闭订单'
         when 'CONTINUE_TRANSPORT' then '疑难件继续配送'
         when 'CREATE_WORK_ORDER' then '创建工单'
         when 'CUSTOMER_CHANGE_PARCEL_INFO' then '客户修改包裹信息'
         when 'CUSTOMER_OPERATING_RETURN' then '客户操作退回寄件人'
         when 'DELIVERY_CONFIRM' then '确认妥投'
         when 'DELIVERY_MARKER' then '派件标记'
         when 'DELIVERY_PICKUP_STORE_SCAN' then '自提取件扫描'
         when 'DELIVERY_TICKET_CREATION_SCAN' then '交接扫描'
         when 'DELIVERY_TRANSFER' then '派件转单'
         when 'DEPARTURE_GOODS_VAN_CK_SCAN' then '车货关联出港'
         when 'DETAIN_WAREHOUSE' then '货件留仓'
         when 'DIFFICULTY_FINISH_INDEMNITY' then '疑难件支付赔偿'
         when 'DIFFICULTY_HANDOVER' then '疑难件交接'
         when 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE' then '疑难件交接货件留仓'
         when 'DIFFICULTY_RE_TRANSIT' then '疑难件退回区域总部/重启运送'
         when 'DIFFICULTY_RETURN' then '疑难件退回寄件人'
         when 'DIFFICULTY_SEAL' then '集包异常'
         when 'DISCARD_RETURN_BKK' then '丢弃包裹的，换单后寄回BKK'
         when 'DISTRIBUTION_INVENTORY' then '分拨盘库'
         when 'DWS_WEIGHT_IMAGE' then 'DWS复秤照片'
         when 'EXCHANGE_PARCEL' then '换货'
         when 'FAKE_CANCEL_HANDLE' then '虚假撤销判责'
         when 'FLASH_HOME_SCAN' then 'FH交接扫描'
         when 'FORCE_TAKE_PHOTO' then '强制拍照路由'
         when 'HAVE_HAIR_SCAN_NO_TO' then '有发无到'
         when 'HURRY_PARCEL' then '催单'
         when 'INCOMING_CALL' then '来电接听'
         when 'INTERRUPT_PARCEL_AND_RETURN' then '中断运输并退回'
         when 'INVENTORY' then '盘库'
         when 'LOSE_PARCEL_TEAM_OPERATION' then '丢失件团队处理'
         when 'MANUAL_REMARK' then '添加备注'
         when 'MISS_PICKUP_HANDLE' then '漏包裹揽收判责'
         when 'MISSING_PARCEL_SCAN' then '丢失件包裹操作'
         when 'NOTICE_LOST_PARTS_TEAM' then '已通知丢失件团队'
         when 'PARCEL_HEADLESS_CLAIMED' then '无头件包裹已认领'
         when 'PARCEL_HEADLESS_PRINTED' then '无头件包裹已打单'
         when 'PENDING_RETURN' then '待退件'
         when 'PHONE' then '电话联系'
         when 'PICK_UP_STORE' then '待自提取件'
         when 'PICKUP_RETURN_RECEIPT' then '签回单揽收'
         when 'PRINTING' then '打印面单'
         when 'QAQC_OPERATION' then 'QAQC判责'
         when 'RECEIVE_WAREHOUSE_SCAN' then '收件入仓'
         when 'RECEIVED' then '已揽收,初始化动作，实际情况并没有作用'
         when 'REFUND_CONFIRM' then '退件妥投'
         when 'REPAIRED' then '上报问题修复路由'
         when 'REPLACE_PNO' then '换单'
         when 'REPLY_WORK_ORDER' then '回复工单'
         when 'REVISION_TIME' then '改约时间'
         when 'SEAL' then '集包'
         when 'SEAL_NUMBER_CHANGE' then '集包件数变化'
         when 'SHIPMENT_WAREHOUSE_SCAN' then '发件出仓扫描'
         when 'SORTER_WEIGHT_IMAGE' then '分拣机复秤照片'
         when 'SORTING_SCAN' then '分拣扫描'
         when 'STAFF_INFO_UPDATE_WEIGHT' then '快递员修改重量'
         when 'STORE_KEEPER_UPDATE_WEIGHT' then '仓管员复秤'
         when 'STORE_SORTER_UPDATE_WEIGHT' then '分拣机复秤'
         when 'SYSTEM_AUTO_RETURN' then '系统自动退件'
         when 'TAKE_PHOTO' then '异常打单拍照'
         when 'THIRD_EXPRESS_ROUTE' then '第三方公司路由'
         when 'THIRD_PARTY_REASON_DETAIN' then '第三方原因滞留'
         when 'TICKET_WEIGHT_IMAGE' then '揽收称重照片'
         when 'TRANSFER_LOST_PARTS_TEAM' then '已转交丢失件团队'
         when 'TRANSFER_QAQC' then '转交QAQC处理'
         when 'UNSEAL' then '拆包'
         when 'UNSEAL_NO_PARCEL' then '上报包裹不在集包里'
         when 'UNSEAL_NOT_SCANNED' then '集包已拆包，本包裹未被扫描'
         when 'VEHICLE_ACCIDENT_REG' then '车辆车祸登记'
         when 'VEHICLE_ACCIDENT_REGISTRATION' then '车辆车祸登记'
         when 'VEHICLE_WET_DAMAGE_REG' then '车辆湿损登记'
         when 'VEHICLE_WET_DAMAGE_REGISTRATION' then '车辆湿损登记'
    end as 最后一次有效路由操作
    ,t1.store_name 最后一次有效路由网点
    ,convert_tz(ss.routed_at, '+00:00', '+08:00') 到达网点时间
    ,date(convert_tz(t1.routed_at, '+00:00', '+08:00')) 最后一次有效路由时间
    ,timestampdiff(hour, convert_tz(t1.routed_at, '+00:00', '+08:00'), now()) 最近一次有效路由至今小时数
    ,if(t1.returned = 0, dai.delivery_attempt_num, dai.returned_delivery_attempt_num) 尝试派送次数
    ,if(t1.interrupt_category = 3, '是', '否') 是否有待退件标记
#     ,case
#         when t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139') and curdate() > t1.end_date then '是'
#         when t1.client_id in ('AA0131', 'AA0132') and curdate() > tik.end_date then '是'
#         when t1.client_id in ('AA0090', 'AA0128','AA0089') and curdate() > sho.end_date then '是'
#         when t1.client_id in ('AA0149', 'AA0148') and curdate() > she.delievey_end_date then '是'
#         else null
#     end 是否已经超时
    ,case
        when t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139') and curdate() > t1.end_date then datediff(curdate(), t1.end_date)
        when t1.client_id in ('AA0131', 'AA0132') and curdate() > t1.end_date then datediff(curdate(), t1.end_date)
        when t1.client_id in ('AA0090', 'AA0128','AA0089') and curdate() > t1.end_date then datediff(curdate(), t1.end_date)
        when t1.client_id in ('AA0149', 'AA0148') and curdate() > t1.end_date then datediff(curdate(), t1.end_date)
        else null
    end  超时天数
    ,if(t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139'), oi.insure_declare_value/100, oi.cogs_amount/100) cogs金额
    ,t1.cod_amount/100 cod金额
    ,pho.pho_count 打电话次数
    ,pho.xiangling_count 响铃未通话次数
    ,pho.tonghua_num 有效通话次数
    ,pho.8_tonghua_num 大于8秒通话次数
from t t1
left join
    (
        select
            plt.pno
            ,plt.updated_at
            ,plt.duty_result
        from ph_bi.parcel_lose_task plt
        join t t1 on t1.pno = plt.pno
        where
            plt.state = 6
            and plt.created_at > '2023-07-01'
    ) a2 on a2.pno = t1.pno
left join ph_staging.delivery_attempt_info dai on dai.pno = if(t1.returned = 0, t1.pno, t1.customary_pno)
left join
    (
        select
            pr.routed_at
            ,pr.pno
            ,row_number() over (partition by pr.pno order by pr.routed_at ) rk
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno and pr.store_id = t1.store_id
        where
            pr.routed_at > '2023-07-01'
            and pr.route_action in ('INVENTORY','RECEIVED' ,'RECEIVE_WAREHOUSE_SCAN', 'SORTING_SCAN', 'DELIVERY_TICKET_CREATION_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SHIPMENT_WAREHOUSE_SCAN', 'DETAIN_WAREHOUSE', 'DELIVERY_CONFIRM', 'DIFFICULTY_HANDOVER', 'DELIVERY_MARKER', 'REPLACE_PNO','SEAL', 'UNSEAL', 'STAFF_INFO_UPDATE_WEIGHT', 'STORE_KEEPER_UPDATE_WEIGHT', 'STORE_SORTER_UPDATE_WEIGHT', 'DISCARD_RETURN_BKK', 'DELIVERY_TRANSFER', 'PICKUP_RETURN_RECEIPT', 'FLASH_HOME_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SORTING_SCAN ', 'DELIVERY_PICKUP_STORE_SCAN', 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE', 'REFUND_CONFIRM', 'ACCEPT_PARCEL')
    ) ss on ss.pno = t1.pno and ss.rk = 1
left join ph_staging.order_info oi on oi.pno = t1.pno
left join ph_staging.sys_store ss2 on ss2.id = t1.ticket_pickup_store_id
left join ph_staging.sys_store ss3 on ss3.id = t1.dst_store_id
left join
    (
        select
            a1.pno
            ,count(a1.id) pho_count
            ,count(if(a1.tonghua = 0 and a1.xiangling > 0, a1.id, null)) xiangling_count
            ,count(if(a1.tonghua > 0, a1.id, null)) tonghua_num
            ,count(if(a1.tonghua > 8, a1.id, null)) 8_tonghua_num
        from
            (
                select
                    pr2.pno
                    ,pr2.id
                    ,json_extract(pr2.extra_value, '$.callDuration') tonghua
                    ,json_extract(pr2.extra_value, '$.diaboloDuration') xiangling
                from ph_staging.parcel_route pr2
                join t t1 on pr2.pno = t1.pno
                where
                    pr2.route_action = 'PHONE'
                    and pr2.routed_at >= '2023-07-01'
            ) a1
        group by 1
    ) pho on pho.pno = t1.pno;
;-- -. . -..- - / . -. - .-. -.--
select
    f1.store_id
    ,f1.store_name
	,f1.piece_name
	,f1.region_name
    ,hsi.staff_info_id
    ,hsi.job_title
    ,hjt.job_name
    ,case when hsi.state=1 and hsi.wait_leave_state = 0 then '在职'
        when hsi.state=1 and hsi.wait_leave_state = 1 then '待离职'
        when  hsi.state=3 then '停职' else null end as 在职状态
	#,ad.staff_info_id
	#,ad1.staff_info_id
	#,ad2.staff_info_id
from ph_bi.hr_staff_info hsi
left join ph_bi.hr_job_title hjt on hjt.id = hsi.job_title
left join
    (
       select
		    dp.store_id
		    ,dp.store_name
			,dp.piece_name
			,dp.region_name
		from dwm.dim_ph_sys_store_rd dp
		where  dp.stat_date = date_sub(curdate(), interval 1 day) and dp.store_category=1
    )f1 on hsi.sys_store_id=f1.store_id
where hsi.job_title in(13,110,1000) and hsi.state in(1,3);
;-- -. . -..- - / . -. - .-. -.--
select
    replace(replace(swd.history_warning, '[', ''), ']', '')
from ph_backyard.staff_warning_dismiss swd
where
    swd.id = 4706;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        hsi.staff_info_id
        ,hsi.name
        ,hsi.state
        ,hsi.wait_leave_state
        ,hjt.job_name
        ,dp.store_name
        ,dp.piece_name
        ,dp.region_name
        ,swd.warning_count
        ,swd.warning_pending_count
        ,mw.created_at
        ,mw.warning_type
        ,row_number() over (partition by swd.staff_info_id order by mw.created_at ) rk
    from ph_backyard.staff_warning_dismiss swd
    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = swd.staff_info_id and hsi.state = 1
    left join ph_bi.hr_job_title hjt on hjt.id = hsi.job_title
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    left join ph_backyard.message_warning mw on mw.staff_info_id = swd.staff_info_id and mw.warning_type > 1
    where
        swd.warning_pending_count >= 3
        and hsi.state = 1
)
select
    t1.staff_info_id 员工工号
    ,t1.name 员工名字
    ,case
        when t1.state = 1 and t1.wait_leave_state = 0 then '在职'
        when t1.state = 1 and t1.wait_leave_state = 1 then '待离职'
        when t1.state = 2 then '离职'
        when t1.state = 3 then '停职'
    end 在职状态
    ,t1.job_name 职位
    ,t1.store_name 所属网点
    ,t1.region_name 大区
    ,t1.piece_name 片区
    ,t1.warning_count 警告书总次数
    ,t1.warning_pending_count '严厉&最后警告次数'
    ,t1.created_at 第一次
    ,t2.created_at 第二次
    ,t3.created_at 第三次
    ,t4.created_at 第四次
    ,t5.created_at 第五次
from t t1
left join t t2 on t2.staff_info_id = t1.staff_info_id and t2.rk = 2
left join t t3 on t3.staff_info_id = t1.staff_info_id and t3.rk = 2
left join t t4 on t4.staff_info_id = t1.staff_info_id and t4.rk = 2
left join t t5 on t5.staff_info_id = t1.staff_info_id and t5.rk = 2
where
    t1.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
select
    a.leave_date
    ,count(distinct a.staff_info_id) 离职快递员人数
    ,count(distinct if(a.mw_count > 0, a.staff_info_id, null))/count(distinct a.staff_info_id) 有警告信占比
    ,count(distinct if(a.mw_count = 1, a.staff_info_id, null))/count(distinct a.staff_info_id) 1封警告信占比
    ,count(distinct if(a.mw_count = 2, a.staff_info_id, null))/count(distinct a.staff_info_id) 2封警告信占比
    ,count(distinct if(a.mw_count = 3, a.staff_info_id, null))/count(distinct a.staff_info_id) 3封警告信占比
    ,count(distinct if(a.mw_count > 3, a.staff_info_id, null))/count(distinct a.staff_info_id) 3封以上警告信占比
from
    (
        select
            hsi.leave_date
            ,hsi.staff_info_id
        #     ,count(distinct hsi.staff_info_id) 离职快递员人数
        #     ,count(distinct if(mw.staff_info_id is not null, hsi.staff_info_id, null)) 有警告信占比
            ,count(mw.id) mw_count
        from ph_bi.hr_staff_info hsi
        left join ph_backyard.message_warning mw on mw.staff_info_id = hsi.staff_info_id and mw.is_delete = 0
        where
            hsi.state = 2
            and hsi.job_title in (13,110,1000)
            and hsi.leave_date >= date_sub(curdate(), interval 30 day)
            and hsi.leave_date < curdate()
        group by 1,2
    ) a
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    date(a.leave_date) 日期
    ,count(distinct a.staff_info_id) 离职快递员人数
    ,count(distinct if(a.mw_count > 0, a.staff_info_id, null))/count(distinct a.staff_info_id) 有警告信占比
    ,count(distinct if(a.mw_count = 1, a.staff_info_id, null))/count(distinct a.staff_info_id) 1封警告信占比
    ,count(distinct if(a.mw_count = 2, a.staff_info_id, null))/count(distinct a.staff_info_id) 2封警告信占比
    ,count(distinct if(a.mw_count = 3, a.staff_info_id, null))/count(distinct a.staff_info_id) 3封警告信占比
    ,count(distinct if(a.mw_count > 3, a.staff_info_id, null))/count(distinct a.staff_info_id) 3封以上警告信占比
from
    (
        select
            hsi.leave_date
            ,hsi.staff_info_id
        #     ,count(distinct hsi.staff_info_id) 离职快递员人数
        #     ,count(distinct if(mw.staff_info_id is not null, hsi.staff_info_id, null)) 有警告信占比
            ,count(mw.id) mw_count
        from ph_bi.hr_staff_info hsi
        left join ph_backyard.message_warning mw on mw.staff_info_id = hsi.staff_info_id and mw.is_delete = 0
        where
            hsi.state = 2
            and hsi.job_title in (13,110,1000)
            and hsi.leave_date >= date_sub(curdate(), interval 30 day)
            and hsi.leave_date < curdate()
        group by 1,2
    ) a
group by 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        hsi.staff_info_id
        ,hsi.name
        ,hsi.state
        ,hsi.wait_leave_state
        ,hjt.job_name
        ,dp.store_name
        ,dp.piece_name
        ,dp.region_name
        ,swd.warning_count
        ,swd.warning_pending_count
        ,mw.created_at
        ,mw.warning_type
        ,row_number() over (partition by swd.staff_info_id order by mw.created_at ) rk
    from ph_backyard.staff_warning_dismiss swd
    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = swd.staff_info_id and hsi.state = 1
    left join ph_bi.hr_job_title hjt on hjt.id = hsi.job_title
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    left join ph_backyard.message_warning mw on mw.staff_info_id = swd.staff_info_id and mw.warning_type > 1
    where
        swd.warning_pending_count >= 3
        and hsi.state = 1
)
select
    t1.staff_info_id 员工工号
    ,t1.name 员工名字
    ,case
        when t1.state = 1 and t1.wait_leave_state = 0 then '在职'
        when t1.state = 1 and t1.wait_leave_state = 1 then '待离职'
        when t1.state = 2 then '离职'
        when t1.state = 3 then '停职'
    end 在职状态
    ,t1.job_name 职位
    ,t1.store_name 所属网点
    ,t1.region_name 大区
    ,t1.piece_name 片区
    ,t1.warning_count 警告书总次数
    ,t1.warning_pending_count '严厉&最后警告次数'
    ,t1.created_at 第一次
    ,t2.created_at 第二次
    ,t3.created_at 第三次
    ,t4.created_at 第四次
    ,t5.created_at 第五次
from t t1
left join t t2 on t2.staff_info_id = t1.staff_info_id and t2.rk = 2
left join t t3 on t3.staff_info_id = t1.staff_info_id and t3.rk = 3
left join t t4 on t4.staff_info_id = t1.staff_info_id and t4.rk = 4
left join t t5 on t5.staff_info_id = t1.staff_info_id and t5.rk = 5
where
    t1.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
with support as
    (# 系统申请支援---1BY申请支援+2HCM批量导入支援'
	    select
		    hsa.store_id
		    ,hsa.store_name
		    ,hsa.staff_info_id
		    ,hsa.staff_store_id
		    ,hsa.job_title_id
		    ,hsa.employment_begin_date
		    ,hsa.employment_end_date
		    ,hsa.actual_begin_date
			,hsa.actual_end_date
			,hsa.shift_start
	        ,swa.started_at
			,hsa.shift_end
	        ,hsa.data_source
		from ph_backyard.hr_staff_apply_support_store hsa
		join  ph_backyard.staff_work_attendance swa on hsa.staff_info_id = swa.staff_info_id and swa.attendance_date =current_date
		join ph_bi.hr_staff_info hsi on hsi.staff_info_id =hsa.staff_info_id
		where
		    hsi.formal=1
		    and hsa.employment_end_date>=current_date
	        and hsa.status = 2
# 			and (swa.started_at is not null or swa.end_at is not null)
			and hsi.job_title in (13,110,1000,37)
    )
, total as
(
    select
        a.*
    from
        (
            select
                a1.dst_store_id
                ,a1.pno
                ,a1.third_sorting_code
                ,td.created_at td_time
                ,td.staff_info_id
                ,pi.state
                ,pi.finished_at
                ,pi.ticket_delivery_staff_info_id
                ,row_number() over (partition by td.pno order by td.created_at desc ) rn
            from
                (
                    select
                        a.*
                    from
                        (
                            select
                                ds.pno
                                ,ds.dst_store_id
                                ,ps.third_sorting_code
                                ,row_number() over (partition by ps.pno order by ps.created_at desc ) rk
                            from dwm.dwd_ph_dc_should_be_delivery ds
                            join ph_drds.parcel_sorting_code_info ps on ds.pno =  ps.pno and ds.dst_store_id = ps.dst_store_id
                        ) a
                    where
                        a.rk = 1
                ) a1
            join ph_staging.ticket_delivery td on td.pno = a1.pno and td.created_at >=  date_sub(current_date, interval 8 hour) and td.created_at < date_add(current_date, interval 16 hour)
            left join ph_staging.parcel_info pi on pi.pno = a1.pno
        ) a
    where
        a.rn = 1
)



select
        f1.大区
        ,f1.片区
		,f1.网点
        ,f1.支援网点负责人 as 负责人
		,f2.当日应派
        ,f2.当日妥投
        ,f2.未妥投大件数量
        ,f2.自有快递员人数
        ,f2.支援人数
        ,f2.自有仓管
        ,f2.支援仓管
        ,f2.分拣扫描率
        ,f2.自有人效
        ,f2.支援人效
        ,f1.原大区
        ,f1.原片区
		,f1.原网点
        ,f1.原网点负责人
		,f1.参与支援人ID
		,f1.快递员类型
		,f1.上班时间
		,f1.下班时间
     	,f1.揽收量
		,f1.交接量
		,f1.妥投量
		,f1.派送时长
		,f1.交接三段码数量
		,f1.妥投三段码数量
		,f1.未妥投中打电话次数为0的数量
		,f1.未妥投中打电话次数为1的数量

    from
     (
        select
			dp.store_name as 网点
			,dp.piece_name as 片区
			,dp.region_name as 大区
            ,dp1.store_name as 原网点
			,dp1.piece_name as 原片区
			,dp1.region_name as 原大区
		    ,case
			    when dp.region_name in ( 'Area6','Area15') then '徐加文'
			    when dp.region_name in ('Area4') then '韩钥'
			    when dp.region_name in ('Area7','Area10', 'Area11','FHome','Area14') then '张可新'
			    when dp.region_name in ( 'Area8') then '黄勇'
			    when dp.region_name in ('Area1', 'Area2','Area3','Area5', 'Area9', 'Area12','Area13','Area16') then '李俊'
				end 支援网点负责人
            	,case
			    when dp1.region_name in ( 'Area6','Area15') then '徐加文'
			    when dp1.region_name in ('Area4') then '韩钥'
			    when dp.region_name in ('Area7','Area10', 'Area11','FHome','Area14') then '张可新'
			    when dp1.region_name in ( 'Area8') then '黄勇'
			    when dp1.region_name in ('Area1', 'Area2','Area3','Area5', 'Area9', 'Area12','Area13','Area16') then '李俊'
				end 原网点负责人
		    ,sp.staff_info_id as 参与支援人ID
            ,sp.store_id
		    ,case when sp.job_title_id=13 then 'bike' when sp.job_title_id=110 then 'van' when sp.job_title_id=1000 then 'Tricycle'  else 'dco' end as 快递员类型
			,ad.attendance_started_at as 上班时间
			,ad.attendance_end_at as 下班时间
			,s2.scan_count 交接量
		    ,s2.del_count 妥投量
		    ,fk.pickup_pno_cn as 揽收量
		    ,timestampdiff(minute ,fir.finished_at, las.finished_at)/60 派送时长
		    ,code.scan_code_count 交接三段码数量
		    ,code.del_code_num 妥投三段码数量
		    ,pho.0_count 未妥投中打电话次数为0的数量
		    ,pho.1_count 未妥投中打电话次数为1的数量
		from support sp
		left join dwm.dim_ph_sys_store_rd dp on dp.store_id = sp.store_id and dp.stat_date =date_sub(current_date,interval 1 day) # 支援网点组织架构
		left join dwm.dim_ph_sys_store_rd dp1 on dp1.store_id = sp.staff_store_id and dp1.stat_date =date_sub(current_date,interval 1 day)# 原网点组织架构
		left join ph_bi.attendance_data_v2 ad on sp.staff_info_id=ad.staff_info_id and ad.stat_date  =current_date
		left join
		    (
		        select
		            t1.staff_info_id
		            ,count(distinct t1.pno) scan_count
		            ,count(if(t1.state = 5, t1.pno, null)) del_count
		        from total t1
		        group by 1
		    ) s2 on s2.staff_info_id =sp.staff_info_id
		left join
		    ( -- 第一次妥投时间
		        select
		            t1.*
		            ,row_number() over (partition by t1.staff_info_id order by t1.finished_at ) rk
		        from total t1
		        where
		            t1.state = 5
		    ) fir on fir.staff_info_id = sp.staff_info_id and fir.rk = 1
		left join
		    (
		        select
		            t1.*
		            ,row_number() over (partition by t1.staff_info_id order by t1.finished_at desc ) rk
		        from total t1
		        where
		            t1.state = 5
		    ) las on las.staff_info_id = sp.staff_info_id and las.rk = 2
		left join
		    (
		        select
		            t1.staff_info_id
		            ,count(distinct t1.third_sorting_code) scan_code_count
		            ,count(distinct if(t1.state = 5, t1.third_sorting_code, null)) del_code_num
		        from total t1
		        where
		            t1.third_sorting_code not in ('XX', 'YY', 'ZZ', '00', '88')
		        group by 1
		    ) code on code.staff_info_id = sp.staff_info_id
		left join
		    (
		        select
		            a.staff_info_id
		            ,count(if(a.call_times = 0, a.pno, null)) 0_count
		            ,count(if(a.call_times = 1, a.pno, null)) 1_count
		        from
		            (
		                select
		                    t.staff_info_id
		                    ,t.pno
		                    ,count(pr.pno) call_times
		                from total t
		                left join ph_staging.parcel_route pr on pr.pno = t.pno and pr.route_action = 'PHONE'  and pr.routed_at >=  date_sub(current_date, interval 8 hour) and pr.routed_at < date_add(current_date, interval 16 hour)
		                where
		                    t.state != 5
		                group by 1,2
		            ) a
		        group by 1
		    ) pho on pho.staff_info_id = sp.staff_info_id
		left join
		    ( #揽收量
		        select
		            pi.ticket_pickup_staff_info_id
		            ,count(distinct pi.pno) as pickup_pno_cn
		        from ph_staging.parcel_info pi
		        where pi.state <9
		        and pi.created_at >=  date_sub(current_date, interval 8 hour)
		        and pi.created_at < date_add(current_date, interval 16 hour)
		    ) fk on fk.ticket_pickup_staff_info_id = sp.staff_info_id
		where sp.job_title_id in(13,110,10000)
    )f1
    left join
        (
            select
			   sbd.dst_store_id
			    ,sbd.should_delivery_pno as 当日应派
				,sbd.finished_pno as 当日妥投
				,sbd.no_del_big_count as 未妥投大件数量
			    ,hsi.self_courier_count as 自有快递员人数
				,sp.support_courier_count as 支援人数
			    ,hsi.self_dco_count as 自有仓管
				,sp.support_dco_staff_count  as 支援仓管
				,a4.sort_rate as 分拣扫描率
				,a5.self_effect as 自有人效
				,a5.other_effect as 支援人效
			from
				(# 支援网点 当日支援的快递员和仓管数
			        select
			            sp.store_id
						,count(distinct case when sp.job_title_id in(13,110,1000) then sp.staff_info_id else null end) as support_courier_count
						,count(distinct case when sp.job_title_id=37 then sp.staff_info_id else null end) as support_dco_staff_count
			        from support sp
			        group by  sp.store_id
			    ) sp
			join
				(# 应派&当日妥投
			        select
						sbd.dst_store_id
			            ,count(distinct sbd.pno) as should_delivery_pno
			            ,count(distinct case when pi.finished_at is not null and pi.state=5 then pi.pno else null end) as finished_pno
						,count(distinct if(pi.state != 5 and ( pi.exhibition_weight > 5000 or pi.exhibition_length + pi.exhibition_width + pi.exhibition_height > 80 ), pi.pno, null)) no_del_big_count
					from dwm.dwd_ph_dc_should_be_delivery sbd
					join ph_staging.parcel_info pi on sbd.pno=pi.pno
					where sbd.should_delevry_type != '非当日应派'
					group by 1
			    )sbd on sbd.dst_store_id=sp.store_id
			left join
				(# 当日本网点出勤快递员和仓管
					select
					    hsi.sys_store_id
					    ,count(distinct if(hsi.job_title in (13,110,1000) and sup1.staff_info_id is null, hsi.staff_info_id, null)) self_courier_count
					    ,count(distinct if(hsi.job_title in (37) and sup1.staff_info_id is null, hsi.staff_info_id, null)) self_dco_count
					from ph_bi.hr_staff_info hsi
					join ph_backyard.staff_work_attendance swa on swa.staff_info_id = hsi.staff_info_id
					left join support sup1 on sup1.staff_info_id = hsi.staff_info_id
					where swa.attendance_date =current_date
					  and (swa.started_at is not null or swa.end_at is not null)
					group by 1
				)hsi on sbd.dst_store_id=hsi.sys_store_id
			left join
				(# 本网点员工应分拣扫描和实际分拣扫描量
				    select
				        ds.dst_store_id
				        ,count(distinct ds.pno) ds_count
				        ,count(distinct if(pr.pno is not null , ds.pno, null)) sort_count
				        ,count(distinct if(pr.pno is not null , ds.pno, null))/count(distinct ds.pno) sort_rate
				    from dwm.dwd_ph_dc_should_be_delivery ds
				    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'SORTING_SCAN' and pr.routed_at >= date_sub(current_date, interval 8 hour) and pr.routed_at < date_add(current_date, interval 16 hour)
				    group by 1
				) a4 on a4.dst_store_id = sbd.dst_store_id
			left join
			    (# 网点自有员工人效&支援员工人效
			        select
			            ds.dst_store_id
			            ,count(distinct if(hsi.staff_info_id is not null, ds.pno, null))/count(distinct if(hsi.staff_info_id is not null, pi.ticket_delivery_staff_info_id, null)) self_effect #自有员工人效
			            ,count(distinct if(s1.staff_info_id is not null, ds.pno, null))/count(distinct if(s1.staff_info_id is not null, pi.ticket_delivery_staff_info_id, null)) other_effect #支援员工人效
			        from dwm.dwd_ph_dc_should_be_delivery ds
			        join ph_staging.parcel_info pi on pi.pno = ds.pno
			        left join support s1 on s1.store_id = ds.dst_store_id and pi.ticket_delivery_staff_info_id = s1.staff_info_id
			        left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.formal =1  and hsi.sys_store_id = ds.dst_store_id
			        where
			            pi.state = 5
			            and pi.finished_at >= date_sub(current_date, interval 8 hour)
			            and pi.finished_at < date_add(current_date, interval 16 hour)
			            and pi.returned = 0
			        group by 1
			    ) a5 on a5.dst_store_id = sbd.dst_store_id
        )f2  on f1.store_id=f2.dst_store_id

 order by 3;
;-- -. . -..- - / . -. - .-. -.--
select
		    hsa.store_id
		    ,hsa.store_name
		    ,hsa.staff_info_id
		    ,hsa.staff_store_id
		    ,hsa.job_title_id
		    ,hsa.employment_begin_date
		    ,hsa.employment_end_date
		    ,hsa.actual_begin_date
			,hsa.actual_end_date
			,hsa.shift_start
	        ,swa.started_at
			,hsa.shift_end
	        ,hsa.data_source
		from ph_backyard.hr_staff_apply_support_store hsa
		join  ph_backyard.staff_work_attendance swa on hsa.staff_info_id = swa.staff_info_id and swa.attendance_date =current_date
		join ph_bi.hr_staff_info hsi on hsi.staff_info_id =hsa.staff_info_id
		where
		    hsi.formal=1
		    and hsa.employment_end_date>=current_date
	        and hsa.status = 2
# 			and (swa.started_at is not null or swa.end_at is not null)
			and hsi.job_title in (13,110,1000,37);
;-- -. . -..- - / . -. - .-. -.--
with support as
    (# 系统申请支援---1BY申请支援+2HCM批量导入支援'
	    select
		    hsa.store_id
		    ,hsa.store_name
		    ,hsa.staff_info_id
		    ,hsa.staff_store_id
		    ,hsa.job_title_id
		    ,hsa.employment_begin_date
		    ,hsa.employment_end_date
		    ,hsa.actual_begin_date
			,hsa.actual_end_date
			,hsa.shift_start
	        ,swa.started_at
			,hsa.shift_end
	        ,hsa.data_source
		from ph_backyard.hr_staff_apply_support_store hsa
		join  ph_backyard.staff_work_attendance swa on hsa.staff_info_id = swa.staff_info_id and swa.attendance_date =current_date
		join ph_bi.hr_staff_info hsi on hsi.staff_info_id =hsa.staff_info_id
		where
		    hsi.formal=1
		    and hsa.employment_end_date>=current_date
	        and hsa.status = 2
# 			and (swa.started_at is not null or swa.end_at is not null)
			and hsi.job_title in (13,110,1000,37)
    )
, total as
(
    select
        a.*
    from
        (
            select
                a1.dst_store_id
                ,a1.pno
                ,a1.third_sorting_code
                ,td.created_at td_time
                ,td.staff_info_id
                ,pi.state
                ,pi.finished_at
                ,pi.ticket_delivery_staff_info_id
                ,row_number() over (partition by td.pno order by td.created_at desc ) rn
            from
                (
                    select
                        a.*
                    from
                        (
                            select
                                ds.pno
                                ,ds.dst_store_id
                                ,ps.third_sorting_code
                                ,row_number() over (partition by ps.pno order by ps.created_at desc ) rk
                            from dwm.dwd_ph_dc_should_be_delivery ds
                            join ph_drds.parcel_sorting_code_info ps on ds.pno =  ps.pno and ds.dst_store_id = ps.dst_store_id
                        ) a
                    where
                        a.rk = 1
                ) a1
            join ph_staging.ticket_delivery td on td.pno = a1.pno and td.created_at >=  date_sub(current_date, interval 8 hour) and td.created_at < date_add(current_date, interval 16 hour)
            left join ph_staging.parcel_info pi on pi.pno = a1.pno
        ) a
    where
        a.rn = 1
)



select
        f1.大区
        ,f1.片区
		,f1.网点
        ,f1.支援网点负责人 as 负责人
		,f2.当日应派
        ,f2.当日妥投
        ,f2.未妥投大件数量
        ,f2.自有快递员人数
        ,f2.支援人数
        ,f2.自有仓管
        ,f2.支援仓管
        ,f2.分拣扫描率
        ,f2.自有人效
        ,f2.支援人效
        ,f1.原大区
        ,f1.原片区
		,f1.原网点
        ,f1.原网点负责人
		,f1.参与支援人ID
		,f1.快递员类型
		,f1.上班时间
		,f1.下班时间
     	,f1.揽收量
		,f1.交接量
		,f1.妥投量
		,f1.派送时长
		,f1.交接三段码数量
		,f1.妥投三段码数量
		,f1.未妥投中打电话次数为0的数量
		,f1.未妥投中打电话次数为1的数量

    from
     (
        select
			dp.store_name as 网点
			,dp.piece_name as 片区
			,dp.region_name as 大区
            ,dp1.store_name as 原网点
			,dp1.piece_name as 原片区
			,dp1.region_name as 原大区
		    ,case
			    when dp.region_name in ( 'Area6','Area15') then '徐加文'
			    when dp.region_name in ('Area4') then '韩钥'
			    when dp.region_name in ('Area7','Area10', 'Area11','FHome','Area14') then '张可新'
			    when dp.region_name in ( 'Area8') then '黄勇'
			    when dp.region_name in ('Area1', 'Area2','Area3','Area5', 'Area9', 'Area12','Area13','Area16') then '李俊'
            end 支援网点负责人
            ,case
			    when dp1.region_name in ( 'Area6','Area15') then '徐加文'
			    when dp1.region_name in ('Area4') then '韩钥'
			    when dp1.region_name in ('Area7','Area10', 'Area11','FHome','Area14') then '张可新'
			    when dp1.region_name in ( 'Area8') then '黄勇'
			    when dp1.region_name in ('Area1', 'Area2','Area3','Area5', 'Area9', 'Area12','Area13','Area16') then '李俊'
            end 原网点负责人
		    ,sp.staff_info_id as 参与支援人ID
            ,sp.store_id
		    ,case when sp.job_title_id=13 then 'bike' when sp.job_title_id=110 then 'van' when sp.job_title_id=1000 then 'Tricycle'  else 'dco' end as 快递员类型
			,ad.attendance_started_at as 上班时间
			,ad.attendance_end_at as 下班时间
			,s2.scan_count 交接量
		    ,s2.del_count 妥投量
		    ,fk.pickup_pno_cn as 揽收量
		    ,timestampdiff(minute ,fir.finished_at, las.finished_at)/60 派送时长
		    ,code.scan_code_count 交接三段码数量
		    ,code.del_code_num 妥投三段码数量
		    ,pho.0_count 未妥投中打电话次数为0的数量
		    ,pho.1_count 未妥投中打电话次数为1的数量
		from support sp
		left join dwm.dim_ph_sys_store_rd dp on dp.store_id = sp.store_id and dp.stat_date =date_sub(current_date,interval 1 day) # 支援网点组织架构
		left join dwm.dim_ph_sys_store_rd dp1 on dp1.store_id = sp.staff_store_id and dp1.stat_date =date_sub(current_date,interval 1 day)# 原网点组织架构
		left join ph_bi.attendance_data_v2 ad on sp.staff_info_id=ad.staff_info_id and ad.stat_date  =current_date
		left join
		    (
		        select
		            t1.staff_info_id
		            ,count(distinct t1.pno) scan_count
		            ,count(if(t1.state = 5, t1.pno, null)) del_count
		        from total t1
		        group by 1
		    ) s2 on s2.staff_info_id =sp.staff_info_id
		left join
		    ( -- 第一次妥投时间
		        select
		            t1.*
		            ,row_number() over (partition by t1.staff_info_id order by t1.finished_at ) rk
		        from total t1
		        where
		            t1.state = 5
		    ) fir on fir.staff_info_id = sp.staff_info_id and fir.rk = 1
		left join
		    (
		        select
		            t1.*
		            ,row_number() over (partition by t1.staff_info_id order by t1.finished_at desc ) rk
		        from total t1
		        where
		            t1.state = 5
		    ) las on las.staff_info_id = sp.staff_info_id and las.rk = 2
		left join
		    (
		        select
		            t1.staff_info_id
		            ,count(distinct t1.third_sorting_code) scan_code_count
		            ,count(distinct if(t1.state = 5, t1.third_sorting_code, null)) del_code_num
		        from total t1
		        where
		            t1.third_sorting_code not in ('XX', 'YY', 'ZZ', '00', '88')
		        group by 1
		    ) code on code.staff_info_id = sp.staff_info_id
		left join
		    (
		        select
		            a.staff_info_id
		            ,count(if(a.call_times = 0, a.pno, null)) 0_count
		            ,count(if(a.call_times = 1, a.pno, null)) 1_count
		        from
		            (
		                select
		                    t.staff_info_id
		                    ,t.pno
		                    ,count(pr.pno) call_times
		                from total t
		                left join ph_staging.parcel_route pr on pr.pno = t.pno and pr.route_action = 'PHONE'  and pr.routed_at >=  date_sub(current_date, interval 8 hour) and pr.routed_at < date_add(current_date, interval 16 hour)
		                where
		                    t.state != 5
		                group by 1,2
		            ) a
		        group by 1
		    ) pho on pho.staff_info_id = sp.staff_info_id
		left join
		    ( #揽收量
		        select
		            pi.ticket_pickup_staff_info_id
		            ,count(distinct pi.pno) as pickup_pno_cn
		        from ph_staging.parcel_info pi
		        where pi.state <9
		        and pi.created_at >=  date_sub(current_date, interval 8 hour)
		        and pi.created_at < date_add(current_date, interval 16 hour)
		    ) fk on fk.ticket_pickup_staff_info_id = sp.staff_info_id
		where sp.job_title_id in(13,110,10000)
    )f1
    left join
        (
            select
			     sbd.dst_store_id
			    ,sbd.should_delivery_pno as 当日应派
				,sbd.finished_pno as 当日妥投
				,sbd.no_del_big_count as 未妥投大件数量
			    ,hsi.self_courier_count as 自有快递员人数
				,sp.support_courier_count as 支援人数
			    ,hsi.self_dco_count as 自有仓管
				,sp.support_dco_staff_count  as 支援仓管
				,a4.sort_rate as 分拣扫描率
				,a5.self_effect as 自有人效
				,a5.other_effect as 支援人效
			from
				(# 支援网点 当日支援的快递员和仓管数
			        select
			            sp.store_id
						,count(distinct case when sp.job_title_id in(13,110,1000) then sp.staff_info_id else null end) as support_courier_count
						,count(distinct case when sp.job_title_id=37 then sp.staff_info_id else null end) as support_dco_staff_count
			        from support sp
			        group by  sp.store_id
			    ) sp
			join
				(# 应派&当日妥投
			        select
						sbd.dst_store_id
			            ,count(distinct sbd.pno) as should_delivery_pno
			            ,count(distinct case when pi.finished_at is not null and pi.state=5 then pi.pno else null end) as finished_pno
						,count(distinct if(pi.state != 5 and ( pi.exhibition_weight > 5000 or pi.exhibition_length + pi.exhibition_width + pi.exhibition_height > 80 ), pi.pno, null)) no_del_big_count
					from dwm.dwd_ph_dc_should_be_delivery sbd
					join ph_staging.parcel_info pi on sbd.pno=pi.pno
					where sbd.should_delevry_type != '非当日应派'
					group by 1
			    )sbd on sbd.dst_store_id=sp.store_id
			left join
				(# 当日本网点出勤快递员和仓管
					select
					    hsi.sys_store_id
					    ,count(distinct if(hsi.job_title in (13,110,1000) and sup1.staff_info_id is null, hsi.staff_info_id, null)) self_courier_count
					    ,count(distinct if(hsi.job_title in (37) and sup1.staff_info_id is null, hsi.staff_info_id, null)) self_dco_count
					from ph_bi.hr_staff_info hsi
					join ph_backyard.staff_work_attendance swa on swa.staff_info_id = hsi.staff_info_id
					left join support sup1 on sup1.staff_info_id = hsi.staff_info_id
					where swa.attendance_date =current_date
					  and (swa.started_at is not null or swa.end_at is not null)
					group by 1
				)hsi on sbd.dst_store_id=hsi.sys_store_id
			left join
				(# 本网点员工应分拣扫描和实际分拣扫描量
				    select
				        ds.dst_store_id
				        ,count(distinct ds.pno) ds_count
				        ,count(distinct if(pr.pno is not null , ds.pno, null)) sort_count
				        ,count(distinct if(pr.pno is not null , ds.pno, null))/count(distinct ds.pno) sort_rate
				    from dwm.dwd_ph_dc_should_be_delivery ds
				    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'SORTING_SCAN' and pr.routed_at >= date_sub(current_date, interval 8 hour) and pr.routed_at < date_add(current_date, interval 16 hour)
				    group by 1
				) a4 on a4.dst_store_id = sbd.dst_store_id
			left join
			    (# 网点自有员工人效&支援员工人效
			        select
			            ds.dst_store_id
			            ,count(distinct if(hsi.staff_info_id is not null, ds.pno, null))/count(distinct if(hsi.staff_info_id is not null, pi.ticket_delivery_staff_info_id, null)) self_effect #自有员工人效
			            ,count(distinct if(s1.staff_info_id is not null, ds.pno, null))/count(distinct if(s1.staff_info_id is not null, pi.ticket_delivery_staff_info_id, null)) other_effect #支援员工人效
			        from dwm.dwd_ph_dc_should_be_delivery ds
			        join ph_staging.parcel_info pi on pi.pno = ds.pno
			        left join support s1 on s1.store_id = ds.dst_store_id and pi.ticket_delivery_staff_info_id = s1.staff_info_id
			        left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.formal =1  and hsi.sys_store_id = ds.dst_store_id
			        where
			            pi.state = 5
			            and pi.finished_at >= date_sub(current_date, interval 8 hour)
			            and pi.finished_at < date_add(current_date, interval 16 hour)
			            and pi.returned = 0
			        group by 1
			    ) a5 on a5.dst_store_id = sbd.dst_store_id
        )f2  on f1.store_id=f2.dst_store_id

 order by 3;
;-- -. . -..- - / . -. - .-. -.--
with support as
    (# 系统申请支援---1BY申请支援+2HCM批量导入支援'
	    select
		    hsa.store_id
		    ,hsa.store_name
		    ,hsa.staff_info_id
		    ,hsa.staff_store_id
		    ,hsa.job_title_id
		    ,hsa.employment_begin_date
		    ,hsa.employment_end_date
		    ,hsa.actual_begin_date
			,hsa.actual_end_date
			,hsa.shift_start
	        ,swa.started_at
			,hsa.shift_end
	        ,hsa.data_source
		from ph_backyard.hr_staff_apply_support_store hsa
		join  ph_backyard.staff_work_attendance swa on hsa.staff_info_id = swa.staff_info_id and swa.attendance_date =current_date
		join ph_bi.hr_staff_info hsi on hsi.staff_info_id =hsa.staff_info_id
		where
		    hsi.formal=1
		    and hsa.employment_end_date>=current_date
		    and hsa.employment_begin_date <= curdate()
	        and hsa.status = 2
# 			and (swa.started_at is not null or swa.end_at is not null)
			and hsi.job_title in (13,110,1000,37)
    )
, total as
(
    select
        a.*
    from
        (
            select
                a1.dst_store_id
                ,a1.pno
                ,a1.third_sorting_code
                ,td.created_at td_time
                ,td.staff_info_id
                ,pi.state
                ,pi.finished_at
                ,pi.ticket_delivery_staff_info_id
                ,row_number() over (partition by td.pno order by td.created_at desc ) rn
            from
                (
                    select
                        a.*
                    from
                        (
                            select
                                ds.pno
                                ,ds.dst_store_id
                                ,ps.third_sorting_code
                                ,row_number() over (partition by ps.pno order by ps.created_at desc ) rk
                            from dwm.dwd_ph_dc_should_be_delivery ds
                            join ph_drds.parcel_sorting_code_info ps on ds.pno =  ps.pno and ds.dst_store_id = ps.dst_store_id
                        ) a
                    where
                        a.rk = 1
                ) a1
            join ph_staging.ticket_delivery td on td.pno = a1.pno and td.created_at >=  date_sub(current_date, interval 8 hour) and td.created_at < date_add(current_date, interval 16 hour)
            left join ph_staging.parcel_info pi on pi.pno = a1.pno
        ) a
    where
        a.rn = 1
)



select
        f1.大区
        ,f1.片区
		,f1.网点
        ,f1.支援网点负责人 as 负责人
		,f2.当日应派
        ,f2.当日妥投
        ,f2.未妥投大件数量
        ,f2.自有快递员人数
        ,f2.支援人数
        ,f2.自有仓管
        ,f2.支援仓管
        ,f2.分拣扫描率
        ,f2.自有人效
        ,f2.支援人效
        ,f1.原大区
        ,f1.原片区
		,f1.原网点
        ,f1.原网点负责人
		,f1.参与支援人ID
		,f1.快递员类型
		,f1.上班时间
		,f1.下班时间
     	,f1.揽收量
		,f1.交接量
		,f1.妥投量
		,f1.派送时长
		,f1.交接三段码数量
		,f1.妥投三段码数量
		,f1.未妥投中打电话次数为0的数量
		,f1.未妥投中打电话次数为1的数量

    from
     (
        select
			dp.store_name as 网点
			,dp.piece_name as 片区
			,dp.region_name as 大区
            ,dp1.store_name as 原网点
			,dp1.piece_name as 原片区
			,dp1.region_name as 原大区
		    ,case
			    when dp.region_name in ( 'Area6','Area15') then '徐加文'
			    when dp.region_name in ('Area4') then '韩钥'
			    when dp.region_name in ('Area7','Area10', 'Area11','FHome','Area14') then '张可新'
			    when dp.region_name in ( 'Area8') then '黄勇'
			    when dp.region_name in ('Area1', 'Area2','Area3','Area5', 'Area9', 'Area12','Area13','Area16') then '李俊'
            end 支援网点负责人
            ,case
			    when dp1.region_name in ( 'Area6','Area15') then '徐加文'
			    when dp1.region_name in ('Area4') then '韩钥'
			    when dp1.region_name in ('Area7','Area10', 'Area11','FHome','Area14') then '张可新'
			    when dp1.region_name in ( 'Area8') then '黄勇'
			    when dp1.region_name in ('Area1', 'Area2','Area3','Area5', 'Area9', 'Area12','Area13','Area16') then '李俊'
            end 原网点负责人
		    ,sp.staff_info_id as 参与支援人ID
            ,sp.store_id
		    ,case when sp.job_title_id=13 then 'bike' when sp.job_title_id=110 then 'van' when sp.job_title_id=1000 then 'Tricycle'  else 'dco' end as 快递员类型
			,ad.attendance_started_at as 上班时间
			,ad.attendance_end_at as 下班时间
			,s2.scan_count 交接量
		    ,s2.del_count 妥投量
		    ,fk.pickup_pno_cn as 揽收量
		    ,timestampdiff(minute ,fir.finished_at, las.finished_at)/60 派送时长
		    ,code.scan_code_count 交接三段码数量
		    ,code.del_code_num 妥投三段码数量
		    ,pho.0_count 未妥投中打电话次数为0的数量
		    ,pho.1_count 未妥投中打电话次数为1的数量
		from support sp
		left join dwm.dim_ph_sys_store_rd dp on dp.store_id = sp.store_id and dp.stat_date =date_sub(current_date,interval 1 day) # 支援网点组织架构
		left join dwm.dim_ph_sys_store_rd dp1 on dp1.store_id = sp.staff_store_id and dp1.stat_date =date_sub(current_date,interval 1 day)# 原网点组织架构
		left join ph_bi.attendance_data_v2 ad on sp.staff_info_id=ad.staff_info_id and ad.stat_date  =current_date
		left join
		    (
		        select
		            t1.staff_info_id
		            ,count(distinct t1.pno) scan_count
		            ,count(if(t1.state = 5, t1.pno, null)) del_count
		        from total t1
		        group by 1
		    ) s2 on s2.staff_info_id =sp.staff_info_id
		left join
		    ( -- 第一次妥投时间
		        select
		            t1.*
		            ,row_number() over (partition by t1.staff_info_id order by t1.finished_at ) rk
		        from total t1
		        where
		            t1.state = 5
		    ) fir on fir.staff_info_id = sp.staff_info_id and fir.rk = 1
		left join
		    (
		        select
		            t1.*
		            ,row_number() over (partition by t1.staff_info_id order by t1.finished_at desc ) rk
		        from total t1
		        where
		            t1.state = 5
		    ) las on las.staff_info_id = sp.staff_info_id and las.rk = 2
		left join
		    (
		        select
		            t1.staff_info_id
		            ,count(distinct t1.third_sorting_code) scan_code_count
		            ,count(distinct if(t1.state = 5, t1.third_sorting_code, null)) del_code_num
		        from total t1
		        where
		            t1.third_sorting_code not in ('XX', 'YY', 'ZZ', '00', '88')
		        group by 1
		    ) code on code.staff_info_id = sp.staff_info_id
		left join
		    (
		        select
		            a.staff_info_id
		            ,count(if(a.call_times = 0, a.pno, null)) 0_count
		            ,count(if(a.call_times = 1, a.pno, null)) 1_count
		        from
		            (
		                select
		                    t.staff_info_id
		                    ,t.pno
		                    ,count(pr.pno) call_times
		                from total t
		                left join ph_staging.parcel_route pr on pr.pno = t.pno and pr.route_action = 'PHONE'  and pr.routed_at >=  date_sub(current_date, interval 8 hour) and pr.routed_at < date_add(current_date, interval 16 hour)
		                where
		                    t.state != 5
		                group by 1,2
		            ) a
		        group by 1
		    ) pho on pho.staff_info_id = sp.staff_info_id
		left join
		    ( #揽收量
		        select
		            pi.ticket_pickup_staff_info_id
		            ,count(distinct pi.pno) as pickup_pno_cn
		        from ph_staging.parcel_info pi
		        where pi.state <9
		        and pi.created_at >=  date_sub(current_date, interval 8 hour)
		        and pi.created_at < date_add(current_date, interval 16 hour)
		    ) fk on fk.ticket_pickup_staff_info_id = sp.staff_info_id
		where sp.job_title_id in(13,110,10000)
    )f1
    left join
        (
            select
			     sbd.dst_store_id
			    ,sbd.should_delivery_pno as 当日应派
				,sbd.finished_pno as 当日妥投
				,sbd.no_del_big_count as 未妥投大件数量
			    ,hsi.self_courier_count as 自有快递员人数
				,sp.support_courier_count as 支援人数
			    ,hsi.self_dco_count as 自有仓管
				,sp.support_dco_staff_count  as 支援仓管
				,a4.sort_rate as 分拣扫描率
				,a5.self_effect as 自有人效
				,a5.other_effect as 支援人效
			from
				(# 支援网点 当日支援的快递员和仓管数
			        select
			            sp.store_id
						,count(distinct case when sp.job_title_id in(13,110,1000) then sp.staff_info_id else null end) as support_courier_count
						,count(distinct case when sp.job_title_id=37 then sp.staff_info_id else null end) as support_dco_staff_count
			        from support sp
			        group by  sp.store_id
			    ) sp
			join
				(# 应派&当日妥投
			        select
						sbd.dst_store_id
			            ,count(distinct sbd.pno) as should_delivery_pno
			            ,count(distinct case when pi.finished_at is not null and pi.state=5 then pi.pno else null end) as finished_pno
						,count(distinct if(pi.state != 5 and ( pi.exhibition_weight > 5000 or pi.exhibition_length + pi.exhibition_width + pi.exhibition_height > 80 ), pi.pno, null)) no_del_big_count
					from dwm.dwd_ph_dc_should_be_delivery sbd
					join ph_staging.parcel_info pi on sbd.pno=pi.pno
					where sbd.should_delevry_type != '非当日应派'
					group by 1
			    )sbd on sbd.dst_store_id=sp.store_id
			left join
				(# 当日本网点出勤快递员和仓管
					select
					    hsi.sys_store_id
					    ,count(distinct if(hsi.job_title in (13,110,1000) and sup1.staff_info_id is null, hsi.staff_info_id, null)) self_courier_count
					    ,count(distinct if(hsi.job_title in (37) and sup1.staff_info_id is null, hsi.staff_info_id, null)) self_dco_count
					from ph_bi.hr_staff_info hsi
					join ph_backyard.staff_work_attendance swa on swa.staff_info_id = hsi.staff_info_id
					left join support sup1 on sup1.staff_info_id = hsi.staff_info_id
					where swa.attendance_date =current_date
					  and (swa.started_at is not null or swa.end_at is not null)
					group by 1
				)hsi on sbd.dst_store_id=hsi.sys_store_id
			left join
				(# 本网点员工应分拣扫描和实际分拣扫描量
				    select
				        ds.dst_store_id
				        ,count(distinct ds.pno) ds_count
				        ,count(distinct if(pr.pno is not null , ds.pno, null)) sort_count
				        ,count(distinct if(pr.pno is not null , ds.pno, null))/count(distinct ds.pno) sort_rate
				    from dwm.dwd_ph_dc_should_be_delivery ds
				    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'SORTING_SCAN' and pr.routed_at >= date_sub(current_date, interval 8 hour) and pr.routed_at < date_add(current_date, interval 16 hour)
				    group by 1
				) a4 on a4.dst_store_id = sbd.dst_store_id
			left join
			    (# 网点自有员工人效&支援员工人效
			        select
			            ds.dst_store_id
			            ,count(distinct if(hsi.staff_info_id is not null, ds.pno, null))/count(distinct if(hsi.staff_info_id is not null, pi.ticket_delivery_staff_info_id, null)) self_effect #自有员工人效
			            ,count(distinct if(s1.staff_info_id is not null, ds.pno, null))/count(distinct if(s1.staff_info_id is not null, pi.ticket_delivery_staff_info_id, null)) other_effect #支援员工人效
			        from dwm.dwd_ph_dc_should_be_delivery ds
			        join ph_staging.parcel_info pi on pi.pno = ds.pno
			        left join support s1 on s1.store_id = ds.dst_store_id and pi.ticket_delivery_staff_info_id = s1.staff_info_id
			        left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.formal =1  and hsi.sys_store_id = ds.dst_store_id
			        where
			            pi.state = 5
			            and pi.finished_at >= date_sub(current_date, interval 8 hour)
			            and pi.finished_at < date_add(current_date, interval 16 hour)
			            and pi.returned = 0
			        group by 1
			    ) a5 on a5.dst_store_id = sbd.dst_store_id
        )f2  on f1.store_id=f2.dst_store_id

 order by 3;
;-- -. . -..- - / . -. - .-. -.--
select
		    hsa.store_id
		    ,hsa.store_name
		    ,hsa.staff_info_id
		    ,hsa.staff_store_id
		    ,hsa.job_title_id
		    ,hsa.employment_begin_date
		    ,hsa.employment_end_date
		    ,hsa.actual_begin_date
			,hsa.actual_end_date
			,hsa.shift_start
	        ,swa.started_at
			,hsa.shift_end
	        ,hsa.data_source
		from ph_backyard.hr_staff_apply_support_store hsa
		join  ph_backyard.staff_work_attendance swa on hsa.staff_info_id = swa.staff_info_id and swa.attendance_date =current_date
		join ph_bi.hr_staff_info hsi on hsi.staff_info_id =hsa.staff_info_id
		where
		    hsi.formal=1
		    and hsa.employment_end_date>=current_date
		    and hsa.employment_begin_date <= curdate()
	        and hsa.status = 2
# 			and (swa.started_at is not null or swa.end_at is not null)
			and hsi.job_title in (13,110,1000,37);
;-- -. . -..- - / . -. - .-. -.--
select
		    hsa.store_id
		    ,hsa.store_name
		    ,hsa.staff_info_id
		    ,hsa.staff_store_id
		    ,hsa.job_title_id
		    ,hsa.employment_begin_date
		    ,hsa.employment_end_date
		    ,hsa.actual_begin_date
			,hsa.actual_end_date
			,hsa.shift_start
	        ,swa.started_at
			,hsa.shift_end
	        ,hsa.data_source
		from ph_backyard.hr_staff_apply_support_store hsa
		join  ph_backyard.staff_work_attendance swa on hsa.staff_info_id = swa.staff_info_id and swa.attendance_date =current_date
		join ph_bi.hr_staff_info hsi on hsi.staff_info_id =hsa.staff_info_id
		where
		    hsi.formal=1
		    and hsa.employment_end_date>=current_date
		    and hsa.employment_begin_date <= curdate()
	        and hsa.status = 2
	        and hsa.support_status in (2.3)
# 			and (swa.started_at is not null or swa.end_at is not null)
			and hsi.job_title in (13,110,1000,37);
;-- -. . -..- - / . -. - .-. -.--
select
		    hsa.store_id
		    ,hsa.store_name
		    ,hsa.staff_info_id
		    ,hsa.staff_store_id
		    ,hsa.job_title_id
		    ,hsa.employment_begin_date
		    ,hsa.employment_end_date
		    ,hsa.actual_begin_date
			,hsa.actual_end_date
			,hsa.shift_start
	        ,swa.started_at
			,hsa.shift_end
	        ,hsa.data_source
	        ,hsa.support_status
		from ph_backyard.hr_staff_apply_support_store hsa
		join  ph_backyard.staff_work_attendance swa on hsa.staff_info_id = swa.staff_info_id and swa.attendance_date =current_date
		join ph_bi.hr_staff_info hsi on hsi.staff_info_id =hsa.staff_info_id
		where
		    hsi.formal=1
		    and hsa.employment_end_date>=current_date
		    and hsa.employment_begin_date <= curdate()
	        and hsa.status = 2
# 	        and hsa.support_status in (2.3)
# 			and (swa.started_at is not null or swa.end_at is not null)
			and hsi.job_title in (13,110,1000,37);
;-- -. . -..- - / . -. - .-. -.--
select
		    hsa.store_id
		    ,hsa.store_name
		    ,hsa.staff_info_id
		    ,hsa.staff_store_id
		    ,hsa.job_title_id
		    ,hsa.employment_begin_date
		    ,hsa.employment_end_date
		    ,hsa.actual_begin_date
			,hsa.actual_end_date
			,hsa.shift_start
	        ,swa.started_at
			,hsa.shift_end
	        ,hsa.data_source
	        ,hsa.support_status
		from ph_backyard.hr_staff_apply_support_store hsa
		join  ph_backyard.staff_work_attendance swa on hsa.staff_info_id = swa.staff_info_id and swa.attendance_date =current_date
		join ph_bi.hr_staff_info hsi on hsi.staff_info_id =hsa.staff_info_id
		where
		    hsi.formal=1
		    and hsa.employment_end_date>=current_date
		    and hsa.employment_begin_date <= curdate()
	        and hsa.status = 2
	        and hsa.support_status in (2.3)
# 			and (swa.started_at is not null or swa.end_at is not null)
			and hsi.job_title in (13,110,1000,37);
;-- -. . -..- - / . -. - .-. -.--
with support as
    (# 系统申请支援---1BY申请支援+2HCM批量导入支援'
	    select
		    hsa.store_id
		    ,hsa.store_name
		    ,hsa.staff_info_id
		    ,hsa.staff_store_id
		    ,hsa.job_title_id
		    ,hsa.employment_begin_date
		    ,hsa.employment_end_date
		    ,hsa.actual_begin_date
			,hsa.actual_end_date
			,hsa.shift_start
	        ,swa.started_at
			,hsa.shift_end
	        ,hsa.data_source
	        ,hsa.support_status
		from ph_backyard.hr_staff_apply_support_store hsa
		join  ph_backyard.staff_work_attendance swa on hsa.staff_info_id = swa.staff_info_id and swa.attendance_date =current_date
		join ph_bi.hr_staff_info hsi on hsi.staff_info_id =hsa.staff_info_id
		where
		    hsi.formal=1
		    and hsa.employment_end_date>=current_date
		    and hsa.employment_begin_date <= curdate()
	        and hsa.status = 2
	        and hsa.support_status between 2 and 3
# 			and (swa.started_at is not null or swa.end_at is not null)
			and hsi.job_title in (13,110,1000,37)
    )
, total as
(
    select
        a.*
    from
        (
            select
                a1.dst_store_id
                ,a1.pno
                ,a1.third_sorting_code
                ,td.created_at td_time
                ,td.staff_info_id
                ,pi.state
                ,pi.finished_at
                ,pi.ticket_delivery_staff_info_id
                ,row_number() over (partition by td.pno order by td.created_at desc ) rn
            from
                (
                    select
                        a.*
                    from
                        (
                            select
                                ds.pno
                                ,ds.dst_store_id
                                ,ps.third_sorting_code
                                ,row_number() over (partition by ps.pno order by ps.created_at desc ) rk
                            from dwm.dwd_ph_dc_should_be_delivery ds
                            join ph_drds.parcel_sorting_code_info ps on ds.pno =  ps.pno and ds.dst_store_id = ps.dst_store_id
                        ) a
                    where
                        a.rk = 1
                ) a1
            join ph_staging.ticket_delivery td on td.pno = a1.pno and td.created_at >=  date_sub(current_date, interval 8 hour) and td.created_at < date_add(current_date, interval 16 hour)
            left join ph_staging.parcel_info pi on pi.pno = a1.pno
        ) a
    where
        a.rn = 1
)



select
        f1.大区
        ,f1.片区
		,f1.网点
        ,f1.支援网点负责人 as 负责人
		,f2.当日应派
        ,f2.当日妥投
        ,f2.未妥投大件数量
        ,f2.自有快递员人数
        ,f2.支援人数
        ,f2.自有仓管
        ,f2.支援仓管
        ,f2.分拣扫描率
        ,f2.自有人效
        ,f2.支援人效
        ,f1.原大区
        ,f1.原片区
		,f1.原网点
        ,f1.原网点负责人
		,f1.参与支援人ID
		,f1.快递员类型
		,f1.上班时间
		,f1.下班时间
     	,f1.揽收量
		,f1.交接量
		,f1.妥投量
		,f1.派送时长
		,f1.交接三段码数量
		,f1.妥投三段码数量
		,f1.未妥投中打电话次数为0的数量
		,f1.未妥投中打电话次数为1的数量

    from
     (
        select
			dp.store_name as 网点
			,dp.piece_name as 片区
			,dp.region_name as 大区
            ,dp1.store_name as 原网点
			,dp1.piece_name as 原片区
			,dp1.region_name as 原大区
		    ,case
			    when dp.region_name in ( 'Area6','Area15') then '徐加文'
			    when dp.region_name in ('Area4') then '韩钥'
			    when dp.region_name in ('Area7','Area10', 'Area11','FHome','Area14') then '张可新'
			    when dp.region_name in ( 'Area8') then '黄勇'
			    when dp.region_name in ('Area1', 'Area2','Area3','Area5', 'Area9', 'Area12','Area13','Area16') then '李俊'
            end 支援网点负责人
            ,case
			    when dp1.region_name in ( 'Area6','Area15') then '徐加文'
			    when dp1.region_name in ('Area4') then '韩钥'
			    when dp1.region_name in ('Area7','Area10', 'Area11','FHome','Area14') then '张可新'
			    when dp1.region_name in ( 'Area8') then '黄勇'
			    when dp1.region_name in ('Area1', 'Area2','Area3','Area5', 'Area9', 'Area12','Area13','Area16') then '李俊'
            end 原网点负责人
		    ,sp.staff_info_id as 参与支援人ID
            ,sp.store_id
		    ,case when sp.job_title_id=13 then 'bike' when sp.job_title_id=110 then 'van' when sp.job_title_id=1000 then 'Tricycle'  else 'dco' end as 快递员类型
			,ad.attendance_started_at as 上班时间
			,ad.attendance_end_at as 下班时间
			,s2.scan_count 交接量
		    ,s2.del_count 妥投量
		    ,fk.pickup_pno_cn as 揽收量
		    ,timestampdiff(minute ,fir.finished_at, las.finished_at)/60 派送时长
		    ,code.scan_code_count 交接三段码数量
		    ,code.del_code_num 妥投三段码数量
		    ,pho.0_count 未妥投中打电话次数为0的数量
		    ,pho.1_count 未妥投中打电话次数为1的数量
		from support sp
		left join dwm.dim_ph_sys_store_rd dp on dp.store_id = sp.store_id and dp.stat_date =date_sub(current_date,interval 1 day) # 支援网点组织架构
		left join dwm.dim_ph_sys_store_rd dp1 on dp1.store_id = sp.staff_store_id and dp1.stat_date =date_sub(current_date,interval 1 day)# 原网点组织架构
		left join ph_bi.attendance_data_v2 ad on sp.staff_info_id=ad.staff_info_id and ad.stat_date  =current_date
		left join
		    (
		        select
		            t1.staff_info_id
		            ,count(distinct t1.pno) scan_count
		            ,count(if(t1.state = 5, t1.pno, null)) del_count
		        from total t1
		        group by 1
		    ) s2 on s2.staff_info_id =sp.staff_info_id
		left join
		    ( -- 第一次妥投时间
		        select
		            t1.*
		            ,row_number() over (partition by t1.staff_info_id order by t1.finished_at ) rk
		        from total t1
		        where
		            t1.state = 5
		    ) fir on fir.staff_info_id = sp.staff_info_id and fir.rk = 1
		left join
		    (
		        select
		            t1.*
		            ,row_number() over (partition by t1.staff_info_id order by t1.finished_at desc ) rk
		        from total t1
		        where
		            t1.state = 5
		    ) las on las.staff_info_id = sp.staff_info_id and las.rk = 2
		left join
		    (
		        select
		            t1.staff_info_id
		            ,count(distinct t1.third_sorting_code) scan_code_count
		            ,count(distinct if(t1.state = 5, t1.third_sorting_code, null)) del_code_num
		        from total t1
		        where
		            t1.third_sorting_code not in ('XX', 'YY', 'ZZ', '00', '88')
		        group by 1
		    ) code on code.staff_info_id = sp.staff_info_id
		left join
		    (
		        select
		            a.staff_info_id
		            ,count(if(a.call_times = 0, a.pno, null)) 0_count
		            ,count(if(a.call_times = 1, a.pno, null)) 1_count
		        from
		            (
		                select
		                    t.staff_info_id
		                    ,t.pno
		                    ,count(pr.pno) call_times
		                from total t
		                left join ph_staging.parcel_route pr on pr.pno = t.pno and pr.route_action = 'PHONE'  and pr.routed_at >=  date_sub(current_date, interval 8 hour) and pr.routed_at < date_add(current_date, interval 16 hour)
		                where
		                    t.state != 5
		                group by 1,2
		            ) a
		        group by 1
		    ) pho on pho.staff_info_id = sp.staff_info_id
		left join
		    ( #揽收量
		        select
		            pi.ticket_pickup_staff_info_id
		            ,count(distinct pi.pno) as pickup_pno_cn
		        from ph_staging.parcel_info pi
		        where pi.state <9
		        and pi.created_at >=  date_sub(current_date, interval 8 hour)
		        and pi.created_at < date_add(current_date, interval 16 hour)
		    ) fk on fk.ticket_pickup_staff_info_id = sp.staff_info_id
		where sp.job_title_id in(13,110,10000)
    )f1
    left join
        (
            select
			     sbd.dst_store_id
			    ,sbd.should_delivery_pno as 当日应派
				,sbd.finished_pno as 当日妥投
				,sbd.no_del_big_count as 未妥投大件数量
			    ,hsi.self_courier_count as 自有快递员人数
				,sp.support_courier_count as 支援人数
			    ,hsi.self_dco_count as 自有仓管
				,sp.support_dco_staff_count  as 支援仓管
				,a4.sort_rate as 分拣扫描率
				,a5.self_effect as 自有人效
				,a5.other_effect as 支援人效
			from
				(# 支援网点 当日支援的快递员和仓管数
			        select
			            sp.store_id
						,count(distinct case when sp.job_title_id in(13,110,1000) then sp.staff_info_id else null end) as support_courier_count
						,count(distinct case when sp.job_title_id=37 then sp.staff_info_id else null end) as support_dco_staff_count
			        from support sp
			        group by  sp.store_id
			    ) sp
			join
				(# 应派&当日妥投
			        select
						sbd.dst_store_id
			            ,count(distinct sbd.pno) as should_delivery_pno
			            ,count(distinct case when pi.finished_at is not null and pi.state=5 then pi.pno else null end) as finished_pno
						,count(distinct if(pi.state != 5 and ( pi.exhibition_weight > 5000 or pi.exhibition_length + pi.exhibition_width + pi.exhibition_height > 80 ), pi.pno, null)) no_del_big_count
					from dwm.dwd_ph_dc_should_be_delivery sbd
					join ph_staging.parcel_info pi on sbd.pno=pi.pno
					where sbd.should_delevry_type != '非当日应派'
					group by 1
			    )sbd on sbd.dst_store_id=sp.store_id
			left join
				(# 当日本网点出勤快递员和仓管
					select
					    hsi.sys_store_id
					    ,count(distinct if(hsi.job_title in (13,110,1000) and sup1.staff_info_id is null, hsi.staff_info_id, null)) self_courier_count
					    ,count(distinct if(hsi.job_title in (37) and sup1.staff_info_id is null, hsi.staff_info_id, null)) self_dco_count
					from ph_bi.hr_staff_info hsi
					join ph_backyard.staff_work_attendance swa on swa.staff_info_id = hsi.staff_info_id
					left join support sup1 on sup1.staff_info_id = hsi.staff_info_id
					where swa.attendance_date =current_date
					  and (swa.started_at is not null or swa.end_at is not null)
					group by 1
				)hsi on sbd.dst_store_id=hsi.sys_store_id
			left join
				(# 本网点员工应分拣扫描和实际分拣扫描量
				    select
				        ds.dst_store_id
				        ,count(distinct ds.pno) ds_count
				        ,count(distinct if(pr.pno is not null , ds.pno, null)) sort_count
				        ,count(distinct if(pr.pno is not null , ds.pno, null))/count(distinct ds.pno) sort_rate
				    from dwm.dwd_ph_dc_should_be_delivery ds
				    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'SORTING_SCAN' and pr.routed_at >= date_sub(current_date, interval 8 hour) and pr.routed_at < date_add(current_date, interval 16 hour)
				    group by 1
				) a4 on a4.dst_store_id = sbd.dst_store_id
			left join
			    (# 网点自有员工人效&支援员工人效
			        select
			            ds.dst_store_id
			            ,count(distinct if(hsi.staff_info_id is not null, ds.pno, null))/count(distinct if(hsi.staff_info_id is not null, pi.ticket_delivery_staff_info_id, null)) self_effect #自有员工人效
			            ,count(distinct if(s1.staff_info_id is not null, ds.pno, null))/count(distinct if(s1.staff_info_id is not null, pi.ticket_delivery_staff_info_id, null)) other_effect #支援员工人效
			        from dwm.dwd_ph_dc_should_be_delivery ds
			        join ph_staging.parcel_info pi on pi.pno = ds.pno
			        left join support s1 on s1.store_id = ds.dst_store_id and pi.ticket_delivery_staff_info_id = s1.staff_info_id
			        left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.formal =1  and hsi.sys_store_id = ds.dst_store_id
			        where
			            pi.state = 5
			            and pi.finished_at >= date_sub(current_date, interval 8 hour)
			            and pi.finished_at < date_add(current_date, interval 16 hour)
			            and pi.returned = 0
			        group by 1
			    ) a5 on a5.dst_store_id = sbd.dst_store_id
        )f2  on f1.store_id=f2.dst_store_id

 order by 3;
;-- -. . -..- - / . -. - .-. -.--
with support as
    (# 系统申请支援---1BY申请支援+2HCM批量导入支援'
	    select
		    hsa.store_id
		    ,hsa.store_name
		    ,hsa.staff_info_id
		    ,hsa.staff_store_id
		    ,hsa.job_title_id
		    ,hsa.employment_begin_date
		    ,hsa.employment_end_date
		    ,hsa.actual_begin_date
			,hsa.actual_end_date
			,hsa.shift_start
	        ,swa.started_at
			,hsa.shift_end
	        ,hsa.data_source
	        ,hsa.support_status
		from ph_backyard.hr_staff_apply_support_store hsa
		join  ph_backyard.staff_work_attendance swa on hsa.staff_info_id = swa.staff_info_id and swa.attendance_date =current_date
		join ph_bi.hr_staff_info hsi on hsi.staff_info_id =hsa.staff_info_id
		where
		    hsi.formal=1
		    and hsa.employment_end_date>=current_date
		    and hsa.employment_begin_date <= curdate()
	        and hsa.status = 2
	        and hsa.support_status between 2 and 3
# 			and (swa.started_at is not null or swa.end_at is not null)
			and hsi.job_title in (13,110,1000,37)
    )
, total as
(
    select
        a.*
    from
        (
            select
                a1.dst_store_id
                ,a1.pno
                ,a1.third_sorting_code
                ,td.created_at td_time
                ,td.staff_info_id
                ,pi.state
                ,pi.finished_at
                ,pi.ticket_delivery_staff_info_id
                ,row_number() over (partition by td.pno order by td.created_at desc ) rn
            from
                (
                    select
                        a.*
                    from
                        (
                            select
                                ds.pno
                                ,ds.dst_store_id
                                ,ps.third_sorting_code
                                ,row_number() over (partition by ps.pno order by ps.created_at desc ) rk
                            from dwm.dwd_ph_dc_should_be_delivery ds
                            join ph_drds.parcel_sorting_code_info ps on ds.pno =  ps.pno and ds.dst_store_id = ps.dst_store_id
                        ) a
                    where
                        a.rk = 1
                ) a1
            join ph_staging.ticket_delivery td on td.pno = a1.pno and td.created_at >=  date_sub(current_date, interval 8 hour) and td.created_at < date_add(current_date, interval 16 hour)
            left join ph_staging.parcel_info pi on pi.pno = a1.pno
        ) a
    where
        a.rn = 1
)



select
        f1.大区
        ,f1.片区
		,f1.网点
        ,f1.支援网点负责人 as 负责人
		,f2.当日应派
        ,f2.当日妥投
        ,f2.未妥投大件数量
        ,f2.自有快递员人数
        ,f2.支援人数
        ,f2.自有仓管
        ,f2.支援仓管
        ,f2.分拣扫描率
        ,f2.自有人效
        ,f2.支援人效
        ,f1.原大区
        ,f1.原片区
		,f1.原网点
        ,f1.原网点负责人
		,f1.参与支援人ID
		,f1.快递员类型
		,f1.上班时间
		,f1.下班时间
     	,f1.揽收量
		,f1.交接量
		,f1.妥投量
		,f1.派送时长
		,f1.交接三段码数量
		,f1.妥投三段码数量
		,f1.未妥投中打电话次数为0的数量
		,f1.未妥投中打电话次数为1的数量

    from
     (
        select
			dp.store_name as 网点
			,dp.piece_name as 片区
			,dp.region_name as 大区
            ,dp1.store_name as 原网点
			,dp1.piece_name as 原片区
			,dp1.region_name as 原大区
		    ,case
			    when dp.region_name in ( 'Area6','Area15') then '徐加文'
			    when dp.region_name in ('Area4') then '韩钥'
			    when dp.region_name in ('Area7','Area10', 'Area11','FHome','Area14') then '张可新'
			    when dp.region_name in ( 'Area8') then '黄勇'
			    when dp.region_name in ('Area1', 'Area2','Area3','Area5', 'Area9', 'Area12','Area13','Area16') then '李俊'
            end 支援网点负责人
            ,case
			    when dp1.region_name in ( 'Area6','Area15') then '徐加文'
			    when dp1.region_name in ('Area4') then '韩钥'
			    when dp1.region_name in ('Area7','Area10', 'Area11','FHome','Area14') then '张可新'
			    when dp1.region_name in ( 'Area8') then '黄勇'
			    when dp1.region_name in ('Area1', 'Area2','Area3','Area5', 'Area9', 'Area12','Area13','Area16') then '李俊'
            end 原网点负责人
		    ,sp.staff_info_id as 参与支援人ID
            ,sp.store_id
		    ,case when sp.job_title_id=13 then 'bike' when sp.job_title_id=110 then 'van' when sp.job_title_id=1000 then 'Tricycle'  else 'dco' end as 快递员类型
			,ad.attendance_started_at as 上班时间
			,ad.attendance_end_at as 下班时间
			,s2.scan_count 交接量
		    ,s2.del_count 妥投量
		    ,fk.pickup_pno_cn as 揽收量
		    ,timestampdiff(minute ,fir.finished_at, las.finished_at)/60 派送时长
		    ,code.scan_code_count 交接三段码数量
		    ,code.del_code_num 妥投三段码数量
		    ,pho.0_count 未妥投中打电话次数为0的数量
		    ,pho.1_count 未妥投中打电话次数为1的数量
		from support sp
		left join dwm.dim_ph_sys_store_rd dp on dp.store_id = sp.store_id and dp.stat_date =date_sub(current_date,interval 1 day) # 支援网点组织架构
		left join dwm.dim_ph_sys_store_rd dp1 on dp1.store_id = sp.staff_store_id and dp1.stat_date =date_sub(current_date,interval 1 day)# 原网点组织架构
		left join ph_bi.attendance_data_v2 ad on sp.staff_info_id=ad.staff_info_id and ad.stat_date  =current_date
		left join
		    (
		        select
		            t1.staff_info_id
		            ,count(distinct t1.pno) scan_count
		            ,count(if(t1.state = 5, t1.pno, null)) del_count
		        from total t1
		        group by 1
		    ) s2 on s2.staff_info_id =sp.staff_info_id
		left join
		    ( -- 第一次妥投时间
		        select
		            t1.*
		            ,row_number() over (partition by t1.staff_info_id order by t1.finished_at ) rk
		        from total t1
		        where
		            t1.state = 5
		    ) fir on fir.staff_info_id = sp.staff_info_id and fir.rk = 1
		left join
		    (
		        select
		            t1.*
		            ,row_number() over (partition by t1.staff_info_id order by t1.finished_at desc ) rk
		        from total t1
		        where
		            t1.state = 5
		    ) las on las.staff_info_id = sp.staff_info_id and las.rk = 2
		left join
		    (
		        select
		            t1.staff_info_id
		            ,count(distinct t1.third_sorting_code) scan_code_count
		            ,count(distinct if(t1.state = 5, t1.third_sorting_code, null)) del_code_num
		        from total t1
		        where
		            t1.third_sorting_code not in ('XX', 'YY', 'ZZ', '00', '88')
		        group by 1
		    ) code on code.staff_info_id = sp.staff_info_id
		left join
		    (
		        select
		            a.staff_info_id
		            ,count(if(a.call_times = 0, a.pno, null)) 0_count
		            ,count(if(a.call_times = 1, a.pno, null)) 1_count
		        from
		            (
		                select
		                    t.staff_info_id
		                    ,t.pno
		                    ,count(pr.pno) call_times
		                from total t
		                left join ph_staging.parcel_route pr on pr.pno = t.pno and pr.route_action = 'PHONE'  and pr.routed_at >=  date_sub(current_date, interval 8 hour) and pr.routed_at < date_add(current_date, interval 16 hour)
		                where
		                    t.state != 5
		                group by 1,2
		            ) a
		        group by 1
		    ) pho on pho.staff_info_id = sp.staff_info_id
		left join
		    ( #揽收量
		        select
		            pi.ticket_pickup_staff_info_id
		            ,count(distinct pi.pno) as pickup_pno_cn
		        from ph_staging.parcel_info pi
		        where pi.state <9
		        and pi.created_at >=  date_sub(current_date, interval 8 hour)
		        and pi.created_at < date_add(current_date, interval 16 hour)
		    ) fk on fk.ticket_pickup_staff_info_id = sp.staff_info_id
		where sp.job_title_id in(13,110,1000)
    )f1
    left join
        (
            select
			     sbd.dst_store_id
			    ,sbd.should_delivery_pno as 当日应派
				,sbd.finished_pno as 当日妥投
				,sbd.no_del_big_count as 未妥投大件数量
			    ,hsi.self_courier_count as 自有快递员人数
				,sp.support_courier_count as 支援人数
			    ,hsi.self_dco_count as 自有仓管
				,sp.support_dco_staff_count  as 支援仓管
				,a4.sort_rate as 分拣扫描率
				,a5.self_effect as 自有人效
				,a5.other_effect as 支援人效
			from
				(# 支援网点 当日支援的快递员和仓管数
			        select
			            sp.store_id
						,count(distinct case when sp.job_title_id in(13,110,1000) then sp.staff_info_id else null end) as support_courier_count
						,count(distinct case when sp.job_title_id=37 then sp.staff_info_id else null end) as support_dco_staff_count
			        from support sp
			        group by  sp.store_id
			    ) sp
			join
				(# 应派&当日妥投
			        select
						sbd.dst_store_id
			            ,count(distinct sbd.pno) as should_delivery_pno
			            ,count(distinct case when pi.finished_at is not null and pi.state=5 then pi.pno else null end) as finished_pno
						,count(distinct if(pi.state != 5 and ( pi.exhibition_weight > 5000 or pi.exhibition_length + pi.exhibition_width + pi.exhibition_height > 80 ), pi.pno, null)) no_del_big_count
					from dwm.dwd_ph_dc_should_be_delivery sbd
					join ph_staging.parcel_info pi on sbd.pno=pi.pno
					where sbd.should_delevry_type != '非当日应派'
					group by 1
			    )sbd on sbd.dst_store_id=sp.store_id
			left join
				(# 当日本网点出勤快递员和仓管
					select
					    hsi.sys_store_id
					    ,count(distinct if(hsi.job_title in (13,110,1000) and sup1.staff_info_id is null, hsi.staff_info_id, null)) self_courier_count
					    ,count(distinct if(hsi.job_title in (37) and sup1.staff_info_id is null, hsi.staff_info_id, null)) self_dco_count
					from ph_bi.hr_staff_info hsi
					join ph_backyard.staff_work_attendance swa on swa.staff_info_id = hsi.staff_info_id
					left join support sup1 on sup1.staff_info_id = hsi.staff_info_id
					where swa.attendance_date =current_date
					  and (swa.started_at is not null or swa.end_at is not null)
					group by 1
				)hsi on sbd.dst_store_id=hsi.sys_store_id
			left join
				(# 本网点员工应分拣扫描和实际分拣扫描量
				    select
				        ds.dst_store_id
				        ,count(distinct ds.pno) ds_count
				        ,count(distinct if(pr.pno is not null , ds.pno, null)) sort_count
				        ,count(distinct if(pr.pno is not null , ds.pno, null))/count(distinct ds.pno) sort_rate
				    from dwm.dwd_ph_dc_should_be_delivery ds
				    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'SORTING_SCAN' and pr.routed_at >= date_sub(current_date, interval 8 hour) and pr.routed_at < date_add(current_date, interval 16 hour)
				    group by 1
				) a4 on a4.dst_store_id = sbd.dst_store_id
			left join
			    (# 网点自有员工人效&支援员工人效
			        select
			            ds.dst_store_id
			            ,count(distinct if(hsi.staff_info_id is not null, ds.pno, null))/count(distinct if(hsi.staff_info_id is not null, pi.ticket_delivery_staff_info_id, null)) self_effect #自有员工人效
			            ,count(distinct if(s1.staff_info_id is not null, ds.pno, null))/count(distinct if(s1.staff_info_id is not null, pi.ticket_delivery_staff_info_id, null)) other_effect #支援员工人效
			        from dwm.dwd_ph_dc_should_be_delivery ds
			        join ph_staging.parcel_info pi on pi.pno = ds.pno
			        left join support s1 on s1.store_id = ds.dst_store_id and pi.ticket_delivery_staff_info_id = s1.staff_info_id
			        left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.formal =1  and hsi.sys_store_id = ds.dst_store_id
			        where
			            pi.state = 5
			            and pi.finished_at >= date_sub(current_date, interval 8 hour)
			            and pi.finished_at < date_add(current_date, interval 16 hour)
			            and pi.returned = 0
			        group by 1
			    ) a5 on a5.dst_store_id = sbd.dst_store_id
        )f2  on f1.store_id=f2.dst_store_id

 order by 3;
;-- -. . -..- - / . -. - .-. -.--
select
		    hsa.store_id
		    ,hsa.store_name
		    ,hsa.staff_info_id
		    ,hsa.staff_store_id
		    ,hsa.job_title_id
		    ,hsa.employment_begin_date
		    ,hsa.employment_end_date
		    ,hsa.actual_begin_date
			,hsa.actual_end_date
			,hsa.shift_start
	        ,swa.started_at
			,hsa.shift_end
	        ,hsa.data_source
	        ,hsa.support_status
		from ph_backyard.hr_staff_apply_support_store hsa
		join  ph_backyard.staff_work_attendance swa on hsa.staff_info_id = swa.staff_info_id and swa.attendance_date =current_date
		join ph_bi.hr_staff_info hsi on hsi.staff_info_id =hsa.staff_info_id
		where
		    hsi.formal=1
		    and hsa.employment_end_date>=current_date
		    and hsa.employment_begin_date <= curdate()
	        and hsa.status = 2
	        and hsa.support_status between 2 and 3
# 			and (swa.started_at is not null or swa.end_at is not null)
			and hsi.job_title in (13,110,1000,37);
;-- -. . -..- - / . -. - .-. -.--
select
		    hsa.store_id
		    ,hsa.store_name
		    ,hsa.staff_info_id
		    ,hsa.staff_store_id
		    ,hsa.job_title_id
		    ,hsa.employment_begin_date
		    ,hsa.employment_end_date
		    ,hsa.actual_begin_date
			,hsa.actual_end_date
			,hsa.shift_start
	        ,swa.started_at
			,hsa.shift_end
	        ,hsa.data_source
	        ,hsa.support_status
		from ph_backyard.hr_staff_apply_support_store hsa
		join  ph_backyard.staff_work_attendance swa on hsa.staff_info_id = swa.staff_info_id and swa.attendance_date =current_date
		join ph_bi.hr_staff_info hsi on hsi.staff_info_id =hsa.staff_info_id
		where
		    hsi.formal=1
		    and hsa.employment_end_date>=current_date
		    and hsa.employment_begin_date <= curdate()
	        and hsa.status = 2
	        and hsa.support_status between 2 and 3
# 			and (swa.started_at is not null or swa.end_at is not null)
			and hsa.job_title_id in (13,110,1000,37);
;-- -. . -..- - / . -. - .-. -.--
select
		    hsa.store_id
		    ,hsa.store_name
		    ,hsa.staff_info_id
		    ,hsa.staff_store_id
		    ,hsa.job_title_id
		    ,hsa.employment_begin_date
		    ,hsa.employment_end_date
		    ,hsa.actual_begin_date
			,hsa.actual_end_date
			,hsa.shift_start
# 	        ,swa.started_at
			,hsa.shift_end
	        ,hsa.data_source
	        ,hsa.support_status
		from ph_backyard.hr_staff_apply_support_store hsa
# 		 join  ph_backyard.staff_work_attendance swa on hsa.staff_info_id = swa.staff_info_id and swa.attendance_date =current_date
		join ph_bi.hr_staff_info hsi on hsi.staff_info_id =hsa.staff_info_id
		where
		    hsi.formal=1
		    and hsa.employment_end_date>=current_date
		    and hsa.employment_begin_date <= curdate()
	        and hsa.status = 2
	        and hsa.support_status between 2 and 3
# 			and (swa.started_at is not null or swa.end_at is not null)
			and hsa.job_title_id in (13,110,1000,37);
;-- -. . -..- - / . -. - .-. -.--
with support as
    (# 系统申请支援---1BY申请支援+2HCM批量导入支援'
	    select
		    hsa.store_id
		    ,hsa.store_name
		    ,hsa.staff_info_id
		    ,hsa.staff_store_id
		    ,hsa.job_title_id
		    ,hsa.employment_begin_date
		    ,hsa.employment_end_date
		    ,hsa.actual_begin_date
			,hsa.actual_end_date
			,hsa.shift_start
# 	        ,swa.started_at
			,hsa.shift_end
	        ,hsa.data_source
	        ,hsa.support_status
		from ph_backyard.hr_staff_apply_support_store hsa
# 		 join  ph_backyard.staff_work_attendance swa on hsa.staff_info_id = swa.staff_info_id and swa.attendance_date =current_date
		join ph_bi.hr_staff_info hsi on hsi.staff_info_id =hsa.staff_info_id
		where
		    hsi.formal=1
		    and hsa.employment_end_date>=current_date
		    and hsa.employment_begin_date <= curdate()
	        and hsa.status = 2
	        and hsa.support_status between 2 and 3
# 			and (swa.started_at is not null or swa.end_at is not null)
			and hsa.job_title_id in (13,110,1000,37)
    )
, total as
(
    select
        a.*
    from
        (
            select
                a1.dst_store_id
                ,a1.pno
                ,a1.third_sorting_code
                ,td.created_at td_time
                ,td.staff_info_id
                ,pi.state
                ,pi.finished_at
                ,pi.ticket_delivery_staff_info_id
                ,row_number() over (partition by td.pno order by td.created_at desc ) rn
            from
                (
                    select
                        a.*
                    from
                        (
                            select
                                ds.pno
                                ,ds.dst_store_id
                                ,ps.third_sorting_code
                                ,row_number() over (partition by ps.pno order by ps.created_at desc ) rk
                            from dwm.dwd_ph_dc_should_be_delivery ds
                            join ph_drds.parcel_sorting_code_info ps on ds.pno =  ps.pno and ds.dst_store_id = ps.dst_store_id
                        ) a
                    where
                        a.rk = 1
                ) a1
            join ph_staging.ticket_delivery td on td.pno = a1.pno and td.created_at >=  date_sub(current_date, interval 8 hour) and td.created_at < date_add(current_date, interval 16 hour)
            left join ph_staging.parcel_info pi on pi.pno = a1.pno
        ) a
    where
        a.rn = 1
)



select
        f1.大区
        ,f1.片区
		,f1.网点
        ,f1.支援网点负责人 as 负责人
		,f2.当日应派
        ,f2.当日妥投
        ,f2.未妥投大件数量
        ,f2.自有快递员人数
        ,f2.支援人数
        ,f2.自有仓管
        ,f2.支援仓管
        ,f2.分拣扫描率
        ,f2.自有人效
        ,f2.支援人效
        ,f1.原大区
        ,f1.原片区
		,f1.原网点
        ,f1.原网点负责人
		,f1.参与支援人ID
		,f1.快递员类型
		,f1.上班时间
		,f1.下班时间
     	,f1.揽收量
		,f1.交接量
		,f1.妥投量
		,f1.派送时长
		,f1.交接三段码数量
		,f1.妥投三段码数量
		,f1.未妥投中打电话次数为0的数量
		,f1.未妥投中打电话次数为1的数量

    from
     (
        select
			dp.store_name as 网点
			,dp.piece_name as 片区
			,dp.region_name as 大区
            ,dp1.store_name as 原网点
			,dp1.piece_name as 原片区
			,dp1.region_name as 原大区
		    ,case
			    when dp.region_name in ( 'Area6','Area15') then '徐加文'
			    when dp.region_name in ('Area4') then '韩钥'
			    when dp.region_name in ('Area7','Area10', 'Area11','FHome','Area14') then '张可新'
			    when dp.region_name in ( 'Area8') then '黄勇'
			    when dp.region_name in ('Area1', 'Area2','Area3','Area5', 'Area9', 'Area12','Area13','Area16') then '李俊'
            end 支援网点负责人
            ,case
			    when dp1.region_name in ( 'Area6','Area15') then '徐加文'
			    when dp1.region_name in ('Area4') then '韩钥'
			    when dp1.region_name in ('Area7','Area10', 'Area11','FHome','Area14') then '张可新'
			    when dp1.region_name in ( 'Area8') then '黄勇'
			    when dp1.region_name in ('Area1', 'Area2','Area3','Area5', 'Area9', 'Area12','Area13','Area16') then '李俊'
            end 原网点负责人
		    ,sp.staff_info_id as 参与支援人ID
            ,sp.store_id
		    ,case when sp.job_title_id=13 then 'bike' when sp.job_title_id=110 then 'van' when sp.job_title_id=1000 then 'Tricycle'  else 'dco' end as 快递员类型
			,ad.attendance_started_at as 上班时间
			,ad.attendance_end_at as 下班时间
			,s2.scan_count 交接量
		    ,s2.del_count 妥投量
		    ,fk.pickup_pno_cn as 揽收量
		    ,timestampdiff(minute ,fir.finished_at, las.finished_at)/60 派送时长
		    ,code.scan_code_count 交接三段码数量
		    ,code.del_code_num 妥投三段码数量
		    ,pho.0_count 未妥投中打电话次数为0的数量
		    ,pho.1_count 未妥投中打电话次数为1的数量
		from support sp
		left join dwm.dim_ph_sys_store_rd dp on dp.store_id = sp.store_id and dp.stat_date =date_sub(current_date,interval 1 day) # 支援网点组织架构
		left join dwm.dim_ph_sys_store_rd dp1 on dp1.store_id = sp.staff_store_id and dp1.stat_date =date_sub(current_date,interval 1 day)# 原网点组织架构
		left join ph_bi.attendance_data_v2 ad on sp.staff_info_id=ad.staff_info_id and ad.stat_date  =current_date
		left join
		    (
		        select
		            t1.staff_info_id
		            ,count(distinct t1.pno) scan_count
		            ,count(if(t1.state = 5, t1.pno, null)) del_count
		        from total t1
		        group by 1
		    ) s2 on s2.staff_info_id =sp.staff_info_id
		left join
		    ( -- 第一次妥投时间
		        select
		            t1.*
		            ,row_number() over (partition by t1.staff_info_id order by t1.finished_at ) rk
		        from total t1
		        where
		            t1.state = 5
		    ) fir on fir.staff_info_id = sp.staff_info_id and fir.rk = 1
		left join
		    (
		        select
		            t1.*
		            ,row_number() over (partition by t1.staff_info_id order by t1.finished_at desc ) rk
		        from total t1
		        where
		            t1.state = 5
		    ) las on las.staff_info_id = sp.staff_info_id and las.rk = 2
		left join
		    (
		        select
		            t1.staff_info_id
		            ,count(distinct t1.third_sorting_code) scan_code_count
		            ,count(distinct if(t1.state = 5, t1.third_sorting_code, null)) del_code_num
		        from total t1
		        where
		            t1.third_sorting_code not in ('XX', 'YY', 'ZZ', '00', '88')
		        group by 1
		    ) code on code.staff_info_id = sp.staff_info_id
		left join
		    (
		        select
		            a.staff_info_id
		            ,count(if(a.call_times = 0, a.pno, null)) 0_count
		            ,count(if(a.call_times = 1, a.pno, null)) 1_count
		        from
		            (
		                select
		                    t.staff_info_id
		                    ,t.pno
		                    ,count(pr.pno) call_times
		                from total t
		                left join ph_staging.parcel_route pr on pr.pno = t.pno and pr.route_action = 'PHONE'  and pr.routed_at >=  date_sub(current_date, interval 8 hour) and pr.routed_at < date_add(current_date, interval 16 hour)
		                where
		                    t.state != 5
		                group by 1,2
		            ) a
		        group by 1
		    ) pho on pho.staff_info_id = sp.staff_info_id
		left join
		    ( #揽收量
		        select
		            pi.ticket_pickup_staff_info_id
		            ,count(distinct pi.pno) as pickup_pno_cn
		        from ph_staging.parcel_info pi
		        where pi.state <9
		        and pi.created_at >=  date_sub(current_date, interval 8 hour)
		        and pi.created_at < date_add(current_date, interval 16 hour)
		    ) fk on fk.ticket_pickup_staff_info_id = sp.staff_info_id
		where sp.job_title_id in(13,110,1000)
    )f1
    left join
        (
            select
			     sbd.dst_store_id
			    ,sbd.should_delivery_pno as 当日应派
				,sbd.finished_pno as 当日妥投
				,sbd.no_del_big_count as 未妥投大件数量
			    ,hsi.self_courier_count as 自有快递员人数
				,sp.support_courier_count as 支援人数
			    ,hsi.self_dco_count as 自有仓管
				,sp.support_dco_staff_count  as 支援仓管
				,a4.sort_rate as 分拣扫描率
				,a5.self_effect as 自有人效
				,a5.other_effect as 支援人效
			from
				(# 支援网点 当日支援的快递员和仓管数
			        select
			            sp.store_id
						,count(distinct case when sp.job_title_id in(13,110,1000) then sp.staff_info_id else null end) as support_courier_count
						,count(distinct case when sp.job_title_id=37 then sp.staff_info_id else null end) as support_dco_staff_count
			        from support sp
			        group by  sp.store_id
			    ) sp
			join
				(# 应派&当日妥投
			        select
						sbd.dst_store_id
			            ,count(distinct sbd.pno) as should_delivery_pno
			            ,count(distinct case when pi.finished_at is not null and pi.state=5 then pi.pno else null end) as finished_pno
						,count(distinct if(pi.state != 5 and ( pi.exhibition_weight > 5000 or pi.exhibition_length + pi.exhibition_width + pi.exhibition_height > 80 ), pi.pno, null)) no_del_big_count
					from dwm.dwd_ph_dc_should_be_delivery sbd
					join ph_staging.parcel_info pi on sbd.pno=pi.pno
					where sbd.should_delevry_type != '非当日应派'
					group by 1
			    )sbd on sbd.dst_store_id=sp.store_id
			left join
				(# 当日本网点出勤快递员和仓管
					select
					    hsi.sys_store_id
					    ,count(distinct if(hsi.job_title in (13,110,1000) and sup1.staff_info_id is null, hsi.staff_info_id, null)) self_courier_count
					    ,count(distinct if(hsi.job_title in (37) and sup1.staff_info_id is null, hsi.staff_info_id, null)) self_dco_count
					from ph_bi.hr_staff_info hsi
					join ph_backyard.staff_work_attendance swa on swa.staff_info_id = hsi.staff_info_id
					left join support sup1 on sup1.staff_info_id = hsi.staff_info_id
					where swa.attendance_date =current_date
					  and (swa.started_at is not null or swa.end_at is not null)
					group by 1
				)hsi on sbd.dst_store_id=hsi.sys_store_id
			left join
				(# 本网点员工应分拣扫描和实际分拣扫描量
				    select
				        ds.dst_store_id
				        ,count(distinct ds.pno) ds_count
				        ,count(distinct if(pr.pno is not null , ds.pno, null)) sort_count
				        ,count(distinct if(pr.pno is not null , ds.pno, null))/count(distinct ds.pno) sort_rate
				    from dwm.dwd_ph_dc_should_be_delivery ds
				    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'SORTING_SCAN' and pr.routed_at >= date_sub(current_date, interval 8 hour) and pr.routed_at < date_add(current_date, interval 16 hour)
				    group by 1
				) a4 on a4.dst_store_id = sbd.dst_store_id
			left join
			    (# 网点自有员工人效&支援员工人效
			        select
			            ds.dst_store_id
			            ,count(distinct if(hsi.staff_info_id is not null, ds.pno, null))/count(distinct if(hsi.staff_info_id is not null, pi.ticket_delivery_staff_info_id, null)) self_effect #自有员工人效
			            ,count(distinct if(s1.staff_info_id is not null, ds.pno, null))/count(distinct if(s1.staff_info_id is not null, pi.ticket_delivery_staff_info_id, null)) other_effect #支援员工人效
			        from dwm.dwd_ph_dc_should_be_delivery ds
			        join ph_staging.parcel_info pi on pi.pno = ds.pno
			        left join support s1 on s1.store_id = ds.dst_store_id and pi.ticket_delivery_staff_info_id = s1.staff_info_id
			        left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.formal =1  and hsi.sys_store_id = ds.dst_store_id
			        where
			            pi.state = 5
			            and pi.finished_at >= date_sub(current_date, interval 8 hour)
			            and pi.finished_at < date_add(current_date, interval 16 hour)
			            and pi.returned = 0
			        group by 1
			    ) a5 on a5.dst_store_id = sbd.dst_store_id
        )f2  on f1.store_id=f2.dst_store_id

 order by 3;
;-- -. . -..- - / . -. - .-. -.--
select
    ds.pno
    ,pi.state
    ,convert_tz(pi.finished_at, '+00:00', '+08:00') 时间
    ,date(convert_tz(pi.finished_at, '+00:00', '+08:00') ) 妥投日期
from dwm.dwd_ph_dc_should_be_delivery ds
left join ph_staging.parcel_info pi on pi.pno = ds.pno
where
    ds.p_date = '2023-09-26'
    and ds.should_delevry_type not in ('非当日应派');
;-- -. . -..- - / . -. - .-. -.--
select
    ds.pno
    ,pi.state
    ,convert_tz(pi.finished_at, '+00:00', '+08:00') 时间
    ,date(convert_tz(pi.finished_at, '+00:00', '+08:00') ) 妥投日期
from dwm.dwd_ph_dc_should_be_delivery ds
left join ph_staging.parcel_info pi on pi.pno = ds.pno
where
    ds.p_date = '2023-09-26'
    and ds.should_delevry_type not in ('非当日应派')
    and ds.dst_store_id = 'PH81160200';
;-- -. . -..- - / . -. - .-. -.--
select
    dp.store_name 网点Branch
    ,dp.piece_name 片区District
    ,dp.region_name 大区Area
    ,plt.pno 运单Tracking_Number
    ,plt.client_id
    ,bc.client_name
    ,plt.created_at 任务创建时间Task_Generation_time
    ,plt.parcel_created_at 包裹揽收时间Receive_time
    ,concat(ddd.element, ddd.CN_element) 最后有效路由Last_effective_route
    ,plt.last_valid_routed_at 最后有效路由操作时间Last_effective_routing_time
    ,plt.last_valid_staff_info_id 最后有效路由操作员工Last_effective_route_operate_id
    ,ss.name 最后有效路由操作网点Last_operate_branch
from ph_bi.parcel_lose_task plt
join dwm.dwd_dim_bigClient bc on bc.client_id = plt.client_id
left join ph_bi.parcel_detail pd on pd.pno = plt.pno
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = pd.resp_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
left join dwm.dwd_dim_dict ddd on ddd.element = plt.last_valid_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.fieldname = 'route_action'
left join dwm.dim_ph_sys_store_rd dp2 on dp2.store_id = plt.last_valid_store_id and dp2.stat_date = date_sub(curdate(), interval 1 day)
left join ph_staging.sys_store ss on ss.id = plt.last_valid_store_id
where
    plt.source in (3,33)
    and plt.state in (1,2,3,4)
    and plt.created_at >= '2023-09-01';
;-- -. . -..- - / . -. - .-. -.--
with t as
(
        select
            a1.*
        from
            (
                select
                    a.*
                from
                    (
                        select
                            pi.pno
                            ,pi.returned
                            ,pi.client_id
                            ,pi.state
                            ,pi.ticket_pickup_store_id
                            ,pi.dst_store_id
                            ,pi.customary_pno
                            ,pr.store_name
                            ,pr.store_id
                            ,pi.interrupt_category
                            ,pr.route_action
                            ,pr.routed_at
                            ,row_number() over (partition by pr.pno order by pr.routed_at desc) rk
                        from ph_staging.parcel_info pi
                        left join ph_staging.parcel_route pr on pr.pno = pi.pno
                        where
                            pi.state not in (5,7,8,9)
                            and pi.created_at < date_sub(now(), interval 56 hour)
                            and pi.created_at > '2023-01-01'
                            and pr.routed_at > '2023-03-01'
                            and pr.route_action in ('INVENTORY','RECEIVED' ,'RECEIVE_WAREHOUSE_SCAN', 'SORTING_SCAN', 'DELIVERY_TICKET_CREATION_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SHIPMENT_WAREHOUSE_SCAN', 'DETAIN_WAREHOUSE', 'DELIVERY_CONFIRM', 'DIFFICULTY_HANDOVER', 'DELIVERY_MARKER', 'REPLACE_PNO','SEAL', 'UNSEAL', 'STAFF_INFO_UPDATE_WEIGHT', 'STORE_KEEPER_UPDATE_WEIGHT', 'STORE_SORTER_UPDATE_WEIGHT', 'DISCARD_RETURN_BKK', 'DELIVERY_TRANSFER', 'PICKUP_RETURN_RECEIPT', 'FLASH_HOME_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SORTING_SCAN ', 'DELIVERY_PICKUP_STORE_SCAN', 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE', 'REFUND_CONFIRM', 'ACCEPT_PARCEL')
                    ) a
                where
                    a.rk = 1
            ) a1
        where
            a1.routed_at < date_sub(now(), interval 56 hour)
)
select
    t1.pno
    ,if(t1.returned = 0, '正向', '退件') 包裹流向
    ,t1.client_id
    ,case t1.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,ss2.name 揽收网点
    ,case
        when ss2.province_code in ('PH01','PH02','PH03','PH04','PH05','PH06','PH07','PH08','PH09','PH10','PH11','PH12','PH13','PH14','PH15','PH16','PH17','PH18','PH19','PH20','PH21','PH22','PH23','PH24','PH25','PH26','PH27','PH61','PH62','PH63','PH64','PH65','PH66','PH67','PH78','PH79','PH80','PH82') then 'Luzon'
        when ss2.province_code in ('PH44','PH45','PH46','PH47','PH48','PH49','PH50','PH51','PH52','PH53','PH54','PH55','PH56','PH57','PH58','PH59','PH60','PH68','PH69','PH70','PH71','PH72','PH73','PH74','PH75','PH76','PH77','PH83') then 'Mindanao'
        when ss2.province_code in ('PH81') then 'Palawan'
        when ss2.province_code in ('PH28','PH29','PH30','PH31','PH32','PH33','PH34','PH35','PH36','PH37','PH38','PH39','PH40','PH41','PH42','PH43') then 'Visayas'
    end 揽收岛屿
    ,ss3.name 目的地网点
    ,case
        when ss3.province_code in ('PH01','PH02','PH03','PH04','PH05','PH06','PH07','PH08','PH09','PH10','PH11','PH12','PH13','PH14','PH15','PH16','PH17','PH18','PH19','PH20','PH21','PH22','PH23','PH24','PH25','PH26','PH27','PH61','PH62','PH63','PH64','PH65','PH66','PH67','PH78','PH79','PH80','PH82') then 'Luzon'
        when ss3.province_code in ('PH44','PH45','PH46','PH47','PH48','PH49','PH50','PH51','PH52','PH53','PH54','PH55','PH56','PH57','PH58','PH59','PH60','PH68','PH69','PH70','PH71','PH72','PH73','PH74','PH75','PH76','PH77','PH83') then 'Mindanao'
        when ss3.province_code in ('PH81') then 'Palawan'
        when ss3.province_code in ('PH28','PH29','PH30','PH31','PH32','PH33','PH34','PH35','PH36','PH37','PH38','PH39','PH40','PH41','PH42','PH43') then 'Visayas'
    end 目的地岛屿
    ,case a2.duty_result
        when 1 then '丢失'
        when 2 then '破损'
        when 3 then '超时效'
    end 判责类型
    ,a2.updated_at 判责日期
#     ,t1.route_action
    ,case t1.route_action # 路由动作
         when 'ACCEPT_PARCEL' then '接件扫描'
         when 'ARRIVAL_GOODS_VAN_CHECK_SCAN' then '车货关联到港'
         when 'ARRIVAL_WAREHOUSE_SCAN' then '到件入仓扫描'
         when 'CANCEL_ARRIVAL_WAREHOUSE_SCAN' then '取消到件入仓扫描'
         when 'CANCEL_PARCEL' then '撤销包裹'
         when 'CANCEL_SHIPMENT_WAREHOUSE' then '取消发件出仓'
         when 'CHANGE_PARCEL_CANCEL' then '修改包裹为撤销'
         when 'CHANGE_PARCEL_CLOSE' then '修改包裹为异常关闭'
         when 'CHANGE_PARCEL_IN_TRANSIT' then '修改包裹为运输中'
         when 'CHANGE_PARCEL_INFO' then '修改包裹信息'
         when 'CHANGE_PARCEL_SIGNED' then '修改包裹为签收'
         when 'CLAIMS_CLOSE' then '理赔关闭'
         when 'CLAIMS_COMPLETE' then '理赔完成'
         when 'CLAIMS_CONTACT' then '已联系客户'
         when 'CLAIMS_TRANSFER_CS' then '转交总部cs处理'
         when 'CLOSE_ORDER' then '关闭订单'
         when 'CONTINUE_TRANSPORT' then '疑难件继续配送'
         when 'CREATE_WORK_ORDER' then '创建工单'
         when 'CUSTOMER_CHANGE_PARCEL_INFO' then '客户修改包裹信息'
         when 'CUSTOMER_OPERATING_RETURN' then '客户操作退回寄件人'
         when 'DELIVERY_CONFIRM' then '确认妥投'
         when 'DELIVERY_MARKER' then '派件标记'
         when 'DELIVERY_PICKUP_STORE_SCAN' then '自提取件扫描'
         when 'DELIVERY_TICKET_CREATION_SCAN' then '交接扫描'
         when 'DELIVERY_TRANSFER' then '派件转单'
         when 'DEPARTURE_GOODS_VAN_CK_SCAN' then '车货关联出港'
         when 'DETAIN_WAREHOUSE' then '货件留仓'
         when 'DIFFICULTY_FINISH_INDEMNITY' then '疑难件支付赔偿'
         when 'DIFFICULTY_HANDOVER' then '疑难件交接'
         when 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE' then '疑难件交接货件留仓'
         when 'DIFFICULTY_RE_TRANSIT' then '疑难件退回区域总部/重启运送'
         when 'DIFFICULTY_RETURN' then '疑难件退回寄件人'
         when 'DIFFICULTY_SEAL' then '集包异常'
         when 'DISCARD_RETURN_BKK' then '丢弃包裹的，换单后寄回BKK'
         when 'DISTRIBUTION_INVENTORY' then '分拨盘库'
         when 'DWS_WEIGHT_IMAGE' then 'DWS复秤照片'
         when 'EXCHANGE_PARCEL' then '换货'
         when 'FAKE_CANCEL_HANDLE' then '虚假撤销判责'
         when 'FLASH_HOME_SCAN' then 'FH交接扫描'
         when 'FORCE_TAKE_PHOTO' then '强制拍照路由'
         when 'HAVE_HAIR_SCAN_NO_TO' then '有发无到'
         when 'HURRY_PARCEL' then '催单'
         when 'INCOMING_CALL' then '来电接听'
         when 'INTERRUPT_PARCEL_AND_RETURN' then '中断运输并退回'
         when 'INVENTORY' then '盘库'
         when 'LOSE_PARCEL_TEAM_OPERATION' then '丢失件团队处理'
         when 'MANUAL_REMARK' then '添加备注'
         when 'MISS_PICKUP_HANDLE' then '漏包裹揽收判责'
         when 'MISSING_PARCEL_SCAN' then '丢失件包裹操作'
         when 'NOTICE_LOST_PARTS_TEAM' then '已通知丢失件团队'
         when 'PARCEL_HEADLESS_CLAIMED' then '无头件包裹已认领'
         when 'PARCEL_HEADLESS_PRINTED' then '无头件包裹已打单'
         when 'PENDING_RETURN' then '待退件'
         when 'PHONE' then '电话联系'
         when 'PICK_UP_STORE' then '待自提取件'
         when 'PICKUP_RETURN_RECEIPT' then '签回单揽收'
         when 'PRINTING' then '打印面单'
         when 'QAQC_OPERATION' then 'QAQC判责'
         when 'RECEIVE_WAREHOUSE_SCAN' then '收件入仓'
         when 'RECEIVED' then '已揽收,初始化动作，实际情况并没有作用'
         when 'REFUND_CONFIRM' then '退件妥投'
         when 'REPAIRED' then '上报问题修复路由'
         when 'REPLACE_PNO' then '换单'
         when 'REPLY_WORK_ORDER' then '回复工单'
         when 'REVISION_TIME' then '改约时间'
         when 'SEAL' then '集包'
         when 'SEAL_NUMBER_CHANGE' then '集包件数变化'
         when 'SHIPMENT_WAREHOUSE_SCAN' then '发件出仓扫描'
         when 'SORTER_WEIGHT_IMAGE' then '分拣机复秤照片'
         when 'SORTING_SCAN' then '分拣扫描'
         when 'STAFF_INFO_UPDATE_WEIGHT' then '快递员修改重量'
         when 'STORE_KEEPER_UPDATE_WEIGHT' then '仓管员复秤'
         when 'STORE_SORTER_UPDATE_WEIGHT' then '分拣机复秤'
         when 'SYSTEM_AUTO_RETURN' then '系统自动退件'
         when 'TAKE_PHOTO' then '异常打单拍照'
         when 'THIRD_EXPRESS_ROUTE' then '第三方公司路由'
         when 'THIRD_PARTY_REASON_DETAIN' then '第三方原因滞留'
         when 'TICKET_WEIGHT_IMAGE' then '揽收称重照片'
         when 'TRANSFER_LOST_PARTS_TEAM' then '已转交丢失件团队'
         when 'TRANSFER_QAQC' then '转交QAQC处理'
         when 'UNSEAL' then '拆包'
         when 'UNSEAL_NO_PARCEL' then '上报包裹不在集包里'
         when 'UNSEAL_NOT_SCANNED' then '集包已拆包，本包裹未被扫描'
         when 'VEHICLE_ACCIDENT_REG' then '车辆车祸登记'
         when 'VEHICLE_ACCIDENT_REGISTRATION' then '车辆车祸登记'
         when 'VEHICLE_WET_DAMAGE_REG' then '车辆湿损登记'
         when 'VEHICLE_WET_DAMAGE_REGISTRATION' then '车辆湿损登记'
    end as 最后一次有效路由操作
    ,t1.store_name 最后一次有效路由网点
    ,convert_tz(ss.routed_at, '+00:00', '+08:00') 到达网点时间
    ,date(convert_tz(t1.routed_at, '+00:00', '+08:00')) 最后一次有效路由时间
    ,timestampdiff(hour, convert_tz(t1.routed_at, '+00:00', '+08:00'), now()) 最近一次有效路由至今小时数
    ,if(t1.returned = 0, dai.delivery_attempt_num, dai.returned_delivery_attempt_num) 尝试派送次数
    ,if(t1.interrupt_category = 3, '是', '否') 是否有待退件标记
    ,case
        when t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139') and curdate() > laz.delievey_end_date then '是'
        when t1.client_id in ('AA0131', 'AA0132') and curdate() > tik.end_date then '是'
        when t1.client_id in ('AA0090', 'AA0128','AA0089') and curdate() > sho.end_date then '是'
        when t1.client_id in ('AA0149', 'AA0148') and curdate() > she.delievey_end_date then '是'
        else null
    end 是否已经超时
    ,case
        when t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139') and curdate() > laz.delievey_end_date then datediff(curdate(), laz.delievey_end_date)
        when t1.client_id in ('AA0131', 'AA0132') and curdate() > tik.end_date then datediff(curdate(), tik.end_date)
        when t1.client_id in ('AA0090', 'AA0128','AA0089') and curdate() > sho.end_date then datediff(curdate(), sho.end_date)
        when t1.client_id in ('AA0149', 'AA0148') and curdate() > she.delievey_end_date then datediff(curdate(), she.delievey_end_date)
        else null
    end  超时天数
    ,if(t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139'), oi.insure_declare_value/100, oi.cogs_amount/100) cogs金额
    ,oi.cod_amount/100 cod金额
from t t1
left join
    (
        select
            plt.pno
            ,plt.updated_at
            ,plt.duty_result
        from ph_bi.parcel_lose_task plt
        join t t1 on t1.pno = plt.pno
        where
            plt.state = 6
    ) a2 on a2.pno = t1.pno
left join dwm.dwd_ex_ph_lazada_pno_period laz on laz.pno = t1.pno
left join dwm.dwd_ex_shopee_pno_period sho on sho.pno = t1.pno
left join dwm.dwd_ex_ph_tiktok_sla_detail tik on tik.pno = t1.pno
left join dwm.dwd_ex_ph_shein_sla_detail she on she.pno = t1.pno
left join ph_staging.delivery_attempt_info dai on dai.pno = if(t1.returned = 0, t1.pno, t1.customary_pno)
left join
    (
        select
            pr.routed_at
            ,pr.pno
            ,row_number() over (partition by pr.pno order by pr.routed_at ) rk
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno and pr.store_id = t1.store_id
        where
            pr.route_action in ('INVENTORY','RECEIVED' ,'RECEIVE_WAREHOUSE_SCAN', 'SORTING_SCAN', 'DELIVERY_TICKET_CREATION_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SHIPMENT_WAREHOUSE_SCAN', 'DETAIN_WAREHOUSE', 'DELIVERY_CONFIRM', 'DIFFICULTY_HANDOVER', 'DELIVERY_MARKER', 'REPLACE_PNO','SEAL', 'UNSEAL', 'STAFF_INFO_UPDATE_WEIGHT', 'STORE_KEEPER_UPDATE_WEIGHT', 'STORE_SORTER_UPDATE_WEIGHT', 'DISCARD_RETURN_BKK', 'DELIVERY_TRANSFER', 'PICKUP_RETURN_RECEIPT', 'FLASH_HOME_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SORTING_SCAN ', 'DELIVERY_PICKUP_STORE_SCAN', 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE', 'REFUND_CONFIRM', 'ACCEPT_PARCEL')
    ) ss on ss.pno = t1.pno and ss.rk = 1
left join ph_staging.order_info oi on oi.pno = t1.pno
left join ph_staging.sys_store ss2 on ss2.id = t1.ticket_pickup_store_id
left join ph_staging.sys_store ss3 on ss3.id = t1.dst_store_id;
;-- -. . -..- - / . -. - .-. -.--
with a as
(
    -- lazada
        select
            laz.pno
            ,laz.delievey_end_date end_date
            ,pi.returned
            ,pi.client_id
            ,pi.state
            ,pi.customary_pno
            ,pi.insure_declare_value
            ,pi.ticket_pickup_store_id
            ,pi.dst_store_id
            ,pi.interrupt_category
            ,pi.cod_amount
        from dwm.dwd_ex_ph_lazada_pno_period laz
        join ph_staging.parcel_info pi on pi.pno = laz.pno
        where
            pi.state not in (5,7,8,9)
            and laz.delievey_end_date < curdate()

        union all

        select
            sho.pno
            ,sho.end_date
            ,pi.returned
            ,pi.client_id
            ,pi.state
            ,pi.customary_pno
            ,pi.insure_declare_value
            ,pi.ticket_pickup_store_id
            ,pi.dst_store_id
            ,pi.interrupt_category
            ,pi.cod_amount
        from dwm.dwd_ex_shopee_pno_period sho
        join ph_staging.parcel_info pi on pi.pno = sho.pno
        where
            pi.state not in (5,7,8,9)
            and sho.end_date < curdate()
        -- tiktok
        union all

        select
            tik.pno
            ,tik.end_date
            ,pi.returned
            ,pi.client_id
            ,pi.state
            ,pi.customary_pno
            ,pi.insure_declare_value
            ,pi.ticket_pickup_store_id
            ,pi.dst_store_id
            ,pi.interrupt_category
            ,pi.cod_amount
        from dwm.dwd_ex_ph_tiktok_sla_detail tik
        join ph_staging.parcel_info pi on pi.pno = tik.pno
        where
            pi.state not in (5,7,8,9)
            and tik.end_date < curdate()

        union all
        -- shein
        select
            shein.pno
            ,shein.delievey_end_date
            ,pi.returned
            ,pi.client_id
            ,pi.state
            ,pi.customary_pno
            ,pi.insure_declare_value
            ,pi.ticket_pickup_store_id
            ,pi.dst_store_id
            ,pi.interrupt_category
            ,pi.cod_amount
        from dwm.dwd_ex_ph_shein_sla_detail shein
        join ph_staging.parcel_info pi on pi.pno = shein.pno
        where
            pi.state not in (5,7,8,9)
            and shein.delievey_end_date < curdate()
)
, t as
(
    select
        a1.*
    from
        (
            select
                pr.routed_at
                ,pr.route_action
                ,pr.store_name
                ,pr.store_id
                ,t1.*
                ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
            from ph_staging.parcel_route pr
            join a t1 on t1.pno = pr.pno
            where
                pr.routed_at > '2023-07-01'
                and pr.route_action in ('INVENTORY','RECEIVED' ,'RECEIVE_WAREHOUSE_SCAN', 'SORTING_SCAN', 'DELIVERY_TICKET_CREATION_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SHIPMENT_WAREHOUSE_SCAN', 'DETAIN_WAREHOUSE', 'DELIVERY_CONFIRM', 'DIFFICULTY_HANDOVER', 'DELIVERY_MARKER', 'REPLACE_PNO','SEAL', 'UNSEAL', 'STAFF_INFO_UPDATE_WEIGHT', 'STORE_KEEPER_UPDATE_WEIGHT', 'STORE_SORTER_UPDATE_WEIGHT', 'DISCARD_RETURN_BKK', 'DELIVERY_TRANSFER', 'PICKUP_RETURN_RECEIPT', 'FLASH_HOME_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SORTING_SCAN ', 'DELIVERY_PICKUP_STORE_SCAN', 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE', 'REFUND_CONFIRM', 'ACCEPT_PARCEL')
        ) a1
    where
        a1.rk = 1
) , inc as
(
    select
        pr4.pno
        ,pr4.id
        ,pr4.routed_at
        ,row_number() over (partition by pr4.pno order by pr4.routed_at desc) rk
    from ph_staging.parcel_route pr4
    join t t1 on t1.pno = pr4.pno
    where
        pr4.routed_at > '2023-07-01'
        and pr4.route_action = 'INCOMING_CALL'
)
select
    t1.pno
    ,if(t1.returned = 0, '正向', '退件') 包裹流向
    ,t1.client_id
    ,case t1.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,ss2.name 揽收网点
    ,ss3.name 目的地网点
    ,case a2.duty_result
        when 1 then '丢失'
        when 2 then '破损'
        when 3 then '超时效'
    end 判责类型
    ,a2.updated_at 判责日期
    ,case t1.route_action # 路由动作
         when 'ACCEPT_PARCEL' then '接件扫描'
         when 'ARRIVAL_GOODS_VAN_CHECK_SCAN' then '车货关联到港'
         when 'ARRIVAL_WAREHOUSE_SCAN' then '到件入仓扫描'
         when 'CANCEL_ARRIVAL_WAREHOUSE_SCAN' then '取消到件入仓扫描'
         when 'CANCEL_PARCEL' then '撤销包裹'
         when 'CANCEL_SHIPMENT_WAREHOUSE' then '取消发件出仓'
         when 'CHANGE_PARCEL_CANCEL' then '修改包裹为撤销'
         when 'CHANGE_PARCEL_CLOSE' then '修改包裹为异常关闭'
         when 'CHANGE_PARCEL_IN_TRANSIT' then '修改包裹为运输中'
         when 'CHANGE_PARCEL_INFO' then '修改包裹信息'
         when 'CHANGE_PARCEL_SIGNED' then '修改包裹为签收'
         when 'CLAIMS_CLOSE' then '理赔关闭'
         when 'CLAIMS_COMPLETE' then '理赔完成'
         when 'CLAIMS_CONTACT' then '已联系客户'
         when 'CLAIMS_TRANSFER_CS' then '转交总部cs处理'
         when 'CLOSE_ORDER' then '关闭订单'
         when 'CONTINUE_TRANSPORT' then '疑难件继续配送'
         when 'CREATE_WORK_ORDER' then '创建工单'
         when 'CUSTOMER_CHANGE_PARCEL_INFO' then '客户修改包裹信息'
         when 'CUSTOMER_OPERATING_RETURN' then '客户操作退回寄件人'
         when 'DELIVERY_CONFIRM' then '确认妥投'
         when 'DELIVERY_MARKER' then '派件标记'
         when 'DELIVERY_PICKUP_STORE_SCAN' then '自提取件扫描'
         when 'DELIVERY_TICKET_CREATION_SCAN' then '交接扫描'
         when 'DELIVERY_TRANSFER' then '派件转单'
         when 'DEPARTURE_GOODS_VAN_CK_SCAN' then '车货关联出港'
         when 'DETAIN_WAREHOUSE' then '货件留仓'
         when 'DIFFICULTY_FINISH_INDEMNITY' then '疑难件支付赔偿'
         when 'DIFFICULTY_HANDOVER' then '疑难件交接'
         when 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE' then '疑难件交接货件留仓'
         when 'DIFFICULTY_RE_TRANSIT' then '疑难件退回区域总部/重启运送'
         when 'DIFFICULTY_RETURN' then '疑难件退回寄件人'
         when 'DIFFICULTY_SEAL' then '集包异常'
         when 'DISCARD_RETURN_BKK' then '丢弃包裹的，换单后寄回BKK'
         when 'DISTRIBUTION_INVENTORY' then '分拨盘库'
         when 'DWS_WEIGHT_IMAGE' then 'DWS复秤照片'
         when 'EXCHANGE_PARCEL' then '换货'
         when 'FAKE_CANCEL_HANDLE' then '虚假撤销判责'
         when 'FLASH_HOME_SCAN' then 'FH交接扫描'
         when 'FORCE_TAKE_PHOTO' then '强制拍照路由'
         when 'HAVE_HAIR_SCAN_NO_TO' then '有发无到'
         when 'HURRY_PARCEL' then '催单'
         when 'INCOMING_CALL' then '来电接听'
         when 'INTERRUPT_PARCEL_AND_RETURN' then '中断运输并退回'
         when 'INVENTORY' then '盘库'
         when 'LOSE_PARCEL_TEAM_OPERATION' then '丢失件团队处理'
         when 'MANUAL_REMARK' then '添加备注'
         when 'MISS_PICKUP_HANDLE' then '漏包裹揽收判责'
         when 'MISSING_PARCEL_SCAN' then '丢失件包裹操作'
         when 'NOTICE_LOST_PARTS_TEAM' then '已通知丢失件团队'
         when 'PARCEL_HEADLESS_CLAIMED' then '无头件包裹已认领'
         when 'PARCEL_HEADLESS_PRINTED' then '无头件包裹已打单'
         when 'PENDING_RETURN' then '待退件'
         when 'PHONE' then '电话联系'
         when 'PICK_UP_STORE' then '待自提取件'
         when 'PICKUP_RETURN_RECEIPT' then '签回单揽收'
         when 'PRINTING' then '打印面单'
         when 'QAQC_OPERATION' then 'QAQC判责'
         when 'RECEIVE_WAREHOUSE_SCAN' then '收件入仓'
         when 'RECEIVED' then '已揽收,初始化动作，实际情况并没有作用'
         when 'REFUND_CONFIRM' then '退件妥投'
         when 'REPAIRED' then '上报问题修复路由'
         when 'REPLACE_PNO' then '换单'
         when 'REPLY_WORK_ORDER' then '回复工单'
         when 'REVISION_TIME' then '改约时间'
         when 'SEAL' then '集包'
         when 'SEAL_NUMBER_CHANGE' then '集包件数变化'
         when 'SHIPMENT_WAREHOUSE_SCAN' then '发件出仓扫描'
         when 'SORTER_WEIGHT_IMAGE' then '分拣机复秤照片'
         when 'SORTING_SCAN' then '分拣扫描'
         when 'STAFF_INFO_UPDATE_WEIGHT' then '快递员修改重量'
         when 'STORE_KEEPER_UPDATE_WEIGHT' then '仓管员复秤'
         when 'STORE_SORTER_UPDATE_WEIGHT' then '分拣机复秤'
         when 'SYSTEM_AUTO_RETURN' then '系统自动退件'
         when 'TAKE_PHOTO' then '异常打单拍照'
         when 'THIRD_EXPRESS_ROUTE' then '第三方公司路由'
         when 'THIRD_PARTY_REASON_DETAIN' then '第三方原因滞留'
         when 'TICKET_WEIGHT_IMAGE' then '揽收称重照片'
         when 'TRANSFER_LOST_PARTS_TEAM' then '已转交丢失件团队'
         when 'TRANSFER_QAQC' then '转交QAQC处理'
         when 'UNSEAL' then '拆包'
         when 'UNSEAL_NO_PARCEL' then '上报包裹不在集包里'
         when 'UNSEAL_NOT_SCANNED' then '集包已拆包，本包裹未被扫描'
         when 'VEHICLE_ACCIDENT_REG' then '车辆车祸登记'
         when 'VEHICLE_ACCIDENT_REGISTRATION' then '车辆车祸登记'
         when 'VEHICLE_WET_DAMAGE_REG' then '车辆湿损登记'
         when 'VEHICLE_WET_DAMAGE_REGISTRATION' then '车辆湿损登记'
    end as 最后一次有效路由操作
    ,t1.store_name 最后一次有效路由网点
    ,convert_tz(ss.routed_at, '+00:00', '+08:00') 到达网点时间
    ,date(convert_tz(t1.routed_at, '+00:00', '+08:00')) 最后一次有效路由时间
    ,timestampdiff(hour, convert_tz(t1.routed_at, '+00:00', '+08:00'), now()) 最近一次有效路由至今小时数
    ,if(t1.returned = 0, dai.delivery_attempt_num, dai.returned_delivery_attempt_num) 尝试派送次数
    ,if(t1.interrupt_category = 3, '是', '否') 是否有待退件标记
#     ,case
#         when t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139') and curdate() > t1.end_date then '是'
#         when t1.client_id in ('AA0131', 'AA0132') and curdate() > tik.end_date then '是'
#         when t1.client_id in ('AA0090', 'AA0128','AA0089') and curdate() > sho.end_date then '是'
#         when t1.client_id in ('AA0149', 'AA0148') and curdate() > she.delievey_end_date then '是'
#         else null
#     end 是否已经超时
    ,case
        when t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139') and curdate() > t1.end_date then datediff(curdate(), t1.end_date)
        when t1.client_id in ('AA0131', 'AA0132') and curdate() > t1.end_date then datediff(curdate(), t1.end_date)
        when t1.client_id in ('AA0090', 'AA0128','AA0089') and curdate() > t1.end_date then datediff(curdate(), t1.end_date)
        when t1.client_id in ('AA0149', 'AA0148') and curdate() > t1.end_date then datediff(curdate(), t1.end_date)
        else null
    end  超时天数
    ,if(t1.client_id in ('AA0080', 'AA0050', 'AA0121', 'AA0051', 'AA0139'), oi.insure_declare_value/100, oi.cogs_amount/100) cogs金额
    ,t1.cod_amount/100 cod金额
    ,pho.pho_count 打电话次数
    ,pho.xiangling_count 响铃未通话次数
    ,pho.tonghua_num 有效通话次数
    ,pho.8_tonghua_num 大于8秒通话次数
    ,com.in_count 呼入电话次数
    ,convert_tz(c2.routed_at, '+00:00', '+08:00') 最后一次呼入电话时间
from t t1
left join
    (
        select
            plt.pno
            ,plt.updated_at
            ,plt.duty_result
        from ph_bi.parcel_lose_task plt
        join t t1 on t1.pno = plt.pno
        where
            plt.state = 6
            and plt.created_at > '2023-07-01'
    ) a2 on a2.pno = t1.pno
left join ph_staging.delivery_attempt_info dai on dai.pno = if(t1.returned = 0, t1.pno, t1.customary_pno)
left join
    (
        select
            pr.routed_at
            ,pr.pno
            ,row_number() over (partition by pr.pno order by pr.routed_at ) rk
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno and pr.store_id = t1.store_id
        where
            pr.routed_at > '2023-07-01'
            and pr.route_action in ('INVENTORY','RECEIVED' ,'RECEIVE_WAREHOUSE_SCAN', 'SORTING_SCAN', 'DELIVERY_TICKET_CREATION_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SHIPMENT_WAREHOUSE_SCAN', 'DETAIN_WAREHOUSE', 'DELIVERY_CONFIRM', 'DIFFICULTY_HANDOVER', 'DELIVERY_MARKER', 'REPLACE_PNO','SEAL', 'UNSEAL', 'STAFF_INFO_UPDATE_WEIGHT', 'STORE_KEEPER_UPDATE_WEIGHT', 'STORE_SORTER_UPDATE_WEIGHT', 'DISCARD_RETURN_BKK', 'DELIVERY_TRANSFER', 'PICKUP_RETURN_RECEIPT', 'FLASH_HOME_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SORTING_SCAN ', 'DELIVERY_PICKUP_STORE_SCAN', 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE', 'REFUND_CONFIRM', 'ACCEPT_PARCEL')
    ) ss on ss.pno = t1.pno and ss.rk = 1
left join ph_staging.order_info oi on oi.pno = t1.pno
left join ph_staging.sys_store ss2 on ss2.id = t1.ticket_pickup_store_id
left join ph_staging.sys_store ss3 on ss3.id = t1.dst_store_id
left join
    (
        select
            a1.pno
            ,count(a1.id) pho_count
            ,count(if(a1.tonghua = 0 and a1.xiangling > 0, a1.id, null)) xiangling_count
            ,count(if(a1.tonghua > 0, a1.id, null)) tonghua_num
            ,count(if(a1.tonghua > 8, a1.id, null)) 8_tonghua_num
        from
            (
                select
                    pr2.pno
                    ,pr2.id
                    ,json_extract(pr2.extra_value, '$.callDuration') tonghua
                    ,json_extract(pr2.extra_value, '$.diaboloDuration') xiangling
                from ph_staging.parcel_route pr2
                join t t1 on pr2.pno = t1.pno
                where
                    pr2.route_action = 'PHONE'
                    and pr2.routed_at >= '2023-07-01'
            ) a1
        group by 1
    ) pho on pho.pno = t1.pno
left join
    (
        select
            c1.pno
            ,count(distinct c1.id) in_count
        from inc c1
        group by 1
    ) com on com.pno = t1.pno
left join inc c2 on c2.pno = t1.pno and c2.rk = 1;