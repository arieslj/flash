select
    hr.`staff_info_id`
    ,hr.`identity` 身份证
    ,hr.mobile 手机号
    ,hr.`company_name_ef` 外协公司
from  `ph_bi`.`hr_staff_info`  hr
where
    hr.staff_info_id in ('342157','343397','373608','391119','397554','398273','399550','400178','400590','400764','401100','401109','401135','402919','402945','402949','402959','411224','411498','411661','411682','411875','412633','416171','416173','418193','418637','419474','419521','420056','420076','420107','422994','423074','423241','423250','423272','423275','423326','423329','424414','424427','424476','424670','425000','427192','429819','429884','429961','430576','430594','430613','430749','430772','430778','434042','434102','437772','437990','438086','438179','438504','438620','438693','438756','438976','439522','440649','440675','441288','442160','443668','443677','443682','444157','445411','445514','445836','445901','445953','445991','445993','445997','445998','446016','446042','446099','446169','446287','447733','447746','448049','448076','448083','448087','448203','448272','448281','448285','448290','448327','448456','448461','448741','448742','448773','449044','450028','450057','450321','450322','450323','450360','450366','450425','450427','450432','450434','450445','450462','450466','450477','450508','450526','450547','450549','450552','450583','450602','450870','451008','451032','451071','451239','451257','451259','451286','451870','451886','451888','451890','451903','451912','451922','451927','451929','451933','451938','451942','451944','451947','451954','451965','451966','451967','452011','452012','452116','452123','452139','452140','452146','452152','452153','452161','452164','452181','452186','452192','452195','452200','452212','452220','452225','452230','452234','452246','452247','452251','452266','452268','452269','452275','452281','452293','452306','452319','452322','452327','452346','452432','452441','452443','452449','452450','452453','452461','452468','452473','452476','452482','452484','452485','452497','452498','452500','452512','452514','452519','452535','452536','452537','452538','452539','452541','452544','452547','452548','452557','452576','452585','452594','452595','452598','452606','452608','452610','452622','452636','452640','452645','452652','452653','452654','452662','452670','452672','452673','452686','452695','452700','452712','452714','452733','452735','452742','452802','452803','452817','452819','452842','452847','452848','452850','452857','452859','452870','452880','452891','452902','452919','452920','452921','452927','452929','452936','452940','452942','452946','452964','452967','452971','452974','454118','454123','454129','454142','454146','454170','454282','454370','454375','454376','454380','454381','454390','454392','454400','454405','454439','454446','454448','454456','454458','454460','454463','454473','454479','454493','454501','454507','454522','454524','455703','456063','456067','456068','456070','456071','456073','456074','456076','456078','456079','456087','456089','456094','456102','456120','456125','456127','456129','456151','456177','456179','456184','456313','456324','456334','456335','456340','456359','456361','456364','456374','456398','456412','456413','456418','456438','456456','456461','456464','456631','456647','456653','456655','456670','456724','456737','456738','456740','456745','456748','456755','456764','456772','456790','456794','456795','456798','456809','456810','456815','458213','458221','458237','458252','458256','458258','458265','458273','458276','458282','458286','458288','458307','458308','458324','458334','458486','458504','458531','458534','458545','458548','458556','458557','458601','458615','458623','458634','458640','458653','458659','458680','458683','458686','458690','458699','458713','458714','458741','458747','458750','458764','458765','458769','458773','458775','458791','458795','458812','458818','458834','458854','458873','458877','458890','458894','458898','458906','458908','458918','458936','458938','458956','458962','458966','458972','458973','458975','458976','458986','458992','459010','459024','459037','459038','459043','459055','459064','459074','459082','459095','459212','459226','459230','459232','459252','459254','459257','459258','459261','459263','459268','459342','459345','459350','459353','459360','459367','459375','459389','459394','459396','459403','459406','459409','459411','459473','459475','459494','459506','459528','459529','460143','460148','460152','460158','460172','460176','460185','460189','460194','460212','460227','460245','460263','460265','460281','460305','460315','460345','460364','460379','460380','460405','460409','460423','460439','460461','460469','460475','460482','460487','460491','460512','460518','460523','460529','460530','460533','460564','460568','460573','460584','460586','460597','460624','460625','460634','460637','460703','460705','460710','460712','460722','460725','460732','460736','460775','460780','460783')
;


-- 正式员工入职信息
select
    hr.`staff_info_id`
    ,hr.`job_title`
    ,si.`name`
    ,case hr.`state`
        when 1 then '在职'
        when 2 then '离职'
    end as state
    ,hr.`hire_date` 入职日期
from  `ph_bi`.`hr_staff_info`  hr
left join `ph_staging`.`staff_info_job_title` si
on si.`id` = hr.`job_title`
where
    hr.`staff_info_id` in
    ('124187','126680','126820','127228','131350','131834','133407','134473','135868','136881','137618','138613','139185','139349','139841','140223','142148','142571','144116','144527','145216','145971','147429','147876','148271','148342','149608','151436','151667','152189','152202','152298','153824','154022','154164','154662','155585','155774','157448','158997','159232','159288','159361','159614','160896','162329','162427','162644','163033','163126','163169','163416','163597','163598','164087','164194','164788','164961','168772','169643','171104','171822','171871','172121','172193','172558','173139','173237','174523','175227','175838','177196','177793','177979','178031','178770','178783','179551','180707','181023','181264','181616','181695','181773','181960','182355','183240','183612','183695','184593','184964','185060','185062','185227','185229','186456','186707','186756','186834','186853','187217','187376','187599','188036','188256','188742','188868','189080','189411','189592','189616','189733','189874','190558','190658','190966','191709','191785','191818','192044','192188','192197','192536','193808','193902','194036','194245','194394','194483','194950','195135','195315','195537','195559','195808','196676','196732','197058','197531','197651','198016','198299','198381','198651','198980','199118','199185','199425','199458','199495','199549','199580','199792','199818','199925','199941','200049','200132','200187','200277','200367','200609','200686','200804','200883','201634','202007','202019','202175','202226','202551','202798','202843','203151','203808','203980','204267','204479','204482','204525','205102','205103','205155','205254','205609','205652','205791','205799','206006','206013','206041','206104','206140','206201','206526','206787','206999','207191','207207','207651','207691','207771','208096','208260','208412','208485','208717','209166','209258','209541','209901','209905','209990','210013','210053','210699','210959','211125','211138','211386','211438','212219','212232','212383','212405','212991','213119','213343','213477','213912','213976','214348','214547','215245','215283','215509','215777','215803','215892','216174','216200','216484','216601','216611','216612','216636','216731','216772','217179','217637','217762','217975','217976','218226','218887','219580','219791','219965','220004','220034','220104','220118','220203','220434','220454','220465','221047','221096','221636','221813','222166','222255','222329','222516','222825','222967','223068','223093','223119','223140','223347','223356','223361','223625','223683','224323','224346','224373','225010','225063','225407','225580','225670','225781','225973','226059','226680','226773','226774','226789','227124','227774','227987','228113','228258','228261','228297','228362','228405','228528','228755','229429','230199','230672','230870','231043','231869','231997','232076','232467','232526','232758','232812','232854','233020','233043','233261','233596','233606','233854','233933','233938','234186','234298','234415','234419','234492','234796','234995','235137','235508','235597','235889','235966','235968','236451','236574','236739','236934','237002','237362','237558','237559','237884','237912','238005','238006','238258','238504','238626','238914','238940','239042','239569','239618','239643','239658','239662','239668','239674','239694','239823','239826','239831','239863','239879','239881','239926','239931','239962','240036','240077','240098','240106','240131','240294','240324','240345','240367','240489','240548','240755','240759','240765','240788','240789','240792','240824','240837','240852','240887','240967','240979','241013','241067','241129','241215','241310','241323','241362','241367','241368','241372','241420','241437','241443','241560','241692','241693','241705','241774','241781','241921','241981','241985','241991','242001','242004','242017','242026','242039','242043','242059','242060','242070','242071','242094','242095','242132','242185','242240','242319','242339','242340','242341','242342','242348','242369','242377','242397','242413','242496','242514','242551','242553','242561','242584','242627','242732','242831','242846','242869','242876','243004','243053','243071','243072','243115','243121','243122','243149','243161','243242','243244','243245','243267','243276','243302','243321','243322','243323','243366','243368','243388','243407','243429','243444','243501','243615','243641','243762','243792','243801','243944','243958','243970','243987','243996','244038','244069','244170','244226','244227','244247','244251','2000184','2000403','2000643','2000650','2000685','2000695','2000741','2000776','2000777','2000797','2000890','2000901','2000911','2000931','2000960','2000961','2000969')

;



select a.id,
date(a.date),
count( a.`pno` )
from
(
select distinct pi.`pno`, sw.ID ,date(sw.`date`) date
from tmpale.tmp_ph_ttime_0307 sw
left join `ph_staging`.`parcel_info`  pi
on pi.`ticket_delivery_staff_info_id` = sw.`id`
and convert_tz(pi.`finished_at`,'+00:00','+08:00') >=from_unixtime(sw.`ttime`)
and convert_tz(pi.`finished_at`,'+00:00','+08:00')<= date_add(sw.date,interval 1 day)
where pi.`state` =5
#and pi.`ticket_delivery_staff_info_id` ='3158683'
#and date(sw.`date` )='2022-12-03'
) a
#where a.id='3158683'
group by 1,2



;


with t as
    (
        select
            t.*
            ,hsi2.company_name_ef
            ,hsi2.identity
            ,hsi2.mobile
            ,hsi.`name`
            ,case hsi.`state`
                when 1 then '在职'
                when 2 then '离职'
            end as state
            ,hsi.hire_date
            ,hjt.job_name
            ,concat(t.sub_id, '_', date(t.sub_staff_clock_data)) p_key
            ,substring_index(substring_index(t.sub_clock_pic_id, '_', -1), '.', 1) clock_unix_time
        from tmpale.tmp_ph_fake_sub_lj t
        left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = t.staff_id
        left join ph_bi.hr_job_title hjt on hjt.id = hsi.job_title
        left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = t.sub_id
    )
select
    t1.sub_id 外协id
    ,t1.company_name_ef 外协公司
    ,t1.identity 身份证ID
    ,t1.sub_clock_pic_id 外协打卡图片id
    ,t1.region 大区
    ,t1.sim_dsitince 相似距离
    ,t1.staff_id 正式员工id
    ,t1.job_name 正式员工职位
    ,t1.hire_date 入职时间
    ,t1.staff_store 正式员工所属网点
    ,t1.sub_staff_store 外协人员所属网点
    ,t1.staff_pic 正式员工筛选底片
    ,t1.sub_clock_pic 外协打卡图片
    ,t1.sub_staff_clock_data 外协打卡时间
    ,t1.staff_clock_date 正式员工打卡日期
    ,p1.p_count 正式员工使用外协账号打卡后妥投的包裹数量
    ,if(t1.sub_staff_clock_data > t1.hire_date, 'y', 'n') 是否入职后打卡
from t t1
left join
    (
        select
            t1.sub_id
            ,date(t1.sub_staff_clock_data) p_date
            ,concat(t1.sub_id, '_', date(t1.sub_staff_clock_data)) p_key
            ,count(distinct pi.pno) p_count
        from ph_staging.parcel_info pi
        join t t1 on t1.sub_id = pi.ticket_delivery_staff_info_id
        where
            pi.state = 5
            and pi.finished_at >= date_sub(from_unixtime(t1.clock_unix_time), interval 8 hour)
            and pi.finished_at <= date_sub(date_add(t1.sub_staff_clock_data,interval 1 day), interval 8 hour )
        group by 1,2,3
    ) p1 on p1.p_key = t1.p_key