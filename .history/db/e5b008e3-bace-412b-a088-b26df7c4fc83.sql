with t as
(
    select
        de.pno
        ,de.dst_store_id
        ,de.dst_store
        ,de.dst_region
        ,de.dst_piece
        ,pi.state
        ,pi.dst_phone
        ,pi.dst_home_phone
        ,if(pcd.pno is not null , 'y', 'n') change_store
        ,max(pcd.created_at) pcd_create_at
    from dwm.dwd_ex_ph_parcel_details de
    left join ph_staging.parcel_info pi on de.pno = pi.pno
    left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
    left join ph_staging.parcel_route pr on pr.pno = de.pno and pr.route_action = 'PENDING_RETURN'
    left join ph_staging.parcel_change_detail pcd on pcd.pno = pi.pno and pcd.field_name = 'dst_store_id' and pcd.new_value != pcd.old_value
    where
        datediff(now(), de.dst_routed_at) <= 7
        and pi.state not in (5,7,8,9)
        and bc.client_id is null
        and pr.pno is null
    group by 1
)
select
    a.*
    ,b.diff_marker_category
    ,b.ppd_time '最后一次留仓/问题件时间'
from
    (
        select
            t1.pno
            ,t1.dst_store 目的地网点
            ,t1.dst_store_id 目的网点ID
            ,t1.dst_piece 目的地片区
            ,t1.dst_region 目的地大区
            ,case t1.state
                when '1' then '已揽收'
                when '2' then '运输中'
                when '3' then '派送中'
                when '4' then '已滞留'
                when '5' then '已签收'
                when '6' then '疑难件处理中'
                when '7' then '已退件'
                when '8' then '异常关闭'
                when '9' then '已撤销'
            end as `包裹状态`
            ,t1.dst_phone 收件人电话
            ,t1.dst_home_phone 收件人家庭电话
            ,count(distinct ppd.mark_date) 尝试天数
        from t t1
        left join
            (
                select
                    td.pno
                    ,date(convert_tz(tdm.created_at, '+00:00', '+08:00')) mark_date
                from ph_staging.ticket_delivery td
                join t t1 on t1.pno = td.pno
                left join ph_staging.ticket_delivery_marker tdm on tdm.delivery_id = td.id
                where
                    tdm.marker_id not in (7,22,5,20,6,21,15,71,32,69,31)
                    and if(t1.change_store = 'n', 1 = 1, tdm.created_at > t1.pcd_create_at)
                group by 1,2
            ) mark on mark.pno = t1.pno
        join
            (
                select
                    ppd.pno
                    ,date(convert_tz(ppd.created_at, '+00:00', '+08:00')) mark_date
                from ph_staging.parcel_problem_detail ppd
                join t t1 on t1.pno = ppd.pno
                where
                    if(t1.change_store = 'n', 1 = 1, ppd.created_at > t1.pcd_create_at)
                group by 1,2
            ) ppd on ppd.pno = mark.pno and mark.mark_date = ppd.mark_date
        group by 1
        having count(distinct ppd.mark_date) >= 3
    ) a
left join
    (
        select
            *
        from
            (
                select
                    ppd.pno
                    ,ppd.diff_marker_category
                    ,convert_tz(ppd.created_at, '+00:00', '+08:00') ppd_time
                    ,row_number() over (partition by ppd.pno order by ppd.created_at desc) rk
                from ph_staging.parcel_problem_detail ppd
                join t t1 on t1.pno = ppd.pno
#                 where
#                     ppd.parcel_problem_type_category = 1
            ) b
        where
            b.rk = 1
    ) b on b.pno = a.pno
where
    b.diff_marker_category != 17 -- 拒收疑难件
    or b.diff_marker_category is null
    and
        (
            case
                when hour(now()) = 9 then b.ppd_time >= date_sub(curdate(), interval 12 hour) and  b.ppd_time < date_add(curdate(), interval 1 hour) -- 9-10点
                when hour(now()) > 9 then b.ppd_time >= date_add(curdate(), interval hour(now()) - 9 hour ) and b.ppd_time < date_add(curdate(), interval hour(now())- 8 hour) -- 前一小时
                else 1 = 1
            end
        );
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        de.pno
        ,de.dst_store_id
        ,de.dst_store
        ,de.dst_region
        ,de.dst_piece
        ,pi.state
        ,pi.dst_phone
        ,pi.dst_home_phone
        ,if(pcd.pno is not null , 'y', 'n') change_store
        ,max(pcd.created_at) pcd_create_at
    from dwm.dwd_ex_ph_parcel_details de
    left join ph_staging.parcel_info pi on de.pno = pi.pno
    left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
    left join ph_staging.parcel_route pr on pr.pno = de.pno and pr.route_action = 'PENDING_RETURN'
    left join ph_staging.parcel_change_detail pcd on pcd.pno = pi.pno and pcd.field_name = 'dst_store_id' and pcd.new_value != pcd.old_value
    where
        datediff(now(), de.dst_routed_at) <= 7
        and pi.state not in (5,7,8,9)
        and bc.client_id is null
        and pr.pno is null
    group by 1
)
select
    a.*
    ,b.diff_marker_category
    ,b.ppd_time '最后一次留仓/问题件时间'
from
    (
        select
            t1.pno
            ,t1.dst_store 目的地网点
            ,t1.dst_store_id 目的网点ID
            ,t1.dst_piece 目的地片区
            ,t1.dst_region 目的地大区
            ,case t1.state
                when '1' then '已揽收'
                when '2' then '运输中'
                when '3' then '派送中'
                when '4' then '已滞留'
                when '5' then '已签收'
                when '6' then '疑难件处理中'
                when '7' then '已退件'
                when '8' then '异常关闭'
                when '9' then '已撤销'
            end as `包裹状态`
            ,t1.dst_phone 收件人电话
            ,t1.dst_home_phone 收件人家庭电话
            ,count(distinct ppd.mark_date) 尝试天数
        from t t1
        left join
            (
                select
                    td.pno
                    ,date(convert_tz(tdm.created_at, '+00:00', '+08:00')) mark_date
                from ph_staging.ticket_delivery td
                join t t1 on t1.pno = td.pno
                left join ph_staging.ticket_delivery_marker tdm on tdm.delivery_id = td.id
                where
                    tdm.marker_id not in (7,22,5,20,6,21,15,71,32,69,31)
                    and if(t1.change_store = 'n', 1 = 1, tdm.created_at > t1.pcd_create_at)
                group by 1,2
            ) mark on mark.pno = t1.pno
        join
            (
                select
                    ppd.pno
                    ,date(convert_tz(ppd.created_at, '+00:00', '+08:00')) mark_date
                from ph_staging.parcel_problem_detail ppd
                join t t1 on t1.pno = ppd.pno
                where
                    if(t1.change_store = 'n', 1 = 1, ppd.created_at > t1.pcd_create_at)
                group by 1,2
            ) ppd on ppd.pno = mark.pno and mark.mark_date = ppd.mark_date
        group by 1
        having count(distinct ppd.mark_date) >= 3
    ) a
left join
    (
        select
            *
        from
            (
                select
                    ppd.pno
                    ,ppd.diff_marker_category
                    ,convert_tz(ppd.created_at, '+00:00', '+08:00') ppd_time
                    ,row_number() over (partition by ppd.pno order by ppd.created_at desc) rk
                from ph_staging.parcel_problem_detail ppd
                join t t1 on t1.pno = ppd.pno
#                 where
#                     ppd.parcel_problem_type_category = 1
            ) b
        where
            b.rk = 1
    ) b on b.pno = a.pno
where
     ( b.diff_marker_category != 17 or b.diff_marker_category is null )
    and
        (
            case
                when hour(now()) = 9 then b.ppd_time >= date_sub(curdate(), interval 12 hour) and  b.ppd_time < date_add(curdate(), interval 1 hour) -- 9-10点
                when hour(now()) > 9 then b.ppd_time >= date_add(curdate(), interval hour(now()) - 9 hour ) and b.ppd_time < date_add(curdate(), interval hour(now())- 8 hour) -- 前一小时
                else 1 = 1
            end
        );
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        de.pno
        ,de.dst_store_id
        ,de.dst_store
        ,de.dst_region
        ,de.dst_piece
        ,pi.state
        ,pi.dst_phone
        ,pi.dst_home_phone
        ,if(pcd.pno is not null , 'y', 'n') change_store
        ,max(pcd.created_at) pcd_create_at
    from dwm.dwd_ex_ph_parcel_details de
    left join ph_staging.parcel_info pi on de.pno = pi.pno
    left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
    left join ph_staging.parcel_route pr on pr.pno = de.pno and pr.route_action = 'PENDING_RETURN'
    left join ph_staging.parcel_change_detail pcd on pcd.pno = pi.pno and pcd.field_name = 'dst_store_id' and pcd.new_value != pcd.old_value
    where
        datediff(now(), de.dst_routed_at) <= 7
        and pi.state not in (5,7,8,9)
        and bc.client_id is null
        and pr.pno is null
    group by 1
)
select
    a.*
    ,b.diff_marker_category
    ,b.ppd_time '最后一次留仓/问题件时间'
from
    (
        select
            t1.pno
            ,t1.dst_store 目的地网点
            ,t1.dst_store_id 目的网点ID
            ,t1.dst_piece 目的地片区
            ,t1.dst_region 目的地大区
            ,case t1.state
                when '1' then '已揽收'
                when '2' then '运输中'
                when '3' then '派送中'
                when '4' then '已滞留'
                when '5' then '已签收'
                when '6' then '疑难件处理中'
                when '7' then '已退件'
                when '8' then '异常关闭'
                when '9' then '已撤销'
            end as `包裹状态`
            ,t1.dst_phone 收件人电话
            ,t1.dst_home_phone 收件人家庭电话
            ,count(distinct ppd.mark_date) 尝试天数
        from t t1
        left join
            (
                select
                    td.pno
                    ,date(convert_tz(tdm.created_at, '+00:00', '+08:00')) mark_date
                from ph_staging.ticket_delivery td
                join t t1 on t1.pno = td.pno
                left join ph_staging.ticket_delivery_marker tdm on tdm.delivery_id = td.id
                where
                    tdm.marker_id not in (7,22,5,20,6,21,15,71,32,69,31)
                    and if(t1.change_store = 'n', 1 = 1, tdm.created_at > t1.pcd_create_at)
                group by 1,2
            ) mark on mark.pno = t1.pno
        join
            (
                select
                    ppd.pno
                    ,date(convert_tz(ppd.created_at, '+00:00', '+08:00')) mark_date
                from ph_staging.parcel_problem_detail ppd
                join t t1 on t1.pno = ppd.pno
                where
                    if(t1.change_store = 'n', 1 = 1, ppd.created_at > t1.pcd_create_at)
                group by 1,2
            ) ppd on ppd.pno = mark.pno and mark.mark_date = ppd.mark_date
        group by 1
        having count(distinct ppd.mark_date) >= 3
    ) a
left join
    (
        select
            *
        from
            (
                select
                    ppd.pno
                    ,ppd.diff_marker_category
                    ,convert_tz(ppd.created_at, '+00:00', '+08:00') ppd_time
                    ,row_number() over (partition by ppd.pno order by ppd.created_at desc) rk
                from ph_staging.parcel_problem_detail ppd
                join t t1 on t1.pno = ppd.pno
#                 where
#                     ppd.parcel_problem_type_category = 1
            ) b
        where
            b.rk = 1
    ) b on b.pno = a.pno
where
     ( b.diff_marker_category != 17 or b.diff_marker_category is null );
;-- -. . -..- - / . -. - .-. -.--
select hour(now());
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        de.pno
        ,de.dst_store_id
        ,de.dst_store
        ,de.dst_region
        ,de.dst_piece
        ,pi.state
        ,pi.dst_phone
        ,pi.dst_home_phone
        ,if(pcd.pno is not null , 'y', 'n') change_store
        ,max(pcd.created_at) pcd_create_at
    from dwm.dwd_ex_ph_parcel_details de
    left join ph_staging.parcel_info pi on de.pno = pi.pno
    left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
    left join ph_staging.parcel_route pr on pr.pno = de.pno and pr.route_action = 'PENDING_RETURN'
    left join ph_staging.parcel_change_detail pcd on pcd.pno = pi.pno and pcd.field_name = 'dst_store_id' and pcd.new_value != pcd.old_value
    where
        datediff(now(), de.dst_routed_at) <= 7
        and pi.state not in (5,7,8,9)
        and bc.client_id is null
        and pr.pno is null
    group by 1
)
select
    a.*
    ,b.diff_marker_category
    ,b.ppd_time '最后一次留仓/问题件时间'
from
    (
        select
            t1.pno
            ,t1.dst_store 目的地网点
            ,t1.dst_store_id 目的网点ID
            ,t1.dst_piece 目的地片区
            ,t1.dst_region 目的地大区
            ,case t1.state
                when '1' then '已揽收'
                when '2' then '运输中'
                when '3' then '派送中'
                when '4' then '已滞留'
                when '5' then '已签收'
                when '6' then '疑难件处理中'
                when '7' then '已退件'
                when '8' then '异常关闭'
                when '9' then '已撤销'
            end as `包裹状态`
            ,t1.dst_phone 收件人电话
            ,t1.dst_home_phone 收件人家庭电话
            ,count(distinct ppd.mark_date) 尝试天数
        from t t1
        left join
            (
                select
                    td.pno
                    ,date(convert_tz(tdm.created_at, '+00:00', '+08:00')) mark_date
                from ph_staging.ticket_delivery td
                join t t1 on t1.pno = td.pno
                left join ph_staging.ticket_delivery_marker tdm on tdm.delivery_id = td.id
                where
                    tdm.marker_id not in (7,22,5,20,6,21,15,71,32,69,31)
                    and if(t1.change_store = 'n', 1 = 1, tdm.created_at > t1.pcd_create_at)
                group by 1,2
            ) mark on mark.pno = t1.pno
        join
            (
                select
                    ppd.pno
                    ,date(convert_tz(ppd.created_at, '+00:00', '+08:00')) mark_date
                from ph_staging.parcel_problem_detail ppd
                join t t1 on t1.pno = ppd.pno
                where
                    if(t1.change_store = 'n', 1 = 1, ppd.created_at > t1.pcd_create_at)
                group by 1,2
            ) ppd on ppd.pno = mark.pno and mark.mark_date = ppd.mark_date
        group by 1
        having count(distinct ppd.mark_date) >= 3
    ) a
left join
    (
        select
            *
        from
            (
                select
                    ppd.pno
                    ,ppd.diff_marker_category
                    ,convert_tz(ppd.created_at, '+00:00', '+08:00') ppd_time
                    ,row_number() over (partition by ppd.pno order by ppd.created_at desc) rk
                from ph_staging.parcel_problem_detail ppd
                join t t1 on t1.pno = ppd.pno
#                 where
#                     ppd.parcel_problem_type_category = 1
            ) b
        where
            b.rk = 1
    ) b on b.pno = a.pno
where
     ( b.diff_marker_category != 17 or b.diff_marker_category is null )
    and if(hour(now()) = 9,  b.ppd_time >= date_sub(curdate(), interval 12 hour) and  b.ppd_time < date_add(curdate(), interval 1 hour), b.ppd_time >= date_add(curdate(), interval hour(now()) - 9 hour ) and b.ppd_time < date_add(curdate(), interval hour(now())- 8 hour) );
;-- -. . -..- - / . -. - .-. -.--
select date_add(curdate(), interval hour(now()) - 9 hour );
;-- -. . -..- - / . -. - .-. -.--
select
    de.pno 运单号
    ,de.src_store 揽件网点
    ,de.src_piece 片区
    ,de.src_region 大区
    ,de.client_id 客户ID
    ,de.pickup_time 揽件时间
    ,de.dst_store 目的网点
    ,case pi.article_category
        when '0' then '文件'
        when '1' then '干燥食品'
        when '10' then '家居用具'
        when '11' then '水果'
        when '2' then '日用品'
        when '3' then '数码产品'
        when '4' then '衣物'
        when '5' then '书刊'
        when '6' then '汽车配件'
        when '7' then '鞋包'
        when '8' then '体育器材'
        when '9' then '化妆品'
        when '99' then '其它'
    end  as 物品类型
    ,pi.exhibition_weight 物品重量
    ,pi.exhibition_length*pi.exhibition_width*pi.exhibition_height 物品体积
    ,pi.cod_amount/100 COD金额
    ,de.last_cn_route_action 最后一步有效路由
    ,de.last_route_time 操作时间
    ,de.last_staff_info_id 操作ID
#     ,'普通' type
from dwm.dwd_ex_ph_parcel_details de
left join ph_staging.parcel_info pi on pi.pno = de.pno
left join ph_staging.parcel_route pr on pr.pno = pi.pno and pr.store_id = pi.ticket_pickup_store_id and pr.route_action = 'SHIPMENT_WAREHOUSE_SCAN'
left join ph_staging.sys_store ss on ss.id = de.src_store_id
where
    pr.routed_at is null
    and de.pickup_time < curdate()
    and de.dst_store != de.src_store -- 剔除自揽自派
    and pi.state not in (5,7,8,9)
    and de.client_id != 'AA0038' -- 物料仓
    and ss.category != 6
    and de.last_store_id = de.src_store_id

union
-- 物料仓
select
     de.pno 运单号
    ,de.src_store 揽件网点
    ,de.src_piece 片区
    ,de.src_region 大区
    ,de.client_id 客户ID
    ,de.pickup_time 揽件时间
    ,de.dst_store 目的网点
    ,case pi.article_category
        when '0' then '文件'
        when '1' then '干燥食品'
        when '10' then '家居用具'
        when '11' then '水果'
        when '2' then '日用品'
        when '3' then '数码产品'
        when '4' then '衣物'
        when '5' then '书刊'
        when '6' then '汽车配件'
        when '7' then '鞋包'
        when '8' then '体育器材'
        when '9' then '化妆品'
        when '99' then '其它'
    end  as 物品类型
    ,pi.exhibition_weight 物品重量
    ,pi.exhibition_length*pi.exhibition_width*pi.exhibition_height 物品体积
    ,pi.cod_amount/100 COD金额
    ,de.last_cn_route_action 最后一步有效路由
    ,de.last_route_time 操作时间
    ,de.last_staff_info_id 操作ID
#     ,'物料' type
from dwm.dwd_ex_ph_parcel_details de
left join ph_staging.parcel_info pi on pi.pno = de.pno
# left join ph_staging.parcel_route pr on pr.pno = pi.pno and pr.store_id = pi.ticket_pickup_store_id and pr.route_action = 'SHIPMENT_WAREHOUSE_SCAN'
left join ph_staging.sys_store ss on ss.id = de.src_store_id
where
    de.src_hub_out_time is null
    and de.pickup_time < curdate()
    and de.dst_store != de.src_store -- 剔除自揽自派
    and pi.state not in (5,7,8,9)
    and de.client_id = 'AA0038' -- 物料仓
    and ss.category != 6 -- 非FH

union all

select
    de.pno 运单号
    ,de.src_store 揽件网点
    ,de.src_piece 片区
    ,de.src_region 大区
    ,de.client_id 客户ID
    ,de.pickup_time 揽件时间
    ,de.dst_store 目的网点
    ,case pi.article_category
        when '0' then '文件'
        when '1' then '干燥食品'
        when '10' then '家居用具'
        when '11' then '水果'
        when '2' then '日用品'
        when '3' then '数码产品'
        when '4' then '衣物'
        when '5' then '书刊'
        when '6' then '汽车配件'
        when '7' then '鞋包'
        when '8' then '体育器材'
        when '9' then '化妆品'
        when '99' then '其它'
    end  as 物品类型
    ,pi.exhibition_weight 物品重量
    ,pi.exhibition_length*pi.exhibition_width*pi.exhibition_height 物品体积
    ,pi.cod_amount/100 COD金额
    ,de.last_cn_route_action 最后一步有效路由
    ,de.last_route_time 操作时间
    ,de.last_staff_info_id 操作ID
#     ,'fh' type
from dwm.dwd_ex_ph_parcel_details de
left join ph_staging.parcel_info pi on pi.pno = de.pno
left join ph_staging.parcel_route pr on pr.pno = pi.pno and pr.store_id = pi.ticket_pickup_store_id and pr.route_action = 'SHIPMENT_WAREHOUSE_SCAN'
left join ph_staging.parcel_route pr2 on pr2.pno = pi.pno and pr2.route_action = 'FLASH_HOME_SCAN'
left join ph_staging.sys_store ss on ss.id = de.src_store_id
where
    coalesce(pr.routed_at, pr2.routed_at) is null
    and de.pickup_time < curdate()
    and de.dst_store != de.src_store -- 剔除自揽自派
    and de.last_store_id = pi.ticket_pickup_store_id
    and pi.state not in (5,7,8,9)
    and de.client_id != 'AA0038' -- 物料仓
    and ss.category = 6;
;-- -. . -..- - / . -. - .-. -.--
select
    de.pno 运单号
    ,de.src_store 揽件网点
    ,de.src_piece 片区
    ,de.src_region 大区
    ,de.client_id 客户ID
    ,de.pickup_time 揽件时间
    ,de.dst_store 目的网点
    ,case pi.article_category
        when '0' then '文件'
        when '1' then '干燥食品'
        when '10' then '家居用具'
        when '11' then '水果'
        when '2' then '日用品'
        when '3' then '数码产品'
        when '4' then '衣物'
        when '5' then '书刊'
        when '6' then '汽车配件'
        when '7' then '鞋包'
        when '8' then '体育器材'
        when '9' then '化妆品'
        when '99' then '其它'
    end  as 物品类型
    ,pi.exhibition_weight 物品重量
    ,pi.exhibition_length*pi.exhibition_width*pi.exhibition_height 物品体积
    ,pi.cod_amount/100 COD金额
    ,de.last_cn_route_action 最后一步有效路由
    ,de.last_route_time 操作时间
    ,de.last_staff_info_id 操作ID
#     ,'普通' type
from dwm.dwd_ex_ph_parcel_details de
left join ph_staging.parcel_info pi on pi.pno = de.pno
left join ph_staging.parcel_route pr on pr.pno = pi.pno and pr.store_id = pi.ticket_pickup_store_id and pr.route_action = 'SHIPMENT_WAREHOUSE_SCAN'
left join ph_staging.sys_store ss on ss.id = de.src_store_id
where
    pr.routed_at is null
    and de.pickup_time < curdate()
    and de.dst_store != de.src_store -- 剔除自揽自派
    and pi.state not in (5,7,8,9)
    and de.client_id != 'AA0038' -- 物料仓
    and ss.category != 6
    and de.last_store_id = de.src_store_id

union
-- 物料仓
select
     de.pno 运单号
    ,de.src_store 揽件网点
    ,de.src_piece 片区
    ,de.src_region 大区
    ,de.client_id 客户ID
    ,de.pickup_time 揽件时间
    ,de.dst_store 目的网点
    ,case pi.article_category
        when '0' then '文件'
        when '1' then '干燥食品'
        when '10' then '家居用具'
        when '11' then '水果'
        when '2' then '日用品'
        when '3' then '数码产品'
        when '4' then '衣物'
        when '5' then '书刊'
        when '6' then '汽车配件'
        when '7' then '鞋包'
        when '8' then '体育器材'
        when '9' then '化妆品'
        when '99' then '其它'
    end  as 物品类型
    ,pi.exhibition_weight 物品重量
    ,pi.exhibition_length*pi.exhibition_width*pi.exhibition_height 物品体积
    ,pi.cod_amount/100 COD金额
    ,de.last_cn_route_action 最后一步有效路由
    ,de.last_route_time 操作时间
    ,de.last_staff_info_id 操作ID
#     ,'物料' type
from dwm.dwd_ex_ph_parcel_details de
left join ph_staging.parcel_info pi on pi.pno = de.pno
# left join ph_staging.parcel_route pr on pr.pno = pi.pno and pr.store_id = pi.ticket_pickup_store_id and pr.route_action = 'SHIPMENT_WAREHOUSE_SCAN'
left join ph_staging.sys_store ss on ss.id = de.src_store_id
where
    de.pickup_out_time is null
    and de.pickup_time < curdate()
    and de.dst_store != de.src_store -- 剔除自揽自派
    and pi.state not in (5,7,8,9)
    and de.client_id = 'AA0038' -- 物料仓
    and ss.category != 6 -- 非FH

union all

select
    de.pno 运单号
    ,de.src_store 揽件网点
    ,de.src_piece 片区
    ,de.src_region 大区
    ,de.client_id 客户ID
    ,de.pickup_time 揽件时间
    ,de.dst_store 目的网点
    ,case pi.article_category
        when '0' then '文件'
        when '1' then '干燥食品'
        when '10' then '家居用具'
        when '11' then '水果'
        when '2' then '日用品'
        when '3' then '数码产品'
        when '4' then '衣物'
        when '5' then '书刊'
        when '6' then '汽车配件'
        when '7' then '鞋包'
        when '8' then '体育器材'
        when '9' then '化妆品'
        when '99' then '其它'
    end  as 物品类型
    ,pi.exhibition_weight 物品重量
    ,pi.exhibition_length*pi.exhibition_width*pi.exhibition_height 物品体积
    ,pi.cod_amount/100 COD金额
    ,de.last_cn_route_action 最后一步有效路由
    ,de.last_route_time 操作时间
    ,de.last_staff_info_id 操作ID
#     ,'fh' type
from dwm.dwd_ex_ph_parcel_details de
left join ph_staging.parcel_info pi on pi.pno = de.pno
left join ph_staging.parcel_route pr on pr.pno = pi.pno and pr.store_id = pi.ticket_pickup_store_id and pr.route_action = 'SHIPMENT_WAREHOUSE_SCAN'
left join ph_staging.parcel_route pr2 on pr2.pno = pi.pno and pr2.route_action = 'FLASH_HOME_SCAN'
left join ph_staging.sys_store ss on ss.id = de.src_store_id
where
    coalesce(pr.routed_at, pr2.routed_at) is null
    and de.pickup_time < curdate()
    and de.dst_store != de.src_store -- 剔除自揽自派
    and de.last_store_id = pi.ticket_pickup_store_id
    and pi.state not in (5,7,8,9)
    and de.client_id != 'AA0038' -- 物料仓
    and ss.category = 6;
;-- -. . -..- - / . -. - .-. -.--
select
    de.pno 运单号
    ,de.src_store 揽件网点
    ,de.src_piece 片区
    ,de.src_region 大区
    ,de.client_id 客户ID
    ,de.pickup_time 揽件时间
    ,de.dst_store 目的网点
    ,case pi.article_category
        when '0' then '文件'
        when '1' then '干燥食品'
        when '10' then '家居用具'
        when '11' then '水果'
        when '2' then '日用品'
        when '3' then '数码产品'
        when '4' then '衣物'
        when '5' then '书刊'
        when '6' then '汽车配件'
        when '7' then '鞋包'
        when '8' then '体育器材'
        when '9' then '化妆品'
        when '99' then '其它'
    end  as 物品类型
    ,pi.exhibition_weight 物品重量
    ,pi.exhibition_length*pi.exhibition_width*pi.exhibition_height 物品体积
    ,pi.cod_amount/100 COD金额
    ,de.last_cn_route_action 最后一步有效路由
    ,de.last_route_time 操作时间
    ,de.last_staff_info_id 操作ID
#     ,'普通' type
from dwm.dwd_ex_ph_parcel_details de
left join ph_staging.parcel_info pi on pi.pno = de.pno
left join ph_staging.parcel_route pr on pr.pno = pi.pno and pr.store_id = pi.ticket_pickup_store_id and pr.route_action = 'SHIPMENT_WAREHOUSE_SCAN'
left join ph_staging.sys_store ss on ss.id = de.src_store_id
where
    pr.routed_at is null
    and de.pickup_time < curdate()
    and de.dst_store != de.src_store -- 剔除自揽自派
    and pi.state not in (5,7,8,9)
    and de.client_id != 'AA0038' -- 物料仓
    and ss.category != 6
    and de.last_store_id = de.src_store_id

union
-- 物料仓
select
     de.pno 运单号
    ,de.src_store 揽件网点
    ,de.src_piece 片区
    ,de.src_region 大区
    ,de.client_id 客户ID
    ,de.pickup_time 揽件时间
    ,de.dst_store 目的网点
    ,case pi.article_category
        when '0' then '文件'
        when '1' then '干燥食品'
        when '10' then '家居用具'
        when '11' then '水果'
        when '2' then '日用品'
        when '3' then '数码产品'
        when '4' then '衣物'
        when '5' then '书刊'
        when '6' then '汽车配件'
        when '7' then '鞋包'
        when '8' then '体育器材'
        when '9' then '化妆品'
        when '99' then '其它'
    end  as 物品类型
    ,pi.exhibition_weight 物品重量
    ,pi.exhibition_length*pi.exhibition_width*pi.exhibition_height 物品体积
    ,pi.cod_amount/100 COD金额
    ,de.last_cn_route_action 最后一步有效路由
    ,de.last_route_time 操作时间
    ,de.last_staff_info_id 操作ID
#     ,'物料' type
from dwm.dwd_ex_ph_parcel_details de
left join ph_staging.parcel_info pi on pi.pno = de.pno
# left join ph_staging.parcel_route pr on pr.pno = pi.pno and pr.store_id = pi.ticket_pickup_store_id and pr.route_action = 'SHIPMENT_WAREHOUSE_SCAN'
left join ph_staging.sys_store ss on ss.id = de.src_store_id
where
    de.pickup_out_time is null
    and de.src_hub_out_time is null
    and de.pickup_time < curdate()
    and de.dst_store != de.src_store -- 剔除自揽自派
    and pi.state not in (5,7,8,9)
    and de.client_id = 'AA0038' -- 物料仓
    and ss.category != 6 -- 非FH

union all

select
    de.pno 运单号
    ,de.src_store 揽件网点
    ,de.src_piece 片区
    ,de.src_region 大区
    ,de.client_id 客户ID
    ,de.pickup_time 揽件时间
    ,de.dst_store 目的网点
    ,case pi.article_category
        when '0' then '文件'
        when '1' then '干燥食品'
        when '10' then '家居用具'
        when '11' then '水果'
        when '2' then '日用品'
        when '3' then '数码产品'
        when '4' then '衣物'
        when '5' then '书刊'
        when '6' then '汽车配件'
        when '7' then '鞋包'
        when '8' then '体育器材'
        when '9' then '化妆品'
        when '99' then '其它'
    end  as 物品类型
    ,pi.exhibition_weight 物品重量
    ,pi.exhibition_length*pi.exhibition_width*pi.exhibition_height 物品体积
    ,pi.cod_amount/100 COD金额
    ,de.last_cn_route_action 最后一步有效路由
    ,de.last_route_time 操作时间
    ,de.last_staff_info_id 操作ID
#     ,'fh' type
from dwm.dwd_ex_ph_parcel_details de
left join ph_staging.parcel_info pi on pi.pno = de.pno
left join ph_staging.parcel_route pr on pr.pno = pi.pno and pr.store_id = pi.ticket_pickup_store_id and pr.route_action = 'SHIPMENT_WAREHOUSE_SCAN'
left join ph_staging.parcel_route pr2 on pr2.pno = pi.pno and pr2.route_action = 'FLASH_HOME_SCAN'
left join ph_staging.sys_store ss on ss.id = de.src_store_id
where
    coalesce(pr.routed_at, pr2.routed_at) is null
    and de.pickup_time < curdate()
    and de.dst_store != de.src_store -- 剔除自揽自派
    and de.last_store_id = pi.ticket_pickup_store_id
    and pi.state not in (5,7,8,9)
    and de.client_id != 'AA0038' -- 物料仓
    and ss.category = 6;
;-- -. . -..- - / . -. - .-. -.--
select
    ra.id
    ,ra.submitter_id
    ,hsi3.name submitter_name
    ,hjt2.job_name submitter_job
    ,ra.report_id
    ,concat(tp.cn, tp.eng) reason
    ,hsi.sys_store_id
    ,ra.event_date
    ,ra.remark
    ,group_concat(concat('https://fex-ph-asset-pro.oss-ap-southeast-1.aliyuncs.com/', sa.object_key) separator ';') picture
from ph_backyard.report_audit ra
left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ra.report_id
left join ph_bi.hr_staff_info hsi3 on hsi3.staff_info_id = ra.submitter_id
left join ph_bi.hr_job_title hjt2 on hjt2.id = hsi3.job_title
left join tmpale.tmp_ph_report_reason tp on tp.key = ra.reason
left join ph_backyard.sys_attachment sa on sa.oss_bucket_key = ra.id and sa.oss_bucket_type = 'REPORT_AUDIT_IMG'
where
    ra.created_at >= '2023-07-10' -- QC不看之前的数据
    and ra.status = 2
    and ra.final_approval_time >= date_sub(curdate(), interval 11 hour)
    and ra.final_approval_time < date_add(curdate(), interval 13 hour )
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    ra.id
    ,ra.submitter_id
    ,hsi3.name submitter_name
    ,hjt2.job_name submitter_job
    ,ra.report_id
    ,concat(tp.cn, tp.eng) reason
    ,hsi.sys_store_id
    ,ra.event_date
    ,ra.remark
    ,group_concat(concat('https://fex-ph-asset-pro.oss-ap-southeast-1.aliyuncs.com/', sa.object_key) separator ';') picture
from ph_backyard.report_audit ra
left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ra.report_id
left join ph_bi.hr_staff_info hsi3 on hsi3.staff_info_id = ra.submitter_id
left join ph_bi.hr_job_title hjt2 on hjt2.id = hsi3.job_title
left join tmpale.tmp_ph_report_reason tp on tp.key = ra.reason
left join ph_backyard.sys_attachment sa on sa.oss_bucket_key = ra.id and sa.oss_bucket_type = 'REPORT_AUDIT_IMG'
where
    ra.created_at >= '2023-07-10' -- QC不看之前的数据
    and ra.status = 2;
;-- -. . -..- - / . -. - .-. -.--
select
    ra.id
    ,ra.submitter_id
    ,hsi3.name submitter_name
    ,hjt2.job_name submitter_job
    ,ra.report_id
    ,concat(tp.cn, tp.eng) reason
    ,hsi.sys_store_id
    ,ra.event_date
    ,ra.remark
#     ,group_concat(concat('https://fex-ph-asset-pro.oss-ap-southeast-1.aliyuncs.com/', sa.object_key) separator ';') picture
from ph_backyard.report_audit ra
left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ra.report_id
left join ph_bi.hr_staff_info hsi3 on hsi3.staff_info_id = ra.submitter_id
left join ph_bi.hr_job_title hjt2 on hjt2.id = hsi3.job_title
left join tmpale.tmp_ph_report_reason tp on tp.key = ra.reason
left join ph_backyard.sys_attachment sa on sa.oss_bucket_key = ra.id and sa.oss_bucket_type = 'REPORT_AUDIT_IMG'
where
    ra.created_at >= '2023-07-10' -- QC不看之前的数据
    and ra.status = 2;
;-- -. . -..- - / . -. - .-. -.--
select
    ra.id
    ,ra.submitter_id
    ,hsi3.name submitter_name
    ,hjt2.job_name submitter_job
    ,ra.report_id
    ,concat(tp.cn, tp.eng) reason
    ,hsi.sys_store_id
    ,ra.event_date
    ,ra.remark
    ,ra.final_approval_time
#     ,group_concat(concat('https://fex-ph-asset-pro.oss-ap-southeast-1.aliyuncs.com/', sa.object_key) separator ';') picture
from ph_backyard.report_audit ra
left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ra.report_id
left join ph_bi.hr_staff_info hsi3 on hsi3.staff_info_id = ra.submitter_id
left join ph_bi.hr_job_title hjt2 on hjt2.id = hsi3.job_title
left join tmpale.tmp_ph_report_reason tp on tp.key = ra.reason
left join ph_backyard.sys_attachment sa on sa.oss_bucket_key = ra.id and sa.oss_bucket_type = 'REPORT_AUDIT_IMG'
where
    ra.created_at >= '2023-07-10' -- QC不看之前的数据
    and ra.status = 2;
;-- -. . -..- - / . -. - .-. -.--
select
    ra.id
    ,ra.submitter_id
    ,hsi3.name submitter_name
    ,hjt2.job_name submitter_job
    ,ra.report_id
    ,concat(tp.cn, tp.eng) reason
    ,hsi.sys_store_id
    ,ra.event_date
    ,ra.remark
    ,ra.final_approval_time
    ,group_concat(concat('https://fex-ph-asset-pro.oss-ap-southeast-1.aliyuncs.com/', sa.object_key) separator ';') picture
from ph_backyard.report_audit ra
left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ra.report_id
left join ph_bi.hr_staff_info hsi3 on hsi3.staff_info_id = ra.submitter_id
left join ph_bi.hr_job_title hjt2 on hjt2.id = hsi3.job_title
left join tmpale.tmp_ph_report_reason tp on tp.key = ra.reason
left join ph_backyard.sys_attachment sa on sa.oss_bucket_key = ra.id and sa.oss_bucket_type = 'REPORT_AUDIT_IMG'
where
    ra.created_at >= '2023-07-10' -- QC不看之前的数据
    and ra.status = 2
    and hsi.sys_store_id = -1
#     and ra.final_approval_time >= date_sub(curdate(), interval 11 hour)
#     and ra.final_approval_time < date_add(curdate(), interval 13 hour )
group by 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        de.pno
        ,de.dst_store_id
        ,de.dst_store
        ,de.dst_region
        ,de.dst_piece
        ,pi.state
        ,pi.dst_phone
        ,pi.dst_home_phone
        ,if(pcd.pno is not null , 'y', 'n') change_store
        ,max(pcd.created_at) pcd_create_at
    from dwm.dwd_ex_ph_parcel_details de
    left join ph_staging.parcel_info pi on de.pno = pi.pno
    left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
    left join ph_staging.parcel_route pr on pr.pno = de.pno and pr.route_action = 'PENDING_RETURN'
    left join ph_staging.parcel_change_detail pcd on pcd.pno = pi.pno and pcd.field_name = 'dst_store_id' and pcd.new_value != pcd.old_value
    where
        datediff(now(), de.dst_routed_at) <= 7
        and pi.state not in (5,7,8,9)
        and bc.client_id is null
        and pr.pno is null
    group by 1
)
select
    a.*
    ,b.diff_marker_category
    ,b.ppd_time '最后一次留仓/问题件时间'
from
    (
        select
            t1.pno
            ,t1.dst_store 目的地网点
            ,t1.dst_store_id 目的网点ID
            ,t1.dst_piece 目的地片区
            ,t1.dst_region 目的地大区
            ,case t1.state
                when '1' then '已揽收'
                when '2' then '运输中'
                when '3' then '派送中'
                when '4' then '已滞留'
                when '5' then '已签收'
                when '6' then '疑难件处理中'
                when '7' then '已退件'
                when '8' then '异常关闭'
                when '9' then '已撤销'
            end as `包裹状态`
            ,t1.dst_phone 收件人电话
            ,t1.dst_home_phone 收件人家庭电话
            ,count(distinct ppd.mark_date) 尝试天数
        from t t1
        left join
            (
                select
                    td.pno
                    ,date(convert_tz(tdm.created_at, '+00:00', '+08:00')) mark_date
                from ph_staging.ticket_delivery td
                join t t1 on t1.pno = td.pno
                left join ph_staging.ticket_delivery_marker tdm on tdm.delivery_id = td.id
                where
                    tdm.marker_id not in (7,22,5,20,6,21,15,71,32,69,31)
                    and if(t1.change_store = 'n', 1 = 1, tdm.created_at > t1.pcd_create_at)
                group by 1,2
            ) mark on mark.pno = t1.pno
        join
            (
                select
                    ppd.pno
                    ,date(convert_tz(ppd.created_at, '+00:00', '+08:00')) mark_date
                from ph_staging.parcel_problem_detail ppd
                join t t1 on t1.pno = ppd.pno
                where
                    if(t1.change_store = 'n', 1 = 1, ppd.created_at > t1.pcd_create_at)
                group by 1,2
            ) ppd on ppd.pno = mark.pno and mark.mark_date = ppd.mark_date
        group by 1
        having count(distinct ppd.mark_date) >= 3
    ) a
left join
    (
        select
            *
        from
            (
                select
                    ppd.pno
                    ,ppd.diff_marker_category
                    ,convert_tz(ppd.created_at, '+00:00', '+08:00') ppd_time
                    ,row_number() over (partition by ppd.pno order by ppd.created_at desc) rk
                from ph_staging.parcel_problem_detail ppd
                join t t1 on t1.pno = ppd.pno
#                 where
#                     ppd.parcel_problem_type_category = 1
            ) b
        where
            b.rk = 1
    ) b on b.pno = a.pno
where
     ( b.diff_marker_category != 17 or b.diff_marker_category is null )
    and if(hour(now()) = 9,  b.ppd_time >= date_sub(curdate(), interval 4 hour) and  b.ppd_time < date_add(curdate(), interval 9 hour), b.ppd_time >= date_add(curdate(), interval hour(now()) - 1 hour ) and b.ppd_time < date_add(curdate(), interval hour(now()) hour) );
;-- -. . -..- - / . -. - .-. -.--
select
            sc.cfg_value
        from ph_staging.sys_configuration sc
        where
            sc.cfg_key = 'sorting.scan.enable.store.ids';
;-- -. . -..- - / . -. - .-. -.--
select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    *
from
    (
        select
            ds.pno
            ,convert_tz(pr.routed_at, '+00:00', '+08:00') sort_time
            ,row_number() over (partition by ds.pno order by pr.routed_at desc ) rk
        from ph_bi.dc_should_delivery_today ds
        left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'SORTING_SCAN'
        where
            ds.store_id = 'PH02060100'
            and ds.stat_date = '2023-07-25'
    ) a
where
    a.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
select
    *
from
    (
        select
            ds.pno
            ,convert_tz(pr.routed_at, '+00:00', '+08:00') sort_time
            ,row_number() over (partition by ds.pno order by pr.routed_at desc ) rk
        from ph_bi.dc_should_delivery_today ds
        left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'SORTING_SCAN' and pr.routed_at > '2023-07-24 16:00:00' and pr.routed_at < '2023-07-25 16:00:00'
        where
            ds.store_id = 'PH02060100'
            and ds.stat_date = '2023-07-25'
    ) a
where
    a.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
select
    *
from
    (
        select
            ds.pno
            ,convert_tz(pr.routed_at, '+00:00', '+08:00') sort_time
            ,row_number() over (partition by ds.pno order by pr.routed_at desc ) rk
        from ph_bi.dc_should_delivery_today ds
        left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'SORTING_SCAN' and pr.routed_at > '2023-07-24 16:00:00' and pr.routed_at < '2023-07-25 16:00:00'
        where
            ds.store_id = 'PH24170100'
            and ds.stat_date = '2023-07-25'
    ) a
where
    a.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.store_id
        ,pr.pno
        ,pr.staff_info_id
        ,pi.state
    from ph_bi.dc_should_delivery_today ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pr.staff_info_id
    where
        ds.stat_date = '2023-07-25'
        and pr.routed_at >= date_sub('2023-07-25', interval 8 hour )
        and pr.routed_at < date_add('2023-07-25', interval 16 hour)
#         and ds.store_id = 'PH62010300'
)
select
    dr.store_id 网点ID
    ,dr.store_name 网点
    ,dr.opening_at 开业时间
    ,case dr.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dr.piece_name 片区
    ,dr.region_name 大区
    ,emp_cnt.staf_num 总快递员人数
    ,a3.staf_num 总出勤快递员人数
    ,a3.avg_scan_num 平均交接量
    ,a3.avg_del_num 平均妥投量
    ,sdb.code_num 网点三段码数量
    ,a2.avg_staff_code 三段码平均交接量
    ,a2.avg_staff_del_code 三段码平均妥投量
    ,a2.avg_code_staff 三段码平均交接快递员数
    ,case
        when a2.avg_code_staff < 2 then 'A'
        when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
        when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
        when a2.avg_code_staff >= 4 then 'D'
    end 评级
    ,a2.code_num
    ,a2.staff_code_num
    ,a2.staff_num
    ,a2.fin_staff_code_num
from
    (
        select
            a1.store_id
            ,count(distinct a1.staff_code) staff_code_num
            ,count(distinct a1.third_sorting_code) code_num
            ,count(distinct a1.staff_info_id) staff_num
            ,count(distinct if(a1.state = 5, a1.staff_code, null)) fin_staff_code_num
            ,count(distinct a1.staff_code)/ count(distinct a1.third_sorting_code) avg_code_staff
            ,count(distinct a1.staff_code)/count(distinct a1.staff_info_id)  avg_staff_code
            ,count(distinct if(a1.state = 5, a1.staff_code, null))/count(distinct a1.staff_info_id) avg_staff_del_code
        from
            (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,t1.state
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
left join
    (
        select
           ad.sys_store_id
           ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
       from ph_bi.attendance_data_v2 ad
       left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
       where
           (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
            and hr.job_title in (13,110,1000)
#             and ad.stat_date = curdate()
            and ad.stat_date = '2023-07-25'
       group by 1
    ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct t1.staff_info_id) staf_num
            ,count(distinct t1.pno)/count(distinct t1.staff_info_id) avg_scan_num
            ,count(distinct if(t1.state = 5, t1.pno, null))/count(distinct t1.staff_info_id) avg_del_num
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
select
    ss.id
    ,ss.opening_at
from ph_staging.sys_store ss
where
    ss.state = 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.store_id
        ,ss.name
        ,pi.finished_at
        ,pi.ticket_delivery_staff_info_id
        ,row_number() over (partition by ds.store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from ph_bi.dc_should_delivery_today ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.store_id
    where
        ds.stat_date = '2023-07-25'
        and pi.state = 5
        and pi.finished_at >= '2023-07-24 16:00:00'
        and pi.finished_at < '2023-07-25 16:00:00'
)
select
    a.store_id
    ,a.name
    ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
from
    (
        select
            t1.store_id
            ,t1.name
            ,t1.ticket_delivery_staff_info_id
            ,t1.finished_at
            ,t2.finished_at finished_at_2
            ,timestampdiff(second, t1.finished_at, t2.finished_at)/3600 diff_hour
        from
            (
                select * from t t1 where t1.rk1 = 1
            ) t1
        join
            (
                select * from t t2 where t2.rk2 = 2
            ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
    ) a
group by 1,2;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.store_id
        ,ss.name
        ,pi.finished_at
        ,pi.ticket_delivery_staff_info_id
        ,row_number() over (partition by ds.store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from ph_bi.dc_should_delivery_today ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.store_id
    where
        ds.stat_date = '2023-07-25'
        and pi.state = 5
        and pi.finished_at >= '2023-07-24 16:00:00'
        and pi.finished_at < '2023-07-25 16:00:00'
        and ds.store_id = 'PH39230D00'
)
# select
#     a.store_id
#     ,a.name
#     ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
# from
#     (
        select
            t1.store_id
            ,t1.name
            ,t1.ticket_delivery_staff_info_id
            ,t1.finished_at
            ,t2.finished_at finished_at_2
            ,timestampdiff(second, t1.finished_at, t2.finished_at)/3600 diff_hour
        from
            (
                select * from t t1 where t1.rk1 = 1
            ) t1
        join
            (
                select * from t t2 where t2.rk2 = 2
            ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id;
;-- -. . -..- - / . -. - .-. -.--
select
        ds.store_id
        ,ss.name
        ,pi.finished_at
        ,pi.ticket_delivery_staff_info_id
        ,row_number() over (partition by ds.store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from ph_bi.dc_should_delivery_today ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.store_id
    where
        ds.stat_date = '2023-07-25'
        and pi.state = 5
        and pi.finished_at >= '2023-07-24 16:00:00'
        and pi.finished_at < '2023-07-25 16:00:00'
        and ds.store_id = 'PH39230D00';
;-- -. . -..- - / . -. - .-. -.--
select
        ds.store_id
        ,ss.name
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,row_number() over (partition by ds.store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from ph_bi.dc_should_delivery_today ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.store_id
    where
        ds.stat_date = '2023-07-25'
        and pi.state = 5
        and pi.finished_at >= '2023-07-24 16:00:00'
        and pi.finished_at < '2023-07-25 16:00:00'
        and ds.store_id = 'PH39230D00';
;-- -. . -..- - / . -. - .-. -.--
select
        ds.store_id
        ,ss.name
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,row_number() over (partition by ds.store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from ph_bi.dc_should_delivery_today ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.store_id
    where
        ds.stat_date = '2023-07-25'
        and pi.state = 5
        and pi.finished_at >= '2023-07-24 16:00:00'
        and pi.finished_at < '2023-07-25 16:00:00'
        and ds.store_id = 'PH40010900';
;-- -. . -..- - / . -. - .-. -.--
select
            ds.pno
            ,ds.store_id
            ,convert_tz(pr.routed_at, '+00:00', '+08:00') sort_time
            ,row_number() over (partition by ds.pno order by pr.routed_at desc ) rk
        from ph_bi.dc_should_delivery_today ds
        left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'SORTING_SCAN' and pr.routed_at > '2023-07-24 16:00:00' and pr.routed_at < '2023-07-25 16:00:00'
        where
            ds.stat_date = '2023-07-25'
            and ds.store_id = 'PH61270901';
;-- -. . -..- - / . -. - .-. -.--
select
    a.store_id
    ,b.pno
    ,a.sort_time
from
    (
        select
            ds.pno
            ,ds.store_id
        from ph_bi.dc_should_delivery_today ds
#         left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'SORTING_SCAN' and pr.routed_at > '2023-07-24 16:00:00' and pr.routed_at < '2023-07-25 16:00:00'
        where
            ds.stat_date = '2023-07-25'
            and ds.store_id = 'PH57040200'
    ) b
left join
    (
        select
            ds.pno
            ,ds.store_id
            ,convert_tz(pr.routed_at, '+00:00', '+08:00') sort_time
            ,row_number() over (partition by ds.pno order by pr.routed_at desc ) rk
        from ph_bi.dc_should_delivery_today ds
        left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'SORTING_SCAN' and pr.routed_at > '2023-07-24 16:00:00' and pr.routed_at < '2023-07-25 16:00:00'
        where
            ds.stat_date = '2023-07-25'
            and ds.store_id = 'PH57040200'
    ) a on a.store_id = b.store_id and a.pno = b.pno and a.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
select
    a.store_id
    ,b.pno
    ,a.sort_time
from
    (
        select
            ds.pno
            ,ds.store_id
        from ph_bi.dc_should_delivery_today ds
#         left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'SORTING_SCAN' and pr.routed_at > '2023-07-24 16:00:00' and pr.routed_at < '2023-07-25 16:00:00'
        where
            ds.stat_date = '2023-07-25'
            and ds.store_id = 'PH57040200'
    ) b
left join
    (
        select
            ds.pno
            ,ds.store_id
            ,convert_tz(pr.routed_at, '+00:00', '+08:00') sort_time
            ,row_number() over (partition by ds.pno order by pr.routed_at ) rk
        from ph_bi.dc_should_delivery_today ds
        left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'SORTING_SCAN' and pr.routed_at > '2023-07-24 16:00:00' and pr.routed_at < '2023-07-25 16:00:00'
        where
            ds.stat_date = '2023-07-25'
            and ds.store_id = 'PH57040200'
    ) a on a.store_id = b.store_id and a.pno = b.pno and a.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
select
    a.store_id
    ,b.pno
    ,a.sort_time
from
    (
        select
            ds.pno
            ,ds.store_id
        from ph_bi.dc_should_delivery_today ds
#         left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'SORTING_SCAN' and pr.routed_at > '2023-07-24 16:00:00' and pr.routed_at < '2023-07-25 16:00:00'
        where
            ds.stat_date = '2023-07-25'
            and ds.store_id = 'PH61270901'
    ) b
left join
    (
        select
            ds.pno
            ,ds.store_id
            ,convert_tz(pr.routed_at, '+00:00', '+08:00') sort_time
            ,row_number() over (partition by ds.pno order by pr.routed_at ) rk
        from ph_bi.dc_should_delivery_today ds
        left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'SORTING_SCAN' and pr.routed_at > '2023-07-24 16:00:00' and pr.routed_at < '2023-07-25 16:00:00'
        where
            ds.stat_date = '2023-07-25'
            and ds.store_id = 'PH61270901'
    ) a on a.store_id = b.store_id and a.pno = b.pno and a.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
select
    ss.id
    ,ss.delivery_frequency
from ph_staging.sys_store ss
where
    ss.state = 1;
;-- -. . -..- - / . -. - .-. -.--
select
	tt.store_id 网点ID,
	tt.store_name 网点名称,
	piece_name 片区,
	region_name 大区,
	shoud_counts 应派总数,
	scan_fished_counts 分拣扫描数,
	scan_fished_counts/shoud_counts 分拣扫描率,

	youxiao_counts 总有效分拣扫描数,
	youxiao_counts/scan_fished_counts 总有效分拣扫描率,

	1pai_counts  一派应派数,
	1pai_scan_fished_counts 一派分拣扫描数,
	1pai_scan_fished_counts/1pai_counts  一派分拣扫描率,

	1pai_youxiao_counts 一派有效分拣扫描数,
	1pai_youxiao_counts/1pai_scan_fished_counts 一派有效分拣扫描率，

	1pai_hour_8_fished_counts/1pai_scan_fished_counts  一派8点前扫描占比,
	1pai_hour_8ban_fished_counts/1pai_scan_fished_counts  一派8点半前扫描占比,
	1pai_hour_9_fished_counts/1pai_scan_fished_counts 一派9点前扫描占比,
	1pai_hour_9ban_fished_counts/1pai_scan_fished_counts 一派9点半前扫描占比,

	case
	   when 1pai_scan_fished_counts/1pai_counts>=0.95 and 1pai_hour_8_fished_counts/1pai_scan_fished_counts>=0.98 then 'A'
	   when 1pai_scan_fished_counts/1pai_counts>=0.95 and 1pai_hour_8ban_fished_counts/1pai_scan_fished_counts>=0.98 then 'B'
	   when 1pai_scan_fished_counts/1pai_counts>=0.95 and 1pai_hour_9_fished_counts/1pai_scan_fished_counts>=0.98 then 'C'
	   when 1pai_scan_fished_counts/1pai_counts>=0.95 and 1pai_hour_9ban_fished_counts/1pai_scan_fished_counts>=0.98 then 'D'
	   else 'E'
	end 一派分拣评级,

	case
	   when 1pai_youxiao_counts/1pai_scan_fished_counts>=0.95 then 'A'
	   when 1pai_youxiao_counts/1pai_scan_fished_counts>=0.90 then 'B'
	   when 1pai_youxiao_counts/1pai_scan_fished_counts>=0.85 then 'C'
	   when 1pai_youxiao_counts/1pai_scan_fished_counts>=0.80 then 'D'
	   else 'E'
	end 一派有效分拣评级, -- 派有效分拣
	tt1.min_real_arrived_at,
	tt1.max_real_arrived_at,
	tt1.real_counts,
	tt2.max_schedule_time
from
(
	select
		store_id,
		store_name,
		piece_name,
		region_name,
		count(pno) shoud_counts,
		count(case when min_fenjian_scan_time is not null then pno else null end ) scan_fished_counts,

		count(case when min_fenjian_scan_time is not null and min_fenjian_scan_time<tiaozheng_scan_deadline_time then pno else null end ) youxiao_counts,

		count(case when type='一派' then  pno else null end ) 1pai_counts,
		count(case when type='一派' and min_fenjian_scan_time is not null then  pno else null end ) 1pai_scan_fished_counts,
		count(case when type='一派' and min_fenjian_scan_time is not null and min_fenjian_scan_time<tiaozheng_scan_deadline_time then  pno else null end ) 1pai_youxiao_counts,

		count(case when type='一派' and date_format(min_fenjian_scan_time,'%H:%i:%s')<='08:00:00' then pno else null end) 1pai_hour_8_fished_counts,
		count(case when type='一派' and date_format(min_fenjian_scan_time,'%H:%i:%s')<='08:30:00' then pno else null end) 1pai_hour_8ban_fished_counts,
		count(case when type='一派' and date_format(min_fenjian_scan_time,'%H:%i:%s')<='09:00:00' then pno else null end) 1pai_hour_9_fished_counts,
		count(case when type='一派' and date_format(min_fenjian_scan_time,'%H:%i:%s')<='09:30:00' then pno else null end) 1pai_hour_9ban_fished_counts
	from
	(
		select
			t.*, case when hour(real_arrived_at)<9 or real_arrived_at is null then '一派'  end type
		from test.fleet_20230720_v2 t
		join ph_staging.sys_store ss
		on t.store_id =ss.id
		where
		ss.category not in (8) and t.store_name not like '%_PDC%'
	) base

	group by store_id,store_name,piece_name,region_name
) tt

left join
(
	select
		dd.next_store_id,
		min(convert_tz(fvr.created_at,'+00:00','+08:00')) min_real_arrived_at,
		max(convert_tz(fvr.created_at,'+00:00','+08:00')) max_real_arrived_at,
		count(distinct dd.proof_id) real_counts
	from  ph_staging.fleet_van_proof_parcel_detail dd

	join ph_staging.fleet_van_route fvr
	on dd.next_store_id=fvr.store_id
	and dd.proof_id=fvr.proof_id
	where
	dd.relation_category in (1,3)
	and dd.state in (1,2)
	and fvr.event =1
	and fvr.created_at >=convert_tz('2023-07-25','+08:00','+00:00')
	and fvr.created_at <convert_tz('2023-07-25 09:00:00','+08:00','+00:00')
	and fvr.deleted =0
	group by next_store_id

) tt1
on tt.store_id=tt1.next_store_id

left join
(
	select next_store_id,max(max_schedule_time) max_schedule_time from test.fleet_base group by next_store_id
) tt2
on tt.store_id=tt2.next_store_id;
;-- -. . -..- - / . -. - .-. -.--
with a as
(
    select
        coalesce(a.client_name, '总计') client_name
        ,coalesce(a.疑难件原因, '总计') 疑难件原因
        ,a.`0-2小时`
        ,a.`2-4小时`
        ,a.`4-6小时`
        ,a.`6小时以上`
        ,a.总疑难件量
        ,a.继续配送
        ,a.退货
        ,a.平均处理时长_h
    from
        (
            select
                bc.client_name
                ,case di.diff_marker_category # 疑难原因
                    when 1 then '客户不在家/电话无人接听'
                    when 2 then '收件人拒收'
                    when 3 then '快件分错网点'
                    when 4 then '外包装破损'
                    when 5 then '货物破损'
                    when 6 then '货物短少'
                    when 7 then '货物丢失'
                    when 8 then '电话联系不上'
                    when 9 then '客户改约时间'
                    when 10 then '客户不在'
                    when 11 then '客户取消任务'
                    when 12 then '无人签收'
                    when 13 then '客户周末或假期不收货'
                    when 14 then '客户改约时间'
                    when 15 then '当日运力不足，无法派送'
                    when 16 then '联系不上收件人'
                    when 17 then '收件人拒收'
                    when 18 then '快件分错网点'
                    when 19 then '外包装破损'
                    when 20 then '货物破损'
                    when 21 then '货物短少'
                    when 22 then '货物丢失'
                    when 23 then '详细地址错误'
                    when 24 then '收件地址已废弃或不存在'
                    when 25 then '收件人电话号码错误'
                    when 26 then 'cod金额不正确'
                    when 27 then '无实际包裹'
                    when 28 then '已妥投未交接'
                    when 29 then '收件人电话号码是空号'
                    when 30 then '送错网点'
                    when 31 then '省市乡邮编错误'
                    when 32 then '禁运品'
                    when 33 then '严重破损（丢弃）'
                    when 34 then '退件两次尝试派送失败'
                    when 35 then '不能打开locker'
                    when 36 then 'locker不能使用'
                    when 37 then '该地址找不到lockerstation'
                    when 38 then '一票多件'
                    when 39 then '多次尝试派件失败'
                    when 40 then '客户不在家/电话无人接听'
                    when 41 then '错过班车时间'
                    when 42 then '目的地是偏远地区,留仓待次日派送'
                    when 43 then '目的地是岛屿,留仓待次日派送'
                    when 44 then '企业/机构当天已下班'
                    when 45 then '子母件包裹未全部到达网点'
                    when 46 then '不可抗力原因留仓(台风)'
                    when 47 then '虚假包裹'
                    when 50 then '客户取消寄件'
                    when 51 then '信息录入错误'
                    when 52 then '客户取消寄件'
                    when 53 then 'lazada仓库拒收'
                    when 69 then '禁运品'
                    when 70 then '客户改约时间'
                    when 71 then '当日运力不足，无法派送'
                    when 72 then '客户周末或假期不收货'
                    when 73 then '详细地址错误'
                    when 74 then '收件地址已废弃或不存在'
                    when 75 then '收件人电话号码错误'
                    when 76 then 'cod金额不正确'
                    when 77 then '企业/机构当天已下班'
                    when 78 then '收件人电话号码是空号'
                    when 79 then '快件分错网点-地址错误'
                    when 80 then '客户取消任务'
                    when 81 then '重复下单'
                    when 82 then '已完成揽件'
                    when 83 then '联系不上客户'
                    when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 85 then '寄件人电话号码是空号'
                    when 86 then '包裹不符合揽收条件超大件'
                    when 87 then '包裹不符合揽收条件违禁品'
                    when 88 then '寄件人地址为岛屿'
                    when 89 then '运力短缺，跟客户协商推迟揽收'
                    when 90 then '包裹未准备好推迟揽收'
                    when 91 then '包裹包装不符合运输标准'
                    when 92 then '客户提供的清单里没有此包裹'
                    when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 94 then '客户取消寄件/客户实际不想寄此包裹'
                    when 95 then '车辆/人力短缺推迟揽收'
                    when 96 then '遗漏揽收(已停用)'
                    when 97 then '子母件(一个单号多个包裹)'
                    when 98 then '地址错误addresserror'
                    when 99 then '包裹不符合揽收条件：超大件'
                    when 100 then '包裹不符合揽收条件：违禁品'
                    when 101 then '包裹包装不符合运输标准'
                    when 102 then '包裹未准备好'
                    when 103 then '运力短缺，跟客户协商推迟揽收'
                    when 104 then '子母件(一个单号多个包裹)'
                    when 105 then '破损包裹'
                    when 106 then '空包裹'
                    when 107 then '不能打开locker(密码错误)'
                    when 108 then 'locker不能使用'
                    when 109 then 'locker找不到'
                    when 110 then '运单号与实际包裹的单号不一致'
                    when 111 then 'box客户取消任务'
                    when 112 then '不能打开locker(密码错误)'
                    when 113 then 'locker不能使用'
                    when 114 then 'locker找不到'
                    when 115 then '实际重量尺寸大于客户下单的重量尺寸'
                    when 116 then '客户仓库关闭'
                    when 117 then '客户仓库关闭'
                    when 118 then 'SHOPEE订单系统自动关闭'
                    when 119 then '客户取消包裹'
                    when 121 then '地址错误'
                    when 122 then '当日运力不足，无法揽收'
                end as 疑难件原因
                ,count(if(cdt.negotiation_result_category = 5, di.id, null)) 继续配送
                ,count(if(cdt.negotiation_result_category = 3, di.id, null)) 退货
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 < 2, di.id, null)) '0-2小时'
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 >= 2 and timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 < 4 , di.id, null)) '2-4小时'
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 >= 4 and timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 < 6, di.id, null )) '4-6小时'
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 >= 6 , di.id, null )) '6小时以上'
                ,sum(if(cdt.operator_id not in (10000,10001,100002), timestampdiff(second , cdt.created_at, cdt.updated_at)/3600, null))/count(if(cdt.operator_id not in (10000,10001,100002), di.id, null)) 平均处理时长_h
                ,count(di.id) 总疑难件量
            from ph_staging.diff_info di
            left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
            left join ph_staging.store_diff_ticket sdt on sdt.diff_info_id = di.id
#             left join dwm.dwd_dim_dict tdt2 on di.diff_marker_category= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category' -- 标记原因
            left join ph_staging.parcel_info pi on pi.pno = di.pno
            join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
            where
                di.updated_at >= date_sub('2023-07-27', interval 8 hour )
                and di.updated_at < date_add('2023-07-27', interval 16 hour ) -- 今日处理
                and cdt.state = 1 -- 已处理
                and di.diff_marker_category in (23,73,29,78,25,75,31,79,30,17)
            group by 1,2
            with rollup
        ) a
    order by 1,2
)
# b as
# (
#         select
#         coalesce(a.client_name, '总计') client_name
#         ,coalesce(a.疑难件原因, '总计') 疑难件原因
#         ,a.当日20点后
#         ,a.积压时间0day
#         ,a.积压1天及以上
#     from
#         (
#                 select
#                 coalesce(bc.client_name, '总计') client_name
#                 ,coalesce(tdt2.cn_element, '总计') 疑难件原因
#                 ,count(if(cdt.created_at >= date_add('${date1}', interval 12 hour), di.id, null)) 当日20点后
#                 ,count(if(cdt.created_at < date_add('${date1}', interval 12 hour ) and di.created_at >= date_sub('${date1}', interval 8 hour ), di.id, null)) '积压时间0day'
#                 ,count(if(cdt.created_at < date_sub('${date1}', interval 8 hour ), di.id, null)) '积压1天及以上'
#             from ph_staging.diff_info di
#             left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
#             left join ph_staging.store_diff_ticket sdt2 on sdt2.diff_info_id = di.id
#             left join dwm.dwd_dim_dict tdt2 on di.diff_marker_category= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category' -- 标记原因
#             left join ph_staging.parcel_info pi on pi.pno = di.pno
#             join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
#             where
#                 di.diff_marker_category in (23,73,29,78,25,75,31,79)
#                 and
#                 (
#                     (sdt2.state in (0,1) and di.created_at < date_add('${date1}', interval  16 hour) )
#                     or (sdt2.state = 2 and di.created_at < date_add('${date1}', interval  16 hour) and di.updated_at >= date_add('${date1}', interval  16 hour))
#                 )
#             group by 1,2
#             with rollup
#         ) a
#     order by 1,2
# )
, b as
(
    select
        coalesce(a2.client_name, '总计') client_name
        ,coalesce(a2.疑难件原因, '总计') 疑难件原因
        ,a2.`20-9单量`
        ,a2.`前日20-今日9点处理完成量`
        ,a2.`20-9点11点处理完成量`
        ,a2.`9-20单量`
        ,a2.`9-20已处理单量`
        ,a2.`9-20已处理2小时内量`
    from
        (
           select
                bc.client_name
                ,case di.diff_marker_category # 疑难原因
                    when 1 then '客户不在家/电话无人接听'
                    when 2 then '收件人拒收'
                    when 3 then '快件分错网点'
                    when 4 then '外包装破损'
                    when 5 then '货物破损'
                    when 6 then '货物短少'
                    when 7 then '货物丢失'
                    when 8 then '电话联系不上'
                    when 9 then '客户改约时间'
                    when 10 then '客户不在'
                    when 11 then '客户取消任务'
                    when 12 then '无人签收'
                    when 13 then '客户周末或假期不收货'
                    when 14 then '客户改约时间'
                    when 15 then '当日运力不足，无法派送'
                    when 16 then '联系不上收件人'
                    when 17 then '收件人拒收'
                    when 18 then '快件分错网点'
                    when 19 then '外包装破损'
                    when 20 then '货物破损'
                    when 21 then '货物短少'
                    when 22 then '货物丢失'
                    when 23 then '详细地址错误'
                    when 24 then '收件地址已废弃或不存在'
                    when 25 then '收件人电话号码错误'
                    when 26 then 'cod金额不正确'
                    when 27 then '无实际包裹'
                    when 28 then '已妥投未交接'
                    when 29 then '收件人电话号码是空号'
                    when 30 then '送错网点'
                    when 31 then '省市乡邮编错误'
                    when 32 then '禁运品'
                    when 33 then '严重破损（丢弃）'
                    when 34 then '退件两次尝试派送失败'
                    when 35 then '不能打开locker'
                    when 36 then 'locker不能使用'
                    when 37 then '该地址找不到lockerstation'
                    when 38 then '一票多件'
                    when 39 then '多次尝试派件失败'
                    when 40 then '客户不在家/电话无人接听'
                    when 41 then '错过班车时间'
                    when 42 then '目的地是偏远地区,留仓待次日派送'
                    when 43 then '目的地是岛屿,留仓待次日派送'
                    when 44 then '企业/机构当天已下班'
                    when 45 then '子母件包裹未全部到达网点'
                    when 46 then '不可抗力原因留仓(台风)'
                    when 47 then '虚假包裹'
                    when 50 then '客户取消寄件'
                    when 51 then '信息录入错误'
                    when 52 then '客户取消寄件'
                    when 53 then 'lazada仓库拒收'
                    when 69 then '禁运品'
                    when 70 then '客户改约时间'
                    when 71 then '当日运力不足，无法派送'
                    when 72 then '客户周末或假期不收货'
                    when 73 then '详细地址错误'
                    when 74 then '收件地址已废弃或不存在'
                    when 75 then '收件人电话号码错误'
                    when 76 then 'cod金额不正确'
                    when 77 then '企业/机构当天已下班'
                    when 78 then '收件人电话号码是空号'
                    when 79 then '快件分错网点-地址错误'
                    when 80 then '客户取消任务'
                    when 81 then '重复下单'
                    when 82 then '已完成揽件'
                    when 83 then '联系不上客户'
                    when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 85 then '寄件人电话号码是空号'
                    when 86 then '包裹不符合揽收条件超大件'
                    when 87 then '包裹不符合揽收条件违禁品'
                    when 88 then '寄件人地址为岛屿'
                    when 89 then '运力短缺，跟客户协商推迟揽收'
                    when 90 then '包裹未准备好推迟揽收'
                    when 91 then '包裹包装不符合运输标准'
                    when 92 then '客户提供的清单里没有此包裹'
                    when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 94 then '客户取消寄件/客户实际不想寄此包裹'
                    when 95 then '车辆/人力短缺推迟揽收'
                    when 96 then '遗漏揽收(已停用)'
                    when 97 then '子母件(一个单号多个包裹)'
                    when 98 then '地址错误addresserror'
                    when 99 then '包裹不符合揽收条件：超大件'
                    when 100 then '包裹不符合揽收条件：违禁品'
                    when 101 then '包裹包装不符合运输标准'
                    when 102 then '包裹未准备好'
                    when 103 then '运力短缺，跟客户协商推迟揽收'
                    when 104 then '子母件(一个单号多个包裹)'
                    when 105 then '破损包裹'
                    when 106 then '空包裹'
                    when 107 then '不能打开locker(密码错误)'
                    when 108 then 'locker不能使用'
                    when 109 then 'locker找不到'
                    when 110 then '运单号与实际包裹的单号不一致'
                    when 111 then 'box客户取消任务'
                    when 112 then '不能打开locker(密码错误)'
                    when 113 then 'locker不能使用'
                    when 114 then 'locker找不到'
                    when 115 then '实际重量尺寸大于客户下单的重量尺寸'
                    when 116 then '客户仓库关闭'
                    when 117 then '客户仓库关闭'
                    when 118 then 'SHOPEE订单系统自动关闭'
                    when 119 then '客户取消包裹'
                    when 121 then '地址错误'
                    when 122 then '当日运力不足，无法揽收'
                end as 疑难件原因
                ,count(if(di.created_at >= date_sub('2023-07-27', interval 12 hour) and di.created_at < date_add('2023-07-27', interval  1 hour), di.id, null)) '20-9单量'
                ,count(if(di.created_at >= date_sub('2023-07-27', interval 12 hour) and di.created_at < date_add('2023-07-27', interval  1 hour) and cdt.state = 1 , di.id, null)) '前日20-今日9点处理完成量'
                ,count(if(di.created_at >= date_sub('2023-07-27', interval 12 hour) and di.created_at < date_add('2023-07-27', interval  1 hour) and cdt.state = 1 and cdt.updated_at < date_add('2023-07-27', interval  3 hour ) , di.id, null)) '20-9点11点处理完成量'
                ,count(if(di.created_at >= date_add('2023-07-27', interval  1 hour) and di.created_at < date_add('2023-07-27', interval 12 hour), di.id, null)) '9-20单量'
                ,count(if(di.created_at >= date_add('2023-07-27', interval  1 hour) and di.created_at < date_add('2023-07-27', interval 12 hour) and cdt.state = 1 , di.id, null)) '9-20已处理单量'
                ,count(if(di.created_at >= date_add('2023-07-27', interval  1 hour) and di.created_at < date_add('2023-07-27', interval 12 hour) and cdt.state = 1 and cdt.updated_at < date_add(di.created_at, interval  2 hour ), di.id, null)) '9-20已处理2小时内量'
            from ph_staging.diff_info di
            join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
            left join ph_staging.store_diff_ticket sdt2 on sdt2.diff_info_id = di.id
#             left join dwm.dwd_dim_dict tdt2 on di.diff_marker_category= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category' -- 标记原因
            left join ph_staging.parcel_info pi on pi.pno = di.pno
            join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
            where
                di.diff_marker_category in (23,73,29,78,25,75,31,79)
                and di.created_at >= date_sub('2023-07-27', interval 12 hour)
                and di.created_at < date_add('2023-07-27', interval 12 hour )
            group by 1,2
            with rollup
        ) a2
)
select
    t1.client_name
    ,t1.疑难件原因
    ,a1.`0-2小时`
    ,a1.`2-4小时`
    ,a1.`4-6小时`
    ,a1.`6小时以上`
    ,a1.继续配送
    ,a1.退货
    ,a1.平均处理时长_h
    ,a1.总疑难件量
    ,b1.`20-9单量`
    ,b1.`前日20-今日9点处理完成量`
    ,b1.`20-9点11点处理完成量`
    ,b1.`9-20单量`
    ,b1.`9-20已处理单量`
    ,b1.`9-20已处理2小时内量`
from
    (
        select
            t1.疑难件原因
            ,t1.client_name
        from
            (
                select
                    a.client_name
                    ,a.疑难件原因
                from a

                union

                select
                    b.client_name
                    ,b.疑难件原因
                from b
            ) t1
        group by 1,2
    ) t1
left join a a1 on t1.client_name = a1.client_name and t1.疑难件原因 = a1.疑难件原因
left join b b1 on t1.client_name = b1.client_name and t1.疑难件原因 = b1.疑难件原因
order by t1.client_name,case t1.疑难件原因
                            when '总计' then 1
                            when '详细地址错误' then 2
                            when '收件人电话号码是空号' then 3
                            when '收件人电话号码错误' then 4
                            when '省市乡邮编错误' then 5
                        end;
;-- -. . -..- - / . -. - .-. -.--
with a as
(
    select
        coalesce(a.client_name, '总计') client_name
        ,coalesce(a.疑难件原因, '总计') 疑难件原因
        ,a.`0-2小时`
        ,a.`2-4小时`
        ,a.`4-6小时`
        ,a.`6小时以上`
        ,a.总疑难件量
        ,a.继续配送
        ,a.退货
        ,a.平均处理时长_h
    from
        (
            select
                bc.client_name
                ,case di.diff_marker_category # 疑难原因
                    when 1 then '客户不在家/电话无人接听'
                    when 2 then '收件人拒收'
                    when 3 then '快件分错网点'
                    when 4 then '外包装破损'
                    when 5 then '货物破损'
                    when 6 then '货物短少'
                    when 7 then '货物丢失'
                    when 8 then '电话联系不上'
                    when 9 then '客户改约时间'
                    when 10 then '客户不在'
                    when 11 then '客户取消任务'
                    when 12 then '无人签收'
                    when 13 then '客户周末或假期不收货'
                    when 14 then '客户改约时间'
                    when 15 then '当日运力不足，无法派送'
                    when 16 then '联系不上收件人'
                    when 17 then '收件人拒收'
                    when 18 then '快件分错网点'
                    when 19 then '外包装破损'
                    when 20 then '货物破损'
                    when 21 then '货物短少'
                    when 22 then '货物丢失'
                    when 23 then '详细地址错误'
                    when 24 then '收件地址已废弃或不存在'
                    when 25 then '收件人电话号码错误'
                    when 26 then 'cod金额不正确'
                    when 27 then '无实际包裹'
                    when 28 then '已妥投未交接'
                    when 29 then '收件人电话号码是空号'
                    when 30 then '送错网点'
                    when 31 then '省市乡邮编错误'
                    when 32 then '禁运品'
                    when 33 then '严重破损（丢弃）'
                    when 34 then '退件两次尝试派送失败'
                    when 35 then '不能打开locker'
                    when 36 then 'locker不能使用'
                    when 37 then '该地址找不到lockerstation'
                    when 38 then '一票多件'
                    when 39 then '多次尝试派件失败'
                    when 40 then '客户不在家/电话无人接听'
                    when 41 then '错过班车时间'
                    when 42 then '目的地是偏远地区,留仓待次日派送'
                    when 43 then '目的地是岛屿,留仓待次日派送'
                    when 44 then '企业/机构当天已下班'
                    when 45 then '子母件包裹未全部到达网点'
                    when 46 then '不可抗力原因留仓(台风)'
                    when 47 then '虚假包裹'
                    when 50 then '客户取消寄件'
                    when 51 then '信息录入错误'
                    when 52 then '客户取消寄件'
                    when 53 then 'lazada仓库拒收'
                    when 69 then '禁运品'
                    when 70 then '客户改约时间'
                    when 71 then '当日运力不足，无法派送'
                    when 72 then '客户周末或假期不收货'
                    when 73 then '详细地址错误'
                    when 74 then '收件地址已废弃或不存在'
                    when 75 then '收件人电话号码错误'
                    when 76 then 'cod金额不正确'
                    when 77 then '企业/机构当天已下班'
                    when 78 then '收件人电话号码是空号'
                    when 79 then '快件分错网点-地址错误'
                    when 80 then '客户取消任务'
                    when 81 then '重复下单'
                    when 82 then '已完成揽件'
                    when 83 then '联系不上客户'
                    when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 85 then '寄件人电话号码是空号'
                    when 86 then '包裹不符合揽收条件超大件'
                    when 87 then '包裹不符合揽收条件违禁品'
                    when 88 then '寄件人地址为岛屿'
                    when 89 then '运力短缺，跟客户协商推迟揽收'
                    when 90 then '包裹未准备好推迟揽收'
                    when 91 then '包裹包装不符合运输标准'
                    when 92 then '客户提供的清单里没有此包裹'
                    when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 94 then '客户取消寄件/客户实际不想寄此包裹'
                    when 95 then '车辆/人力短缺推迟揽收'
                    when 96 then '遗漏揽收(已停用)'
                    when 97 then '子母件(一个单号多个包裹)'
                    when 98 then '地址错误addresserror'
                    when 99 then '包裹不符合揽收条件：超大件'
                    when 100 then '包裹不符合揽收条件：违禁品'
                    when 101 then '包裹包装不符合运输标准'
                    when 102 then '包裹未准备好'
                    when 103 then '运力短缺，跟客户协商推迟揽收'
                    when 104 then '子母件(一个单号多个包裹)'
                    when 105 then '破损包裹'
                    when 106 then '空包裹'
                    when 107 then '不能打开locker(密码错误)'
                    when 108 then 'locker不能使用'
                    when 109 then 'locker找不到'
                    when 110 then '运单号与实际包裹的单号不一致'
                    when 111 then 'box客户取消任务'
                    when 112 then '不能打开locker(密码错误)'
                    when 113 then 'locker不能使用'
                    when 114 then 'locker找不到'
                    when 115 then '实际重量尺寸大于客户下单的重量尺寸'
                    when 116 then '客户仓库关闭'
                    when 117 then '客户仓库关闭'
                    when 118 then 'SHOPEE订单系统自动关闭'
                    when 119 then '客户取消包裹'
                    when 121 then '地址错误'
                    when 122 then '当日运力不足，无法揽收'
                end as 疑难件原因
                ,count(if(cdt.negotiation_result_category = 5, di.id, null)) 继续配送
                ,count(if(cdt.negotiation_result_category = 3, di.id, null)) 退货
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 < 2, di.id, null)) '0-2小时'
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 >= 2 and timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 < 4 , di.id, null)) '2-4小时'
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 >= 4 and timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 < 6, di.id, null )) '4-6小时'
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 >= 6 , di.id, null )) '6小时以上'
                ,sum(if(cdt.operator_id not in (10000,10001,100002), timestampdiff(second , cdt.created_at, cdt.updated_at)/3600, null))/count(if(cdt.operator_id not in (10000,10001,100002), di.id, null)) 平均处理时长_h
                ,count(di.id) 总疑难件量
            from ph_staging.diff_info di
            left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
            left join ph_staging.store_diff_ticket sdt on sdt.diff_info_id = di.id
#             left join dwm.dwd_dim_dict tdt2 on di.diff_marker_category= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category' -- 标记原因
            left join ph_staging.parcel_info pi on pi.pno = di.pno
            join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
            where
                di.updated_at >= date_sub('2023-07-27', interval 8 hour )
                and di.updated_at < date_add('2023-07-27', interval 16 hour ) -- 今日处理
                and cdt.state = 1 -- 已处理
                and di.diff_marker_category in (23,73,29,78,25,75,31,79,30,17)
            group by 1,2
            with rollup
        ) a
    order by 1,2
)
# b as
# (
#         select
#         coalesce(a.client_name, '总计') client_name
#         ,coalesce(a.疑难件原因, '总计') 疑难件原因
#         ,a.当日20点后
#         ,a.积压时间0day
#         ,a.积压1天及以上
#     from
#         (
#                 select
#                 coalesce(bc.client_name, '总计') client_name
#                 ,coalesce(tdt2.cn_element, '总计') 疑难件原因
#                 ,count(if(cdt.created_at >= date_add('${date1}', interval 12 hour), di.id, null)) 当日20点后
#                 ,count(if(cdt.created_at < date_add('${date1}', interval 12 hour ) and di.created_at >= date_sub('${date1}', interval 8 hour ), di.id, null)) '积压时间0day'
#                 ,count(if(cdt.created_at < date_sub('${date1}', interval 8 hour ), di.id, null)) '积压1天及以上'
#             from ph_staging.diff_info di
#             left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
#             left join ph_staging.store_diff_ticket sdt2 on sdt2.diff_info_id = di.id
#             left join dwm.dwd_dim_dict tdt2 on di.diff_marker_category= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category' -- 标记原因
#             left join ph_staging.parcel_info pi on pi.pno = di.pno
#             join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
#             where
#                 di.diff_marker_category in (23,73,29,78,25,75,31,79)
#                 and
#                 (
#                     (sdt2.state in (0,1) and di.created_at < date_add('${date1}', interval  16 hour) )
#                     or (sdt2.state = 2 and di.created_at < date_add('${date1}', interval  16 hour) and di.updated_at >= date_add('${date1}', interval  16 hour))
#                 )
#             group by 1,2
#             with rollup
#         ) a
#     order by 1,2
# )
, b as
(
    select
        coalesce(a2.client_name, '总计') client_name
        ,coalesce(a2.疑难件原因, '总计') 疑难件原因
        ,a2.`20-9单量`
        ,a2.`前日20-今日9点处理完成量`
        ,a2.`20-9点11点处理完成量`
        ,a2.`9-20单量`
        ,a2.`9-20已处理单量`
        ,a2.`9-20已处理2小时内量`
    from
        (
           select
                bc.client_name
                ,case di.diff_marker_category # 疑难原因
                    when 1 then '客户不在家/电话无人接听'
                    when 2 then '收件人拒收'
                    when 3 then '快件分错网点'
                    when 4 then '外包装破损'
                    when 5 then '货物破损'
                    when 6 then '货物短少'
                    when 7 then '货物丢失'
                    when 8 then '电话联系不上'
                    when 9 then '客户改约时间'
                    when 10 then '客户不在'
                    when 11 then '客户取消任务'
                    when 12 then '无人签收'
                    when 13 then '客户周末或假期不收货'
                    when 14 then '客户改约时间'
                    when 15 then '当日运力不足，无法派送'
                    when 16 then '联系不上收件人'
                    when 17 then '收件人拒收'
                    when 18 then '快件分错网点'
                    when 19 then '外包装破损'
                    when 20 then '货物破损'
                    when 21 then '货物短少'
                    when 22 then '货物丢失'
                    when 23 then '详细地址错误'
                    when 24 then '收件地址已废弃或不存在'
                    when 25 then '收件人电话号码错误'
                    when 26 then 'cod金额不正确'
                    when 27 then '无实际包裹'
                    when 28 then '已妥投未交接'
                    when 29 then '收件人电话号码是空号'
                    when 30 then '送错网点'
                    when 31 then '省市乡邮编错误'
                    when 32 then '禁运品'
                    when 33 then '严重破损（丢弃）'
                    when 34 then '退件两次尝试派送失败'
                    when 35 then '不能打开locker'
                    when 36 then 'locker不能使用'
                    when 37 then '该地址找不到lockerstation'
                    when 38 then '一票多件'
                    when 39 then '多次尝试派件失败'
                    when 40 then '客户不在家/电话无人接听'
                    when 41 then '错过班车时间'
                    when 42 then '目的地是偏远地区,留仓待次日派送'
                    when 43 then '目的地是岛屿,留仓待次日派送'
                    when 44 then '企业/机构当天已下班'
                    when 45 then '子母件包裹未全部到达网点'
                    when 46 then '不可抗力原因留仓(台风)'
                    when 47 then '虚假包裹'
                    when 50 then '客户取消寄件'
                    when 51 then '信息录入错误'
                    when 52 then '客户取消寄件'
                    when 53 then 'lazada仓库拒收'
                    when 69 then '禁运品'
                    when 70 then '客户改约时间'
                    when 71 then '当日运力不足，无法派送'
                    when 72 then '客户周末或假期不收货'
                    when 73 then '详细地址错误'
                    when 74 then '收件地址已废弃或不存在'
                    when 75 then '收件人电话号码错误'
                    when 76 then 'cod金额不正确'
                    when 77 then '企业/机构当天已下班'
                    when 78 then '收件人电话号码是空号'
                    when 79 then '快件分错网点-地址错误'
                    when 80 then '客户取消任务'
                    when 81 then '重复下单'
                    when 82 then '已完成揽件'
                    when 83 then '联系不上客户'
                    when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 85 then '寄件人电话号码是空号'
                    when 86 then '包裹不符合揽收条件超大件'
                    when 87 then '包裹不符合揽收条件违禁品'
                    when 88 then '寄件人地址为岛屿'
                    when 89 then '运力短缺，跟客户协商推迟揽收'
                    when 90 then '包裹未准备好推迟揽收'
                    when 91 then '包裹包装不符合运输标准'
                    when 92 then '客户提供的清单里没有此包裹'
                    when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 94 then '客户取消寄件/客户实际不想寄此包裹'
                    when 95 then '车辆/人力短缺推迟揽收'
                    when 96 then '遗漏揽收(已停用)'
                    when 97 then '子母件(一个单号多个包裹)'
                    when 98 then '地址错误addresserror'
                    when 99 then '包裹不符合揽收条件：超大件'
                    when 100 then '包裹不符合揽收条件：违禁品'
                    when 101 then '包裹包装不符合运输标准'
                    when 102 then '包裹未准备好'
                    when 103 then '运力短缺，跟客户协商推迟揽收'
                    when 104 then '子母件(一个单号多个包裹)'
                    when 105 then '破损包裹'
                    when 106 then '空包裹'
                    when 107 then '不能打开locker(密码错误)'
                    when 108 then 'locker不能使用'
                    when 109 then 'locker找不到'
                    when 110 then '运单号与实际包裹的单号不一致'
                    when 111 then 'box客户取消任务'
                    when 112 then '不能打开locker(密码错误)'
                    when 113 then 'locker不能使用'
                    when 114 then 'locker找不到'
                    when 115 then '实际重量尺寸大于客户下单的重量尺寸'
                    when 116 then '客户仓库关闭'
                    when 117 then '客户仓库关闭'
                    when 118 then 'SHOPEE订单系统自动关闭'
                    when 119 then '客户取消包裹'
                    when 121 then '地址错误'
                    when 122 then '当日运力不足，无法揽收'
                end as 疑难件原因
                ,count(if(di.created_at >= date_sub('2023-07-27', interval 12 hour) and di.created_at < date_add('2023-07-27', interval  1 hour), di.id, null)) '20-9单量'
                ,count(if(di.created_at >= date_sub('2023-07-27', interval 12 hour) and di.created_at < date_add('2023-07-27', interval  1 hour) and cdt.state = 1 , di.id, null)) '前日20-今日9点处理完成量'
                ,count(if(di.created_at >= date_sub('2023-07-27', interval 12 hour) and di.created_at < date_add('2023-07-27', interval  1 hour) and cdt.state = 1 and cdt.updated_at < date_add('2023-07-27', interval  3 hour ) , di.id, null)) '20-9点11点处理完成量'
                ,count(if(di.created_at >= date_add('2023-07-27', interval  1 hour) and di.created_at < date_add('2023-07-27', interval 12 hour), di.id, null)) '9-20单量'
                ,count(if(di.created_at >= date_add('2023-07-27', interval  1 hour) and di.created_at < date_add('2023-07-27', interval 12 hour) and cdt.state = 1 , di.id, null)) '9-20已处理单量'
                ,count(if(di.created_at >= date_add('2023-07-27', interval  1 hour) and di.created_at < date_add('2023-07-27', interval 12 hour) and cdt.state = 1 and cdt.updated_at < date_add(di.created_at, interval  2 hour ), di.id, null)) '9-20已处理2小时内量'
            from ph_staging.diff_info di
            join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
            left join ph_staging.store_diff_ticket sdt2 on sdt2.diff_info_id = di.id
#             left join dwm.dwd_dim_dict tdt2 on di.diff_marker_category= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category' -- 标记原因
            left join ph_staging.parcel_info pi on pi.pno = di.pno
            join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
            where
                di.diff_marker_category in (23,73,29,78,25,75,31,79,17)
                and di.created_at >= date_sub('2023-07-27', interval 12 hour)
                and di.created_at < date_add('2023-07-27', interval 12 hour )
            group by 1,2
            with rollup
        ) a2
)
select
    t1.client_name
    ,t1.疑难件原因
    ,a1.`0-2小时`
    ,a1.`2-4小时`
    ,a1.`4-6小时`
    ,a1.`6小时以上`
    ,a1.继续配送
    ,a1.退货
    ,a1.平均处理时长_h
    ,a1.总疑难件量
    ,b1.`20-9单量`
    ,b1.`前日20-今日9点处理完成量`
    ,b1.`20-9点11点处理完成量`
    ,b1.`9-20单量`
    ,b1.`9-20已处理单量`
    ,b1.`9-20已处理2小时内量`
from
    (
        select
            t1.疑难件原因
            ,t1.client_name
        from
            (
                select
                    a.client_name
                    ,a.疑难件原因
                from a

                union

                select
                    b.client_name
                    ,b.疑难件原因
                from b
            ) t1
        group by 1,2
    ) t1
left join a a1 on t1.client_name = a1.client_name and t1.疑难件原因 = a1.疑难件原因
left join b b1 on t1.client_name = b1.client_name and t1.疑难件原因 = b1.疑难件原因
order by t1.client_name,case t1.疑难件原因
                            when '总计' then 1
                            when '详细地址错误' then 2
                            when '收件人电话号码是空号' then 3
                            when '收件人电话号码错误' then 4
                            when '省市乡邮编错误' then 5
                        end;
;-- -. . -..- - / . -. - .-. -.--
with a as
(
    select
        coalesce(a.client_name, '总计') client_name
        ,coalesce(a.疑难件原因, '总计') 疑难件原因
        ,a.`0-2小时`
        ,a.`2-4小时`
        ,a.`4-6小时`
        ,a.`6小时以上`
        ,a.总疑难件量
        ,a.继续配送
        ,a.退货
        ,a.平均处理时长_h
    from
        (
            select
                bc.client_name
                ,case di.diff_marker_category # 疑难原因
                    when 1 then '客户不在家/电话无人接听'
                    when 2 then '收件人拒收'
                    when 3 then '快件分错网点'
                    when 4 then '外包装破损'
                    when 5 then '货物破损'
                    when 6 then '货物短少'
                    when 7 then '货物丢失'
                    when 8 then '电话联系不上'
                    when 9 then '客户改约时间'
                    when 10 then '客户不在'
                    when 11 then '客户取消任务'
                    when 12 then '无人签收'
                    when 13 then '客户周末或假期不收货'
                    when 14 then '客户改约时间'
                    when 15 then '当日运力不足，无法派送'
                    when 16 then '联系不上收件人'
                    when 17 then '收件人拒收'
                    when 18 then '快件分错网点'
                    when 19 then '外包装破损'
                    when 20 then '货物破损'
                    when 21 then '货物短少'
                    when 22 then '货物丢失'
                    when 23 then '详细地址错误'
                    when 24 then '收件地址已废弃或不存在'
                    when 25 then '收件人电话号码错误'
                    when 26 then 'cod金额不正确'
                    when 27 then '无实际包裹'
                    when 28 then '已妥投未交接'
                    when 29 then '收件人电话号码是空号'
                    when 30 then '送错网点'
                    when 31 then '省市乡邮编错误'
                    when 32 then '禁运品'
                    when 33 then '严重破损（丢弃）'
                    when 34 then '退件两次尝试派送失败'
                    when 35 then '不能打开locker'
                    when 36 then 'locker不能使用'
                    when 37 then '该地址找不到lockerstation'
                    when 38 then '一票多件'
                    when 39 then '多次尝试派件失败'
                    when 40 then '客户不在家/电话无人接听'
                    when 41 then '错过班车时间'
                    when 42 then '目的地是偏远地区,留仓待次日派送'
                    when 43 then '目的地是岛屿,留仓待次日派送'
                    when 44 then '企业/机构当天已下班'
                    when 45 then '子母件包裹未全部到达网点'
                    when 46 then '不可抗力原因留仓(台风)'
                    when 47 then '虚假包裹'
                    when 50 then '客户取消寄件'
                    when 51 then '信息录入错误'
                    when 52 then '客户取消寄件'
                    when 53 then 'lazada仓库拒收'
                    when 69 then '禁运品'
                    when 70 then '客户改约时间'
                    when 71 then '当日运力不足，无法派送'
                    when 72 then '客户周末或假期不收货'
                    when 73 then '详细地址错误'
                    when 74 then '收件地址已废弃或不存在'
                    when 75 then '收件人电话号码错误'
                    when 76 then 'cod金额不正确'
                    when 77 then '企业/机构当天已下班'
                    when 78 then '收件人电话号码是空号'
                    when 79 then '快件分错网点-地址错误'
                    when 80 then '客户取消任务'
                    when 81 then '重复下单'
                    when 82 then '已完成揽件'
                    when 83 then '联系不上客户'
                    when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 85 then '寄件人电话号码是空号'
                    when 86 then '包裹不符合揽收条件超大件'
                    when 87 then '包裹不符合揽收条件违禁品'
                    when 88 then '寄件人地址为岛屿'
                    when 89 then '运力短缺，跟客户协商推迟揽收'
                    when 90 then '包裹未准备好推迟揽收'
                    when 91 then '包裹包装不符合运输标准'
                    when 92 then '客户提供的清单里没有此包裹'
                    when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 94 then '客户取消寄件/客户实际不想寄此包裹'
                    when 95 then '车辆/人力短缺推迟揽收'
                    when 96 then '遗漏揽收(已停用)'
                    when 97 then '子母件(一个单号多个包裹)'
                    when 98 then '地址错误addresserror'
                    when 99 then '包裹不符合揽收条件：超大件'
                    when 100 then '包裹不符合揽收条件：违禁品'
                    when 101 then '包裹包装不符合运输标准'
                    when 102 then '包裹未准备好'
                    when 103 then '运力短缺，跟客户协商推迟揽收'
                    when 104 then '子母件(一个单号多个包裹)'
                    when 105 then '破损包裹'
                    when 106 then '空包裹'
                    when 107 then '不能打开locker(密码错误)'
                    when 108 then 'locker不能使用'
                    when 109 then 'locker找不到'
                    when 110 then '运单号与实际包裹的单号不一致'
                    when 111 then 'box客户取消任务'
                    when 112 then '不能打开locker(密码错误)'
                    when 113 then 'locker不能使用'
                    when 114 then 'locker找不到'
                    when 115 then '实际重量尺寸大于客户下单的重量尺寸'
                    when 116 then '客户仓库关闭'
                    when 117 then '客户仓库关闭'
                    when 118 then 'SHOPEE订单系统自动关闭'
                    when 119 then '客户取消包裹'
                    when 121 then '地址错误'
                    when 122 then '当日运力不足，无法揽收'
                end as 疑难件原因
                ,count(if(cdt.negotiation_result_category = 5, di.id, null)) 继续配送
                ,count(if(cdt.negotiation_result_category = 3, di.id, null)) 退货
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 < 2, di.id, null)) '0-2小时'
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 >= 2 and timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 < 4 , di.id, null)) '2-4小时'
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 >= 4 and timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 < 6, di.id, null )) '4-6小时'
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 >= 6 , di.id, null )) '6小时以上'
                ,sum(if(cdt.operator_id not in (10000,10001,100002), timestampdiff(second , cdt.created_at, cdt.updated_at)/3600, null))/count(if(cdt.operator_id not in (10000,10001,100002), di.id, null)) 平均处理时长_h
                ,count(di.id) 总疑难件量
            from ph_staging.diff_info di
            left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
            left join ph_staging.store_diff_ticket sdt on sdt.diff_info_id = di.id
#             left join dwm.dwd_dim_dict tdt2 on di.diff_marker_category= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category' -- 标记原因
            left join ph_staging.parcel_info pi on pi.pno = di.pno
            join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
            where
                di.updated_at >= date_sub('2023-07-27', interval 8 hour )
                and di.updated_at < date_add('2023-07-27', interval 16 hour ) -- 今日处理
                and cdt.state = 1 -- 已处理
                and if(bc.client_name in ('shopee', 'tiktok'), di.diff_marker_category in (23,73,29,78,25,75,31,79), di.diff_marker_category in (23,73,29,78,25,75,31,79,17))
            group by 1,2
            with rollup
        ) a
    order by 1,2
)
, b as
(
    select
        coalesce(a2.client_name, '总计') client_name
        ,coalesce(a2.疑难件原因, '总计') 疑难件原因
        ,a2.`20-9单量`
        ,a2.`前日20-今日9点处理完成量`
        ,a2.`20-9点11点处理完成量`
        ,a2.`9-20单量`
        ,a2.`9-20已处理单量`
        ,a2.`9-20已处理2小时内量`
    from
        (
           select
                bc.client_name
                ,case di.diff_marker_category
                    when 1 then '客户不在家/电话无人接听'
                    when 2 then '收件人拒收'
                    when 3 then '快件分错网点'
                    when 4 then '外包装破损'
                    when 5 then '货物破损'
                    when 6 then '货物短少'
                    when 7 then '货物丢失'
                    when 8 then '电话联系不上'
                    when 9 then '客户改约时间'
                    when 10 then '客户不在'
                    when 11 then '客户取消任务'
                    when 12 then '无人签收'
                    when 13 then '客户周末或假期不收货'
                    when 14 then '客户改约时间'
                    when 15 then '当日运力不足，无法派送'
                    when 16 then '联系不上收件人'
                    when 17 then '收件人拒收'
                    when 18 then '快件分错网点'
                    when 19 then '外包装破损'
                    when 20 then '货物破损'
                    when 21 then '货物短少'
                    when 22 then '货物丢失'
                    when 23 then '详细地址错误'
                    when 24 then '收件地址已废弃或不存在'
                    when 25 then '收件人电话号码错误'
                    when 26 then 'cod金额不正确'
                    when 27 then '无实际包裹'
                    when 28 then '已妥投未交接'
                    when 29 then '收件人电话号码是空号'
                    when 30 then '送错网点'
                    when 31 then '省市乡邮编错误'
                    when 32 then '禁运品'
                    when 33 then '严重破损（丢弃）'
                    when 34 then '退件两次尝试派送失败'
                    when 35 then '不能打开locker'
                    when 36 then 'locker不能使用'
                    when 37 then '该地址找不到lockerstation'
                    when 38 then '一票多件'
                    when 39 then '多次尝试派件失败'
                    when 40 then '客户不在家/电话无人接听'
                    when 41 then '错过班车时间'
                    when 42 then '目的地是偏远地区,留仓待次日派送'
                    when 43 then '目的地是岛屿,留仓待次日派送'
                    when 44 then '企业/机构当天已下班'
                    when 45 then '子母件包裹未全部到达网点'
                    when 46 then '不可抗力原因留仓(台风)'
                    when 47 then '虚假包裹'
                    when 50 then '客户取消寄件'
                    when 51 then '信息录入错误'
                    when 52 then '客户取消寄件'
                    when 53 then 'lazada仓库拒收'
                    when 69 then '禁运品'
                    when 70 then '客户改约时间'
                    when 71 then '当日运力不足，无法派送'
                    when 72 then '客户周末或假期不收货'
                    when 73 then '详细地址错误'
                    when 74 then '收件地址已废弃或不存在'
                    when 75 then '收件人电话号码错误'
                    when 76 then 'cod金额不正确'
                    when 77 then '企业/机构当天已下班'
                    when 78 then '收件人电话号码是空号'
                    when 79 then '快件分错网点-地址错误'
                    when 80 then '客户取消任务'
                    when 81 then '重复下单'
                    when 82 then '已完成揽件'
                    when 83 then '联系不上客户'
                    when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 85 then '寄件人电话号码是空号'
                    when 86 then '包裹不符合揽收条件超大件'
                    when 87 then '包裹不符合揽收条件违禁品'
                    when 88 then '寄件人地址为岛屿'
                    when 89 then '运力短缺，跟客户协商推迟揽收'
                    when 90 then '包裹未准备好推迟揽收'
                    when 91 then '包裹包装不符合运输标准'
                    when 92 then '客户提供的清单里没有此包裹'
                    when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 94 then '客户取消寄件/客户实际不想寄此包裹'
                    when 95 then '车辆/人力短缺推迟揽收'
                    when 96 then '遗漏揽收(已停用)'
                    when 97 then '子母件(一个单号多个包裹)'
                    when 98 then '地址错误addresserror'
                    when 99 then '包裹不符合揽收条件：超大件'
                    when 100 then '包裹不符合揽收条件：违禁品'
                    when 101 then '包裹包装不符合运输标准'
                    when 102 then '包裹未准备好'
                    when 103 then '运力短缺，跟客户协商推迟揽收'
                    when 104 then '子母件(一个单号多个包裹)'
                    when 105 then '破损包裹'
                    when 106 then '空包裹'
                    when 107 then '不能打开locker(密码错误)'
                    when 108 then 'locker不能使用'
                    when 109 then 'locker找不到'
                    when 110 then '运单号与实际包裹的单号不一致'
                    when 111 then 'box客户取消任务'
                    when 112 then '不能打开locker(密码错误)'
                    when 113 then 'locker不能使用'
                    when 114 then 'locker找不到'
                    when 115 then '实际重量尺寸大于客户下单的重量尺寸'
                    when 116 then '客户仓库关闭'
                    when 117 then '客户仓库关闭'
                    when 118 then 'SHOPEE订单系统自动关闭'
                    when 119 then '客户取消包裹'
                    when 121 then '地址错误'
                    when 122 then '当日运力不足，无法揽收'
                end as 疑难件原因
                ,count(if(di.created_at >= date_sub('2023-07-27', interval 12 hour) and di.created_at < date_add('2023-07-27', interval  1 hour), di.id, null)) '20-9单量'
                ,count(if(di.created_at >= date_sub('2023-07-27', interval 12 hour) and di.created_at < date_add('2023-07-27', interval  1 hour) and cdt.state = 1 , di.id, null)) '前日20-今日9点处理完成量'
                ,count(if(di.created_at >= date_sub('2023-07-27', interval 12 hour) and di.created_at < date_add('2023-07-27', interval  1 hour) and cdt.state = 1 and cdt.updated_at < date_add('2023-07-27', interval  3 hour ) , di.id, null)) '20-9点11点处理完成量'
                ,count(if(di.created_at >= date_add('2023-07-27', interval  1 hour) and di.created_at < date_add('2023-07-27', interval 12 hour), di.id, null)) '9-20单量'
                ,count(if(di.created_at >= date_add('2023-07-27', interval  1 hour) and di.created_at < date_add('2023-07-27', interval 12 hour) and cdt.state = 1 , di.id, null)) '9-20已处理单量'
                ,count(if(di.created_at >= date_add('2023-07-27', interval  1 hour) and di.created_at < date_add('2023-07-27', interval 12 hour) and cdt.state = 1 and cdt.updated_at < date_add(di.created_at, interval  2 hour ), di.id, null)) '9-20已处理2小时内量'
            from ph_staging.diff_info di
            join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
            left join ph_staging.store_diff_ticket sdt2 on sdt2.diff_info_id = di.id
#             left join dwm.dwd_dim_dict tdt2 on di.diff_marker_category= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category' -- 标记原因
            left join ph_staging.parcel_info pi on pi.pno = di.pno
            join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
            where
                if(bc.client_name in ('shopee', 'tiktok'), di.diff_marker_category in (23,73,29,78,25,75,31,79), di.diff_marker_category in (23,73,29,78,25,75,31,79,17))
                and di.created_at >= date_sub('2023-07-27', interval 12 hour)
                and di.created_at < date_add('2023-07-27', interval 12 hour )
            group by 1,2
            with rollup
        ) a2
)
select
    t1.client_name
    ,t1.疑难件原因
    ,a1.`0-2小时`
    ,a1.`2-4小时`
    ,a1.`4-6小时`
    ,a1.`6小时以上`
    ,a1.继续配送
    ,a1.退货
    ,a1.平均处理时长_h
    ,a1.总疑难件量
    ,b1.`20-9单量`
    ,b1.`前日20-今日9点处理完成量`
    ,b1.`20-9点11点处理完成量`
    ,b1.`9-20单量`
    ,b1.`9-20已处理单量`
    ,b1.`9-20已处理2小时内量`
from
    (
        select
            t1.疑难件原因
            ,t1.client_name
        from
            (
                select
                    a.client_name
                    ,a.疑难件原因
                from a

                union

                select
                    b.client_name
                    ,b.疑难件原因
                from b
            ) t1
        group by 1,2
    ) t1
left join a a1 on t1.client_name = a1.client_name and t1.疑难件原因 = a1.疑难件原因
left join b b1 on t1.client_name = b1.client_name and t1.疑难件原因 = b1.疑难件原因
order by t1.client_name,case t1.疑难件原因
                            when '总计' then 1
                            when '详细地址错误' then 2
                            when '收件人电话号码是空号' then 3
                            when '收件人电话号码错误' then 4
                            when '省市乡邮编错误' then 5
                        end;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        pi.pno
        ,pi.state
        ,pi.ticket_pickup_store_id
        ,pi.returned
        ,pi.dst_store_id
        ,pi.client_id
        ,pi.cod_enabled
    from ph_staging.parcel_info pi
    where
        pi.created_at < '2023-06-28 16:00:00'
        and pi.state not in (5,7,8,9)
)
select
    t1.pno
    ,if(t1.returned = 1, '退件', '正向件')  方向
    ,t1.client_id 客户ID
    ,case
        when bc.`client_id` is not null then bc.client_name
        when kp.id is not null and bc.client_id is null then '普通ka'
        when kp.`id` is null then '小c'
    end as 客户类型
    ,case t1.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,case di.diff_marker_category # 疑难原因
        when 1 then '客户不在家/电话无人接听'
        when 2 then '收件人拒收'
        when 3 then '快件分错网点'
        when 4 then '外包装破损'
        when 5 then '货物破损'
        when 6 then '货物短少'
        when 7 then '货物丢失'
        when 8 then '电话联系不上'
        when 9 then '客户改约时间'
        when 10 then '客户不在'
        when 11 then '客户取消任务'
        when 12 then '无人签收'
        when 13 then '客户周末或假期不收货'
        when 14 then '客户改约时间'
        when 15 then '当日运力不足，无法派送'
        when 16 then '联系不上收件人'
        when 17 then '收件人拒收'
        when 18 then '快件分错网点'
        when 19 then '外包装破损'
        when 20 then '货物破损'
        when 21 then '货物短少'
        when 22 then '货物丢失'
        when 23 then '收件人/地址不清晰或不正确'
        when 24 then '收件地址已废弃或不存在'
        when 25 then '收件人电话号码错误'
        when 26 then 'cod金额不正确'
        when 27 then '无实际包裹'
        when 28 then '已妥投未交接'
        when 29 then '收件人电话号码是空号'
        when 30 then '快件分错网点-地址正确'
        when 31 then '快件分错网点-地址错误'
        when 32 then '禁运品'
        when 33 then '严重破损（丢弃）'
        when 34 then '退件两次尝试派送失败'
        when 35 then '不能打开locker'
        when 36 then 'locker不能使用'
        when 37 then '该地址找不到lockerstation'
        when 38 then '一票多件'
        when 39 then '多次尝试派件失败'
        when 40 then '客户不在家/电话无人接听'
        when 41 then '错过班车时间'
        when 42 then '目的地是偏远地区,留仓待次日派送'
        when 43 then '目的地是岛屿,留仓待次日派送'
        when 44 then '企业/机构当天已下班'
        when 45 then '子母件包裹未全部到达网点'
        when 46 then '不可抗力原因留仓(台风)'
        when 47 then '虚假包裹'
        when 48 then '转交FH包裹留仓'
        when 50 then '客户取消寄件'
        when 51 then '信息录入错误'
        when 52 then '客户取消寄件'
        when 53 then 'lazada仓库拒收'
        when 69 then '禁运品'
        when 70 then '客户改约时间'
        when 71 then '当日运力不足，无法派送'
        when 72 then '客户周末或假期不收货'
        when 73 then '收件人/地址不清晰或不正确'
        when 74 then '收件地址已废弃或不存在'
        when 75 then '收件人电话号码错误'
        when 76 then 'cod金额不正确'
        when 77 then '企业/机构当天已下班'
        when 78 then '收件人电话号码是空号'
        when 79 then '快件分错网点-地址错误'
        when 80 then '客户取消任务'
        when 81 then '重复下单'
        when 82 then '已完成揽件'
        when 83 then '联系不上客户'
        when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
        when 85 then '寄件人电话号码是空号'
        when 86 then '包裹不符合揽收条件超大件'
        when 87 then '包裹不符合揽收条件违禁品'
        when 88 then '寄件人地址为岛屿'
        when 89 then '运力短缺，跟客户协商推迟揽收'
        when 90 then '包裹未准备好推迟揽收'
        when 91 then '包裹包装不符合运输标准'
        when 92 then '客户提供的清单里没有此包裹'
        when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
        when 94 then '客户取消寄件/客户实际不想寄此包裹'
        when 95 then '车辆/人力短缺推迟揽收'
        when 96 then '遗漏揽收(已停用)'
        when 97 then '子母件(一个单号多个包裹)'
        when 98 then '地址错误addresserror'
        when 99 then '包裹不符合揽收条件：超大件'
        when 100 then '包裹不符合揽收条件：违禁品'
        when 101 then '包裹包装不符合运输标准'
        when 102 then '包裹未准备好'
        when 103 then '运力短缺，跟客户协商推迟揽收'
        when 104 then '子母件(一个单号多个包裹)'
        when 105 then '破损包裹'
        when 106 then '空包裹'
        when 107 then '不能打开locker(密码错误)'
        when 108 then 'locker不能使用'
        when 109 then 'locker找不到'
        when 110 then '运单号与实际包裹的单号不一致'
        when 111 then 'box客户取消任务'
        when 112 then '不能打开locker(密码错误)'
        when 113 then 'locker不能使用'
        when 114 then 'locker找不到'
        when 115 then '实际重量尺寸大于客户下单的重量尺寸'
        when 116 then '客户仓库关闭'
        when 117 then '客户仓库关闭'
        when 118 then 'SHOPEE订单系统自动关闭'
        when 119 then '客户取消包裹'
        when 121 then '地址错误'
        when 122 then '当日运力不足，无法揽收'
    end as 疑难原因
#     ,case
#         when t1.state = 6 and di.pno is not null then 'KAM/揽件网点未协商'
#         when t1.state = 6 and di.pno is null  then '闪速系统沟通处理中'
#         when t1.state != 6 and plt.pno is not null and plt2.pno is not null then '闪速系统沟通处理中'
#         when plt.pno is null and pct.pno is not null then '闪速超时效理赔未完成'
#         when de.last_store_id = t1.ticket_pickup_store_id and plt2.pno is null then '揽件未发出'
#         when t1.dst_store_id = 'PH19040F05' and plt2.pno is null then '弃件未到拍卖仓'
#         when t1.state != 6 and datediff(now(), convert_tz(pr.routed_at, '+00:00', '+08:00')) > 7 and plt2.pno is not null then 'QAQC无须追责后长期无有效路由'
#         else null
#     end 卡点原因
#     ,de.last_store_name 当前节点
    ,datediff(now(), convert_tz(pr.routed_at, '+00:00', '+08:00')) 最后有效路由距今天数
#     ,de.last_cn_route_action 最新一条有效路由
    ,case pr.route_action # 路由动作
         when 'ACCEPT_PARCEL' then '接件扫描'
         when 'ARRIVAL_GOODS_VAN_CHECK_SCAN' then '车货关联到港'
         when 'ARRIVAL_WAREHOUSE_SCAN' then '到件入仓扫描'
         when 'CANCEL_ARRIVAL_WAREHOUSE_SCAN' then '取消到件入仓扫描'
         when 'CANCEL_PARCEL' then '撤销包裹'
         when 'CANCEL_SHIPMENT_WAREHOUSE' then '取消发件出仓'
         when 'CHANGE_PARCEL_CANCEL' then '修改包裹为撤销'
         when 'CHANGE_PARCEL_CLOSE' then '修改包裹为异常关闭'
         when 'CHANGE_PARCEL_IN_TRANSIT' then '修改包裹为运输中'
         when 'CHANGE_PARCEL_INFO' then '修改包裹信息'
         when 'CHANGE_PARCEL_SIGNED' then '修改包裹为签收'
         when 'CLAIMS_CLOSE' then '理赔关闭'
         when 'CLAIMS_COMPLETE' then '理赔完成'
         when 'CLAIMS_CONTACT' then '已联系客户'
         when 'CLAIMS_TRANSFER_CS' then '转交总部cs处理'
         when 'CLOSE_ORDER' then '关闭订单'
         when 'CONTINUE_TRANSPORT' then '疑难件继续配送'
         when 'CREATE_WORK_ORDER' then '创建工单'
         when 'CUSTOMER_CHANGE_PARCEL_INFO' then '客户修改包裹信息'
         when 'CUSTOMER_OPERATING_RETURN' then '客户操作退回寄件人'
         when 'DELIVERY_CONFIRM' then '确认妥投'
         when 'DELIVERY_MARKER' then '派件标记'
         when 'DELIVERY_PICKUP_STORE_SCAN' then '自提取件扫描'
         when 'DELIVERY_TICKET_CREATION_SCAN' then '交接扫描'
         when 'DELIVERY_TRANSFER' then '派件转单'
         when 'DEPARTURE_GOODS_VAN_CK_SCAN' then '车货关联出港'
         when 'DETAIN_WAREHOUSE' then '货件留仓'
         when 'DIFFICULTY_FINISH_INDEMNITY' then '疑难件支付赔偿'
         when 'DIFFICULTY_HANDOVER' then '疑难件交接'
         when 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE' then '疑难件交接货件留仓'
         when 'DIFFICULTY_RE_TRANSIT' then '疑难件退回区域总部/重启运送'
         when 'DIFFICULTY_RETURN' then '疑难件退回寄件人'
         when 'DIFFICULTY_SEAL' then '集包异常'
         when 'DISCARD_RETURN_BKK' then '丢弃包裹的，换单后寄回BKK'
         when 'DISTRIBUTION_INVENTORY' then '分拨盘库'
         when 'DWS_WEIGHT_IMAGE' then 'DWS复秤照片'
         when 'EXCHANGE_PARCEL' then '换货'
         when 'FAKE_CANCEL_HANDLE' then '虚假撤销判责'
         when 'FLASH_HOME_SCAN' then 'FH交接扫描'
         when 'FORCE_TAKE_PHOTO' then '强制拍照路由'
         when 'HAVE_HAIR_SCAN_NO_TO' then '有发无到'
         when 'HURRY_PARCEL' then '催单'
         when 'INCOMING_CALL' then '来电接听'
         when 'INTERRUPT_PARCEL_AND_RETURN' then '中断运输并退回'
         when 'INVENTORY' then '盘库'
         when 'LOSE_PARCEL_TEAM_OPERATION' then '丢失件团队处理'
         when 'MANUAL_REMARK' then '添加备注'
         when 'MISS_PICKUP_HANDLE' then '漏包裹揽收判责'
         when 'MISSING_PARCEL_SCAN' then '丢失件包裹操作'
         when 'NOTICE_LOST_PARTS_TEAM' then '已通知丢失件团队'
         when 'PARCEL_HEADLESS_CLAIMED' then '无头件包裹已认领'
         when 'PARCEL_HEADLESS_PRINTED' then '无头件包裹已打单'
         when 'PENDING_RETURN' then '待退件'
         when 'PHONE' then '电话联系'
         when 'PICK_UP_STORE' then '待自提取件'
         when 'PICKUP_RETURN_RECEIPT' then '签回单揽收'
         when 'PRINTING' then '打印面单'
         when 'QAQC_OPERATION' then 'QAQC判责'
         when 'RECEIVE_WAREHOUSE_SCAN' then '收件入仓'
         when 'RECEIVED' then '已揽收,初始化动作，实际情况并没有作用'
         when 'REFUND_CONFIRM' then '退件妥投'
         when 'REPAIRED' then '上报问题修复路由'
         when 'REPLACE_PNO' then '换单'
         when 'REPLY_WORK_ORDER' then '回复工单'
         when 'REVISION_TIME' then '改约时间'
         when 'SEAL' then '集包'
         when 'SEAL_NUMBER_CHANGE' then '集包件数变化'
         when 'SHIPMENT_WAREHOUSE_SCAN' then '发件出仓扫描'
         when 'SORTER_WEIGHT_IMAGE' then '分拣机复秤照片'
         when 'SORTING_SCAN' then '分拣扫描'
         when 'STAFF_INFO_UPDATE_WEIGHT' then '快递员修改重量'
         when 'STORE_KEEPER_UPDATE_WEIGHT' then '仓管员复秤'
         when 'STORE_SORTER_UPDATE_WEIGHT' then '分拣机复秤'
         when 'SYSTEM_AUTO_RETURN' then '系统自动退件'
         when 'TAKE_PHOTO' then '异常打单拍照'
         when 'THIRD_EXPRESS_ROUTE' then '第三方公司路由'
         when 'THIRD_PARTY_REASON_DETAIN' then '第三方原因滞留'
         when 'TICKET_WEIGHT_IMAGE' then '揽收称重照片'
         when 'TRANSFER_LOST_PARTS_TEAM' then '已转交丢失件团队'
         when 'TRANSFER_QAQC' then '转交QAQC处理'
         when 'UNSEAL' then '拆包'
         when 'UNSEAL_NO_PARCEL' then '上报包裹不在集包里'
         when 'UNSEAL_NOT_SCANNED' then '集包已拆包，本包裹未被扫描'
         when 'VEHICLE_ACCIDENT_REG' then '车辆车祸登记'
         when 'VEHICLE_ACCIDENT_REGISTRATION' then '车辆车祸登记'
         when 'VEHICLE_WET_DAMAGE_REG' then '车辆湿损登记'
         when 'VEHICLE_WET_DAMAGE_REGISTRATION' then '车辆湿损登记'
        end as 最后一条路由
    ,pr.store_name 最后有效路由动作网点
    ,convert_tz(pr.routed_at ,'+00:00', '+08:00') 最新一条有效路由时间
    ,datediff(now(), de.dst_routed_at) 目的地网点停留时间
    ,de.dst_store 目的地网点
    ,de.src_store 揽收网点
    ,de.pickup_time 揽收时间
    ,de.pick_date 揽收日期
    ,if(hold.pno is not null, 'yes', 'no' ) 是否有holding标记
    ,if(pr3.pno is not null, 'yes', 'no') 是否有待退件标记
    ,td.try_num 尝试派送次数
from t t1
left join ph_staging.ka_profile kp on t1.client_id = kp.id
left join dwm.dwd_dim_bigClient bc on bc.client_id = t1.client_id
left join dwm.dwd_ex_ph_parcel_details de on de.pno = t1.pno
left join
    (
        select
            plt.pno
            ,group_concat(ss.name ) should_do
        from ph_bi.parcel_lose_task plt
        join t t1 on t1.pno = plt.pno
        left join ph_bi.work_order wo on wo.loseparcel_task_id = plt.id
        left join ph_staging.sys_store ss on ss.id = wo.store_id
        where
            plt.state in (3)
            and wo.status in (1,2)
        group by 1

        union  all

        select
            plt.pno
            ,'QAQC' should_do
        from ph_bi.parcel_lose_task plt
        join t t1 on t1.pno = plt.pno
        where
            plt.state in (1,2,4)
    ) plt on plt.pno = t1.pno
left join
    (
        select
            t2.pno
            ,cdt.negotiation_result_category
            ,di.diff_marker_category
            ,case
                when di.diff_marker_category in (20,21)  and cdt.vip_enable = 1 then 'KAM'
                when di.diff_marker_category not in (20,21) and cdt.vip_enable = 1 then 'KAM'
                when di.diff_marker_category not in (20,21) and cdt.vip_enable = 0 then ss2.name
                WHEN di.diff_marker_category in (20,21) and cdt.vip_enable = 0 then ss2.name
            end sh_do
        from ph_staging.diff_info di
        join t t2 on t2.pno = di.pno
        join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
        left join ph_bi.parcel_lose_task plt on plt.source_id = cdt.id
        left join ph_staging.sys_store ss2 on ss2.id = t2.ticket_pickup_store_id
        where
            cdt.negotiation_result_category is null
    ) di on di.pno = t1.pno
left join  
    (
        select
            pr.pno
            ,pr.store_name
            ,pr.routed_at
            ,pr.route_action
            ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
        from  ph_staging.parcel_route pr
        join t t3 on t3.pno = pr.pno
        where
            pr.route_action in ('INVENTORY','RECEIVED' ,'RECEIVE_WAREHOUSE_SCAN', 'SORTING_SCAN', 'DELIVERY_TICKET_CREATION_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SHIPMENT_WAREHOUSE_SCAN', 'DETAIN_WAREHOUSE', 'DELIVERY_CONFIRM', 'DIFFICULTY_HANDOVER', 'DELIVERY_MARKER', 'REPLACE_PNO','SEAL', 'UNSEAL', 'STAFF_INFO_UPDATE_WEIGHT', 'STORE_KEEPER_UPDATE_WEIGHT', 'STORE_SORTER_UPDATE_WEIGHT', 'DISCARD_RETURN_BKK', 'DELIVERY_TRANSFER', 'PICKUP_RETURN_RECEIPT', 'FLASH_HOME_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SORTING_SCAN ', 'DELIVERY_PICKUP_STORE_SCAN', 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE', 'REFUND_CONFIRM', 'ACCEPT_PARCEL')
            and pr.organization_type = 1
        ) pr on pr.pno = t1.pno and pr.rk = 1
left join
    (
        select
            plt.pno
        from ph_bi.parcel_lose_task plt
        join t t1 on t1.pno = plt.pno
        where
            plt.state = 5
            and plt.operator_id not in (10000,10001,10002)
        group by 1
    ) plt2 on plt2.pno = t1.pno
left join
    (
        select
            plt.pno
        from ph_bi.parcel_claim_task plt
        join t t4  on t4.pno = plt.pno
        where
            plt.state not in (6,7,8)
            and plt.source = 11
        group by 1
    ) pct on pct.pno = t1.pno
left join
    (
        select
            pr2.pno
        from ph_staging.parcel_route pr2
        join t t1 on t1.pno = pr2.pno
        where
            pr2.route_action = 'REFUND_CONFIRM'
        group by 1
    ) hold on hold.pno = t1.pno
left join
    (
        select
            pr2.pno
        from  ph_staging.parcel_route pr2
        join t t1 on t1.pno = pr2.pno
        where
            pr2.route_action = 'PENDING_RETURN'
        group by 1
    ) pr3 on pr3.pno = t1.pno
left join
    (
        select
            td.pno
            ,count(distinct date(convert_tz(tdm.created_at, '+00:00', '+08:00'))) try_num
        from ph_staging.ticket_delivery td
        join t t1 on t1.pno = td.pno
        left join ph_staging.ticket_delivery_marker tdm on tdm.delivery_id = td.id
        group by 1
    ) td on td.pno = t1.pno
group by t1.pno;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.CT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < curdate()
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,dp.opening_at 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级快递员
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end store_level
    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.sys_store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_info hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.sys_store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.is_sub_staff= 0
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.store_id
        ,pr.pno
        ,hsi.sys_store_id hr_store_id
        ,hsi.formal
        ,hsi.is_sub_staff
        ,pr.staff_info_id
        ,pi.state
    from ph_bi.dc_should_delivery_today ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pr.staff_info_id
    where
        ds.stat_date = '2023-07-25'
        and pr.routed_at >= date_sub('2023-07-25', interval 8 hour )
        and pr.routed_at < date_add('2023-07-25', interval 16 hour)
#         and ds.store_id = 'PH62010300'
)
select
    dr.store_id 网点ID
    ,dr.store_name 网点
    ,dr.opening_at 开业时间
    ,case dr.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dr.piece_name 片区
    ,dr.region_name 大区
    ,emp_cnt.staf_num 总快递员人数
    ,a3.self_staff_num 自有快递员出勤数
    ,a3.staf_num - a3.self_staff_num '外协+支援快递员出勤数'
#     ,a3.staf_num 总出勤快递员人数
    ,a3.avg_scan_num 平均交接量
    ,a3.avg_del_num 平均妥投量
    ,sdb.code_num 网点三段码数量
    ,a2.avg_staff_code 三段码平均交接量
    ,a2.avg_staff_del_code 三段码平均妥投量
    ,a2.avg_code_staff 三段码平均交接快递员数
    ,case
        when a2.avg_code_staff < 2 then 'A'
        when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
        when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
        when a2.avg_code_staff >= 4 then 'D'
    end 评级
    ,a2.code_num
    ,a2.staff_code_num
    ,a2.staff_num
    ,a2.fin_staff_code_num
from
    (
        select
            a1.store_id
            ,count(distinct a1.staff_code) staff_code_num
            ,count(distinct a1.third_sorting_code) code_num
            ,count(distinct a1.staff_info_id) staff_num
            ,count(distinct if(a1.state = 5, a1.staff_code, null)) fin_staff_code_num
            ,count(distinct a1.staff_code)/ count(distinct a1.third_sorting_code) avg_code_staff
            ,count(distinct a1.staff_code)/count(distinct a1.staff_info_id)  avg_staff_code
            ,count(distinct if(a1.state = 5, a1.staff_code, null))/count(distinct a1.staff_info_id) avg_staff_del_code
        from
            (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,t1.state
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct t1.staff_info_id) staf_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1 and t1.is_sub_staff = 0, t1.staff_info_id, null))  self_staff_num

            ,count(distinct t1.pno)/count(distinct t1.staff_info_id) avg_scan_num
            ,count(distinct if(t1.state = 5, t1.pno, null))/count(distinct t1.staff_info_id) avg_del_num
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
select
    pr.pno
    ,pr.staff_info_id 员工
    ,convert_tz(pr.routed_at, '+00:00', '+08:00') 路由时间
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
from ph_staging.parcel_route pr
left join ph_staging.parcel_info pi on pi.pno = pr.pno
where
    pr.staff_info_id in ('153803','155404','127781','155612','126187','151043','158384','152336','127291','133935','155505','155761','155647','155157','154089','132205','132216','156805','151271','134520','158015','128194','127339','144839','144838','144401','150816','128325','128830','130996','133028','137587','119603','156467','156000','151376')
    and pr.route_action in ('DELIVERY_TICKET_CREATION_SCAN');
;-- -. . -..- - / . -. - .-. -.--
select
    pr.pno
    ,pr.staff_info_id 员工
    ,convert_tz(pr.routed_at, '+00:00', '+08:00') 路由时间
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
from ph_staging.parcel_route pr
left join ph_staging.parcel_info pi on pi.pno = pr.pno
where
    pr.staff_info_id in ('153803','155404','127781','155612','126187','151043','158384','152336','127291','133935','155505','155761','155647','155157','154089','132205','132216','156805','151271','134520','158015','128194','127339','144839','144838','144401','150816','128325','128830','130996','133028','137587','119603','156467','156000','151376')
    and pr.route_action in ('DELIVERY_TICKET_CREATION_SCAN')
    and pr.routed_at > '2023-07-14 16:00:00'
    and pr.routed_at < '2023-07-28 16:00:00';
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
    ,convert_tz(pi.created_at, '+00:00', '+08:00') 揽收时间
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
from ph_staging.parcel_info pi
where
    pi.client_id in ('CA1728')
    and pi.created_at >= '2023-02-28 16:00:00';
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.store_id
        ,pr.pno
        ,hsi.sys_store_id hr_store_id
        ,hsi.formal
        ,hsi.is_sub_staff
        ,pr.staff_info_id
        ,pi.state
    from ph_bi.dc_should_delivery_today ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pr.staff_info_id
    where
        ds.stat_date = '2023-07-25'
        and pr.routed_at >= date_sub('2023-07-25', interval 8 hour )
        and pr.routed_at < date_add('2023-07-25', interval 16 hour)
#         and ds.store_id = 'PH62010300'
)
select
    dr.store_id 网点ID
    ,dr.store_name 网点
    ,dr.opening_at 开业时间
    ,case dr.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dr.piece_name 片区
    ,dr.region_name 大区
    ,emp_cnt.staf_num 总快递员人数
    ,a3.self_staff_num 自有快递员出勤数
    ,a3.staf_num - a3.self_staff_num '外协+支援快递员出勤数'
#     ,a3.staf_num 总出勤快递员人数
    ,a3.avg_scan_num 平均交接量
    ,a3.avg_del_num 平均妥投量
    ,sdb.code_num 网点三段码数量
    ,a2.self_avg_staff_code 自有快递员三段码平均交接量
    ,a2.other_avg_staff_code 其他快递员三段码平均交接量
    ,a2.self_avg_staff_del_code 自有快递员三段码平均妥投量
    ,a2.other_avg_staff_del_code 其他快递员三段码平均妥投量
    ,a2.avg_code_staff 三段码平均交接快递员数
    ,case
        when a2.avg_code_staff < 2 then 'A'
        when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
        when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
        when a2.avg_code_staff >= 4 then 'D'
    end 评级
    ,a2.code_num
    ,a2.staff_code_num
    ,a2.staff_num
    ,a2.fin_staff_code_num
from
    (
        select
            a1.store_id
            ,count(distinct a1.staff_code) staff_code_num
            ,count(distinct a1.third_sorting_code) code_num
            ,count(distinct a1.staff_info_id) staff_num
            ,count(distinct if(a1.state = 5, a1.staff_code, null)) fin_staff_code_num
            ,count(distinct a1.staff_code)/ count(distinct a1.third_sorting_code) avg_code_staff
            ,count(distinct if(a1.is_self = 'y', a1.staff_code, null))/count(distinct if(a1.is_self = 'y', a1.staff_info_id, null)) self_avg_staff_code
            ,count(distinct if(a1.is_self = 'n', a1.staff_code, null))/count(distinct if(a1.is_self = 'n', a1.staff_info_id, null)) other_avg_staff_code
            ,count(distinct if(a1.state = 5 and a1.is_self = 'y', a1.staff_code, null))/count(distinct if(a1.is_self = 'y', a1.staff_info_id, null)) self_avg_staff_del_code
            ,count(distinct if(a1.state = 5 and a1.is_self = 'n', a1.staff_code, null))/count(distinct if(a1.is_self = 'n', a1.staff_info_id, null)) other_avg_staff_del_code
        from
            (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct t1.staff_info_id) staf_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1 and t1.is_sub_staff = 0, t1.staff_info_id, null))  self_staff_num

            ,count(distinct t1.pno)/count(distinct t1.staff_info_id) avg_scan_num
            ,count(distinct if(t1.state = 5, t1.pno, null))/count(distinct t1.staff_info_id) avg_del_num
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
select
    coalesce(a2.client_name, '总计') 客户
    ,case a2.type
        when 1 then '揽件任务异常取消'
        when 2 then '虚假妥投'
        when 3 then' 收件人拒收'
        when 4 then '标记客户改约时间'
        when 5 then 'KA现场不揽收'
        when 6 then '包裹未准备好'
        when 7 then '上报错分未妥投'
        when 8 then '多次尝试派送失败'
    end 回访类型
    ,a2.`昨日20-今日20单量`
    ,a2.`昨日20-今日20处理完成单量`
    ,a2.`昨日20-今日20处理及时完成单量`
from
    (
        select
            a.client_name
            ,a.type
            ,count(a.id) '昨日20-今日20单量'
            ,count(if(a.visit_state in (3,4), a.id, null)) '昨日20-今日20处理完成单量'
            ,count(if(a.beyond_time = 'y', a.id, null)) '昨日20-今日20处理及时完成单量'
        from
            (
                select
                    vrv.link_id
                    ,bc.client_name
                    ,vrv.id
                    ,vrv.type
                    ,vrv.visit_state
                    ,vrv.created_at
                    ,vrv.updated_at
                    ,vrv.visit_num
                    ,case
                        when vrv.visit_state in (4) and vrv.visit_num = 1  and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 120 then 'y'
                        when vrv.visit_state in (4) and vrv.visit_num = 1  and timestampdiff(minute , vrv.created_at, vrv.updated_at) >= 120 then 'n'
                        when vrv.visit_state in (4) and vrv.visit_num > 1 and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 240 then 'y'
                        when vrv.visit_state in (4) and vrv.visit_num > 1 and timestampdiff(minute , vrv.created_at, vrv.updated_at) >= 240 then 'n'

                        when vrv.visit_state in (3) and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 240 then 'y'
                        when vrv.visit_state in (3) and timestampdiff(minute , vrv.created_at, vrv.updated_at) > 240 then 'n'
                    end beyond_time
                from nl_production.violation_return_visit vrv
                join dwm.dwd_dim_bigClient bc on vrv.client_id = bc.client_id
                where
                    vrv.created_at >= date_sub('2023-07-31', interval 4 hour)
                    and vrv.created_at < date_add('2023-07-31', interval 20 hour)
                    and vrv.type in  (3,8)
            ) a
        group by 1,2
        with rollup
    ) a2
order by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    coalesce(a2.client_name, '总计') 客户
    ,coalesce(a2.vrv_type, '总计') 回访类型
    ,a2.`昨日20-今日20单量`
    ,a2.`昨日20-今日20处理完成单量`
    ,a2.`昨日20-今日20处理及时完成单量`
from
    (
        select
            a.client_name
            ,case a.type
                when 1 then '揽件任务异常取消'
                when 2 then '虚假妥投'
                when 3 then' 收件人拒收'
                when 4 then '标记客户改约时间'
                when 5 then 'KA现场不揽收'
                when 6 then '包裹未准备好'
                when 7 then '上报错分未妥投'
                when 8 then '多次尝试派送失败'
            end vrv_type
            ,count(a.id) '昨日20-今日20单量'
            ,count(if(a.visit_state in (3,4), a.id, null)) '昨日20-今日20处理完成单量'
            ,count(if(a.beyond_time = 'y', a.id, null)) '昨日20-今日20处理及时完成单量'
        from
            (
                select
                    vrv.link_id
                    ,bc.client_name
                    ,vrv.id
                    ,vrv.type
                    ,vrv.visit_state
                    ,vrv.created_at
                    ,vrv.updated_at
                    ,vrv.visit_num
                    ,case
                        when vrv.visit_state in (4) and vrv.visit_num = 1  and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 120 then 'y'
                        when vrv.visit_state in (4) and vrv.visit_num = 1  and timestampdiff(minute , vrv.created_at, vrv.updated_at) >= 120 then 'n'
                        when vrv.visit_state in (4) and vrv.visit_num > 1 and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 240 then 'y'
                        when vrv.visit_state in (4) and vrv.visit_num > 1 and timestampdiff(minute , vrv.created_at, vrv.updated_at) >= 240 then 'n'

                        when vrv.visit_state in (3) and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 240 then 'y'
                        when vrv.visit_state in (3) and timestampdiff(minute , vrv.created_at, vrv.updated_at) > 240 then 'n'
                    end beyond_time
                from nl_production.violation_return_visit vrv
                join dwm.dwd_dim_bigClient bc on vrv.client_id = bc.client_id
                where
                    vrv.created_at >= date_sub('2023-07-31', interval 4 hour)
                    and vrv.created_at < date_add('2023-07-31', interval 20 hour)
                    and vrv.type in  (3,8)
            ) a
        group by 1,2
        with rollup
    ) a2
order by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    coalesce(a2.client_name, '总计') 客户
    ,coalesce(a2.vrv_type, '总计') 回访类型
    ,a2.`昨日20-今日20单量`
    ,a2.`昨日20-今日20处理完成单量`
    ,a2.`昨日20-今日20处理及时完成单量`
from
    (
        select
            a.client_name
            ,case a.type
                when 1 then '揽件任务异常取消'
                when 2 then '虚假妥投'
                when 3 then' 收件人拒收'
                when 4 then '标记客户改约时间'
                when 5 then 'KA现场不揽收'
                when 6 then '包裹未准备好'
                when 7 then '上报错分未妥投'
                when 8 then '多次尝试派送失败'
            end vrv_type
            ,count(a.id) '昨日20-今日20单量'
            ,count(if(a.visit_state in (3,4), a.id, null)) '昨日20-今日20处理完成单量'
            ,count(if(a.beyond_time = 'y', a.id, null)) '昨日20-今日20处理及时完成单量'
        from
            (
                select
                    vrv.link_id
                    ,bc.client_name
                    ,vrv.id
                    ,vrv.type
                    ,vrv.visit_state
                    ,vrv.created_at
                    ,vrv.updated_at
                    ,vrv.visit_num
                    ,case
                        when vrv.visit_state in (4) and vrv.visit_num = 1  and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 120 then 'y'
                        when vrv.visit_state in (4) and vrv.visit_num = 1  and timestampdiff(minute , vrv.created_at, vrv.updated_at) >= 120 then 'n'
                        when vrv.visit_state in (4) and vrv.visit_num > 1 and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 240 then 'y'
                        when vrv.visit_state in (4) and vrv.visit_num > 1 and timestampdiff(minute , vrv.created_at, vrv.updated_at) >= 240 then 'n'

                        when vrv.visit_state in (3) and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 240 then 'y'
                        when vrv.visit_state in (3) and timestampdiff(minute , vrv.created_at, vrv.updated_at) > 240 then 'n'
                    end beyond_time
                from nl_production.violation_return_visit vrv
                join dwm.dwd_dim_bigClient bc on vrv.client_id = bc.client_id
                where
                    vrv.created_at >= date_sub('2023-07-31', interval 4 hour)
                    and vrv.created_at < date_add('2023-07-31', interval 20 hour)
                    and vrv.type in  (3,8)
            ) a
        group by 1,2
        with rollup
    ) a2
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
select
    coalesce(a2.client_name, '总计') 客户
    ,coalesce(a2.vrv_type, '总计') 回访类型
    ,a2.`昨日20-今日20单量`
    ,a2.`昨日20-今日20处理完成单量`
    ,a2.`昨日20-今日20处理及时完成单量`
from
    (
        select
            a.client_name
            ,case a.type
                when 1 then '揽件任务异常取消'
                when 2 then '虚假妥投'
                when 3 then' 收件人拒收'
                when 4 then '标记客户改约时间'
                when 5 then 'KA现场不揽收'
                when 6 then '包裹未准备好'
                when 7 then '上报错分未妥投'
                when 8 then '多次尝试派送失败'
            end vrv_type
            ,count(a.id) '昨日20-今日20单量'
            ,count(if(a.visit_state in (3,4), a.id, null)) '昨日20-今日20处理完成单量'
            ,count(if(a.beyond_time = 'y', a.id, null)) '昨日20-今日20处理及时完成单量'
        from
            (
                select
                    vrv.link_id
                    ,bc.client_name
                    ,vrv.id
                    ,vrv.type
                    ,vrv.visit_state
                    ,vrv.created_at
                    ,vrv.updated_at
                    ,vrv.visit_num
                    ,case
                        when vrv.visit_state in (4) and vrv.visit_num = 1  and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 120 then 'y'
                        when vrv.visit_state in (4) and vrv.visit_num = 1  and timestampdiff(minute , vrv.created_at, vrv.updated_at) >= 120 then 'n'
                        when vrv.visit_state in (4) and vrv.visit_num > 1 and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 240 then 'y'
                        when vrv.visit_state in (4) and vrv.visit_num > 1 and timestampdiff(minute , vrv.created_at, vrv.updated_at) >= 240 then 'n'

                        when vrv.visit_state in (3) and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 240 then 'y'
                        when vrv.visit_state in (3) and timestampdiff(minute , vrv.created_at, vrv.updated_at) > 240 then 'n'
                    end beyond_time
                from nl_production.violation_return_visit vrv
                join dwm.dwd_dim_bigClient bc on vrv.client_id = bc.client_id
                where
                    vrv.created_at >= date_sub('2023-07-31', interval 4 hour)
                    and vrv.created_at < date_add('2023-07-31', interval 20 hour)
                    and vrv.type in  (3,8)
            ) a
        group by 1,2
        with rollup
    ) a2;
;-- -. . -..- - / . -. - .-. -.--
select
    coalesce(a2.vrv_type, '总计') 回访类型
    ,coalesce(a2.client_name, '总计') 客户
    ,a2.`昨日20-今日20单量`
    ,a2.`昨日20-今日20处理完成单量`
    ,a2.`昨日20-今日20处理及时完成单量`
from
    (
        select
            a.client_name
            ,case a.type
                when 1 then '揽件任务异常取消'
                when 2 then '虚假妥投'
                when 3 then' 收件人拒收'
                when 4 then '标记客户改约时间'
                when 5 then 'KA现场不揽收'
                when 6 then '包裹未准备好'
                when 7 then '上报错分未妥投'
                when 8 then '多次尝试派送失败'
            end vrv_type
            ,count(a.id) '昨日20-今日20单量'
            ,count(if(a.visit_state in (3,4), a.id, null)) '昨日20-今日20处理完成单量'
            ,count(if(a.beyond_time = 'y', a.id, null)) '昨日20-今日20处理及时完成单量'
        from
            (
                select
                    vrv.link_id
                    ,bc.client_name
                    ,vrv.id
                    ,vrv.type
                    ,vrv.visit_state
                    ,vrv.created_at
                    ,vrv.updated_at
                    ,vrv.visit_num
                    ,case
                        when vrv.visit_state in (4) and vrv.visit_num = 1  and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 120 then 'y'
                        when vrv.visit_state in (4) and vrv.visit_num = 1  and timestampdiff(minute , vrv.created_at, vrv.updated_at) >= 120 then 'n'
                        when vrv.visit_state in (4) and vrv.visit_num > 1 and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 240 then 'y'
                        when vrv.visit_state in (4) and vrv.visit_num > 1 and timestampdiff(minute , vrv.created_at, vrv.updated_at) >= 240 then 'n'

                        when vrv.visit_state in (3) and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 240 then 'y'
                        when vrv.visit_state in (3) and timestampdiff(minute , vrv.created_at, vrv.updated_at) > 240 then 'n'
                    end beyond_time
                from nl_production.violation_return_visit vrv
                join dwm.dwd_dim_bigClient bc on vrv.client_id = bc.client_id
                where
                    vrv.created_at >= date_sub('2023-07-31', interval 4 hour)
                    and vrv.created_at < date_add('2023-07-31', interval 20 hour)
                    and vrv.type in  (3,8)
            ) a
        group by 1,2
        with rollup
    ) a2;
;-- -. . -..- - / . -. - .-. -.--
with a as
(
    select
        coalesce(a.client_name, '总计') client_name
        ,coalesce(a.疑难件原因, '总计') 疑难件原因
        ,a.`0-2小时`
        ,a.`2-4小时`
        ,a.`4-6小时`
        ,a.`6小时以上`
        ,a.总疑难件量
        ,a.继续配送
        ,a.退货
        ,a.平均处理时长_h
    from
        (
            select
                bc.client_name
                ,case di.diff_marker_category # 疑难原因
                    when 1 then '客户不在家/电话无人接听'
                    when 2 then '收件人拒收'
                    when 3 then '快件分错网点'
                    when 4 then '外包装破损'
                    when 5 then '货物破损'
                    when 6 then '货物短少'
                    when 7 then '货物丢失'
                    when 8 then '电话联系不上'
                    when 9 then '客户改约时间'
                    when 10 then '客户不在'
                    when 11 then '客户取消任务'
                    when 12 then '无人签收'
                    when 13 then '客户周末或假期不收货'
                    when 14 then '客户改约时间'
                    when 15 then '当日运力不足，无法派送'
                    when 16 then '联系不上收件人'
                    when 17 then '收件人拒收'
                    when 18 then '快件分错网点'
                    when 19 then '外包装破损'
                    when 20 then '货物破损'
                    when 21 then '货物短少'
                    when 22 then '货物丢失'
                    when 23 then '详细地址错误'
                    when 24 then '收件地址已废弃或不存在'
                    when 25 then '收件人电话号码错误'
                    when 26 then 'cod金额不正确'
                    when 27 then '无实际包裹'
                    when 28 then '已妥投未交接'
                    when 29 then '收件人电话号码是空号'
                    when 30 then '送错网点'
                    when 31 then '省市乡邮编错误'
                    when 32 then '禁运品'
                    when 33 then '严重破损（丢弃）'
                    when 34 then '退件两次尝试派送失败'
                    when 35 then '不能打开locker'
                    when 36 then 'locker不能使用'
                    when 37 then '该地址找不到lockerstation'
                    when 38 then '一票多件'
                    when 39 then '多次尝试派件失败'
                    when 40 then '客户不在家/电话无人接听'
                    when 41 then '错过班车时间'
                    when 42 then '目的地是偏远地区,留仓待次日派送'
                    when 43 then '目的地是岛屿,留仓待次日派送'
                    when 44 then '企业/机构当天已下班'
                    when 45 then '子母件包裹未全部到达网点'
                    when 46 then '不可抗力原因留仓(台风)'
                    when 47 then '虚假包裹'
                    when 50 then '客户取消寄件'
                    when 51 then '信息录入错误'
                    when 52 then '客户取消寄件'
                    when 53 then 'lazada仓库拒收'
                    when 69 then '禁运品'
                    when 70 then '客户改约时间'
                    when 71 then '当日运力不足，无法派送'
                    when 72 then '客户周末或假期不收货'
                    when 73 then '详细地址错误'
                    when 74 then '收件地址已废弃或不存在'
                    when 75 then '收件人电话号码错误'
                    when 76 then 'cod金额不正确'
                    when 77 then '企业/机构当天已下班'
                    when 78 then '收件人电话号码是空号'
                    when 79 then '快件分错网点-地址错误'
                    when 80 then '客户取消任务'
                    when 81 then '重复下单'
                    when 82 then '已完成揽件'
                    when 83 then '联系不上客户'
                    when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 85 then '寄件人电话号码是空号'
                    when 86 then '包裹不符合揽收条件超大件'
                    when 87 then '包裹不符合揽收条件违禁品'
                    when 88 then '寄件人地址为岛屿'
                    when 89 then '运力短缺，跟客户协商推迟揽收'
                    when 90 then '包裹未准备好推迟揽收'
                    when 91 then '包裹包装不符合运输标准'
                    when 92 then '客户提供的清单里没有此包裹'
                    when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 94 then '客户取消寄件/客户实际不想寄此包裹'
                    when 95 then '车辆/人力短缺推迟揽收'
                    when 96 then '遗漏揽收(已停用)'
                    when 97 then '子母件(一个单号多个包裹)'
                    when 98 then '地址错误addresserror'
                    when 99 then '包裹不符合揽收条件：超大件'
                    when 100 then '包裹不符合揽收条件：违禁品'
                    when 101 then '包裹包装不符合运输标准'
                    when 102 then '包裹未准备好'
                    when 103 then '运力短缺，跟客户协商推迟揽收'
                    when 104 then '子母件(一个单号多个包裹)'
                    when 105 then '破损包裹'
                    when 106 then '空包裹'
                    when 107 then '不能打开locker(密码错误)'
                    when 108 then 'locker不能使用'
                    when 109 then 'locker找不到'
                    when 110 then '运单号与实际包裹的单号不一致'
                    when 111 then 'box客户取消任务'
                    when 112 then '不能打开locker(密码错误)'
                    when 113 then 'locker不能使用'
                    when 114 then 'locker找不到'
                    when 115 then '实际重量尺寸大于客户下单的重量尺寸'
                    when 116 then '客户仓库关闭'
                    when 117 then '客户仓库关闭'
                    when 118 then 'SHOPEE订单系统自动关闭'
                    when 119 then '客户取消包裹'
                    when 121 then '地址错误'
                    when 122 then '当日运力不足，无法揽收'
                end as 疑难件原因
                ,count(if(cdt.negotiation_result_category = 5, di.id, null)) 继续配送
                ,count(if(cdt.negotiation_result_category = 3, di.id, null)) 退货
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 < 2, di.id, null)) '0-2小时'
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 >= 2 and timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 < 4 , di.id, null)) '2-4小时'
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 >= 4 and timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 < 6, di.id, null )) '4-6小时'
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 >= 6 , di.id, null )) '6小时以上'
                ,sum(if(cdt.operator_id not in (10000,10001,100002), timestampdiff(second , cdt.created_at, cdt.updated_at)/3600, null))/count(if(cdt.operator_id not in (10000,10001,100002), di.id, null)) 平均处理时长_h
                ,count(di.id) 总疑难件量
            from ph_staging.diff_info di
            left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
            left join ph_staging.store_diff_ticket sdt on sdt.diff_info_id = di.id
#             left join dwm.dwd_dim_dict tdt2 on di.diff_marker_category= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category' -- 标记原因
            left join ph_staging.parcel_info pi on pi.pno = di.pno
            join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
            where
                di.updated_at >= date_sub('2023-07-31', interval 8 hour )
                and di.updated_at < date_add('2023-07-31', interval 16 hour ) -- 今日处理
                and cdt.state = 1 -- 已处理
                and if(bc.client_name in ('shopee', 'tiktok'), di.diff_marker_category in (23,73,29,78,25,75,31,79), di.diff_marker_category in (23,73,29,78,25,75,31,79,17))
            group by 1,2
            with rollup
        ) a
    order by 1,2
)
, b as
(
    select
        coalesce(a2.client_name, '总计') client_name
        ,coalesce(a2.疑难件原因, '总计') 疑难件原因
        ,a2.`20-9单量`
        ,a2.`前日20-今日9点处理完成量`
        ,a2.`20-9点11点处理完成量`
        ,a2.`9-20单量`
        ,a2.`9-20已处理单量`
        ,a2.`9-20已处理2小时内量`
    from
        (
           select
                bc.client_name
                ,case di.diff_marker_category
                    when 1 then '客户不在家/电话无人接听'
                    when 2 then '收件人拒收'
                    when 3 then '快件分错网点'
                    when 4 then '外包装破损'
                    when 5 then '货物破损'
                    when 6 then '货物短少'
                    when 7 then '货物丢失'
                    when 8 then '电话联系不上'
                    when 9 then '客户改约时间'
                    when 10 then '客户不在'
                    when 11 then '客户取消任务'
                    when 12 then '无人签收'
                    when 13 then '客户周末或假期不收货'
                    when 14 then '客户改约时间'
                    when 15 then '当日运力不足，无法派送'
                    when 16 then '联系不上收件人'
                    when 17 then '收件人拒收'
                    when 18 then '快件分错网点'
                    when 19 then '外包装破损'
                    when 20 then '货物破损'
                    when 21 then '货物短少'
                    when 22 then '货物丢失'
                    when 23 then '详细地址错误'
                    when 24 then '收件地址已废弃或不存在'
                    when 25 then '收件人电话号码错误'
                    when 26 then 'cod金额不正确'
                    when 27 then '无实际包裹'
                    when 28 then '已妥投未交接'
                    when 29 then '收件人电话号码是空号'
                    when 30 then '送错网点'
                    when 31 then '省市乡邮编错误'
                    when 32 then '禁运品'
                    when 33 then '严重破损（丢弃）'
                    when 34 then '退件两次尝试派送失败'
                    when 35 then '不能打开locker'
                    when 36 then 'locker不能使用'
                    when 37 then '该地址找不到lockerstation'
                    when 38 then '一票多件'
                    when 39 then '多次尝试派件失败'
                    when 40 then '客户不在家/电话无人接听'
                    when 41 then '错过班车时间'
                    when 42 then '目的地是偏远地区,留仓待次日派送'
                    when 43 then '目的地是岛屿,留仓待次日派送'
                    when 44 then '企业/机构当天已下班'
                    when 45 then '子母件包裹未全部到达网点'
                    when 46 then '不可抗力原因留仓(台风)'
                    when 47 then '虚假包裹'
                    when 50 then '客户取消寄件'
                    when 51 then '信息录入错误'
                    when 52 then '客户取消寄件'
                    when 53 then 'lazada仓库拒收'
                    when 69 then '禁运品'
                    when 70 then '客户改约时间'
                    when 71 then '当日运力不足，无法派送'
                    when 72 then '客户周末或假期不收货'
                    when 73 then '详细地址错误'
                    when 74 then '收件地址已废弃或不存在'
                    when 75 then '收件人电话号码错误'
                    when 76 then 'cod金额不正确'
                    when 77 then '企业/机构当天已下班'
                    when 78 then '收件人电话号码是空号'
                    when 79 then '快件分错网点-地址错误'
                    when 80 then '客户取消任务'
                    when 81 then '重复下单'
                    when 82 then '已完成揽件'
                    when 83 then '联系不上客户'
                    when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 85 then '寄件人电话号码是空号'
                    when 86 then '包裹不符合揽收条件超大件'
                    when 87 then '包裹不符合揽收条件违禁品'
                    when 88 then '寄件人地址为岛屿'
                    when 89 then '运力短缺，跟客户协商推迟揽收'
                    when 90 then '包裹未准备好推迟揽收'
                    when 91 then '包裹包装不符合运输标准'
                    when 92 then '客户提供的清单里没有此包裹'
                    when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 94 then '客户取消寄件/客户实际不想寄此包裹'
                    when 95 then '车辆/人力短缺推迟揽收'
                    when 96 then '遗漏揽收(已停用)'
                    when 97 then '子母件(一个单号多个包裹)'
                    when 98 then '地址错误addresserror'
                    when 99 then '包裹不符合揽收条件：超大件'
                    when 100 then '包裹不符合揽收条件：违禁品'
                    when 101 then '包裹包装不符合运输标准'
                    when 102 then '包裹未准备好'
                    when 103 then '运力短缺，跟客户协商推迟揽收'
                    when 104 then '子母件(一个单号多个包裹)'
                    when 105 then '破损包裹'
                    when 106 then '空包裹'
                    when 107 then '不能打开locker(密码错误)'
                    when 108 then 'locker不能使用'
                    when 109 then 'locker找不到'
                    when 110 then '运单号与实际包裹的单号不一致'
                    when 111 then 'box客户取消任务'
                    when 112 then '不能打开locker(密码错误)'
                    when 113 then 'locker不能使用'
                    when 114 then 'locker找不到'
                    when 115 then '实际重量尺寸大于客户下单的重量尺寸'
                    when 116 then '客户仓库关闭'
                    when 117 then '客户仓库关闭'
                    when 118 then 'SHOPEE订单系统自动关闭'
                    when 119 then '客户取消包裹'
                    when 121 then '地址错误'
                    when 122 then '当日运力不足，无法揽收'
                end as 疑难件原因
                ,count(if(di.created_at >= date_sub('2023-07-31', interval 12 hour) and di.created_at < date_add('2023-07-31', interval  1 hour), di.id, null)) '20-9单量'
                ,count(if(di.created_at >= date_sub('2023-07-31', interval 12 hour) and di.created_at < date_add('2023-07-31', interval  1 hour) and cdt.state = 1 , di.id, null)) '前日20-今日9点处理完成量'
                ,count(if(di.created_at >= date_sub('2023-07-31', interval 12 hour) and di.created_at < date_add('2023-07-31', interval  1 hour) and cdt.state = 1 and cdt.updated_at < date_add('2023-07-31', interval  3 hour ) , di.id, null)) '20-9点11点处理完成量'
                ,count(if(di.created_at >= date_add('2023-07-31', interval  1 hour) and di.created_at < date_add('2023-07-31', interval 12 hour), di.id, null)) '9-20单量'
                ,count(if(di.created_at >= date_add('2023-07-31', interval  1 hour) and di.created_at < date_add('2023-07-31', interval 12 hour) and cdt.state = 1 , di.id, null)) '9-20已处理单量'
                ,count(if(di.created_at >= date_add('2023-07-31', interval  1 hour) and di.created_at < date_add('2023-07-31', interval 12 hour) and cdt.state = 1 and cdt.updated_at < date_add(di.created_at, interval  2 hour ), di.id, null)) '9-20已处理2小时内量'
            from ph_staging.diff_info di
            join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
            left join ph_staging.store_diff_ticket sdt2 on sdt2.diff_info_id = di.id
#             left join dwm.dwd_dim_dict tdt2 on di.diff_marker_category= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category' -- 标记原因
            left join ph_staging.parcel_info pi on pi.pno = di.pno
            join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
            left join nl_production.violation_return_visit vrv on vrv.link_id = di.pno and vrv.type = 8 and vrv.visit_state = 1
            where
                if(bc.client_name in ('shopee', 'tiktok'), di.diff_marker_category in (23,73,29,78,25,75,31,79), di.diff_marker_category in (23,73,29,78,25,75,31,79,17))
                and di.created_at >= date_sub('2023-07-31', interval 12 hour)
                and di.created_at < date_add('2023-07-31', interval 12 hour )
                and vrv.link_id is null
            group by 1,2
            with rollup
        ) a2
)
select
    t1.client_name
    ,t1.疑难件原因
    ,a1.`0-2小时`
    ,a1.`2-4小时`
    ,a1.`4-6小时`
    ,a1.`6小时以上`
    ,a1.继续配送
    ,a1.退货
    ,a1.平均处理时长_h
    ,a1.总疑难件量
    ,b1.`20-9单量`
    ,b1.`前日20-今日9点处理完成量`
    ,b1.`20-9点11点处理完成量`
    ,b1.`9-20单量`
    ,b1.`9-20已处理单量`
    ,b1.`9-20已处理2小时内量`
from
    (
        select
            t1.疑难件原因
            ,t1.client_name
        from
            (
                select
                    a.client_name
                    ,a.疑难件原因
                from a

                union

                select
                    b.client_name
                    ,b.疑难件原因
                from b
            ) t1
        group by 1,2
    ) t1
left join a a1 on t1.client_name = a1.client_name and t1.疑难件原因 = a1.疑难件原因
left join b b1 on t1.client_name = b1.client_name and t1.疑难件原因 = b1.疑难件原因
order by t1.client_name,case t1.疑难件原因
                            when '总计' then 1
                            when '详细地址错误' then 2
                            when '收件人电话号码是空号' then 3
                            when '收件人电话号码错误' then 4
                            when '省市乡邮编错误' then 5
                            when '收件人拒收' then 6
                        end;
;-- -. . -..- - / . -. - .-. -.--
select
    coalesce(a2.vrv_type, '总计') 回访类型
    ,coalesce(a2.client_name, '总计') 客户
    ,a2.`昨日20-今日20单量`
    ,a2.`昨日20-今日20处理完成单量`
    ,a2.`昨日20-今日20处理及时完成单量`
from
    (
        select
            a.client_name
            ,case a.type
                when 1 then '揽件任务异常取消'
                when 2 then '虚假妥投'
                when 3 then '收件人拒收'
                when 4 then '标记客户改约时间'
                when 5 then 'KA现场不揽收'
                when 6 then '包裹未准备好'
                when 7 then '上报错分未妥投'
                when 8 then '多次尝试派送失败'
            end vrv_type
            ,count(a.id) '昨日20-今日20单量'
            ,count(if(a.visit_state in (3,4), a.id, null)) '昨日20-今日20处理完成单量'
            ,count(if(a.beyond_time = 'y', a.id, null)) '昨日20-今日20处理及时完成单量'
        from
            (
                select
                    vrv.link_id
                    ,bc.client_name
                    ,vrv.id
                    ,vrv.type
                    ,vrv.visit_state
                    ,vrv.created_at
                    ,vrv.updated_at
                    ,vrv.visit_num
                    ,case
                        when vrv.visit_state in (4) and vrv.visit_num = 1  and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 120 then 'y'
                        when vrv.visit_state in (4) and vrv.visit_num = 1  and timestampdiff(minute , vrv.created_at, vrv.updated_at) >= 120 then 'n'
                        when vrv.visit_state in (4) and vrv.visit_num > 1 and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 240 then 'y'
                        when vrv.visit_state in (4) and vrv.visit_num > 1 and timestampdiff(minute , vrv.created_at, vrv.updated_at) >= 240 then 'n'

                        when vrv.visit_state in (3) and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 240 then 'y'
                        when vrv.visit_state in (3) and timestampdiff(minute , vrv.created_at, vrv.updated_at) > 240 then 'n'
                    end beyond_time
                from nl_production.violation_return_visit vrv
                join dwm.dwd_dim_bigClient bc on vrv.client_id = bc.client_id
                where
                    vrv.created_at >= date_sub('2023-07-31', interval 4 hour)
                    and vrv.created_at < date_add('2023-07-31', interval 20 hour)
                    and vrv.type in  (3,8)
            ) a
        group by 1,2
        with rollup
    ) a2;
;-- -. . -..- - / . -. - .-. -.--
select
    coalesce(a2.vrv_type, '总计') 回访类型
    ,coalesce(a2.client_name, '总计') 客户
    ,a2.`昨日20-今日20单量`
    ,a2.`昨日20-今日20处理完成单量`
    ,a2.`昨日20-今日20处理及时完成单量`
from
    (
        select
            case a.type
                when 1 then '揽件任务异常取消'
                when 2 then '虚假妥投'
                when 3 then '收件人拒收'
                when 4 then '标记客户改约时间'
                when 5 then 'KA现场不揽收'
                when 6 then '包裹未准备好'
                when 7 then '上报错分未妥投'
                when 8 then '多次尝试派送失败'
            end vrv_type
            ,a.client_name
            ,count(a.id) '昨日20-今日20单量'
            ,count(if(a.visit_state in (3,4), a.id, null)) '昨日20-今日20处理完成单量'
            ,count(if(a.beyond_time = 'y', a.id, null)) '昨日20-今日20处理及时完成单量'
        from
            (
                select
                    vrv.link_id
                    ,bc.client_name
                    ,vrv.id
                    ,vrv.type
                    ,vrv.visit_state
                    ,vrv.created_at
                    ,vrv.updated_at
                    ,vrv.visit_num
                    ,case
                        when vrv.visit_state in (4) and vrv.visit_num = 1  and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 120 then 'y'
                        when vrv.visit_state in (4) and vrv.visit_num = 1  and timestampdiff(minute , vrv.created_at, vrv.updated_at) >= 120 then 'n'
                        when vrv.visit_state in (4) and vrv.visit_num > 1 and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 240 then 'y'
                        when vrv.visit_state in (4) and vrv.visit_num > 1 and timestampdiff(minute , vrv.created_at, vrv.updated_at) >= 240 then 'n'

                        when vrv.visit_state in (3) and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 240 then 'y'
                        when vrv.visit_state in (3) and timestampdiff(minute , vrv.created_at, vrv.updated_at) > 240 then 'n'
                    end beyond_time
                from nl_production.violation_return_visit vrv
                join dwm.dwd_dim_bigClient bc on vrv.client_id = bc.client_id
                where
                    vrv.created_at >= date_sub('2023-07-31', interval 4 hour)
                    and vrv.created_at < date_add('2023-07-31', interval 20 hour)
                    and vrv.type in  (3,8)
            ) a
        group by 1,2
        with rollup
    ) a2;
;-- -. . -..- - / . -. - .-. -.--
select
    coalesce(a2.vrv_type, '总计') 回访类型
    ,coalesce(a2.client_name, '总计') 客户
    ,a2.`昨日20-今日20单量`
    ,a2.`昨日20-今日20处理完成单量`
    ,a2.`昨日20-今日20处理及时完成单量`
from
    (
        select
            case a.type
                when 1 then '揽件任务异常取消'
                when 2 then '虚假妥投'
                when 3 then '收件人拒收'
                when 4 then '标记客户改约时间'
                when 5 then 'KA现场不揽收'
                when 6 then '包裹未准备好'
                when 7 then '上报错分未妥投'
                when 8 then '多次尝试派送失败'
            end vrv_type
            ,a.client_name
            ,count(a.id) '昨日20-今日20单量'
            ,count(if(a.visit_state in (3,4), a.id, null)) '昨日20-今日20处理完成单量'
            ,count(if(a.beyond_time = 'y', a.id, null)) '昨日20-今日20处理及时完成单量'
        from
            (
                select
                    vrv.link_id
                    ,bc.client_name
                    ,vrv.id
                    ,vrv.type
                    ,vrv.visit_state
                    ,vrv.created_at
                    ,vrv.updated_at
                    ,vrv.visit_num
                    ,case
                        when vrv.visit_state in (4) and vrv.visit_num = 1  and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 120 then 'y'
                        when vrv.visit_state in (4) and vrv.visit_num = 1  and timestampdiff(minute , vrv.created_at, vrv.updated_at) >= 120 then 'n'
                        when vrv.visit_state in (4) and vrv.visit_num > 1 and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 240 then 'y'
                        when vrv.visit_state in (4) and vrv.visit_num > 1 and timestampdiff(minute , vrv.created_at, vrv.updated_at) >= 240 then 'n'

                        when vrv.visit_state in (3) and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 240 then 'y'
                        when vrv.visit_state in (3) and timestampdiff(minute , vrv.created_at, vrv.updated_at) > 240 then 'n'
                    end beyond_time
                from nl_production.violation_return_visit vrv
                join dwm.dwd_dim_bigClient bc on vrv.client_id = bc.client_id
                where
                    vrv.created_at >= date_sub('2023-07-31', interval 4 hour)
                    and vrv.created_at < date_add('2023-07-31', interval 20 hour)
                    and vrv.type in  (3,8)
            ) a
        group by 1,2
        with rollup
    ) a2
order by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    coalesce(a2.vrv_type, '总计') 回访类型
    ,coalesce(a2.client_name, '总计') 客户
    ,a2.`昨日20-今日20单量`
    ,a2.`昨日20-今日20处理完成单量`
    ,a2.`昨日20-今日20处理及时完成单量`
from
    (
        select
            case a.type
                when 1 then '揽件任务异常取消'
                when 2 then '虚假妥投'
                when 3 then '收件人拒收'
                when 4 then '标记客户改约时间'
                when 5 then 'KA现场不揽收'
                when 6 then '包裹未准备好'
                when 7 then '上报错分未妥投'
                when 8 then '多次尝试派送失败'
            end vrv_type
            ,a.client_name
            ,count(a.id) '昨日20-今日20单量'
            ,count(if(a.visit_state in (3,4), a.id, null)) '昨日20-今日20处理完成单量'
            ,count(if(a.beyond_time = 'y', a.id, null)) '昨日20-今日20处理及时完成单量'
        from
            (
                select
                    vrv.link_id
                    ,bc.client_name
                    ,vrv.id
                    ,vrv.type
                    ,vrv.visit_state
                    ,vrv.created_at
                    ,vrv.updated_at
                    ,vrv.visit_num
                    ,case
                        when vrv.visit_state in (4) and vrv.visit_num = 1  and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 120 then 'y'
                        when vrv.visit_state in (4) and vrv.visit_num = 1  and timestampdiff(minute , vrv.created_at, vrv.updated_at) >= 120 then 'n'
                        when vrv.visit_state in (4) and vrv.visit_num > 1 and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 240 then 'y'
                        when vrv.visit_state in (4) and vrv.visit_num > 1 and timestampdiff(minute , vrv.created_at, vrv.updated_at) >= 240 then 'n'

                        when vrv.visit_state in (3) and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 240 then 'y'
                        when vrv.visit_state in (3) and timestampdiff(minute , vrv.created_at, vrv.updated_at) > 240 then 'n'
                    end beyond_time
                from nl_production.violation_return_visit vrv
                join dwm.dwd_dim_bigClient bc on vrv.client_id = bc.client_id
                where
                    vrv.created_at >= date_sub('2023-07-31', interval 4 hour)
                    and vrv.created_at < date_add('2023-07-31', interval 20 hour)
                    and vrv.type in  (3,8)
            ) a
        group by 1,2
        with rollup
    ) a2
order by case
            when '收件人拒收' then 1
            when '多次尝试派送失败' then 2
            when '总计' then 3
        end,
        case
            when 'lazada' then 1
            when 'tiktok' then 2
            when '总计' then 3
        end;
;-- -. . -..- - / . -. - .-. -.--
select
    coalesce(a2.vrv_type, '总计') 回访类型
    ,coalesce(a2.client_name, '总计') 客户
    ,a2.`昨日20-今日20单量`
    ,a2.`昨日20-今日20处理完成单量`
    ,a2.`昨日20-今日20处理及时完成单量`
from
    (
        select
            case a.type
                when 1 then '揽件任务异常取消'
                when 2 then '虚假妥投'
                when 3 then '收件人拒收'
                when 4 then '标记客户改约时间'
                when 5 then 'KA现场不揽收'
                when 6 then '包裹未准备好'
                when 7 then '上报错分未妥投'
                when 8 then '多次尝试派送失败'
            end vrv_type
            ,a.client_name
            ,count(a.id) '昨日20-今日20单量'
            ,count(if(a.visit_state in (3,4), a.id, null)) '昨日20-今日20处理完成单量'
            ,count(if(a.beyond_time = 'y', a.id, null)) '昨日20-今日20处理及时完成单量'
        from
            (
                select
                    vrv.link_id
                    ,bc.client_name
                    ,vrv.id
                    ,vrv.type
                    ,vrv.visit_state
                    ,vrv.created_at
                    ,vrv.updated_at
                    ,vrv.visit_num
                    ,case
                        when vrv.visit_state in (4) and vrv.visit_num = 1  and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 120 then 'y'
                        when vrv.visit_state in (4) and vrv.visit_num = 1  and timestampdiff(minute , vrv.created_at, vrv.updated_at) >= 120 then 'n'
                        when vrv.visit_state in (4) and vrv.visit_num > 1 and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 240 then 'y'
                        when vrv.visit_state in (4) and vrv.visit_num > 1 and timestampdiff(minute , vrv.created_at, vrv.updated_at) >= 240 then 'n'

                        when vrv.visit_state in (3) and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 240 then 'y'
                        when vrv.visit_state in (3) and timestampdiff(minute , vrv.created_at, vrv.updated_at) > 240 then 'n'
                    end beyond_time
                from nl_production.violation_return_visit vrv
                join dwm.dwd_dim_bigClient bc on vrv.client_id = bc.client_id
                where
                    vrv.created_at >= date_sub('2023-07-31', interval 4 hour)
                    and vrv.created_at < date_add('2023-07-31', interval 20 hour)
                    and vrv.type in  (3,8)
            ) a
        group by 1,2
        with rollup
    ) a2
order by case  a2.vrv_type
            when '收件人拒收' then 1
            when '多次尝试派送失败' then 2
            when '总计' then 3
        end,
        case  a2.client_name
            when 'lazada' then 1
            when 'tiktok' then 2
            when '总计' then 3
        end;
;-- -. . -..- - / . -. - .-. -.--
select
    coalesce(a2.vrv_type, '总计') 回访类型
    ,coalesce(a2.client_name, '总计') 客户
    ,a2.`昨日20-今日20单量`
    ,a2.`昨日20-今日20处理完成单量`
    ,a2.`昨日20-今日20处理及时完成单量`
from
    (
        select
            case a.type
                when 1 then '揽件任务异常取消'
                when 2 then '虚假妥投'
                when 3 then '收件人拒收'
                when 4 then '标记客户改约时间'
                when 5 then 'KA现场不揽收'
                when 6 then '包裹未准备好'
                when 7 then '上报错分未妥投'
                when 8 then '多次尝试派送失败'
            end vrv_type
            ,a.client_name
            ,count(a.id) '昨日20-今日20单量'
            ,count(if(a.visit_state in (3,4), a.id, null)) '昨日20-今日20处理完成单量'
            ,count(if(a.beyond_time = 'y', a.id, null)) '昨日20-今日20处理及时完成单量'
        from
            (
                select
                    vrv.link_id
                    ,bc.client_name
                    ,vrv.id
                    ,vrv.type
                    ,vrv.visit_state
                    ,vrv.created_at
                    ,vrv.updated_at
                    ,vrv.visit_num
                    ,case
                        when vrv.visit_state in (4) and vrv.visit_num = 1  and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 120 then 'y'
                        when vrv.visit_state in (4) and vrv.visit_num = 1  and timestampdiff(minute , vrv.created_at, vrv.updated_at) >= 120 then 'n'
                        when vrv.visit_state in (4) and vrv.visit_num > 1 and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 240 then 'y'
                        when vrv.visit_state in (4) and vrv.visit_num > 1 and timestampdiff(minute , vrv.created_at, vrv.updated_at) >= 240 then 'n'

                        when vrv.visit_state in (3) and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 240 then 'y'
                        when vrv.visit_state in (3) and timestampdiff(minute , vrv.created_at, vrv.updated_at) > 240 then 'n'
                    end beyond_time
                from nl_production.violation_return_visit vrv
                join dwm.dwd_dim_bigClient bc on vrv.client_id = bc.client_id
                where
                    vrv.created_at >= date_sub('2023-07-31', interval 4 hour)
                    and vrv.created_at < date_add('2023-07-31', interval 20 hour)
                    and vrv.type in  (3,8)
            ) a
        group by 1,2
        with rollup
    ) a2
order by case  a2.vrv_type
            when '收件人拒收' then 1
            when '多次尝试派送失败' then 2
            when '总计' then 3
        end desc ,
        case  a2.client_name
            when 'lazada' then 1
            when 'tiktok' then 2
            when '总计' then 3
        end desc;
;-- -. . -..- - / . -. - .-. -.--
select
    coalesce(a2.vrv_type, '总计') 回访类型
    ,coalesce(a2.client_name, '总计') 客户
    ,a2.`昨日20-今日20单量`
    ,a2.`昨日20-今日20处理完成单量`
    ,a2.`昨日20-今日20处理及时完成单量`
from
    (
        select
            case a.type
                when 1 then '揽件任务异常取消'
                when 2 then '虚假妥投'
                when 3 then '收件人拒收'
                when 4 then '标记客户改约时间'
                when 5 then 'KA现场不揽收'
                when 6 then '包裹未准备好'
                when 7 then '上报错分未妥投'
                when 8 then '多次尝试派送失败'
            end vrv_type
            ,a.client_name
            ,count(a.id) '昨日20-今日20单量'
            ,count(if(a.visit_state in (3,4), a.id, null)) '昨日20-今日20处理完成单量'
            ,count(if(a.beyond_time = 'y', a.id, null)) '昨日20-今日20处理及时完成单量'
        from
            (
                select
                    vrv.link_id
                    ,bc.client_name
                    ,vrv.id
                    ,vrv.type
                    ,vrv.visit_state
                    ,vrv.created_at
                    ,vrv.updated_at
                    ,vrv.visit_num
                    ,case
                        when vrv.visit_state in (4) and vrv.visit_num = 1  and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 120 then 'y'
                        when vrv.visit_state in (4) and vrv.visit_num = 1  and timestampdiff(minute , vrv.created_at, vrv.updated_at) >= 120 then 'n'
                        when vrv.visit_state in (4) and vrv.visit_num > 1 and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 240 then 'y'
                        when vrv.visit_state in (4) and vrv.visit_num > 1 and timestampdiff(minute , vrv.created_at, vrv.updated_at) >= 240 then 'n'

                        when vrv.visit_state in (3) and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 240 then 'y'
                        when vrv.visit_state in (3) and timestampdiff(minute , vrv.created_at, vrv.updated_at) > 240 then 'n'
                    end beyond_time
                from nl_production.violation_return_visit vrv
                join dwm.dwd_dim_bigClient bc on vrv.client_id = bc.client_id
                where
                    vrv.created_at >= date_sub('2023-07-31', interval 4 hour)
                    and vrv.created_at < date_add('2023-07-31', interval 20 hour)
                    and vrv.type in  (3,8)
            ) a
        group by 1,2
        with rollup
    ) a2
order by case  a2.vrv_type
            when '收件人拒收' then 1
            when '多次尝试派送失败' then 2
            when '总计' then 3
        end desc ,
        case  a2.client_name
            when 'lazada' then 1
            when 'tiktok' then 2
            when 'shopee' then 3
            when '总计' then 4
        end desc;
;-- -. . -..- - / . -. - .-. -.--
with p as
(
    select
        pi.pno
        ,convert_tz(pi.created_at, '+00:00', '+08:00') created_time
        ,pi.ticket_pickup_store_id
        ,pi.dst_store_id
        ,pi.client_id
        ,pi.returned
    from ph_staging.parcel_info pi
    where
        pi.created_at <= date_sub('2023-07-08', interval 8 hour)
        and pi.state = 6
)
select
    p1.pno 单号
    ,if(p1.returned = 0, '正向', '逆向') 方向
    ,ss.name 揽收网点名称
    ,ss2.name 目的地网点名称
    ,p1.client_id 客户ID
    ,case
        when bc.`client_id` is not null then bc.client_name
        when kp.id is not null and bc.id is null then '普通ka'
        when kp.`id` is null then 'GE'
    end as 客户类型
    ,case di.diff_marker_category # 疑难原因
        when 1 then '客户不在家/电话无人接听'
        when 2 then '收件人拒收'
        when 3 then '快件分错网点'
        when 4 then '外包装破损'
        when 5 then '货物破损'
        when 6 then '货物短少'
        when 7 then '货物丢失'
        when 8 then '电话联系不上'
        when 9 then '客户改约时间'
        when 10 then '客户不在'
        when 11 then '客户取消任务'
        when 12 then '无人签收'
        when 13 then '客户周末或假期不收货'
        when 14 then '客户改约时间'
        when 15 then '当日运力不足，无法派送'
        when 16 then '联系不上收件人'
        when 17 then '收件人拒收'
        when 18 then '快件分错网点'
        when 19 then '外包装破损'
        when 20 then '货物破损'
        when 21 then '货物短少'
        when 22 then '货物丢失'
        when 23 then '详细地址错误'
        when 24 then '收件地址已废弃或不存在'
        when 25 then '收件人电话号码错误'
        when 26 then 'cod金额不正确'
        when 27 then '无实际包裹'
        when 28 then '已妥投未交接'
        when 29 then '收件人电话号码是空号'
        when 30 then '送错网点'
        when 31 then '省市乡邮编错误'
        when 32 then '禁运品'
        when 33 then '严重破损（丢弃）'
        when 34 then '退件两次尝试派送失败'
        when 35 then '不能打开locker'
        when 36 then 'locker不能使用'
        when 37 then '该地址找不到lockerstation'
        when 38 then '一票多件'
        when 39 then '多次尝试派件失败'
        when 40 then '客户不在家/电话无人接听'
        when 41 then '错过班车时间'
        when 42 then '目的地是偏远地区,留仓待次日派送'
        when 43 then '目的地是岛屿,留仓待次日派送'
        when 44 then '企业/机构当天已下班'
        when 45 then '子母件包裹未全部到达网点'
        when 46 then '不可抗力原因留仓(台风)'
        when 47 then '虚假包裹'
        when 50 then '客户取消寄件'
        when 51 then '信息录入错误'
        when 52 then '客户取消寄件'
        when 53 then 'lazada仓库拒收'
        when 69 then '禁运品'
        when 70 then '客户改约时间'
        when 71 then '当日运力不足，无法派送'
        when 72 then '客户周末或假期不收货'
        when 73 then '详细地址错误'
        when 74 then '收件地址已废弃或不存在'
        when 75 then '收件人电话号码错误'
        when 76 then 'cod金额不正确'
        when 77 then '企业/机构当天已下班'
        when 78 then '收件人电话号码是空号'
        when 79 then '快件分错网点-地址错误'
        when 80 then '客户取消任务'
        when 81 then '重复下单'
        when 82 then '已完成揽件'
        when 83 then '联系不上客户'
        when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
        when 85 then '寄件人电话号码是空号'
        when 86 then '包裹不符合揽收条件超大件'
        when 87 then '包裹不符合揽收条件违禁品'
        when 88 then '寄件人地址为岛屿'
        when 89 then '运力短缺，跟客户协商推迟揽收'
        when 90 then '包裹未准备好推迟揽收'
        when 91 then '包裹包装不符合运输标准'
        when 92 then '客户提供的清单里没有此包裹'
        when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
        when 94 then '客户取消寄件/客户实际不想寄此包裹'
        when 95 then '车辆/人力短缺推迟揽收'
        when 96 then '遗漏揽收(已停用)'
        when 97 then '子母件(一个单号多个包裹)'
        when 98 then '地址错误addresserror'
        when 99 then '包裹不符合揽收条件：超大件'
        when 100 then '包裹不符合揽收条件：违禁品'
        when 101 then '包裹包装不符合运输标准'
        when 102 then '包裹未准备好'
        when 103 then '运力短缺，跟客户协商推迟揽收'
        when 104 then '子母件(一个单号多个包裹)'
        when 105 then '破损包裹'
        when 106 then '空包裹'
        when 107 then '不能打开locker(密码错误)'
        when 108 then 'locker不能使用'
        when 109 then 'locker找不到'
        when 110 then '运单号与实际包裹的单号不一致'
        when 111 then 'box客户取消任务'
        when 112 then '不能打开locker(密码错误)'
        when 113 then 'locker不能使用'
        when 114 then 'locker找不到'
        when 115 then '实际重量尺寸大于客户下单的重量尺寸'
        when 116 then '客户仓库关闭'
        when 117 then '客户仓库关闭'
        when 118 then 'SHOPEE订单系统自动关闭'
        when 119 then '客户取消包裹'
        when 121 then '地址错误'
        when 122 then '当日运力不足，无法揽收'
    end as 疑难件原因
    ,datediff(now(), de.routed_at) 目的地网点停留时长
    ,date(p1.created_time) 揽收日期
from ph_staging.diff_info di
join p p1 on p1.pno = di.pno
join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id and cdt.state != 1
left join
    (
        select
            pr.pno
            ,pr.routed_at
            ,row_number() over (partition by pr.pno order by pr.routed_at ) rk
        from ph_staging.parcel_route pr
        join p p1 on p1.pno = pr.pno and pr.store_id = p1.dst_store_id
        join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.fieldname = 'route_action' and ddd.remark = 'valid'
    ) de on de.pno = p1.pno and de.rk = 1
left join ph_staging.sys_store ss on ss.id = p1.ticket_pickup_store_id
left join ph_staging.sys_store ss2 on ss2.id = p1.dst_store_id
left join ph_staging.ka_profile kp on kp.id = p1.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = p1.client_id;
;-- -. . -..- - / . -. - .-. -.--
with p as
(
    select
        pi.pno
        ,convert_tz(pi.created_at, '+00:00', '+08:00') created_time
        ,pi.ticket_pickup_store_id
        ,pi.dst_store_id
        ,pi.client_id
        ,pi.returned
    from ph_staging.parcel_info pi
    where
        pi.created_at <= date_sub('2023-07-08', interval 8 hour)
        and pi.state = 6
)
select
    p1.pno 单号
    ,if(p1.returned = 0, '正向', '逆向') 方向
    ,ss.name 揽收网点名称
    ,ss2.name 目的地网点名称
    ,p1.client_id 客户ID
    ,case
        when bc.`client_id` is not null then bc.client_name
        when kp.id is not null and bc.client_id is null then '普通ka'
        when kp.`id` is null then 'GE'
    end as 客户类型
    ,case di.diff_marker_category # 疑难原因
        when 1 then '客户不在家/电话无人接听'
        when 2 then '收件人拒收'
        when 3 then '快件分错网点'
        when 4 then '外包装破损'
        when 5 then '货物破损'
        when 6 then '货物短少'
        when 7 then '货物丢失'
        when 8 then '电话联系不上'
        when 9 then '客户改约时间'
        when 10 then '客户不在'
        when 11 then '客户取消任务'
        when 12 then '无人签收'
        when 13 then '客户周末或假期不收货'
        when 14 then '客户改约时间'
        when 15 then '当日运力不足，无法派送'
        when 16 then '联系不上收件人'
        when 17 then '收件人拒收'
        when 18 then '快件分错网点'
        when 19 then '外包装破损'
        when 20 then '货物破损'
        when 21 then '货物短少'
        when 22 then '货物丢失'
        when 23 then '详细地址错误'
        when 24 then '收件地址已废弃或不存在'
        when 25 then '收件人电话号码错误'
        when 26 then 'cod金额不正确'
        when 27 then '无实际包裹'
        when 28 then '已妥投未交接'
        when 29 then '收件人电话号码是空号'
        when 30 then '送错网点'
        when 31 then '省市乡邮编错误'
        when 32 then '禁运品'
        when 33 then '严重破损（丢弃）'
        when 34 then '退件两次尝试派送失败'
        when 35 then '不能打开locker'
        when 36 then 'locker不能使用'
        when 37 then '该地址找不到lockerstation'
        when 38 then '一票多件'
        when 39 then '多次尝试派件失败'
        when 40 then '客户不在家/电话无人接听'
        when 41 then '错过班车时间'
        when 42 then '目的地是偏远地区,留仓待次日派送'
        when 43 then '目的地是岛屿,留仓待次日派送'
        when 44 then '企业/机构当天已下班'
        when 45 then '子母件包裹未全部到达网点'
        when 46 then '不可抗力原因留仓(台风)'
        when 47 then '虚假包裹'
        when 50 then '客户取消寄件'
        when 51 then '信息录入错误'
        when 52 then '客户取消寄件'
        when 53 then 'lazada仓库拒收'
        when 69 then '禁运品'
        when 70 then '客户改约时间'
        when 71 then '当日运力不足，无法派送'
        when 72 then '客户周末或假期不收货'
        when 73 then '详细地址错误'
        when 74 then '收件地址已废弃或不存在'
        when 75 then '收件人电话号码错误'
        when 76 then 'cod金额不正确'
        when 77 then '企业/机构当天已下班'
        when 78 then '收件人电话号码是空号'
        when 79 then '快件分错网点-地址错误'
        when 80 then '客户取消任务'
        when 81 then '重复下单'
        when 82 then '已完成揽件'
        when 83 then '联系不上客户'
        when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
        when 85 then '寄件人电话号码是空号'
        when 86 then '包裹不符合揽收条件超大件'
        when 87 then '包裹不符合揽收条件违禁品'
        when 88 then '寄件人地址为岛屿'
        when 89 then '运力短缺，跟客户协商推迟揽收'
        when 90 then '包裹未准备好推迟揽收'
        when 91 then '包裹包装不符合运输标准'
        when 92 then '客户提供的清单里没有此包裹'
        when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
        when 94 then '客户取消寄件/客户实际不想寄此包裹'
        when 95 then '车辆/人力短缺推迟揽收'
        when 96 then '遗漏揽收(已停用)'
        when 97 then '子母件(一个单号多个包裹)'
        when 98 then '地址错误addresserror'
        when 99 then '包裹不符合揽收条件：超大件'
        when 100 then '包裹不符合揽收条件：违禁品'
        when 101 then '包裹包装不符合运输标准'
        when 102 then '包裹未准备好'
        when 103 then '运力短缺，跟客户协商推迟揽收'
        when 104 then '子母件(一个单号多个包裹)'
        when 105 then '破损包裹'
        when 106 then '空包裹'
        when 107 then '不能打开locker(密码错误)'
        when 108 then 'locker不能使用'
        when 109 then 'locker找不到'
        when 110 then '运单号与实际包裹的单号不一致'
        when 111 then 'box客户取消任务'
        when 112 then '不能打开locker(密码错误)'
        when 113 then 'locker不能使用'
        when 114 then 'locker找不到'
        when 115 then '实际重量尺寸大于客户下单的重量尺寸'
        when 116 then '客户仓库关闭'
        when 117 then '客户仓库关闭'
        when 118 then 'SHOPEE订单系统自动关闭'
        when 119 then '客户取消包裹'
        when 121 then '地址错误'
        when 122 then '当日运力不足，无法揽收'
    end as 疑难件原因
    ,datediff(now(), de.routed_at) 目的地网点停留时长
    ,date(p1.created_time) 揽收日期
from ph_staging.diff_info di
join p p1 on p1.pno = di.pno
join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id and cdt.state != 1
left join
    (
        select
            pr.pno
            ,pr.routed_at
            ,row_number() over (partition by pr.pno order by pr.routed_at ) rk
        from ph_staging.parcel_route pr
        join p p1 on p1.pno = pr.pno and pr.store_id = p1.dst_store_id
        join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.fieldname = 'route_action' and ddd.remark = 'valid'
    ) de on de.pno = p1.pno and de.rk = 1
left join ph_staging.sys_store ss on ss.id = p1.ticket_pickup_store_id
left join ph_staging.sys_store ss2 on ss2.id = p1.dst_store_id
left join ph_staging.ka_profile kp on kp.id = p1.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = p1.client_id;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        pi.pno
        ,pi.ticket_pickup_store_id
        ,pi.dst_store_id
        ,pi.client_id
        ,pi.created_at
        ,pi.returned
    from ph_staging.parcel_info pi
    where
        pi.state not in (5,6,7,8,9)
        and pi.dst_store_id in ('PH19040F04','PH19040F06','PH19040F07','PH19280F10')
        and pi.created_at <= date_sub('2023-07-08', interval 8 hour)
)
select
    t1.pno
    ,if(t1.returned = 0 , '正向', '逆向') 方向
    ,ss.name 揽收网点
    ,ss2.name 目的地网点
    ,t1.client_id
    ,case
        when bc.`client_id` is not null then bc.client_name
        when kp.id is not null and bc.client_id is null then '普通ka'
        when kp.`id` is null then 'GE'
    end as 客户类型
    ,ss3.name 当前网点
    ,datediff(now(), convert_tz(dst.routed_at, '+00:00', '+08:00')) 目的地网点停留时间
    ,date(convert_tz(t1.created_at, '+00:00', '+08:00')) 揽收日期
    ,las.CN_element 最后一条有效路由
    ,convert_tz(las.routed_at, '+00:00', '+08:00') 最后一条有效路由时间
    ,inv.inv_num 盘库次数
from t t1
left join
    (
        select
            pr.pno
            ,pr.routed_at
            ,pr.store_id
            ,ddd.CN_element
            ,row_number() over (partition by pr.pno order by pr.routed_at ) rk
        from ph_staging.parcel_route pr
        join t p1 on p1.pno = pr.pno
        join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.fieldname = 'route_action' and ddd.remark = 'valid'
    ) las on las.pno = t1.pno
left join ph_staging.sys_store ss on ss.id = t1.ticket_pickup_store_id
left join ph_staging.sys_store ss2 on ss2.id = t1.dst_store_id
left join ph_staging.ka_profile kp on kp.id = t1.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = t1.client_id
left join ph_staging.sys_store ss3 on ss3.id = las.store_id
left join
    (
        select
            pr.pno
            ,pr.routed_at
            ,row_number() over (partition by pr.pno order by pr.routed_at ) rk
        from ph_staging.parcel_route pr
        join t p1 on p1.pno = pr.pno and pr.store_id = p1.dst_store_id
        join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.fieldname = 'route_action' and ddd.remark = 'valid'
    ) dst on dst.pno = t1.pno and dst.rk = 1
left join
    (
        select
            pr.pno
            ,count(pr.id) inv_num
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno and pr.store_id = t1.dst_store_id and pr.route_action = 'INVENTORY'
        group by 1
    ) inv on inv.pno = t1.pno;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        pi.pno
        ,pi.ticket_pickup_store_id
        ,pi.dst_store_id
        ,pi.client_id
        ,pi.created_at
        ,pi.returned
    from ph_staging.parcel_info pi
    where
        pi.state not in (5,6,7,8,9)
        and pi.dst_store_id in ('PH19040F04','PH19040F06','PH19040F07','PH19280F10')
        and pi.created_at <= date_sub('2023-07-20', interval 8 hour)
)
select
    t1.pno
    ,if(t1.returned = 0 , '正向', '逆向') 方向
    ,ss.name 揽收网点
    ,ss2.name 目的地网点
    ,t1.client_id
    ,case
        when bc.`client_id` is not null then bc.client_name
        when kp.id is not null and bc.client_id is null then '普通ka'
        when kp.`id` is null then 'GE'
    end as 客户类型
    ,ss3.name 当前网点
    ,datediff(now(), convert_tz(dst.routed_at, '+00:00', '+08:00')) 目的地网点停留时间
    ,date(convert_tz(t1.created_at, '+00:00', '+08:00')) 揽收日期
    ,las.CN_element 最后一条有效路由
    ,convert_tz(las.routed_at, '+00:00', '+08:00') 最后一条有效路由时间
    ,inv.inv_num 盘库次数
from t t1
left join
    (
        select
            pr.pno
            ,pr.routed_at
            ,pr.store_id
            ,ddd.CN_element
            ,row_number() over (partition by pr.pno order by pr.routed_at ) rk
        from ph_staging.parcel_route pr
        join t p1 on p1.pno = pr.pno
        join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.fieldname = 'route_action' and ddd.remark = 'valid'
    ) las on las.pno = t1.pno
left join ph_staging.sys_store ss on ss.id = t1.ticket_pickup_store_id
left join ph_staging.sys_store ss2 on ss2.id = t1.dst_store_id
left join ph_staging.ka_profile kp on kp.id = t1.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = t1.client_id
left join ph_staging.sys_store ss3 on ss3.id = las.store_id
left join
    (
        select
            pr.pno
            ,pr.routed_at
            ,row_number() over (partition by pr.pno order by pr.routed_at ) rk
        from ph_staging.parcel_route pr
        join t p1 on p1.pno = pr.pno and pr.store_id = p1.dst_store_id
        join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.fieldname = 'route_action' and ddd.remark = 'valid'
    ) dst on dst.pno = t1.pno and dst.rk = 1
left join
    (
        select
            pr.pno
            ,count(pr.id) inv_num
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno and pr.store_id = t1.dst_store_id and pr.route_action = 'INVENTORY'
        group by 1
    ) inv on inv.pno = t1.pno;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        pi.pno
        ,pi.ticket_pickup_store_id
        ,pi.dst_store_id
        ,pi.client_id
        ,pi.created_at
        ,pi.returned
    from ph_staging.parcel_info pi
    where
        pi.state not in (5,6,7,8,9)
        and pi.dst_store_id in ('PH19040F05') -- 丢弃仓
        and pi.created_at <= date_sub('2023-07-15', interval 8 hour)
)
select
    t1.pno
    ,if(t1.returned = 0 , '正向', '逆向') 方向
    ,ss.name 揽收网点
    ,ss2.name 目的地网点
    ,t1.client_id
    ,case
        when bc.`client_id` is not null then bc.client_name
        when kp.id is not null and bc.client_id is null then '普通ka'
        when kp.`id` is null then 'GE'
    end as 客户类型
    ,ss3.name 当前网点
    ,date(convert_tz(t1.created_at, '+00:00', '+08:00')) 揽收日期
    ,las.CN_element 最后一条有效路由
    ,convert_tz(las.routed_at, '+00:00', '+08:00') 最后一条有效路由时间
    ,if(clo.pno is null ,'否' ,'是') 是否关闭过
    ,inv.inv_num 盘库次数
from t t1
left join
    (
        select
            pr.pno
            ,pr.routed_at
            ,pr.store_id
            ,ddd.CN_element
            ,row_number() over (partition by pr.pno order by pr.routed_at ) rk
        from ph_staging.parcel_route pr
        join t p1 on p1.pno = pr.pno
        join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.fieldname = 'route_action' and ddd.remark = 'valid'
    ) las on las.pno = t1.pno
left join ph_staging.sys_store ss on ss.id = t1.ticket_pickup_store_id
left join ph_staging.sys_store ss2 on ss2.id = t1.dst_store_id
left join ph_staging.ka_profile kp on kp.id = t1.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = t1.client_id
left join ph_staging.sys_store ss3 on ss3.id = las.store_id
left join
    (
        select
            pr.pno
            ,count(pr.id) inv_num
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno and pr.store_id = t1.dst_store_id and pr.route_action = 'INVENTORY'
        group by 1
    ) inv on inv.pno = t1.pno
left join
    (
        select
            pr.pno
            ,max(pr.routed_at) rou_time
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno
        where
            pr.route_action = 'CHANGE_PARCEL_CLOSE'
        group by 1
    ) clo on clo.pno = t1.pno;
;-- -. . -..- - / . -. - .-. -.--
select
    di.pno

from ph_staging.diff_info di
left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
join ph_staging.parcel_change_detail pcd on pcd.pno = di.pno and pcd.field_name = 'dst_store_id' and pcd.created_at > di.created_at
left join ph_staging.parcel_route pr on pr.pno = di.pno and pr.route_action = 'SHIPMENT_WAREHOUSE_SCAN'
where
    di.diff_marker_category = 31
    and cdt.negotiation_result_category in (5,6)
    and pr.pno is null;
;-- -. . -..- - / . -. - .-. -.--
select
    di.pno
    ,di.store_id
from ph_staging.diff_info di
left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
join ph_staging.parcel_change_detail pcd on pcd.pno = di.pno and pcd.field_name = 'dst_store_id' and pcd.created_at > di.created_at
left join ph_staging.parcel_route pr on pr.pno = di.pno and pr.route_action = 'SHIPMENT_WAREHOUSE_SCAN'
where
    di.diff_marker_category = 31
    and cdt.negotiation_result_category in (5,6)
    and pr.pno is null;
;-- -. . -..- - / . -. - .-. -.--
select
    di.pno
    ,di.store_id
from ph_staging.diff_info di
left join ph_staging.parcel_info pi on di.pno = pi.pno
left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
join ph_staging.parcel_change_detail pcd on pcd.pno = di.pno and pcd.field_name = 'dst_store_id' and pcd.created_at > di.created_at
left join ph_staging.parcel_route pr on pr.pno = di.pno and pr.route_action = 'SHIPMENT_WAREHOUSE_SCAN'
where
    di.diff_marker_category = 31
    and cdt.negotiation_result_category in (5,6)
    and pr.pno is null
    and pi.state not in (5,7,8,9);
;-- -. . -..- - / . -. - .-. -.--
select
    di.pno
    ,di.store_id
from ph_staging.diff_info di
left join ph_staging.parcel_info pi on di.pno = pi.pno
left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
join ph_staging.parcel_change_detail pcd on pcd.pno = di.pno and pcd.field_name = 'dst_store_id' and pcd.created_at > di.created_at
left join ph_staging.parcel_route pr on pr.pno = di.pno and pr.route_action = 'SHIPMENT_WAREHOUSE_SCAN'
where
    di.diff_marker_category = 31
    and cdt.negotiation_result_category in (5,6)
    and pr.pno is null
    and pi.state not in (5,7,8,9)
    and di.store_id = pi.dst_store_id;
;-- -. . -..- - / . -. - .-. -.--
select
    di.pno
    ,di.store_id
from ph_staging.diff_info di
left join ph_staging.parcel_info pi on di.pno = pi.pno
left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
join ph_staging.parcel_change_detail pcd on pcd.pno = di.pno and pcd.field_name = 'dst_store_id' and pcd.created_at > di.created_at
left join ph_staging.parcel_route pr on pr.pno = di.pno and pr.route_action = 'SHIPMENT_WAREHOUSE_SCAN'
left join ph_staging.parcel_route pr2 on pr2.pno = di.pno and pr2.routed_at > cdt.updated_at and pr2.store_id != di.store_id and pr2.route_action in ('RECEIVED','RECEIVE_WAREHOUSE_SCAN','SORTING_SCAN','DELIVERY_TICKET_CREATION_SCAN','ARRIVAL_WAREHOUSE_SCAN','SHIPMENT_WAREHOUSE_SCAN','DETAIN_WAREHOUSE','DELIVERY_CONFIRM','DIFFICULTY_HANDOVER','DELIVERY_MARKER','REPLACE_PNO','SEAL','UNSEAL','PARCEL_HEADLESS_PRINTED','STAFF_INFO_UPDATE_WEIGHT','STORE_KEEPER_UPDATE_WEIGHT','STORE_SORTER_UPDATE_WEIGHT','DISCARD_RETURN_BKK','DELIVERY_TRANSFER','PICKUP_RETURN_RECEIPT','FLASH_HOME_SCAN','ARRIVAL_WAREHOUSE_SCAN','SORTING_SCAN', 'INVENTORY')
where
    di.diff_marker_category = 31
    and cdt.negotiation_result_category in (5,6)
    and pr.pno is null
    and pi.state not in (5,7,8,9)
    and di.created_at >= date_sub(date_sub(curdate(), interval 30 day), interval 8 hour )
    and pr2.pno is null 
group by 1,2;
;-- -. . -..- - / . -. - .-. -.--
    di.pno
    ,di.store_id
from ph_staging.diff_info di
left join ph_staging.parcel_info pi on di.pno = pi.pno
left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
join ph_staging.parcel_change_detail pcd on pcd.pno = di.pno and pcd.field_name = 'dst_store_id' and pcd.created_at > di.created_at
left join ph_staging.parcel_route pr on pr.pno = di.pno and pr.route_action = 'SHIPMENT_WAREHOUSE_SCAN'
left join ph_staging.parcel_route pr2 on pr2.pno = di.pno and pr2.routed_at > cdt.updated_at and pr2.store_id != di.store_id and pr2.route_action in ('RECEIVED','RECEIVE_WAREHOUSE_SCAN','SORTING_SCAN','DELIVERY_TICKET_CREATION_SCAN','ARRIVAL_WAREHOUSE_SCAN','SHIPMENT_WAREHOUSE_SCAN','DETAIN_WAREHOUSE','DELIVERY_CONFIRM','DIFFICULTY_HANDOVER','DELIVERY_MARKER','REPLACE_PNO','SEAL','UNSEAL','PARCEL_HEADLESS_PRINTED','STAFF_INFO_UPDATE_WEIGHT','STORE_KEEPER_UPDATE_WEIGHT','STORE_SORTER_UPDATE_WEIGHT','DISCARD_RETURN_BKK','DELIVERY_TRANSFER','PICKUP_RETURN_RECEIPT','FLASH_HOME_SCAN','ARRIVAL_WAREHOUSE_SCAN','SORTING_SCAN', 'INVENTORY')
where
    di.diff_marker_category = 31
    and cdt.negotiation_result_category in (5,6)
    and pr.pno is null
    and pi.state not in (5,7,8,9)
    and di.created_at >= date_sub(date_sub(curdate(), interval 30 day), interval 8 hour )
    and pr2.pno is null
group by 1,2
;;
;-- -. . -..- - / . -. - .-. -.--
select
    di.pno
    ,di.store_id
from ph_staging.diff_info di
left join ph_staging.parcel_info pi on di.pno = pi.pno
left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
join ph_staging.parcel_change_detail pcd on pcd.pno = di.pno and pcd.field_name = 'dst_store_id' and pcd.created_at > di.created_at
left join ph_staging.parcel_route pr on pr.pno = di.pno and pr.route_action = 'SHIPMENT_WAREHOUSE_SCAN'
left join ph_staging.parcel_route pr2 on pr2.pno = di.pno and pr2.routed_at > cdt.updated_at and pr2.store_id != di.store_id and pr2.route_action in ('RECEIVED','RECEIVE_WAREHOUSE_SCAN','SORTING_SCAN','DELIVERY_TICKET_CREATION_SCAN','ARRIVAL_WAREHOUSE_SCAN','SHIPMENT_WAREHOUSE_SCAN','DETAIN_WAREHOUSE','DELIVERY_CONFIRM','DIFFICULTY_HANDOVER','DELIVERY_MARKER','REPLACE_PNO','SEAL','UNSEAL','PARCEL_HEADLESS_PRINTED','STAFF_INFO_UPDATE_WEIGHT','STORE_KEEPER_UPDATE_WEIGHT','STORE_SORTER_UPDATE_WEIGHT','DISCARD_RETURN_BKK','DELIVERY_TRANSFER','PICKUP_RETURN_RECEIPT','FLASH_HOME_SCAN','ARRIVAL_WAREHOUSE_SCAN','SORTING_SCAN', 'INVENTORY')
where
    di.diff_marker_category = 31
    and cdt.negotiation_result_category in (5,6)
    and pr.pno is null
    and pi.state not in (5,7,8,9)
    and di.created_at >= date_sub(date_sub(curdate(), interval 30 day), interval 8 hour )
    and pr2.pno is null
group by 1,2;
;-- -. . -..- - / . -. - .-. -.--
select
    mw.staff_info_id
    ,mw.staff_name
    ,dp.store_name
    ,dp.piece_name
    ,dp.region_name
    ,case
        when swm.id is not null then '回访虚假导入'
        when ral.warning_id is not null  then 'by举报'
        else '电子警告信'
    end 警告信来源
    ,case swm.type
            when 1 then '派件低效'
            when 3 then '虚假操作'
            when 4 then '虚假打卡'
    end 导入HCM违规类型
    ,json_extract(swm.data_bucket, '$.false_type') 虚假类型
    ,case ra.reason
        when 1 then '迟到早退'
        when 2 then '连续旷工'
        when 3 then '贪污'
        when 4 then '工作时间或工作地点饮酒'
        when 5 then '持有或吸食毒品'
        when 6 then '违反公司的命令/通知/规则/纪律/规定'
        when 7 then '通过社会媒体污蔑公司'
        when 8 then '公司设备私人使用 / 利用公司设备去做其他事情'
        when 9 then '腐败/滥用职权'
        when 10 then '玩忽职守'
        when 11 then '吵架、打架/伤害同事、外部人员、上级或其他'
        when 12 then '未告知上级或无故旷工'
        when 13 then '上级没有同意请假、没有通过系统请假'
        when 14 then '没有通过系统请假'
        when 15 then '未按时上下班'
        when 16 then '不配合公司的吸毒检查'
        when 17 then '伪造证件'
        when 18 then '粗心大意造成公司重大损失（造成钱丢失）'
        when 19 then '未按照网点规定的时间回款'
        when 20 then '谎报里程'
        when 21 then '煽动/挑衅/损害公司利益'
        when 22 then '失职'
        when 23 then '损害公司名誉'
        when 24 then '不接受或不配合公司的调查'
        when 25 then 'Fake Status'
        when 26 then 'Fake POD'
        when 27 then '工作效率未达到公司的标准(KPI)'
        when 28 then '贪污钱'
        when 29 then '贪污包裹'
        when 30 then '偷盗公司财物'
        when 101 then '一月内虚假妥投大于等于4次'
        when 102 then '包裹被网点KIT扫描后遗失（2件及以上）'
        when 103 then '虚假扫描'
        when 104 then '偷盗包裹'
        when 105 then '仓库内吸烟'
        when 106 then '辱骂客户'
        when 107 then '乱扔包裹'
        when 108 then '一个月内两次及以上虚假取消揽收'
        when 109 then '未经客户同意私自擅闯客户家'
        when 110 then '恶意争抢客户'
    end BY举报原因
    ,case mw.type_code
        when 'warning_1' then '迟到早退'
        when 'warning_2' then '连续旷工'
        when 'warning_3' then '贪污'
        when 'warning_4' then '工作时间或工作地点饮酒'
        when 'warning_5' then '持有或吸食毒品'
        when 'warning_6' then '违反公司的命令/通知/规则/纪律/规定'
        when 'warning_7' then '通过社会媒体污蔑公司'
        when 'warning_8' then '公司设备私人使用 / 利用公司设备去做其他事情'
        when 'warning_9' then '腐败/滥用职权'
        when 'warning_10' then '玩忽职守'
        when 'warning_11' then '吵架、打架/伤害同事、外部人员、上级或其他'
        when 'warning_12' then '未告知上级或无故旷工'
        when 'warning_13' then '上级没有同意请假、没有通过系统请假'
        when 'warning_14' then '没有通过系统请假'
        when 'warning_15' then '未按时上下班'
        when 'warning_16' then '不配合公司的吸毒检查'
        when 'warning_17' then '伪造证件'
        when 'warning_18' then '粗心大意造成公司重大损失（造成钱丢失）'
        when 'warning_19' then '未按照网点规定的时间回款'
        when 'warning_20' then '谎报里程'
        when 'warning_21' then '煽动/挑衅/损害公司利益'
        when 'warning_22' then '失职'
        when 'warning_23' then '损害公司名誉'
        when 'warning_24' then '不接受或不配合公司的调查'
        when 'warning_25' then 'Fake  Status'
        when 'warning_26' then 'Fake  POD '
        when 'warning_27' then '工作效率未达到公司的标准(KPI)'
        when 'warning_28' then '贪污钱 '
        when 'warning_29' then '贪污包裹'
        when 'warning_30' then '偷盗公司财物'
        when 'warning_31' then '无故连续旷工1天'
        when 'warning_32' then '无故连续旷工2天'
        when 'warning_33' then '迟到/早退 <= 10 分钟超过1次'
        when 'warning_34' then '性骚扰'
        when 'warning_35' then '提供虚假或未更新的个人信息'
        when 'warning_36' then 'Fake scan face - 违法者'
        when 'warning_37' then 'Fake scan face - 帮手'
        when 'warning_101' then '一月内虚假妥投大于等于4次 '
        when 'warning_102' then '包裹被网点KIT扫描后遗失（2件及以上） '
        when 'warning_103' then '虚假扫描 '
        when 'warning_104' then '偷盗包裹 '
        when 'warning_105' then '仓库内吸烟 '
        when 'warning_106' then '辱骂客户 '
        when 'warning_107' then '乱扔包裹 '
        when 'warning_108' then '一个月内两次及以上虚假取消揽收 '
        when 'warning_109' then '未经客户同意私自擅闯客户家 '
        when 'warning_110' then '恶意争抢客户 '
    end 警告原因
    ,swd.warning_count 警告信次数
from ph_backyard.message_warning mw
left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = mw.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day )
left join ph_backyard.staff_warning_message swm on mw.staff_warning_message_id = swm.id
left join ph_backyard.report_audit_log ral on ral.warning_id = mw.id
left join ph_backyard.report_audit ra on ral.report_id = ra.id
left join ph_backyard.staff_warning_dismiss swd on swd.staff_info_id = mw.staff_info_id
where
    mw.is_delete = 0
    and mw.created_at >= '2023-06-01'
    and mw.created_at < '2023-07-01';
;-- -. . -..- - / . -. - .-. -.--
select
    mw.staff_info_id
    ,mw.staff_name
    ,dp.store_name
    ,dp.piece_name
    ,dp.region_name
    ,case
        when swm.id is not null then '回访虚假导入'
        when ral.warning_id is not null  then 'by举报'
        else '电子警告信'
    end 警告信来源
    ,case swm.type
            when 1 then '派件低效'
            when 3 then '虚假操作'
            when 4 then '虚假打卡'
    end 导入HCM违规类型
    ,json_extract(swm.data_bucket, '$.false_type') 虚假类型
    ,case ra.reason
        when 1 then '迟到早退'
        when 2 then '连续旷工'
        when 3 then '贪污'
        when 4 then '工作时间或工作地点饮酒'
        when 5 then '持有或吸食毒品'
        when 6 then '违反公司的命令/通知/规则/纪律/规定'
        when 7 then '通过社会媒体污蔑公司'
        when 8 then '公司设备私人使用 / 利用公司设备去做其他事情'
        when 9 then '腐败/滥用职权'
        when 10 then '玩忽职守'
        when 11 then '吵架、打架/伤害同事、外部人员、上级或其他'
        when 12 then '未告知上级或无故旷工'
        when 13 then '上级没有同意请假、没有通过系统请假'
        when 14 then '没有通过系统请假'
        when 15 then '未按时上下班'
        when 16 then '不配合公司的吸毒检查'
        when 17 then '伪造证件'
        when 18 then '粗心大意造成公司重大损失（造成钱丢失）'
        when 19 then '未按照网点规定的时间回款'
        when 20 then '谎报里程'
        when 21 then '煽动/挑衅/损害公司利益'
        when 22 then '失职'
        when 23 then '损害公司名誉'
        when 24 then '不接受或不配合公司的调查'
        when 25 then 'Fake Status'
        when 26 then 'Fake POD'
        when 27 then '工作效率未达到公司的标准(KPI)'
        when 28 then '贪污钱'
        when 29 then '贪污包裹'
        when 30 then '偷盗公司财物'
        when 101 then '一月内虚假妥投大于等于4次'
        when 102 then '包裹被网点KIT扫描后遗失（2件及以上）'
        when 103 then '虚假扫描'
        when 104 then '偷盗包裹'
        when 105 then '仓库内吸烟'
        when 106 then '辱骂客户'
        when 107 then '乱扔包裹'
        when 108 then '一个月内两次及以上虚假取消揽收'
        when 109 then '未经客户同意私自擅闯客户家'
        when 110 then '恶意争抢客户'
    end BY举报原因
    ,case mw.type_code
        when 'warning_1' then '迟到早退'
        when 'warning_2' then '连续旷工'
        when 'warning_3' then '贪污'
        when 'warning_4' then '工作时间或工作地点饮酒'
        when 'warning_5' then '持有或吸食毒品'
        when 'warning_6' then '违反公司的命令/通知/规则/纪律/规定'
        when 'warning_7' then '通过社会媒体污蔑公司'
        when 'warning_8' then '公司设备私人使用 / 利用公司设备去做其他事情'
        when 'warning_9' then '腐败/滥用职权'
        when 'warning_10' then '玩忽职守'
        when 'warning_11' then '吵架、打架/伤害同事、外部人员、上级或其他'
        when 'warning_12' then '未告知上级或无故旷工'
        when 'warning_13' then '上级没有同意请假、没有通过系统请假'
        when 'warning_14' then '没有通过系统请假'
        when 'warning_15' then '未按时上下班'
        when 'warning_16' then '不配合公司的吸毒检查'
        when 'warning_17' then '伪造证件'
        when 'warning_18' then '粗心大意造成公司重大损失（造成钱丢失）'
        when 'warning_19' then '未按照网点规定的时间回款'
        when 'warning_20' then '谎报里程'
        when 'warning_21' then '煽动/挑衅/损害公司利益'
        when 'warning_22' then '失职'
        when 'warning_23' then '损害公司名誉'
        when 'warning_24' then '不接受或不配合公司的调查'
        when 'warning_25' then 'Fake  Status'
        when 'warning_26' then 'Fake  POD '
        when 'warning_27' then '工作效率未达到公司的标准(KPI)'
        when 'warning_28' then '贪污钱 '
        when 'warning_29' then '贪污包裹'
        when 'warning_30' then '偷盗公司财物'
        when 'warning_31' then '无故连续旷工1天'
        when 'warning_32' then '无故连续旷工2天'
        when 'warning_33' then '迟到/早退 <= 10 分钟超过1次'
        when 'warning_34' then '性骚扰'
        when 'warning_35' then '提供虚假或未更新的个人信息'
        when 'warning_36' then 'Fake scan face - 违法者'
        when 'warning_37' then 'Fake scan face - 帮手'
        when 'warning_101' then '一月内虚假妥投大于等于4次 '
        when 'warning_102' then '包裹被网点KIT扫描后遗失（2件及以上） '
        when 'warning_103' then '虚假扫描 '
        when 'warning_104' then '偷盗包裹 '
        when 'warning_105' then '仓库内吸烟 '
        when 'warning_106' then '辱骂客户 '
        when 'warning_107' then '乱扔包裹 '
        when 'warning_108' then '一个月内两次及以上虚假取消揽收 '
        when 'warning_109' then '未经客户同意私自擅闯客户家 '
        when 'warning_110' then '恶意争抢客户 '
        else type_code
    end 警告原因
    ,swd.warning_count 警告信次数
from ph_backyard.message_warning mw
left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = mw.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day )
left join ph_backyard.staff_warning_message swm on mw.staff_warning_message_id = swm.id
left join ph_backyard.report_audit_log ral on ral.warning_id = mw.id
left join ph_backyard.report_audit ra on ral.report_id = ra.id
left join ph_backyard.staff_warning_dismiss swd on swd.staff_info_id = mw.staff_info_id
where
    mw.is_delete = 0
    and mw.created_at >= '2023-06-01'
    and mw.created_at < '2023-07-01';
;-- -. . -..- - / . -. - .-. -.--
select
    mw.staff_info_id
    ,mw.staff_name
    ,dp.store_name
    ,dp.piece_name
    ,dp.region_name
    ,case
        when swm.id is not null then '回访虚假导入'
        when ral.warning_id is not null  then 'by举报'
        else '电子警告信'
    end 警告信来源
    ,case swm.type
            when 1 then '派件低效'
            when 3 then '虚假操作'
            when 4 then '虚假打卡'
    end 导入HCM违规类型
    ,json_extract(swm.data_bucket, '$.false_type') 虚假类型
    ,case ra.reason
        when 1 then '迟到早退'
        when 2 then '连续旷工'
        when 3 then '贪污'
        when 4 then '工作时间或工作地点饮酒'
        when 5 then '持有或吸食毒品'
        when 6 then '违反公司的命令/通知/规则/纪律/规定'
        when 7 then '通过社会媒体污蔑公司'
        when 8 then '公司设备私人使用 / 利用公司设备去做其他事情'
        when 9 then '腐败/滥用职权'
        when 10 then '玩忽职守'
        when 11 then '吵架、打架/伤害同事、外部人员、上级或其他'
        when 12 then '未告知上级或无故旷工'
        when 13 then '上级没有同意请假、没有通过系统请假'
        when 14 then '没有通过系统请假'
        when 15 then '未按时上下班'
        when 16 then '不配合公司的吸毒检查'
        when 17 then '伪造证件'
        when 18 then '粗心大意造成公司重大损失（造成钱丢失）'
        when 19 then '未按照网点规定的时间回款'
        when 20 then '谎报里程'
        when 21 then '煽动/挑衅/损害公司利益'
        when 22 then '失职'
        when 23 then '损害公司名誉'
        when 24 then '不接受或不配合公司的调查'
        when 25 then 'Fake Status'
        when 26 then 'Fake POD'
        when 27 then '工作效率未达到公司的标准(KPI)'
        when 28 then '贪污钱'
        when 29 then '贪污包裹'
        when 30 then '偷盗公司财物'
        when 101 then '一月内虚假妥投大于等于4次'
        when 102 then '包裹被网点KIT扫描后遗失（2件及以上）'
        when 103 then '虚假扫描'
        when 104 then '偷盗包裹'
        when 105 then '仓库内吸烟'
        when 106 then '辱骂客户'
        when 107 then '乱扔包裹'
        when 108 then '一个月内两次及以上虚假取消揽收'
        when 109 then '未经客户同意私自擅闯客户家'
        when 110 then '恶意争抢客户'
    end BY举报原因
    ,case mw.type_code
        when 'warning_01' then '迟到早退'
        when 'warning_02' then '连续旷工'
        when 'warning_03' then '贪污'
        when 'warning_04' then '工作时间或工作地点饮酒'
        when 'warning_05' then '持有或吸食毒品'
        when 'warning_06' then '违反公司的命令/通知/规则/纪律/规定'
        when 'warning_07' then '通过社会媒体污蔑公司'
        when 'warning_08' then '公司设备私人使用 / 利用公司设备去做其他事情'
        when 'warning_09' then '腐败/滥用职权'
        when 'warning_10' then '玩忽职守'
        when 'warning_11' then '吵架、打架/伤害同事、外部人员、上级或其他'
        when 'warning_12' then '未告知上级或无故旷工'
        when 'warning_13' then '上级没有同意请假、没有通过系统请假'
        when 'warning_14' then '没有通过系统请假'
        when 'warning_15' then '未按时上下班'
        when 'warning_16' then '不配合公司的吸毒检查'
        when 'warning_17' then '伪造证件'
        when 'warning_18' then '粗心大意造成公司重大损失（造成钱丢失）'
        when 'warning_19' then '未按照网点规定的时间回款'
        when 'warning_20' then '谎报里程'
        when 'warning_21' then '煽动/挑衅/损害公司利益'
        when 'warning_22' then '失职'
        when 'warning_23' then '损害公司名誉'
        when 'warning_24' then '不接受或不配合公司的调查'
        when 'warning_25' then 'Fake  Status'
        when 'warning_26' then 'Fake  POD '
        when 'warning_27' then '工作效率未达到公司的标准(KPI)'
        when 'warning_28' then '贪污钱 '
        when 'warning_29' then '贪污包裹'
        when 'warning_30' then '偷盗公司财物'
        when 'warning_31' then '无故连续旷工1天'
        when 'warning_32' then '无故连续旷工2天'
        when 'warning_33' then '迟到/早退 <= 10 分钟超过1次'
        when 'warning_34' then '性骚扰'
        when 'warning_35' then '提供虚假或未更新的个人信息'
        when 'warning_36' then 'Fake scan face - 违法者'
        when 'warning_37' then 'Fake scan face - 帮手'
        when 'warning_101' then '一月内虚假妥投大于等于4次 '
        when 'warning_102' then '包裹被网点KIT扫描后遗失（2件及以上） '
        when 'warning_103' then '虚假扫描 '
        when 'warning_104' then '偷盗包裹 '
        when 'warning_105' then '仓库内吸烟 '
        when 'warning_106' then '辱骂客户 '
        when 'warning_107' then '乱扔包裹 '
        when 'warning_108' then '一个月内两次及以上虚假取消揽收 '
        when 'warning_109' then '未经客户同意私自擅闯客户家 '
        when 'warning_110' then '恶意争抢客户 '
        else type_code
    end 警告原因
    ,swd.warning_count 警告信次数
from ph_backyard.message_warning mw
left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = mw.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day )
left join ph_backyard.staff_warning_message swm on mw.staff_warning_message_id = swm.id
left join ph_backyard.report_audit_log ral on ral.warning_id = mw.id
left join ph_backyard.report_audit ra on ral.report_id = ra.id
left join ph_backyard.staff_warning_dismiss swd on swd.staff_info_id = mw.staff_info_id
where
    mw.is_delete = 0
    and mw.created_at >= '2023-06-01'
    and mw.created_at < '2023-07-01';
;-- -. . -..- - / . -. - .-. -.--
select
    mw.staff_info_id 员工ID
    ,mw.staff_name 姓名
    ,case
        when hsi.state = 1 and hsi.wait_leave_state = 0 then '在职'
        when hsi.state = 1 and hsi.wait_leave_state = 1 then '待离职'
        when hsi.state = 2 then '离职'
        when hsi.state = 3 then '停职'
    end 在职状态
    ,dp.store_name 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when swm.id is not null then '回访虚假导入'
        when ral.warning_id is not null  then 'by举报'
        else '电子警告信'
    end 警告信来源
    ,case mw.warning_type
        when 1 then '口述警告'
        when 2 then '书面警告'
        when 3 then '末次书面警告'
    end as 警告信类型
    ,case swm.type
            when 1 then '派件低效'
            when 3 then '虚假操作'
            when 4 then '虚假打卡'
    end 导入HCM违规类型
    ,json_extract(swm.data_bucket, '$.false_type') 虚假类型
    ,case ra.reason
        when 1 then '迟到早退'
        when 2 then '连续旷工'
        when 3 then '贪污'
        when 4 then '工作时间或工作地点饮酒'
        when 5 then '持有或吸食毒品'
        when 6 then '违反公司的命令/通知/规则/纪律/规定'
        when 7 then '通过社会媒体污蔑公司'
        when 8 then '公司设备私人使用 / 利用公司设备去做其他事情'
        when 9 then '腐败/滥用职权'
        when 10 then '玩忽职守'
        when 11 then '吵架、打架/伤害同事、外部人员、上级或其他'
        when 12 then '未告知上级或无故旷工'
        when 13 then '上级没有同意请假、没有通过系统请假'
        when 14 then '没有通过系统请假'
        when 15 then '未按时上下班'
        when 16 then '不配合公司的吸毒检查'
        when 17 then '伪造证件'
        when 18 then '粗心大意造成公司重大损失（造成钱丢失）'
        when 19 then '未按照网点规定的时间回款'
        when 20 then '谎报里程'
        when 21 then '煽动/挑衅/损害公司利益'
        when 22 then '失职'
        when 23 then '损害公司名誉'
        when 24 then '不接受或不配合公司的调查'
        when 25 then 'Fake Status'
        when 26 then 'Fake POD'
        when 27 then '工作效率未达到公司的标准(KPI)'
        when 28 then '贪污钱'
        when 29 then '贪污包裹'
        when 30 then '偷盗公司财物'
        when 101 then '一月内虚假妥投大于等于4次'
        when 102 then '包裹被网点KIT扫描后遗失（2件及以上）'
        when 103 then '虚假扫描'
        when 104 then '偷盗包裹'
        when 105 then '仓库内吸烟'
        when 106 then '辱骂客户'
        when 107 then '乱扔包裹'
        when 108 then '一个月内两次及以上虚假取消揽收'
        when 109 then '未经客户同意私自擅闯客户家'
        when 110 then '恶意争抢客户'
    end BY举报原因
    ,case mw.type_code
        when 'warning_01' then '迟到早退'
        when 'warning_02' then '连续旷工'
        when 'warning_03' then '贪污'
        when 'warning_04' then '工作时间或工作地点饮酒'
        when 'warning_05' then '持有或吸食毒品'
        when 'warning_06' then '违反公司的命令/通知/规则/纪律/规定'
        when 'warning_07' then '通过社会媒体污蔑公司'
        when 'warning_08' then '公司设备私人使用 / 利用公司设备去做其他事情'
        when 'warning_09' then '腐败/滥用职权'
        when 'warning_10' then '玩忽职守'
        when 'warning_11' then '吵架、打架/伤害同事、外部人员、上级或其他'
        when 'warning_12' then '未告知上级或无故旷工'
        when 'warning_13' then '上级没有同意请假、没有通过系统请假'
        when 'warning_14' then '没有通过系统请假'
        when 'warning_15' then '未按时上下班'
        when 'warning_16' then '不配合公司的吸毒检查'
        when 'warning_17' then '伪造证件'
        when 'warning_18' then '粗心大意造成公司重大损失（造成钱丢失）'
        when 'warning_19' then '未按照网点规定的时间回款'
        when 'warning_20' then '谎报里程'
        when 'warning_21' then '煽动/挑衅/损害公司利益'
        when 'warning_22' then '失职'
        when 'warning_23' then '损害公司名誉'
        when 'warning_24' then '不接受或不配合公司的调查'
        when 'warning_25' then 'Fake  Status'
        when 'warning_26' then 'Fake  POD '
        when 'warning_27' then '工作效率未达到公司的标准(KPI)'
        when 'warning_28' then '贪污钱 '
        when 'warning_29' then '贪污包裹'
        when 'warning_30' then '偷盗公司财物'
        when 'warning_31' then '无故连续旷工1天'
        when 'warning_32' then '无故连续旷工2天'
        when 'warning_33' then '迟到/早退 <= 10 分钟超过1次'
        when 'warning_34' then '性骚扰'
        when 'warning_35' then '提供虚假或未更新的个人信息'
        when 'warning_36' then 'Fake scan face - 违法者'
        when 'warning_37' then 'Fake scan face - 帮手'
        when 'warning_101' then '一月内虚假妥投大于等于4次 '
        when 'warning_102' then '包裹被网点KIT扫描后遗失（2件及以上） '
        when 'warning_103' then '虚假扫描 '
        when 'warning_104' then '偷盗包裹 '
        when 'warning_105' then '仓库内吸烟 '
        when 'warning_106' then '辱骂客户 '
        when 'warning_107' then '乱扔包裹 '
        when 'warning_108' then '一个月内两次及以上虚假取消揽收 '
        when 'warning_109' then '未经客户同意私自擅闯客户家 '
        when 'warning_110' then '恶意争抢客户 '
        else type_code
    end 警告原因
    ,swd.warning_count 员工当前警告信次数
from ph_backyard.message_warning mw
left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = mw.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day )
left join ph_backyard.staff_warning_message swm on mw.staff_warning_message_id = swm.id
left join ph_backyard.report_audit_log ral on ral.warning_id = mw.id
left join ph_backyard.report_audit ra on ral.report_id = ra.id
left join ph_backyard.staff_warning_dismiss swd on swd.staff_info_id = mw.staff_info_id
where
    mw.is_delete = 0
    and mw.created_at >= '2023-06-01'
    and mw.created_at < '2023-07-01';
;-- -. . -..- - / . -. - .-. -.--
select
    pi.client_id
    ,pi.dst_phone 收件人
    ,ss.name 网点
    ,count(distinct pi.pno) 包裹数
from ph_staging.parcel_info pi
left join ph_staging.sys_store ss on ss.id = pi.dst_store_id
where
    pi.returned = 0
    and pi.client_id in ('CA0089','BA0635','A0142','BA0184','BA0056','BA0299','BA0577','CA3484','BA0258','CA1026','BA0323','BA0344','CA1644','BA0599','AA0140','CA1281','CA0548','CA0179','CA1280','CA1385','CA3478','BA0391','AA0111','AA0076','BA0441')
    and pi.created_at >= '2023-06-30 16:00:00'
    and pi.created_at < '2023-06-30 16:00:00'
group by 1,2,3;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.client_id
    ,pi.dst_phone 收件人
    ,ss.name 网点
    ,count(distinct pi.pno) 包裹数
from ph_staging.parcel_info pi
left join ph_staging.sys_store ss on ss.id = pi.dst_store_id
where
    pi.returned = 0
    and pi.client_id in ('CA0089','BA0635','A0142','BA0184','BA0056','BA0299','BA0577','CA3484','BA0258','CA1026','BA0323','BA0344','CA1644','BA0599','AA0140','CA1281','CA0548','CA0179','CA1280','CA1385','CA3478','BA0391','AA0111','AA0076','BA0441')
    and pi.created_at >= '2023-06-30 16:00:00'
    and pi.created_at < '2023-07-31 16:00:00'
group by 1,2,3;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.client_id
    ,pi.dst_phone 收件人
    ,ss.name 网点
    ,count(distinct pi.pno) 包裹数
from ph_staging.diff_info di
left join ph_staging.parcel_info pi on pi.pno = di.pno
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = di.store_id
where
    di.diff_marker_category in (2,17)
    and pi.returned = 0
    and pi.client_id in ('CA0089','BA0635','A0142','BA0184','BA0056','BA0299','BA0577','CA3484','BA0258','CA1026','BA0323','BA0344','CA1644','BA0599','AA0140','CA1281','CA0548','CA0179','CA1280','CA1385','CA3478','BA0391','AA0111','AA0076','BA0441')
    and pi.created_at >= '2023-06-30 16:00:00'
    and pi.created_at < '2023-07-31 16:00:00'
group by 1,2,3;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.client_id
    ,pi.dst_phone 收件人
    ,dp.store_name 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,count(distinct pi.pno) 包裹数
from ph_staging.diff_info di
left join ph_staging.parcel_info pi on pi.pno = di.pno
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = di.store_id and dp.stat_date = date_sub(curdate(), interval 1 day )
where
    di.diff_marker_category in (2,17)
    and pi.returned = 0
    and pi.client_id in ('CA0089','BA0635','A0142','BA0184','BA0056','BA0299','BA0577','CA3484','BA0258','CA1026','BA0323','BA0344','CA1644','BA0599','AA0140','CA1281','CA0548','CA0179','CA1280','CA1385','CA3478','BA0391','AA0111','AA0076','BA0441')
    and pi.created_at >= '2023-06-30 16:00:00'
    and pi.created_at < '2023-07-31 16:00:00'
group by 1,2,3;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.client_id
    ,pi.dst_phone 收件人
    ,dp.store_name 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,ph.pi_num 收件人7月收包裹数
    ,count(distinct pi.pno) 包裹数
from ph_staging.diff_info di
left join ph_staging.parcel_info pi on pi.pno = di.pno
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = di.store_id and dp.stat_date = date_sub(curdate(), interval 1 day )
left join
    (
        select
            pi.dst_phone
            ,count(pi.pno) pi_num
        from ph_staging.parcel_info pi
        where
            pi.client_id in ('CA0089','BA0635','A0142','BA0184','BA0056','BA0299','BA0577','CA3484','BA0258','CA1026','BA0323','BA0344','CA1644','BA0599','AA0140','CA1281','CA0548','CA0179','CA1280','CA1385','CA3478','BA0391','AA0111','AA0076','BA0441')
            and pi.returned = 0
            and pi.state < 9
            and pi.created_at >= '2023-06-30 16:00:00'
            and pi.created_at < '2023-07-31 16:00:00'
        group by 1
    ) ph on ph.dst_phone = pi.dst_phone
where
    di.diff_marker_category in (2,17)
    and pi.returned = 0
    and pi.state < 9
    and pi.client_id in ('CA0089','BA0635','A0142','BA0184','BA0056','BA0299','BA0577','CA3484','BA0258','CA1026','BA0323','BA0344','CA1644','BA0599','AA0140','CA1281','CA0548','CA0179','CA1280','CA1385','CA3478','BA0391','AA0111','AA0076','BA0441')
    and pi.created_at >= '2023-06-30 16:00:00'
    and pi.created_at < '2023-07-31 16:00:00'
group by 1,2,3;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
    ,convert_tz(pi.created_at, '+00:00', '+08:00') 'pickup time'
    ,src_name 'sender name'
    ,src_phone 'sender contact'
    ,dp1.store_name 'pickup dc'
    ,dp1.piece_name 'pickup district'
    ,dp2.region_name 'pickup area'
    ,concat(hsi.name, '(', hsi.staff_info_id, ')') 'pickup courier'
    ,pi.cod_amount/100 COD
    ,pi.exhibition_weight 'weight/g'
    ,dp2.store_name 'destination dc'
    ,dp2.piece_name 'destination district'
    ,dp2.region_name 'destination area'
from ph_staging.parcel_info pi
left join dwm.dim_ph_sys_store_rd dp1 on dp1.store_id = pi.ticket_pickup_store_id and dp1.stat_date = date_sub(curdate(), interval 1 day )
left join dwm.dim_ph_sys_store_rd dp2 on dp2.store_id = pi.ticket_pickup_store_id and dp2.stat_date = date_sub(curdate(), interval 1 day )
left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_pickup_staff_info_id
where
    if(hour(now()) >= 17, pi.created_at > date_sub(curdate(), interval 8 hour ) and pi.created_at <= date_add(curdate(), interval 9 hour), pi.created_at > date_sub(curdate(), interval 15 hour) and pi.created_at < date_sub(curdate(), interval 8 hour) );
;-- -. . -..- - / . -. - .-. -.--
select
    pi.client_id
    ,pi.dst_phone 收件人
    ,dp.store_name 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,count(distinct pi.pno) 总包裹数
    ,count(distinct di.pno) 拒收包裹数
from ph_staging.parcel_info pi
left join ph_staging.diff_info di on pi.pno = di.pno and di.diff_marker_category in (2,17)
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = di.store_id and dp.stat_date = date_sub(curdate(), interval 1 day )
where
    pi.returned = 0
    and pi.state < 9
    and pi.client_id in ('CA0089','BA0635','A0142','BA0184','BA0056','BA0299','BA0577','CA3484','BA0258','CA1026','BA0323','BA0344','CA1644','BA0599','AA0140','CA1281','CA0548','CA0179','CA1280','CA1385','CA3478','BA0391','AA0111','AA0076','BA0441')
    and pi.created_at >= '2023-06-30 16:00:00'
    and pi.created_at < '2023-07-31 16:00:00'
group by 1,2,3;
;-- -. . -..- - / . -. - .-. -.--
select
    ds.pno
    ,if(ds.arrival_scan_route_at < curdate(), '昨天', '今天' ) 包裹日期
from ph_bi.dc_should_delivery_today ds
where
    ds.stat_date = '2023-08-01'
    and ds.store_id = 'PH61280100';
;-- -. . -..- - / . -. - .-. -.--
select
    ds.pno
    ,if(ds.arrival_scan_route_at < curdate(), '昨天', '今天' ) 包裹日期
from ph_bi.dc_should_delivery_today ds
where
    ds.stat_date = '2023-08-01'
    and ds.store_id = 'PH61280100'
    and ds.pno = 'PT612422AZ0P5AF';
;-- -. . -..- - / . -. - .-. -.--
select
    ds.pno
    ,if(ds.arrival_scan_route_at < curdate(), '昨天', '今天' ) 包裹日期
from ph_bi.dc_should_delivery_today ds
where
    ds.stat_date = '2023-08-01'
    and ds.store_id = 'PH61280100'
    and ds.pno = 'P61281YPAE8CN';
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,pr.pno
        ,hsi.sys_store_id hr_store_id
        ,hsi.formal
        ,hsi.is_sub_staff
        ,pr.staff_info_id
        ,pi.state
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pr.staff_info_id
    where
#         ds.stat_date = '${date}'
#         and
        pr.routed_at >= date_sub('2023-08-01', interval 8 hour )
        and pr.routed_at < date_add('2023-08-01', interval 16 hour)
#         and ds.store_id = 'PH62010300'
)
select
    dr.store_id 网点ID
    ,dr.store_name 网点
    ,dr.opening_at 开业时间
    ,case dr.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dr.piece_name 片区
    ,dr.region_name 大区
    ,emp_cnt.staf_num 总快递员人数
    ,a3.self_staff_num 自有快递员出勤数
    ,a3.staf_num - a3.self_staff_num '外协+支援快递员出勤数'

    ,a3.avg_scan_num 平均交接量
    ,a3.avg_del_num 平均妥投量
    ,sdb.code_num 网点三段码数量
    ,a2.self_avg_staff_code 自有快递员三段码平均交接量
    ,a2.other_avg_staff_code 其他快递员三段码平均交接量
    ,a2.self_avg_staff_del_code 自有快递员三段码平均妥投量
    ,a2.other_avg_staff_del_code 其他快递员三段码平均妥投量
    ,a2.avg_code_staff 三段码平均交接快递员数
    ,case
        when a2.avg_code_staff < 2 then 'A'
        when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
        when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
        when a2.avg_code_staff >= 4 then 'D'
    end 评级
    ,a2.code_num
    ,a2.staff_code_num
    ,a2.staff_num
    ,a2.fin_staff_code_num
from
    (
        select
            a1.store_id
            ,count(distinct a1.staff_code) staff_code_num
            ,count(distinct a1.third_sorting_code) code_num
            ,count(distinct a1.staff_info_id) staff_num
            ,count(distinct if(a1.state = 5, a1.staff_code, null)) fin_staff_code_num
            ,count(distinct a1.staff_code)/ count(distinct a1.third_sorting_code) avg_code_staff
            ,count(distinct if(a1.is_self = 'y', a1.staff_code, null))/count(distinct if(a1.is_self = 'y', a1.staff_info_id, null)) self_avg_staff_code
            ,count(distinct if(a1.is_self = 'n', a1.staff_code, null))/count(distinct if(a1.is_self = 'n', a1.staff_info_id, null)) other_avg_staff_code
            ,count(distinct if(a1.state = 5 and a1.is_self = 'y', a1.staff_code, null))/count(distinct if(a1.is_self = 'y', a1.staff_info_id, null)) self_avg_staff_del_code
            ,count(distinct if(a1.state = 5 and a1.is_self = 'n', a1.staff_code, null))/count(distinct if(a1.is_self = 'n', a1.staff_info_id, null)) other_avg_staff_del_code
        from
            (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct t1.staff_info_id) staf_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1 and t1.is_sub_staff = 0, t1.staff_info_id, null))  self_staff_num

            ,count(distinct t1.pno)/count(distinct t1.staff_info_id) avg_scan_num
            ,count(distinct if(t1.state = 5, t1.pno, null))/count(distinct t1.staff_info_id) avg_del_num
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
select
        ds.dst_store_id store_id
        ,pr.pno
        ,hsi.sys_store_id hr_store_id
        ,hsi.formal
        ,hsi.is_sub_staff
        ,pr.staff_info_id
        ,pi.state
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pr.staff_info_id
    where
#         ds.stat_date = '${date}'
#         and
        pr.routed_at >= date_sub('2023-08-01', interval 8 hour )
        and pr.routed_at < date_add('2023-08-01', interval 16 hour)
        and ds.dst_store_id = 'PH35500K01';
;-- -. . -..- - / . -. - .-. -.--
select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,pr.pno
        ,hsi.sys_store_id hr_store_id
        ,hsi.formal
        ,hsi.is_sub_staff
        ,pr.staff_info_id
        ,pi.state
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pr.staff_info_id
    where
#         ds.stat_date = '${date}'
#         and
        pr.routed_at >= date_sub('2023-08-01', interval 8 hour )
        and pr.routed_at < date_add('2023-08-01', interval 16 hour)
        and hsi.job_title in (13,110,1000)
#         and ds.dst_store_id = 'PH35500K01'
)
select
    dr.store_id 网点ID
    ,dr.store_name 网点
    ,dr.opening_at 开业时间
    ,case dr.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dr.piece_name 片区
    ,dr.region_name 大区
    ,emp_cnt.staf_num 总快递员人数
    ,a3.self_staff_num 自有快递员出勤数
    ,a3.staf_num - a3.self_staff_num '外协+支援快递员出勤数'

    ,a3.avg_scan_num 平均交接量
    ,a3.avg_del_num 平均妥投量
    ,sdb.code_num 网点三段码数量
    ,a2.self_avg_staff_code 自有快递员三段码平均交接量
    ,a2.other_avg_staff_code 其他快递员三段码平均交接量
    ,a2.self_avg_staff_del_code 自有快递员三段码平均妥投量
    ,a2.other_avg_staff_del_code 其他快递员三段码平均妥投量
    ,a2.avg_code_staff 三段码平均交接快递员数
    ,case
        when a2.avg_code_staff < 2 then 'A'
        when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
        when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
        when a2.avg_code_staff >= 4 then 'D'
    end 评级
    ,a2.code_num
    ,a2.staff_code_num
    ,a2.staff_num
    ,a2.fin_staff_code_num
from
    (
        select
            a1.store_id
            ,count(distinct a1.staff_code) staff_code_num
            ,count(distinct a1.third_sorting_code) code_num
            ,count(distinct a1.staff_info_id) staff_num
            ,count(distinct if(a1.state = 5, a1.staff_code, null)) fin_staff_code_num
            ,count(distinct a1.staff_code)/ count(distinct a1.third_sorting_code) avg_code_staff
            ,count(distinct if(a1.is_self = 'y', a1.staff_code, null))/count(distinct if(a1.is_self = 'y', a1.staff_info_id, null)) self_avg_staff_code
            ,count(distinct if(a1.is_self = 'n', a1.staff_code, null))/count(distinct if(a1.is_self = 'n', a1.staff_info_id, null)) other_avg_staff_code
            ,count(distinct if(a1.state = 5 and a1.is_self = 'y', a1.staff_code, null))/count(distinct if(a1.is_self = 'y', a1.staff_info_id, null)) self_avg_staff_del_code
            ,count(distinct if(a1.state = 5 and a1.is_self = 'n', a1.staff_code, null))/count(distinct if(a1.is_self = 'n', a1.staff_info_id, null)) other_avg_staff_del_code
        from
            (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct t1.staff_info_id) staf_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1 and t1.is_sub_staff = 0, t1.staff_info_id, null))  self_staff_num

            ,count(distinct t1.pno)/count(distinct t1.staff_info_id) avg_scan_num
            ,count(distinct if(t1.state = 5, t1.pno, null))/count(distinct t1.staff_info_id) avg_del_num
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,hsi.sys_store_id hr_store_id
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.finished_at >= '2023-07-31 16:00:00'
        and pi.finished_at < '2023-08-01 16:00:00'
        and pi.state = 5
#         and ds.store_id = 'PH40010900'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,dp.opening_at 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,cour.staf_num 本网点所属快递员数
    ,ds.sd_num 应派件量
    ,del.pno_num 妥投量
    ,del_cou.self_staff_num 参与妥投快递员_自有
    ,del_cou.other_staff_num 参与妥投快递员_外协支援
    ,del_cou.self_effect 当日人效_自有
    ,del_cou.other_effect 当日人效_外协支援
    ,del_hour.avg_del_hour 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if(t1.hr_store_id != t1.store_id, t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if(t1.hr_store_id != t1.store_id, t1.pno, null))/count(distinct if(t1.hr_store_id != t1.store_id, t1.ticket_delivery_staff_info_id, null)) other_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,hsi.sys_store_id hr_store_id
        ,hsi.job_title
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.finished_at >= '2023-07-31 16:00:00'
        and pi.finished_at < '2023-08-01 16:00:00'
        and pi.state = 5
#         and ds.store_id = 'PH40010900'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,cour.staf_num 本网点所属快递员数
    ,ds.sd_num 应派件量
    ,del.pno_num '妥投量(快递员+仓管+主管)'
    ,del_cou.self_staff_num 参与妥投快递员_自有
    ,del_cou.other_staff_num 参与妥投快递员_外协支援
    ,del_cou.dco_dcs_num 参与妥投_仓管主管

    ,del_cou.self_effect 当日人效_自有
    ,del_cou.other_effect 当日人效_外协支援
    ,del_cou.dco_dcs_effect 仓管主管人效
    ,del_hour.avg_del_hour 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if(t1.hr_store_id != t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if(t1.hr_store_id != t1.store_id and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.hr_store_id != t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,pr.pno
        ,hsi.sys_store_id hr_store_id
        ,hsi.formal
        ,hsi.is_sub_staff
        ,pr.staff_info_id
        ,pi.state
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pr.staff_info_id
    where
#         ds.stat_date = '${date}'
#         and
        pr.routed_at >= date_sub('2023-08-01', interval 8 hour )
        and pr.routed_at < date_add('2023-08-01', interval 16 hour)
        and hsi.job_title in (13,110,1000)
)
# select
#     dr.store_id 网点ID
#     ,dr.store_name 网点
#     ,dr.opening_at 开业时间
#     ,case dr.store_category
#         when 1 then 'SP'
#         when 2 then 'DC'
#         when 4 then 'SHOP'
#         when 5 then 'SHOP'
#         when 6 then 'FH'
#         when 7 then 'SHOP'
#         when 8 then 'Hub'
#         when 9 then 'Onsite'
#         when 10 then 'BDC'
#         when 11 then 'fulfillment'
#         when 12 then 'B-HUB'
#         when 13 then 'CDC'
#         when 14 then 'PDC'
#     end 网点类型
#     ,dr.piece_name 片区
#     ,dr.region_name 大区
#     ,emp_cnt.staf_num 总快递员人数
#     ,a3.self_staff_num 自有快递员出勤数
#     ,a3.staf_num - a3.self_staff_num '外协+支援快递员出勤数'
#
#     ,a3.avg_scan_num 平均交接量
#     ,a3.avg_del_num 平均妥投量
#     ,sdb.code_num 网点三段码数量
#     ,a2.self_avg_staff_code 自有快递员三段码平均交接量
#     ,a2.other_avg_staff_code 其他快递员三段码平均交接量
#     ,a2.self_avg_staff_del_code 自有快递员三段码平均妥投量
#     ,a2.other_avg_staff_del_code 其他快递员三段码平均妥投量
#     ,a2.avg_code_staff 三段码平均交接快递员数
#     ,case
#         when a2.avg_code_staff < 2 then 'A'
#         when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
#         when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
#         when a2.avg_code_staff >= 4 then 'D'
#     end 评级
#     ,a2.code_num
#     ,a2.staff_code_num
#     ,a2.staff_num
#     ,a2.fin_staff_code_num
# from
#     (
#         select
#             a1.store_id
#             ,count(distinct a1.staff_code) staff_code_num
#             ,count(distinct a1.third_sorting_code) code_num
#             ,count(distinct a1.staff_info_id) staff_num
#             ,count(distinct if(a1.state = 5, a1.staff_code, null)) fin_staff_code_num
#             ,count(distinct a1.staff_code)/ count(distinct a1.third_sorting_code) avg_code_staff
#             ,count(distinct if(a1.is_self = 'y', a1.staff_code, null))/count(distinct if(a1.is_self = 'y', a1.staff_info_id, null)) self_avg_staff_code
#             ,count(distinct if(a1.is_self = 'n', a1.staff_code, null))/count(distinct if(a1.is_self = 'n', a1.staff_info_id, null)) other_avg_staff_code
#             ,count(distinct if(a1.state = 5 and a1.is_self = 'y', a1.staff_code, null))/count(distinct if(a1.is_self = 'y', a1.staff_info_id, null)) self_avg_staff_del_code
#             ,count(distinct if(a1.state = 5 and a1.is_self = 'n', a1.staff_code, null))/count(distinct if(a1.is_self = 'n', a1.staff_info_id, null)) other_avg_staff_del_code
#         from
#             (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,pr.pno
        ,hsi.sys_store_id hr_store_id
        ,hsi.formal
        ,hsi.is_sub_staff
        ,pr.staff_info_id
        ,pi.state
        ,hsi.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pr.staff_info_id
    where
#         ds.stat_date = '${date}'
#         and
        pr.routed_at >= date_sub('2023-08-01', interval 8 hour )
        and pr.routed_at < date_add('2023-08-01', interval 16 hour)
        and ds.dst_store_id = 'PH61230100'
)
select
    dr.store_id 网点ID
    ,dr.store_name 网点
    ,dr.opening_at 开业时间
    ,case dr.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dr.piece_name 片区
    ,dr.region_name 大区
    ,emp_cnt.staf_num 总快递员人数_在职
    ,a3.self_staff_num 自有快递员出勤数
    ,a3.other_staff_num '外协+支援快递员出勤数'

    ,a3.avg_scan_num 平均交接量
    ,a3.avg_del_num 平均妥投量
    ,sdb.code_num 网点三段码数量

    ,a3.dco_dcs_num 仓管主管_出勤数
    ,a3.dco_dcs_avg_scan 仓管主管_平均交接量
    ,a2.self_avg_staff_code 自有快递员三段码平均交接量
    ,a2.other_avg_staff_code 其他快递员三段码平均交接量
    ,a2.self_avg_staff_del_code 自有快递员三段码平均妥投量
    ,a2.other_avg_staff_del_code 其他快递员三段码平均妥投量
    ,a2.avg_code_staff 三段码平均交接快递员数
    ,case
        when a2.avg_code_staff < 2 then 'A'
        when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
        when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
        when a2.avg_code_staff >= 4 then 'D'
    end 评级
    ,a2.code_num
    ,a2.staff_code_num
    ,a2.staff_num
    ,a2.fin_staff_code_num
from
    (
        select
            a1.store_id
            ,count(distinct a1.staff_code) staff_code_num
            ,count(distinct a1.third_sorting_code) code_num
            ,count(distinct a1.staff_info_id) staff_num
            ,count(distinct if(a1.state = 5, a1.staff_code, null)) fin_staff_code_num
            ,count(distinct a1.staff_code)/ count(distinct a1.third_sorting_code) avg_code_staff
            ,count(distinct if(a1.is_self = 'y', a1.staff_code, null))/count(distinct if(a1.is_self = 'y', a1.staff_info_id, null)) self_avg_staff_code
            ,count(distinct if(a1.is_self = 'n', a1.staff_code, null))/count(distinct if(a1.is_self = 'n', a1.staff_info_id, null)) other_avg_staff_code
            ,count(distinct if(a1.state = 5 and a1.is_self = 'y', a1.staff_code, null))/count(distinct if(a1.is_self = 'y', a1.staff_info_id, null)) self_avg_staff_del_code
            ,count(distinct if(a1.state = 5 and a1.is_self = 'n', a1.staff_code, null))/count(distinct if(a1.is_self = 'n', a1.staff_info_id, null)) other_avg_staff_del_code
        from
            (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1 and t1.is_sub_staff = 0 and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1 or t1.is_sub_staff != 0 ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13.110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13.110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
select
        ds.dst_store_id store_id
        ,pr.pno
        ,hsi.sys_store_id hr_store_id
        ,hsi.formal
        ,hsi.is_sub_staff
        ,pr.staff_info_id
        ,pi.state
        ,hsi.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pr.staff_info_id
    where
#         ds.stat_date = '${date}'
#         and
        pr.routed_at >= date_sub('2023-08-01', interval 8 hour )
        and pr.routed_at < date_add('2023-08-01', interval 16 hour)
        and ds.dst_store_id = 'PH61230100';
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hsi.sys_store_id hr_store_id
        ,hsi.formal
        ,hsi.is_sub_staff
        ,pr.staff_info_id
        ,pi.state
        ,hsi.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pr.staff_info_id
    where
#         ds.stat_date = '${date}'
#         and
        pr.routed_at >= date_sub('2023-08-01', interval 8 hour )
        and pr.routed_at < date_add('2023-08-01', interval 16 hour)
        and ds.dst_store_id = 'PH61230100'
)
select
    dr.store_id 网点ID
    ,dr.store_name 网点
    ,dr.opening_at 开业时间
    ,case dr.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dr.piece_name 片区
    ,dr.region_name 大区
    ,emp_cnt.staf_num 总快递员人数_在职
    ,a3.self_staff_num 自有快递员出勤数
    ,a3.other_staff_num '外协+支援快递员出勤数'

    ,a3.avg_scan_num 平均交接量
    ,a3.avg_del_num 平均妥投量
    ,sdb.code_num 网点三段码数量

    ,a3.dco_dcs_num 仓管主管_出勤数
    ,a3.dco_dcs_avg_scan 仓管主管_平均交接量
    ,a2.self_avg_staff_code 自有快递员三段码平均交接量
    ,a2.other_avg_staff_code 其他快递员三段码平均交接量
    ,a2.self_avg_staff_del_code 自有快递员三段码平均妥投量
    ,a2.other_avg_staff_del_code 其他快递员三段码平均妥投量
    ,a2.avg_code_staff 三段码平均交接快递员数
    ,case
        when a2.avg_code_staff < 2 then 'A'
        when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
        when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
        when a2.avg_code_staff >= 4 then 'D'
    end 评级
    ,a2.code_num
    ,a2.staff_code_num
    ,a2.staff_num
    ,a2.fin_staff_code_num
from
    (
        select
            a1.store_id
            ,count(distinct a1.staff_code) staff_code_num
            ,count(distinct a1.third_sorting_code) code_num
            ,count(distinct a1.staff_info_id) staff_num
            ,count(distinct if(a1.state = 5, a1.staff_code, null)) fin_staff_code_num
            ,count(distinct a1.staff_code)/ count(distinct a1.third_sorting_code) avg_code_staff
            ,count(distinct if(a1.is_self = 'y', a1.staff_code, null))/count(distinct if(a1.is_self = 'y', a1.staff_info_id, null)) self_avg_staff_code
            ,count(distinct if(a1.is_self = 'n', a1.staff_code, null))/count(distinct if(a1.is_self = 'n', a1.staff_info_id, null)) other_avg_staff_code
            ,count(distinct if(a1.state = 5 and a1.is_self = 'y', a1.staff_code, null))/count(distinct if(a1.is_self = 'y', a1.staff_info_id, null)) self_avg_staff_del_code
            ,count(distinct if(a1.state = 5 and a1.is_self = 'n', a1.staff_code, null))/count(distinct if(a1.is_self = 'n', a1.staff_info_id, null)) other_avg_staff_del_code
        from
            (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1 and t1.is_sub_staff = 0 and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1 or t1.is_sub_staff != 0 ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13.110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13.110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hsi.sys_store_id hr_store_id
        ,hsi.formal
        ,hsi.is_sub_staff
        ,pr.staff_info_id
        ,pi.state
        ,hsi.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pr.staff_info_id
    where
#         ds.stat_date = '${date}'
#         and
        pr.routed_at >= date_sub('2023-08-01', interval 8 hour )
        and pr.routed_at < date_add('2023-08-01', interval 16 hour)
        and ds.dst_store_id = 'PH61230100';
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hsi.sys_store_id hr_store_id
        ,hsi.formal
        ,hsi.is_sub_staff
        ,pr.staff_info_id
        ,pi.state
        ,hsi.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pr.staff_info_id
    where
#         ds.stat_date = '${date}'
#         and
        pr.routed_at >= date_sub('2023-08-01', interval 8 hour )
        and pr.routed_at < date_add('2023-08-01', interval 16 hour)
        and ds.dst_store_id = 'PH61230100'
)
select
    dr.store_id 网点ID
    ,dr.store_name 网点
    ,dr.opening_at 开业时间
    ,case dr.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dr.piece_name 片区
    ,dr.region_name 大区
    ,emp_cnt.staf_num 总快递员人数_在职
    ,a3.self_staff_num 自有快递员出勤数
    ,a3.other_staff_num '外协+支援快递员出勤数'

    ,a3.avg_scan_num 平均交接量
    ,a3.avg_del_num 平均妥投量
    ,sdb.code_num 网点三段码数量

    ,a3.dco_dcs_num 仓管主管_出勤数
    ,a3.dco_dcs_avg_scan 仓管主管_平均交接量
    ,a2.self_avg_staff_code 自有快递员三段码平均交接量
    ,a2.other_avg_staff_code 其他快递员三段码平均交接量
    ,a2.self_avg_staff_del_code 自有快递员三段码平均妥投量
    ,a2.other_avg_staff_del_code 其他快递员三段码平均妥投量
    ,a2.avg_code_staff 三段码平均交接快递员数
    ,case
        when a2.avg_code_staff < 2 then 'A'
        when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
        when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
        when a2.avg_code_staff >= 4 then 'D'
    end 评级
    ,a2.code_num
    ,a2.staff_code_num
    ,a2.staff_num
    ,a2.fin_staff_code_num
from
    (
        select
            a1.store_id
            ,count(distinct a1.staff_code) staff_code_num
            ,count(distinct a1.third_sorting_code) code_num
            ,count(distinct a1.staff_info_id) staff_num
            ,count(distinct if(a1.state = 5, a1.staff_code, null)) fin_staff_code_num
            ,count(distinct a1.staff_code)/ count(distinct a1.third_sorting_code) avg_code_staff
            ,count(distinct if(a1.is_self = 'y', a1.staff_code, null))/count(distinct if(a1.is_self = 'y', a1.staff_info_id, null)) self_avg_staff_code
            ,count(distinct if(a1.is_self = 'n', a1.staff_code, null))/count(distinct if(a1.is_self = 'n', a1.staff_info_id, null)) other_avg_staff_code
            ,count(distinct if(a1.state = 5 and a1.is_self = 'y', a1.staff_code, null))/count(distinct if(a1.is_self = 'y', a1.staff_info_id, null)) self_avg_staff_del_code
            ,count(distinct if(a1.state = 5 and a1.is_self = 'n', a1.staff_code, null))/count(distinct if(a1.is_self = 'n', a1.staff_info_id, null)) other_avg_staff_del_code
        from
            (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1 and t1.is_sub_staff = 0 and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1 or t1.is_sub_staff != 0 ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
select
    dp.region_name
    ,sum(datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), convert_tz(pi.created_at, '+00:00', '+08:00')))/count(distinct pi.pno) avg_day
from ph_staging.parcel_info pi
left join dwm.dim_ph_sys_store_rd dp on pi.ticket_delivery_store_id = dp.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
where  
    pi.created_at >= '2023-06-30 16:00:00'
    and pi.created_at < '2023-07-31 16:00:00'
    and pi.state = 5
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    dp.region_name
    ,sum(datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), convert_tz(pi.created_at, '+00:00', '+08:00')))/count(distinct pi.pno) avg_day
    ,max(datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), convert_tz(pi.created_at, '+00:00', '+08:00'))) max_day
from ph_staging.parcel_info pi
left join dwm.dim_ph_sys_store_rd dp on pi.ticket_delivery_store_id = dp.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
where
    pi.created_at >= '2023-06-30 16:00:00'
    and pi.created_at < '2023-07-31 16:00:00'
    and pi.state = 5
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    dp.region_name
    ,sum(datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), convert_tz(pi.created_at, '+00:00', '+08:00')))/count(distinct pi.pno) avg_day
    ,max(datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), convert_tz(pi.created_at, '+00:00', '+08:00'))) max_day
    ,count(pi.pno) total
    ,count(if(datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), convert_tz(pi.created_at, '+00:00', '+08:00')) > 10, pi.pno, null)) 10_pno
    ,count(if(datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), convert_tz(pi.created_at, '+00:00', '+08:00')) > 15, pi.pno, null)) 15_pno
    ,count(if(datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), convert_tz(pi.created_at, '+00:00', '+08:00')) > 20, pi.pno, null)) 20_pno
from ph_staging.parcel_info pi
left join dwm.dim_ph_sys_store_rd dp on pi.ticket_delivery_store_id = dp.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
where
    pi.created_at >= '2023-06-30 16:00:00'
    and pi.created_at < '2023-07-31 16:00:00'
    and pi.state = 5
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    dp.region_name
    ,sum(datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), convert_tz(pi.created_at, '+00:00', '+08:00')))/count(distinct pi.pno) avg_day
    ,max(datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), convert_tz(pi.created_at, '+00:00', '+08:00'))) max_day
    ,count(pi.pno) total
    ,count(if(datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), convert_tz(pi.created_at, '+00:00', '+08:00')) > 10, pi.pno, null)) 10_pno
    ,count(if(datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), convert_tz(pi.created_at, '+00:00', '+08:00')) > 15, pi.pno, null)) 15_pno
    ,count(if(datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), convert_tz(pi.created_at, '+00:00', '+08:00')) > 20, pi.pno, null)) 20_pno
from ph_staging.parcel_info pi
left join dwm.dim_ph_sys_store_rd dp on pi.ticket_delivery_store_id = dp.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
where
    pi.created_at >= '2023-06-30 16:00:00'
    and pi.created_at < '2023-07-31 16:00:00'
    and pi.state = 5
    and bc.client_id is null 
group by 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hsi.sys_store_id hr_store_id
        ,hsi.formal
        ,hsi.is_sub_staff
        ,pr.staff_info_id
        ,pi.state
        ,hsi.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pr.staff_info_id
    where
#         ds.stat_date = '${date}'
#         and
        pr.routed_at >= date_sub('2023-08-01', interval 8 hour )
        and pr.routed_at < date_add('2023-08-01', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH61230100'
)
select
    dr.store_id 网点ID
    ,dr.store_name 网点
    ,dr.opening_at 开业时间
    ,case dr.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dr.piece_name 片区
    ,dr.region_name 大区
    ,emp_cnt.staf_num 总快递员人数_在职
    ,a3.self_staff_num 自有快递员出勤数
    ,a3.other_staff_num '外协+支援快递员出勤数'

    ,a3.avg_scan_num 平均交接量
    ,a3.avg_del_num 平均妥投量
    ,sdb.code_num 网点三段码数量

    ,a3.dco_dcs_num 仓管主管_出勤数
    ,a3.dco_dcs_avg_scan 仓管主管_平均交接量
    ,a2.self_avg_staff_code 自有快递员三段码平均交接量
    ,a2.other_avg_staff_code 其他快递员三段码平均交接量
    ,a2.self_avg_staff_del_code 自有快递员三段码平均妥投量
    ,a2.other_avg_staff_del_code 其他快递员三段码平均妥投量
    ,a2.avg_code_staff 三段码平均交接快递员数
    ,case
        when a2.avg_code_staff < 2 then 'A'
        when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
        when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
        when a2.avg_code_staff >= 4 then 'D'
    end 评级
    ,a2.code_num
    ,a2.staff_code_num
    ,a2.staff_num
    ,a2.fin_staff_code_num
from
    (
        select
            a1.store_id
            ,count(distinct a1.staff_code) staff_code_num
            ,count(distinct a1.third_sorting_code) code_num
            ,count(distinct a1.staff_info_id) staff_num
            ,count(distinct if(a1.state = 5, a1.staff_code, null)) fin_staff_code_num
            ,count(distinct a1.staff_code)/ count(distinct a1.third_sorting_code) avg_code_staff
            ,count(distinct if(a1.is_self = 'y', a1.staff_code, null))/count(distinct if(a1.is_self = 'y', a1.staff_info_id, null)) self_avg_staff_code
            ,count(distinct if(a1.is_self = 'n', a1.staff_code, null))/count(distinct if(a1.is_self = 'n', a1.staff_info_id, null)) other_avg_staff_code
            ,count(distinct if(a1.state = 5 and a1.is_self = 'y', a1.staff_code, null))/count(distinct if(a1.is_self = 'y', a1.staff_info_id, null)) self_avg_staff_del_code
            ,count(distinct if(a1.state = 5 and a1.is_self = 'n', a1.staff_code, null))/count(distinct if(a1.is_self = 'n', a1.staff_info_id, null)) other_avg_staff_del_code
        from
            (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1 and t1.is_sub_staff = 0 and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1 or t1.is_sub_staff != 0 ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hsi.sys_store_id hr_store_id
        ,hsi.formal
        ,hsi.is_sub_staff
        ,pr.staff_info_id
        ,pi.state
        ,hsi.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pr.staff_info_id
    where
#         ds.stat_date = '${date}'
#         and
        pr.routed_at >= date_sub('2023-08-01', interval 8 hour )
        and pr.routed_at < date_add('2023-08-01', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
        and ds.dst_store_id = 'PH40401200';
;-- -. . -..- - / . -. - .-. -.--
select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hsi.sys_store_id hr_store_id
        ,hsi.formal
        ,hsi.is_sub_staff
        ,pr.staff_info_id
        ,pi.state
        ,hsi.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pr.staff_info_id
    where
#         ds.stat_date = '${date}'
#         and
        pr.routed_at >= date_sub('2023-08-01', interval 8 hour )
        and pr.routed_at < date_add('2023-08-01', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
        and ds.dst_store_id = 'PH35300N02';
;-- -. . -..- - / . -. - .-. -.--
select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hsi.sys_store_id hr_store_id
        ,hsi.formal
        ,hsi.is_sub_staff
        ,pr.staff_info_id
        ,pi.state
        ,hsi.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pr.staff_info_id
    where
#         ds.stat_date = '${date}'
#         and
        pr.routed_at >= date_sub('2023-08-01', interval 8 hour )
        and pr.routed_at < date_add('2023-08-01', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
        and ds.dst_store_id = 'PH17140C03';
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
#         ds.stat_date = '${date}'
#         and
        pr.routed_at >= date_sub('2023-08-01', interval 8 hour )
        and pr.routed_at < date_add('2023-08-01', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
        and hst.stat_date = '2023-08-01'
#         and ds.dst_store_id = 'PH17140C03'
)
select
    dr.store_id 网点ID
    ,dr.store_name 网点
    ,dr.opening_at 开业时间
    ,case dr.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dr.piece_name 片区
    ,dr.region_name 大区
    ,emp_cnt.staf_num 总快递员人数_在职
    ,a3.self_staff_num 自有快递员出勤数
    ,a3.other_staff_num '外协+支援快递员出勤数'

    ,a3.avg_scan_num 平均交接量
    ,a3.avg_del_num 平均妥投量
    ,sdb.code_num 网点三段码数量

    ,a3.dco_dcs_num 仓管主管_出勤数
    ,a3.dco_dcs_avg_scan 仓管主管_平均交接量
    ,a2.self_avg_staff_code 自有快递员三段码平均交接量
    ,a2.other_avg_staff_code 其他快递员三段码平均交接量
    ,a2.self_avg_staff_del_code 自有快递员三段码平均妥投量
    ,a2.other_avg_staff_del_code 其他快递员三段码平均妥投量
    ,a2.avg_code_staff 三段码平均交接快递员数
    ,case
        when a2.avg_code_staff < 2 then 'A'
        when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
        when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
        when a2.avg_code_staff >= 4 then 'D'
    end 评级
    ,a2.code_num
    ,a2.staff_code_num
    ,a2.staff_num
    ,a2.fin_staff_code_num
from
    (
        select
            a1.store_id
            ,count(distinct a1.staff_code) staff_code_num
            ,count(distinct a1.third_sorting_code) code_num
            ,count(distinct a1.staff_info_id) staff_num
            ,count(distinct if(a1.state = 5, a1.staff_code, null)) fin_staff_code_num
            ,count(distinct a1.staff_code)/ count(distinct a1.third_sorting_code) avg_code_staff
            ,count(distinct if(a1.is_self = 'y', a1.staff_code, null))/count(distinct if(a1.is_self = 'y', a1.staff_info_id, null)) self_avg_staff_code
            ,count(distinct if(a1.is_self = 'n', a1.staff_code, null))/count(distinct if(a1.is_self = 'n', a1.staff_info_id, null)) other_avg_staff_code
            ,count(distinct if(a1.state = 5 and a1.is_self = 'y', a1.staff_code, null))/count(distinct if(a1.is_self = 'y', a1.staff_info_id, null)) self_avg_staff_del_code
            ,count(distinct if(a1.state = 5 and a1.is_self = 'n', a1.staff_code, null))/count(distinct if(a1.is_self = 'n', a1.staff_info_id, null)) other_avg_staff_del_code
        from
            (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
#         ds.stat_date = '${date}'
#         and
        pr.routed_at >= date_sub('2023-08-01', interval 8 hour )
        and pr.routed_at < date_add('2023-08-01', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
        and hst.stat_date = '2023-08-01'
        and ds.dst_store_id = 'PH17140100';
;-- -. . -..- - / . -. - .-. -.--
select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
#         ds.stat_date = '${date}'
#         and
        pr.routed_at >= date_sub('2023-08-01', interval 8 hour )
        and pr.routed_at < date_add('2023-08-01', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
        and hst.stat_date = '2023-08-01'
        and ds.dst_store_id = 'PH12110200';
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,hsi.store_id hr_store_id
        ,hsi.job_title
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-01'
    where
        pi.finished_at >= '2023-07-31 16:00:00'
        and pi.finished_at < '2023-08-01 16:00:00'
        and pi.state = 5

#         and ds.store_id = 'PH40010900'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if(t1.hr_store_id != t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if(t1.hr_store_id != t1.store_id and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.hr_store_id != t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
select
    d.should_delevry_type
from dwm.dwd_ph_dc_should_be_delivery d
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    scd.*
	,case when scd.delivery_type='自揽自派' and scd.parcel_type='当日包裹' and time(scd.receive_warehouse_time)<'09:20:00' then '1派应派包裹'
		  when scd.delivery_type='自揽自派' and scd.parcel_type='当日包裹'  and scd.store_type='2派网点' and time(scd.receive_warehouse_time)>='09:20:00' and time(scd.receive_warehouse_time)<'13:20:00' then '2派应派包裹'
		  when  scd.parcel_type='历史包裹' then '1派应派包裹'
		  when  scd.parcel_type='当日包裹' and scd.actual_real_time<scd.adjust_line_1_latest_plan_arrive_time then '1派应派包裹'
		  when  scd.parcel_type='当日包裹' and scd.store_type='2派网点' and scd.actual_real_time>=scd.adjust_line_1_latest_plan_arrive_time and scd.actual_real_time<scd.adjust_line_2_latest_plan_arrive_time then '2派应派包裹'
		  when pi.finished_at is not null and pi.state= 5 then '今日应派_妥投'
    else '非当日应派' end as should_delevry_type
	,scd.reschedule_marker_time
from dwm.dwd_ph_dc_should_be_delivery scd
left join ph_staging.parcel_info pi on scd.pno=pi.pno
where
    scd.dst_store_id = 'PH19050S02';
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
#         ds.stat_date = '${date}'
#         and
        pr.routed_at >= date_sub('2023-08-01', interval 8 hour )
        and pr.routed_at < date_add('2023-08-01', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
        and hst.stat_date = '2023-08-01'
#         and ds.dst_store_id = 'PH12110200'
)
select
    dr.store_id 网点ID
    ,dr.store_name 网点
    ,dr.opening_at 开业时间
    ,case dr.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dr.piece_name 片区
    ,dr.region_name 大区
    ,emp_cnt.staf_num 总快递员人数_在职
    ,a3.self_staff_num 自有快递员出勤数
    ,a3.other_staff_num '外协+支援快递员出勤数'

    ,a3.avg_scan_num 平均交接量
    ,a3.avg_del_num 平均妥投量
    ,sdb.code_num 网点三段码数量

    ,a3.dco_dcs_num 仓管主管_出勤数
    ,a3.dco_dcs_avg_scan 仓管主管_平均交接量
    ,a2.self_avg_staff_code 自有快递员三段码平均交接量
    ,a2.other_avg_staff_code 其他快递员三段码平均交接量
    ,a2.self_avg_staff_del_code 自有快递员三段码平均妥投量
    ,a2.other_avg_staff_del_code 其他快递员三段码平均妥投量
    ,a2.avg_code_staff 三段码平均交接快递员数
    ,case
        when a2.avg_code_staff < 2 then 'A'
        when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
        when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
        when a2.avg_code_staff >= 4 then 'D'
    end 评级
    ,a2.code_num
    ,a2.staff_code_num
    ,a2.staff_num
    ,a2.fin_staff_code_num
from
    (
        select
            a1.store_id
            ,count(distinct a1.staff_code) staff_code_num
            ,count(distinct a1.third_sorting_code) code_num
            ,count(distinct a1.staff_info_id) staff_num
            ,count(distinct if(a1.state = 5, a1.staff_code, null)) fin_staff_code_num
            ,count(distinct a1.staff_code)/ count(distinct a1.third_sorting_code) avg_code_staff
            ,count(distinct if(a1.is_self = 'y', a1.staff_code, null))/count(distinct if(a1.is_self = 'y', a1.staff_info_id, null)) self_avg_staff_code
            ,count(distinct if(a1.is_self = 'n', a1.staff_code, null))/count(distinct if(a1.is_self = 'n', a1.staff_info_id, null)) other_avg_staff_code
            ,count(distinct if(a1.state = 5 and a1.is_self = 'y', a1.staff_code, null))/count(distinct if(a1.is_self = 'y', a1.staff_info_id, null)) self_avg_staff_del_code
            ,count(distinct if(a1.state = 5 and a1.is_self = 'n', a1.staff_code, null))/count(distinct if(a1.is_self = 'n', a1.staff_info_id, null)) other_avg_staff_del_code
        from
            (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,hsi.store_id hr_store_id
        ,hsi.job_title
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-01'
    where
        pi.finished_at >= '2023-07-31 16:00:00'
        and pi.finished_at < '2023-08-01 16:00:00'
        and pi.state = 5
        and ds.should_delevry_type != '非当日应派'

#         and ds.store_id = 'PH40010900'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if(t1.hr_store_id != t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if(t1.hr_store_id != t1.store_id and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.hr_store_id != t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,hsi.store_id hr_store_id
        ,hsi.job_title
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-01'
    where
        pi.finished_at >= '2023-07-31 16:00:00'
        and pi.finished_at < '2023-08-01 16:00:00'
        and pi.state = 5
        and ds.should_delevry_type != '非当日应派'

        and ds.store_id = 'PH19050S02';
;-- -. . -..- - / . -. - .-. -.--
select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,hsi.store_id hr_store_id
        ,hsi.job_title
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-01'
    where
        pi.finished_at >= '2023-07-31 16:00:00'
        and pi.finished_at < '2023-08-01 16:00:00'
        and pi.state = 5
        and ds.should_delevry_type != '非当日应派'

        and ds.dst_store_id = 'PH19050S02';
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,hsi.store_id hr_store_id
        ,hsi.job_title
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-01'
    where
        pi.finished_at >= '2023-07-31 16:00:00'
        and pi.finished_at < '2023-08-01 16:00:00'
        and pi.state = 5
        and ds.should_delevry_type != '非当日应派'

#         and ds.dst_store_id = 'PH19050S02'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if(t1.hr_store_id != t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if(t1.hr_store_id != t1.store_id and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.hr_store_id != t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
with d as
(
    select
         ds.dst_store_id store_id
        ,ds.pno
        , '2023-08-01' stat_date
    from dwm.dwd_ph_dc_should_be_delivery ds
    where
        ds.should_delevry_type != '非当日应派'
)
, t as
(
    select
         ds.store_id
        ,ds.pno
        ,ds.stat_date
    from d ds
    left join
        (
            select
                pr.pno
                ,ds.stat_date
                ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
            from ph_staging.parcel_route pr
            join d ds on pr.pno = ds.pno
            where 1=1
                and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                and pr.route_action = 'DETAIN_WAREHOUSE'
                and pr.marker_category in (42,43) ##岛屿,偏远地区
            group by 1,2
        ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
    left join
        (
            select
               pr.pno
                ,ds.stat_date
               ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
               ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
            from ph_staging.parcel_route pr
            join d ds on ds.pno = pr.pno
            where 1=1
                and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                and pr.route_action = 'DETAIN_WAREHOUSE'
                and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                and pr.marker_category in (9,14,70) ##客户改约时间
        ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
    left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
    where
        case
            when pr1.pno is not null then 'N'
            when pr2.pno is not null then 'N'
            when ds1.pno is not null  then 'N'  else 'Y'
        end = 'Y'
)
select
    a.stat_date 日期
    ,a.store_id 网点ID
    ,dp.store_name 网点名称
    ,dp.opening_at 开业时间
    ,case
        when dp.region_name in ('Area3', 'Area6') then '彭万松'
        when dp.region_name in ('Area4', 'Area9') then '韩钥'
        when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
        when dp.region_name in ( 'Area8') then '黄勇'
        when dp.region_name in ('Area1', 'Area2','Area5', 'Area12') then '李俊'
    end 区域
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,a.应交接
    ,a.已交接
    ,concat(round(a.交接率*100,2),'%') as 交接率
    ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
    ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
    ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
    ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
    ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
from
    (
        select
            t1.store_id
            ,t1.stat_date
            ,count(t1.pno) 应交接
            ,count(if(sc.pno is not null , t1.pno, null)) 已交接
            ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
            ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
            ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
            ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
            ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

            ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
            ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
            ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
            ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
        from t t1
        left join
            (
                select
                    sc.*
                from
                    (
                        select
                            pr.pno
                            ,pr.store_id
                            ,pr.store_name
                            ,t1.stat_date
                            ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                            ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                            ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                        from ph_staging.parcel_route pr
                        join t t1 on t1.pno = pr.pno
                        where
                            pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                           and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                          and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                    ) sc
                where
                    sc.rk = 1
            ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
        group by 1,2
    ) a
join
    (
        select
            sd.store_id
        from ph_staging.sys_district sd
        where
            sd.deleted = 0
            and sd.store_id is not null
        group by 1

        union all

        select
            sd.separation_store_id store_id
        from ph_staging.sys_district sd
        where
            sd.deleted = 0
            and sd.separation_store_id is not null
        group by 1
    ) sd on sd.store_id = a.store_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
where
    dp.store_category in (1,10,13);
;-- -. . -..- - / . -. - .-. -.--
select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
#         ds.stat_date = '${date}'
#         and
        pr.routed_at >= date_sub('2023-08-01', interval 8 hour )
        and pr.routed_at < date_add('2023-08-01', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
        and hst.stat_date = '2023-08-01'
        and ds.dst_store_id = 'PH35300N02';
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,hsi.sys_store_id hr_store_id
        ,hsi.job_title
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
#     left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-01'
    left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-08-02'
        and pi.finished_at >= date_sub('2023-08-01', interval 8 hour )
        and pi.finished_at < date_add('2023-08-01', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'

)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.stat_date = '2023-08-02'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if(t1.hr_store_id != t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if(t1.hr_store_id != t1.store_id and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.hr_store_id != t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,hsi.sys_store_id hr_store_id
        ,hsi.job_title
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
#     left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-01'
    left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-08-02'
        and pi.finished_at >= date_sub('2023-08-01', interval 8 hour )
        and pi.finished_at < date_add('2023-08-01', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'

)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-08-02'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if(t1.hr_store_id != t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if(t1.hr_store_id != t1.store_id and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.hr_store_id != t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
with d as
(
    select
         ds.dst_store_id store_id
        ,ds.pno
        ,ds.p_date stat_date
    from dwm.dwd_ph_dc_should_be_delivery ds
    where
        ds.should_delevry_type != '非当日应派'
        and ds.p_date = '2023-08-02'
)
, t as
(
    select
         ds.store_id
        ,ds.pno
        ,ds.stat_date
    from d ds
    left join
        (
            select
                pr.pno
                ,ds.stat_date
                ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
            from ph_staging.parcel_route pr
            join d ds on pr.pno = ds.pno
            where 1=1
                and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                and pr.route_action = 'DETAIN_WAREHOUSE'
                and pr.marker_category in (42,43) ##岛屿,偏远地区
            group by 1,2
        ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
    left join
        (
            select
               pr.pno
                ,ds.stat_date
               ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
               ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
            from ph_staging.parcel_route pr
            join d ds on ds.pno = pr.pno
            where 1=1
                and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                and pr.route_action = 'DETAIN_WAREHOUSE'
                and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                and pr.marker_category in (9,14,70) ##客户改约时间
        ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
    left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
    where
        case
            when pr1.pno is not null then 'N'
            when pr2.pno is not null then 'N'
            when ds1.pno is not null  then 'N'  else 'Y'
        end = 'Y'
)
select
    a.stat_date 日期
    ,a.store_id 网点ID
    ,dp.store_name 网点名称
    ,dp.opening_at 开业时间
    ,case
        when dp.region_name in ('Area3', 'Area6') then '彭万松'
        when dp.region_name in ('Area4', 'Area9') then '韩钥'
        when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
        when dp.region_name in ( 'Area8') then '黄勇'
        when dp.region_name in ('Area1', 'Area2','Area5', 'Area12') then '李俊'
    end 区域
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,a.应交接
    ,a.已交接
    ,concat(round(a.交接率*100,2),'%') as 交接率
    ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
    ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
    ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
    ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
    ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
from
    (
        select
            t1.store_id
            ,t1.stat_date
            ,count(t1.pno) 应交接
            ,count(if(sc.pno is not null , t1.pno, null)) 已交接
            ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
            ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
            ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
            ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
            ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

            ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
            ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
            ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
            ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
        from t t1
        left join
            (
                select
                    sc.*
                from
                    (
                        select
                            pr.pno
                            ,pr.store_id
                            ,pr.store_name
                            ,t1.stat_date
                            ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                            ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                            ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                        from ph_staging.parcel_route pr
                        join t t1 on t1.pno = pr.pno
                        where
                            pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                           and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                          and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                    ) sc
                where
                    sc.rk = 1
            ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
        group by 1,2
    ) a
join
    (
        select
            sd.store_id
        from ph_staging.sys_district sd
        where
            sd.deleted = 0
            and sd.store_id is not null
        group by 1

        union all

        select
            sd.separation_store_id store_id
        from ph_staging.sys_district sd
        where
            sd.deleted = 0
            and sd.separation_store_id is not null
        group by 1
    ) sd on sd.store_id = a.store_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
where
    dp.store_category in (1,10,13);
;-- -. . -..- - / . -. - .-. -.--
select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,hsi.sys_store_id hr_store_id
        ,hsi.job_title
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
#     left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-01'
    left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-08-02'
        and pi.finished_at >= date_sub('2023-08-01', interval 8 hour )
        and pi.finished_at < date_add('2023-08-01', interval 16 hour)
        and ds.should_delevry_type != '非当日应派';
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,hsi.sys_store_id hr_store_id
        ,hsi.job_title
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
#     left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-01'
    left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-08-02'
        and pi.finished_at >= date_sub('2023-08-02', interval 8 hour )
        and pi.finished_at < date_add('2023-08-02', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'

)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-08-02'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if(t1.hr_store_id != t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if(t1.hr_store_id != t1.store_id and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.hr_store_id != t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-08-02'
        and pr.routed_at >= date_sub('2023-08-02', interval 8 hour )
        and pr.routed_at < date_add('2023-08-02', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id = 'PH35300N02'
)
select
    dr.store_id 网点ID
    ,dr.store_name 网点
    ,dr.opening_at 开业时间
    ,case dr.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dr.piece_name 片区
    ,dr.region_name 大区
    ,emp_cnt.staf_num 总快递员人数_在职
    ,a3.self_staff_num 自有快递员出勤数
    ,a3.other_staff_num '外协+支援快递员出勤数'

    ,a3.avg_scan_num 平均交接量
    ,a3.avg_del_num 平均妥投量
    ,sdb.code_num 网点三段码数量

    ,a3.dco_dcs_num 仓管主管_出勤数
    ,a3.dco_dcs_avg_scan 仓管主管_平均交接量
    ,a2.self_avg_staff_code 自有快递员三段码平均交接量
    ,a2.other_avg_staff_code 其他快递员三段码平均交接量
    ,a2.self_avg_staff_del_code 自有快递员三段码平均妥投量
    ,a2.other_avg_staff_del_code 其他快递员三段码平均妥投量
    ,a2.avg_code_staff 三段码平均交接快递员数
    ,case
        when a2.avg_code_staff < 2 then 'A'
        when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
        when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
        when a2.avg_code_staff >= 4 then 'D'
    end 评级
    ,a2.code_num
    ,a2.staff_code_num
    ,a2.staff_num
    ,a2.fin_staff_code_num
from
    (
        select
            a1.store_id
            ,count(distinct a1.staff_code) staff_code_num
            ,count(distinct a1.third_sorting_code) code_num
            ,count(distinct a1.staff_info_id) staff_num
            ,count(distinct if(a1.state = 5, a1.staff_code, null)) fin_staff_code_num
            ,count(distinct a1.staff_code)/ count(distinct a1.third_sorting_code) avg_code_staff
            ,count(distinct if(a1.is_self = 'y', a1.staff_code, null))/count(distinct if(a1.is_self = 'y', a1.staff_info_id, null)) self_avg_staff_code
            ,count(distinct if(a1.is_self = 'n', a1.staff_code, null))/count(distinct if(a1.is_self = 'n', a1.staff_info_id, null)) other_avg_staff_code
            ,count(distinct if(a1.state = 5 and a1.is_self = 'y', a1.staff_code, null))/count(distinct if(a1.is_self = 'y', a1.staff_info_id, null)) self_avg_staff_del_code
            ,count(distinct if(a1.state = 5 and a1.is_self = 'n', a1.staff_code, null))/count(distinct if(a1.is_self = 'n', a1.staff_info_id, null)) other_avg_staff_del_code
        from
            (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with d as
(
    select
         ds.dst_store_id store_id
        ,ds.pno
        ,ds.p_date stat_date
    from dwm.dwd_ph_dc_should_be_delivery ds
    where
        ds.should_delevry_type = '1派应派包裹'
        and ds.p_date = '2023-08-02'
)
, t as
(
    select
         ds.store_id
        ,ds.pno
        ,ds.stat_date
    from d ds
    left join
        (
            select
                pr.pno
                ,ds.stat_date
                ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
            from ph_staging.parcel_route pr
            join d ds on pr.pno = ds.pno
            where 1=1
                and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                and pr.route_action = 'DETAIN_WAREHOUSE'
                and pr.marker_category in (42,43) ##岛屿,偏远地区
            group by 1,2
        ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
    left join
        (
            select
               pr.pno
                ,ds.stat_date
               ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
               ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
            from ph_staging.parcel_route pr
            join d ds on ds.pno = pr.pno
            where 1=1
                and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                and pr.route_action = 'DETAIN_WAREHOUSE'
                and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                and pr.marker_category in (9,14,70) ##客户改约时间
        ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
    left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
    where
        case
            when pr1.pno is not null then 'N'
            when pr2.pno is not null then 'N'
            when ds1.pno is not null  then 'N'  else 'Y'
        end = 'Y'
)
select
    a.stat_date 日期
    ,a.store_id 网点ID
    ,dp.store_name 网点名称
    ,dp.opening_at 开业时间
    ,case
        when dp.region_name in ('Area3', 'Area6') then '彭万松'
        when dp.region_name in ('Area4', 'Area9') then '韩钥'
        when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
        when dp.region_name in ( 'Area8') then '黄勇'
        when dp.region_name in ('Area1', 'Area2','Area5', 'Area12') then '李俊'
    end 区域
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,a.应交接
    ,a.已交接
    ,concat(round(a.交接率*100,2),'%') as 交接率
    ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
    ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
    ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
    ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
    ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
from
    (
        select
            t1.store_id
            ,t1.stat_date
            ,count(t1.pno) 应交接
            ,count(if(sc.pno is not null , t1.pno, null)) 已交接
            ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
            ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
            ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
            ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
            ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

            ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
            ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
            ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
            ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
        from t t1
        left join
            (
                select
                    sc.*
                from
                    (
                        select
                            pr.pno
                            ,pr.store_id
                            ,pr.store_name
                            ,t1.stat_date
                            ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                            ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                            ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                        from ph_staging.parcel_route pr
                        join t t1 on t1.pno = pr.pno
                        where
                            pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                           and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                          and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                    ) sc
                where
                    sc.rk = 1
            ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
        group by 1,2
    ) a
join
    (
        select
            sd.store_id
        from ph_staging.sys_district sd
        where
            sd.deleted = 0
            and sd.store_id is not null
        group by 1

        union all

        select
            sd.separation_store_id store_id
        from ph_staging.sys_district sd
        where
            sd.deleted = 0
            and sd.separation_store_id is not null
        group by 1
    ) sd on sd.store_id = a.store_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
where
    dp.store_category in (1,10,13);
;-- -. . -..- - / . -. - .-. -.--
select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-08-02'
        and pr.routed_at >= date_sub('2023-08-02', interval 8 hour )
        and pr.routed_at < date_add('2023-08-02', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
        and ds.dst_store_id = 'PH35500K01';
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-08-02'
        and pr.routed_at >= date_sub('2023-08-02', interval 8 hour )
        and pr.routed_at < date_add('2023-08-02', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
        and ds.dst_store_id = 'PH35500K01'
)
select
    dr.store_id 网点ID
    ,dr.store_name 网点
    ,dr.opening_at 开业时间
    ,case dr.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dr.piece_name 片区
    ,dr.region_name 大区
    ,emp_cnt.staf_num 总快递员人数_在职
    ,a3.self_staff_num 自有快递员出勤数
    ,a3.other_staff_num '外协+支援快递员出勤数'

    ,a3.avg_scan_num 平均交接量
    ,a3.avg_del_num 平均妥投量
    ,sdb.code_num 网点三段码数量

    ,a3.dco_dcs_num 仓管主管_出勤数
    ,a3.dco_dcs_avg_scan 仓管主管_平均交接量
    ,a2.self_avg_staff_code 自有快递员三段码平均交接量
    ,a2.other_avg_staff_code 其他快递员三段码平均交接量
    ,a2.self_avg_staff_del_code 自有快递员三段码平均妥投量
    ,a2.other_avg_staff_del_code 其他快递员三段码平均妥投量
    ,a2.avg_code_staff 三段码平均交接快递员数
    ,case
        when a2.avg_code_staff < 2 then 'A'
        when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
        when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
        when a2.avg_code_staff >= 4 then 'D'
    end 评级
    ,a2.code_num
    ,a2.staff_code_num
    ,a2.staff_num
    ,a2.fin_staff_code_num
from
    (
        select
            a1.store_id
            ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
            ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
            ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
            ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
            ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
            ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
            ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
            ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
            ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
        from
            (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-08-02'
        and pr.routed_at >= date_sub('2023-08-02', interval 8 hour )
        and pr.routed_at < date_add('2023-08-02', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id = 'PH35500K01'
)
select
    dr.store_id 网点ID
    ,dr.store_name 网点
    ,dr.opening_at 开业时间
    ,case dr.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dr.piece_name 片区
    ,dr.region_name 大区
    ,emp_cnt.staf_num 总快递员人数_在职
    ,a3.self_staff_num 自有快递员出勤数
    ,a3.other_staff_num '外协+支援快递员出勤数'

    ,a3.avg_scan_num 平均交接量
    ,a3.avg_del_num 平均妥投量
    ,sdb.code_num 网点三段码数量

    ,a3.dco_dcs_num 仓管主管_出勤数
    ,a3.dco_dcs_avg_scan 仓管主管_平均交接量
    ,a2.self_avg_staff_code 自有快递员三段码平均交接量
    ,a2.other_avg_staff_code 其他快递员三段码平均交接量
    ,a2.self_avg_staff_del_code 自有快递员三段码平均妥投量
    ,a2.other_avg_staff_del_code 其他快递员三段码平均妥投量
    ,a2.avg_code_staff 三段码平均交接快递员数
    ,case
        when a2.avg_code_staff < 2 then 'A'
        when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
        when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
        when a2.avg_code_staff >= 4 then 'D'
    end 评级
    ,a2.code_num
    ,a2.staff_code_num
    ,a2.staff_num
    ,a2.fin_staff_code_num
from
    (
        select
            a1.store_id
            ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
            ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
            ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
            ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
            ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
            ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
            ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
            ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
            ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
        from
            (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-08-02'
        and pr.routed_at >= date_sub('2023-08-02', interval 8 hour )
        and pr.routed_at < date_add('2023-08-02', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
        and ds.dst_store_id = 'PH01120102';
;-- -. . -..- - / . -. - .-. -.--
select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-08-02'
        and pr.routed_at >= date_sub('2023-08-02', interval 8 hour )
        and pr.routed_at < date_add('2023-08-02', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
        and ds.dst_store_id = 'PH17310800';
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        pr.pno
        ,pr.staff_info_id
        ,convert_tz(pr.routed_at ,'+00:00', '+08:00') rou_time
        ,row_number() over (partition by pr.pno,pr.staff_info_id order by pr.routed_at desc ) rk
    from ph_staging.parcel_route pr
    where
        pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
        and pr.routed_at >= '2023-08-01 16:00:00'
        and pr.routed_at < '2023-08-02 16:00:00'
        and pr.staff_info_id in (162570,154286 ,162116 ,161737 )
)
select
    a1.pno
    ,a1.rou_time 161737最后一次交接时间
    ,a2.rou_time 162116最后一次交接时间
    ,a2.rou_time 154286最后一次交接时间
    ,a4.rou_time 162570最后一次交接时间
from
    (
        select
            *
        from t t1
        where
            t1.staff_info_id = '161737'
            and t1.rk = 1
    ) a1
left join
   (
        select
            *
        from t t1
        where
            t1.staff_info_id = '162116'
            and t1.rk = 1
    ) a2 on a2.pno = a1.pno
join
   (
        select
            *
        from t t1
        where
            t1.staff_info_id = '154286'
            and t1.rk = 1
    ) a3 on a3.pno = a1.pno
join
   (
        select
            *
        from t t1
        where
            t1.staff_info_id = '162570'
            and t1.rk = 1
    ) a4 on a4.pno = a1.pno;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        pr.pno
        ,pr.staff_info_id
        ,convert_tz(pr.routed_at ,'+00:00', '+08:00') rou_time
        ,row_number() over (partition by pr.pno,pr.staff_info_id order by pr.routed_at desc ) rk
    from ph_staging.parcel_route pr
    where
        pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
        and pr.routed_at >= '2023-08-01 16:00:00'
        and pr.routed_at < '2023-08-02 16:00:00'
        and pr.staff_info_id in (162570,154286 ,162116 ,161737 )
)
select
    a1.pno
    ,a1.rou_time 161737最后一次交接时间
    ,a2.rou_time 162116最后一次交接时间
    ,a3.rou_time 154286最后一次交接时间
    ,a4.rou_time 162570最后一次交接时间
from
    (
        select
            *
        from t t1
        where
            t1.staff_info_id = '161737'
            and t1.rk = 1
    ) a1
left join
   (
        select
            *
        from t t1
        where
            t1.staff_info_id = '162116'
            and t1.rk = 1
    ) a2 on a2.pno = a1.pno
join
   (
        select
            *
        from t t1
        where
            t1.staff_info_id = '154286'
            and t1.rk = 1
    ) a3 on a3.pno = a1.pno
join
   (
        select
            *
        from t t1
        where
            t1.staff_info_id = '162570'
            and t1.rk = 1
    ) a4 on a4.pno = a1.pno;
;-- -. . -..- - / . -. - .-. -.--
select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-08-02'
        and pr.routed_at >= date_sub('2023-08-02', interval 8 hour )
        and pr.routed_at < date_add('2023-08-02', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
        and ds.dst_store_id = 'PH52010101';
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-08-02'
        and pr.routed_at >= date_sub('2023-08-02', interval 8 hour )
        and pr.routed_at < date_add('2023-08-02', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id = 'PH52010101'
)
select
    dr.store_id 网点ID
    ,dr.store_name 网点
    ,dr.opening_at 开业时间
    ,case dr.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dr.piece_name 片区
    ,dr.region_name 大区
    ,emp_cnt.staf_num 总快递员人数_在职
    ,a3.self_staff_num 自有快递员出勤数
    ,a3.other_staff_num '外协+支援快递员出勤数'

    ,a3.avg_scan_num 平均交接量
    ,a3.avg_del_num 平均妥投量
    ,sdb.code_num 网点三段码数量

    ,a3.dco_dcs_num 仓管主管_出勤数
    ,a3.dco_dcs_avg_scan 仓管主管_平均交接量
    ,a2.self_avg_staff_code 自有快递员三段码平均交接量
    ,a2.other_avg_staff_code 其他快递员三段码平均交接量
    ,a2.self_avg_staff_del_code 自有快递员三段码平均妥投量
    ,a2.other_avg_staff_del_code 其他快递员三段码平均妥投量
    ,a2.avg_code_staff 三段码平均交接快递员数
    ,case
        when a2.avg_code_staff < 2 then 'A'
        when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
        when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
        when a2.avg_code_staff >= 4 then 'D'
    end 评级
    ,a2.code_num
    ,a2.staff_code_num
    ,a2.staff_num
    ,a2.fin_staff_code_num
from
    (
        select
            a1.store_id
            ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
            ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
            ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
            ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
            ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
            ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
            ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
            ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
            ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
        from
            (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-08-02'
        and pr.routed_at >= date_sub('2023-08-02', interval 8 hour )
        and pr.routed_at < date_add('2023-08-02', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
        and ds.dst_store_id = 'PH61280100'
)
# select
#     dr.store_id 网点ID
#     ,dr.store_name 网点
#     ,dr.opening_at 开业时间
#     ,case dr.store_category
#         when 1 then 'SP'
#         when 2 then 'DC'
#         when 4 then 'SHOP'
#         when 5 then 'SHOP'
#         when 6 then 'FH'
#         when 7 then 'SHOP'
#         when 8 then 'Hub'
#         when 9 then 'Onsite'
#         when 10 then 'BDC'
#         when 11 then 'fulfillment'
#         when 12 then 'B-HUB'
#         when 13 then 'CDC'
#         when 14 then 'PDC'
#     end 网点类型
#     ,dr.piece_name 片区
#     ,dr.region_name 大区
#     ,emp_cnt.staf_num 总快递员人数_在职
#     ,a3.self_staff_num 自有快递员出勤数
#     ,a3.other_staff_num '外协+支援快递员出勤数'
#
#     ,a3.avg_scan_num 平均交接量
#     ,a3.avg_del_num 平均妥投量
#     ,sdb.code_num 网点三段码数量
#
#     ,a3.dco_dcs_num 仓管主管_出勤数
#     ,a3.dco_dcs_avg_scan 仓管主管_平均交接量
#     ,a2.self_avg_staff_code 自有快递员三段码平均交接量
#     ,a2.other_avg_staff_code 其他快递员三段码平均交接量
#     ,a2.self_avg_staff_del_code 自有快递员三段码平均妥投量
#     ,a2.other_avg_staff_del_code 其他快递员三段码平均妥投量
#     ,a2.avg_code_staff 三段码平均交接快递员数
#     ,case
#         when a2.avg_code_staff < 2 then 'A'
#         when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
#         when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
#         when a2.avg_code_staff >= 4 then 'D'
#     end 评级
#     ,a2.code_num
#     ,a2.staff_code_num
#     ,a2.staff_num
#     ,a2.fin_staff_code_num
# from
#     (
#         select
#             a1.store_id
#             ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
#             ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
#             ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
#             ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
#             ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
#             ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
#             ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
#             ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
#             ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
#         from
#             (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    where
        pi.state = 5
        and pi.finished_at >= '2023-07-31 16:00:00'
        and pi.finished_at < '2023-08-01 16:00:00'
#         and ds.store_id = 'PH40010900'
)
select
    a.store_id
    ,a.name
    ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
from
    (
        select
            t1.store_id
            ,t1.name
            ,t1.ticket_delivery_staff_info_id
            ,t1.finished_time
            ,t2.finished_time finished_at_2
            ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
        from
            (
                select * from t t1 where t1.rk1 = 1
            ) t1
        join
            (
                select * from t t2 where t2.rk2 = 2
            ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
    ) a
group by 1,2;
;-- -. . -..- - / . -. - .-. -.--
select
    emp_cnt.sys_store_id
    ,emp_cnt.staf_num
    ,att.atd_emp_cnt
from
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt
left join
    (
        select
           ad.sys_store_id
           ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
       from ph_bi.attendance_data_v2 ad
       left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
       where
           (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
            and hr.job_title in (13,110,1000)
#             and ad.stat_date = curdate()
            and ad.stat_date = curdate()
       group by 1
    ) att on att.sys_store_id = emp_cnt.sys_store_id;
;-- -. . -..- - / . -. - .-. -.--
select
    ad.sys_store_id
    ,count(ad.staff_info_id) 应出勤人数
    ,count(if(ad.attendance_started_at is not null or ad.attendance_end_at is not null , ad.staff_info_id, null)) 出勤人数
from ph_bi.attendance_data_v2 ad
where
    ad.attendance_time + ad.BT + ad.CT + ad.BT_Y + ad.AB = 10
    and ad.stat_date = curdate()
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    ds.store_id
    ,ss.name
    ,count(ds.pno) 应派包裹量
    ,count(if(pi.state = 5, ds.pno, null)) 妥投包裹量
    ,count(distinct if(pi.state = 5, pi.ticket_delivery_staff_info_id, null)) 妥投快递员数
    ,count(if(pi.state = 5, ds.pno, null))/count(distinct if(pi.state = 5, pi.ticket_delivery_staff_info_id, null)) 当日人效
from ph_bi.dc_should_delivery_today ds
left join ph_staging.parcel_info pi on pi.pno = ds.pno
left join ph_staging.sys_store ss on ss.id = ds.store_id
where
    ds.stat_date = '2023-07-25'
group by 1,2;
;-- -. . -..- - / . -. - .-. -.--
select
            hsi3.sys_store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_info hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.sys_store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.is_sub_staff= 0
        group by 1,2,3,4,5,6;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.CT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < curdate()
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,dp.opening_at 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end store_level
    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.sys_store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_info hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.sys_store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.is_sub_staff= 0
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,hsi.sys_store_id hr_store_id
        ,hsi.job_title
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
#     left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-01'
    left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-08-02'
        and pi.finished_at >= date_sub('2023-08-02', interval 8 hour )
        and pi.finished_at < date_add('2023-08-02', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'

)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_transfer   hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
            and hr.stat_date = '2023-08-02'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-08-02'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if(t1.hr_store_id != t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if(t1.hr_store_id != t1.store_id and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.hr_store_id != t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,hsi.sys_store_id hr_store_id
        ,hsi.job_title
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
#     left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-01'
    left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-08-02'
        and pi.finished_at >= date_sub('2023-08-02', interval 8 hour )
        and pi.finished_at < date_add('2023-08-02', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'

)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_transfer   hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
            and hr.stat_date = '2023-08-02'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-08-02'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if(t1.hr_store_id != t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if(t1.hr_store_id != t1.store_id and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.hr_store_id != t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,hsi.sys_store_id hr_store_id
        ,hsi.job_title
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
#     left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-01'
    left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-08-02'
        and pi.finished_at >= date_sub('2023-08-02', interval 8 hour )
        and pi.finished_at < date_add('2023-08-02', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
        and ds.dst_store_id = 'PH06140200';
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,hsi.sys_store_id hr_store_id
        ,hsi.job_title
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-02'
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-08-02'
        and pi.finished_at >= date_sub('2023-08-02', interval 8 hour )
        and pi.finished_at < date_add('2023-08-02', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH06140200'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_transfer   hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
            and hr.stat_date = '2023-08-02'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-08-02'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if(t1.hr_store_id != t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if(t1.hr_store_id != t1.store_id and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.hr_store_id != t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,hsi.store_id hr_store_id
        ,hsi.job_title
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-02'
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-08-02'
        and pi.finished_at >= date_sub('2023-08-02', interval 8 hour )
        and pi.finished_at < date_add('2023-08-02', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH06140200'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_transfer   hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
            and hr.stat_date = '2023-08-02'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-08-02'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if(t1.hr_store_id != t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if(t1.hr_store_id != t1.store_id and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.hr_store_id != t1.store_id and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,hsi.store_id hr_store_id
        ,hsi.job_title
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-02'
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-08-02'
        and pi.finished_at >= date_sub('2023-08-02', interval 8 hour )
        and pi.finished_at < date_add('2023-08-02', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
        and ds.dst_store_id = 'PH64140700';
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,hsi.store_id hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-02'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date > '2023-08-02')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-08-02'
        and pi.finished_at >= date_sub('2023-08-02', interval 8 hour )
        and pi.finished_at < date_add('2023-08-02', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
        and ds.dst_store_id = 'PH64140700'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_transfer   hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
            and hr.stat_date = '2023-08-02'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-08-02'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal = 0) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal = 0) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal = 0) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,hsi.store_id hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-02'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date > '2023-08-02')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-08-02'
        and pi.finished_at >= date_sub('2023-08-02', interval 8 hour )
        and pi.finished_at < date_add('2023-08-02', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH64140700'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_transfer   hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
            and hr.stat_date = '2023-08-02'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-08-02'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal = 0) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal = 0) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal = 0) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,hsi.store_id hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-02'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date > '2023-08-02')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-08-02'
        and pi.finished_at >= date_sub('2023-08-02', interval 8 hour )
        and pi.finished_at < date_add('2023-08-02', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
        and ds.dst_store_id = 'PH62110500';
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,hsi.store_id hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-02'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date > '2023-08-02')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-08-02'
        and pi.finished_at >= date_sub('2023-08-02', interval 8 hour )
        and pi.finished_at < date_add('2023-08-02', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
        and ds.dst_store_id = 'PH62110500'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_transfer   hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
            and hr.stat_date = '2023-08-02'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-08-02'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,hsi.store_id hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-02'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date > '2023-08-02')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-08-02'
        and pi.finished_at >= date_sub('2023-08-02', interval 8 hour )
        and pi.finished_at < date_add('2023-08-02', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
        and ds.dst_store_id = 'PH81180100';
;-- -. . -..- - / . -. - .-. -.--
select
    *
from ph_bi.fleet_time ft
where
    ft.real_arrive_time is null
    and ft.fleet_status = 1;
;-- -. . -..- - / . -. - .-. -.--
select
    a.next_store_id
    ,count(distinct a.proof_id) num
from
    (
        select
            ft.next_store_id
            ,ft.proof_id
            ,if(ft.sign_time is null , ft.real_arrive_time, least(ft.sign_time, ft.real_arrive_time)) arr_time
            ,ft.plan_arrive_time
        from ph_bi.fleet_time ft
        where
            ft.fleet_status = 1
            and ft.real_arrive_time >= '2023-08-01 16:00:00'
            and ft.real_arrive_time < '2023-08-02 16:00:00'
            and ft.arrive_type in (3,5)
    ) a
where
    timestampdiff(minute , a.plan_arrive_time, a.arr_time) > 20;
;-- -. . -..- - / . -. - .-. -.--
select
    a.next_store_id
    ,count(distinct a.proof_id) num
from
    (
        select
            ft.next_store_id
            ,ft.proof_id
            ,if(ft.sign_time is null , ft.real_arrive_time, least(ft.sign_time, ft.real_arrive_time)) arr_time
            ,ft.plan_arrive_time
        from ph_bi.fleet_time ft
        where
            ft.fleet_status = 1
            and ft.real_arrive_time >= '2023-08-01 16:00:00'
            and ft.real_arrive_time < '2023-08-02 16:00:00'
            and ft.arrive_type in (3,5)
    ) a
where
    timestampdiff(minute , a.plan_arrive_time, a.arr_time) > 20
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-08-02'
        and pr.routed_at >= date_sub('2023-08-02', interval 8 hour )
        and pr.routed_at < date_add('2023-08-02', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
        and ds.dst_store_id = 'PH61060300';
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-08-02'
        and pr.routed_at >= date_sub('2023-08-02', interval 8 hour )
        and pr.routed_at < date_add('2023-08-02', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
        and ds.dst_store_id = 'PH61060300'
)
# select
#     dr.store_id 网点ID
#     ,dr.store_name 网点
#     ,dr.opening_at 开业时间
#     ,case dr.store_category
#         when 1 then 'SP'
#         when 2 then 'DC'
#         when 4 then 'SHOP'
#         when 5 then 'SHOP'
#         when 6 then 'FH'
#         when 7 then 'SHOP'
#         when 8 then 'Hub'
#         when 9 then 'Onsite'
#         when 10 then 'BDC'
#         when 11 then 'fulfillment'
#         when 12 then 'B-HUB'
#         when 13 then 'CDC'
#         when 14 then 'PDC'
#     end 网点类型
#     ,dr.piece_name 片区
#     ,dr.region_name 大区
#     ,emp_cnt.staf_num 总快递员人数_在职
#     ,a3.self_staff_num 自有快递员出勤数
#     ,a3.other_staff_num '外协+支援快递员出勤数'
#
#     ,a3.avg_scan_num 平均交接量
#     ,a3.avg_del_num 平均妥投量
#     ,sdb.code_num 网点三段码数量
#
#     ,a3.dco_dcs_num 仓管主管_出勤数
#     ,a3.dco_dcs_avg_scan 仓管主管_平均交接量
#     ,a2.self_avg_staff_code 自有快递员三段码平均交接量
#     ,a2.other_avg_staff_code 其他快递员三段码平均交接量
#     ,a2.self_avg_staff_del_code 自有快递员三段码平均妥投量
#     ,a2.other_avg_staff_del_code 其他快递员三段码平均妥投量
#     ,a2.avg_code_staff 三段码平均交接快递员数
#     ,case
#         when a2.avg_code_staff < 2 then 'A'
#         when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
#         when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
#         when a2.avg_code_staff >= 4 then 'D'
#     end 评级
#     ,a2.code_num
#     ,a2.staff_code_num
#     ,a2.staff_num
#     ,a2.fin_staff_code_num
# from
#     (
#         select
#             a1.store_id
#             ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
#             ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
#             ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
#             ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
#             ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
#             ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
#             ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
#             ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
#             ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
#         from
#             (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
with a as
(
    select
        coalesce(a.client_name, '总计') client_name
        ,coalesce(a.疑难件原因, '总计') 疑难件原因
        ,a.`0-2小时`
        ,a.`2-4小时`
        ,a.`4-6小时`
        ,a.`6小时以上`
        ,a.总疑难件量
        ,a.继续配送
        ,a.退货
        ,a.平均处理时长_h
    from
        (
            select
                bc.client_name
                ,case di.diff_marker_category # 疑难原因
                    when 1 then '客户不在家/电话无人接听'
                    when 2 then '收件人拒收'
                    when 3 then '快件分错网点'
                    when 4 then '外包装破损'
                    when 5 then '货物破损'
                    when 6 then '货物短少'
                    when 7 then '货物丢失'
                    when 8 then '电话联系不上'
                    when 9 then '客户改约时间'
                    when 10 then '客户不在'
                    when 11 then '客户取消任务'
                    when 12 then '无人签收'
                    when 13 then '客户周末或假期不收货'
                    when 14 then '客户改约时间'
                    when 15 then '当日运力不足，无法派送'
                    when 16 then '联系不上收件人'
                    when 17 then '收件人拒收'
                    when 18 then '快件分错网点'
                    when 19 then '外包装破损'
                    when 20 then '货物破损'
                    when 21 then '货物短少'
                    when 22 then '货物丢失'
                    when 23 then '详细地址错误'
                    when 24 then '收件地址已废弃或不存在'
                    when 25 then '收件人电话号码错误'
                    when 26 then 'cod金额不正确'
                    when 27 then '无实际包裹'
                    when 28 then '已妥投未交接'
                    when 29 then '收件人电话号码是空号'
                    when 30 then '送错网点'
                    when 31 then '省市乡邮编错误'
                    when 32 then '禁运品'
                    when 33 then '严重破损（丢弃）'
                    when 34 then '退件两次尝试派送失败'
                    when 35 then '不能打开locker'
                    when 36 then 'locker不能使用'
                    when 37 then '该地址找不到lockerstation'
                    when 38 then '一票多件'
                    when 39 then '多次尝试派件失败'
                    when 40 then '客户不在家/电话无人接听'
                    when 41 then '错过班车时间'
                    when 42 then '目的地是偏远地区,留仓待次日派送'
                    when 43 then '目的地是岛屿,留仓待次日派送'
                    when 44 then '企业/机构当天已下班'
                    when 45 then '子母件包裹未全部到达网点'
                    when 46 then '不可抗力原因留仓(台风)'
                    when 47 then '虚假包裹'
                    when 50 then '客户取消寄件'
                    when 51 then '信息录入错误'
                    when 52 then '客户取消寄件'
                    when 53 then 'lazada仓库拒收'
                    when 69 then '禁运品'
                    when 70 then '客户改约时间'
                    when 71 then '当日运力不足，无法派送'
                    when 72 then '客户周末或假期不收货'
                    when 73 then '详细地址错误'
                    when 74 then '收件地址已废弃或不存在'
                    when 75 then '收件人电话号码错误'
                    when 76 then 'cod金额不正确'
                    when 77 then '企业/机构当天已下班'
                    when 78 then '收件人电话号码是空号'
                    when 79 then '快件分错网点-地址错误'
                    when 80 then '客户取消任务'
                    when 81 then '重复下单'
                    when 82 then '已完成揽件'
                    when 83 then '联系不上客户'
                    when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 85 then '寄件人电话号码是空号'
                    when 86 then '包裹不符合揽收条件超大件'
                    when 87 then '包裹不符合揽收条件违禁品'
                    when 88 then '寄件人地址为岛屿'
                    when 89 then '运力短缺，跟客户协商推迟揽收'
                    when 90 then '包裹未准备好推迟揽收'
                    when 91 then '包裹包装不符合运输标准'
                    when 92 then '客户提供的清单里没有此包裹'
                    when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 94 then '客户取消寄件/客户实际不想寄此包裹'
                    when 95 then '车辆/人力短缺推迟揽收'
                    when 96 then '遗漏揽收(已停用)'
                    when 97 then '子母件(一个单号多个包裹)'
                    when 98 then '地址错误addresserror'
                    when 99 then '包裹不符合揽收条件：超大件'
                    when 100 then '包裹不符合揽收条件：违禁品'
                    when 101 then '包裹包装不符合运输标准'
                    when 102 then '包裹未准备好'
                    when 103 then '运力短缺，跟客户协商推迟揽收'
                    when 104 then '子母件(一个单号多个包裹)'
                    when 105 then '破损包裹'
                    when 106 then '空包裹'
                    when 107 then '不能打开locker(密码错误)'
                    when 108 then 'locker不能使用'
                    when 109 then 'locker找不到'
                    when 110 then '运单号与实际包裹的单号不一致'
                    when 111 then 'box客户取消任务'
                    when 112 then '不能打开locker(密码错误)'
                    when 113 then 'locker不能使用'
                    when 114 then 'locker找不到'
                    when 115 then '实际重量尺寸大于客户下单的重量尺寸'
                    when 116 then '客户仓库关闭'
                    when 117 then '客户仓库关闭'
                    when 118 then 'SHOPEE订单系统自动关闭'
                    when 119 then '客户取消包裹'
                    when 121 then '地址错误'
                    when 122 then '当日运力不足，无法揽收'
                end as 疑难件原因
                ,count(if(cdt.negotiation_result_category = 5, di.id, null)) 继续配送
                ,count(if(cdt.negotiation_result_category = 3, di.id, null)) 退货
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 < 2, di.id, null)) '0-2小时'
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 >= 2 and timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 < 4 , di.id, null)) '2-4小时'
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 >= 4 and timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 < 6, di.id, null )) '4-6小时'
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 >= 6 , di.id, null )) '6小时以上'
                ,sum(if(cdt.operator_id not in (10000,10001,100002), timestampdiff(second , cdt.created_at, cdt.updated_at)/3600, null))/count(if(cdt.operator_id not in (10000,10001,100002), di.id, null)) 平均处理时长_h
                ,count(di.id) 总疑难件量
            from ph_staging.diff_info di
            left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
            left join ph_staging.store_diff_ticket sdt on sdt.diff_info_id = di.id
#             left join dwm.dwd_dim_dict tdt2 on di.diff_marker_category= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category' -- 标记原因
            left join ph_staging.parcel_info pi on pi.pno = di.pno
            join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
            where
                di.updated_at >= date_sub('2023-08-02', interval 8 hour )
                and di.updated_at < date_add('2023-08-02', interval 16 hour ) -- 今日处理
                and cdt.state = 1 -- 已处理
                and if(bc.client_name in ('shopee', 'tiktok'), di.diff_marker_category in (23,73,29,78,25,75,31,79), di.diff_marker_category in (23,73,29,78,25,75,31,79,17))
            group by 1,2
            with rollup
        ) a
    order by 1,2
)
, b as
(
    select
        coalesce(a2.client_name, '总计') client_name
        ,coalesce(a2.疑难件原因, '总计') 疑难件原因
        ,a2.`20-9单量`
        ,a2.`前日20-今日9点处理完成量`
        ,a2.`20-9点11点处理完成量`
        ,a2.`9-20单量`
        ,a2.`9-20已处理单量`
        ,a2.`9-20已处理2小时内量`
    from
        (
           select
                bc.client_name
                ,case di.diff_marker_category
                    when 1 then '客户不在家/电话无人接听'
                    when 2 then '收件人拒收'
                    when 3 then '快件分错网点'
                    when 4 then '外包装破损'
                    when 5 then '货物破损'
                    when 6 then '货物短少'
                    when 7 then '货物丢失'
                    when 8 then '电话联系不上'
                    when 9 then '客户改约时间'
                    when 10 then '客户不在'
                    when 11 then '客户取消任务'
                    when 12 then '无人签收'
                    when 13 then '客户周末或假期不收货'
                    when 14 then '客户改约时间'
                    when 15 then '当日运力不足，无法派送'
                    when 16 then '联系不上收件人'
                    when 17 then '收件人拒收'
                    when 18 then '快件分错网点'
                    when 19 then '外包装破损'
                    when 20 then '货物破损'
                    when 21 then '货物短少'
                    when 22 then '货物丢失'
                    when 23 then '详细地址错误'
                    when 24 then '收件地址已废弃或不存在'
                    when 25 then '收件人电话号码错误'
                    when 26 then 'cod金额不正确'
                    when 27 then '无实际包裹'
                    when 28 then '已妥投未交接'
                    when 29 then '收件人电话号码是空号'
                    when 30 then '送错网点'
                    when 31 then '省市乡邮编错误'
                    when 32 then '禁运品'
                    when 33 then '严重破损（丢弃）'
                    when 34 then '退件两次尝试派送失败'
                    when 35 then '不能打开locker'
                    when 36 then 'locker不能使用'
                    when 37 then '该地址找不到lockerstation'
                    when 38 then '一票多件'
                    when 39 then '多次尝试派件失败'
                    when 40 then '客户不在家/电话无人接听'
                    when 41 then '错过班车时间'
                    when 42 then '目的地是偏远地区,留仓待次日派送'
                    when 43 then '目的地是岛屿,留仓待次日派送'
                    when 44 then '企业/机构当天已下班'
                    when 45 then '子母件包裹未全部到达网点'
                    when 46 then '不可抗力原因留仓(台风)'
                    when 47 then '虚假包裹'
                    when 50 then '客户取消寄件'
                    when 51 then '信息录入错误'
                    when 52 then '客户取消寄件'
                    when 53 then 'lazada仓库拒收'
                    when 69 then '禁运品'
                    when 70 then '客户改约时间'
                    when 71 then '当日运力不足，无法派送'
                    when 72 then '客户周末或假期不收货'
                    when 73 then '详细地址错误'
                    when 74 then '收件地址已废弃或不存在'
                    when 75 then '收件人电话号码错误'
                    when 76 then 'cod金额不正确'
                    when 77 then '企业/机构当天已下班'
                    when 78 then '收件人电话号码是空号'
                    when 79 then '快件分错网点-地址错误'
                    when 80 then '客户取消任务'
                    when 81 then '重复下单'
                    when 82 then '已完成揽件'
                    when 83 then '联系不上客户'
                    when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 85 then '寄件人电话号码是空号'
                    when 86 then '包裹不符合揽收条件超大件'
                    when 87 then '包裹不符合揽收条件违禁品'
                    when 88 then '寄件人地址为岛屿'
                    when 89 then '运力短缺，跟客户协商推迟揽收'
                    when 90 then '包裹未准备好推迟揽收'
                    when 91 then '包裹包装不符合运输标准'
                    when 92 then '客户提供的清单里没有此包裹'
                    when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 94 then '客户取消寄件/客户实际不想寄此包裹'
                    when 95 then '车辆/人力短缺推迟揽收'
                    when 96 then '遗漏揽收(已停用)'
                    when 97 then '子母件(一个单号多个包裹)'
                    when 98 then '地址错误addresserror'
                    when 99 then '包裹不符合揽收条件：超大件'
                    when 100 then '包裹不符合揽收条件：违禁品'
                    when 101 then '包裹包装不符合运输标准'
                    when 102 then '包裹未准备好'
                    when 103 then '运力短缺，跟客户协商推迟揽收'
                    when 104 then '子母件(一个单号多个包裹)'
                    when 105 then '破损包裹'
                    when 106 then '空包裹'
                    when 107 then '不能打开locker(密码错误)'
                    when 108 then 'locker不能使用'
                    when 109 then 'locker找不到'
                    when 110 then '运单号与实际包裹的单号不一致'
                    when 111 then 'box客户取消任务'
                    when 112 then '不能打开locker(密码错误)'
                    when 113 then 'locker不能使用'
                    when 114 then 'locker找不到'
                    when 115 then '实际重量尺寸大于客户下单的重量尺寸'
                    when 116 then '客户仓库关闭'
                    when 117 then '客户仓库关闭'
                    when 118 then 'SHOPEE订单系统自动关闭'
                    when 119 then '客户取消包裹'
                    when 121 then '地址错误'
                    when 122 then '当日运力不足，无法揽收'
                end as 疑难件原因
                ,count(if(di.created_at >= date_sub('2023-08-02', interval 12 hour) and di.created_at < date_add('2023-08-02', interval  1 hour), di.id, null)) '20-9单量'
                ,count(if(di.created_at >= date_sub('2023-08-02', interval 12 hour) and di.created_at < date_add('2023-08-02', interval  1 hour) and cdt.state = 1 , di.id, null)) '前日20-今日9点处理完成量'
                ,count(if(di.created_at >= date_sub('2023-08-02', interval 12 hour) and di.created_at < date_add('2023-08-02', interval  1 hour) and cdt.state = 1 and cdt.updated_at < date_add('2023-08-02', interval  3 hour ) , di.id, null)) '20-9点11点处理完成量'
                ,count(if(di.created_at >= date_add('2023-08-02', interval  1 hour) and di.created_at < date_add('2023-08-02', interval 12 hour), di.id, null)) '9-20单量'
                ,count(if(di.created_at >= date_add('2023-08-02', interval  1 hour) and di.created_at < date_add('2023-08-02', interval 12 hour) and cdt.state = 1 , di.id, null)) '9-20已处理单量'
                ,count(if(di.created_at >= date_add('2023-08-02', interval  1 hour) and di.created_at < date_add('2023-08-02', interval 12 hour) and cdt.state = 1 and cdt.updated_at < date_add(di.created_at, interval  2 hour ), di.id, null)) '9-20已处理2小时内量'
            from ph_staging.diff_info di
            join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
            left join ph_staging.store_diff_ticket sdt2 on sdt2.diff_info_id = di.id
#             left join dwm.dwd_dim_dict tdt2 on di.diff_marker_category= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category' -- 标记原因
            left join ph_staging.parcel_info pi on pi.pno = di.pno
            join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
            left join nl_production.violation_return_visit vrv on vrv.link_id = di.pno and vrv.type = 8 and vrv.created_at > date_add(di.created_at, interval 8 hour)
            where
                if(bc.client_name in ('shopee', 'tiktok'), di.diff_marker_category in (23,73,29,78,25,75,31,79), di.diff_marker_category in (23,73,29,78,25,75,31,79,17))
                and di.created_at >= date_sub('2023-08-02', interval 12 hour)
                and di.created_at < date_add('2023-08-02', interval 12 hour )
                and vrv.link_id is null
            group by 1,2
            with rollup
        ) a2
)
select
    t1.client_name
    ,t1.疑难件原因
    ,a1.`0-2小时`
    ,a1.`2-4小时`
    ,a1.`4-6小时`
    ,a1.`6小时以上`
    ,a1.继续配送
    ,a1.退货
    ,a1.平均处理时长_h
    ,a1.总疑难件量
    ,b1.`20-9单量`
    ,b1.`前日20-今日9点处理完成量`
    ,b1.`20-9点11点处理完成量`
    ,b1.`9-20单量`
    ,b1.`9-20已处理单量`
    ,b1.`9-20已处理2小时内量`
from
    (
        select
            t1.疑难件原因
            ,t1.client_name
        from
            (
                select
                    a.client_name
                    ,a.疑难件原因
                from a

                union

                select
                    b.client_name
                    ,b.疑难件原因
                from b
            ) t1
        group by 1,2
    ) t1
left join a a1 on t1.client_name = a1.client_name and t1.疑难件原因 = a1.疑难件原因
left join b b1 on t1.client_name = b1.client_name and t1.疑难件原因 = b1.疑难件原因
order by t1.client_name,case t1.疑难件原因
                            when '总计' then 1
                            when '详细地址错误' then 2
                            when '收件人电话号码是空号' then 3
                            when '收件人电话号码错误' then 4
                            when '省市乡邮编错误' then 5
                            when '收件人拒收' then 6
                        end;
;-- -. . -..- - / . -. - .-. -.--
select
	 di.pno '运单号'
     ,dd.client_name 客户名称
	 ,convert_tz(pi.created_at,'+00:00','+08:00') '揽收日期'
	 ,ss.name '揽收网点'
	 ,case pi.state
		  when 1 then '已揽收'
		  when 2 then '运输中'
		  when 3 then '派送中'
		  when 4 then '已滞留'
		  when 5 then '已签收'
		  when 6 then '疑难件处理中'
		  when 7 then '已退件'
		  when 8 then '异常关闭'
		  when 9 then '已撤销'
		  ELSE pi.state
		  end as '包裹状态'
	 ,ss1.name '目的地网点'
	 ,ss2.name '上报疑难件网点'
	, di.diff_marker_category
    ,case di.diff_marker_category # 疑难原因
            when 1 then '客户不在家/电话无人接听'
            when 2 then '收件人拒收'
            when 3 then '快件分错网点'
            when 4 then '外包装破损'
            when 5 then '货物破损'
            when 6 then '货物短少'
            when 7 then '货物丢失'
            when 8 then '电话联系不上'
            when 9 then '客户改约时间'
            when 10 then '客户不在'
            when 11 then '客户取消任务'
            when 12 then '无人签收'
            when 13 then '客户周末或假期不收货'
            when 14 then '客户改约时间'
            when 15 then '当日运力不足，无法派送'
            when 16 then '联系不上收件人'
            when 17 then '收件人拒收'
            when 18 then '快件分错网点'
            when 19 then '外包装破损'
            when 20 then '货物破损'
            when 21 then '货物短少'
            when 22 then '货物丢失'
            when 23 then '详细地址错误'
            when 24 then '收件地址已废弃或不存在'
            when 25 then '收件人电话号码错误'
            when 26 then 'cod金额不正确'
            when 27 then '无实际包裹'
            when 28 then '已妥投未交接'
            when 29 then '收件人电话号码是空号'
            when 30 then '送错网点'
            when 31 then '省市乡邮编错误'
            when 32 then '禁运品'
            when 33 then '严重破损（丢弃）'
            when 34 then '退件两次尝试派送失败'
            when 35 then '不能打开locker'
            when 36 then 'locker不能使用'
            when 37 then '该地址找不到lockerstation'
            when 38 then '一票多件'
            when 39 then '多次尝试派件失败'
            when 40 then '客户不在家/电话无人接听'
            when 41 then '错过班车时间'
            when 42 then '目的地是偏远地区,留仓待次日派送'
            when 43 then '目的地是岛屿,留仓待次日派送'
            when 44 then '企业/机构当天已下班'
            when 45 then '子母件包裹未全部到达网点'
            when 46 then '不可抗力原因留仓(台风)'
            when 47 then '虚假包裹'
            when 50 then '客户取消寄件'
            when 51 then '信息录入错误'
            when 52 then '客户取消寄件'
            when 53 then 'lazada仓库拒收'
            when 69 then '禁运品'
            when 70 then '客户改约时间'
            when 71 then '当日运力不足，无法派送'
            when 72 then '客户周末或假期不收货'
            when 73 then '详细地址错误'
            when 74 then '收件地址已废弃或不存在'
            when 75 then '收件人电话号码错误'
            when 76 then 'cod金额不正确'
            when 77 then '企业/机构当天已下班'
            when 78 then '收件人电话号码是空号'
            when 79 then '快件分错网点-地址错误'
            when 80 then '客户取消任务'
            when 81 then '重复下单'
            when 82 then '已完成揽件'
            when 83 then '联系不上客户'
            when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
            when 85 then '寄件人电话号码是空号'
            when 86 then '包裹不符合揽收条件超大件'
            when 87 then '包裹不符合揽收条件违禁品'
            when 88 then '寄件人地址为岛屿'
            when 89 then '运力短缺，跟客户协商推迟揽收'
            when 90 then '包裹未准备好推迟揽收'
            when 91 then '包裹包装不符合运输标准'
            when 92 then '客户提供的清单里没有此包裹'
            when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
            when 94 then '客户取消寄件/客户实际不想寄此包裹'
            when 95 then '车辆/人力短缺推迟揽收'
            when 96 then '遗漏揽收(已停用)'
            when 97 then '子母件(一个单号多个包裹)'
            when 98 then '地址错误addresserror'
            when 99 then '包裹不符合揽收条件：超大件'
            when 100 then '包裹不符合揽收条件：违禁品'
            when 101 then '包裹包装不符合运输标准'
            when 102 then '包裹未准备好'
            when 103 then '运力短缺，跟客户协商推迟揽收'
            when 104 then '子母件(一个单号多个包裹)'
            when 105 then '破损包裹'
            when 106 then '空包裹'
            when 107 then '不能打开locker(密码错误)'
            when 108 then 'locker不能使用'
            when 109 then 'locker找不到'
            when 110 then '运单号与实际包裹的单号不一致'
            when 111 then 'box客户取消任务'
            when 112 then '不能打开locker(密码错误)'
            when 113 then 'locker不能使用'
            when 114 then 'locker找不到'
            when 115 then '实际重量尺寸大于客户下单的重量尺寸'
            when 116 then '客户仓库关闭'
            when 117 then '客户仓库关闭'
            when 118 then 'SHOPEE订单系统自动关闭'
            when 119 then '客户取消包裹'
            when 121 then '地址错误'
            when 122 then '当日运力不足，无法揽收'
        end  as ' 疑难件原因 '
	 ,convert_tz(di.created_at,'+00:00','+08:00') '上报时间'
     ,date(convert_tz(di.created_at,'+00:00','+08:00')) '上报日期'
	 ,di.staff_info_id '上报人'
	 ,hi.name '上报人姓名'
	 ,sd.name '处理机构'
	 ,cdt.operator_id '客服操作人ID'
	 ,convert_tz(cdt.first_operated_at,'+00:00','+08:00') '第一次处理时间'
	 ,ifnull(convert_tz(cdt.last_operated_at,'+00:00','+08:00'),convert_tz(cdt.first_operated_at,'+00:00','+08:00')) '最后一次处理时间'
	 ,case cdt.state
		  when 0 then '未处理'
		  when 1 then '已处理'
		  when 2 then '正在沟通中'
		  when 3 then '财务驳回'
		  when 4 then '客户未处理'
		  when 5 then '转交闪速系统'
		  when 6 then '转交QAQC'
		  else cdt.state
		  end '客服处理情况'

     ,case cdt.negotiation_result_category
          when 1 then '赔偿'
          when 2        then '关闭订单(不赔偿不退货)'
          when 3        then'退货'
          when 4        then '退货并赔偿'
          when 5        then '继续配送'
          when 6        then '继续配送并赔偿'
          when 7        then '正在沟通中'
          when 8        then '丢弃包裹的，换单后寄回BKK'
          when 9        then '货物找回，继续派送'
          when 10       then  '改包裹状态'
          when 11       then '需客户修改信息'
          when 12       then '丢弃并赔偿（包裹发到内部拍卖仓）'
	  end '处理结果'
	 ,datediff('hour',convert_tz(di.created_at,'+00:00','+08:00'),ifnull(convert_tz(cdt.last_operated_at,'+00:00','+08:00'),convert_tz(cdt.first_operated_at,'+00:00','+08:00'))) '客服处理-上报时长/h'
	 ,case di.state
		  when 0 then '未处理'
		  when 1 then '已处理'
		  else di.state
      end '疑难件处理情况'
	 ,if(di.state=1,convert_tz(cdt.updated_at,'+00:00','+08:00'),null)  '疑难件处理完成时间'
# 	 ,datediff('hour',convert_tz(di.created_at,'+00:00','+08:00'),if(di.state=1,convert_tz(di.updated_at,'+00:00','+08:00'),null)) '疑难件处理时长/h'
# 	 ,datediff(now(),if(di.state=0,convert_tz(di.created_at,'+00:00','+08:00'),null) ) '未处理当前时间-上报时间/d'
#     ,if(di.state = 0 and di.created_at >= concat(curdate(), ' 12:00:00'), '当日20点后', '之前') 8点判断
    ,case
        when di.created_at >= date_add('2023-08-02', interval 12 hour ) then '当日20点后'
        when di.created_at < date_add('2023-08-02', interval 12 hour ) and di.created_at >= date_sub('2023-08-02', interval 8 hour ) then '积压时间 0 day'
        when di.created_at < date_sub('2023-08-02', interval 8 hour ) then concat('积压时间', datediff('2023-08-02', convert_tz(di.created_at , '+00:00', '+08:00'), ' day'))
    end 积压时长
    ,case
        when cdt.state = 1 and cdt.updated_at <= date_add(cdt.created_at, interval  2 hour) then '及时'
        when cdt.state = 1 and cdt.updated_at > date_add(cdt.created_at, interval  2 hour) then '不及时'
        else null
    end 是否及时
    ,if(di.state = 1 , round(timestampdiff(second, di.created_at, di.updated_at )/ 3600, 2), null) 处理时长_h
from ph_staging.diff_info di
# left join dwm.dwd_dim_dict tdt2 on di.diff_marker_category= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category' -- 标记原因
join ph_staging.parcel_info pi on pi.pno=di.pno
join dwm.dwd_dim_bigClient dd on pi.client_id=dd.client_id
left join ph_bi.sys_store ss on ss.id=pi.ticket_pickup_store_id #揽收网点
left join ph_bi.sys_store ss1 on ss1.id=pi.dst_store_id#目的地网点
left join ph_bi.sys_store ss2 on ss2.id=di.store_id #上报当前网点
left join ph_bi.hr_staff_info hi on hi.staff_info_id=di.staff_info_id #疑难件处理人对应网点
join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id=di.id and cdt.organization_type=2 #疑难件处理进度
left join ph_bi.hr_staff_info hi2 on hi2.staff_info_id=cdt.operator_id #疑难件处理人对应网点
left join ph_bi.sys_department sd on sd.id=hi2.node_department_id
left join nl_production.violation_return_visit vrv on vrv.link_id = di.pno and vrv.type = 8 and and vrv.created_at > date_add(di.created_at, interval 8 hour)
where
    if(dd.client_name in ('shopee', 'tiktok'), di.diff_marker_category in (23,73,29,78,25,75,31,79), di.diff_marker_category in (23,73,29,78,25,75,31,79,17))
    and di.created_at >= date_add('2023-08-02', interval  1 hour)
    and di.created_at < date_add('2023-08-02', interval 12 hour)
    and vrv.link_id is null;
;-- -. . -..- - / . -. - .-. -.--
select
	 di.pno '运单号'
     ,dd.client_name 客户名称
	 ,convert_tz(pi.created_at,'+00:00','+08:00') '揽收日期'
	 ,ss.name '揽收网点'
	 ,case pi.state
		  when 1 then '已揽收'
		  when 2 then '运输中'
		  when 3 then '派送中'
		  when 4 then '已滞留'
		  when 5 then '已签收'
		  when 6 then '疑难件处理中'
		  when 7 then '已退件'
		  when 8 then '异常关闭'
		  when 9 then '已撤销'
		  ELSE pi.state
		  end as '包裹状态'
	 ,ss1.name '目的地网点'
	 ,ss2.name '上报疑难件网点'
	, di.diff_marker_category
    ,case di.diff_marker_category # 疑难原因
            when 1 then '客户不在家/电话无人接听'
            when 2 then '收件人拒收'
            when 3 then '快件分错网点'
            when 4 then '外包装破损'
            when 5 then '货物破损'
            when 6 then '货物短少'
            when 7 then '货物丢失'
            when 8 then '电话联系不上'
            when 9 then '客户改约时间'
            when 10 then '客户不在'
            when 11 then '客户取消任务'
            when 12 then '无人签收'
            when 13 then '客户周末或假期不收货'
            when 14 then '客户改约时间'
            when 15 then '当日运力不足，无法派送'
            when 16 then '联系不上收件人'
            when 17 then '收件人拒收'
            when 18 then '快件分错网点'
            when 19 then '外包装破损'
            when 20 then '货物破损'
            when 21 then '货物短少'
            when 22 then '货物丢失'
            when 23 then '详细地址错误'
            when 24 then '收件地址已废弃或不存在'
            when 25 then '收件人电话号码错误'
            when 26 then 'cod金额不正确'
            when 27 then '无实际包裹'
            when 28 then '已妥投未交接'
            when 29 then '收件人电话号码是空号'
            when 30 then '送错网点'
            when 31 then '省市乡邮编错误'
            when 32 then '禁运品'
            when 33 then '严重破损（丢弃）'
            when 34 then '退件两次尝试派送失败'
            when 35 then '不能打开locker'
            when 36 then 'locker不能使用'
            when 37 then '该地址找不到lockerstation'
            when 38 then '一票多件'
            when 39 then '多次尝试派件失败'
            when 40 then '客户不在家/电话无人接听'
            when 41 then '错过班车时间'
            when 42 then '目的地是偏远地区,留仓待次日派送'
            when 43 then '目的地是岛屿,留仓待次日派送'
            when 44 then '企业/机构当天已下班'
            when 45 then '子母件包裹未全部到达网点'
            when 46 then '不可抗力原因留仓(台风)'
            when 47 then '虚假包裹'
            when 50 then '客户取消寄件'
            when 51 then '信息录入错误'
            when 52 then '客户取消寄件'
            when 53 then 'lazada仓库拒收'
            when 69 then '禁运品'
            when 70 then '客户改约时间'
            when 71 then '当日运力不足，无法派送'
            when 72 then '客户周末或假期不收货'
            when 73 then '详细地址错误'
            when 74 then '收件地址已废弃或不存在'
            when 75 then '收件人电话号码错误'
            when 76 then 'cod金额不正确'
            when 77 then '企业/机构当天已下班'
            when 78 then '收件人电话号码是空号'
            when 79 then '快件分错网点-地址错误'
            when 80 then '客户取消任务'
            when 81 then '重复下单'
            when 82 then '已完成揽件'
            when 83 then '联系不上客户'
            when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
            when 85 then '寄件人电话号码是空号'
            when 86 then '包裹不符合揽收条件超大件'
            when 87 then '包裹不符合揽收条件违禁品'
            when 88 then '寄件人地址为岛屿'
            when 89 then '运力短缺，跟客户协商推迟揽收'
            when 90 then '包裹未准备好推迟揽收'
            when 91 then '包裹包装不符合运输标准'
            when 92 then '客户提供的清单里没有此包裹'
            when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
            when 94 then '客户取消寄件/客户实际不想寄此包裹'
            when 95 then '车辆/人力短缺推迟揽收'
            when 96 then '遗漏揽收(已停用)'
            when 97 then '子母件(一个单号多个包裹)'
            when 98 then '地址错误addresserror'
            when 99 then '包裹不符合揽收条件：超大件'
            when 100 then '包裹不符合揽收条件：违禁品'
            when 101 then '包裹包装不符合运输标准'
            when 102 then '包裹未准备好'
            when 103 then '运力短缺，跟客户协商推迟揽收'
            when 104 then '子母件(一个单号多个包裹)'
            when 105 then '破损包裹'
            when 106 then '空包裹'
            when 107 then '不能打开locker(密码错误)'
            when 108 then 'locker不能使用'
            when 109 then 'locker找不到'
            when 110 then '运单号与实际包裹的单号不一致'
            when 111 then 'box客户取消任务'
            when 112 then '不能打开locker(密码错误)'
            when 113 then 'locker不能使用'
            when 114 then 'locker找不到'
            when 115 then '实际重量尺寸大于客户下单的重量尺寸'
            when 116 then '客户仓库关闭'
            when 117 then '客户仓库关闭'
            when 118 then 'SHOPEE订单系统自动关闭'
            when 119 then '客户取消包裹'
            when 121 then '地址错误'
            when 122 then '当日运力不足，无法揽收'
        end  as ' 疑难件原因 '
	 ,convert_tz(di.created_at,'+00:00','+08:00') '上报时间'
     ,date(convert_tz(di.created_at,'+00:00','+08:00')) '上报日期'
	 ,di.staff_info_id '上报人'
	 ,hi.name '上报人姓名'
	 ,sd.name '处理机构'
	 ,cdt.operator_id '客服操作人ID'
	 ,convert_tz(cdt.first_operated_at,'+00:00','+08:00') '第一次处理时间'
	 ,ifnull(convert_tz(cdt.last_operated_at,'+00:00','+08:00'),convert_tz(cdt.first_operated_at,'+00:00','+08:00')) '最后一次处理时间'
	 ,case cdt.state
		  when 0 then '未处理'
		  when 1 then '已处理'
		  when 2 then '正在沟通中'
		  when 3 then '财务驳回'
		  when 4 then '客户未处理'
		  when 5 then '转交闪速系统'
		  when 6 then '转交QAQC'
		  else cdt.state
		  end '客服处理情况'

     ,case cdt.negotiation_result_category
          when 1 then '赔偿'
          when 2        then '关闭订单(不赔偿不退货)'
          when 3        then'退货'
          when 4        then '退货并赔偿'
          when 5        then '继续配送'
          when 6        then '继续配送并赔偿'
          when 7        then '正在沟通中'
          when 8        then '丢弃包裹的，换单后寄回BKK'
          when 9        then '货物找回，继续派送'
          when 10       then  '改包裹状态'
          when 11       then '需客户修改信息'
          when 12       then '丢弃并赔偿（包裹发到内部拍卖仓）'
	  end '处理结果'
	 ,datediff('hour',convert_tz(di.created_at,'+00:00','+08:00'),ifnull(convert_tz(cdt.last_operated_at,'+00:00','+08:00'),convert_tz(cdt.first_operated_at,'+00:00','+08:00'))) '客服处理-上报时长/h'
	 ,case di.state
		  when 0 then '未处理'
		  when 1 then '已处理'
		  else di.state
      end '疑难件处理情况'
	 ,if(di.state=1,convert_tz(cdt.updated_at,'+00:00','+08:00'),null)  '疑难件处理完成时间'
# 	 ,datediff('hour',convert_tz(di.created_at,'+00:00','+08:00'),if(di.state=1,convert_tz(di.updated_at,'+00:00','+08:00'),null)) '疑难件处理时长/h'
# 	 ,datediff(now(),if(di.state=0,convert_tz(di.created_at,'+00:00','+08:00'),null) ) '未处理当前时间-上报时间/d'
#     ,if(di.state = 0 and di.created_at >= concat(curdate(), ' 12:00:00'), '当日20点后', '之前') 8点判断
    ,case
        when di.created_at >= date_add('2023-08-02', interval 12 hour ) then '当日20点后'
        when di.created_at < date_add('2023-08-02', interval 12 hour ) and di.created_at >= date_sub('2023-08-02', interval 8 hour ) then '积压时间 0 day'
        when di.created_at < date_sub('2023-08-02', interval 8 hour ) then concat('积压时间', datediff('2023-08-02', convert_tz(di.created_at , '+00:00', '+08:00'), ' day'))
    end 积压时长
    ,case
        when cdt.state = 1 and cdt.updated_at <= date_add(cdt.created_at, interval  2 hour) then '及时'
        when cdt.state = 1 and cdt.updated_at > date_add(cdt.created_at, interval  2 hour) then '不及时'
        else null
    end 是否及时
    ,if(di.state = 1 , round(timestampdiff(second, di.created_at, di.updated_at )/ 3600, 2), null) 处理时长_h
from ph_staging.diff_info di
# left join dwm.dwd_dim_dict tdt2 on di.diff_marker_category= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category' -- 标记原因
join ph_staging.parcel_info pi on pi.pno=di.pno
join dwm.dwd_dim_bigClient dd on pi.client_id=dd.client_id
left join ph_bi.sys_store ss on ss.id=pi.ticket_pickup_store_id #揽收网点
left join ph_bi.sys_store ss1 on ss1.id=pi.dst_store_id#目的地网点
left join ph_bi.sys_store ss2 on ss2.id=di.store_id #上报当前网点
left join ph_bi.hr_staff_info hi on hi.staff_info_id=di.staff_info_id #疑难件处理人对应网点
join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id=di.id and cdt.organization_type=2 #疑难件处理进度
left join ph_bi.hr_staff_info hi2 on hi2.staff_info_id=cdt.operator_id #疑难件处理人对应网点
left join ph_bi.sys_department sd on sd.id=hi2.node_department_id
left join nl_production.violation_return_visit vrv on vrv.link_id = di.pno and vrv.type = 8 and vrv.created_at > date_add(di.created_at, interval 8 hour)
where
    if(dd.client_name in ('shopee', 'tiktok'), di.diff_marker_category in (23,73,29,78,25,75,31,79), di.diff_marker_category in (23,73,29,78,25,75,31,79,17))
    and di.created_at >= date_add('2023-08-02', interval  1 hour)
    and di.created_at < date_add('2023-08-02', interval 12 hour)
    and vrv.link_id is null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        pi.pno
        ,pi.state
        ,pi.ticket_pickup_store_id
        ,pi.returned
        ,pi.dst_store_id
        ,pi.client_id
        ,pi.cod_enabled
    from ph_staging.parcel_info pi
    where
        pi.created_at < '2023-07-12 16:00:00'
        and pi.state not in (5,7,8,9)
)
select
    t1.pno
    ,if(t1.returned = 1, '退件', '正向件')  方向
    ,t1.client_id 客户ID
    ,case
        when bc.`client_id` is not null then bc.client_name
        when kp.id is not null and bc.client_id is null then '普通ka'
        when kp.`id` is null then '小c'
    end as 客户类型
    ,case t1.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,case di.diff_marker_category # 疑难原因
        when 1 then '客户不在家/电话无人接听'
        when 2 then '收件人拒收'
        when 3 then '快件分错网点'
        when 4 then '外包装破损'
        when 5 then '货物破损'
        when 6 then '货物短少'
        when 7 then '货物丢失'
        when 8 then '电话联系不上'
        when 9 then '客户改约时间'
        when 10 then '客户不在'
        when 11 then '客户取消任务'
        when 12 then '无人签收'
        when 13 then '客户周末或假期不收货'
        when 14 then '客户改约时间'
        when 15 then '当日运力不足，无法派送'
        when 16 then '联系不上收件人'
        when 17 then '收件人拒收'
        when 18 then '快件分错网点'
        when 19 then '外包装破损'
        when 20 then '货物破损'
        when 21 then '货物短少'
        when 22 then '货物丢失'
        when 23 then '收件人/地址不清晰或不正确'
        when 24 then '收件地址已废弃或不存在'
        when 25 then '收件人电话号码错误'
        when 26 then 'cod金额不正确'
        when 27 then '无实际包裹'
        when 28 then '已妥投未交接'
        when 29 then '收件人电话号码是空号'
        when 30 then '快件分错网点-地址正确'
        when 31 then '快件分错网点-地址错误'
        when 32 then '禁运品'
        when 33 then '严重破损（丢弃）'
        when 34 then '退件两次尝试派送失败'
        when 35 then '不能打开locker'
        when 36 then 'locker不能使用'
        when 37 then '该地址找不到lockerstation'
        when 38 then '一票多件'
        when 39 then '多次尝试派件失败'
        when 40 then '客户不在家/电话无人接听'
        when 41 then '错过班车时间'
        when 42 then '目的地是偏远地区,留仓待次日派送'
        when 43 then '目的地是岛屿,留仓待次日派送'
        when 44 then '企业/机构当天已下班'
        when 45 then '子母件包裹未全部到达网点'
        when 46 then '不可抗力原因留仓(台风)'
        when 47 then '虚假包裹'
        when 48 then '转交FH包裹留仓'
        when 50 then '客户取消寄件'
        when 51 then '信息录入错误'
        when 52 then '客户取消寄件'
        when 53 then 'lazada仓库拒收'
        when 69 then '禁运品'
        when 70 then '客户改约时间'
        when 71 then '当日运力不足，无法派送'
        when 72 then '客户周末或假期不收货'
        when 73 then '收件人/地址不清晰或不正确'
        when 74 then '收件地址已废弃或不存在'
        when 75 then '收件人电话号码错误'
        when 76 then 'cod金额不正确'
        when 77 then '企业/机构当天已下班'
        when 78 then '收件人电话号码是空号'
        when 79 then '快件分错网点-地址错误'
        when 80 then '客户取消任务'
        when 81 then '重复下单'
        when 82 then '已完成揽件'
        when 83 then '联系不上客户'
        when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
        when 85 then '寄件人电话号码是空号'
        when 86 then '包裹不符合揽收条件超大件'
        when 87 then '包裹不符合揽收条件违禁品'
        when 88 then '寄件人地址为岛屿'
        when 89 then '运力短缺，跟客户协商推迟揽收'
        when 90 then '包裹未准备好推迟揽收'
        when 91 then '包裹包装不符合运输标准'
        when 92 then '客户提供的清单里没有此包裹'
        when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
        when 94 then '客户取消寄件/客户实际不想寄此包裹'
        when 95 then '车辆/人力短缺推迟揽收'
        when 96 then '遗漏揽收(已停用)'
        when 97 then '子母件(一个单号多个包裹)'
        when 98 then '地址错误addresserror'
        when 99 then '包裹不符合揽收条件：超大件'
        when 100 then '包裹不符合揽收条件：违禁品'
        when 101 then '包裹包装不符合运输标准'
        when 102 then '包裹未准备好'
        when 103 then '运力短缺，跟客户协商推迟揽收'
        when 104 then '子母件(一个单号多个包裹)'
        when 105 then '破损包裹'
        when 106 then '空包裹'
        when 107 then '不能打开locker(密码错误)'
        when 108 then 'locker不能使用'
        when 109 then 'locker找不到'
        when 110 then '运单号与实际包裹的单号不一致'
        when 111 then 'box客户取消任务'
        when 112 then '不能打开locker(密码错误)'
        when 113 then 'locker不能使用'
        when 114 then 'locker找不到'
        when 115 then '实际重量尺寸大于客户下单的重量尺寸'
        when 116 then '客户仓库关闭'
        when 117 then '客户仓库关闭'
        when 118 then 'SHOPEE订单系统自动关闭'
        when 119 then '客户取消包裹'
        when 121 then '地址错误'
        when 122 then '当日运力不足，无法揽收'
    end as 疑难原因
#     ,case
#         when t1.state = 6 and di.pno is not null then 'KAM/揽件网点未协商'
#         when t1.state = 6 and di.pno is null  then '闪速系统沟通处理中'
#         when t1.state != 6 and plt.pno is not null and plt2.pno is not null then '闪速系统沟通处理中'
#         when plt.pno is null and pct.pno is not null then '闪速超时效理赔未完成'
#         when de.last_store_id = t1.ticket_pickup_store_id and plt2.pno is null then '揽件未发出'
#         when t1.dst_store_id = 'PH19040F05' and plt2.pno is null then '弃件未到拍卖仓'
#         when t1.state != 6 and datediff(now(), convert_tz(pr.routed_at, '+00:00', '+08:00')) > 7 and plt2.pno is not null then 'QAQC无须追责后长期无有效路由'
#         else null
#     end 卡点原因
#     ,de.last_store_name 当前节点
    ,datediff(now(), convert_tz(pr.routed_at, '+00:00', '+08:00')) 最后有效路由距今天数
#     ,de.last_cn_route_action 最新一条有效路由
    ,case pr.route_action # 路由动作
         when 'ACCEPT_PARCEL' then '接件扫描'
         when 'ARRIVAL_GOODS_VAN_CHECK_SCAN' then '车货关联到港'
         when 'ARRIVAL_WAREHOUSE_SCAN' then '到件入仓扫描'
         when 'CANCEL_ARRIVAL_WAREHOUSE_SCAN' then '取消到件入仓扫描'
         when 'CANCEL_PARCEL' then '撤销包裹'
         when 'CANCEL_SHIPMENT_WAREHOUSE' then '取消发件出仓'
         when 'CHANGE_PARCEL_CANCEL' then '修改包裹为撤销'
         when 'CHANGE_PARCEL_CLOSE' then '修改包裹为异常关闭'
         when 'CHANGE_PARCEL_IN_TRANSIT' then '修改包裹为运输中'
         when 'CHANGE_PARCEL_INFO' then '修改包裹信息'
         when 'CHANGE_PARCEL_SIGNED' then '修改包裹为签收'
         when 'CLAIMS_CLOSE' then '理赔关闭'
         when 'CLAIMS_COMPLETE' then '理赔完成'
         when 'CLAIMS_CONTACT' then '已联系客户'
         when 'CLAIMS_TRANSFER_CS' then '转交总部cs处理'
         when 'CLOSE_ORDER' then '关闭订单'
         when 'CONTINUE_TRANSPORT' then '疑难件继续配送'
         when 'CREATE_WORK_ORDER' then '创建工单'
         when 'CUSTOMER_CHANGE_PARCEL_INFO' then '客户修改包裹信息'
         when 'CUSTOMER_OPERATING_RETURN' then '客户操作退回寄件人'
         when 'DELIVERY_CONFIRM' then '确认妥投'
         when 'DELIVERY_MARKER' then '派件标记'
         when 'DELIVERY_PICKUP_STORE_SCAN' then '自提取件扫描'
         when 'DELIVERY_TICKET_CREATION_SCAN' then '交接扫描'
         when 'DELIVERY_TRANSFER' then '派件转单'
         when 'DEPARTURE_GOODS_VAN_CK_SCAN' then '车货关联出港'
         when 'DETAIN_WAREHOUSE' then '货件留仓'
         when 'DIFFICULTY_FINISH_INDEMNITY' then '疑难件支付赔偿'
         when 'DIFFICULTY_HANDOVER' then '疑难件交接'
         when 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE' then '疑难件交接货件留仓'
         when 'DIFFICULTY_RE_TRANSIT' then '疑难件退回区域总部/重启运送'
         when 'DIFFICULTY_RETURN' then '疑难件退回寄件人'
         when 'DIFFICULTY_SEAL' then '集包异常'
         when 'DISCARD_RETURN_BKK' then '丢弃包裹的，换单后寄回BKK'
         when 'DISTRIBUTION_INVENTORY' then '分拨盘库'
         when 'DWS_WEIGHT_IMAGE' then 'DWS复秤照片'
         when 'EXCHANGE_PARCEL' then '换货'
         when 'FAKE_CANCEL_HANDLE' then '虚假撤销判责'
         when 'FLASH_HOME_SCAN' then 'FH交接扫描'
         when 'FORCE_TAKE_PHOTO' then '强制拍照路由'
         when 'HAVE_HAIR_SCAN_NO_TO' then '有发无到'
         when 'HURRY_PARCEL' then '催单'
         when 'INCOMING_CALL' then '来电接听'
         when 'INTERRUPT_PARCEL_AND_RETURN' then '中断运输并退回'
         when 'INVENTORY' then '盘库'
         when 'LOSE_PARCEL_TEAM_OPERATION' then '丢失件团队处理'
         when 'MANUAL_REMARK' then '添加备注'
         when 'MISS_PICKUP_HANDLE' then '漏包裹揽收判责'
         when 'MISSING_PARCEL_SCAN' then '丢失件包裹操作'
         when 'NOTICE_LOST_PARTS_TEAM' then '已通知丢失件团队'
         when 'PARCEL_HEADLESS_CLAIMED' then '无头件包裹已认领'
         when 'PARCEL_HEADLESS_PRINTED' then '无头件包裹已打单'
         when 'PENDING_RETURN' then '待退件'
         when 'PHONE' then '电话联系'
         when 'PICK_UP_STORE' then '待自提取件'
         when 'PICKUP_RETURN_RECEIPT' then '签回单揽收'
         when 'PRINTING' then '打印面单'
         when 'QAQC_OPERATION' then 'QAQC判责'
         when 'RECEIVE_WAREHOUSE_SCAN' then '收件入仓'
         when 'RECEIVED' then '已揽收,初始化动作，实际情况并没有作用'
         when 'REFUND_CONFIRM' then '退件妥投'
         when 'REPAIRED' then '上报问题修复路由'
         when 'REPLACE_PNO' then '换单'
         when 'REPLY_WORK_ORDER' then '回复工单'
         when 'REVISION_TIME' then '改约时间'
         when 'SEAL' then '集包'
         when 'SEAL_NUMBER_CHANGE' then '集包件数变化'
         when 'SHIPMENT_WAREHOUSE_SCAN' then '发件出仓扫描'
         when 'SORTER_WEIGHT_IMAGE' then '分拣机复秤照片'
         when 'SORTING_SCAN' then '分拣扫描'
         when 'STAFF_INFO_UPDATE_WEIGHT' then '快递员修改重量'
         when 'STORE_KEEPER_UPDATE_WEIGHT' then '仓管员复秤'
         when 'STORE_SORTER_UPDATE_WEIGHT' then '分拣机复秤'
         when 'SYSTEM_AUTO_RETURN' then '系统自动退件'
         when 'TAKE_PHOTO' then '异常打单拍照'
         when 'THIRD_EXPRESS_ROUTE' then '第三方公司路由'
         when 'THIRD_PARTY_REASON_DETAIN' then '第三方原因滞留'
         when 'TICKET_WEIGHT_IMAGE' then '揽收称重照片'
         when 'TRANSFER_LOST_PARTS_TEAM' then '已转交丢失件团队'
         when 'TRANSFER_QAQC' then '转交QAQC处理'
         when 'UNSEAL' then '拆包'
         when 'UNSEAL_NO_PARCEL' then '上报包裹不在集包里'
         when 'UNSEAL_NOT_SCANNED' then '集包已拆包，本包裹未被扫描'
         when 'VEHICLE_ACCIDENT_REG' then '车辆车祸登记'
         when 'VEHICLE_ACCIDENT_REGISTRATION' then '车辆车祸登记'
         when 'VEHICLE_WET_DAMAGE_REG' then '车辆湿损登记'
         when 'VEHICLE_WET_DAMAGE_REGISTRATION' then '车辆湿损登记'
        end as 最后一条路由
    ,pr.store_name 最后有效路由动作网点
    ,convert_tz(pr.routed_at ,'+00:00', '+08:00') 最新一条有效路由时间
    ,datediff(now(), de.dst_routed_at) 目的地网点停留时间
    ,de.dst_store 目的地网点
    ,de.src_store 揽收网点
    ,de.pickup_time 揽收时间
    ,de.pick_date 揽收日期
    ,if(hold.pno is not null, 'yes', 'no' ) 是否有holding标记
    ,if(pr3.pno is not null, 'yes', 'no') 是否有待退件标记
    ,td.try_num 尝试派送次数
from t t1
left join ph_staging.ka_profile kp on t1.client_id = kp.id
left join dwm.dwd_dim_bigClient bc on bc.client_id = t1.client_id
left join dwm.dwd_ex_ph_parcel_details de on de.pno = t1.pno
left join
    (
        select
            plt.pno
            ,group_concat(ss.name ) should_do
        from ph_bi.parcel_lose_task plt
        join t t1 on t1.pno = plt.pno
        left join ph_bi.work_order wo on wo.loseparcel_task_id = plt.id
        left join ph_staging.sys_store ss on ss.id = wo.store_id
        where
            plt.state in (3)
            and wo.status in (1,2)
        group by 1

        union  all

        select
            plt.pno
            ,'QAQC' should_do
        from ph_bi.parcel_lose_task plt
        join t t1 on t1.pno = plt.pno
        where
            plt.state in (1,2,4)
    ) plt on plt.pno = t1.pno
left join
    (
        select
            t2.pno
            ,cdt.negotiation_result_category
            ,di.diff_marker_category
            ,case
                when di.diff_marker_category in (20,21)  and cdt.vip_enable = 1 then 'KAM'
                when di.diff_marker_category not in (20,21) and cdt.vip_enable = 1 then 'KAM'
                when di.diff_marker_category not in (20,21) and cdt.vip_enable = 0 then ss2.name
                WHEN di.diff_marker_category in (20,21) and cdt.vip_enable = 0 then ss2.name
            end sh_do
        from ph_staging.diff_info di
        join t t2 on t2.pno = di.pno
        join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
        left join ph_bi.parcel_lose_task plt on plt.source_id = cdt.id
        left join ph_staging.sys_store ss2 on ss2.id = t2.ticket_pickup_store_id
        where
            cdt.negotiation_result_category is null
    ) di on di.pno = t1.pno
left join  
    (
        select
            pr.pno
            ,pr.store_name
            ,pr.routed_at
            ,pr.route_action
            ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
        from  ph_staging.parcel_route pr
        join t t3 on t3.pno = pr.pno
        where
            pr.route_action in ('INVENTORY','RECEIVED' ,'RECEIVE_WAREHOUSE_SCAN', 'SORTING_SCAN', 'DELIVERY_TICKET_CREATION_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SHIPMENT_WAREHOUSE_SCAN', 'DETAIN_WAREHOUSE', 'DELIVERY_CONFIRM', 'DIFFICULTY_HANDOVER', 'DELIVERY_MARKER', 'REPLACE_PNO','SEAL', 'UNSEAL', 'STAFF_INFO_UPDATE_WEIGHT', 'STORE_KEEPER_UPDATE_WEIGHT', 'STORE_SORTER_UPDATE_WEIGHT', 'DISCARD_RETURN_BKK', 'DELIVERY_TRANSFER', 'PICKUP_RETURN_RECEIPT', 'FLASH_HOME_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SORTING_SCAN ', 'DELIVERY_PICKUP_STORE_SCAN', 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE', 'REFUND_CONFIRM', 'ACCEPT_PARCEL')
            and pr.organization_type = 1
        ) pr on pr.pno = t1.pno and pr.rk = 1
left join
    (
        select
            plt.pno
        from ph_bi.parcel_lose_task plt
        join t t1 on t1.pno = plt.pno
        where
            plt.state = 5
            and plt.operator_id not in (10000,10001,10002)
        group by 1
    ) plt2 on plt2.pno = t1.pno
left join
    (
        select
            plt.pno
        from ph_bi.parcel_claim_task plt
        join t t4  on t4.pno = plt.pno
        where
            plt.state not in (6,7,8)
            and plt.source = 11
        group by 1
    ) pct on pct.pno = t1.pno
left join
    (
        select
            pr2.pno
        from ph_staging.parcel_route pr2
        join t t1 on t1.pno = pr2.pno
        where
            pr2.route_action = 'REFUND_CONFIRM'
        group by 1
    ) hold on hold.pno = t1.pno
left join
    (
        select
            pr2.pno
        from  ph_staging.parcel_route pr2
        join t t1 on t1.pno = pr2.pno
        where
            pr2.route_action = 'PENDING_RETURN'
        group by 1
    ) pr3 on pr3.pno = t1.pno
left join
    (
        select
            td.pno
            ,count(distinct date(convert_tz(tdm.created_at, '+00:00', '+08:00'))) try_num
        from ph_staging.ticket_delivery td
        join t t1 on t1.pno = td.pno
        left join ph_staging.ticket_delivery_marker tdm on tdm.delivery_id = td.id
        group by 1
    ) td on td.pno = t1.pno
group by t1.pno;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.client_id
    ,pi.dst_phone 收件人
    ,dp.store_name 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,count(distinct pi.pno) 总包裹数
    ,count(distinct di.pno) 拒收包裹数
from ph_staging.parcel_info pi
left join ph_staging.diff_info di on pi.pno = di.pno and di.diff_marker_category in (2,17)
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = coalesce(di.store_id, pi.dst_store_id) and dp.stat_date = date_sub(curdate(), interval 1 day )
where
    pi.returned = 0
    and pi.state < 9
    and pi.client_id in ('CA0089','BA0635','A0142','BA0184','BA0056','BA0299','BA0577','CA3484','BA0258','CA1026','BA0323','BA0344','CA1644','BA0599','AA0140','CA1281','CA0548','CA0179','CA1280','CA1385','CA3478','BA0391','AA0111','AA0076','BA0441')
    and pi.created_at >= '2023-06-30 16:00:00'
    and pi.created_at < '2023-07-31 16:00:00'
group by 1,2,3;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
    ,convert_tz(pi.created_at, '+00:00', '+08:00') 'pickup time'
    ,src_name 'sender name'
    ,src_phone 'sender contact'
    ,dp1.store_name 'pickup dc'
    ,dp1.piece_name 'pickup district'
    ,dp1.region_name 'pickup area'
    ,concat(hsi.name, '(', hsi.staff_info_id, ')') 'pickup courier'
    ,pi.cod_amount/100 COD
    ,pi.exhibition_weight 'weight/g'
    ,dp2.store_name 'destination dc'
    ,dp2.piece_name 'destination district'
    ,dp2.region_name 'destination area'
from ph_staging.parcel_info pi
left join dwm.dim_ph_sys_store_rd dp1 on dp1.store_id = pi.ticket_pickup_store_id and dp1.stat_date = date_sub(curdate(), interval 1 day )
left join dwm.dim_ph_sys_store_rd dp2 on dp2.store_id = pi.dst_store_id and dp2.stat_date = date_sub(curdate(), interval 1 day )
left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_pickup_staff_info_id
where
    if(hour(now()) >= 17, pi.created_at > date_sub(curdate(), interval 8 hour ) and pi.created_at <= date_add(curdate(), interval 9 hour), pi.created_at > date_sub(curdate(), interval 15 hour) and pi.created_at < date_sub(curdate(), interval 8 hour) );
;-- -. . -..- - / . -. - .-. -.--
select
    kp.id 客户ID
    ,ss.id 网点ID
    ,ss.name 网点
    ,count(distinct pi.pno) 总包裹数
    ,count(distinct if(pr.pno is not null , pi.pno, null)) 总拒收包裹数
    ,count(distinct if(pi.cod_enabled = 1, pi.pno, null)) COD包裹数
    ,count(distinct if(pr.pno is not null and pi.cod_enabled = 1, pi.pno, null)) COD拒收包裹数
from ph_staging.parcel_info pi
join ph_staging.ka_profile kp on kp.id = pi.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
left join ph_staging.parcel_route pr on pr.pno = pi.pno and pr.marker_category in (2,17)
left join ph_staging.sys_store ss on ss.id = coalesce(pi.ticket_delivery_store_id, dst_store_id)
where
    pi.returned = 0
    and pi.state < 9
    and pi.created_at >= '2023-06-30 16:00:00'
    and pi.created_at < '2023-07-31 16:00:00'
    and bc.client_id is null
group by 1,2,3;
;-- -. . -..- - / . -. - .-. -.--
select
    ds.pno
    ,if(ds.arrival_scan_route_at < curdate(), '昨天', '今天' ) 包裹日期
from ph_bi.dc_should_delivery_today ds
where
    ds.stat_date = '2023-08-01'
#     and ds.store_id = 'PH61280100'
    and ds.pno = 'P61281YPAE8CN';
;-- -. . -..- - / . -. - .-. -.--
select
    *
from dwm.dwd_ex_ph_parcel_details de
where
    de.src_store regexp 'FH'
    and de.dst_routed_at is not null
    and de.pickup_time >= '2023-08-01';
;-- -. . -..- - / . -. - .-. -.--
select
    a.*
from
    (
        select
            plt.pno
            ,plt.duty_result
            ,plt.duty_reasons
            ,plt.parcel_created_at
            ,plt.source
            ,plt.operator_id
            ,plt.updated_at
            ,ddd.CN_element
            ,pr.store_id
            ,pr.routed_at
            ,row_number() over (partition by plt.pno order by pr.routed_at desc ) rk
        from ph_bi.parcel_lose_task plt
        left join `ph_bi`.`translations` t on plt.duty_reasons = t.t_key AND t.`lang` = 'zh-CN'
        left join ph_staging.parcel_route pr on pr.pno = plt.pno and pr.routed_at > date_sub(plt.updated_at, interval 8 hour)
        join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
        where
            plt.state = 6
            and plt.duty_result = 1
            and plt.updated_at >= '2023-07-20'
            and plt.updated_at < '2023-07-30'
    ) a
where
    a.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
select
    a.pno
    ,concat(t2.t_value, t3.t_value) 判责原因duty_reasons
    ,a.parcel_created_at 揽收时间receive_time
    ,a.CN_element 最后有效路由last_effective_route
    ,convert_tz(a.routed_at, '+00:00', '+08:00') 最后有效路由时间last_effective_route_time
    ,ss.name 最后有效路由操作网点operate_network_for_last_effective_route
    ,case a.source
        WHEN 1 THEN 'A-问题件-丢失'
        WHEN 2 THEN 'B-记录本-丢失'
        WHEN 3 THEN 'C-包裹状态未更新'
        WHEN 4 THEN 'D-问题件-破损/短少'
        WHEN 5 THEN 'E-记录本-索赔-丢失'
        WHEN 6 THEN 'F-记录本-索赔-破损/短少'
        WHEN 7 THEN 'G-记录本-索赔-其他'
        WHEN 8 THEN 'H-包裹状态未更新-IPC计数'
        WHEN 9 THEN 'I-问题件-外包装破损险'
        WHEN 10 THEN 'J-问题记录本-外包装破损险'
        when 11 then 'K-超时效包裹'
        when 12 then 'L-高度疑似丢失'
    end 问题来源渠道source_of_problem
    ,concat('(', hsi.staff_info_id, ')', hsi.name) 处理人handler
    ,a.updated_at 处理时间process_time
    ,group_concat(ss2.name) 责任网点duty_branch
from
    (
        select
            plt.pno
            ,plt.id
            ,plt.duty_result
            ,plt.duty_reasons
            ,plt.parcel_created_at
            ,plt.source
            ,plt.operator_id
            ,plt.updated_at
            ,ddd.CN_element
            ,pr.store_id
            ,pr.routed_at
            ,row_number() over (partition by plt.pno order by pr.routed_at desc ) rk
        from ph_bi.parcel_lose_task plt
        left join `ph_bi`.`translations` t on plt.duty_reasons = t.t_key AND t.`lang` = 'zh-CN'
        left join ph_staging.parcel_route pr on pr.pno = plt.pno and pr.routed_at > date_sub(plt.updated_at, interval 8 hour)
        join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
        where
            plt.state = 6
            and plt.duty_result = 1
            and plt.updated_at >= '2023-07-20'
            and plt.updated_at < '2023-07-30'
    ) a
left join ph_bi.translations t2 on t2.t_key = a.duty_reasons and  t2.lang ='zh-CN'
left join ph_bi.translations t3 on t3.t_key = a.duty_reasons and  t3.lang ='en'
left join ph_staging.sys_store ss on ss.id = a.store_id
left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = a.operator_id
left join ph_bi.parcel_lose_responsible plr on plr.lose_task_id = a.id
left join ph_staging.sys_store ss2 on ss2.id = plr.store_id
where
    a.rk = 1
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    a.pno
    ,concat(t2.t_value, t3.t_value) 判责原因duty_reasons
    ,a.parcel_created_at 揽收时间receive_time
    ,a.CN_element 最后有效路由last_effective_route
    ,convert_tz(a.routed_at, '+00:00', '+08:00') 最后有效路由时间last_effective_route_time
    ,ss.name 最后有效路由操作网点operate_network_for_last_effective_route
    ,case a.source
        WHEN 1 THEN 'A-问题件-丢失'
        WHEN 2 THEN 'B-记录本-丢失'
        WHEN 3 THEN 'C-包裹状态未更新'
        WHEN 4 THEN 'D-问题件-破损/短少'
        WHEN 5 THEN 'E-记录本-索赔-丢失'
        WHEN 6 THEN 'F-记录本-索赔-破损/短少'
        WHEN 7 THEN 'G-记录本-索赔-其他'
        WHEN 8 THEN 'H-包裹状态未更新-IPC计数'
        WHEN 9 THEN 'I-问题件-外包装破损险'
        WHEN 10 THEN 'J-问题记录本-外包装破损险'
        when 11 then 'K-超时效包裹'
        when 12 then 'L-高度疑似丢失'
    end 问题来源渠道source_of_problem
    ,concat('(', hsi.staff_info_id, ')', hsi.name) 处理人handler
    ,a.updated_at 处理时间process_time
    ,group_concat(distinct ss2.name) 责任网点duty_branch
from
    (
        select
            plt.pno
            ,plt.id
            ,plt.duty_result
            ,plt.duty_reasons
            ,plt.parcel_created_at
            ,plt.source
            ,plt.operator_id
            ,plt.updated_at
            ,ddd.CN_element
            ,pr.store_id
            ,pr.routed_at
            ,row_number() over (partition by plt.pno order by pr.routed_at desc ) rk
        from ph_bi.parcel_lose_task plt
        left join `ph_bi`.`translations` t on plt.duty_reasons = t.t_key AND t.`lang` = 'zh-CN'
        left join ph_staging.parcel_route pr on pr.pno = plt.pno and pr.routed_at > date_sub(plt.updated_at, interval 8 hour)
        join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
        where
            plt.state = 6
            and plt.duty_result = 1
            and plt.updated_at >= '2023-07-20'
            and plt.updated_at < '2023-07-30'
    ) a
left join ph_bi.translations t2 on t2.t_key = a.duty_reasons and  t2.lang ='zh-CN'
left join ph_bi.translations t3 on t3.t_key = a.duty_reasons and  t3.lang ='en'
left join ph_staging.sys_store ss on ss.id = a.store_id
left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = a.operator_id
left join ph_bi.parcel_lose_responsible plr on plr.lose_task_id = a.id
left join ph_staging.sys_store ss2 on ss2.id = plr.store_id
where
    a.rk = 1
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    a.pno
    ,concat(t2.t_value, t3.t_value) 判责原因duty_reasons
    ,a.parcel_created_at 揽收时间receive_time
    ,concat(a.CN_element, a.EN_element) 最后有效路由last_effective_route
    ,convert_tz(a.routed_at, '+00:00', '+08:00') 最后有效路由时间last_effective_route_time
    ,ss.name 最后有效路由操作网点operate_network_for_last_effective_route
    ,case a.source
        WHEN 1 THEN 'A-问题件-丢失'
        WHEN 2 THEN 'B-记录本-丢失'
        WHEN 3 THEN 'C-包裹状态未更新'
        WHEN 4 THEN 'D-问题件-破损/短少'
        WHEN 5 THEN 'E-记录本-索赔-丢失'
        WHEN 6 THEN 'F-记录本-索赔-破损/短少'
        WHEN 7 THEN 'G-记录本-索赔-其他'
        WHEN 8 THEN 'H-包裹状态未更新-IPC计数'
        WHEN 9 THEN 'I-问题件-外包装破损险'
        WHEN 10 THEN 'J-问题记录本-外包装破损险'
        when 11 then 'K-超时效包裹'
        when 12 then 'L-高度疑似丢失'
    end 问题来源渠道source_of_problem
    ,concat('(', hsi.staff_info_id, ')', hsi.name) 处理人handler
    ,a.updated_at 处理时间process_time
    ,group_concat(distinct ss2.name) 责任网点duty_branch
from
    (
        select
            plt.pno
            ,plt.id
            ,plt.duty_result
            ,plt.duty_reasons
            ,plt.parcel_created_at
            ,plt.source
            ,plt.operator_id
            ,plt.updated_at
            ,ddd.CN_element
            ,ddd.EN_element
            ,pr.store_id
            ,pr.routed_at
            ,row_number() over (partition by plt.pno order by pr.routed_at desc ) rk
        from ph_bi.parcel_lose_task plt
        left join `ph_bi`.`translations` t on plt.duty_reasons = t.t_key AND t.`lang` = 'zh-CN'
        left join ph_staging.parcel_route pr on pr.pno = plt.pno and pr.routed_at > date_sub(plt.updated_at, interval 8 hour)
        join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
        where
            plt.state = 6
            and plt.duty_result = 1
            and plt.updated_at >= '2023-07-20'
            and plt.updated_at < '2023-07-30'
    ) a
left join ph_bi.translations t2 on t2.t_key = a.duty_reasons and  t2.lang ='zh-CN'
left join ph_bi.translations t3 on t3.t_key = a.duty_reasons and  t3.lang ='en'
left join ph_staging.sys_store ss on ss.id = a.store_id
left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = a.operator_id
left join ph_bi.parcel_lose_responsible plr on plr.lose_task_id = a.id
left join ph_staging.sys_store ss2 on ss2.id = plr.store_id
where
    a.rk = 1
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    a.pno
    ,concat(t2.t_value, t3.t_value) 判责原因duty_reasons
    ,a.parcel_created_at 揽收时间receive_time
    ,concat(a.CN_element, a.route_action) 最后有效路由last_effective_route
    ,convert_tz(a.routed_at, '+00:00', '+08:00') 最后有效路由时间last_effective_route_time
    ,ss.name 最后有效路由操作网点operate_network_for_last_effective_route
    ,case a.source
        WHEN 1 THEN 'A-问题件-丢失'
        WHEN 2 THEN 'B-记录本-丢失'
        WHEN 3 THEN 'C-包裹状态未更新'
        WHEN 4 THEN 'D-问题件-破损/短少'
        WHEN 5 THEN 'E-记录本-索赔-丢失'
        WHEN 6 THEN 'F-记录本-索赔-破损/短少'
        WHEN 7 THEN 'G-记录本-索赔-其他'
        WHEN 8 THEN 'H-包裹状态未更新-IPC计数'
        WHEN 9 THEN 'I-问题件-外包装破损险'
        WHEN 10 THEN 'J-问题记录本-外包装破损险'
        when 11 then 'K-超时效包裹'
        when 12 then 'L-高度疑似丢失'
    end 问题来源渠道source_of_problem
    ,concat('(', hsi.staff_info_id, ')', hsi.name) 处理人handler
    ,a.updated_at 处理时间process_time
    ,group_concat(distinct ss2.name) 责任网点duty_branch
from
    (
        select
            plt.pno
            ,plt.id
            ,plt.duty_result
            ,plt.duty_reasons
            ,plt.parcel_created_at
            ,plt.source
            ,plt.operator_id
            ,plt.updated_at
            ,ddd.CN_element
            ,pr.route_action
            ,pr.store_id
            ,pr.routed_at
            ,row_number() over (partition by plt.pno order by pr.routed_at desc ) rk
        from ph_bi.parcel_lose_task plt
        left join `ph_bi`.`translations` t on plt.duty_reasons = t.t_key AND t.`lang` = 'zh-CN'
        left join ph_staging.parcel_route pr on pr.pno = plt.pno and pr.routed_at > date_sub(plt.updated_at, interval 8 hour)
        join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
        where
            plt.state = 6
            and plt.duty_result = 1
            and plt.updated_at >= '2023-07-20'
            and plt.updated_at < '2023-07-30'
    ) a
left join ph_bi.translations t2 on t2.t_key = a.duty_reasons and  t2.lang ='zh-CN'
left join ph_bi.translations t3 on t3.t_key = a.duty_reasons and  t3.lang ='en'
left join ph_staging.sys_store ss on ss.id = a.store_id
left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = a.operator_id
left join ph_bi.parcel_lose_responsible plr on plr.lose_task_id = a.id
left join ph_staging.sys_store ss2 on ss2.id = plr.store_id
where
    a.rk = 1
group by 1;
;-- -. . -..- - / . -. - .-. -.--
with d as
(
    select
         ds.store_id
        ,ds.pno
        ,ds.stat_date
    from ph_bi.dc_should_delivery_today ds
    where
        ds.stat_date >= '2023-08-03'
        and ds.stat_date <= '2023-08-03'
        and ds.arrival_scan_route_at < concat(ds.stat_date, ' 09:00:00')
)
, t as
(
    select
         ds.store_id
        ,ds.pno
        ,ds.stat_date
    from d ds
    left join
        (
            select
                pr.pno
                ,ds.stat_date
                ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
            from ph_staging.parcel_route pr
            join d ds on pr.pno = ds.pno
            where 1=1
                and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                and pr.route_action = 'DETAIN_WAREHOUSE'
                and pr.marker_category in (42,43) ##岛屿,偏远地区
            group by 1,2
        ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
    left join
        (
            select
               pr.pno
                ,ds.stat_date
               ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
               ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
            from ph_staging.parcel_route pr
            join d ds on ds.pno = pr.pno
            where 1=1
                and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                and pr.route_action = 'DETAIN_WAREHOUSE'
                and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                and pr.marker_category in (9,14,70) ##客户改约时间
        ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
    left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
    where
        case
            when pr1.pno is not null then 'N'
            when pr2.pno is not null then 'N'
            when ds1.pno is not null  then 'N'  else 'Y'
        end = 'Y'
)
select
    a.stat_date 日期
    ,a.store_id 网点ID
    ,dp.store_name 网点名称
    ,dp.opening_at 开业时间
    ,case
        when dp.region_name in ('Area3', 'Area6') then '彭万松'
        when dp.region_name in ('Area4', 'Area9') then '韩钥'
        when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
        when dp.region_name in ( 'Area8') then '黄勇'
        when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
    end 区域
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,a.应交接
    ,a.已交接
    ,concat(round(a.交接率*100,2),'%') as 交接率
    ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
    ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
    ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
    ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
    ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
from
    (
        select
            t1.store_id
            ,t1.stat_date
            ,count(t1.pno) 应交接
            ,count(if(sc.pno is not null , t1.pno, null)) 已交接
            ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
            ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
            ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
            ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
            ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

            ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
            ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
            ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
            ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
        from t t1
        left join
            (
                select
                    sc.*
                from
                    (
                        select
                            pr.pno
                            ,pr.store_id
                            ,pr.store_name
                            ,t1.stat_date
                            ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                            ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                            ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                        from ph_staging.parcel_route pr
                        join t t1 on t1.pno = pr.pno
                        where
                            pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                           and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                          and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                    ) sc
                where
                    sc.rk = 1
            ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
        group by 1,2
    ) a
join
    (
        select
            sd.store_id
        from ph_staging.sys_district sd
        where
            sd.deleted = 0
            and sd.store_id is not null
        group by 1

        union all

        select
            sd.separation_store_id store_id
        from ph_staging.sys_district sd
        where
            sd.deleted = 0
            and sd.separation_store_id is not null
        group by 1
    ) sd on sd.store_id = a.store_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
where
    dp.store_category in (1,10,13);
;-- -. . -..- - / . -. - .-. -.--
with d as
(
    select
         ds.store_id
        ,ds.pno
        ,ds.stat_date
    from ph_bi.dc_should_delivery_today ds
    where
        ds.stat_date >= '2023-08-03'
        and ds.stat_date <= '2023-08-03'
        and ds.arrival_scan_route_at < concat(ds.stat_date, ' 09:00:00')
)
, t as
(
    select
         ds.store_id
        ,ds.pno
        ,ds.stat_date
    from d ds
    left join
        (
            select
                pr.pno
                ,ds.stat_date
                ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
            from ph_staging.parcel_route pr
            join d ds on pr.pno = ds.pno
            where 1=1
                and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                and pr.route_action = 'DETAIN_WAREHOUSE'
                and pr.marker_category in (42,43) ##岛屿,偏远地区
            group by 1,2
        ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
    left join
        (
            select
               pr.pno
                ,ds.stat_date
               ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
               ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
            from ph_staging.parcel_route pr
            join d ds on ds.pno = pr.pno
            where 1=1
                and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                and pr.route_action = 'DETAIN_WAREHOUSE'
                and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                and pr.marker_category in (9,14,70) ##客户改约时间
        ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
    left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
    where
        case
            when pr1.pno is not null then 'N'
            when pr2.pno is not null then 'N'
            when ds1.pno is not null  then 'N'  else 'Y'
        end = 'Y'
)
, b as
(

        select
            a.stat_date 日期
            ,a.store_id 网点ID
            ,dp.store_name 网点名称
            ,case
                when dp.region_name in ('Area3', 'Area6') then '彭万松'
                when dp.region_name in ('Area4', 'Area9') then '韩钥'
                when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
                when dp.region_name in ( 'Area8') then '黄勇'
                when dp.region_name in ('Area1', 'Area2','Area5', 'Area12', 'Area13') then '李俊'
            end 区域
            ,dp.region_name 大区
            ,dp.piece_name 片区
            ,a.应交接
            ,a.已交接
            ,concat(round(a.交接率*100,2),'%') as 交接率
            ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
            ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
            ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
            ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
            ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
        from
            (
                select
                    t1.store_id
                    ,t1.stat_date
                    ,count(t1.pno) 应交接
                    ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                    ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                    ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                    ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                    ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                    ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                    ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                    ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                    ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                    ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
                from t t1
                left join
                    (
                        select
                            sc.*
                        from
                            (
                                select
                                    pr.pno
                                    ,pr.store_id
                                    ,pr.store_name
                                    ,t1.stat_date
                                    ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                    ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                    ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                                from ph_staging.parcel_route pr
                                join t t1 on t1.pno = pr.pno
                                where
                                    pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                                   and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                                  and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                            ) sc
                        where
                            sc.rk = 1
                    ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
                group by 1,2
            ) a
        join
            (
                select
                    sd.store_id
                from ph_staging.sys_district sd
                where
                    sd.deleted = 0
                    and sd.store_id is not null
                group by 1

                union all

                select
                    sd.separation_store_id store_id
                from ph_staging.sys_district sd
                where
                    sd.deleted = 0
                    and sd.separation_store_id is not null
                group by 1
            ) sd on sd.store_id = a.store_id
        left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
        where
            dp.store_category in (1,10,13)
)
select
    t1.日期
    ,t1.区域
    ,t1.交接评级
    ,t1.store_num 网点数
    ,t1.store_num/t2.store_num 网点占比
from
    (
        select
            b1.日期
            ,b1.区域
            ,b1.交接评级
            ,count(b1.网点ID) store_num
        from b b1
        group by 1,2,3
    ) t1
left join
    (
        select
            b1.日期
            ,b1.区域
            ,count(b1.网点ID) store_num
        from b b1
        group by 1,2
    ) t2 on t2.区域 = t1.区域 and  t2.日期 = t1.日期

union all

select
    t1.日期
    , 'Grand Total' 区域
    ,t1.交接评级
    ,t1.store_num 网点数
    ,t1.store_num/t2.store_num 网点占比
from
    (
        select
            b1.日期
            ,b1.交接评级
            ,count(b1.网点ID) store_num
        from b b1
        group by 1,2
    ) t1
left join
    (
        select
            b1.日期
            ,count(b1.网点ID) store_num
        from b b1
        group by 1
    ) t2 on  t2.日期 = t1.日期;
;-- -. . -..- - / . -. - .-. -.--
with d as
(
    select
         ds.store_id
        ,ds.pno
        ,ds.stat_date
    from ph_bi.dc_should_delivery_today ds
    where
        ds.stat_date >= '2023-08-03'
        and ds.stat_date <= '2023-08-03'
        and ds.arrival_scan_route_at < concat(ds.stat_date, ' 09:00:00')
)
, t as
(
    select
         ds.store_id
        ,ds.pno
        ,ds.stat_date
    from d ds
    left join
        (
            select
                pr.pno
                ,ds.stat_date
                ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
            from ph_staging.parcel_route pr
            join d ds on pr.pno = ds.pno
            where 1=1
                and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                and pr.route_action = 'DETAIN_WAREHOUSE'
                and pr.marker_category in (42,43) ##岛屿,偏远地区
            group by 1,2
        ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
    left join
        (
            select
               pr.pno
                ,ds.stat_date
               ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
               ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
            from ph_staging.parcel_route pr
            join d ds on ds.pno = pr.pno
            where 1=1
                and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                and pr.route_action = 'DETAIN_WAREHOUSE'
                and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                and pr.marker_category in (9,14,70) ##客户改约时间
        ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
    left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
    where
        case
            when pr1.pno is not null then 'N'
            when pr2.pno is not null then 'N'
            when ds1.pno is not null  then 'N'  else 'Y'
        end = 'Y'
)
, b as
(

        select
            a.stat_date 日期
            ,a.store_id 网点ID
            ,dp.store_name 网点名称
            ,case
                when dp.region_name in ('Area3', 'Area6') then '彭万松'
                when dp.region_name in ('Area4', 'Area9') then '韩钥'
                when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
                when dp.region_name in ( 'Area8') then '黄勇'
                when dp.region_name in ('Area1', 'Area2','Area5', 'Area12', 'Area13') then '李俊'
            end 区域
            ,dp.region_name 大区
            ,dp.piece_name 片区
            ,a.应交接
            ,a.已交接
            ,concat(round(a.交接率*100,2),'%') as 交接率
            ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
            ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
            ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
            ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
            ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
        from
            (
                select
                    t1.store_id
                    ,t1.stat_date
                    ,count(t1.pno) 应交接
                    ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                    ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                    ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                    ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                    ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                    ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                    ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                    ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                    ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                    ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
                from t t1
                left join
                    (
                        select
                            sc.*
                        from
                            (
                                select
                                    pr.pno
                                    ,pr.store_id
                                    ,pr.store_name
                                    ,t1.stat_date
                                    ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                    ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                    ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                                from ph_staging.parcel_route pr
                                join t t1 on t1.pno = pr.pno
                                where
                                    pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                                   and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                                  and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                            ) sc
                        where
                            sc.rk = 1
                    ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
                group by 1,2
            ) a
        join
            (
                select
                    sd.store_id
                from ph_staging.sys_district sd
                where
                    sd.deleted = 0
                    and sd.store_id is not null
                group by 1

                union all

                select
                    sd.separation_store_id store_id
                from ph_staging.sys_district sd
                where
                    sd.deleted = 0
                    and sd.separation_store_id is not null
                group by 1
            ) sd on sd.store_id = a.store_id
        left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
        where
            dp.store_category in (1,10,13)
)
select
    t1.日期
    ,t1.大区
    ,t1.区域
    ,t1.交接评级
    ,t1.store_num 网点数
    ,t1.store_num/t2.store_num 网点占比
from
    (
        select
            b1.日期
            ,b1.区域
            ,b1.大区
            ,b1.交接评级
            ,count(b1.网点ID) store_num
        from b b1
        group by 1,2,3,4
    ) t1
left join
    (
        select
            b1.日期
            ,b1.区域
            ,b1.大区
            ,count(b1.网点ID) store_num
        from b b1
        group by 1,2,3
    ) t2 on t2.区域 = t1.区域 and t2.大区 = t1.大区 and t2.日期 = t1.日期;
;-- -. . -..- - / . -. - .-. -.--
select
    vrv.visit_state
from nl_production.violation_return_visit vrv
group by 1;
;-- -. . -..- - / . -. - .-. -.--
SELECT
swrd.`统计日期` 统计日期date
,swrd.`staff_info_id` staff_info_id
,swrd.`员工手机号` 员工手机号employee_contact_number
,swrd.`工龄` 工龄length_of_service
,swrd.`当日岗位` 当日岗位position

,ss.name 原网点original_DC
,smr.name 原网点所属大区
,smp.name 原网点所属片区

,swrd.`当日所属网点` 当日所属网点DC_where_the_courier_stay_at_on_that_day
,swrd.`网点类型` 网点类型DC_type
,swrd.`大区` 大区Area
,swrd.`片区` 片区district


,case swrd.`员工属性`
    when '自有员工' then '自有员工 in house courier'
    when '支援员工' then '支援员工 support courier'
    when '外协员工' then '外协员工 outsource courier'
end 员工属性employee_type


,CONCAT(swa.shift_start,"-",swa.shift_end) 考勤时间attendance_record_time
,swa.shift_start  班次开始时间
,swa.shift_end    班次结束时间

,jr.上班打卡时间
,jr.下班打卡时间
,jr.打卡时长
,case when jr.上班打卡时间 > swa.shift_start then '迟到' else '未迟到' end as 是否迟到

,date_format(ft.arrive_time_first,'%Y-%m-%d %H:%i') as 正班车第一趟到达时间
,date_format(ft.arrive_time_last,'%Y-%m-%d %H:%i') as  正班车最后一趟到达时间

,swrd.`最早交接时间` 最早交接时间earlist_handover_time
,swrd.`最近交接时间` 最近交接时间latest_handover_time
,round(timestampdiff(second,jr.上班打卡时间,swrd.最早交接时间) / 60,2) 时长上班_首次交接
,swrd.`最早派件时间` 最早派件时间earlist_successfully_delivered_time
,swrd.`最近派件时间` 最近派件时间latest_successfully_delivered_time
,case when swrd.`最近交接时间` < swrd.`最早派件时间` then '否' else '是' end as 首次妥投之后是否有二次交接


,swrd.`揽件量` 揽件量pickup_volume
,case when  jr.ids is null then 0 else jr.ids end 当日揽收任务

##,jr.delivery_pno 交接量liuxia
##,jr.大件数量 交接大件数量
##,jr.大件占比 交接大件占比
##,jr.小件数量 交接小件数量
##,jr.小件占比 交接小件占比


,nwrd.当日应派  as 网点当日应派包裹量
,nwrd.当日到件入仓量
,nwrd.当日应派交接 as 网点当日应派交接包裹量
,nwrd.当日应派妥投 as 网点当日应派妥投包裹量
,nwrd.应派交接率   as 网点当日应派交接率
,nwrd.妥投率      as 网点当日应派妥投率
,nwrd.积压量
,nwrd.未交接量
,a.avg_decnt 网点人均可交接量

,case when yp.应派 is null then 0 else  yp.应派 end '网点应派量'
,case when yp.今日妥投量 is null then 0 else  yp.今日妥投量 end '网点妥投量'
,case when yp.网点交接包裹量 is null then 0 else  yp.网点交接包裹量 end '网点交接量'
,yp.应派 - yp.网点交接包裹量 网点应派未交接包裹量
,case when yp.网点交接率 is null then 0 else  yp.网点交接率 end '网点应派交接率'
,round((if(yp.今日妥投量 is null,0,yp.今日妥投量)/if(yp.应派 is null,0,yp.应派)),2) 网点应派妥投率

,jc.今日首次妥投时间
,jc.今日倒数第二次妥投时间
,case when jc.今日派件时长 is null then 0 else jc.今日派件时长 end 今日派件时长

,jr.first_pickup_time 第一件揽收时间
,tt.个人妥投量 as 个人妥投量

,swrd.`交接量` 交接量handover_volume
,area_delivery.交接区域数量 交接区域数量number_of_handover_area
,area_delivery.交接情况 交接情况handover_area_details

,sdbsi.三段码绑定数量 三段码绑定数量three_segment_code_binding_quantity
,sdbsi.三段码绑定情况 三段码绑定情况three_segment_code_binding_details
,sdbsi.barangay绑定数量 barangay绑定数量barangay_binding_quantity
,sdbsi.绑定明细情况 绑定明细情况barangay_binding_details

,swrd.`当天派件数` 妥投量successfully_delivered
,area_delivery.妥投区域数量 妥投区域数量number_of_areas_in_where_contains_successfully_delivered_parcels
,area_delivery.妥投情况 妥投情况successfully_delivered_details


,swrd.`拒收包裹数` 拒收包裹数number_of_reject
,swrd.`运力不足包裹数` 运力不足包裹数number_of_manpower_shortage
,swrd.`改约包裹数` 改约包裹数number_of_reschedule
,swrd.`联系不上包裹数` 联系不上包裹数number_of_unable_to_contact_consignee

,swrd.`派件间隔(分钟)` '派件间隔(分钟)time_interval_of_deliveries(min)'
,swrd.`派件/交接` '派件/交接delivered/handovered'
,swrd.`5KG以上` '5KG以上above_5KG'



,swrd.`派件工作时间` 派件时长delivering_time_period

,swrd.`最早揽件时间` 最早揽件时间earliest_pickup_time
,swrd.`最近揽件时间` 最近揽件时间latest_pickup_time
,swrd.`揽件工作时间` 揽件时长picking_up_time_period
,swrd.`网点当日派件人数` 网点当日派件人数number_of_couriers_who_do_delivery
,swrd.`人效排名` 人效排名rank_of_human_efficiency

,case when swrd.网点类型 = 'SP' and swrd.员工属性 in ('自有员工','支援员工') and swrd.当日岗位 in ('Bike','VAN','Boat','Tricycle') and ifnull(swrd.交接量,0) < 40 then '交接不达标 handover volume does not reach the standard' end 交接不达标handover_volume_does_not_reach_the_standard
,case when swrd.网点类型 = 'SP' and swrd.员工属性 in ('自有员工','支援员工') and swrd.当日岗位 in ('Bike','VAN','Boat','Tricycle') and ifnull(swrd.当天派件数,0) < 30 then '妥投不达标 successfully delivered volume does not reach the standard' end 妥投不达标successfully_delivered_volume_dose_not_reach_the_standard
,CASE WHEN swrd.网点类型 = 'SP' and swrd.员工属性 in ('自有员工','支援员工') and swrd.当日岗位 in ('Bike','VAN','Boat','Tricycle') and ifnull(swrd.当天派件数,0)/nwrd.当日人效<0.8  THEN '相对人效低 relatively low human efficiency' END 相对人效低relatively_low_human_efficiency
,CASE WHEN swrd.网点类型 = 'SP' and swrd.当日岗位 in ('Bike','VAN','Boat','Tricycle') and swrd.最早派件时间 IS NULL AND swrd.当天派件数 > 0 THEN '网点50m范围内派送 delivery mark within 50 meters from DC' END 派件地点作弊嫌疑suspect_fake_delivered_location
,CASE WHEN swrd.网点类型 = 'SP' and swrd.当日岗位 in ('Bike','VAN','Boat','Tricycle') and swrd.交接量>ROUND((nwrd.正式快递员交接量+nwrd.支援交接量)/(nwrd.交接的正式快递员数量+nwrd.交接的支援快递员数量))*3 then '超量交接 excessively handover' end 超量交接作弊嫌疑suspect_fake_excessively_handover_
,case when swrd.网点类型 = 'SP' and swrd.当日岗位 in ('Bike','VAN','Boat','Tricycle') and swrd.当天派件数>ROUND((nwrd.正式快递员派件量+nwrd.支援派件量)/(nwrd.派件的正式快递员数量+nwrd.派件的支援员工数量))*3 THEN '超量妥投 excessively successfully delivered' END 超量妥投作弊嫌疑suspect_fake_excessively_successfully_delivered
,CASE WHEN swrd.网点类型 = 'SP' and swrd.当日岗位 in ('Bike','VAN','Boat','Tricycle') and swrd.派件工作时间<GREATEST (6,nwrd.'正式快递员派送时长/h'*0.8) or swrd.派件工作时间 is null THEN '派件时长短 short delivering time period ' END 派件时长短short_delivering_time_period
,CASE WHEN swrd.网点类型 = 'SP' and swrd.当日岗位 in ('Bike','VAN','Boat','Tricycle') and ((ifnull(swrd.拒收包裹数,0)+ifnull(swrd.运力不足包裹数,0)+ifnull(swrd.改约包裹数,0)+ifnull(swrd.联系不上包裹数,0))>10 OR (ifnull(swrd.拒收包裹数,0)+ifnull(swrd.运力不足包裹数,0)+ifnull(swrd.改约包裹数,0)+ifnull(swrd.联系不上包裹数,0))/swrd.交接量>0.1) THEN '问题件数量多 many problematic parcels' END 问题件数量多many_problematic_parcels
,case when swrd.网点类型 = 'SP' and swrd.当日岗位 in ('Bike','VAN','Boat','Tricycle') and swrd.最早派件时间 > nwrd.最晚出门时间 or swrd.最早派件时间 is null then '出门派件时间晚 late depature for delivery' else null  end 出门派件时间晚late_depature_for_delivery
,case when swrd.网点类型 = 'SP' and swrd.当日岗位 in ('Bike','VAN','Boat','Tricycle') and area_delivery.第二区域交接数 > 3 then '交接区域不规范 non-standard handover as per barangay' end 交接区域不规范non_standard_handover_as_per_barangay
,case when swrd.网点类型 in ('SP','PDC') and swrd.当日岗位 in ('Bike','VAN','Boat','Tricycle') and (sum(ifnull(swrd.揽件量,0)+ifnull(swrd.当天派件数,0)) over(partition by swrd.staff_info_id)) = 0 then '旷工absent' end 旷工嫌疑suspect_absent

,ROUND((nwrd.正式快递员交接量+nwrd.支援交接量)/(nwrd.交接的正式快递员数量+nwrd.交接的支援快递员数量))  `网点自有+支援人均交接average_handover_volume_of_in_house_couriers_and_support_couriers`
,ROUND((nwrd.正式快递员派件量+nwrd.支援派件量)/(nwrd.派件的正式快递员数量+nwrd.派件的支援员工数量))  `网点自有+支援人均妥投average_successfully_delivered__volume_of_in_house_couriers_and_support_couriers`
,ROUND((ifnull(nwrd.正式快递员交接量,0)+ifnull(nwrd.支援交接量,0)+ifnull(nwrd.外协交接量,0))/(ifnull(nwrd.交接的正式快递员数量,0)+ifnull(nwrd.交接的支援快递员数量,0)+ifnull(nwrd.交接的外协快递员数量,0)))  `网点自有+支援+外协人均交接average_handover_volume_of_in_house_couriers,_support_couriers_and_outsource_couriers`
,ROUND((ifnull(nwrd.正式快递员派件量,0)+ifnull(nwrd.支援派件量,0)+ifnull(nwrd.外协派件量,0))/(ifnull(nwrd.派件的正式快递员数量,0)+ifnull(nwrd.派件的支援员工数量,0)+ifnull(nwrd.派件的外协员工数量,0)))  `网点自有+支援+外协人均妥投average_successfully_delivered__volume_of_in_house_couriers,_support_couriers_and_outsource_couriers`

,nwrd.正式快递员出勤标准  网点出勤标准attendance_standar_of_DC
,nwrd.当日人效  `网点当日人效(自有human_efficiency_(in_house_courier))`
,nwrd.'正式快递员派送时长/h'  '网点正式快递员派送时长/h in_house_regular_courier_delivering_time_period/h'
,swrd.`数据更新时间/菲律宾` '数据更新时间/菲律宾update_time/Philippines'

FROM tmpale.staff_work_report_daily swrd ## 快递员每日工作情况播报

LEFT JOIN tmpale.network_work_report_daily nwrd ## 网点每日工作情况播报
on swrd.当日所属网点 = nwrd.网点
and swrd.统计日期 = nwrd.统计日期

left join ph_bi.hr_staff_info hsi ##员工表
on swrd.staff_info_id = hsi.staff_info_id

left join ph_staging.sys_store ss ##网点表
on hsi.sys_store_id = ss.id


left join ph_staging.sys_manage_piece smp ##大区
on smp.id=ss.manage_piece

left join ph_staging.sys_manage_region smr ##片区
on smr.id=ss.manage_region

LEFT JOIN ph_backyard.staff_work_attendance swa ##员工考勤表
ON swa.staff_info_id = swrd.staff_info_id
AND swa.attendance_date = DATE(convert_tz(NOW(),'+08:00','+08:00'))


left join
(# 今日信息
    select
        gr.delivery_at              ##交接时间
        ,gr.staff_info_id           ##工号
        ,gr.delivery_pno            ##交接量
        ,gr.大件数量
        ,gr.大件占比
        ,gr.小件数量
        ,gr.小件占比
        ,rw.ids                     ##揽收任务
        ,pp.pnos                    ##今日个人揽收件量
        ,pp.first_pickup_time       ##第一件揽收时间
        ,ad.上班打卡时间
        ,ad.下班打卡时间
        ,ad.打卡时长

    from
    (#交接
        select  date(convert_tz(dt.delivery_at,'+00:00','+08:00')) as delivery_at##交接时间
            ,dt.`store_id` ##网点编号
            ,ss.`name`     ##网点名称
            ,dt.`staff_info_id`##派件员工号
            ,jt.`job_name` ##职位
            ,COUNT(distinct dt.`pno`)  delivery_pno ##交接量
            ,count(distinct if(pi.`weight`>5000 or pi.`length`+pi.`width`+pi.`height`>80,dt.pno  ,null)) '大件数量'
            ,concat(round(count(distinct if(pi.`weight`>5000 or pi.`length`+pi.`width`+pi.`height`>80,dt.pno  ,null))/count(distinct dt.pno)*100,2),"%")  大件占比
            ,count(distinct if(pi.`weight`>5000 or pi.`length`+pi.`width`+pi.`height`>80,null,dt.pno )) 小件数量
            ,concat(round(count(distinct if(pi.`weight`>5000 or pi.`length`+pi.`width`+pi.`height`>80,null,dt.pno ))/count(distinct dt.pno)*100,2),"%") 小件占比
        from `ph_staging`.`ticket_delivery` dt
        left join `ph_staging`.`parcel_info` pi on dt.`pno` = pi.`pno`
        left join `ph_staging`.`sys_store` ss on dt.`store_id`  = ss.`id`
        LEFT JOIN `ph_bi`.`hr_staff_info`  hr on hr.`staff_info_id` =dt.`staff_info_id`
        LEFT JOIN ph_bi.`hr_job_title` jt on jt.`id` =hr.`job_title`
        where 1=1##date(convert_tz(dt.`delivery_at`,'+00:00','+08:00'))= date_sub(CURRENT_DATE,interval 1 day)
            and  date(convert_tz(dt.`delivery_at`,'+00:00','+08:00'))>='2023-07-17'
            and  date(convert_tz(dt.`delivery_at`,'+00:00','+08:00'))<='2023-07-23'
            and dt.`transfered` = 0
            and dt.`state` in (0,1,2)
        GROUP BY 1,2,3,4,5
    )gr



    left join
    (#揽收
        select
            t2.pickup_dt ##揽收时间
            ,t2.ticket_pickup_staff_info_id
            ,p.first_pickup_time ##首次揽收时间
            ,t2.pnos ##揽收量
        from
            (
            select
                date(convert_tz(pi.created_at,'+00:00','+08:00')) as pickup_dt ##揽收时间
                ,pi.ticket_pickup_staff_info_id ##收件员工工号
                ,COUNT(DISTINCT pi.pno) pnos
            from ph_staging.parcel_info pi
            where ##pi.`state` < 9
                  pi.state <> 9 ##（非无效件）
                  and pi.returned = 0 ##（非退件）
                  ##and date(convert_tz(pi.`created_at`,'+00:00','+08:00')) >=date_sub(CURRENT_DATE,interval 1 day)
                  and date(convert_tz(pi.`created_at`,'+00:00','+08:00')) >= '2023-07-17'
                  and date(convert_tz(pi.`created_at`,'+00:00','+08:00')) <= '2023-07-23'
            group by 1,2
            )t2
            left join
            (#第一件揽收时间
            select t1.ticket_pickup_staff_info_id
                ,t1.created_time as first_pickup_time
                ,date(t1.created_time) as first_pickup_dt ##揽收时间
            from
                (
                select pi.ticket_pickup_staff_info_id ##收件员工工号
                    ,convert_tz(pi.created_at,  '+00:00', '+08:00') created_time
                    ##,min(convert_tz(pi.created_at,  '+00:00', '+08:00')) 第一件揽收时间
                    ,row_number() over (partition by pi.ticket_pickup_staff_info_id,date(convert_tz(pi.created_at,'+00:00','+08:00')) order by convert_tz(pi.created_at,  '+00:00', '+08:00') asc) as rn
                from ph_staging.parcel_info pi
                where ##pi.`state` < 9
                    pi.state <> 9 ##（非无效件）
                    and pi.returned = 0 ##（非退件）
                    ##and date(convert_tz(pi.`created_at`,'+00:00','+08:00')) >=date_sub(CURRENT_DATE,interval 1 day)
                    and date(convert_tz(pi.`created_at`,'+00:00','+08:00'))>='2023-07-17'
                    and date(convert_tz(pi.`created_at`,'+00:00','+08:00'))<='2023-07-23'
                )t1
            where t1.rn = 1
            group by 1,2,3
            )p
            on p.ticket_pickup_staff_info_id=t2.ticket_pickup_staff_info_id and p.first_pickup_dt = t2.pickup_dt
        group by 1,2
    )pp
    on pp.ticket_pickup_staff_info_id = gr.staff_info_id and pp.pickup_dt = gr.delivery_at


    LEFT JOIN
    (#今日揽收任务数
        select
            date(convert_tz(tp.created_at,'+00:00','+08:00')) as created_at##任务创建时间
            ,tp.staff_info_id ##工号
            ,COUNT(tp.id) ids ##揽收任务
        from ph_staging.ticket_pickup tp
        where tp.state =2
            and date(convert_tz(tp.created_at,'+00:00','+08:00'))>='2023-07-17'
            and date(convert_tz(tp.created_at,'+00:00','+08:00'))<='2023-07-23'
    group by 1,2
    ) rw
    on rw.staff_info_id = gr.staff_info_id and gr.delivery_at = rw.created_at

    left join
    (#今日出勤
        select
            date(convert_tz(v.stat_date,'+00:00','+08:00')) as stat_dt ##出勤日期
            ,v.`staff_info_id`
            ,v.`attendance_started_at` 上班打卡时间
            ,v.`attendance_end_at` 下班打卡时间
            ,round(timestampdiff(second,v.`attendance_started_at`,v.`attendance_end_at`) / 3600,2) 打卡时长
        from ph_bi.attendance_data_v2 v
        where ##v.`stat_date`  = date_sub(CURRENT_DATE,interval 1 day)
            date(convert_tz(v.stat_date,'+00:00','+08:00'))>='2023-07-17'
            and date(convert_tz(v.stat_date,'+00:00','+08:00'))<='2023-07-23'
        group by 1,2,3,4,5
      )ad
    on ad.staff_info_id=gr.staff_info_id and gr.delivery_at = ad.stat_dt
) jr
on jr.staff_info_id = swrd.staff_info_id and jr.delivery_at = swrd.统计日期

left join
(#今日工作时长
select dc.`staff_info_id`
     ,dc.`store_id`
     ,ss.name
     ,dc.finished_at ##工作日期
     ,round(dc.`duration` / 3600,2) 今日派件时长
     ,dc.`first_delivery_finish_time` 今日首次妥投时间
     ,dc.stat_end 今日倒数第二次妥投时间
from ph_bi.delivery_count_staff dc
left join ph_staging.sys_store ss on dc.`store_id` = ss.`id`
where 1=1##dc.finished_at =date_sub(CURRENT_DATE,interval 1 day)
and dc.finished_at >= '2023-07-17'
and dc.finished_at <='2023-07-23'
and dc.duration <> 0
group by 1,2,3,4,5,6,7
) jc
on jc.staff_info_id = swrd.staff_info_id and jc.finished_at = swrd.统计日期 and swrd.`当日所属网点`  = jc.name

LEFT JOIN
( #今日应派妥投
    select dc.store_id,ss.name,
        date(convert_tz(dc.stat_date,'+00:00','+08:00')) stat_date,
        count(distinct dc.pno) 应派,
        COUNT(DISTINCT(if(date(convert_tz(pi.`finished_at`,"+00:00" ,"+08:00"))= dc.stat_date,dc.`pno` ,null))) 今日妥投量,
        COUNT(distinct if(td.`pno` is not null,dc.pno,null))网点交接包裹量  ,
        round(COUNT(distinct if(td.`pno` is not null,dc.pno,null))/count(distinct dc.pno),2) 网点交接率,
        concat(round(count(distinct if(pi.`weight`>5000 or pi.`length`+pi.`width`+pi.`height`>80,dc.pno  ,null))/count(distinct dc.pno)*100,2),"%")  大件占比
    from ph_bi.dc_should_delivery_today dc
    left join ph_staging.sys_store ss on dc.`store_id` = ss.`id`
    LEFT JOIN ph_staging.parcel_info  pi on dc.`pno` =pi.`pno`
    left join ph_staging.ticket_delivery td
    on td.pno =dc.pno and date(convert_tz(td.delivery_at ,"+00:00","+08:00"))= date(convert_tz(dc.stat_date,'+00:00','+08:00')) and td.`state` in (0,1,2)
    where ##dc.stat_date = date_sub(CURRENT_DATE,interval 1 day)
        date(convert_tz(dc.stat_date,'+00:00','+08:00'))>='2023-07-17'##妥投时间
        and date(convert_tz(dc.stat_date,'+00:00','+08:00'))<='2023-07-23'
        and dc.state<6
    group by 1,2,3
) yp
on yp.name = swrd.`当日所属网点` and yp.stat_date = swrd.统计日期

LEFT JOIN
( #今日妥投
    select date(convert_tz(pi.`finished_at`,'+00:00','+08:00')) as finished_at##日期
        ,pi.`ticket_delivery_staff_info_id`
        ,ss.name
        ,COUNT(DISTINCT pi.`pno`) 个人妥投量
    from ph_staging.parcel_info pi
    LEFT JOIN `ph_bi`.`hr_staff_info`  hr on hr.`staff_info_id` =pi.`ticket_delivery_staff_info_id`
    left join `ph_staging`.`sys_store` ss on hr.`sys_store_id`  = ss.`id`
    where pi.`state` =5
    ##and date(convert_tz(pi.`finished_at`,"+00:00","+08:00"))=date_sub(CURRENT_DATE,interval 1 day)
    and date(convert_tz(pi.`finished_at`,'+00:00','+08:00'))>='2023-07-17'##妥投时间
    and date(convert_tz(pi.`finished_at`,'+00:00','+08:00'))<='2023-07-23'
    GROUP by 1,2,3
) tt
on tt.ticket_delivery_staff_info_id=swrd.staff_info_id and tt.finished_at=swrd.统计日期 and tt.name = swrd.`当日所属网点`

left join
(#网点人均可交接
    select
        date(dc.stat_date) stat_date
        ,dc.store_id
        ,ss.name
        ,COUNT(distinct dc.`pno`)  cnt
        ,round(COUNT(distinct dc.`pno`)/count(distinct td.`staff_info_id` ) ,0) avg_decnt
    FROM dwm.dwd_ph_dc_should_delivery_d dc
    left join `ph_staging`.`ticket_delivery` td
    on td.`pno` =dc.`pno` and dc.`stat_date` =date(convert_tz(td.`delivery_at`,"+00:00","+08:00")) and td.`state`in (0,1,2)
    left join ph_bi.`sys_store` ss on ss.`id` =dc.`store_id`
    where ##dc.`stat_date` =date_sub(CURRENT_DATE ,interval 1 day)
        date(dc.stat_date) >='2023-07-17'
        and date(dc.stat_date) <='2023-07-23'
        and ss.`category` =1
        and dc.`state` <6
    GROUP BY 1,2,3
)a
on a.name = swrd.`当日所属网点` and a.stat_date=swrd.统计日期


left join
(
##网点正班车到达时间
select date(ft.real_arrive_time) as proof_dt##日期
    ,ft.next_store_id
    ,ft.next_store_name
    ,ft11.real_arrive_time as arrive_time_first##正班车第一趟到达时间
    ,ft22.real_arrive_time as arrive_time_last##正班车最后一趟到达时间

from ph_bi.fleet_time ft

left join
(##最早到达时间
    select ft1.next_store_id
        ,ft1.next_store_name
        ,ft1.real_arrive_time
        ,ft1.proof_id
        ,ft1.rn
    from
    (
        select next_store_id
            ,next_store_name
            ,real_arrive_time
            ,proof_id
            ,row_number() over (partition by date(real_arrive_time),next_store_id order by real_arrive_time asc) as rn
        from ph_bi.fleet_time
        where 1=1
            and line_mode =1
            and arrive_type in ('3','5')
            and fleet_status in ('1')
            and date(real_arrive_time) >='2023-07-17'
            and date(real_arrive_time) <='2023-07-23'
    )ft1
    where rn = 1
)ft11
on ft.proof_id = ft11.proof_id
left join (
    ##最晚到达时间
    select ft2.next_store_id
        ,ft2.next_store_name
        ,ft2.real_arrive_time
        ,ft2.proof_id
        ,ft2.rn
    from (
        select next_store_id
            ,next_store_name
            ,real_arrive_time
            ,proof_id
            ,row_number() over (partition by date(real_arrive_time),next_store_id order by real_arrive_time desc) as rn
        from ph_bi.fleet_time
        where 1=1
            and line_mode =1
            and arrive_type in ('3','5')
            and fleet_status in ('1')
            and date(real_arrive_time) >='2023-07-17'
            and date(real_arrive_time) <='2023-07-23'
    )ft2
    where rn = 1
)ft22
on ft.proof_id = ft22.proof_id
where 1=1
    and date(ft.real_arrive_time) >='2023-07-17'
    and date(ft.real_arrive_time) <='2023-07-23'
    and ft11.real_arrive_time is not null
    and ft22.real_arrive_time is not null
group by 1,2,3,4,5
)ft
##日期+网点关联
on ft.next_store_name = swrd.当日所属网点  and ft.proof_dt = swrd.统计日期

left join # 快递员绑定情况

(
    select
    t.store_id
    ,t.name
    ,t.staff_info_id
    ,count(distinct t.delivery_code) 三段码绑定数量
    ,group_concat(distinct t.delivery_code SEPARATOR ' / ') 三段码绑定情况
    ,count(distinct t.district_code) barangay绑定数量
    ,group_concat(concat(t.delivery_code,':',t.barangay_name) order by t.delivery_code SEPARATOR ' / ') 绑定明细情况
    from
    (
        select
        sdbsi.store_id # 网点id
        ,ss.name # 网点名称
        ,sdbsi.staff_info_id # 员工id
        ,sdbsi.delivery_code # 绑定的三段码
        ,sdbsi.district_code # 绑定的barangayID
        ,sd.name barangay_name # 绑定的barangay名称
        from ph_staging.store_delivery_barangay_staff_info sdbsi
        left join ph_staging.sys_district sd
        on sdbsi.district_code  = sd.code
        left join ph_staging.sys_store ss
        on sdbsi.store_id  = ss.id
        where 1=1
        and sdbsi.deleted = 0 # 非剔除记录
        and ss.category  = 1 # SP网点
        group by 1,2,3,4,5,6
    )t
    group by 1,2,3
) sdbsi
on sdbsi.store_id = ss.id
and sdbsi.staff_info_id = swrd.staff_info_id

left join

(
    select
    t1.大区
    ,t1.片区
    ,t1.分拣大区
    ,t1.网点名称
    ,t1.tiktok_area
    ,t1.lazada_area
    ,t1.shopee_area
    ,t1.快递员姓名
    ,t1.员工ID
    ,t1.快递员职位
    ,t1.交接区域数量
    ,t1.交接数
    ,t1.第二区域交接数
    ,t1.交接情况
    ,t2.妥投区域数量
    ,t2.妥投数
    ,t2.妥投情况
    from
    (
        select
        tt.大区
        ,tt.片区
        ,tt.分拣大区
        ,tt.网点名称
        ,tt.tiktok_area
        ,tt.lazada_area
        ,tt.shopee_area
        ,tt.快递员姓名
        ,tt.员工ID
        ,tt.快递员职位
        ,count(distinct tt.三段码) 交接区域数量
        ,sum(tt.交接包裹数) 交接数
        ,group_concat(concat(tt.三段码,':',tt.交接包裹数,'(',tt.当日在仓,')') order by tt.交接包裹数 desc SEPARATOR ' / ') 交接情况
        ,tt.第二区域交接数
        from
        (
            select
            mr.name `大区`
            ,mp.name `片区`
            ,ssd.sorting_no `分拣大区`
            ,ssd.name `网点名称`
            ,tiktok_area.area_name tiktok_area
            ,lazada_area.area_name lazada_area
            ,case shopee_area.area_id when 1 then 'MM'  when 2 then 'GMA '  when 3 then 'Luz 1'  when 4 then 'Luz 2'  when 5 then 'Luz 3' when 6 then 'Vis 1'  when 7 then 'Vis 2'  when 8 then 'Min 1'  when 9 then 'Min 2'  when 10 then 'Luz 4' end as shopee_area
            ,hsi.name `快递员姓名`
            ,td.staff_info_id `员工ID`
            ,if(hsi.job_title = 13,'BIKE',if(hsi.job_title = 110,'VAN',if(hsi.job_title = 452,'BOAT',if(hsi.job_title = 1000,'Tricycle','other')))) `快递员职位`
            ,ddpsci.third_sorting_code `三段码`
            ,sdmzc.当日在仓
            ,count(distinct td.pno) `交接包裹数`
            ,nth_value(count(distinct td.pno),2) over(partition by ssd.name,td.staff_info_id order by count(distinct td.pno) desc) 第二区域交接数

            from ph_staging.ticket_delivery td

            join tmpale.parcel_in_warehouse_today dsdt
            on td.pno = dsdt.pno

            left join
            (
                select
                ddpsci.pno
                ,ddpsci.third_sorting_code
                ,row_number() over(partition by ddpsci.pno order by ddpsci.created_at desc) rk
                from ph_drds.parcel_sorting_code_info ddpsci
                where 1=1
                and ddpsci.created_at >= date_sub(current_date(),91)
            ) ddpsci
            on dsdt.pno = ddpsci.pno
            and ddpsci.rk = 1

            left join ph_staging.sys_store ssd
            on dsdt.dst_store_id = ssd.id

            left join dwm.dwd_ph_dict_lazada_period_rules lazada_area
            on ssd.province_code = lazada_area.province_code

            left join ph_staging.shopee_period_limitation_rules_area shopee_area
            on ssd.province_code = shopee_area.province_code

            left join

            (
                select distinct
                tiktok_area.dst_province_code province_code
                ,case tiktok_area.dst_area_code
                when 'MM' then 'MM'
                when 'GMA' then 'GMA'
                when 'LUZON 1' then 'Luz 1'
                when 'LUZON 2' then 'Luz 2'
                when 'LUZON 3' then 'Luz 3'
                when 'LUZON 4' then 'Luz 4'
                when 'MINDANAO 1' then 'Min 1'
                when 'MINDANAO 2' then 'Min 2'
                when 'VISAYAS 1' then 'Vis 1'
                when 'VISAYAS 2' then 'Vis 2'
                end area_name
                from dwm.dwd_ph_dict_tiktok_period_rules tiktok_area
            ) tiktok_area
            on ssd.province_code = tiktok_area.province_code

            LEFT JOIN ph_staging.sys_manage_region mr
            ON ssd.manage_region = mr.id

            LEFT JOIN ph_staging.sys_manage_piece mp
            ON ssd.manage_piece = mp.id

            left join ph_bi.hr_staff_info hsi
            on td.staff_info_id = hsi.staff_info_id

            left join
            (#网点各三段码在仓、已交接、积压
            SELECT
            dsdt.stat_date
            ,ssd.id `store_id`
            ,ssd.name `网点名称`
            ,ddpsci.third_sorting_code `区域编码`

            ,count(dsdt.pno) '当日在仓'
            ,count(case when dsdt.is_handover = 1 then dsdt.pno else null end)  `已交接量`
            ,count(case when dsdt.state not in ('已签收','疑难件','已退件','异常关闭') then dsdt.pno else null end) `积压件量`

            FROM tmpale.parcel_in_warehouse_today dsdt

            left join ph_staging.parcel_info pi
            on dsdt.pno = pi.pno

            left join
            (
                select
                ddpsci.pno
                ,ddpsci.third_sorting_code
                ,row_number() over(partition by ddpsci.pno order by ddpsci.created_at desc) rk
                from ph_drds.parcel_sorting_code_info ddpsci
                where 1=1
                and ddpsci.created_at >= date_sub(current_date(),91)
            ) ddpsci
            on pi.pno = ddpsci.pno
            and ddpsci.rk = 1

            left join ph_staging.sys_store ssd
            on dsdt.dst_store_id = ssd.id

            where 1=1
            and dsdt.stat_date = date_sub(current_date(),0)
            and ssd.category in ('1','10')
            GROUP BY 1,2,3,4
            order by 1,2,3,4
            )sdmzc
            on sdmzc.网点名称 = ssd.name
            and sdmzc.区域编码 = ddpsci.third_sorting_code

            where 1=1
            and td.created_at >= convert_tz(date_sub(curdate(),0),'+08:00','+00:00')
            and td.state <> 3
            group by 1,2,3,4,5,6,7,8,9,10,11,12
        ) tt
        group by 1,2,3,4,5,6,7,8,9,10
    ) t1

    left join

    (
        select
        tt.大区
        ,tt.片区
        ,tt.分拣大区
        ,tt.网点名称
        ,tt.tiktok_area
        ,tt.lazada_area
        ,tt.shopee_area
        ,tt.快递员姓名
        ,tt.员工ID
        ,tt.快递员职位
        ,count(distinct tt.三段码) 妥投区域数量
        ,sum(tt.妥投包裹数) 妥投数
        ,group_concat(concat(tt.三段码,':',tt.妥投包裹数) order by tt.妥投包裹数 desc SEPARATOR ' / ') 妥投情况
        from
        (
            select
            mr.name `大区`
            ,mp.name `片区`
            ,ssd.sorting_no `分拣大区`
            ,ssd.name `网点名称`
            ,tiktok_area.area_name tiktok_area
            ,lazada_area.area_name lazada_area
            ,case shopee_area.area_id when 1 then 'MM'  when 2 then 'GMA '  when 3 then 'Luz 1'  when 4 then 'Luz 2'  when 5 then 'Luz 3' when 6 then 'Vis 1'  when 7 then 'Vis 2'  when 8 then 'Min 1'  when 9 then 'Min 2'  when 10 then 'Luz 4' end as shopee_area
            ,hsi.name `快递员姓名`
            ,pi.ticket_delivery_staff_info_id `员工ID`
            ,if(hsi.job_title = 13,'BIKE',if(hsi.job_title = 110,'VAN',if(hsi.job_title = 452,'BOAT',if(hsi.job_title = 1000,'Tricycle','other')))) `快递员职位`
            ,ddpsci.third_sorting_code `三段码`
            ,count(distinct pi.pno) `妥投包裹数`

            from ph_staging.parcel_info pi

            join tmpale.parcel_in_warehouse_today dsdt
            on pi.pno = dsdt.pno

            left join
            (
                select
                ddpsci.pno
                ,ddpsci.third_sorting_code
                ,row_number() over(partition by ddpsci.pno order by ddpsci.created_at desc) rk
                from ph_drds.parcel_sorting_code_info ddpsci
                where 1=1
                and ddpsci.created_at >= date_sub(current_date(),91)
            ) ddpsci
            on dsdt.pno = ddpsci.pno
            and ddpsci.rk = 1

            left join ph_staging.sys_store ssd
            on dsdt.dst_store_id = ssd.id

            left join dwm.dwd_ph_dict_lazada_period_rules lazada_area
            on ssd.province_code = lazada_area.province_code

            left join ph_staging.shopee_period_limitation_rules_area shopee_area
            on ssd.province_code = shopee_area.province_code

            left join

            (
                select distinct
                tiktok_area.dst_province_code province_code
                ,case tiktok_area.dst_area_code
                when 'MM' then 'MM'
                when 'GMA' then 'GMA'
                when 'LUZON 1' then 'Luz 1'
                when 'LUZON 2' then 'Luz 2'
                when 'LUZON 3' then 'Luz 3'
                when 'LUZON 4' then 'Luz 4'
                when 'MINDANAO 1' then 'Min 1'
                when 'MINDANAO 2' then 'Min 2'
                when 'VISAYAS 1' then 'Vis 1'
                when 'VISAYAS 2' then 'Vis 2'
                end area_name
                from dwm.dwd_ph_dict_tiktok_period_rules tiktok_area
            ) tiktok_area
            on ssd.province_code = tiktok_area.province_code

            LEFT JOIN ph_staging.sys_manage_region mr
            ON ssd.manage_region = mr.id

            LEFT JOIN ph_staging.sys_manage_piece mp
            ON ssd.manage_piece = mp.id

            left join ph_bi.hr_staff_info hsi
            on pi.ticket_delivery_staff_info_id = hsi.staff_info_id

            where 1=1
            and pi.finished_at >= convert_tz(date_sub(curdate(),0),'+08:00','+00:00')
            group by 1,2,3,4,5,6,7,8,9,10,11
        ) tt
        group by 1,2,3,4,5,6,7,8,9,10
    ) t2

    on t1.网点名称 = t2.网点名称
    and t1.员工ID = t2.员工ID
) area_delivery
on swrd.当日所属网点 = area_delivery.网点名称
and swrd.staff_info_id = area_delivery.员工ID
WHERE ##swrd.统计日期 = DATE(convert_tz(NOW(),'+08:00','+08:00'));
date(convert_tz(swrd.统计日期,'+00:00','+08:00'))>='2023-07-17'
and date(convert_tz(swrd.统计日期,'+00:00','+08:00'))<='2023-07-23';
;-- -. . -..- - / . -. - .-. -.--
select
    tpor.ticket_pickup_id
    ,tpor.order_id
from ph_staging.ticket_pickup_order_relation tpor
where
    tpor.ticket_pickup_id in ('29126285','29121838','29131167','29130236','29095321','29127602','29077557','29126223','29077854','29074434','29123379','29077729','29121708','29117787','29121628','29103463','29112111','29101772','29131844','29073578','29116943','29073455','29074366','29077924','29121798','29073920','29073621','29078454','29077904','29127796','29130022','29126340','29073606','29073324','29126426','29110007','29127391','29077777','29126415','29132045','29077426','29069934','29121640','29076988','29077629','29077376','29127449','29077720','29077745','29074215','29074150','29074273','29121712','29074415','29073998','29076714','29074465','29126296','29078262','29131956','29121813','29132085','29116955','29073349','29112317','29131671','29112166','29076603','29121715','29078189','29076736','29073991','29121614','29074409','29069589','29074109','29077782','29074421','29077780','29078074','29126177','29126319','29131989','29073739','29074103','29121689','29131937','29077956','29073832','29126215','29116959','29074110','29074029','29116885','29096533','29132015','29125046','29121779','29076627','29131658','29073815','29101604','29126367','29077034','29126217','29073937','29074418','29122502','29077211','29077831','29132089','29074518','29073550','29081160','29121690','29073924','29076382','29112156','29073483','29078237','29121661','29077927','29074405','29130028','29131959','29118441','29078414','29073821','29122650','29126289','29101733','29073356','29096402','29126372','29131059','29078369','29109141','29092840','29074214','29120764','29074003','29112311','29094975','29095852','29116823','29074206','29116913','29073802','29101329','29073333','29077286','29118438','29126201','29107743','29076997','29076685','29077231','29077388','29132036','29073635','29073965','29132201','29074510','29126298','29073722','29076250','29117986','29074043','29077599','29073546','29077322','29112167');
;-- -. . -..- - / . -. - .-. -.--
select
    tpor.ticket_pickup_id
    ,tpor.order_id
from ph_staging.ticket_pickup_order_relation tpor
where
    tpor.ticket_pickup_id in ('29077218','29123218','29079966','29078289','29078039','29123513','29078163','29092256','29081310','29127773','29077277','29092979','29082994','29127349','29076982','29094196','29132084','29112272','29127351','29107560','29078028','29091333','29130168','29077683','29079108','29127807','29077703','29126509','29113681','29103145','29090986','29077836','29113148','29077308','29121625','29127713','29109168','29129982','29118014','29082311','29076801','29077880','29077671','29127420','29077130','29103182','29096049','29085349','29093378','29092180','29103151','29126611','29121773','29093526','29092824','29118457','29117949','29079220','29091616','29076529','29107985','29077217','29086623','29112436','29093696','29094564','29127387','29095388','29127223','29093312','29077333','29129991','29082150','29082418','29102822','29078442','29112276','29091143','29130176','29118387','29122819','29103130','29092393','29078169','29122153','29077653','29130065','29121752','29078302','29076288','29082720','29075866','29077346','29132178','29082401','29116833','29127700','29123201','29117994','29109160','29085240','29113463','29123113','29107892','29108594','29092299','29077207','29079091','29093686','29121723','29109605','29077154','29092683','29130031','29094652','29076442','29127042','29113792','29076540','29082800','29127398','29122487','29118569','29077204','29126337','29122881','29076303','29121740','29091788','29092146','29103093','29121706','29118658','29122052','29113448','29127892','29116813','29093360','29081527','29118772','29118412','29131869','29121702','29130089','29077305','29077032','29112290','29127556','29103194','29079361','29103150','29096577','29078517','29116830','29102684','29132113','29076051','29090307','29102638','29117941','29094540','29118872','29109063','29112736','29123112','29117928','29091268','29127445','29076052','29077091','29091747','29083165','29077725','29103146','29123117','29130037','29083521','29102812','29121763','29109038','29078004','29086386','29126521','29078474','29116838','29127758','29121725','29093171','29121953','29091247','29126403','29117520','29103077','29122599','29093792','29117918','29093913','29107601','29127359','29077157','29126492','29123254','29117944','29130171','29077583','29127326','29123253','29123118','29117857','29082349','29081704','29117868','29107615','29126707','29126349','29118760','29127355','29127560','29092690','29131898','29092536','29116947','29126274','29118385','29108554','29112617','29126580','29122862','29089915','29094223','29076491','29118575','29127410','29127393','29109192','29127347','29122542','29078469','29117476','29072948','29107511');
;-- -. . -..- - / . -. - .-. -.--
select
    tpor.ticket_pickup_id
    ,oi.pno
from ph_staging.ticket_pickup_order_relation tpor
left join ph_staging.order_info oi on oi.id = tpor.order_id
where
    tpor.ticket_pickup_id in ('29126285','29121838','29131167','29130236','29095321','29127602','29077557','29126223','29077854','29074434','29123379','29077729','29121708','29117787','29121628','29103463','29112111','29101772','29131844','29073578','29116943','29073455','29074366','29077924','29121798','29073920','29073621','29078454','29077904','29127796','29130022','29126340','29073606','29073324','29126426','29110007','29127391','29077777','29126415','29132045','29077426','29069934','29121640','29076988','29077629','29077376','29127449','29077720','29077745','29074215','29074150','29074273','29121712','29074415','29073998','29076714','29074465','29126296','29078262','29131956','29121813','29132085','29116955','29073349','29112317','29131671','29112166','29076603','29121715','29078189','29076736','29073991','29121614','29074409','29069589','29074109','29077782','29074421','29077780','29078074','29126177','29126319','29131989','29073739','29074103','29121689','29131937','29077956','29073832','29126215','29116959','29074110','29074029','29116885','29096533','29132015','29125046','29121779','29076627','29131658','29073815','29101604','29126367','29077034','29126217','29073937','29074418','29122502','29077211','29077831','29132089','29074518','29073550','29081160','29121690','29073924','29076382','29112156','29073483','29078237','29121661','29077927','29074405','29130028','29131959','29118441','29078414','29073821','29122650','29126289','29101733','29073356','29096402','29126372','29131059','29078369','29109141','29092840','29074214','29120764','29074003','29112311','29094975','29095852','29116823','29074206','29116913','29073802','29101329','29073333','29077286','29118438','29126201','29107743','29076997','29076685','29077231','29077388','29132036','29073635','29073965','29132201','29074510','29126298','29073722','29076250','29117986','29074043','29077599','29073546','29077322','29112167');
;-- -. . -..- - / . -. - .-. -.--
select
    tpor.ticket_pickup_id
    ,oi.pno
from ph_staging.ticket_pickup_order_relation tpor
left join ph_staging.order_info oi on oi.id = tpor.order_id
where
    tpor.ticket_pickup_id in ('29077218','29123218','29079966','29078289','29078039','29123513','29078163','29092256','29081310','29127773','29077277','29092979','29082994','29127349','29076982','29094196','29132084','29112272','29127351','29107560','29078028','29091333','29130168','29077683','29079108','29127807','29077703','29126509','29113681','29103145','29090986','29077836','29113148','29077308','29121625','29127713','29109168','29129982','29118014','29082311','29076801','29077880','29077671','29127420','29077130','29103182','29096049','29085349','29093378','29092180','29103151','29126611','29121773','29093526','29092824','29118457','29117949','29079220','29091616','29076529','29107985','29077217','29086623','29112436','29093696','29094564','29127387','29095388','29127223','29093312','29077333','29129991','29082150','29082418','29102822','29078442','29112276','29091143','29130176','29118387','29122819','29103130','29092393','29078169','29122153','29077653','29130065','29121752','29078302','29076288','29082720','29075866','29077346','29132178','29082401','29116833','29127700','29123201','29117994','29109160','29085240','29113463','29123113','29107892','29108594','29092299','29077207','29079091','29093686','29121723','29109605','29077154','29092683','29130031','29094652','29076442','29127042','29113792','29076540','29082800','29127398','29122487','29118569','29077204','29126337','29122881','29076303','29121740','29091788','29092146','29103093','29121706','29118658','29122052','29113448','29127892','29116813','29093360','29081527','29118772','29118412','29131869','29121702','29130089','29077305','29077032','29112290','29127556','29103194','29079361','29103150','29096577','29078517','29116830','29102684','29132113','29076051','29090307','29102638','29117941','29094540','29118872','29109063','29112736','29123112','29117928','29091268','29127445','29076052','29077091','29091747','29083165','29077725','29103146','29123117','29130037','29083521','29102812','29121763','29109038','29078004','29086386','29126521','29078474','29116838','29127758','29121725','29093171','29121953','29091247','29126403','29117520','29103077','29122599','29093792','29117918','29093913','29107601','29127359','29077157','29126492','29123254','29117944','29130171','29077583','29127326','29123253','29123118','29117857','29082349','29081704','29117868','29107615','29126707','29126349','29118760','29127355','29127560','29092690','29131898','29092536','29116947','29126274','29118385','29108554','29112617','29126580','29122862','29089915','29094223','29076491','29118575','29127410','29127393','29109192','29127347','29122542','29078469','29117476','29072948','29107511');
;-- -. . -..- - / . -. - .-. -.--
select
    oi.pno
    ,group_concat(tpor.ticket_pickup_id) 任务id
    ,count(tpor.ticket_pickup_id)  任务数
from ph_staging.ticket_pickup_order_relation tpor
left join ph_staging.order_info oi on oi.id = tpor.order_id
where
    tpor.ticket_pickup_id in ('29126285','29121838','29131167','29130236','29095321','29127602','29077557','29126223','29077854','29074434','29123379','29077729','29121708','29117787','29121628','29103463','29112111','29101772','29131844','29073578','29116943','29073455','29074366','29077924','29121798','29073920','29073621','29078454','29077904','29127796','29130022','29126340','29073606','29073324','29126426','29110007','29127391','29077777','29126415','29132045','29077426','29069934','29121640','29076988','29077629','29077376','29127449','29077720','29077745','29074215','29074150','29074273','29121712','29074415','29073998','29076714','29074465','29126296','29078262','29131956','29121813','29132085','29116955','29073349','29112317','29131671','29112166','29076603','29121715','29078189','29076736','29073991','29121614','29074409','29069589','29074109','29077782','29074421','29077780','29078074','29126177','29126319','29131989','29073739','29074103','29121689','29131937','29077956','29073832','29126215','29116959','29074110','29074029','29116885','29096533','29132015','29125046','29121779','29076627','29131658','29073815','29101604','29126367','29077034','29126217','29073937','29074418','29122502','29077211','29077831','29132089','29074518','29073550','29081160','29121690','29073924','29076382','29112156','29073483','29078237','29121661','29077927','29074405','29130028','29131959','29118441','29078414','29073821','29122650','29126289','29101733','29073356','29096402','29126372','29131059','29078369','29109141','29092840','29074214','29120764','29074003','29112311','29094975','29095852','29116823','29074206','29116913','29073802','29101329','29073333','29077286','29118438','29126201','29107743','29076997','29076685','29077231','29077388','29132036','29073635','29073965','29132201','29074510','29126298','29073722','29076250','29117986','29074043','29077599','29073546','29077322','29112167')
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    oi.pno
    ,group_concat(tpor.ticket_pickup_id) 任务id
    ,count(tpor.ticket_pickup_id)  任务数
from ph_staging.ticket_pickup_order_relation tpor
left join ph_staging.order_info oi on oi.id = tpor.order_id
where
    tpor.ticket_pickup_id in ('29077218','29123218','29079966','29078289','29078039','29123513','29078163','29092256','29081310','29127773','29077277','29092979','29082994','29127349','29076982','29094196','29132084','29112272','29127351','29107560','29078028','29091333','29130168','29077683','29079108','29127807','29077703','29126509','29113681','29103145','29090986','29077836','29113148','29077308','29121625','29127713','29109168','29129982','29118014','29082311','29076801','29077880','29077671','29127420','29077130','29103182','29096049','29085349','29093378','29092180','29103151','29126611','29121773','29093526','29092824','29118457','29117949','29079220','29091616','29076529','29107985','29077217','29086623','29112436','29093696','29094564','29127387','29095388','29127223','29093312','29077333','29129991','29082150','29082418','29102822','29078442','29112276','29091143','29130176','29118387','29122819','29103130','29092393','29078169','29122153','29077653','29130065','29121752','29078302','29076288','29082720','29075866','29077346','29132178','29082401','29116833','29127700','29123201','29117994','29109160','29085240','29113463','29123113','29107892','29108594','29092299','29077207','29079091','29093686','29121723','29109605','29077154','29092683','29130031','29094652','29076442','29127042','29113792','29076540','29082800','29127398','29122487','29118569','29077204','29126337','29122881','29076303','29121740','29091788','29092146','29103093','29121706','29118658','29122052','29113448','29127892','29116813','29093360','29081527','29118772','29118412','29131869','29121702','29130089','29077305','29077032','29112290','29127556','29103194','29079361','29103150','29096577','29078517','29116830','29102684','29132113','29076051','29090307','29102638','29117941','29094540','29118872','29109063','29112736','29123112','29117928','29091268','29127445','29076052','29077091','29091747','29083165','29077725','29103146','29123117','29130037','29083521','29102812','29121763','29109038','29078004','29086386','29126521','29078474','29116838','29127758','29121725','29093171','29121953','29091247','29126403','29117520','29103077','29122599','29093792','29117918','29093913','29107601','29127359','29077157','29126492','29123254','29117944','29130171','29077583','29127326','29123253','29123118','29117857','29082349','29081704','29117868','29107615','29126707','29126349','29118760','29127355','29127560','29092690','29131898','29092536','29116947','29126274','29118385','29108554','29112617','29126580','29122862','29089915','29094223','29076491','29118575','29127410','29127393','29109192','29127347','29122542','29078469','29117476','29072948','29107511')
group by 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
            oi.pno
            ,tpor.order_id
        from ph_staging.ticket_pickup_order_relation tpor
        left join ph_staging.order_info oi on oi.id = tpor.order_id
        where
            tpor.ticket_pickup_id in ('29126285','29121838','29131167','29130236','29095321','29127602','29077557','29126223','29077854','29074434','29123379','29077729','29121708','29117787','29121628','29103463','29112111','29101772','29131844','29073578','29116943','29073455','29074366','29077924','29121798','29073920','29073621','29078454','29077904','29127796','29130022','29126340','29073606','29073324','29126426','29110007','29127391','29077777','29126415','29132045','29077426','29069934','29121640','29076988','29077629','29077376','29127449','29077720','29077745','29074215','29074150','29074273','29121712','29074415','29073998','29076714','29074465','29126296','29078262','29131956','29121813','29132085','29116955','29073349','29112317','29131671','29112166','29076603','29121715','29078189','29076736','29073991','29121614','29074409','29069589','29074109','29077782','29074421','29077780','29078074','29126177','29126319','29131989','29073739','29074103','29121689','29131937','29077956','29073832','29126215','29116959','29074110','29074029','29116885','29096533','29132015','29125046','29121779','29076627','29131658','29073815','29101604','29126367','29077034','29126217','29073937','29074418','29122502','29077211','29077831','29132089','29074518','29073550','29081160','29121690','29073924','29076382','29112156','29073483','29078237','29121661','29077927','29074405','29130028','29131959','29118441','29078414','29073821','29122650','29126289','29101733','29073356','29096402','29126372','29131059','29078369','29109141','29092840','29074214','29120764','29074003','29112311','29094975','29095852','29116823','29074206','29116913','29073802','29101329','29073333','29077286','29118438','29126201','29107743','29076997','29076685','29077231','29077388','29132036','29073635','29073965','29132201','29074510','29126298','29073722','29076250','29117986','29074043','29077599','29073546','29077322','29112167')
        group by 1
)
select
    t1.pno
    ,group_concat(tp.id) 任务
    ,count(distinct tp.id)  任务数
from t t1
left join ph_staging.ticket_pickup_order_relation tpor2 on tpor2.order_id = t1.order_id
join ph_staging.ticket_pickup tp on tp.id= tpor2.ticket_pickup_id and tp.transfer_ancestry is null
where
    tp.created_at >= '2023-08-01 16:00:00'
    and tp.created_at < '2023-08-02 16:00:00'
group by 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
            oi.pno
            ,tpor.order_id
        from ph_staging.ticket_pickup_order_relation tpor
        left join ph_staging.order_info oi on oi.id = tpor.order_id
        where
            tpor.ticket_pickup_id in ('29077218','29123218','29079966','29078289','29078039','29123513','29078163','29092256','29081310','29127773','29077277','29092979','29082994','29127349','29076982','29094196','29132084','29112272','29127351','29107560','29078028','29091333','29130168','29077683','29079108','29127807','29077703','29126509','29113681','29103145','29090986','29077836','29113148','29077308','29121625','29127713','29109168','29129982','29118014','29082311','29076801','29077880','29077671','29127420','29077130','29103182','29096049','29085349','29093378','29092180','29103151','29126611','29121773','29093526','29092824','29118457','29117949','29079220','29091616','29076529','29107985','29077217','29086623','29112436','29093696','29094564','29127387','29095388','29127223','29093312','29077333','29129991','29082150','29082418','29102822','29078442','29112276','29091143','29130176','29118387','29122819','29103130','29092393','29078169','29122153','29077653','29130065','29121752','29078302','29076288','29082720','29075866','29077346','29132178','29082401','29116833','29127700','29123201','29117994','29109160','29085240','29113463','29123113','29107892','29108594','29092299','29077207','29079091','29093686','29121723','29109605','29077154','29092683','29130031','29094652','29076442','29127042','29113792','29076540','29082800','29127398','29122487','29118569','29077204','29126337','29122881','29076303','29121740','29091788','29092146','29103093','29121706','29118658','29122052','29113448','29127892','29116813','29093360','29081527','29118772','29118412','29131869','29121702','29130089','29077305','29077032','29112290','29127556','29103194','29079361','29103150','29096577','29078517','29116830','29102684','29132113','29076051','29090307','29102638','29117941','29094540','29118872','29109063','29112736','29123112','29117928','29091268','29127445','29076052','29077091','29091747','29083165','29077725','29103146','29123117','29130037','29083521','29102812','29121763','29109038','29078004','29086386','29126521','29078474','29116838','29127758','29121725','29093171','29121953','29091247','29126403','29117520','29103077','29122599','29093792','29117918','29093913','29107601','29127359','29077157','29126492','29123254','29117944','29130171','29077583','29127326','29123253','29123118','29117857','29082349','29081704','29117868','29107615','29126707','29126349','29118760','29127355','29127560','29092690','29131898','29092536','29116947','29126274','29118385','29108554','29112617','29126580','29122862','29089915','29094223','29076491','29118575','29127410','29127393','29109192','29127347','29122542','29078469','29117476','29072948','29107511')
        group by 1
)
select
    t1.pno
    ,group_concat(tp.id) 任务
    ,count(distinct tp.id)  任务数
from t t1
left join ph_staging.ticket_pickup_order_relation tpor2 on tpor2.order_id = t1.order_id
join ph_staging.ticket_pickup tp on tp.id= tpor2.ticket_pickup_id and tp.transfer_ancestry is null
where
    tp.created_at >= '2023-08-01 16:00:00'
    and tp.created_at < '2023-08-02 16:00:00'
group by 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.CT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < curdate()
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,dp.opening_at 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end store_level
    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub(curdate(), interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-08-04'
        and pr.routed_at >= date_sub('2023-08-04', interval 8 hour )
        and pr.routed_at < date_add('2023-08-04', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id = 'PH61060300'
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,dr.opening_at 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,emp_cnt.staf_num 总快递员人数_在职
        ,a3.self_staff_num 自有快递员出勤数
        ,a3.other_staff_num '外协+支援快递员出勤数'

        ,a3.avg_scan_num 平均交接量
        ,a3.avg_del_num 平均妥投量
        ,sdb.code_num 网点三段码数量

        ,a3.dco_dcs_num 仓管主管_出勤数
        ,a3.dco_dcs_avg_scan 仓管主管_平均交接量
        ,a2.self_avg_staff_code 自有快递员三段码平均交接量
        ,a2.other_avg_staff_code 其他快递员三段码平均交接量
        ,a2.self_avg_staff_del_code 自有快递员三段码平均妥投量
        ,a2.other_avg_staff_del_code 其他快递员三段码平均妥投量
        ,a2.avg_code_staff 三段码平均交接快递员数
        ,case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end 评级
        ,a2.code_num
        ,a2.staff_code_num
        ,a2.staff_num
        ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-08-04'
        and pr.routed_at >= date_sub('2023-08-04', interval 8 hour )
        and pr.routed_at < date_add('2023-08-04', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id = 'PH61060300'
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,emp_cnt.staf_num 总快递员人数_在职
        ,a3.self_staff_num 自有快递员出勤数
        ,a3.other_staff_num '外协+支援快递员出勤数'
        ,a3.dco_dcs_num 仓管主管_出勤数

        ,a3.avg_scan_num 快递员平均交接量
        ,a3.avg_del_num 快递员平均妥投量
        ,a3.dco_dcs_avg_scan 仓管主管_平均交接量

        ,sdb.code_num 网点三段码数量
        ,a2.self_avg_staff_code 自有快递员三段码平均交接量
        ,a2.other_avg_staff_code 其他快递员三段码平均交接量
        ,a2.self_avg_staff_del_code 自有快递员三段码平均妥投量
        ,a2.other_avg_staff_del_code 其他快递员三段码平均妥投量
        ,a2.avg_code_staff 三段码平均交接快递员数
        ,case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end 评级
        ,a2.code_num
        ,a2.staff_code_num
        ,a2.staff_num
        ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-08-04'
        and pr.routed_at >= date_sub('2023-08-04', interval 8 hour )
        and pr.routed_at < date_add('2023-08-04', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id = 'PH61060300'
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量coalesce
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end 评级
        ,a2.code_num
        ,a2.staff_code_num
        ,a2.staff_num
        ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-08-04'
        and pr.routed_at >= date_sub('2023-08-04', interval 8 hour )
        and pr.routed_at < date_add('2023-08-04', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id = 'PH61060300'
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end 评级
        ,a2.code_num
        ,a2.staff_code_num
        ,a2.staff_num
        ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with d as
(
    select
         ds.dst_store_id store_id
        ,ds.pno
        ,ds.p_date stat_date
    from dwm.dwd_ph_dc_should_be_delivery ds
    where
        ds.should_delevry_type = '1派应派包裹'
        and ds.p_date = '2023-08-04'
)
, t as
(
    select
         ds.store_id
        ,ds.pno
        ,ds.stat_date
    from d ds
    left join
        (
            select
                pr.pno
                ,ds.stat_date
                ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
            from ph_staging.parcel_route pr
            join d ds on pr.pno = ds.pno
            where 1=1
                and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                and pr.route_action = 'DETAIN_WAREHOUSE'
                and pr.marker_category in (42,43) ##岛屿,偏远地区
            group by 1,2
        ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
    left join
        (
            select
               pr.pno
                ,ds.stat_date
               ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
               ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
            from ph_staging.parcel_route pr
            join d ds on ds.pno = pr.pno
            where 1=1
                and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                and pr.route_action = 'DETAIN_WAREHOUSE'
                and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                and pr.marker_category in (9,14,70) ##客户改约时间
        ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
    left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
    where
        case
            when pr1.pno is not null then 'N'
            when pr2.pno is not null then 'N'
            when ds1.pno is not null  then 'N'  else 'Y'
        end = 'Y'
)
select
    a.stat_date 日期
    ,a.store_id 网点ID
    ,dp.store_name 网点名称
    ,dp.opening_at 开业时间
    ,case
        when dp.region_name in ('Area3', 'Area6') then '彭万松'
        when dp.region_name in ('Area4', 'Area9') then '韩钥'
        when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
        when dp.region_name in ( 'Area8') then '黄勇'
        when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
    end 区域
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,a.应交接
    ,a.已交接
    ,concat(round(a.交接率*100,2),'%') as 交接率
    ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
    ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
    ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
    ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
    ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
from
    (
        select
            t1.store_id
            ,t1.stat_date
            ,count(t1.pno) 应交接
            ,count(if(sc.pno is not null , t1.pno, null)) 已交接
            ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
            ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
            ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
            ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
            ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

            ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
            ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
            ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
            ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
        from t t1
        left join
            (
                select
                    sc.*
                from
                    (
                        select
                            pr.pno
                            ,pr.store_id
                            ,pr.store_name
                            ,t1.stat_date
                            ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                            ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                            ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                        from ph_staging.parcel_route pr
                        join t t1 on t1.pno = pr.pno
                        where
                            pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                           and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                          and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                    ) sc
                where
                    sc.rk = 1
            ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
        group by 1,2
    ) a
join
    (
        select
            sd.store_id
        from ph_staging.sys_district sd
        where
            sd.deleted = 0
            and sd.store_id is not null
        group by 1

        union all

        select
            sd.separation_store_id store_id
        from ph_staging.sys_district sd
        where
            sd.deleted = 0
            and sd.separation_store_id is not null
        group by 1
    ) sd on sd.store_id = a.store_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
where
    dp.store_category in (1,10,13);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,hsi.store_id hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-04'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-08-04')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-08-04'
        and pi.finished_at >= date_sub('2023-08-04', interval 8 hour )
        and pi.finished_at < date_add('2023-08-04', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_transfer   hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
            and hr.stat_date = '2023-08-04'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-08-04'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
select
    pr.pno
    ,convert_tz(pi.created_at, '+00:00', '+08:00') 揽收时间
    ,pi.cod_amount/100 COD
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
from ph_staging.parcel_route pr
left join ph_staging.parcel_info pi on pi.pno = pr.pno
where
    pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    and pr.staff_info_id = '145395'
    and pr.routed_at >= '2023-07-22 16:00:00'
    and pr.routed_at < '2023-08-04 16:00:00';
;-- -. . -..- - / . -. - .-. -.--
select
    pr.pno
    ,convert_tz(pi.created_at, '+00:00', '+08:00') 揽收时间
    ,pi.cod_amount/100 COD
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
from ph_staging.parcel_route pr
left join ph_staging.parcel_info pi on pi.pno = pr.pno
where
    pr.route_action = 'PRINT'
    and pr.staff_info_id = '148335'
    and pr.routed_at >= '2023-07-10 16:00:00'
    and pr.routed_at < '2023-07-11 16:00:00';
;-- -. . -..- - / . -. - .-. -.--
select
    pr.pno
    ,convert_tz(pi.created_at, '+00:00', '+08:00') 揽收时间
    ,pi.cod_amount/100 COD
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
from ph_staging.parcel_route pr
left join ph_staging.parcel_info pi on pi.pno = pr.pno
where
    pr.route_action = 'PRINTING'
    and pr.staff_info_id = '148335'
    and pr.routed_at >= '2023-07-10 16:00:00'
    and pr.routed_at < '2023-07-11 16:00:00';
;-- -. . -..- - / . -. - .-. -.--
with d as
(
    select
         ds.dst_store_id store_id
        ,ds.pno
        ,ds.p_date stat_date
    from dwm.dwd_ph_dc_should_be_delivery ds
    where
        ds.should_delevry_type = '1派应派包裹'
        and ds.p_date = '2023-08-05'
)
, t as
(
    select
         ds.store_id
        ,ds.pno
        ,ds.stat_date
    from d ds
    left join
        (
            select
                pr.pno
                ,ds.stat_date
                ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
            from ph_staging.parcel_route pr
            join d ds on pr.pno = ds.pno
            where 1=1
                and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                and pr.route_action = 'DETAIN_WAREHOUSE'
                and pr.marker_category in (42,43) ##岛屿,偏远地区
            group by 1,2
        ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
    left join
        (
            select
               pr.pno
                ,ds.stat_date
               ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
               ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
            from ph_staging.parcel_route pr
            join d ds on ds.pno = pr.pno
            where 1=1
                and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                and pr.route_action = 'DETAIN_WAREHOUSE'
                and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                and pr.marker_category in (9,14,70) ##客户改约时间
        ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
    left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
    where
        case
            when pr1.pno is not null then 'N'
            when pr2.pno is not null then 'N'
            when ds1.pno is not null  then 'N'  else 'Y'
        end = 'Y'
)
select
    a.stat_date 日期
    ,a.store_id 网点ID
    ,dp.store_name 网点名称
    ,dp.opening_at 开业时间
    ,case
        when dp.region_name in ('Area3', 'Area6') then '彭万松'
        when dp.region_name in ('Area4', 'Area9') then '韩钥'
        when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
        when dp.region_name in ( 'Area8') then '黄勇'
        when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
    end 区域
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,a.应交接
    ,a.已交接
    ,concat(round(a.交接率*100,2),'%') as 交接率
    ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
    ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
    ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
    ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
    ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
from
    (
        select
            t1.store_id
            ,t1.stat_date
            ,count(t1.pno) 应交接
            ,count(if(sc.pno is not null , t1.pno, null)) 已交接
            ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
            ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
            ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
            ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
            ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

            ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
            ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
            ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
            ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
        from t t1
        left join
            (
                select
                    sc.*
                from
                    (
                        select
                            pr.pno
                            ,pr.store_id
                            ,pr.store_name
                            ,t1.stat_date
                            ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                            ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                            ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                        from ph_staging.parcel_route pr
                        join t t1 on t1.pno = pr.pno
                        where
                            pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                           and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                          and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                    ) sc
                where
                    sc.rk = 1
            ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
        group by 1,2
    ) a
join
    (
        select
            sd.store_id
        from ph_staging.sys_district sd
        where
            sd.deleted = 0
            and sd.store_id is not null
        group by 1

        union all

        select
            sd.separation_store_id store_id
        from ph_staging.sys_district sd
        where
            sd.deleted = 0
            and sd.separation_store_id is not null
        group by 1
    ) sd on sd.store_id = a.store_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
where
    dp.store_category in (1,10,13);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-08-05'
        and pr.routed_at >= date_sub('2023-08-05', interval 8 hour )
        and pr.routed_at < date_add('2023-08-05', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id = 'PH61060300'
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end 评级
        ,a2.code_num
        ,a2.staff_code_num
        ,a2.staff_num
        ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,hsi.store_id hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-05'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-08-05')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-08-05'
        and pi.finished_at >= date_sub('2023-08-05', interval 8 hour )
        and pi.finished_at < date_add('2023-08-05', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_transfer   hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
            and hr.stat_date = '2023-08-05'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-08-05'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.CT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < curdate()
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.CT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < curdate()
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub(curdate(), interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with d as
(
    select
         ds.dst_store_id store_id
        ,ds.pno
        ,ds.p_date stat_date
    from dwm.dwd_ph_dc_should_be_delivery ds
    where
        ds.should_delevry_type = '1派应派包裹'
        and ds.p_date = '2023-08-06'
)
, t as
(
    select
         ds.store_id
        ,ds.pno
        ,ds.stat_date
    from d ds
    left join
        (
            select
                pr.pno
                ,ds.stat_date
                ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
            from ph_staging.parcel_route pr
            join d ds on pr.pno = ds.pno
            where 1=1
                and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                and pr.route_action = 'DETAIN_WAREHOUSE'
                and pr.marker_category in (42,43) ##岛屿,偏远地区
            group by 1,2
        ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
    left join
        (
            select
               pr.pno
                ,ds.stat_date
               ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
               ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
            from ph_staging.parcel_route pr
            join d ds on ds.pno = pr.pno
            where 1=1
                and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                and pr.route_action = 'DETAIN_WAREHOUSE'
                and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                and pr.marker_category in (9,14,70) ##客户改约时间
        ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
    left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
    where
        case
            when pr1.pno is not null then 'N'
            when pr2.pno is not null then 'N'
            when ds1.pno is not null  then 'N'  else 'Y'
        end = 'Y'
)
select
    a.stat_date 日期
    ,a.store_id 网点ID
    ,dp.store_name 网点名称
    ,dp.opening_at 开业时间
    ,case
        when dp.region_name in ('Area3', 'Area6') then '彭万松'
        when dp.region_name in ('Area4', 'Area9') then '韩钥'
        when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
        when dp.region_name in ( 'Area8') then '黄勇'
        when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
    end 区域
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,a.应交接
    ,a.已交接
    ,concat(round(a.交接率*100,2),'%') as 交接率
    ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
    ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
    ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
    ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
    ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
from
    (
        select
            t1.store_id
            ,t1.stat_date
            ,count(t1.pno) 应交接
            ,count(if(sc.pno is not null , t1.pno, null)) 已交接
            ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
            ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
            ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
            ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
            ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

            ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
            ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
            ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
            ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
        from t t1
        left join
            (
                select
                    sc.*
                from
                    (
                        select
                            pr.pno
                            ,pr.store_id
                            ,pr.store_name
                            ,t1.stat_date
                            ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                            ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                            ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                        from ph_staging.parcel_route pr
                        join t t1 on t1.pno = pr.pno
                        where
                            pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                           and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                          and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                    ) sc
                where
                    sc.rk = 1
            ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
        group by 1,2
    ) a
join
    (
        select
            sd.store_id
        from ph_staging.sys_district sd
        where
            sd.deleted = 0
            and sd.store_id is not null
        group by 1

        union all

        select
            sd.separation_store_id store_id
        from ph_staging.sys_district sd
        where
            sd.deleted = 0
            and sd.separation_store_id is not null
        group by 1
    ) sd on sd.store_id = a.store_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
where
    dp.store_category in (1,10,13);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-08-06'
        and pr.routed_at >= date_sub('2023-08-06', interval 8 hour )
        and pr.routed_at < date_add('2023-08-06', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id = 'PH61060300'
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end 评级
        ,a2.code_num
        ,a2.staff_code_num
        ,a2.staff_num
        ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,hsi.store_id hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-06'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-08-06')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-08-06'
        and pi.finished_at >= date_sub('2023-08-06', interval 8 hour )
        and pi.finished_at < date_add('2023-08-06', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_transfer   hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
            and hr.stat_date = '2023-08-06'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-08-06'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,hsi.store_id hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-06'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-08-06')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-08-06'
        and pi.finished_at >= date_sub('2023-08-06', interval 8 hour )
        and pi.finished_at < date_add('2023-08-06', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-08-06'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,hsi.store_id hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-06'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-08-06')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-08-06'
        and pi.finished_at >= date_sub('2023-08-06', interval 8 hour )
        and pi.finished_at < date_add('2023-08-06', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-08-06'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-06'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-08-06')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-08-06'
        and pi.finished_at >= date_sub('2023-08-06', interval 8 hour )
        and pi.finished_at < date_add('2023-08-06', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-08-06'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        pi.pno
        ,pi.state
        ,pi.ticket_pickup_store_id
        ,pi.returned
        ,pi.dst_store_id
        ,pi.client_id
        ,pi.cod_enabled
    from ph_staging.parcel_info pi
    where
        pi.created_at < '2023-07-19 16:00:00'
        and pi.state not in (5,7,8,9)
)
select
    t1.pno
    ,if(t1.returned = 1, '退件', '正向件')  方向
    ,t1.client_id 客户ID
    ,case
        when bc.`client_id` is not null then bc.client_name
        when kp.id is not null and bc.client_id is null then '普通ka'
        when kp.`id` is null then '小c'
    end as 客户类型
    ,case t1.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,case di.diff_marker_category # 疑难原因
        when 1 then '客户不在家/电话无人接听'
        when 2 then '收件人拒收'
        when 3 then '快件分错网点'
        when 4 then '外包装破损'
        when 5 then '货物破损'
        when 6 then '货物短少'
        when 7 then '货物丢失'
        when 8 then '电话联系不上'
        when 9 then '客户改约时间'
        when 10 then '客户不在'
        when 11 then '客户取消任务'
        when 12 then '无人签收'
        when 13 then '客户周末或假期不收货'
        when 14 then '客户改约时间'
        when 15 then '当日运力不足，无法派送'
        when 16 then '联系不上收件人'
        when 17 then '收件人拒收'
        when 18 then '快件分错网点'
        when 19 then '外包装破损'
        when 20 then '货物破损'
        when 21 then '货物短少'
        when 22 then '货物丢失'
        when 23 then '收件人/地址不清晰或不正确'
        when 24 then '收件地址已废弃或不存在'
        when 25 then '收件人电话号码错误'
        when 26 then 'cod金额不正确'
        when 27 then '无实际包裹'
        when 28 then '已妥投未交接'
        when 29 then '收件人电话号码是空号'
        when 30 then '快件分错网点-地址正确'
        when 31 then '快件分错网点-地址错误'
        when 32 then '禁运品'
        when 33 then '严重破损（丢弃）'
        when 34 then '退件两次尝试派送失败'
        when 35 then '不能打开locker'
        when 36 then 'locker不能使用'
        when 37 then '该地址找不到lockerstation'
        when 38 then '一票多件'
        when 39 then '多次尝试派件失败'
        when 40 then '客户不在家/电话无人接听'
        when 41 then '错过班车时间'
        when 42 then '目的地是偏远地区,留仓待次日派送'
        when 43 then '目的地是岛屿,留仓待次日派送'
        when 44 then '企业/机构当天已下班'
        when 45 then '子母件包裹未全部到达网点'
        when 46 then '不可抗力原因留仓(台风)'
        when 47 then '虚假包裹'
        when 48 then '转交FH包裹留仓'
        when 50 then '客户取消寄件'
        when 51 then '信息录入错误'
        when 52 then '客户取消寄件'
        when 53 then 'lazada仓库拒收'
        when 69 then '禁运品'
        when 70 then '客户改约时间'
        when 71 then '当日运力不足，无法派送'
        when 72 then '客户周末或假期不收货'
        when 73 then '收件人/地址不清晰或不正确'
        when 74 then '收件地址已废弃或不存在'
        when 75 then '收件人电话号码错误'
        when 76 then 'cod金额不正确'
        when 77 then '企业/机构当天已下班'
        when 78 then '收件人电话号码是空号'
        when 79 then '快件分错网点-地址错误'
        when 80 then '客户取消任务'
        when 81 then '重复下单'
        when 82 then '已完成揽件'
        when 83 then '联系不上客户'
        when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
        when 85 then '寄件人电话号码是空号'
        when 86 then '包裹不符合揽收条件超大件'
        when 87 then '包裹不符合揽收条件违禁品'
        when 88 then '寄件人地址为岛屿'
        when 89 then '运力短缺，跟客户协商推迟揽收'
        when 90 then '包裹未准备好推迟揽收'
        when 91 then '包裹包装不符合运输标准'
        when 92 then '客户提供的清单里没有此包裹'
        when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
        when 94 then '客户取消寄件/客户实际不想寄此包裹'
        when 95 then '车辆/人力短缺推迟揽收'
        when 96 then '遗漏揽收(已停用)'
        when 97 then '子母件(一个单号多个包裹)'
        when 98 then '地址错误addresserror'
        when 99 then '包裹不符合揽收条件：超大件'
        when 100 then '包裹不符合揽收条件：违禁品'
        when 101 then '包裹包装不符合运输标准'
        when 102 then '包裹未准备好'
        when 103 then '运力短缺，跟客户协商推迟揽收'
        when 104 then '子母件(一个单号多个包裹)'
        when 105 then '破损包裹'
        when 106 then '空包裹'
        when 107 then '不能打开locker(密码错误)'
        when 108 then 'locker不能使用'
        when 109 then 'locker找不到'
        when 110 then '运单号与实际包裹的单号不一致'
        when 111 then 'box客户取消任务'
        when 112 then '不能打开locker(密码错误)'
        when 113 then 'locker不能使用'
        when 114 then 'locker找不到'
        when 115 then '实际重量尺寸大于客户下单的重量尺寸'
        when 116 then '客户仓库关闭'
        when 117 then '客户仓库关闭'
        when 118 then 'SHOPEE订单系统自动关闭'
        when 119 then '客户取消包裹'
        when 121 then '地址错误'
        when 122 then '当日运力不足，无法揽收'
    end as 疑难原因
#     ,case
#         when t1.state = 6 and di.pno is not null then 'KAM/揽件网点未协商'
#         when t1.state = 6 and di.pno is null  then '闪速系统沟通处理中'
#         when t1.state != 6 and plt.pno is not null and plt2.pno is not null then '闪速系统沟通处理中'
#         when plt.pno is null and pct.pno is not null then '闪速超时效理赔未完成'
#         when de.last_store_id = t1.ticket_pickup_store_id and plt2.pno is null then '揽件未发出'
#         when t1.dst_store_id = 'PH19040F05' and plt2.pno is null then '弃件未到拍卖仓'
#         when t1.state != 6 and datediff(now(), convert_tz(pr.routed_at, '+00:00', '+08:00')) > 7 and plt2.pno is not null then 'QAQC无须追责后长期无有效路由'
#         else null
#     end 卡点原因
#     ,de.last_store_name 当前节点
    ,datediff(now(), convert_tz(pr.routed_at, '+00:00', '+08:00')) 最后有效路由距今天数
#     ,de.last_cn_route_action 最新一条有效路由
    ,case pr.route_action # 路由动作
         when 'ACCEPT_PARCEL' then '接件扫描'
         when 'ARRIVAL_GOODS_VAN_CHECK_SCAN' then '车货关联到港'
         when 'ARRIVAL_WAREHOUSE_SCAN' then '到件入仓扫描'
         when 'CANCEL_ARRIVAL_WAREHOUSE_SCAN' then '取消到件入仓扫描'
         when 'CANCEL_PARCEL' then '撤销包裹'
         when 'CANCEL_SHIPMENT_WAREHOUSE' then '取消发件出仓'
         when 'CHANGE_PARCEL_CANCEL' then '修改包裹为撤销'
         when 'CHANGE_PARCEL_CLOSE' then '修改包裹为异常关闭'
         when 'CHANGE_PARCEL_IN_TRANSIT' then '修改包裹为运输中'
         when 'CHANGE_PARCEL_INFO' then '修改包裹信息'
         when 'CHANGE_PARCEL_SIGNED' then '修改包裹为签收'
         when 'CLAIMS_CLOSE' then '理赔关闭'
         when 'CLAIMS_COMPLETE' then '理赔完成'
         when 'CLAIMS_CONTACT' then '已联系客户'
         when 'CLAIMS_TRANSFER_CS' then '转交总部cs处理'
         when 'CLOSE_ORDER' then '关闭订单'
         when 'CONTINUE_TRANSPORT' then '疑难件继续配送'
         when 'CREATE_WORK_ORDER' then '创建工单'
         when 'CUSTOMER_CHANGE_PARCEL_INFO' then '客户修改包裹信息'
         when 'CUSTOMER_OPERATING_RETURN' then '客户操作退回寄件人'
         when 'DELIVERY_CONFIRM' then '确认妥投'
         when 'DELIVERY_MARKER' then '派件标记'
         when 'DELIVERY_PICKUP_STORE_SCAN' then '自提取件扫描'
         when 'DELIVERY_TICKET_CREATION_SCAN' then '交接扫描'
         when 'DELIVERY_TRANSFER' then '派件转单'
         when 'DEPARTURE_GOODS_VAN_CK_SCAN' then '车货关联出港'
         when 'DETAIN_WAREHOUSE' then '货件留仓'
         when 'DIFFICULTY_FINISH_INDEMNITY' then '疑难件支付赔偿'
         when 'DIFFICULTY_HANDOVER' then '疑难件交接'
         when 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE' then '疑难件交接货件留仓'
         when 'DIFFICULTY_RE_TRANSIT' then '疑难件退回区域总部/重启运送'
         when 'DIFFICULTY_RETURN' then '疑难件退回寄件人'
         when 'DIFFICULTY_SEAL' then '集包异常'
         when 'DISCARD_RETURN_BKK' then '丢弃包裹的，换单后寄回BKK'
         when 'DISTRIBUTION_INVENTORY' then '分拨盘库'
         when 'DWS_WEIGHT_IMAGE' then 'DWS复秤照片'
         when 'EXCHANGE_PARCEL' then '换货'
         when 'FAKE_CANCEL_HANDLE' then '虚假撤销判责'
         when 'FLASH_HOME_SCAN' then 'FH交接扫描'
         when 'FORCE_TAKE_PHOTO' then '强制拍照路由'
         when 'HAVE_HAIR_SCAN_NO_TO' then '有发无到'
         when 'HURRY_PARCEL' then '催单'
         when 'INCOMING_CALL' then '来电接听'
         when 'INTERRUPT_PARCEL_AND_RETURN' then '中断运输并退回'
         when 'INVENTORY' then '盘库'
         when 'LOSE_PARCEL_TEAM_OPERATION' then '丢失件团队处理'
         when 'MANUAL_REMARK' then '添加备注'
         when 'MISS_PICKUP_HANDLE' then '漏包裹揽收判责'
         when 'MISSING_PARCEL_SCAN' then '丢失件包裹操作'
         when 'NOTICE_LOST_PARTS_TEAM' then '已通知丢失件团队'
         when 'PARCEL_HEADLESS_CLAIMED' then '无头件包裹已认领'
         when 'PARCEL_HEADLESS_PRINTED' then '无头件包裹已打单'
         when 'PENDING_RETURN' then '待退件'
         when 'PHONE' then '电话联系'
         when 'PICK_UP_STORE' then '待自提取件'
         when 'PICKUP_RETURN_RECEIPT' then '签回单揽收'
         when 'PRINTING' then '打印面单'
         when 'QAQC_OPERATION' then 'QAQC判责'
         when 'RECEIVE_WAREHOUSE_SCAN' then '收件入仓'
         when 'RECEIVED' then '已揽收,初始化动作，实际情况并没有作用'
         when 'REFUND_CONFIRM' then '退件妥投'
         when 'REPAIRED' then '上报问题修复路由'
         when 'REPLACE_PNO' then '换单'
         when 'REPLY_WORK_ORDER' then '回复工单'
         when 'REVISION_TIME' then '改约时间'
         when 'SEAL' then '集包'
         when 'SEAL_NUMBER_CHANGE' then '集包件数变化'
         when 'SHIPMENT_WAREHOUSE_SCAN' then '发件出仓扫描'
         when 'SORTER_WEIGHT_IMAGE' then '分拣机复秤照片'
         when 'SORTING_SCAN' then '分拣扫描'
         when 'STAFF_INFO_UPDATE_WEIGHT' then '快递员修改重量'
         when 'STORE_KEEPER_UPDATE_WEIGHT' then '仓管员复秤'
         when 'STORE_SORTER_UPDATE_WEIGHT' then '分拣机复秤'
         when 'SYSTEM_AUTO_RETURN' then '系统自动退件'
         when 'TAKE_PHOTO' then '异常打单拍照'
         when 'THIRD_EXPRESS_ROUTE' then '第三方公司路由'
         when 'THIRD_PARTY_REASON_DETAIN' then '第三方原因滞留'
         when 'TICKET_WEIGHT_IMAGE' then '揽收称重照片'
         when 'TRANSFER_LOST_PARTS_TEAM' then '已转交丢失件团队'
         when 'TRANSFER_QAQC' then '转交QAQC处理'
         when 'UNSEAL' then '拆包'
         when 'UNSEAL_NO_PARCEL' then '上报包裹不在集包里'
         when 'UNSEAL_NOT_SCANNED' then '集包已拆包，本包裹未被扫描'
         when 'VEHICLE_ACCIDENT_REG' then '车辆车祸登记'
         when 'VEHICLE_ACCIDENT_REGISTRATION' then '车辆车祸登记'
         when 'VEHICLE_WET_DAMAGE_REG' then '车辆湿损登记'
         when 'VEHICLE_WET_DAMAGE_REGISTRATION' then '车辆湿损登记'
        end as 最后一条路由
    ,pr.store_name 最后有效路由动作网点
    ,convert_tz(pr.routed_at ,'+00:00', '+08:00') 最新一条有效路由时间
    ,datediff(now(), de.dst_routed_at) 目的地网点停留时间
    ,de.dst_store 目的地网点
    ,de.src_store 揽收网点
    ,de.pickup_time 揽收时间
    ,de.pick_date 揽收日期
    ,if(hold.pno is not null, 'yes', 'no' ) 是否有holding标记
    ,if(pr3.pno is not null, 'yes', 'no') 是否有待退件标记
    ,td.try_num 尝试派送次数
from t t1
left join ph_staging.ka_profile kp on t1.client_id = kp.id
left join dwm.dwd_dim_bigClient bc on bc.client_id = t1.client_id
left join dwm.dwd_ex_ph_parcel_details de on de.pno = t1.pno
left join
    (
        select
            plt.pno
            ,group_concat(ss.name ) should_do
        from ph_bi.parcel_lose_task plt
        join t t1 on t1.pno = plt.pno
        left join ph_bi.work_order wo on wo.loseparcel_task_id = plt.id
        left join ph_staging.sys_store ss on ss.id = wo.store_id
        where
            plt.state in (3)
            and wo.status in (1,2)
        group by 1

        union  all

        select
            plt.pno
            ,'QAQC' should_do
        from ph_bi.parcel_lose_task plt
        join t t1 on t1.pno = plt.pno
        where
            plt.state in (1,2,4)
    ) plt on plt.pno = t1.pno
left join
    (
        select
            t2.pno
            ,cdt.negotiation_result_category
            ,di.diff_marker_category
            ,case
                when di.diff_marker_category in (20,21)  and cdt.vip_enable = 1 then 'KAM'
                when di.diff_marker_category not in (20,21) and cdt.vip_enable = 1 then 'KAM'
                when di.diff_marker_category not in (20,21) and cdt.vip_enable = 0 then ss2.name
                WHEN di.diff_marker_category in (20,21) and cdt.vip_enable = 0 then ss2.name
            end sh_do
        from ph_staging.diff_info di
        join t t2 on t2.pno = di.pno
        join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
        left join ph_bi.parcel_lose_task plt on plt.source_id = cdt.id
        left join ph_staging.sys_store ss2 on ss2.id = t2.ticket_pickup_store_id
        where
            cdt.negotiation_result_category is null
    ) di on di.pno = t1.pno
left join  
    (
        select
            pr.pno
            ,pr.store_name
            ,pr.routed_at
            ,pr.route_action
            ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
        from  ph_staging.parcel_route pr
        join t t3 on t3.pno = pr.pno
        where
            pr.route_action in ('INVENTORY','RECEIVED' ,'RECEIVE_WAREHOUSE_SCAN', 'SORTING_SCAN', 'DELIVERY_TICKET_CREATION_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SHIPMENT_WAREHOUSE_SCAN', 'DETAIN_WAREHOUSE', 'DELIVERY_CONFIRM', 'DIFFICULTY_HANDOVER', 'DELIVERY_MARKER', 'REPLACE_PNO','SEAL', 'UNSEAL', 'STAFF_INFO_UPDATE_WEIGHT', 'STORE_KEEPER_UPDATE_WEIGHT', 'STORE_SORTER_UPDATE_WEIGHT', 'DISCARD_RETURN_BKK', 'DELIVERY_TRANSFER', 'PICKUP_RETURN_RECEIPT', 'FLASH_HOME_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SORTING_SCAN ', 'DELIVERY_PICKUP_STORE_SCAN', 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE', 'REFUND_CONFIRM', 'ACCEPT_PARCEL')
            and pr.organization_type = 1
        ) pr on pr.pno = t1.pno and pr.rk = 1
left join
    (
        select
            plt.pno
        from ph_bi.parcel_lose_task plt
        join t t1 on t1.pno = plt.pno
        where
            plt.state = 5
            and plt.operator_id not in (10000,10001,10002)
        group by 1
    ) plt2 on plt2.pno = t1.pno
left join
    (
        select
            plt.pno
        from ph_bi.parcel_claim_task plt
        join t t4  on t4.pno = plt.pno
        where
            plt.state not in (6,7,8)
            and plt.source = 11
        group by 1
    ) pct on pct.pno = t1.pno
left join
    (
        select
            pr2.pno
        from ph_staging.parcel_route pr2
        join t t1 on t1.pno = pr2.pno
        where
            pr2.route_action = 'REFUND_CONFIRM'
        group by 1
    ) hold on hold.pno = t1.pno
left join
    (
        select
            pr2.pno
        from  ph_staging.parcel_route pr2
        join t t1 on t1.pno = pr2.pno
        where
            pr2.route_action = 'PENDING_RETURN'
        group by 1
    ) pr3 on pr3.pno = t1.pno
left join
    (
        select
            td.pno
            ,count(distinct date(convert_tz(tdm.created_at, '+00:00', '+08:00'))) try_num
        from ph_staging.ticket_delivery td
        join t t1 on t1.pno = td.pno
        left join ph_staging.ticket_delivery_marker tdm on tdm.delivery_id = td.id
        group by 1
    ) td on td.pno = t1.pno
group by t1.pno;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.CT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-08-07'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.CT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-08-07'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-08-07', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with d as
(
    select
         ds.dst_store_id store_id
        ,ds.pno
        ,ds.p_date stat_date
    from dwm.dwd_ph_dc_should_be_delivery ds
    where
        ds.should_delevry_type = '1派应派包裹'
        and ds.p_date = '2023-08-07'
)
, t as
(
    select
         ds.store_id
        ,ds.pno
        ,ds.stat_date
    from d ds
    left join
        (
            select
                pr.pno
                ,ds.stat_date
                ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
            from ph_staging.parcel_route pr
            join d ds on pr.pno = ds.pno
            where 1=1
                and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                and pr.route_action = 'DETAIN_WAREHOUSE'
                and pr.marker_category in (42,43) ##岛屿,偏远地区
            group by 1,2
        ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
    left join
        (
            select
               pr.pno
                ,ds.stat_date
               ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
               ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
            from ph_staging.parcel_route pr
            join d ds on ds.pno = pr.pno
            where 1=1
                and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                and pr.route_action = 'DETAIN_WAREHOUSE'
                and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                and pr.marker_category in (9,14,70) ##客户改约时间
        ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
    left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
    where
        case
            when pr1.pno is not null then 'N'
            when pr2.pno is not null then 'N'
            when ds1.pno is not null  then 'N'  else 'Y'
        end = 'Y'
)
select
    a.stat_date 日期
    ,a.store_id 网点ID
    ,dp.store_name 网点名称
    ,dp.opening_at 开业时间
    ,case
        when dp.region_name in ('Area3', 'Area6') then '彭万松'
        when dp.region_name in ('Area4', 'Area9') then '韩钥'
        when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
        when dp.region_name in ( 'Area8') then '黄勇'
        when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
    end 区域
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,a.应交接
    ,a.已交接
    ,concat(round(a.交接率*100,2),'%') as 交接率
    ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
    ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
    ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
    ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
    ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
from
    (
        select
            t1.store_id
            ,t1.stat_date
            ,count(t1.pno) 应交接
            ,count(if(sc.pno is not null , t1.pno, null)) 已交接
            ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
            ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
            ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
            ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
            ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

            ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
            ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
            ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
            ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
        from t t1
        left join
            (
                select
                    sc.*
                from
                    (
                        select
                            pr.pno
                            ,pr.store_id
                            ,pr.store_name
                            ,t1.stat_date
                            ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                            ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                            ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                        from ph_staging.parcel_route pr
                        join t t1 on t1.pno = pr.pno
                        where
                            pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                           and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                          and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                    ) sc
                where
                    sc.rk = 1
            ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
        group by 1,2
    ) a
join
    (
        select
            sd.store_id
        from ph_staging.sys_district sd
        where
            sd.deleted = 0
            and sd.store_id is not null
        group by 1

        union all

        select
            sd.separation_store_id store_id
        from ph_staging.sys_district sd
        where
            sd.deleted = 0
            and sd.separation_store_id is not null
        group by 1
    ) sd on sd.store_id = a.store_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
where
    dp.store_category in (1,10,13);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-08-07'
        and pr.routed_at >= date_sub('2023-08-07', interval 8 hour )
        and pr.routed_at < date_add('2023-08-07', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id = 'PH61060300'
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end 评级
        ,a2.code_num
        ,a2.staff_code_num
        ,a2.staff_num
        ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-07'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-08-07')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-08-07'
        and pi.finished_at >= date_sub('2023-08-07', interval 8 hour )
        and pi.finished_at < date_add('2023-08-07', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-08-07'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        pi.pno
        ,pi.state
        ,pi.ticket_pickup_store_id
        ,pi.returned
        ,pi.dst_store_id
        ,pi.client_id
        ,pi.cod_enabled
    from ph_staging.parcel_info pi
    where
        pi.created_at < '2023-07-19 16:00:00'
        and pi.state not in (5,7,8,9)
)
select
    t1.pno
    ,if(t1.returned = 1, '退件', '正向件')  方向
    ,t1.client_id 客户ID
    ,case
        when bc.`client_id` is not null then bc.client_name
        when kp.id is not null and bc.client_id is null then '普通ka'
        when kp.`id` is null then '小c'
    end as 客户类型
    ,case t1.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,case di.diff_marker_category # 疑难原因
        when 1 then '客户不在家/电话无人接听'
        when 2 then '收件人拒收'
        when 3 then '快件分错网点'
        when 4 then '外包装破损'
        when 5 then '货物破损'
        when 6 then '货物短少'
        when 7 then '货物丢失'
        when 8 then '电话联系不上'
        when 9 then '客户改约时间'
        when 10 then '客户不在'
        when 11 then '客户取消任务'
        when 12 then '无人签收'
        when 13 then '客户周末或假期不收货'
        when 14 then '客户改约时间'
        when 15 then '当日运力不足，无法派送'
        when 16 then '联系不上收件人'
        when 17 then '收件人拒收'
        when 18 then '快件分错网点'
        when 19 then '外包装破损'
        when 20 then '货物破损'
        when 21 then '货物短少'
        when 22 then '货物丢失'
        when 23 then '收件人/地址不清晰或不正确'
        when 24 then '收件地址已废弃或不存在'
        when 25 then '收件人电话号码错误'
        when 26 then 'cod金额不正确'
        when 27 then '无实际包裹'
        when 28 then '已妥投未交接'
        when 29 then '收件人电话号码是空号'
        when 30 then '快件分错网点-地址正确'
        when 31 then '快件分错网点-地址错误'
        when 32 then '禁运品'
        when 33 then '严重破损（丢弃）'
        when 34 then '退件两次尝试派送失败'
        when 35 then '不能打开locker'
        when 36 then 'locker不能使用'
        when 37 then '该地址找不到lockerstation'
        when 38 then '一票多件'
        when 39 then '多次尝试派件失败'
        when 40 then '客户不在家/电话无人接听'
        when 41 then '错过班车时间'
        when 42 then '目的地是偏远地区,留仓待次日派送'
        when 43 then '目的地是岛屿,留仓待次日派送'
        when 44 then '企业/机构当天已下班'
        when 45 then '子母件包裹未全部到达网点'
        when 46 then '不可抗力原因留仓(台风)'
        when 47 then '虚假包裹'
        when 48 then '转交FH包裹留仓'
        when 50 then '客户取消寄件'
        when 51 then '信息录入错误'
        when 52 then '客户取消寄件'
        when 53 then 'lazada仓库拒收'
        when 69 then '禁运品'
        when 70 then '客户改约时间'
        when 71 then '当日运力不足，无法派送'
        when 72 then '客户周末或假期不收货'
        when 73 then '收件人/地址不清晰或不正确'
        when 74 then '收件地址已废弃或不存在'
        when 75 then '收件人电话号码错误'
        when 76 then 'cod金额不正确'
        when 77 then '企业/机构当天已下班'
        when 78 then '收件人电话号码是空号'
        when 79 then '快件分错网点-地址错误'
        when 80 then '客户取消任务'
        when 81 then '重复下单'
        when 82 then '已完成揽件'
        when 83 then '联系不上客户'
        when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
        when 85 then '寄件人电话号码是空号'
        when 86 then '包裹不符合揽收条件超大件'
        when 87 then '包裹不符合揽收条件违禁品'
        when 88 then '寄件人地址为岛屿'
        when 89 then '运力短缺，跟客户协商推迟揽收'
        when 90 then '包裹未准备好推迟揽收'
        when 91 then '包裹包装不符合运输标准'
        when 92 then '客户提供的清单里没有此包裹'
        when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
        when 94 then '客户取消寄件/客户实际不想寄此包裹'
        when 95 then '车辆/人力短缺推迟揽收'
        when 96 then '遗漏揽收(已停用)'
        when 97 then '子母件(一个单号多个包裹)'
        when 98 then '地址错误addresserror'
        when 99 then '包裹不符合揽收条件：超大件'
        when 100 then '包裹不符合揽收条件：违禁品'
        when 101 then '包裹包装不符合运输标准'
        when 102 then '包裹未准备好'
        when 103 then '运力短缺，跟客户协商推迟揽收'
        when 104 then '子母件(一个单号多个包裹)'
        when 105 then '破损包裹'
        when 106 then '空包裹'
        when 107 then '不能打开locker(密码错误)'
        when 108 then 'locker不能使用'
        when 109 then 'locker找不到'
        when 110 then '运单号与实际包裹的单号不一致'
        when 111 then 'box客户取消任务'
        when 112 then '不能打开locker(密码错误)'
        when 113 then 'locker不能使用'
        when 114 then 'locker找不到'
        when 115 then '实际重量尺寸大于客户下单的重量尺寸'
        when 116 then '客户仓库关闭'
        when 117 then '客户仓库关闭'
        when 118 then 'SHOPEE订单系统自动关闭'
        when 119 then '客户取消包裹'
        when 121 then '地址错误'
        when 122 then '当日运力不足，无法揽收'
    end as 疑难原因
#     ,case
#         when t1.state = 6 and di.pno is not null then 'KAM/揽件网点未协商'
#         when t1.state = 6 and di.pno is null  then '闪速系统沟通处理中'
#         when t1.state != 6 and plt.pno is not null and plt2.pno is not null then '闪速系统沟通处理中'
#         when plt.pno is null and pct.pno is not null then '闪速超时效理赔未完成'
#         when de.last_store_id = t1.ticket_pickup_store_id and plt2.pno is null then '揽件未发出'
#         when t1.dst_store_id = 'PH19040F05' and plt2.pno is null then '弃件未到拍卖仓'
#         when t1.state != 6 and datediff(now(), convert_tz(pr.routed_at, '+00:00', '+08:00')) > 7 and plt2.pno is not null then 'QAQC无须追责后长期无有效路由'
#         else null
#     end 卡点原因
#     ,de.last_store_name 当前节点
    ,datediff(now(), convert_tz(pr.routed_at, '+00:00', '+08:00')) 最后有效路由距今天数
#     ,de.last_cn_route_action 最新一条有效路由
    ,case pr.route_action # 路由动作
         when 'ACCEPT_PARCEL' then '接件扫描'
         when 'ARRIVAL_GOODS_VAN_CHECK_SCAN' then '车货关联到港'
         when 'ARRIVAL_WAREHOUSE_SCAN' then '到件入仓扫描'
         when 'CANCEL_ARRIVAL_WAREHOUSE_SCAN' then '取消到件入仓扫描'
         when 'CANCEL_PARCEL' then '撤销包裹'
         when 'CANCEL_SHIPMENT_WAREHOUSE' then '取消发件出仓'
         when 'CHANGE_PARCEL_CANCEL' then '修改包裹为撤销'
         when 'CHANGE_PARCEL_CLOSE' then '修改包裹为异常关闭'
         when 'CHANGE_PARCEL_IN_TRANSIT' then '修改包裹为运输中'
         when 'CHANGE_PARCEL_INFO' then '修改包裹信息'
         when 'CHANGE_PARCEL_SIGNED' then '修改包裹为签收'
         when 'CLAIMS_CLOSE' then '理赔关闭'
         when 'CLAIMS_COMPLETE' then '理赔完成'
         when 'CLAIMS_CONTACT' then '已联系客户'
         when 'CLAIMS_TRANSFER_CS' then '转交总部cs处理'
         when 'CLOSE_ORDER' then '关闭订单'
         when 'CONTINUE_TRANSPORT' then '疑难件继续配送'
         when 'CREATE_WORK_ORDER' then '创建工单'
         when 'CUSTOMER_CHANGE_PARCEL_INFO' then '客户修改包裹信息'
         when 'CUSTOMER_OPERATING_RETURN' then '客户操作退回寄件人'
         when 'DELIVERY_CONFIRM' then '确认妥投'
         when 'DELIVERY_MARKER' then '派件标记'
         when 'DELIVERY_PICKUP_STORE_SCAN' then '自提取件扫描'
         when 'DELIVERY_TICKET_CREATION_SCAN' then '交接扫描'
         when 'DELIVERY_TRANSFER' then '派件转单'
         when 'DEPARTURE_GOODS_VAN_CK_SCAN' then '车货关联出港'
         when 'DETAIN_WAREHOUSE' then '货件留仓'
         when 'DIFFICULTY_FINISH_INDEMNITY' then '疑难件支付赔偿'
         when 'DIFFICULTY_HANDOVER' then '疑难件交接'
         when 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE' then '疑难件交接货件留仓'
         when 'DIFFICULTY_RE_TRANSIT' then '疑难件退回区域总部/重启运送'
         when 'DIFFICULTY_RETURN' then '疑难件退回寄件人'
         when 'DIFFICULTY_SEAL' then '集包异常'
         when 'DISCARD_RETURN_BKK' then '丢弃包裹的，换单后寄回BKK'
         when 'DISTRIBUTION_INVENTORY' then '分拨盘库'
         when 'DWS_WEIGHT_IMAGE' then 'DWS复秤照片'
         when 'EXCHANGE_PARCEL' then '换货'
         when 'FAKE_CANCEL_HANDLE' then '虚假撤销判责'
         when 'FLASH_HOME_SCAN' then 'FH交接扫描'
         when 'FORCE_TAKE_PHOTO' then '强制拍照路由'
         when 'HAVE_HAIR_SCAN_NO_TO' then '有发无到'
         when 'HURRY_PARCEL' then '催单'
         when 'INCOMING_CALL' then '来电接听'
         when 'INTERRUPT_PARCEL_AND_RETURN' then '中断运输并退回'
         when 'INVENTORY' then '盘库'
         when 'LOSE_PARCEL_TEAM_OPERATION' then '丢失件团队处理'
         when 'MANUAL_REMARK' then '添加备注'
         when 'MISS_PICKUP_HANDLE' then '漏包裹揽收判责'
         when 'MISSING_PARCEL_SCAN' then '丢失件包裹操作'
         when 'NOTICE_LOST_PARTS_TEAM' then '已通知丢失件团队'
         when 'PARCEL_HEADLESS_CLAIMED' then '无头件包裹已认领'
         when 'PARCEL_HEADLESS_PRINTED' then '无头件包裹已打单'
         when 'PENDING_RETURN' then '待退件'
         when 'PHONE' then '电话联系'
         when 'PICK_UP_STORE' then '待自提取件'
         when 'PICKUP_RETURN_RECEIPT' then '签回单揽收'
         when 'PRINTING' then '打印面单'
         when 'QAQC_OPERATION' then 'QAQC判责'
         when 'RECEIVE_WAREHOUSE_SCAN' then '收件入仓'
         when 'RECEIVED' then '已揽收,初始化动作，实际情况并没有作用'
         when 'REFUND_CONFIRM' then '退件妥投'
         when 'REPAIRED' then '上报问题修复路由'
         when 'REPLACE_PNO' then '换单'
         when 'REPLY_WORK_ORDER' then '回复工单'
         when 'REVISION_TIME' then '改约时间'
         when 'SEAL' then '集包'
         when 'SEAL_NUMBER_CHANGE' then '集包件数变化'
         when 'SHIPMENT_WAREHOUSE_SCAN' then '发件出仓扫描'
         when 'SORTER_WEIGHT_IMAGE' then '分拣机复秤照片'
         when 'SORTING_SCAN' then '分拣扫描'
         when 'STAFF_INFO_UPDATE_WEIGHT' then '快递员修改重量'
         when 'STORE_KEEPER_UPDATE_WEIGHT' then '仓管员复秤'
         when 'STORE_SORTER_UPDATE_WEIGHT' then '分拣机复秤'
         when 'SYSTEM_AUTO_RETURN' then '系统自动退件'
         when 'TAKE_PHOTO' then '异常打单拍照'
         when 'THIRD_EXPRESS_ROUTE' then '第三方公司路由'
         when 'THIRD_PARTY_REASON_DETAIN' then '第三方原因滞留'
         when 'TICKET_WEIGHT_IMAGE' then '揽收称重照片'
         when 'TRANSFER_LOST_PARTS_TEAM' then '已转交丢失件团队'
         when 'TRANSFER_QAQC' then '转交QAQC处理'
         when 'UNSEAL' then '拆包'
         when 'UNSEAL_NO_PARCEL' then '上报包裹不在集包里'
         when 'UNSEAL_NOT_SCANNED' then '集包已拆包，本包裹未被扫描'
         when 'VEHICLE_ACCIDENT_REG' then '车辆车祸登记'
         when 'VEHICLE_ACCIDENT_REGISTRATION' then '车辆车祸登记'
         when 'VEHICLE_WET_DAMAGE_REG' then '车辆湿损登记'
         when 'VEHICLE_WET_DAMAGE_REGISTRATION' then '车辆湿损登记'
        end as 最后一条路由
    ,pr.store_name 最后有效路由动作网点
    ,convert_tz(pr.routed_at ,'+00:00', '+08:00') 最新一条有效路由时间
    ,datediff(now(), de.dst_routed_at) 目的地网点停留时间
    ,de.dst_store 目的地网点
    ,de.dst_piece
    ,de.dst_region
    ,de.src_store 揽收网点
    ,de.pickup_time 揽收时间
    ,de.pick_date 揽收日期
    ,if(hold.pno is not null, 'yes', 'no' ) 是否有holding标记
    ,if(pr3.pno is not null, 'yes', 'no') 是否有待退件标记
    ,td.try_num 尝试派送次数
from t t1
left join ph_staging.ka_profile kp on t1.client_id = kp.id
left join dwm.dwd_dim_bigClient bc on bc.client_id = t1.client_id
left join dwm.dwd_ex_ph_parcel_details de on de.pno = t1.pno
left join
    (
        select
            plt.pno
            ,group_concat(ss.name ) should_do
        from ph_bi.parcel_lose_task plt
        join t t1 on t1.pno = plt.pno
        left join ph_bi.work_order wo on wo.loseparcel_task_id = plt.id
        left join ph_staging.sys_store ss on ss.id = wo.store_id
        where
            plt.state in (3)
            and wo.status in (1,2)
        group by 1

        union  all

        select
            plt.pno
            ,'QAQC' should_do
        from ph_bi.parcel_lose_task plt
        join t t1 on t1.pno = plt.pno
        where
            plt.state in (1,2,4)
    ) plt on plt.pno = t1.pno
left join
    (
        select
            t2.pno
            ,cdt.negotiation_result_category
            ,di.diff_marker_category
            ,case
                when di.diff_marker_category in (20,21)  and cdt.vip_enable = 1 then 'KAM'
                when di.diff_marker_category not in (20,21) and cdt.vip_enable = 1 then 'KAM'
                when di.diff_marker_category not in (20,21) and cdt.vip_enable = 0 then ss2.name
                WHEN di.diff_marker_category in (20,21) and cdt.vip_enable = 0 then ss2.name
            end sh_do
        from ph_staging.diff_info di
        join t t2 on t2.pno = di.pno
        join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
        left join ph_bi.parcel_lose_task plt on plt.source_id = cdt.id
        left join ph_staging.sys_store ss2 on ss2.id = t2.ticket_pickup_store_id
        where
            cdt.negotiation_result_category is null
    ) di on di.pno = t1.pno
left join  
    (
        select
            pr.pno
            ,pr.store_name
            ,pr.routed_at
            ,pr.route_action
            ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
        from  ph_staging.parcel_route pr
        join t t3 on t3.pno = pr.pno
        where
            pr.route_action in ('INVENTORY','RECEIVED' ,'RECEIVE_WAREHOUSE_SCAN', 'SORTING_SCAN', 'DELIVERY_TICKET_CREATION_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SHIPMENT_WAREHOUSE_SCAN', 'DETAIN_WAREHOUSE', 'DELIVERY_CONFIRM', 'DIFFICULTY_HANDOVER', 'DELIVERY_MARKER', 'REPLACE_PNO','SEAL', 'UNSEAL', 'STAFF_INFO_UPDATE_WEIGHT', 'STORE_KEEPER_UPDATE_WEIGHT', 'STORE_SORTER_UPDATE_WEIGHT', 'DISCARD_RETURN_BKK', 'DELIVERY_TRANSFER', 'PICKUP_RETURN_RECEIPT', 'FLASH_HOME_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SORTING_SCAN ', 'DELIVERY_PICKUP_STORE_SCAN', 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE', 'REFUND_CONFIRM', 'ACCEPT_PARCEL')
            and pr.organization_type = 1
        ) pr on pr.pno = t1.pno and pr.rk = 1
left join
    (
        select
            plt.pno
        from ph_bi.parcel_lose_task plt
        join t t1 on t1.pno = plt.pno
        where
            plt.state = 5
            and plt.operator_id not in (10000,10001,10002)
        group by 1
    ) plt2 on plt2.pno = t1.pno
left join
    (
        select
            plt.pno
        from ph_bi.parcel_claim_task plt
        join t t4  on t4.pno = plt.pno
        where
            plt.state not in (6,7,8)
            and plt.source = 11
        group by 1
    ) pct on pct.pno = t1.pno
left join
    (
        select
            pr2.pno
        from ph_staging.parcel_route pr2
        join t t1 on t1.pno = pr2.pno
        where
            pr2.route_action = 'REFUND_CONFIRM'
        group by 1
    ) hold on hold.pno = t1.pno
left join
    (
        select
            pr2.pno
        from  ph_staging.parcel_route pr2
        join t t1 on t1.pno = pr2.pno
        where
            pr2.route_action = 'PENDING_RETURN'
        group by 1
    ) pr3 on pr3.pno = t1.pno
left join
    (
        select
            td.pno
            ,count(distinct date(convert_tz(tdm.created_at, '+00:00', '+08:00'))) try_num
        from ph_staging.ticket_delivery td
        join t t1 on t1.pno = td.pno
        left join ph_staging.ticket_delivery_marker tdm on tdm.delivery_id = td.id
        group by 1
    ) td on td.pno = t1.pno
group by t1.pno;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
        select
            pr.pno
            ,pr.routed_at
        from ph_staging.parcel_route pr
        join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
        where
            pr.routed_at > '2023-08-07 16:00:00'
        group by 1,2
)
select
    pr.pno
from ph_staging.parcel_route pr
join t t1 on t1.pno = pr.pno and pr.routed_at < t1.routed_at
where
    pr.route_action = 'CHANGE_PARCEL_CLOSE'
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
    ,pi.dst_phone
    ,pi.dst_home_phone
from ph_staging.parcel_info pi
where
    pi.pno in ('PT140922B3X03AM','PT140922ADAN9AM','PT140922C23G8AM','PT1409229SFX0AK','PT140922DQC48AK','PT140922D2M31AE','PT140922B7YV5AE','PT140122C09S2AL','PT1401228U2A4AC','PT140122BDN03AB','PT140122AWKS3AC','PT140122CM3T1BC','PT1401228PA10BC','PT140122DWWH9BC','PT140122CYAU1AQ','PT140122BWNU6AW','PT140122D3TJ8BC','PT260522BQWS4AZ','PT140122D4SW7AY','PT140122D1P67AF','PT140122ACKQ1AD','PT140122AH2W3AO','PT140122DFPB4AF','PT140122CX9D5AD','PT140922BR612AK','PT140122CUWF9AM','PT1401229FHN2AM','PT1401228XC25AM','PT140122D5W66BC','PT140122CPN10BF','PT140122BY8T1BC','PT140122CDD27BF','PT140122BYBT7AV','PT140122CYJ36AC','PT140122B3601AC','PT140122AYVV4AC','PT140122BR0V4AL','PT140122ADSF6AM','PT140122E74M7AL','PT1401229Q7R5AM','PT140922CN3A0AK','PT140922AM030AE','PT140122BWDD5BE','PT140922DN1W7AK','PT140122CAPD7AL','PT140122A5K93AC','PT140122C7PJ9AC','PT140122AFXB0AL','PT140122CGNH7AG','PT140122D0EF0AC','PT1401229NED5AM','PT140122BWRF8AO','PT140122C9PV1AF','PT140922C20Y2AP','PT14092293SW5AE','PT140922A5ST3AP','PT1409228TNU1AM','PT140922CGBC3AP','PT1401229QXZ2AO','PT1409229UW79AM','PT140922CWWM7AM','PT1409228YPD6AE','PT140922BT6X8AP','PT140122DG872AO','PT140122E5XT0AM','PT140122CRUX2AM','PT140122AGPM6AL','PT140122D1KX5AM','PT611022DJAD2AE','PT140122APYV5AM','PT140122C12D2AH','PT140122C0VV8AM','PT1401229YNR5AL','PT140122DK4V2AC','PT140122CYEY8AC','PT140122DCDX5AL','PT140122AP6Q1AM','PT1401229Z1Z1AM','PT140122CMG29AF','PT140122CZ7F7AM','PT140122DJ8J4BF','PT140122AMR15AM','PT140122ACVW4AM','PT140122B9ED4AL','PT140922A9PH2AK','PT140122C71J8AC','PT140122BTA63AM','PT140122CKN02AM','PT140122B0573AM','PT140122DKGW3AM','PT140122CQ045AM','PT14092211KY6AP','PT140122CX2D9AM','PT140122CKAW4AG','PT140922E5GT5AK','PT140122DFH02AC','PT140122CBMX0AC','PT140122D9DS8AC','PT140122CYZG0AC','PT140122AMWF7AB','PT1401222YPN6AB','PT1401228NFF3AB','PT140122C97U4AB','PT1401229ZXR0AS','PT140122C2Y13AM','PT140122CYNV1AB','PT140122DDDN9BF','PT140122CG1Z4BC','PT140122C8EC1BC','PT140122ATK35BC','PT140122DG275AO','PT140122C8JB6BF','PT140122CXW39BC','PT140922DMKX4AE','PT140922BSG57AP','PT140922AF234AM','PT1409228Z101AE','PT140922E70R4AM','PT140122DMQ73AM','PT140122CX4K8AM','PT140122DPF72AL','PT140922DN050AH','PT140122BZZQ5AL','PT140922DK7K8AK','PT140122BRD65AC','PT140122CA5X1AL','PT140122D0741BF','PT140122E1PY9BF','PT141522BE3Z9AX','PT140122E1N97BF','PT140122CERT2AC','PT140122AZD00AC','PT140122APNF2AM','PT1401228X3Z9AC','PT140122BF6Q9AM','PT140122DU3Z9BA','PT140122CQSJ9AO','PT140122DD788BA','PT1401229W5V6AP','PT140122BQRH0AB','PT140122AJ3W4AF','PT140122CX359AF','PT140122BEKH8AO','PT140122CV519AF','PT140122CGTB2AP','PT140122APNT7AO','PT140122E7MA9AG','PT140122AHY19AF','PT140922E57X6AE','PT1409229TN38AP','PT140922C57Y5AP','PT1409225ERK0AM','PT150722AB5Q8AR','PT1409229TJK1AM','PT140922CRM36AP','PT140122BP2Y6AM','PT140122BAXS1AM','PT140122CX6Y5AC','PT140122C7RN0AC','PT14012294UY6AC','PT140122AM5X2AC','PT140122DHB40AM','PT140922A1D51AK','PT140122CQFG4AL','PT140122E6RV3AM','PT140122D8373AC','PT140122C9321AL','PT1401229KDJ4AM','PT140122D4T36AB','PT140122B0393AL','PT140122C1D95AS','PT140122DFKX0AB','PT1401229SWX9AB','PT140122BX6Q6BF','PT140922BKZY7AB','PT140122AJ1K2BF','PT140122CEU36BC','PT140922A9F09AM','PT140922BNJ16AE','PT140922CFP90AM','PT140922AV4Y0AM','PT140122C2JF8AC','PT140122C2RX3AM','PT140122E8Y85AM','PT140122DUC50AM','PT140122C8C68AM','PT140122D4Q61AC','PT140122CK175AC','PT140122CVMW4AM','PT140122D5W49AM','PT140122D0J79BF','PT14092291RH8AK','PT140122B6RE6AM','PT140122E8JM6AM','PT140122DA2Z5AC','PT140922AKDK1AS','PT140122E2S40AM','PT140122CY7T5AL','PT1409229SGR6AK','PT140922A4EY3AK','PT140122D4MN6BC','PT1401221FTA3AQ','PT140922BTH43AK','P14011YPUVJAQ','PT140122CD3E8BC','PT140122BQF70BF','PT140122BKRB0AM','PT140122CXG69AC','PT140122C78M7AM','PT140122E6728AM','PT140122B72P0AM','PT140122AB249AL','PT140122BEJR0AM','PT140122B5BP9AM','PT140122AJ756AM','PT140122AKKR3AM','PT140122AQFS9AC','PT140122DMPR3AC','PT140122CJ4C4AL','PT140122D1B98AM','PT140122AN4V3AM','PT140122CM7D9AF','PT140122BWVZ8AC','PT1401228GJ35AC','PT140922AH7F3AK','PT140122DG0S3AR','PT140122CP7M9AB','PT140122BPN89AB','PT140122CR6J4AB','PT140122AKEZ4BC','PT1401228N408AB','PT140122DPM84BB','PT140122CGP17AB','PT140122AZDU5AB','PT140122CDAJ2AW','PT140122BXZ43BF','PT140122DP4Y7BF','PT140122DNV48BF','PT140122BS0H4BC','PT140122C8UH1BF','PT140122AMGT3AH','PT140122BKM33BG','PT140122E6S99AM','PT140122DXEY0AC','PT140122DKTK5AM','PT140122CD7A4AM','PT140122ADA93AL','PT140122C7MH9BC','PT140122D6PU3BC','PT140122AN2B2AM','PT140122B0AZ7BC','PT1401229TB83AL','PT140122CJCK3AB','PT140122D6TW5AN','PT140122CD202BF','PT1401229GHU7AS','PT140122E0895AB','PT140122CW7Y9AC','PT1401221G2E5AO','PT140922AE5G5AP','PT140922BQS41AE','PT140922D60X3AP','PT140922AHRV5AP','PT140122BBJU0AB','PT140922ANFR8AK','PT140922CKZP1AK','PT140922CVGV3AK','PT140122AYHP1AE','PT140122CRHT2BF','PT140122DAYZ4BC','PT140122B18W5AB','PT140122AXHC9AB','PT140122CY7P0AB','PT140122C3C21AM','PT1401228GXR3AS','PT140122DUCV5AB','PT1401229SB39AB','PT140122EEU79AC','PT140122CCQ34AK','PT1409228X5W5AE','PT140922D0F68AM','PT140922B4CB7AP','PT1401229YCQ7BC','PT140122A4CV6AP','PT140122BAT41AO','PT140122DD5D0BA','PT044322C66V4AT','PT140922CGEP1AP','PT140922C8S65AM','PT140122D1P89AF','PT140922AV650AM','PT1409229CWS7AP','PT14092284QD2AP','PT140922BGYD4AE','PT140922CNHD8AE','PT140922CHCE4AK','PT140122D44S3AC','PT140122BJWY8AM','PT140122DMBF3AG','PT140122DWBV1AH','PT140122CU1H0AW','PT140122D8JD2AC','PT1401229KKP2AL','PT140122DTQZ2AC','PT1401229FWZ2AM','PT140122DZED7AH','PT140122EEB94AH','PT140122BPN24AC','PT140122CNU68AM','PT140122AUMR9AB','PT140122CGM70AC','PT140122AH2Q6AM','PT140122CGB47AM','PT140122DTGP9AM','PT140122AREZ4AM','PT140122A7UP4AC','PT140922BW3R4AP','PT140122E6Q43AC','PT140122A0BT7AM','PT140122B2KR0AC','PT140122BA241AM','PT140122C7889AS','PT140122BM3B1AM','PT140122C7X74AM','PT140122DWV16AM','PT140122D5U07AM','PT1409229RAD9AK','PT140122C4MX6AM','PT140122DSCK7AM','PT14012283EC6AM','PT140122BYQV7AC','PT1401229AZS2AM','PT140122BBDF8AC','PT140122C9YA1AI','PT140122E7M86AM','PT140122A3DK0AS','PT140122BYHX6AB','PT140122BSQX0AS','PT140122DKF05AB','PT140122D7V28BF','PT140122B93W5BF','PT14092299B22AM','PT14092293HV5AP','PT140122BV7H1AL','PT140122BS4B1AH','PT1401229GWM4AM','PT140922AKMX1AK','PT140122DGXD1AQ','PT140122BZ6Z7BF','PT140122CM5Q7BC','PT140122BBR48BF','PT1401229TPD4BC','PT140122AV2R6AQ','PT140122D2QX7AF','PT140122DTPJ5AM','PT140122C7439AM','PT140122D7E46AL','PT1401229QNT5AC','PT140122AGJ05AL','PT140122AU1W9AL','PT1401229ZTE9AC','PT141522B9V15AX','PT140122DM499AM','PT140122BQCU3AM','PT140922AJ3N7AK','PT141522D5GU9AX','PT140122DHKZ7AM','PT140122AKCW1AC','PT140122CV6B5AM','PT141522AM8Z4AX','PT141522AM8Z4AX','PT140122BFPG7AC','PT140122BPF00BD','PT140122A3642AB','PT140922BBEZ1AK','PT140122DY7Q7AQ','PT140122CKBX4BF','PT1401229N9D1AM','PT140122C7WG1AB','PT140122CD2R3AC','PT140122CZWR7AB','PT140122CVJH7AF','PT140122AYDT0AM','PT140122A3NB2AB','PT140122B0C14AS','PT140922BBFU8AK','PT1409229SKU9AK','PT140122905Z3AC','PT140122DKJM2BC','PT140122CYKK6AB','PT140922A5DR5AM','PT140122BZA53AT','PT140922E2057AK','PT140922BA879AK','PT140122BSDV3AB','PT140122BPJC3AB','PT140122EFHT6AC','PT140122B00F3AS','PT140122B5C99AB','PT140122DYYP9AB','PT140122ADD29AB','PT140122AMZU3AB','PT140122B8659AC','PT140122ASWE7AE','PT140122CAHN8BC','PT140122BN7R1AM','PT140122CZ8K8BF','P14011YPXAKAQ','PT140122AEFH5AQ','PT140122BZNF5BC','PT140122BQM21AC');
;-- -. . -..- - / . -. - .-. -.--
select
    ddd.CN_element
    ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) pr_date
    ,count(distinct pr.pno) 包裹数
from ph_staging.parcel_route pr
left join dwm.dwd_dim_dict ddd on ddd.element = json_extract(pr.extra_value, '$.rejectionCategory') and ddd.db = 'ph_staging' and ddd.tablename = 'diff_info' and ddd.fieldname = 'rejection_category'
where
    pr.route_action = 'DELIVERY_MARKER'
    and pr.routed_at >= '2023-06-30 16:00:00'
    and pr.routed_at < '2023-07-31 16:00:00'
    and pr.marker_category in (2,17)
group by 1,2;
;-- -. . -..- - / . -. - .-. -.--
select
    count( pr.pno) 包裹数
from ph_staging.parcel_route pr
left join dwm.dwd_dim_dict ddd on ddd.element = json_extract(pr.extra_value, '$.rejectionCategory') and ddd.db = 'ph_staging' and ddd.tablename = 'diff_info' and ddd.fieldname = 'rejection_category'
where
    pr.route_action = 'DELIVERY_MARKER'
    and pr.routed_at >= '2023-06-30 16:00:00'
    and pr.routed_at < '2023-07-31 16:00:00'
    and pr.marker_category in (2,17);
;-- -. . -..- - / . -. - .-. -.--
select
    pr.pno
    ,convert_tz(pi.created_at, '+00:00', '+08:00')  揽收时间
    ,convert_tz(pr.routed_at, '+00:00', '+08:00')  标记拒收时间
    ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) 标记拒收日期
    ,pi.client_id 客户ID
    ,ddd.CN_element 拒收二级原因
    ,pr.store_id 操作网点ID
    ,dp.store_name 操作网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,pr.remark 路由备注
from ph_staging.parcel_route pr
left join ph_staging.parcel_info pi on pi.pno = pr.pno
join ph_staging.ka_profile kp on kp.id = pi.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
left join dwm.dwd_dim_dict ddd on ddd.element = json_extract(pr.extra_value, '$.rejectionCategory') and ddd.db = 'ph_staging' and ddd.tablename = 'diff_info' and ddd.fieldname = 'rejection_category'
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = pr.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
where
    pr.route_action = 'DELIVERY_MARKER'
    and pr.routed_at >= '2023-06-30 16:00:00'
    and pr.routed_at < '2023-07-31 16:00:00'
    and pr.marker_category in (2,17)
    and bc.client_id is null;
;-- -. . -..- - / . -. - .-. -.--
select
    date(vrv.created_at) 日期
    ,count(if(bc.client_name = 'lazada', vrv.id, null)) lazada需回访总量
    ,count(if(bc.client_name = 'shopee', vrv.id, null)) shopee需回访总量
    ,count(if(bc.client_name = 'tiktok' and vrv.visit_remark = 3, vrv.id, null )) tiktok3次派送需回访量
    ,count(if(bc.client_name = 'tiktok' and vrv.visit_remark > 3, vrv.id, null )) tiktok超3次派送需回访量
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
where
    vrv.type = 8
    and vrv.created_at >= '2023-08-01';
;-- -. . -..- - / . -. - .-. -.--
select
    date(vrv.created_at) 日期
    ,count(if(bc.client_name = 'lazada', vrv.id, null)) lazada需回访总量
    ,count(if(bc.client_name = 'shopee', vrv.id, null)) shopee需回访总量
    ,count(if(bc.client_name = 'tiktok' and vrv.visit_remark = 3, vrv.id, null )) tiktok3次派送需回访量
    ,count(if(bc.client_name = 'tiktok' and vrv.visit_remark > 3, vrv.id, null )) tiktok超3次派送需回访量
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
where
    vrv.type = 8
    and vrv.created_at >= '2023-08-01'
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    date(vrv.created_at) 日期
    ,count(if(bc.client_name = 'lazada', vrv.id, null)) lazada需回访总量
    ,count(if(bc.client_name = 'shopee', vrv.id, null)) shopee需回访总量
    ,count(if(bc.client_name = 'tiktok' and vrv.violation_remark = 3, vrv.id, null )) tiktok3次派送需回访量
    ,count(if(bc.client_name = 'tiktok' and vrv.violation_remark > 3, vrv.id, null )) tiktok超3次派送需回访量
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
where
    vrv.type = 8
    and vrv.created_at >= '2023-08-01'
group by 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        de.pno
        ,de.dst_store_id
        ,de.dst_store
        ,de.dst_region
        ,de.dst_piece
        ,pi.state
        ,pi.dst_phone
        ,pi.dst_home_phone
        ,if(pcd.pno is not null , 'y', 'n') change_store
        ,max(pcd.created_at) pcd_create_at
    from dwm.dwd_ex_ph_parcel_details de
    left join ph_staging.parcel_info pi on de.pno = pi.pno
    left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
    left join ph_staging.parcel_route pr on pr.pno = de.pno and pr.route_action = 'PENDING_RETURN'
    left join ph_staging.parcel_change_detail pcd on pcd.pno = pi.pno and pcd.field_name = 'dst_store_id' and pcd.new_value != pcd.old_value
    where
        pi.state not in (5,7,8,9)
        and bc.client_id is null
        and pr.pno is null
    group by 1
)
select
    count(if(a.尝试天数 = 3, a.pno, null)) 3次派送量
    ,count(if(a.尝试天数 > 3, a.pno, null)) 3次以上派送量
from
    (
        select
            t1.pno
            ,t1.dst_store 目的地网点
            ,t1.dst_store_id 目的网点ID
            ,t1.dst_piece 目的地片区
            ,t1.dst_region 目的地大区
            ,case t1.state
                when '1' then '已揽收'
                when '2' then '运输中'
                when '3' then '派送中'
                when '4' then '已滞留'
                when '5' then '已签收'
                when '6' then '疑难件处理中'
                when '7' then '已退件'
                when '8' then '异常关闭'
                when '9' then '已撤销'
            end as `包裹状态`
            ,t1.dst_phone 收件人电话
            ,t1.dst_home_phone 收件人家庭电话
            ,count(distinct ppd.mark_date) 尝试天数
        from t t1
        left join
            (
                select
                    td.pno
                    ,date(convert_tz(tdm.created_at, '+00:00', '+08:00')) mark_date
                from ph_staging.ticket_delivery td
                join t t1 on t1.pno = td.pno
                left join ph_staging.ticket_delivery_marker tdm on tdm.delivery_id = td.id
                where
                    if(t1.change_store = 'n', 1 = 1, tdm.created_at > t1.pcd_create_at)
                group by 1,2
            ) mark on mark.pno = t1.pno
        left join
            (
                select
                    ppd.pno
                    ,date(convert_tz(ppd.created_at, '+00:00', '+08:00')) mark_date
                from ph_staging.parcel_problem_detail ppd
                join t t1 on t1.pno = ppd.pno
                where
                    ppd.diff_marker_category not in (7,22,5,20,6,21,15,71)
                    and if(t1.change_store = 'n', 1 = 1, ppd.created_at > t1.pcd_create_at)
                group by 1,2
            ) ppd on ppd.pno = mark.pno and mark.mark_date = ppd.mark_date
        where
            ppd.mark_date is not null
        group by 1
    ) a
group by 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        de.pno
        ,de.dst_store_id
        ,de.dst_store
        ,de.dst_region
        ,de.dst_piece
        ,pi.state
        ,pi.dst_phone
        ,pi.dst_home_phone
        ,if(pcd.pno is not null , 'y', 'n') change_store
        ,max(pcd.created_at) pcd_create_at
    from dwm.dwd_ex_ph_parcel_details de
    left join ph_staging.parcel_info pi on de.pno = pi.pno
    left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
    left join ph_staging.parcel_route pr on pr.pno = de.pno and pr.route_action = 'PENDING_RETURN'
    left join ph_staging.parcel_change_detail pcd on pcd.pno = pi.pno and pcd.field_name = 'dst_store_id' and pcd.new_value != pcd.old_value
    where
        pi.state not in (5,7,8,9)
        and bc.client_id is null
        and pr.pno is null
    group by 1
)
select
    count(if(a.尝试天数 = 3, a.pno, null)) 3次派送量
    ,count(if(a.尝试天数 > 3, a.pno, null)) 3次以上派送量
from
    (
        select
            t1.pno
            ,t1.dst_store 目的地网点
            ,t1.dst_store_id 目的网点ID
            ,t1.dst_piece 目的地片区
            ,t1.dst_region 目的地大区
            ,case t1.state
                when '1' then '已揽收'
                when '2' then '运输中'
                when '3' then '派送中'
                when '4' then '已滞留'
                when '5' then '已签收'
                when '6' then '疑难件处理中'
                when '7' then '已退件'
                when '8' then '异常关闭'
                when '9' then '已撤销'
            end as `包裹状态`
            ,t1.dst_phone 收件人电话
            ,t1.dst_home_phone 收件人家庭电话
            ,count(distinct ppd.mark_date) 尝试天数
        from t t1
        left join
            (
                select
                    td.pno
                    ,date(convert_tz(tdm.created_at, '+00:00', '+08:00')) mark_date
                from ph_staging.ticket_delivery td
                join t t1 on t1.pno = td.pno
                left join ph_staging.ticket_delivery_marker tdm on tdm.delivery_id = td.id
                where
                    if(t1.change_store = 'n', 1 = 1, tdm.created_at > t1.pcd_create_at)
                group by 1,2
            ) mark on mark.pno = t1.pno
        left join
            (
                select
                    ppd.pno
                    ,date(convert_tz(ppd.created_at, '+00:00', '+08:00')) mark_date
                from ph_staging.parcel_problem_detail ppd
                join t t1 on t1.pno = ppd.pno
                where
                    ppd.diff_marker_category not in (7,22,5,20,6,21,15,71)
                    and if(t1.change_store = 'n', 1 = 1, ppd.created_at > t1.pcd_create_at)
                group by 1,2
            ) ppd on ppd.pno = mark.pno and mark.mark_date = ppd.mark_date
        where
            ppd.mark_date is not null
        group by 1
    ) a;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        de.pno
        ,de.dst_store_id
        ,de.dst_store
        ,de.dst_region
        ,de.dst_piece
        ,pi.state
        ,pi.dst_phone
        ,pi.dst_home_phone
        ,if(pcd.pno is not null , 'y', 'n') change_store
        ,max(pcd.created_at) pcd_create_at
    from ph_staging.parcel_info pi
    left join dwm.dwd_ex_ph_parcel_details de on de.pno = pi.pno
    left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
    left join ph_staging.parcel_route pr on pr.pno = de.pno and pr.route_action = 'PENDING_RETURN'
    left join ph_staging.parcel_change_detail pcd on pcd.pno = pi.pno and pcd.field_name = 'dst_store_id' and pcd.new_value != pcd.old_value
    where
        pi.state not in (5,7,8,9)
        and bc.client_id is null
        and pr.pno is null
    group by 1
)
select
    count(if(a.尝试天数 = 3, a.pno, null)) 3次派送量
    ,count(if(a.尝试天数 > 3, a.pno, null)) 3次以上派送量
from
    (
        select
            t1.pno
            ,t1.dst_store 目的地网点
            ,t1.dst_store_id 目的网点ID
            ,t1.dst_piece 目的地片区
            ,t1.dst_region 目的地大区
            ,case t1.state
                when '1' then '已揽收'
                when '2' then '运输中'
                when '3' then '派送中'
                when '4' then '已滞留'
                when '5' then '已签收'
                when '6' then '疑难件处理中'
                when '7' then '已退件'
                when '8' then '异常关闭'
                when '9' then '已撤销'
            end as `包裹状态`
            ,t1.dst_phone 收件人电话
            ,t1.dst_home_phone 收件人家庭电话
            ,count(distinct ppd.mark_date) 尝试天数
        from t t1
        left join
            (
                select
                    td.pno
                    ,date(convert_tz(tdm.created_at, '+00:00', '+08:00')) mark_date
                from ph_staging.ticket_delivery td
                join t t1 on t1.pno = td.pno
                left join ph_staging.ticket_delivery_marker tdm on tdm.delivery_id = td.id
                where
                    if(t1.change_store = 'n', 1 = 1, tdm.created_at > t1.pcd_create_at)
                group by 1,2
            ) mark on mark.pno = t1.pno
        left join
            (
                select
                    ppd.pno
                    ,date(convert_tz(ppd.created_at, '+00:00', '+08:00')) mark_date
                from ph_staging.parcel_problem_detail ppd
                join t t1 on t1.pno = ppd.pno
                where
                    ppd.diff_marker_category not in (7,22,5,20,6,21,15,71)
                    and if(t1.change_store = 'n', 1 = 1, ppd.created_at > t1.pcd_create_at)
                group by 1,2
            ) ppd on ppd.pno = mark.pno and mark.mark_date = ppd.mark_date
        where
            ppd.mark_date is not null
        group by 1
    ) a;
;-- -. . -..- - / . -. - .-. -.--
select
    hsi.staff_info_id 员工ID
    ,hsi.name 姓名
    ,ss.name  网点
    ,hjt.job_name 职级
    ,hsi.mobile 联系电话
from ph_bi.hr_staff_info hsi
left join ph_staging.sys_store ss on ss.id = hsi.sys_store_id
left join ph_bi.hr_job_title hjt on hjt.id = hsi.job_title
where
    ss.name  in ('CLK_SP' ,'CUT_SP')
    and hsi.state = 1;
;-- -. . -..- - / . -. - .-. -.--
select
    hsi.staff_info_id 员工ID
    ,hsi.name 姓名
    ,ss.name  网点
    ,hjt.job_name 职级
    ,hsi.mobile 联系电话
from ph_bi.hr_staff_info hsi
left join ph_staging.sys_store ss on ss.id = hsi.sys_store_id
left join ph_bi.hr_job_title hjt on hjt.id = hsi.job_title
where
    ss.name  in ('CLK_SP' ,'CUT_SP')
    and hsi.state = 1
    and is_sub_staff = 0;
;-- -. . -..- - / . -. - .-. -.--
select
    t.*
    ,case
        when cdt.state != 1 and cdt.created_at > date_add(t.date_d, interval 16 hour ) then 'n'
        when cdt.state != 1 and cdt.created_at <= date_add(t.date_d, interval 16 hour ) then 'y'
        when cdt.state = 1 and cdt.created_at < date_add(t.date_d, interval 16 hour ) and cdt.updated_at > date_sub(t.date_d, interval 8 hour) then 'y'
        else 'n'
    end diff_or_not
from tmpale.tmp_ph_pno_lj_0808 t
left join ph_staging.diff_info di on di.pno = t.pno
left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id;
;-- -. . -..- - / . -. - .-. -.--
with a as
(
    select
        coalesce(a.client_name, '总计') client_name
        ,coalesce(a.疑难件原因, '总计') 疑难件原因
        ,a.`0-2小时`
        ,a.`2-4小时`
        ,a.`4-6小时`
        ,a.`6小时以上`
        ,a.总疑难件量
        ,a.继续配送
        ,a.退货
        ,a.平均处理时长_h
    from
        (
            select
                 case
                    when bc.`client_id` is not null then bc.client_name
                    when kp.id is not null and bc.client_id is null then '普通ka'
                    when kp.`id` is null then '小c'
                end client_name
                ,case di.diff_marker_category # 疑难原因
                    when 1 then '客户不在家/电话无人接听'
                    when 2 then '收件人拒收'
                    when 3 then '快件分错网点'
                    when 4 then '外包装破损'
                    when 5 then '货物破损'
                    when 6 then '货物短少'
                    when 7 then '货物丢失'
                    when 8 then '电话联系不上'
                    when 9 then '客户改约时间'
                    when 10 then '客户不在'
                    when 11 then '客户取消任务'
                    when 12 then '无人签收'
                    when 13 then '客户周末或假期不收货'
                    when 14 then '客户改约时间'
                    when 15 then '当日运力不足，无法派送'
                    when 16 then '联系不上收件人'
                    when 17 then '收件人拒收'
                    when 18 then '快件分错网点'
                    when 19 then '外包装破损'
                    when 20 then '货物破损'
                    when 21 then '货物短少'
                    when 22 then '货物丢失'
                    when 23 then '详细地址错误'
                    when 24 then '收件地址已废弃或不存在'
                    when 25 then '收件人电话号码错误'
                    when 26 then 'cod金额不正确'
                    when 27 then '无实际包裹'
                    when 28 then '已妥投未交接'
                    when 29 then '收件人电话号码是空号'
                    when 30 then '送错网点'
                    when 31 then '省市乡邮编错误'
                    when 32 then '禁运品'
                    when 33 then '严重破损（丢弃）'
                    when 34 then '退件两次尝试派送失败'
                    when 35 then '不能打开locker'
                    when 36 then 'locker不能使用'
                    when 37 then '该地址找不到lockerstation'
                    when 38 then '一票多件'
                    when 39 then '多次尝试派件失败'
                    when 40 then '客户不在家/电话无人接听'
                    when 41 then '错过班车时间'
                    when 42 then '目的地是偏远地区,留仓待次日派送'
                    when 43 then '目的地是岛屿,留仓待次日派送'
                    when 44 then '企业/机构当天已下班'
                    when 45 then '子母件包裹未全部到达网点'
                    when 46 then '不可抗力原因留仓(台风)'
                    when 47 then '虚假包裹'
                    when 50 then '客户取消寄件'
                    when 51 then '信息录入错误'
                    when 52 then '客户取消寄件'
                    when 53 then 'lazada仓库拒收'
                    when 69 then '禁运品'
                    when 70 then '客户改约时间'
                    when 71 then '当日运力不足，无法派送'
                    when 72 then '客户周末或假期不收货'
                    when 73 then '详细地址错误'
                    when 74 then '收件地址已废弃或不存在'
                    when 75 then '收件人电话号码错误'
                    when 76 then 'cod金额不正确'
                    when 77 then '企业/机构当天已下班'
                    when 78 then '收件人电话号码是空号'
                    when 79 then '快件分错网点-地址错误'
                    when 80 then '客户取消任务'
                    when 81 then '重复下单'
                    when 82 then '已完成揽件'
                    when 83 then '联系不上客户'
                    when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 85 then '寄件人电话号码是空号'
                    when 86 then '包裹不符合揽收条件超大件'
                    when 87 then '包裹不符合揽收条件违禁品'
                    when 88 then '寄件人地址为岛屿'
                    when 89 then '运力短缺，跟客户协商推迟揽收'
                    when 90 then '包裹未准备好推迟揽收'
                    when 91 then '包裹包装不符合运输标准'
                    when 92 then '客户提供的清单里没有此包裹'
                    when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 94 then '客户取消寄件/客户实际不想寄此包裹'
                    when 95 then '车辆/人力短缺推迟揽收'
                    when 96 then '遗漏揽收(已停用)'
                    when 97 then '子母件(一个单号多个包裹)'
                    when 98 then '地址错误addresserror'
                    when 99 then '包裹不符合揽收条件：超大件'
                    when 100 then '包裹不符合揽收条件：违禁品'
                    when 101 then '包裹包装不符合运输标准'
                    when 102 then '包裹未准备好'
                    when 103 then '运力短缺，跟客户协商推迟揽收'
                    when 104 then '子母件(一个单号多个包裹)'
                    when 105 then '破损包裹'
                    when 106 then '空包裹'
                    when 107 then '不能打开locker(密码错误)'
                    when 108 then 'locker不能使用'
                    when 109 then 'locker找不到'
                    when 110 then '运单号与实际包裹的单号不一致'
                    when 111 then 'box客户取消任务'
                    when 112 then '不能打开locker(密码错误)'
                    when 113 then 'locker不能使用'
                    when 114 then 'locker找不到'
                    when 115 then '实际重量尺寸大于客户下单的重量尺寸'
                    when 116 then '客户仓库关闭'
                    when 117 then '客户仓库关闭'
                    when 118 then 'SHOPEE订单系统自动关闭'
                    when 119 then '客户取消包裹'
                    when 121 then '地址错误'
                    when 122 then '当日运力不足，无法揽收'
                end as 疑难件原因
                ,count(if(cdt.negotiation_result_category = 5, di.id, null)) 继续配送
                ,count(if(cdt.negotiation_result_category = 3, di.id, null)) 退货
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 < 2, di.id, null)) '0-2小时'
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 >= 2 and timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 < 4 , di.id, null)) '2-4小时'
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 >= 4 and timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 < 6, di.id, null )) '4-6小时'
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 >= 6 , di.id, null )) '6小时以上'
                ,sum(if(cdt.operator_id not in (10000,10001,100002), timestampdiff(second , cdt.created_at, cdt.updated_at)/3600, null))/count(if(cdt.operator_id not in (10000,10001,100002), di.id, null)) 平均处理时长_h
                ,count(di.id) 总疑难件量
            from ph_staging.diff_info di
            left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
            left join ph_staging.store_diff_ticket sdt on sdt.diff_info_id = di.id
#             left join dwm.dwd_dim_dict tdt2 on di.diff_marker_category= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category' -- 标记原因
            left join ph_staging.parcel_info pi on pi.pno = di.pno
            left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id and bc.client_name in ('lazada', 'shopee', 'tiktok')
            left join ph_staging.ka_profile kp on kp.id = pi.client_id
            where
                di.updated_at >= date_sub('2023-08-08', interval 8 hour )
                and di.updated_at < date_add('2023-08-08', interval 16 hour ) -- 今日处理
                and cdt.state = 1 -- 已处理
                and di.diff_marker_category not in (7,22,5,20,6,21,15,71)
            group by 1,2
            with rollup
        ) a
    order by 1,2
)
, b as
(
    select
        coalesce(a2.client_name, '总计') client_name
        ,coalesce(a2.疑难件原因, '总计') 疑难件原因
        ,a2.`20-9单量`
        ,a2.`前日20-今日9点处理完成量`
        ,a2.`20-9点11点处理完成量`
        ,a2.`9-20单量`
        ,a2.`9-20已处理单量`
        ,a2.`9-20已处理2小时内量`
    from
        (
           select
                case
                    when bc.`client_id` is not null then bc.client_name
                    when kp.id is not null and bc.client_id is null then '普通ka'
                    when kp.`id` is null then '小c'
                end client_name
                ,case di.diff_marker_category
                    when 1 then '客户不在家/电话无人接听'
                    when 2 then '收件人拒收'
                    when 3 then '快件分错网点'
                    when 4 then '外包装破损'
                    when 5 then '货物破损'
                    when 6 then '货物短少'
                    when 7 then '货物丢失'
                    when 8 then '电话联系不上'
                    when 9 then '客户改约时间'
                    when 10 then '客户不在'
                    when 11 then '客户取消任务'
                    when 12 then '无人签收'
                    when 13 then '客户周末或假期不收货'
                    when 14 then '客户改约时间'
                    when 15 then '当日运力不足，无法派送'
                    when 16 then '联系不上收件人'
                    when 17 then '收件人拒收'
                    when 18 then '快件分错网点'
                    when 19 then '外包装破损'
                    when 20 then '货物破损'
                    when 21 then '货物短少'
                    when 22 then '货物丢失'
                    when 23 then '详细地址错误'
                    when 24 then '收件地址已废弃或不存在'
                    when 25 then '收件人电话号码错误'
                    when 26 then 'cod金额不正确'
                    when 27 then '无实际包裹'
                    when 28 then '已妥投未交接'
                    when 29 then '收件人电话号码是空号'
                    when 30 then '送错网点'
                    when 31 then '省市乡邮编错误'
                    when 32 then '禁运品'
                    when 33 then '严重破损（丢弃）'
                    when 34 then '退件两次尝试派送失败'
                    when 35 then '不能打开locker'
                    when 36 then 'locker不能使用'
                    when 37 then '该地址找不到lockerstation'
                    when 38 then '一票多件'
                    when 39 then '多次尝试派件失败'
                    when 40 then '客户不在家/电话无人接听'
                    when 41 then '错过班车时间'
                    when 42 then '目的地是偏远地区,留仓待次日派送'
                    when 43 then '目的地是岛屿,留仓待次日派送'
                    when 44 then '企业/机构当天已下班'
                    when 45 then '子母件包裹未全部到达网点'
                    when 46 then '不可抗力原因留仓(台风)'
                    when 47 then '虚假包裹'
                    when 50 then '客户取消寄件'
                    when 51 then '信息录入错误'
                    when 52 then '客户取消寄件'
                    when 53 then 'lazada仓库拒收'
                    when 69 then '禁运品'
                    when 70 then '客户改约时间'
                    when 71 then '当日运力不足，无法派送'
                    when 72 then '客户周末或假期不收货'
                    when 73 then '详细地址错误'
                    when 74 then '收件地址已废弃或不存在'
                    when 75 then '收件人电话号码错误'
                    when 76 then 'cod金额不正确'
                    when 77 then '企业/机构当天已下班'
                    when 78 then '收件人电话号码是空号'
                    when 79 then '快件分错网点-地址错误'
                    when 80 then '客户取消任务'
                    when 81 then '重复下单'
                    when 82 then '已完成揽件'
                    when 83 then '联系不上客户'
                    when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 85 then '寄件人电话号码是空号'
                    when 86 then '包裹不符合揽收条件超大件'
                    when 87 then '包裹不符合揽收条件违禁品'
                    when 88 then '寄件人地址为岛屿'
                    when 89 then '运力短缺，跟客户协商推迟揽收'
                    when 90 then '包裹未准备好推迟揽收'
                    when 91 then '包裹包装不符合运输标准'
                    when 92 then '客户提供的清单里没有此包裹'
                    when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 94 then '客户取消寄件/客户实际不想寄此包裹'
                    when 95 then '车辆/人力短缺推迟揽收'
                    when 96 then '遗漏揽收(已停用)'
                    when 97 then '子母件(一个单号多个包裹)'
                    when 98 then '地址错误addresserror'
                    when 99 then '包裹不符合揽收条件：超大件'
                    when 100 then '包裹不符合揽收条件：违禁品'
                    when 101 then '包裹包装不符合运输标准'
                    when 102 then '包裹未准备好'
                    when 103 then '运力短缺，跟客户协商推迟揽收'
                    when 104 then '子母件(一个单号多个包裹)'
                    when 105 then '破损包裹'
                    when 106 then '空包裹'
                    when 107 then '不能打开locker(密码错误)'
                    when 108 then 'locker不能使用'
                    when 109 then 'locker找不到'
                    when 110 then '运单号与实际包裹的单号不一致'
                    when 111 then 'box客户取消任务'
                    when 112 then '不能打开locker(密码错误)'
                    when 113 then 'locker不能使用'
                    when 114 then 'locker找不到'
                    when 115 then '实际重量尺寸大于客户下单的重量尺寸'
                    when 116 then '客户仓库关闭'
                    when 117 then '客户仓库关闭'
                    when 118 then 'SHOPEE订单系统自动关闭'
                    when 119 then '客户取消包裹'
                    when 121 then '地址错误'
                    when 122 then '当日运力不足，无法揽收'
                end as 疑难件原因
                ,count(if(di.created_at >= date_sub('2023-08-08', interval 12 hour) and di.created_at < date_add('2023-08-08', interval  1 hour), di.id, null)) '20-9单量'
                ,count(if(di.created_at >= date_sub('2023-08-08', interval 12 hour) and di.created_at < date_add('2023-08-08', interval  1 hour) and cdt.state = 1 , di.id, null)) '前日20-今日9点处理完成量'
                ,count(if(di.created_at >= date_sub('2023-08-08', interval 12 hour) and di.created_at < date_add('2023-08-08', interval  1 hour) and cdt.state = 1 and cdt.updated_at < date_add('2023-08-08', interval  3 hour ) , di.id, null)) '20-9点11点处理完成量'
                ,count(if(di.created_at >= date_add('2023-08-08', interval  1 hour) and di.created_at < date_add('2023-08-08', interval 12 hour), di.id, null)) '9-20单量'
                ,count(if(di.created_at >= date_add('2023-08-08', interval  1 hour) and di.created_at < date_add('2023-08-08', interval 12 hour) and cdt.state = 1 , di.id, null)) '9-20已处理单量'
                ,count(if(di.created_at >= date_add('2023-08-08', interval  1 hour) and di.created_at < date_add('2023-08-08', interval 12 hour) and cdt.state = 1 and cdt.updated_at < date_add(di.created_at, interval  2 hour ), di.id, null)) '9-20已处理2小时内量'
            from ph_staging.diff_info di
            join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
            left join ph_staging.store_diff_ticket sdt2 on sdt2.diff_info_id = di.id
#             left join dwm.dwd_dim_dict tdt2 on di.diff_marker_category= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category' -- 标记原因
            left join ph_staging.parcel_info pi on pi.pno = di.pno
            left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id and bc.client_name in ('lazada', 'shopee', 'tiktok')
            left join ph_staging.ka_profile kp on kp.id = pi.client_id
            left join nl_production.violation_return_visit vrv on vrv.link_id = di.pno and vrv.type = 8 and vrv.created_at >= date_add(di.created_at, interval 8 hour)
            where
                di.diff_marker_category not in (7,22,5,20,6,21,15,71)
                and di.created_at >= date_sub('2023-08-08', interval 12 hour)
                and di.created_at < date_add('2023-08-08', interval 12 hour )
                and vrv.link_id is null
            group by 1,2
            with rollup
        ) a2
)
select
    t1.client_name
    ,t1.疑难件原因
    ,a1.`0-2小时`
    ,a1.`2-4小时`
    ,a1.`4-6小时`
    ,a1.`6小时以上`
    ,a1.继续配送
    ,a1.退货
    ,a1.平均处理时长_h
    ,a1.总疑难件量
    ,b1.`20-9单量`
    ,b1.`前日20-今日9点处理完成量`
    ,b1.`20-9点11点处理完成量`
    ,b1.`9-20单量`
    ,b1.`9-20已处理单量`
    ,b1.`9-20已处理2小时内量`
from
    (
        select
            t1.疑难件原因
            ,t1.client_name
        from
            (
                select
                    a.client_name
                    ,a.疑难件原因
                from a

                union

                select
                    b.client_name
                    ,b.疑难件原因
                from b
            ) t1
        group by 1,2
    ) t1
left join a a1 on t1.client_name = a1.client_name and t1.疑难件原因 = a1.疑难件原因
left join b b1 on t1.client_name = b1.client_name and t1.疑难件原因 = b1.疑难件原因
order by t1.client_name,case t1.疑难件原因
                            when '总计' then 1
                            when '详细地址错误' then 2
                            when '收件人电话号码是空号' then 3
                            when '收件人电话号码错误' then 4
                            when '省市乡邮编错误' then 5
                            when '收件人拒收' then 6
                        end;
;-- -. . -..- - / . -. - .-. -.--
with a as
(
    select
        coalesce(a.client_name, '总计') client_name
        ,coalesce(a.疑难件原因, '总计') 疑难件原因
        ,a.`0-2小时`
        ,a.`2-4小时`
        ,a.`4-6小时`
        ,a.`6小时以上`
        ,a.总疑难件量
        ,a.继续配送
        ,a.退货
        ,a.平均处理时长_h
    from
        (
            select
                 case
                    when bc.`client_id` is not null then bc.client_name
                    when kp.id is not null and bc.client_id is null then '普通ka'
                    when kp.`id` is null then '小c'
                end client_name
                ,case di.diff_marker_category # 疑难原因
                    when 1 then '客户不在家/电话无人接听'
                    when 2 then '收件人拒收'
                    when 3 then '快件分错网点'
                    when 4 then '外包装破损'
                    when 5 then '货物破损'
                    when 6 then '货物短少'
                    when 7 then '货物丢失'
                    when 8 then '电话联系不上'
                    when 9 then '客户改约时间'
                    when 10 then '客户不在'
                    when 11 then '客户取消任务'
                    when 12 then '无人签收'
                    when 13 then '客户周末或假期不收货'
                    when 14 then '客户改约时间'
                    when 15 then '当日运力不足，无法派送'
                    when 16 then '联系不上收件人'
                    when 17 then '收件人拒收'
                    when 18 then '快件分错网点'
                    when 19 then '外包装破损'
                    when 20 then '货物破损'
                    when 21 then '货物短少'
                    when 22 then '货物丢失'
                    when 23 then '详细地址错误'
                    when 24 then '收件地址已废弃或不存在'
                    when 25 then '收件人电话号码错误'
                    when 26 then 'cod金额不正确'
                    when 27 then '无实际包裹'
                    when 28 then '已妥投未交接'
                    when 29 then '收件人电话号码是空号'
                    when 30 then '送错网点'
                    when 31 then '省市乡邮编错误'
                    when 32 then '禁运品'
                    when 33 then '严重破损（丢弃）'
                    when 34 then '退件两次尝试派送失败'
                    when 35 then '不能打开locker'
                    when 36 then 'locker不能使用'
                    when 37 then '该地址找不到lockerstation'
                    when 38 then '一票多件'
                    when 39 then '多次尝试派件失败'
                    when 40 then '客户不在家/电话无人接听'
                    when 41 then '错过班车时间'
                    when 42 then '目的地是偏远地区,留仓待次日派送'
                    when 43 then '目的地是岛屿,留仓待次日派送'
                    when 44 then '企业/机构当天已下班'
                    when 45 then '子母件包裹未全部到达网点'
                    when 46 then '不可抗力原因留仓(台风)'
                    when 47 then '虚假包裹'
                    when 50 then '客户取消寄件'
                    when 51 then '信息录入错误'
                    when 52 then '客户取消寄件'
                    when 53 then 'lazada仓库拒收'
                    when 69 then '禁运品'
                    when 70 then '客户改约时间'
                    when 71 then '当日运力不足，无法派送'
                    when 72 then '客户周末或假期不收货'
                    when 73 then '详细地址错误'
                    when 74 then '收件地址已废弃或不存在'
                    when 75 then '收件人电话号码错误'
                    when 76 then 'cod金额不正确'
                    when 77 then '企业/机构当天已下班'
                    when 78 then '收件人电话号码是空号'
                    when 79 then '快件分错网点-地址错误'
                    when 80 then '客户取消任务'
                    when 81 then '重复下单'
                    when 82 then '已完成揽件'
                    when 83 then '联系不上客户'
                    when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 85 then '寄件人电话号码是空号'
                    when 86 then '包裹不符合揽收条件超大件'
                    when 87 then '包裹不符合揽收条件违禁品'
                    when 88 then '寄件人地址为岛屿'
                    when 89 then '运力短缺，跟客户协商推迟揽收'
                    when 90 then '包裹未准备好推迟揽收'
                    when 91 then '包裹包装不符合运输标准'
                    when 92 then '客户提供的清单里没有此包裹'
                    when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 94 then '客户取消寄件/客户实际不想寄此包裹'
                    when 95 then '车辆/人力短缺推迟揽收'
                    when 96 then '遗漏揽收(已停用)'
                    when 97 then '子母件(一个单号多个包裹)'
                    when 98 then '地址错误addresserror'
                    when 99 then '包裹不符合揽收条件：超大件'
                    when 100 then '包裹不符合揽收条件：违禁品'
                    when 101 then '包裹包装不符合运输标准'
                    when 102 then '包裹未准备好'
                    when 103 then '运力短缺，跟客户协商推迟揽收'
                    when 104 then '子母件(一个单号多个包裹)'
                    when 105 then '破损包裹'
                    when 106 then '空包裹'
                    when 107 then '不能打开locker(密码错误)'
                    when 108 then 'locker不能使用'
                    when 109 then 'locker找不到'
                    when 110 then '运单号与实际包裹的单号不一致'
                    when 111 then 'box客户取消任务'
                    when 112 then '不能打开locker(密码错误)'
                    when 113 then 'locker不能使用'
                    when 114 then 'locker找不到'
                    when 115 then '实际重量尺寸大于客户下单的重量尺寸'
                    when 116 then '客户仓库关闭'
                    when 117 then '客户仓库关闭'
                    when 118 then 'SHOPEE订单系统自动关闭'
                    when 119 then '客户取消包裹'
                    when 121 then '地址错误'
                    when 122 then '当日运力不足，无法揽收'
                end as 疑难件原因
                ,count(if(cdt.negotiation_result_category = 5, di.id, null)) 继续配送
                ,count(if(cdt.negotiation_result_category = 3, di.id, null)) 退货
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 < 2, di.id, null)) '0-2小时'
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 >= 2 and timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 < 4 , di.id, null)) '2-4小时'
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 >= 4 and timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 < 6, di.id, null )) '4-6小时'
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 >= 6 , di.id, null )) '6小时以上'
                ,sum(if(cdt.operator_id not in (10000,10001,100002), timestampdiff(second , cdt.created_at, cdt.updated_at)/3600, null))/count(if(cdt.operator_id not in (10000,10001,100002), di.id, null)) 平均处理时长_h
                ,count(di.id) 总疑难件量
            from ph_staging.diff_info di
            left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
            left join ph_staging.store_diff_ticket sdt on sdt.diff_info_id = di.id
#             left join dwm.dwd_dim_dict tdt2 on di.diff_marker_category= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category' -- 标记原因
            left join ph_staging.parcel_info pi on pi.pno = di.pno
            left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id and bc.client_name in ('lazada', 'shopee', 'tiktok')
            left join ph_staging.ka_profile kp on kp.id = pi.client_id
            where
                di.updated_at >= date_sub('2023-08-08', interval 8 hour )
                and di.updated_at < date_add('2023-08-08', interval 16 hour ) -- 今日处理
                and cdt.state = 1 -- 已处理
                and di.diff_marker_category not in (7,22,5,20,6,21,15,71,34)
            group by 1,2
            with rollup
        ) a
    order by 1,2
)
, b as
(
    select
        coalesce(a2.client_name, '总计') client_name
        ,coalesce(a2.疑难件原因, '总计') 疑难件原因
        ,a2.`20-9单量`
        ,a2.`前日20-今日9点处理完成量`
        ,a2.`20-9点11点处理完成量`
        ,a2.`9-20单量`
        ,a2.`9-20已处理单量`
        ,a2.`9-20已处理2小时内量`
    from
        (
           select
                case
                    when bc.`client_id` is not null then bc.client_name
                    when kp.id is not null and bc.client_id is null then '普通ka'
                    when kp.`id` is null then '小c'
                end client_name
                ,case di.diff_marker_category
                    when 1 then '客户不在家/电话无人接听'
                    when 2 then '收件人拒收'
                    when 3 then '快件分错网点'
                    when 4 then '外包装破损'
                    when 5 then '货物破损'
                    when 6 then '货物短少'
                    when 7 then '货物丢失'
                    when 8 then '电话联系不上'
                    when 9 then '客户改约时间'
                    when 10 then '客户不在'
                    when 11 then '客户取消任务'
                    when 12 then '无人签收'
                    when 13 then '客户周末或假期不收货'
                    when 14 then '客户改约时间'
                    when 15 then '当日运力不足，无法派送'
                    when 16 then '联系不上收件人'
                    when 17 then '收件人拒收'
                    when 18 then '快件分错网点'
                    when 19 then '外包装破损'
                    when 20 then '货物破损'
                    when 21 then '货物短少'
                    when 22 then '货物丢失'
                    when 23 then '详细地址错误'
                    when 24 then '收件地址已废弃或不存在'
                    when 25 then '收件人电话号码错误'
                    when 26 then 'cod金额不正确'
                    when 27 then '无实际包裹'
                    when 28 then '已妥投未交接'
                    when 29 then '收件人电话号码是空号'
                    when 30 then '送错网点'
                    when 31 then '省市乡邮编错误'
                    when 32 then '禁运品'
                    when 33 then '严重破损（丢弃）'
                    when 34 then '退件两次尝试派送失败'
                    when 35 then '不能打开locker'
                    when 36 then 'locker不能使用'
                    when 37 then '该地址找不到lockerstation'
                    when 38 then '一票多件'
                    when 39 then '多次尝试派件失败'
                    when 40 then '客户不在家/电话无人接听'
                    when 41 then '错过班车时间'
                    when 42 then '目的地是偏远地区,留仓待次日派送'
                    when 43 then '目的地是岛屿,留仓待次日派送'
                    when 44 then '企业/机构当天已下班'
                    when 45 then '子母件包裹未全部到达网点'
                    when 46 then '不可抗力原因留仓(台风)'
                    when 47 then '虚假包裹'
                    when 50 then '客户取消寄件'
                    when 51 then '信息录入错误'
                    when 52 then '客户取消寄件'
                    when 53 then 'lazada仓库拒收'
                    when 69 then '禁运品'
                    when 70 then '客户改约时间'
                    when 71 then '当日运力不足，无法派送'
                    when 72 then '客户周末或假期不收货'
                    when 73 then '详细地址错误'
                    when 74 then '收件地址已废弃或不存在'
                    when 75 then '收件人电话号码错误'
                    when 76 then 'cod金额不正确'
                    when 77 then '企业/机构当天已下班'
                    when 78 then '收件人电话号码是空号'
                    when 79 then '快件分错网点-地址错误'
                    when 80 then '客户取消任务'
                    when 81 then '重复下单'
                    when 82 then '已完成揽件'
                    when 83 then '联系不上客户'
                    when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 85 then '寄件人电话号码是空号'
                    when 86 then '包裹不符合揽收条件超大件'
                    when 87 then '包裹不符合揽收条件违禁品'
                    when 88 then '寄件人地址为岛屿'
                    when 89 then '运力短缺，跟客户协商推迟揽收'
                    when 90 then '包裹未准备好推迟揽收'
                    when 91 then '包裹包装不符合运输标准'
                    when 92 then '客户提供的清单里没有此包裹'
                    when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 94 then '客户取消寄件/客户实际不想寄此包裹'
                    when 95 then '车辆/人力短缺推迟揽收'
                    when 96 then '遗漏揽收(已停用)'
                    when 97 then '子母件(一个单号多个包裹)'
                    when 98 then '地址错误addresserror'
                    when 99 then '包裹不符合揽收条件：超大件'
                    when 100 then '包裹不符合揽收条件：违禁品'
                    when 101 then '包裹包装不符合运输标准'
                    when 102 then '包裹未准备好'
                    when 103 then '运力短缺，跟客户协商推迟揽收'
                    when 104 then '子母件(一个单号多个包裹)'
                    when 105 then '破损包裹'
                    when 106 then '空包裹'
                    when 107 then '不能打开locker(密码错误)'
                    when 108 then 'locker不能使用'
                    when 109 then 'locker找不到'
                    when 110 then '运单号与实际包裹的单号不一致'
                    when 111 then 'box客户取消任务'
                    when 112 then '不能打开locker(密码错误)'
                    when 113 then 'locker不能使用'
                    when 114 then 'locker找不到'
                    when 115 then '实际重量尺寸大于客户下单的重量尺寸'
                    when 116 then '客户仓库关闭'
                    when 117 then '客户仓库关闭'
                    when 118 then 'SHOPEE订单系统自动关闭'
                    when 119 then '客户取消包裹'
                    when 121 then '地址错误'
                    when 122 then '当日运力不足，无法揽收'
                end as 疑难件原因
                ,count(if(di.created_at >= date_sub('2023-08-08', interval 12 hour) and di.created_at < date_add('2023-08-08', interval  1 hour), di.id, null)) '20-9单量'
                ,count(if(di.created_at >= date_sub('2023-08-08', interval 12 hour) and di.created_at < date_add('2023-08-08', interval  1 hour) and cdt.state = 1 , di.id, null)) '前日20-今日9点处理完成量'
                ,count(if(di.created_at >= date_sub('2023-08-08', interval 12 hour) and di.created_at < date_add('2023-08-08', interval  1 hour) and cdt.state = 1 and cdt.updated_at < date_add('2023-08-08', interval  3 hour ) , di.id, null)) '20-9点11点处理完成量'
                ,count(if(di.created_at >= date_add('2023-08-08', interval  1 hour) and di.created_at < date_add('2023-08-08', interval 12 hour), di.id, null)) '9-20单量'
                ,count(if(di.created_at >= date_add('2023-08-08', interval  1 hour) and di.created_at < date_add('2023-08-08', interval 12 hour) and cdt.state = 1 , di.id, null)) '9-20已处理单量'
                ,count(if(di.created_at >= date_add('2023-08-08', interval  1 hour) and di.created_at < date_add('2023-08-08', interval 12 hour) and cdt.state = 1 and cdt.updated_at < date_add(di.created_at, interval  2 hour ), di.id, null)) '9-20已处理2小时内量'
            from ph_staging.diff_info di
            join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
            left join ph_staging.store_diff_ticket sdt2 on sdt2.diff_info_id = di.id
#             left join dwm.dwd_dim_dict tdt2 on di.diff_marker_category= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category' -- 标记原因
            left join ph_staging.parcel_info pi on pi.pno = di.pno
            left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id and bc.client_name in ('lazada', 'shopee', 'tiktok')
            left join ph_staging.ka_profile kp on kp.id = pi.client_id
            left join nl_production.violation_return_visit vrv on vrv.link_id = di.pno and vrv.type = 8 and vrv.created_at >= date_add(di.created_at, interval 8 hour)
            where
                di.diff_marker_category not in (7,22,5,20,6,21,15,71,34)
                and di.created_at >= date_sub('2023-08-08', interval 12 hour)
                and di.created_at < date_add('2023-08-08', interval 12 hour )
                and vrv.link_id is null
            group by 1,2
            with rollup
        ) a2
)
select
    t1.client_name
    ,t1.疑难件原因
    ,a1.`0-2小时`
    ,a1.`2-4小时`
    ,a1.`4-6小时`
    ,a1.`6小时以上`
    ,a1.继续配送
    ,a1.退货
    ,a1.平均处理时长_h
    ,a1.总疑难件量
    ,b1.`20-9单量`
    ,b1.`前日20-今日9点处理完成量`
    ,b1.`20-9点11点处理完成量`
    ,b1.`9-20单量`
    ,b1.`9-20已处理单量`
    ,b1.`9-20已处理2小时内量`
from
    (
        select
            t1.疑难件原因
            ,t1.client_name
        from
            (
                select
                    a.client_name
                    ,a.疑难件原因
                from a

                union

                select
                    b.client_name
                    ,b.疑难件原因
                from b
            ) t1
        group by 1,2
    ) t1
left join a a1 on t1.client_name = a1.client_name and t1.疑难件原因 = a1.疑难件原因
left join b b1 on t1.client_name = b1.client_name and t1.疑难件原因 = b1.疑难件原因
order by t1.client_name,case t1.疑难件原因
                            when '总计' then 1
                            when '详细地址错误' then 2
                            when '收件人电话号码是空号' then 3
                            when '收件人电话号码错误' then 4
                            when '省市乡邮编错误' then 5
                            when '收件人拒收' then 6
                        end;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.CT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-08-08'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.CT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-08-08'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-08-08', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with d as
(
    select
         ds.dst_store_id store_id
        ,ds.pno
        ,ds.p_date stat_date
    from dwm.dwd_ph_dc_should_be_delivery ds
    where
        ds.should_delevry_type = '1派应派包裹'
        and ds.p_date = '2023-08-08'
)
, t as
(
    select
         ds.store_id
        ,ds.pno
        ,ds.stat_date
    from d ds
    left join
        (
            select
                pr.pno
                ,ds.stat_date
                ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
            from ph_staging.parcel_route pr
            join d ds on pr.pno = ds.pno
            where 1=1
                and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                and pr.route_action = 'DETAIN_WAREHOUSE'
                and pr.marker_category in (42,43) ##岛屿,偏远地区
            group by 1,2
        ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
    left join
        (
            select
               pr.pno
                ,ds.stat_date
               ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
               ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
            from ph_staging.parcel_route pr
            join d ds on ds.pno = pr.pno
            where 1=1
                and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                and pr.route_action = 'DETAIN_WAREHOUSE'
                and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                and pr.marker_category in (9,14,70) ##客户改约时间
        ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
    left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
    where
        case
            when pr1.pno is not null then 'N'
            when pr2.pno is not null then 'N'
            when ds1.pno is not null  then 'N'  else 'Y'
        end = 'Y'
)
select
    a.stat_date 日期
    ,a.store_id 网点ID
    ,dp.store_name 网点名称
    ,dp.opening_at 开业时间
    ,case
        when dp.region_name in ('Area3', 'Area6') then '彭万松'
        when dp.region_name in ('Area4', 'Area9') then '韩钥'
        when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
        when dp.region_name in ( 'Area8') then '黄勇'
        when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
    end 区域
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,a.应交接
    ,a.已交接
    ,concat(round(a.交接率*100,2),'%') as 交接率
    ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
    ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
    ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
    ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
    ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
from
    (
        select
            t1.store_id
            ,t1.stat_date
            ,count(t1.pno) 应交接
            ,count(if(sc.pno is not null , t1.pno, null)) 已交接
            ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
            ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
            ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
            ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
            ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

            ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
            ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
            ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
            ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
        from t t1
        left join
            (
                select
                    sc.*
                from
                    (
                        select
                            pr.pno
                            ,pr.store_id
                            ,pr.store_name
                            ,t1.stat_date
                            ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                            ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                            ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                        from ph_staging.parcel_route pr
                        join t t1 on t1.pno = pr.pno
                        where
                            pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                           and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                          and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                    ) sc
                where
                    sc.rk = 1
            ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
        group by 1,2
    ) a
join
    (
        select
            sd.store_id
        from ph_staging.sys_district sd
        where
            sd.deleted = 0
            and sd.store_id is not null
        group by 1

        union all

        select
            sd.separation_store_id store_id
        from ph_staging.sys_district sd
        where
            sd.deleted = 0
            and sd.separation_store_id is not null
        group by 1
    ) sd on sd.store_id = a.store_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
where
    dp.store_category in (1,10,13);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-08-08'
        and pr.routed_at >= date_sub('2023-08-08', interval 8 hour )
        and pr.routed_at < date_add('2023-08-08', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id = 'PH61060300'
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end 评级
        ,a2.code_num
        ,a2.staff_code_num
        ,a2.staff_num
        ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-08'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-08-08')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-08-08'
        and pi.finished_at >= date_sub('2023-08-08', interval 8 hour )
        and pi.finished_at < date_add('2023-08-08', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-08-08'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
with a as
(
    select
        coalesce(a.client_name, '总计') client_name
        ,coalesce(a.疑难件原因, '总计') 疑难件原因
        ,a.`0-2小时`
        ,a.`2-4小时`
        ,a.`4-6小时`
        ,a.`6小时以上`
        ,a.总疑难件量
        ,a.继续配送
        ,a.退货
        ,a.平均处理时长_h
    from
        (
            select
                 case
                    when bc.`client_id` is not null then bc.client_name
                    when kp.id is not null and bc.client_id is null then '普通ka'
                    when kp.`id` is null then '小c'
                end client_name
                ,case di.diff_marker_category # 疑难原因
                    when 1 then '客户不在家/电话无人接听'
                    when 2 then '收件人拒收'
                    when 3 then '快件分错网点'
                    when 4 then '外包装破损'
                    when 5 then '货物破损'
                    when 6 then '货物短少'
                    when 7 then '货物丢失'
                    when 8 then '电话联系不上'
                    when 9 then '客户改约时间'
                    when 10 then '客户不在'
                    when 11 then '客户取消任务'
                    when 12 then '无人签收'
                    when 13 then '客户周末或假期不收货'
                    when 14 then '客户改约时间'
                    when 15 then '当日运力不足，无法派送'
                    when 16 then '联系不上收件人'
                    when 17 then '收件人拒收'
                    when 18 then '快件分错网点'
                    when 19 then '外包装破损'
                    when 20 then '货物破损'
                    when 21 then '货物短少'
                    when 22 then '货物丢失'
                    when 23 then '详细地址错误'
                    when 24 then '收件地址已废弃或不存在'
                    when 25 then '收件人电话号码错误'
                    when 26 then 'cod金额不正确'
                    when 27 then '无实际包裹'
                    when 28 then '已妥投未交接'
                    when 29 then '收件人电话号码是空号'
                    when 30 then '送错网点'
                    when 31 then '省市乡邮编错误'
                    when 32 then '禁运品'
                    when 33 then '严重破损（丢弃）'
                    when 34 then '退件两次尝试派送失败'
                    when 35 then '不能打开locker'
                    when 36 then 'locker不能使用'
                    when 37 then '该地址找不到lockerstation'
                    when 38 then '一票多件'
                    when 39 then '多次尝试派件失败'
                    when 40 then '客户不在家/电话无人接听'
                    when 41 then '错过班车时间'
                    when 42 then '目的地是偏远地区,留仓待次日派送'
                    when 43 then '目的地是岛屿,留仓待次日派送'
                    when 44 then '企业/机构当天已下班'
                    when 45 then '子母件包裹未全部到达网点'
                    when 46 then '不可抗力原因留仓(台风)'
                    when 47 then '虚假包裹'
                    when 50 then '客户取消寄件'
                    when 51 then '信息录入错误'
                    when 52 then '客户取消寄件'
                    when 53 then 'lazada仓库拒收'
                    when 69 then '禁运品'
                    when 70 then '客户改约时间'
                    when 71 then '当日运力不足，无法派送'
                    when 72 then '客户周末或假期不收货'
                    when 73 then '详细地址错误'
                    when 74 then '收件地址已废弃或不存在'
                    when 75 then '收件人电话号码错误'
                    when 76 then 'cod金额不正确'
                    when 77 then '企业/机构当天已下班'
                    when 78 then '收件人电话号码是空号'
                    when 79 then '快件分错网点-地址错误'
                    when 80 then '客户取消任务'
                    when 81 then '重复下单'
                    when 82 then '已完成揽件'
                    when 83 then '联系不上客户'
                    when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 85 then '寄件人电话号码是空号'
                    when 86 then '包裹不符合揽收条件超大件'
                    when 87 then '包裹不符合揽收条件违禁品'
                    when 88 then '寄件人地址为岛屿'
                    when 89 then '运力短缺，跟客户协商推迟揽收'
                    when 90 then '包裹未准备好推迟揽收'
                    when 91 then '包裹包装不符合运输标准'
                    when 92 then '客户提供的清单里没有此包裹'
                    when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 94 then '客户取消寄件/客户实际不想寄此包裹'
                    when 95 then '车辆/人力短缺推迟揽收'
                    when 96 then '遗漏揽收(已停用)'
                    when 97 then '子母件(一个单号多个包裹)'
                    when 98 then '地址错误addresserror'
                    when 99 then '包裹不符合揽收条件：超大件'
                    when 100 then '包裹不符合揽收条件：违禁品'
                    when 101 then '包裹包装不符合运输标准'
                    when 102 then '包裹未准备好'
                    when 103 then '运力短缺，跟客户协商推迟揽收'
                    when 104 then '子母件(一个单号多个包裹)'
                    when 105 then '破损包裹'
                    when 106 then '空包裹'
                    when 107 then '不能打开locker(密码错误)'
                    when 108 then 'locker不能使用'
                    when 109 then 'locker找不到'
                    when 110 then '运单号与实际包裹的单号不一致'
                    when 111 then 'box客户取消任务'
                    when 112 then '不能打开locker(密码错误)'
                    when 113 then 'locker不能使用'
                    when 114 then 'locker找不到'
                    when 115 then '实际重量尺寸大于客户下单的重量尺寸'
                    when 116 then '客户仓库关闭'
                    when 117 then '客户仓库关闭'
                    when 118 then 'SHOPEE订单系统自动关闭'
                    when 119 then '客户取消包裹'
                    when 121 then '地址错误'
                    when 122 then '当日运力不足，无法揽收'
                end as 疑难件原因
                ,count(if(cdt.negotiation_result_category = 5, di.id, null)) 继续配送
                ,count(if(cdt.negotiation_result_category = 3, di.id, null)) 退货
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 < 2, di.id, null)) '0-2小时'
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 >= 2 and timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 < 4 , di.id, null)) '2-4小时'
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 >= 4 and timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 < 6, di.id, null )) '4-6小时'
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 >= 6 , di.id, null )) '6小时以上'
                ,sum(if(cdt.operator_id not in (10000,10001,100002), timestampdiff(second , cdt.created_at, cdt.updated_at)/3600, null))/count(if(cdt.operator_id not in (10000,10001,100002), di.id, null)) 平均处理时长_h
                ,count(di.id) 总疑难件量
            from ph_staging.diff_info di
            left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
            left join ph_staging.store_diff_ticket sdt on sdt.diff_info_id = di.id
#             left join dwm.dwd_dim_dict tdt2 on di.diff_marker_category= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category' -- 标记原因
            left join ph_staging.parcel_info pi on pi.pno = di.pno
            left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id and bc.client_name in ('lazada', 'shopee', 'tiktok')
            left join ph_staging.ka_profile kp on kp.id = pi.client_id
            where
                di.updated_at >= date_sub('2023-08-08', interval 8 hour )
                and di.updated_at < date_add('2023-08-08', interval 16 hour ) -- 今日处理
                and cdt.state = 1 -- 已处理
                and di.diff_marker_category not in (7,22,5,20,6,21,15,71,34,69,32)
            group by 1,2
            with rollup
        ) a
    order by 1,2
)
, b as
(
    select
        coalesce(a2.client_name, '总计') client_name
        ,coalesce(a2.疑难件原因, '总计') 疑难件原因
        ,a2.`20-9单量`
        ,a2.`前日20-今日9点处理完成量`
        ,a2.`20-9点11点处理完成量`
        ,a2.`9-20单量`
        ,a2.`9-20已处理单量`
        ,a2.`9-20已处理2小时内量`
    from
        (
           select
                case
                    when bc.`client_id` is not null then bc.client_name
                    when kp.id is not null and bc.client_id is null then '普通ka'
                    when kp.`id` is null then '小c'
                end client_name
                ,case di.diff_marker_category
                    when 1 then '客户不在家/电话无人接听'
                    when 2 then '收件人拒收'
                    when 3 then '快件分错网点'
                    when 4 then '外包装破损'
                    when 5 then '货物破损'
                    when 6 then '货物短少'
                    when 7 then '货物丢失'
                    when 8 then '电话联系不上'
                    when 9 then '客户改约时间'
                    when 10 then '客户不在'
                    when 11 then '客户取消任务'
                    when 12 then '无人签收'
                    when 13 then '客户周末或假期不收货'
                    when 14 then '客户改约时间'
                    when 15 then '当日运力不足，无法派送'
                    when 16 then '联系不上收件人'
                    when 17 then '收件人拒收'
                    when 18 then '快件分错网点'
                    when 19 then '外包装破损'
                    when 20 then '货物破损'
                    when 21 then '货物短少'
                    when 22 then '货物丢失'
                    when 23 then '详细地址错误'
                    when 24 then '收件地址已废弃或不存在'
                    when 25 then '收件人电话号码错误'
                    when 26 then 'cod金额不正确'
                    when 27 then '无实际包裹'
                    when 28 then '已妥投未交接'
                    when 29 then '收件人电话号码是空号'
                    when 30 then '送错网点'
                    when 31 then '省市乡邮编错误'
                    when 32 then '禁运品'
                    when 33 then '严重破损（丢弃）'
                    when 34 then '退件两次尝试派送失败'
                    when 35 then '不能打开locker'
                    when 36 then 'locker不能使用'
                    when 37 then '该地址找不到lockerstation'
                    when 38 then '一票多件'
                    when 39 then '多次尝试派件失败'
                    when 40 then '客户不在家/电话无人接听'
                    when 41 then '错过班车时间'
                    when 42 then '目的地是偏远地区,留仓待次日派送'
                    when 43 then '目的地是岛屿,留仓待次日派送'
                    when 44 then '企业/机构当天已下班'
                    when 45 then '子母件包裹未全部到达网点'
                    when 46 then '不可抗力原因留仓(台风)'
                    when 47 then '虚假包裹'
                    when 50 then '客户取消寄件'
                    when 51 then '信息录入错误'
                    when 52 then '客户取消寄件'
                    when 53 then 'lazada仓库拒收'
                    when 69 then '禁运品'
                    when 70 then '客户改约时间'
                    when 71 then '当日运力不足，无法派送'
                    when 72 then '客户周末或假期不收货'
                    when 73 then '详细地址错误'
                    when 74 then '收件地址已废弃或不存在'
                    when 75 then '收件人电话号码错误'
                    when 76 then 'cod金额不正确'
                    when 77 then '企业/机构当天已下班'
                    when 78 then '收件人电话号码是空号'
                    when 79 then '快件分错网点-地址错误'
                    when 80 then '客户取消任务'
                    when 81 then '重复下单'
                    when 82 then '已完成揽件'
                    when 83 then '联系不上客户'
                    when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 85 then '寄件人电话号码是空号'
                    when 86 then '包裹不符合揽收条件超大件'
                    when 87 then '包裹不符合揽收条件违禁品'
                    when 88 then '寄件人地址为岛屿'
                    when 89 then '运力短缺，跟客户协商推迟揽收'
                    when 90 then '包裹未准备好推迟揽收'
                    when 91 then '包裹包装不符合运输标准'
                    when 92 then '客户提供的清单里没有此包裹'
                    when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 94 then '客户取消寄件/客户实际不想寄此包裹'
                    when 95 then '车辆/人力短缺推迟揽收'
                    when 96 then '遗漏揽收(已停用)'
                    when 97 then '子母件(一个单号多个包裹)'
                    when 98 then '地址错误addresserror'
                    when 99 then '包裹不符合揽收条件：超大件'
                    when 100 then '包裹不符合揽收条件：违禁品'
                    when 101 then '包裹包装不符合运输标准'
                    when 102 then '包裹未准备好'
                    when 103 then '运力短缺，跟客户协商推迟揽收'
                    when 104 then '子母件(一个单号多个包裹)'
                    when 105 then '破损包裹'
                    when 106 then '空包裹'
                    when 107 then '不能打开locker(密码错误)'
                    when 108 then 'locker不能使用'
                    when 109 then 'locker找不到'
                    when 110 then '运单号与实际包裹的单号不一致'
                    when 111 then 'box客户取消任务'
                    when 112 then '不能打开locker(密码错误)'
                    when 113 then 'locker不能使用'
                    when 114 then 'locker找不到'
                    when 115 then '实际重量尺寸大于客户下单的重量尺寸'
                    when 116 then '客户仓库关闭'
                    when 117 then '客户仓库关闭'
                    when 118 then 'SHOPEE订单系统自动关闭'
                    when 119 then '客户取消包裹'
                    when 121 then '地址错误'
                    when 122 then '当日运力不足，无法揽收'
                end as 疑难件原因
                ,count(if(di.created_at >= date_sub('2023-08-08', interval 12 hour) and di.created_at < date_add('2023-08-08', interval  1 hour), di.id, null)) '20-9单量'
                ,count(if(di.created_at >= date_sub('2023-08-08', interval 12 hour) and di.created_at < date_add('2023-08-08', interval  1 hour) and cdt.state = 1 , di.id, null)) '前日20-今日9点处理完成量'
                ,count(if(di.created_at >= date_sub('2023-08-08', interval 12 hour) and di.created_at < date_add('2023-08-08', interval  1 hour) and cdt.state = 1 and cdt.updated_at < date_add('2023-08-08', interval  3 hour ) , di.id, null)) '20-9点11点处理完成量'
                ,count(if(di.created_at >= date_add('2023-08-08', interval  1 hour) and di.created_at < date_add('2023-08-08', interval 12 hour), di.id, null)) '9-20单量'
                ,count(if(di.created_at >= date_add('2023-08-08', interval  1 hour) and di.created_at < date_add('2023-08-08', interval 12 hour) and cdt.state = 1 , di.id, null)) '9-20已处理单量'
                ,count(if(di.created_at >= date_add('2023-08-08', interval  1 hour) and di.created_at < date_add('2023-08-08', interval 12 hour) and cdt.state = 1 and cdt.updated_at < date_add(di.created_at, interval  2 hour ), di.id, null)) '9-20已处理2小时内量'
            from ph_staging.diff_info di
            join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
            left join ph_staging.store_diff_ticket sdt2 on sdt2.diff_info_id = di.id
#             left join dwm.dwd_dim_dict tdt2 on di.diff_marker_category= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category' -- 标记原因
            left join ph_staging.parcel_info pi on pi.pno = di.pno
            left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id and bc.client_name in ('lazada', 'shopee', 'tiktok')
            left join ph_staging.ka_profile kp on kp.id = pi.client_id
            left join nl_production.violation_return_visit vrv on vrv.link_id = di.pno and vrv.type = 8 and vrv.created_at >= date_add(di.created_at, interval 8 hour)
            where
                di.diff_marker_category not in (7,22,5,20,6,21,15,71,34,69,32)
                and di.created_at >= date_sub('2023-08-08', interval 12 hour)
                and di.created_at < date_add('2023-08-08', interval 12 hour )
                and vrv.link_id is null
            group by 1,2
            with rollup
        ) a2
)
select
    t1.client_name
    ,t1.疑难件原因
    ,a1.`0-2小时`
    ,a1.`2-4小时`
    ,a1.`4-6小时`
    ,a1.`6小时以上`
    ,a1.继续配送
    ,a1.退货
    ,a1.平均处理时长_h
    ,a1.总疑难件量
    ,b1.`20-9单量`
    ,b1.`前日20-今日9点处理完成量`
    ,b1.`20-9点11点处理完成量`
    ,b1.`9-20单量`
    ,b1.`9-20已处理单量`
    ,b1.`9-20已处理2小时内量`
from
    (
        select
            t1.疑难件原因
            ,t1.client_name
        from
            (
                select
                    a.client_name
                    ,a.疑难件原因
                from a

                union

                select
                    b.client_name
                    ,b.疑难件原因
                from b
            ) t1
        group by 1,2
    ) t1
left join a a1 on t1.client_name = a1.client_name and t1.疑难件原因 = a1.疑难件原因
left join b b1 on t1.client_name = b1.client_name and t1.疑难件原因 = b1.疑难件原因
order by t1.client_name,case t1.疑难件原因
                            when '总计' then 1
                            when '详细地址错误' then 2
                            when '收件人电话号码是空号' then 3
                            when '收件人电话号码错误' then 4
                            when '省市乡邮编错误' then 5
                            when '收件人拒收' then 6
                        end;
;-- -. . -..- - / . -. - .-. -.--
with a as
(
    select
        coalesce(a.client_name, '总计') client_name
        ,coalesce(a.疑难件原因, '总计') 疑难件原因
        ,a.`0-2小时`
        ,a.`2-4小时`
        ,a.`4-6小时`
        ,a.`6小时以上`
        ,a.总疑难件量
        ,a.继续配送
        ,a.退货
        ,a.平均处理时长_h
    from
        (
            select
                 case
                    when bc.`client_id` is not null then bc.client_name
                    when kp.id is not null and bc.client_id is null then '普通ka'
                    when kp.`id` is null then '小c'
                end client_name
                ,case di.diff_marker_category # 疑难原因
                    when 1 then '客户不在家/电话无人接听'
                    when 2 then '收件人拒收'
                    when 3 then '快件分错网点'
                    when 4 then '外包装破损'
                    when 5 then '货物破损'
                    when 6 then '货物短少'
                    when 7 then '货物丢失'
                    when 8 then '电话联系不上'
                    when 9 then '客户改约时间'
                    when 10 then '客户不在'
                    when 11 then '客户取消任务'
                    when 12 then '无人签收'
                    when 13 then '客户周末或假期不收货'
                    when 14 then '客户改约时间'
                    when 15 then '当日运力不足，无法派送'
                    when 16 then '联系不上收件人'
                    when 17 then '收件人拒收'
                    when 18 then '快件分错网点'
                    when 19 then '外包装破损'
                    when 20 then '货物破损'
                    when 21 then '货物短少'
                    when 22 then '货物丢失'
                    when 23 then '详细地址错误'
                    when 24 then '收件地址已废弃或不存在'
                    when 25 then '收件人电话号码错误'
                    when 26 then 'cod金额不正确'
                    when 27 then '无实际包裹'
                    when 28 then '已妥投未交接'
                    when 29 then '收件人电话号码是空号'
                    when 30 then '送错网点'
                    when 31 then '省市乡邮编错误'
                    when 32 then '禁运品'
                    when 33 then '严重破损（丢弃）'
                    when 34 then '退件两次尝试派送失败'
                    when 35 then '不能打开locker'
                    when 36 then 'locker不能使用'
                    when 37 then '该地址找不到lockerstation'
                    when 38 then '一票多件'
                    when 39 then '多次尝试派件失败'
                    when 40 then '客户不在家/电话无人接听'
                    when 41 then '错过班车时间'
                    when 42 then '目的地是偏远地区,留仓待次日派送'
                    when 43 then '目的地是岛屿,留仓待次日派送'
                    when 44 then '企业/机构当天已下班'
                    when 45 then '子母件包裹未全部到达网点'
                    when 46 then '不可抗力原因留仓(台风)'
                    when 47 then '虚假包裹'
                    when 50 then '客户取消寄件'
                    when 51 then '信息录入错误'
                    when 52 then '客户取消寄件'
                    when 53 then 'lazada仓库拒收'
                    when 69 then '禁运品'
                    when 70 then '客户改约时间'
                    when 71 then '当日运力不足，无法派送'
                    when 72 then '客户周末或假期不收货'
                    when 73 then '详细地址错误'
                    when 74 then '收件地址已废弃或不存在'
                    when 75 then '收件人电话号码错误'
                    when 76 then 'cod金额不正确'
                    when 77 then '企业/机构当天已下班'
                    when 78 then '收件人电话号码是空号'
                    when 79 then '快件分错网点-地址错误'
                    when 80 then '客户取消任务'
                    when 81 then '重复下单'
                    when 82 then '已完成揽件'
                    when 83 then '联系不上客户'
                    when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 85 then '寄件人电话号码是空号'
                    when 86 then '包裹不符合揽收条件超大件'
                    when 87 then '包裹不符合揽收条件违禁品'
                    when 88 then '寄件人地址为岛屿'
                    when 89 then '运力短缺，跟客户协商推迟揽收'
                    when 90 then '包裹未准备好推迟揽收'
                    when 91 then '包裹包装不符合运输标准'
                    when 92 then '客户提供的清单里没有此包裹'
                    when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 94 then '客户取消寄件/客户实际不想寄此包裹'
                    when 95 then '车辆/人力短缺推迟揽收'
                    when 96 then '遗漏揽收(已停用)'
                    when 97 then '子母件(一个单号多个包裹)'
                    when 98 then '地址错误addresserror'
                    when 99 then '包裹不符合揽收条件：超大件'
                    when 100 then '包裹不符合揽收条件：违禁品'
                    when 101 then '包裹包装不符合运输标准'
                    when 102 then '包裹未准备好'
                    when 103 then '运力短缺，跟客户协商推迟揽收'
                    when 104 then '子母件(一个单号多个包裹)'
                    when 105 then '破损包裹'
                    when 106 then '空包裹'
                    when 107 then '不能打开locker(密码错误)'
                    when 108 then 'locker不能使用'
                    when 109 then 'locker找不到'
                    when 110 then '运单号与实际包裹的单号不一致'
                    when 111 then 'box客户取消任务'
                    when 112 then '不能打开locker(密码错误)'
                    when 113 then 'locker不能使用'
                    when 114 then 'locker找不到'
                    when 115 then '实际重量尺寸大于客户下单的重量尺寸'
                    when 116 then '客户仓库关闭'
                    when 117 then '客户仓库关闭'
                    when 118 then 'SHOPEE订单系统自动关闭'
                    when 119 then '客户取消包裹'
                    when 121 then '地址错误'
                    when 122 then '当日运力不足，无法揽收'
                end as 疑难件原因
                ,count(if(cdt.negotiation_result_category = 5, di.id, null)) 继续配送
                ,count(if(cdt.negotiation_result_category = 3, di.id, null)) 退货
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 < 2, di.id, null)) '0-2小时'
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 >= 2 and timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 < 4 , di.id, null)) '2-4小时'
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 >= 4 and timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 < 6, di.id, null )) '4-6小时'
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 >= 6 , di.id, null )) '6小时以上'
                ,sum(if(cdt.operator_id not in (10000,10001,100002), timestampdiff(second , cdt.created_at, cdt.updated_at)/3600, null))/count(if(cdt.operator_id not in (10000,10001,100002), di.id, null)) 平均处理时长_h
                ,count(di.id) 总疑难件量
            from ph_staging.diff_info di
            left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
            left join ph_staging.store_diff_ticket sdt on sdt.diff_info_id = di.id
#             left join dwm.dwd_dim_dict tdt2 on di.diff_marker_category= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category' -- 标记原因
            left join ph_staging.parcel_info pi on pi.pno = di.pno
            left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id and bc.client_name in ('lazada', 'shopee', 'tiktok')
            left join ph_staging.ka_profile kp on kp.id = pi.client_id
            where
                di.updated_at >= date_sub('2023-08-08', interval 8 hour )
                and di.updated_at < date_add('2023-08-08', interval 16 hour ) -- 今日处理
                and cdt.state = 1 -- 已处理
                and di.diff_marker_category not in (7,22,5,20,6,21,15,71,34,69,32,39,53)
            group by 1,2
            with rollup
        ) a
    order by 1,2
)
, b as
(
    select
        coalesce(a2.client_name, '总计') client_name
        ,coalesce(a2.疑难件原因, '总计') 疑难件原因
        ,a2.`20-9单量`
        ,a2.`前日20-今日9点处理完成量`
        ,a2.`20-9点11点处理完成量`
        ,a2.`9-20单量`
        ,a2.`9-20已处理单量`
        ,a2.`9-20已处理2小时内量`
    from
        (
           select
                case
                    when bc.`client_id` is not null then bc.client_name
                    when kp.id is not null and bc.client_id is null then '普通ka'
                    when kp.`id` is null then '小c'
                end client_name
                ,case di.diff_marker_category
                    when 1 then '客户不在家/电话无人接听'
                    when 2 then '收件人拒收'
                    when 3 then '快件分错网点'
                    when 4 then '外包装破损'
                    when 5 then '货物破损'
                    when 6 then '货物短少'
                    when 7 then '货物丢失'
                    when 8 then '电话联系不上'
                    when 9 then '客户改约时间'
                    when 10 then '客户不在'
                    when 11 then '客户取消任务'
                    when 12 then '无人签收'
                    when 13 then '客户周末或假期不收货'
                    when 14 then '客户改约时间'
                    when 15 then '当日运力不足，无法派送'
                    when 16 then '联系不上收件人'
                    when 17 then '收件人拒收'
                    when 18 then '快件分错网点'
                    when 19 then '外包装破损'
                    when 20 then '货物破损'
                    when 21 then '货物短少'
                    when 22 then '货物丢失'
                    when 23 then '详细地址错误'
                    when 24 then '收件地址已废弃或不存在'
                    when 25 then '收件人电话号码错误'
                    when 26 then 'cod金额不正确'
                    when 27 then '无实际包裹'
                    when 28 then '已妥投未交接'
                    when 29 then '收件人电话号码是空号'
                    when 30 then '送错网点'
                    when 31 then '省市乡邮编错误'
                    when 32 then '禁运品'
                    when 33 then '严重破损（丢弃）'
                    when 34 then '退件两次尝试派送失败'
                    when 35 then '不能打开locker'
                    when 36 then 'locker不能使用'
                    when 37 then '该地址找不到lockerstation'
                    when 38 then '一票多件'
                    when 39 then '多次尝试派件失败'
                    when 40 then '客户不在家/电话无人接听'
                    when 41 then '错过班车时间'
                    when 42 then '目的地是偏远地区,留仓待次日派送'
                    when 43 then '目的地是岛屿,留仓待次日派送'
                    when 44 then '企业/机构当天已下班'
                    when 45 then '子母件包裹未全部到达网点'
                    when 46 then '不可抗力原因留仓(台风)'
                    when 47 then '虚假包裹'
                    when 50 then '客户取消寄件'
                    when 51 then '信息录入错误'
                    when 52 then '客户取消寄件'
                    when 53 then 'lazada仓库拒收'
                    when 69 then '禁运品'
                    when 70 then '客户改约时间'
                    when 71 then '当日运力不足，无法派送'
                    when 72 then '客户周末或假期不收货'
                    when 73 then '详细地址错误'
                    when 74 then '收件地址已废弃或不存在'
                    when 75 then '收件人电话号码错误'
                    when 76 then 'cod金额不正确'
                    when 77 then '企业/机构当天已下班'
                    when 78 then '收件人电话号码是空号'
                    when 79 then '快件分错网点-地址错误'
                    when 80 then '客户取消任务'
                    when 81 then '重复下单'
                    when 82 then '已完成揽件'
                    when 83 then '联系不上客户'
                    when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 85 then '寄件人电话号码是空号'
                    when 86 then '包裹不符合揽收条件超大件'
                    when 87 then '包裹不符合揽收条件违禁品'
                    when 88 then '寄件人地址为岛屿'
                    when 89 then '运力短缺，跟客户协商推迟揽收'
                    when 90 then '包裹未准备好推迟揽收'
                    when 91 then '包裹包装不符合运输标准'
                    when 92 then '客户提供的清单里没有此包裹'
                    when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 94 then '客户取消寄件/客户实际不想寄此包裹'
                    when 95 then '车辆/人力短缺推迟揽收'
                    when 96 then '遗漏揽收(已停用)'
                    when 97 then '子母件(一个单号多个包裹)'
                    when 98 then '地址错误addresserror'
                    when 99 then '包裹不符合揽收条件：超大件'
                    when 100 then '包裹不符合揽收条件：违禁品'
                    when 101 then '包裹包装不符合运输标准'
                    when 102 then '包裹未准备好'
                    when 103 then '运力短缺，跟客户协商推迟揽收'
                    when 104 then '子母件(一个单号多个包裹)'
                    when 105 then '破损包裹'
                    when 106 then '空包裹'
                    when 107 then '不能打开locker(密码错误)'
                    when 108 then 'locker不能使用'
                    when 109 then 'locker找不到'
                    when 110 then '运单号与实际包裹的单号不一致'
                    when 111 then 'box客户取消任务'
                    when 112 then '不能打开locker(密码错误)'
                    when 113 then 'locker不能使用'
                    when 114 then 'locker找不到'
                    when 115 then '实际重量尺寸大于客户下单的重量尺寸'
                    when 116 then '客户仓库关闭'
                    when 117 then '客户仓库关闭'
                    when 118 then 'SHOPEE订单系统自动关闭'
                    when 119 then '客户取消包裹'
                    when 121 then '地址错误'
                    when 122 then '当日运力不足，无法揽收'
                end as 疑难件原因
                ,count(if(di.created_at >= date_sub('2023-08-08', interval 12 hour) and di.created_at < date_add('2023-08-08', interval  1 hour), di.id, null)) '20-9单量'
                ,count(if(di.created_at >= date_sub('2023-08-08', interval 12 hour) and di.created_at < date_add('2023-08-08', interval  1 hour) and cdt.state = 1 , di.id, null)) '前日20-今日9点处理完成量'
                ,count(if(di.created_at >= date_sub('2023-08-08', interval 12 hour) and di.created_at < date_add('2023-08-08', interval  1 hour) and cdt.state = 1 and cdt.updated_at < date_add('2023-08-08', interval  3 hour ) , di.id, null)) '20-9点11点处理完成量'
                ,count(if(di.created_at >= date_add('2023-08-08', interval  1 hour) and di.created_at < date_add('2023-08-08', interval 12 hour), di.id, null)) '9-20单量'
                ,count(if(di.created_at >= date_add('2023-08-08', interval  1 hour) and di.created_at < date_add('2023-08-08', interval 12 hour) and cdt.state = 1 , di.id, null)) '9-20已处理单量'
                ,count(if(di.created_at >= date_add('2023-08-08', interval  1 hour) and di.created_at < date_add('2023-08-08', interval 12 hour) and cdt.state = 1 and cdt.updated_at < date_add(di.created_at, interval  2 hour ), di.id, null)) '9-20已处理2小时内量'
            from ph_staging.diff_info di
            join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
            left join ph_staging.store_diff_ticket sdt2 on sdt2.diff_info_id = di.id
#             left join dwm.dwd_dim_dict tdt2 on di.diff_marker_category= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category' -- 标记原因
            left join ph_staging.parcel_info pi on pi.pno = di.pno
            left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id and bc.client_name in ('lazada', 'shopee', 'tiktok')
            left join ph_staging.ka_profile kp on kp.id = pi.client_id
            left join nl_production.violation_return_visit vrv on vrv.link_id = di.pno and vrv.type = 8 and vrv.created_at >= date_add(di.created_at, interval 8 hour)
            where
                di.diff_marker_category not in (7,22,5,20,6,21,15,71,34,69,32,39,53)
                and di.created_at >= date_sub('2023-08-08', interval 12 hour)
                and di.created_at < date_add('2023-08-08', interval 12 hour )
                and vrv.link_id is null
            group by 1,2
            with rollup
        ) a2
)
select
    t1.client_name
    ,t1.疑难件原因
    ,a1.`0-2小时`
    ,a1.`2-4小时`
    ,a1.`4-6小时`
    ,a1.`6小时以上`
    ,a1.继续配送
    ,a1.退货
    ,a1.平均处理时长_h
    ,a1.总疑难件量
    ,b1.`20-9单量`
    ,b1.`前日20-今日9点处理完成量`
    ,b1.`20-9点11点处理完成量`
    ,b1.`9-20单量`
    ,b1.`9-20已处理单量`
    ,b1.`9-20已处理2小时内量`
from
    (
        select
            t1.疑难件原因
            ,t1.client_name
        from
            (
                select
                    a.client_name
                    ,a.疑难件原因
                from a

                union

                select
                    b.client_name
                    ,b.疑难件原因
                from b
            ) t1
        group by 1,2
    ) t1
left join a a1 on t1.client_name = a1.client_name and t1.疑难件原因 = a1.疑难件原因
left join b b1 on t1.client_name = b1.client_name and t1.疑难件原因 = b1.疑难件原因
order by t1.client_name,case t1.疑难件原因
                            when '总计' then 1
                            when '详细地址错误' then 2
                            when '收件人电话号码是空号' then 3
                            when '收件人电话号码错误' then 4
                            when '省市乡邮编错误' then 5
                            when '收件人拒收' then 6
                        end;
;-- -. . -..- - / . -. - .-. -.--
with a as
(
    select
        coalesce(a.client_name, '总计') client_name
        ,coalesce(a.疑难件原因, '总计') 疑难件原因
        ,a.`0-2小时`
        ,a.`2-4小时`
        ,a.`4-6小时`
        ,a.`6小时以上`
        ,a.总疑难件量
        ,a.继续配送
        ,a.退货
        ,a.平均处理时长_h
    from
        (
            select
                 case
                    when bc.`client_id` is not null then bc.client_name
                    when kp.id is not null and bc.client_id is null then '普通ka'
                    when kp.`id` is null then '小c'
                end client_name
                ,case di.diff_marker_category # 疑难原因
                    when 1 then '客户不在家/电话无人接听'
                    when 2 then '收件人拒收'
                    when 3 then '快件分错网点'
                    when 4 then '外包装破损'
                    when 5 then '货物破损'
                    when 6 then '货物短少'
                    when 7 then '货物丢失'
                    when 8 then '电话联系不上'
                    when 9 then '客户改约时间'
                    when 10 then '客户不在'
                    when 11 then '客户取消任务'
                    when 12 then '无人签收'
                    when 13 then '客户周末或假期不收货'
                    when 14 then '客户改约时间'
                    when 15 then '当日运力不足，无法派送'
                    when 16 then '联系不上收件人'
                    when 17 then '收件人拒收'
                    when 18 then '快件分错网点'
                    when 19 then '外包装破损'
                    when 20 then '货物破损'
                    when 21 then '货物短少'
                    when 22 then '货物丢失'
                    when 23 then '详细地址错误'
                    when 24 then '收件地址已废弃或不存在'
                    when 25 then '收件人电话号码错误'
                    when 26 then 'cod金额不正确'
                    when 27 then '无实际包裹'
                    when 28 then '已妥投未交接'
                    when 29 then '收件人电话号码是空号'
                    when 30 then '送错网点'
                    when 31 then '省市乡邮编错误'
                    when 32 then '禁运品'
                    when 33 then '严重破损（丢弃）'
                    when 34 then '退件两次尝试派送失败'
                    when 35 then '不能打开locker'
                    when 36 then 'locker不能使用'
                    when 37 then '该地址找不到lockerstation'
                    when 38 then '一票多件'
                    when 39 then '多次尝试派件失败'
                    when 40 then '客户不在家/电话无人接听'
                    when 41 then '错过班车时间'
                    when 42 then '目的地是偏远地区,留仓待次日派送'
                    when 43 then '目的地是岛屿,留仓待次日派送'
                    when 44 then '企业/机构当天已下班'
                    when 45 then '子母件包裹未全部到达网点'
                    when 46 then '不可抗力原因留仓(台风)'
                    when 47 then '虚假包裹'
                    when 50 then '客户取消寄件'
                    when 51 then '信息录入错误'
                    when 52 then '客户取消寄件'
                    when 53 then 'lazada仓库拒收'
                    when 69 then '禁运品'
                    when 70 then '客户改约时间'
                    when 71 then '当日运力不足，无法派送'
                    when 72 then '客户周末或假期不收货'
                    when 73 then '详细地址错误'
                    when 74 then '收件地址已废弃或不存在'
                    when 75 then '收件人电话号码错误'
                    when 76 then 'cod金额不正确'
                    when 77 then '企业/机构当天已下班'
                    when 78 then '收件人电话号码是空号'
                    when 79 then '快件分错网点-地址错误'
                    when 80 then '客户取消任务'
                    when 81 then '重复下单'
                    when 82 then '已完成揽件'
                    when 83 then '联系不上客户'
                    when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 85 then '寄件人电话号码是空号'
                    when 86 then '包裹不符合揽收条件超大件'
                    when 87 then '包裹不符合揽收条件违禁品'
                    when 88 then '寄件人地址为岛屿'
                    when 89 then '运力短缺，跟客户协商推迟揽收'
                    when 90 then '包裹未准备好推迟揽收'
                    when 91 then '包裹包装不符合运输标准'
                    when 92 then '客户提供的清单里没有此包裹'
                    when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 94 then '客户取消寄件/客户实际不想寄此包裹'
                    when 95 then '车辆/人力短缺推迟揽收'
                    when 96 then '遗漏揽收(已停用)'
                    when 97 then '子母件(一个单号多个包裹)'
                    when 98 then '地址错误addresserror'
                    when 99 then '包裹不符合揽收条件：超大件'
                    when 100 then '包裹不符合揽收条件：违禁品'
                    when 101 then '包裹包装不符合运输标准'
                    when 102 then '包裹未准备好'
                    when 103 then '运力短缺，跟客户协商推迟揽收'
                    when 104 then '子母件(一个单号多个包裹)'
                    when 105 then '破损包裹'
                    when 106 then '空包裹'
                    when 107 then '不能打开locker(密码错误)'
                    when 108 then 'locker不能使用'
                    when 109 then 'locker找不到'
                    when 110 then '运单号与实际包裹的单号不一致'
                    when 111 then 'box客户取消任务'
                    when 112 then '不能打开locker(密码错误)'
                    when 113 then 'locker不能使用'
                    when 114 then 'locker找不到'
                    when 115 then '实际重量尺寸大于客户下单的重量尺寸'
                    when 116 then '客户仓库关闭'
                    when 117 then '客户仓库关闭'
                    when 118 then 'SHOPEE订单系统自动关闭'
                    when 119 then '客户取消包裹'
                    when 121 then '地址错误'
                    when 122 then '当日运力不足，无法揽收'
                end as 疑难件原因
                ,count(if(cdt.negotiation_result_category = 5, di.id, null)) 继续配送
                ,count(if(cdt.negotiation_result_category = 3, di.id, null)) 退货
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 < 2, di.id, null)) '0-2小时'
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 >= 2 and timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 < 4 , di.id, null)) '2-4小时'
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 >= 4 and timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 < 6, di.id, null )) '4-6小时'
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 >= 6 , di.id, null )) '6小时以上'
                ,sum(if(cdt.operator_id not in (10000,10001,100002), timestampdiff(second , cdt.created_at, cdt.updated_at)/3600, null))/count(if(cdt.operator_id not in (10000,10001,100002), di.id, null)) 平均处理时长_h
                ,count(di.id) 总疑难件量
            from ph_staging.diff_info di
            left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
            left join ph_staging.store_diff_ticket sdt on sdt.diff_info_id = di.id
#             left join dwm.dwd_dim_dict tdt2 on di.diff_marker_category= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category' -- 标记原因
            left join ph_staging.parcel_info pi on pi.pno = di.pno
            left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id and bc.client_name in ('lazada', 'shopee', 'tiktok')
            left join ph_staging.ka_profile kp on kp.id = pi.client_id
            where
                di.updated_at >= date_sub('2023-08-08', interval 8 hour )
                and di.updated_at < date_add('2023-08-08', interval 16 hour ) -- 今日处理
                and cdt.state = 1 -- 已处理
                and di.diff_marker_category not in (7,22,5,20,6,21,15,71,34,69,32,39,53,28)
            group by 1,2
            with rollup
        ) a
    order by 1,2
)
, b as
(
    select
        coalesce(a2.client_name, '总计') client_name
        ,coalesce(a2.疑难件原因, '总计') 疑难件原因
        ,a2.`20-9单量`
        ,a2.`前日20-今日9点处理完成量`
        ,a2.`20-9点11点处理完成量`
        ,a2.`9-20单量`
        ,a2.`9-20已处理单量`
        ,a2.`9-20已处理2小时内量`
    from
        (
           select
                case
                    when bc.`client_id` is not null then bc.client_name
                    when kp.id is not null and bc.client_id is null then '普通ka'
                    when kp.`id` is null then '小c'
                end client_name
                ,case di.diff_marker_category
                    when 1 then '客户不在家/电话无人接听'
                    when 2 then '收件人拒收'
                    when 3 then '快件分错网点'
                    when 4 then '外包装破损'
                    when 5 then '货物破损'
                    when 6 then '货物短少'
                    when 7 then '货物丢失'
                    when 8 then '电话联系不上'
                    when 9 then '客户改约时间'
                    when 10 then '客户不在'
                    when 11 then '客户取消任务'
                    when 12 then '无人签收'
                    when 13 then '客户周末或假期不收货'
                    when 14 then '客户改约时间'
                    when 15 then '当日运力不足，无法派送'
                    when 16 then '联系不上收件人'
                    when 17 then '收件人拒收'
                    when 18 then '快件分错网点'
                    when 19 then '外包装破损'
                    when 20 then '货物破损'
                    when 21 then '货物短少'
                    when 22 then '货物丢失'
                    when 23 then '详细地址错误'
                    when 24 then '收件地址已废弃或不存在'
                    when 25 then '收件人电话号码错误'
                    when 26 then 'cod金额不正确'
                    when 27 then '无实际包裹'
                    when 28 then '已妥投未交接'
                    when 29 then '收件人电话号码是空号'
                    when 30 then '送错网点'
                    when 31 then '省市乡邮编错误'
                    when 32 then '禁运品'
                    when 33 then '严重破损（丢弃）'
                    when 34 then '退件两次尝试派送失败'
                    when 35 then '不能打开locker'
                    when 36 then 'locker不能使用'
                    when 37 then '该地址找不到lockerstation'
                    when 38 then '一票多件'
                    when 39 then '多次尝试派件失败'
                    when 40 then '客户不在家/电话无人接听'
                    when 41 then '错过班车时间'
                    when 42 then '目的地是偏远地区,留仓待次日派送'
                    when 43 then '目的地是岛屿,留仓待次日派送'
                    when 44 then '企业/机构当天已下班'
                    when 45 then '子母件包裹未全部到达网点'
                    when 46 then '不可抗力原因留仓(台风)'
                    when 47 then '虚假包裹'
                    when 50 then '客户取消寄件'
                    when 51 then '信息录入错误'
                    when 52 then '客户取消寄件'
                    when 53 then 'lazada仓库拒收'
                    when 69 then '禁运品'
                    when 70 then '客户改约时间'
                    when 71 then '当日运力不足，无法派送'
                    when 72 then '客户周末或假期不收货'
                    when 73 then '详细地址错误'
                    when 74 then '收件地址已废弃或不存在'
                    when 75 then '收件人电话号码错误'
                    when 76 then 'cod金额不正确'
                    when 77 then '企业/机构当天已下班'
                    when 78 then '收件人电话号码是空号'
                    when 79 then '快件分错网点-地址错误'
                    when 80 then '客户取消任务'
                    when 81 then '重复下单'
                    when 82 then '已完成揽件'
                    when 83 then '联系不上客户'
                    when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 85 then '寄件人电话号码是空号'
                    when 86 then '包裹不符合揽收条件超大件'
                    when 87 then '包裹不符合揽收条件违禁品'
                    when 88 then '寄件人地址为岛屿'
                    when 89 then '运力短缺，跟客户协商推迟揽收'
                    when 90 then '包裹未准备好推迟揽收'
                    when 91 then '包裹包装不符合运输标准'
                    when 92 then '客户提供的清单里没有此包裹'
                    when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 94 then '客户取消寄件/客户实际不想寄此包裹'
                    when 95 then '车辆/人力短缺推迟揽收'
                    when 96 then '遗漏揽收(已停用)'
                    when 97 then '子母件(一个单号多个包裹)'
                    when 98 then '地址错误addresserror'
                    when 99 then '包裹不符合揽收条件：超大件'
                    when 100 then '包裹不符合揽收条件：违禁品'
                    when 101 then '包裹包装不符合运输标准'
                    when 102 then '包裹未准备好'
                    when 103 then '运力短缺，跟客户协商推迟揽收'
                    when 104 then '子母件(一个单号多个包裹)'
                    when 105 then '破损包裹'
                    when 106 then '空包裹'
                    when 107 then '不能打开locker(密码错误)'
                    when 108 then 'locker不能使用'
                    when 109 then 'locker找不到'
                    when 110 then '运单号与实际包裹的单号不一致'
                    when 111 then 'box客户取消任务'
                    when 112 then '不能打开locker(密码错误)'
                    when 113 then 'locker不能使用'
                    when 114 then 'locker找不到'
                    when 115 then '实际重量尺寸大于客户下单的重量尺寸'
                    when 116 then '客户仓库关闭'
                    when 117 then '客户仓库关闭'
                    when 118 then 'SHOPEE订单系统自动关闭'
                    when 119 then '客户取消包裹'
                    when 121 then '地址错误'
                    when 122 then '当日运力不足，无法揽收'
                end as 疑难件原因
                ,count(if(di.created_at >= date_sub('2023-08-08', interval 12 hour) and di.created_at < date_add('2023-08-08', interval  1 hour), di.id, null)) '20-9单量'
                ,count(if(di.created_at >= date_sub('2023-08-08', interval 12 hour) and di.created_at < date_add('2023-08-08', interval  1 hour) and cdt.state = 1 , di.id, null)) '前日20-今日9点处理完成量'
                ,count(if(di.created_at >= date_sub('2023-08-08', interval 12 hour) and di.created_at < date_add('2023-08-08', interval  1 hour) and cdt.state = 1 and cdt.updated_at < date_add('2023-08-08', interval  3 hour ) , di.id, null)) '20-9点11点处理完成量'
                ,count(if(di.created_at >= date_add('2023-08-08', interval  1 hour) and di.created_at < date_add('2023-08-08', interval 12 hour), di.id, null)) '9-20单量'
                ,count(if(di.created_at >= date_add('2023-08-08', interval  1 hour) and di.created_at < date_add('2023-08-08', interval 12 hour) and cdt.state = 1 , di.id, null)) '9-20已处理单量'
                ,count(if(di.created_at >= date_add('2023-08-08', interval  1 hour) and di.created_at < date_add('2023-08-08', interval 12 hour) and cdt.state = 1 and cdt.updated_at < date_add(di.created_at, interval  2 hour ), di.id, null)) '9-20已处理2小时内量'
            from ph_staging.diff_info di
            join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
            left join ph_staging.store_diff_ticket sdt2 on sdt2.diff_info_id = di.id
#             left join dwm.dwd_dim_dict tdt2 on di.diff_marker_category= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category' -- 标记原因
            left join ph_staging.parcel_info pi on pi.pno = di.pno
            left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id and bc.client_name in ('lazada', 'shopee', 'tiktok')
            left join ph_staging.ka_profile kp on kp.id = pi.client_id
            left join nl_production.violation_return_visit vrv on vrv.link_id = di.pno and vrv.type = 8 and vrv.created_at >= date_add(di.created_at, interval 8 hour)
            where
                di.diff_marker_category not in (7,22,5,20,6,21,15,71,34,69,32,39,53,28)
                and di.created_at >= date_sub('2023-08-08', interval 12 hour)
                and di.created_at < date_add('2023-08-08', interval 12 hour )
                and vrv.link_id is null
            group by 1,2
            with rollup
        ) a2
)
select
    t1.client_name
    ,t1.疑难件原因
    ,a1.`0-2小时`
    ,a1.`2-4小时`
    ,a1.`4-6小时`
    ,a1.`6小时以上`
    ,a1.继续配送
    ,a1.退货
    ,a1.平均处理时长_h
    ,a1.总疑难件量
    ,b1.`20-9单量`
    ,b1.`前日20-今日9点处理完成量`
    ,b1.`20-9点11点处理完成量`
    ,b1.`9-20单量`
    ,b1.`9-20已处理单量`
    ,b1.`9-20已处理2小时内量`
from
    (
        select
            t1.疑难件原因
            ,t1.client_name
        from
            (
                select
                    a.client_name
                    ,a.疑难件原因
                from a

                union

                select
                    b.client_name
                    ,b.疑难件原因
                from b
            ) t1
        group by 1,2
    ) t1
left join a a1 on t1.client_name = a1.client_name and t1.疑难件原因 = a1.疑难件原因
left join b b1 on t1.client_name = b1.client_name and t1.疑难件原因 = b1.疑难件原因
order by t1.client_name,case t1.疑难件原因
                            when '总计' then 1
                            when '详细地址错误' then 2
                            when '收件人电话号码是空号' then 3
                            when '收件人电话号码错误' then 4
                            when '省市乡邮编错误' then 5
                            when '收件人拒收' then 6
                        end;
;-- -. . -..- - / . -. - .-. -.--
with a as
(
    select
        coalesce(a.client_name, '总计') client_name
        ,coalesce(a.疑难件原因, '总计') 疑难件原因
        ,a.`0-2小时`
        ,a.`2-4小时`
        ,a.`4-6小时`
        ,a.`6小时以上`
        ,a.总疑难件量
        ,a.继续配送
        ,a.退货
        ,a.平均处理时长_h
    from
        (
            select
                 case
                    when bc.`client_id` is not null then bc.client_name
                    when kp.id is not null and bc.client_id is null then '普通ka'
                    when kp.`id` is null then '小c'
                end client_name
                ,case di.diff_marker_category # 疑难原因
                    when 1 then '客户不在家/电话无人接听'
                    when 2 then '收件人拒收'
                    when 3 then '快件分错网点'
                    when 4 then '外包装破损'
                    when 5 then '货物破损'
                    when 6 then '货物短少'
                    when 7 then '货物丢失'
                    when 8 then '电话联系不上'
                    when 9 then '客户改约时间'
                    when 10 then '客户不在'
                    when 11 then '客户取消任务'
                    when 12 then '无人签收'
                    when 13 then '客户周末或假期不收货'
                    when 14 then '客户改约时间'
                    when 15 then '当日运力不足，无法派送'
                    when 16 then '联系不上收件人'
                    when 17 then '收件人拒收'
                    when 18 then '快件分错网点'
                    when 19 then '外包装破损'
                    when 20 then '货物破损'
                    when 21 then '货物短少'
                    when 22 then '货物丢失'
                    when 23 then '详细地址错误'
                    when 24 then '收件地址已废弃或不存在'
                    when 25 then '收件人电话号码错误'
                    when 26 then 'cod金额不正确'
                    when 27 then '无实际包裹'
                    when 28 then '已妥投未交接'
                    when 29 then '收件人电话号码是空号'
                    when 30 then '送错网点'
                    when 31 then '省市乡邮编错误'
                    when 32 then '禁运品'
                    when 33 then '严重破损（丢弃）'
                    when 34 then '退件两次尝试派送失败'
                    when 35 then '不能打开locker'
                    when 36 then 'locker不能使用'
                    when 37 then '该地址找不到lockerstation'
                    when 38 then '一票多件'
                    when 39 then '多次尝试派件失败'
                    when 40 then '客户不在家/电话无人接听'
                    when 41 then '错过班车时间'
                    when 42 then '目的地是偏远地区,留仓待次日派送'
                    when 43 then '目的地是岛屿,留仓待次日派送'
                    when 44 then '企业/机构当天已下班'
                    when 45 then '子母件包裹未全部到达网点'
                    when 46 then '不可抗力原因留仓(台风)'
                    when 47 then '虚假包裹'
                    when 50 then '客户取消寄件'
                    when 51 then '信息录入错误'
                    when 52 then '客户取消寄件'
                    when 53 then 'lazada仓库拒收'
                    when 69 then '禁运品'
                    when 70 then '客户改约时间'
                    when 71 then '当日运力不足，无法派送'
                    when 72 then '客户周末或假期不收货'
                    when 73 then '详细地址错误'
                    when 74 then '收件地址已废弃或不存在'
                    when 75 then '收件人电话号码错误'
                    when 76 then 'cod金额不正确'
                    when 77 then '企业/机构当天已下班'
                    when 78 then '收件人电话号码是空号'
                    when 79 then '快件分错网点-地址错误'
                    when 80 then '客户取消任务'
                    when 81 then '重复下单'
                    when 82 then '已完成揽件'
                    when 83 then '联系不上客户'
                    when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 85 then '寄件人电话号码是空号'
                    when 86 then '包裹不符合揽收条件超大件'
                    when 87 then '包裹不符合揽收条件违禁品'
                    when 88 then '寄件人地址为岛屿'
                    when 89 then '运力短缺，跟客户协商推迟揽收'
                    when 90 then '包裹未准备好推迟揽收'
                    when 91 then '包裹包装不符合运输标准'
                    when 92 then '客户提供的清单里没有此包裹'
                    when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 94 then '客户取消寄件/客户实际不想寄此包裹'
                    when 95 then '车辆/人力短缺推迟揽收'
                    when 96 then '遗漏揽收(已停用)'
                    when 97 then '子母件(一个单号多个包裹)'
                    when 98 then '地址错误addresserror'
                    when 99 then '包裹不符合揽收条件：超大件'
                    when 100 then '包裹不符合揽收条件：违禁品'
                    when 101 then '包裹包装不符合运输标准'
                    when 102 then '包裹未准备好'
                    when 103 then '运力短缺，跟客户协商推迟揽收'
                    when 104 then '子母件(一个单号多个包裹)'
                    when 105 then '破损包裹'
                    when 106 then '空包裹'
                    when 107 then '不能打开locker(密码错误)'
                    when 108 then 'locker不能使用'
                    when 109 then 'locker找不到'
                    when 110 then '运单号与实际包裹的单号不一致'
                    when 111 then 'box客户取消任务'
                    when 112 then '不能打开locker(密码错误)'
                    when 113 then 'locker不能使用'
                    when 114 then 'locker找不到'
                    when 115 then '实际重量尺寸大于客户下单的重量尺寸'
                    when 116 then '客户仓库关闭'
                    when 117 then '客户仓库关闭'
                    when 118 then 'SHOPEE订单系统自动关闭'
                    when 119 then '客户取消包裹'
                    when 121 then '地址错误'
                    when 122 then '当日运力不足，无法揽收'
                end as 疑难件原因
                ,count(if(cdt.negotiation_result_category = 5, di.id, null)) 继续配送
                ,count(if(cdt.negotiation_result_category = 3, di.id, null)) 退货
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 < 2, di.id, null)) '0-2小时'
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 >= 2 and timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 < 4 , di.id, null)) '2-4小时'
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 >= 4 and timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 < 6, di.id, null )) '4-6小时'
                ,count(if(timestampdiff(second , cdt.created_at, cdt.updated_at)/3600 >= 6 , di.id, null )) '6小时以上'
                ,sum(if(cdt.operator_id not in (10000,10001,100002), timestampdiff(second , cdt.created_at, cdt.updated_at)/3600, null))/count(if(cdt.operator_id not in (10000,10001,100002), di.id, null)) 平均处理时长_h
                ,count(di.id) 总疑难件量
            from ph_staging.diff_info di
            left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
            left join ph_staging.store_diff_ticket sdt on sdt.diff_info_id = di.id
#             left join dwm.dwd_dim_dict tdt2 on di.diff_marker_category= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category' -- 标记原因
            left join ph_staging.parcel_info pi on pi.pno = di.pno
            left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id and bc.client_name in ('lazada', 'shopee', 'tiktok')
            left join ph_staging.ka_profile kp on kp.id = pi.client_id
            where
                di.updated_at >= date_sub('2023-08-08', interval 8 hour )
                and di.updated_at < date_add('2023-08-08', interval 16 hour ) -- 今日处理
                and cdt.state = 1 -- 已处理
                and di.diff_marker_category not in (7,22,5,20,6,21,15,71,34,69,32,39,53,28)
            group by 1,2
            with rollup
        ) a
    order by 1,2
)
, b as
(
    select
        coalesce(a2.client_name, '总计') client_name
        ,coalesce(a2.疑难件原因, '总计') 疑难件原因
        ,a2.`20-9单量`
        ,a2.`前日20-今日9点处理完成量`
        ,a2.`20-9点11点处理完成量`
        ,a2.`9-20单量`
        ,a2.`9-20已处理单量`
        ,a2.`9-20已处理2小时内量`
    from
        (
           select
                case
                    when bc.`client_id` is not null then bc.client_name
                    when kp.id is not null and bc.client_id is null then '普通ka'
                    when kp.`id` is null then '小c'
                end client_name
                ,case di.diff_marker_category
                    when 1 then '客户不在家/电话无人接听'
                    when 2 then '收件人拒收'
                    when 3 then '快件分错网点'
                    when 4 then '外包装破损'
                    when 5 then '货物破损'
                    when 6 then '货物短少'
                    when 7 then '货物丢失'
                    when 8 then '电话联系不上'
                    when 9 then '客户改约时间'
                    when 10 then '客户不在'
                    when 11 then '客户取消任务'
                    when 12 then '无人签收'
                    when 13 then '客户周末或假期不收货'
                    when 14 then '客户改约时间'
                    when 15 then '当日运力不足，无法派送'
                    when 16 then '联系不上收件人'
                    when 17 then '收件人拒收'
                    when 18 then '快件分错网点'
                    when 19 then '外包装破损'
                    when 20 then '货物破损'
                    when 21 then '货物短少'
                    when 22 then '货物丢失'
                    when 23 then '详细地址错误'
                    when 24 then '收件地址已废弃或不存在'
                    when 25 then '收件人电话号码错误'
                    when 26 then 'cod金额不正确'
                    when 27 then '无实际包裹'
                    when 28 then '已妥投未交接'
                    when 29 then '收件人电话号码是空号'
                    when 30 then '送错网点'
                    when 31 then '省市乡邮编错误'
                    when 32 then '禁运品'
                    when 33 then '严重破损（丢弃）'
                    when 34 then '退件两次尝试派送失败'
                    when 35 then '不能打开locker'
                    when 36 then 'locker不能使用'
                    when 37 then '该地址找不到lockerstation'
                    when 38 then '一票多件'
                    when 39 then '多次尝试派件失败'
                    when 40 then '客户不在家/电话无人接听'
                    when 41 then '错过班车时间'
                    when 42 then '目的地是偏远地区,留仓待次日派送'
                    when 43 then '目的地是岛屿,留仓待次日派送'
                    when 44 then '企业/机构当天已下班'
                    when 45 then '子母件包裹未全部到达网点'
                    when 46 then '不可抗力原因留仓(台风)'
                    when 47 then '虚假包裹'
                    when 50 then '客户取消寄件'
                    when 51 then '信息录入错误'
                    when 52 then '客户取消寄件'
                    when 53 then 'lazada仓库拒收'
                    when 69 then '禁运品'
                    when 70 then '客户改约时间'
                    when 71 then '当日运力不足，无法派送'
                    when 72 then '客户周末或假期不收货'
                    when 73 then '详细地址错误'
                    when 74 then '收件地址已废弃或不存在'
                    when 75 then '收件人电话号码错误'
                    when 76 then 'cod金额不正确'
                    when 77 then '企业/机构当天已下班'
                    when 78 then '收件人电话号码是空号'
                    when 79 then '快件分错网点-地址错误'
                    when 80 then '客户取消任务'
                    when 81 then '重复下单'
                    when 82 then '已完成揽件'
                    when 83 then '联系不上客户'
                    when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 85 then '寄件人电话号码是空号'
                    when 86 then '包裹不符合揽收条件超大件'
                    when 87 then '包裹不符合揽收条件违禁品'
                    when 88 then '寄件人地址为岛屿'
                    when 89 then '运力短缺，跟客户协商推迟揽收'
                    when 90 then '包裹未准备好推迟揽收'
                    when 91 then '包裹包装不符合运输标准'
                    when 92 then '客户提供的清单里没有此包裹'
                    when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
                    when 94 then '客户取消寄件/客户实际不想寄此包裹'
                    when 95 then '车辆/人力短缺推迟揽收'
                    when 96 then '遗漏揽收(已停用)'
                    when 97 then '子母件(一个单号多个包裹)'
                    when 98 then '地址错误addresserror'
                    when 99 then '包裹不符合揽收条件：超大件'
                    when 100 then '包裹不符合揽收条件：违禁品'
                    when 101 then '包裹包装不符合运输标准'
                    when 102 then '包裹未准备好'
                    when 103 then '运力短缺，跟客户协商推迟揽收'
                    when 104 then '子母件(一个单号多个包裹)'
                    when 105 then '破损包裹'
                    when 106 then '空包裹'
                    when 107 then '不能打开locker(密码错误)'
                    when 108 then 'locker不能使用'
                    when 109 then 'locker找不到'
                    when 110 then '运单号与实际包裹的单号不一致'
                    when 111 then 'box客户取消任务'
                    when 112 then '不能打开locker(密码错误)'
                    when 113 then 'locker不能使用'
                    when 114 then 'locker找不到'
                    when 115 then '实际重量尺寸大于客户下单的重量尺寸'
                    when 116 then '客户仓库关闭'
                    when 117 then '客户仓库关闭'
                    when 118 then 'SHOPEE订单系统自动关闭'
                    when 119 then '客户取消包裹'
                    when 121 then '地址错误'
                    when 122 then '当日运力不足，无法揽收'
                end as 疑难件原因
                ,count(if(di.created_at >= date_sub('2023-08-08', interval 12 hour) and di.created_at < date_add('2023-08-08', interval  1 hour), di.id, null)) '20-9单量'
                ,count(if(di.created_at >= date_sub('2023-08-08', interval 12 hour) and di.created_at < date_add('2023-08-08', interval  1 hour) and cdt.state = 1 , di.id, null)) '前日20-今日9点处理完成量'
                ,count(if(di.created_at >= date_sub('2023-08-08', interval 12 hour) and di.created_at < date_add('2023-08-08', interval  1 hour) and cdt.state = 1 and cdt.updated_at < date_add('2023-08-08', interval  3 hour ) , di.id, null)) '20-9点11点处理完成量'
                ,count(if(di.created_at >= date_add('2023-08-08', interval  1 hour) and di.created_at < date_add('2023-08-08', interval 12 hour), di.id, null)) '9-20单量'
                ,count(if(di.created_at >= date_add('2023-08-08', interval  1 hour) and di.created_at < date_add('2023-08-08', interval 12 hour) and cdt.state = 1 , di.id, null)) '9-20已处理单量'
                ,count(if(di.created_at >= date_add('2023-08-08', interval  1 hour) and di.created_at < date_add('2023-08-08', interval 12 hour) and cdt.state = 1 and cdt.updated_at < date_add(di.created_at, interval  2 hour ), di.id, null)) '9-20已处理2小时内量'
            from ph_staging.diff_info di
            join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
            left join ph_staging.store_diff_ticket sdt2 on sdt2.diff_info_id = di.id
#             left join dwm.dwd_dim_dict tdt2 on di.diff_marker_category= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category' -- 标记原因
            left join ph_staging.parcel_info pi on pi.pno = di.pno
            left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id and bc.client_name in ('lazada', 'shopee', 'tiktok')
            left join ph_staging.ka_profile kp on kp.id = pi.client_id
            left join nl_production.violation_return_visit vrv on vrv.link_id = di.pno and vrv.type = 8 and vrv.created_at >= date_add(di.created_at, interval 8 hour)
            where
                di.diff_marker_category not in (7,22,5,20,6,21,15,71,34,69,32,39,53,28)
                and di.created_at >= date_sub('2023-08-08', interval 12 hour)
                and di.created_at < date_add('2023-08-08', interval 12 hour )
                and vrv.link_id is null
            group by 1,2
            with rollup
        ) a2
)
select
    t1.client_name
    ,t1.疑难件原因
    ,a1.`0-2小时`
    ,a1.`2-4小时`
    ,a1.`4-6小时`
    ,a1.`6小时以上`
    ,a1.继续配送
    ,a1.退货
    ,a1.平均处理时长_h
    ,a1.总疑难件量
    ,b1.`20-9单量`
    ,b1.`前日20-今日9点处理完成量`
    ,b1.`20-9点11点处理完成量`
    ,b1.`9-20单量`
    ,b1.`9-20已处理单量`
    ,b1.`9-20已处理2小时内量`
from
    (
        select
            t1.疑难件原因
            ,t1.client_name
        from
            (
                select
                    a.client_name
                    ,a.疑难件原因
                from a

                union

                select
                    b.client_name
                    ,b.疑难件原因
                from b
            ) t1
        group by 1,2
    ) t1
left join a a1 on t1.client_name = a1.client_name and t1.疑难件原因 = a1.疑难件原因
left join b b1 on t1.client_name = b1.client_name and t1.疑难件原因 = b1.疑难件原因
order by
    case t1.client_name
        when 'lazada' then 1
        when 'shopee' then 2
        when 'tiktok' then 3
        when '普通ka' then 4
        when '小c' then 5
        when '总计' then 6
    end
    ,case t1.疑难件原因
        when '总计' then 1
        when '详细地址错误' then 2
        when '收件人电话号码是空号' then 3
        when '收件人电话号码错误' then 4
        when '省市乡邮编错误' then 5
        when '收件人拒收' then 6
    end;
;-- -. . -..- - / . -. - .-. -.--
select
    date(vrv.created_at) 日期
    ,count(distinct if(bc.client_name = 'lazada', vrv.link_id, null)) lazada需回访总量
    ,count(distinct if(bc.client_name = 'shopee', vrv.link_id, null)) shopee需回访总量
    ,count(distinct if(bc.client_name = 'tiktok' and vrv.violation_remark = 3, vrv.link_id, null )) tiktok3次派送需回访量
    ,count(distinct if(bc.client_name = 'tiktok' and vrv.violation_remark > 3, vrv.link_id, null )) tiktok超3次派送需回访量
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
where
    vrv.type = 8
    and vrv.created_at >= '2023-08-01'
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    date(vrv.ticket_created_at) 日期
    ,count(distinct if(bc.client_name = 'lazada', vrv.link_id, null)) lazada需回访总量
    ,count(distinct if(bc.client_name = 'shopee', vrv.link_id, null)) shopee需回访总量
    ,count(distinct if(bc.client_name = 'tiktok' and vrv.violation_remark = 3, vrv.link_id, null )) tiktok3次派送需回访量
    ,count(distinct if(bc.client_name = 'tiktok' and vrv.violation_remark > 3, vrv.link_id, null )) tiktok超3次派送需回访量
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
where
    vrv.type = 8
    and vrv.ticket_created_at >= '2023-08-01';
;-- -. . -..- - / . -. - .-. -.--
select
    date(vrv.ticket_created_at) 日期
    ,count(distinct if(bc.client_name = 'lazada', vrv.link_id, null)) lazada需回访总量
    ,count(distinct if(bc.client_name = 'shopee', vrv.link_id, null)) shopee需回访总量
    ,count(distinct if(bc.client_name = 'tiktok' and vrv.violation_remark = 3, vrv.link_id, null )) tiktok3次派送需回访量
    ,count(distinct if(bc.client_name = 'tiktok' and vrv.violation_remark > 3, vrv.link_id, null )) tiktok超3次派送需回访量
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
where
    vrv.type = 8
    and vrv.ticket_created_at >= '2023-08-01'
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    vrv.link_id 单号
    ,bc.client_name 客户
    ,ss.name 网点
    ,vrv.violation_remark 尝试派送次数
    ,vrv.mobile 客户联系方式
    ,smp.name 片区
    ,smr.name 大区
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on vrv.client_id = bc.client_id
left join ph_staging.sys_store ss on ss.id = vrv.store_id
left join ph_staging.sys_manage_piece smp on smp.id = ss.manage_piece
left join ph_staging.sys_manage_region smr on smr.id = ss.manage_region
where
    vrv.type = 8
#     and ss.province_code = 'PH14'
    and vrv.visit_state = 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        pi.pno
        ,pi.dst_store_id
        ,pi.state
        ,pi.dst_phone
        ,pi.dst_home_phone
        ,if(pcd.pno is not null , 'y', 'n') change_store
        ,max(pcd.created_at) pcd_create_at
    from ph_staging.parcel_info pi
    left join dwm.dwd_ex_ph_parcel_details de on de.pno = pi.pno
    left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
    left join ph_staging.parcel_route pr on pr.pno = de.pno and pr.route_action = 'PENDING_RETURN'
    left join ph_staging.parcel_change_detail pcd on pcd.pno = pi.pno and pcd.field_name = 'dst_store_id' and pcd.new_value != pcd.old_value
    where
        pi.state not in (5,7,8,9)
        and bc.client_id is null
        and pr.pno is null
    group by 1
)
select
    t1.pno
    ,dp.store_name 目的地网点
    ,t1.dst_store_id 目的网点ID
    ,dp.piece_name 目的地片区
    ,dp.region_name 目的地大区
    ,case t1.state
        when '1' then '已揽收'
        when '2' then '运输中'
        when '3' then '派送中'
        when '4' then '已滞留'
        when '5' then '已签收'
        when '6' then '疑难件处理中'
        when '7' then '已退件'
        when '8' then '异常关闭'
        when '9' then '已撤销'
    end as `包裹状态`
    ,t1.dst_phone 收件人电话
    ,t1.dst_home_phone 收件人家庭电话
    ,count(distinct ppd.mark_date) 尝试天数
from t t1
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = t1.dst_store_id and   dp.stat_date = date_sub(curdate(),interval 1 day)
left join
    (
        select
            td.pno
            ,date(convert_tz(tdm.created_at, '+00:00', '+08:00')) mark_date
        from ph_staging.ticket_delivery td
        join t t1 on t1.pno = td.pno
        left join ph_staging.ticket_delivery_marker tdm on tdm.delivery_id = td.id
        where
            if(t1.change_store = 'n', 1 = 1, tdm.created_at > t1.pcd_create_at)
        group by 1,2
    ) mark on mark.pno = t1.pno
left join
    (
        select
            ppd.pno
            ,date(convert_tz(ppd.created_at, '+00:00', '+08:00')) mark_date
        from ph_staging.parcel_problem_detail ppd
        join t t1 on t1.pno = ppd.pno
        where
            ppd.diff_marker_category not in (7,22,5,20,6,21,15,71)
            and if(t1.change_store = 'n', 1 = 1, ppd.created_at > t1.pcd_create_at)
        group by 1,2
    ) ppd on ppd.pno = mark.pno and mark.mark_date = ppd.mark_date
where
    ppd.mark_date is not null
    and dp.province_code = 'PH14'
group by 1
having count(distinct ppd.mark_date) >= 3;
;-- -. . -..- - / . -. - .-. -.--
select
    vrv.link_id 单号
    ,bc.client_name 客户
    ,vrv.client_id 客户ID
    ,vrv,violation_remark 尝试派送次数
    ,ddd.CN_element 计入多次尝试派送回访前的标记
    ,ss.name 网点
    ,smp.name 片区
    ,smr.name 大区
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
left join dwm.dwd_dim_dict ddd on ddd.element = json_extract(vrv.extra_value, '$.marker_category') and ddd.db = 'ph_staging' and ddd.tablename = 'diif_info' and ddd.fieldname = 'diff_marker_category'
left join ph_staging.sys_store ss on ss.id =vrv.store_id
left join ph_staging.sys_manage_piece smp on smp.id = vrv.piece
left join ph_staging.sys_manage_region smr on smr.id = vrv.region
where
    bc.client_name = 'tiktok'
    and vrv.ticket_created_at >= '2023-08-09';
;-- -. . -..- - / . -. - .-. -.--
select
    vrv.link_id 单号
    ,bc.client_name 客户
    ,vrv.client_id 客户ID
    ,vrv.violation_remark 尝试派送次数
    ,ddd.CN_element 计入多次尝试派送回访前的标记
    ,ss.name 网点
    ,smp.name 片区
    ,smr.name 大区
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
left join dwm.dwd_dim_dict ddd on ddd.element = json_extract(vrv.extra_value, '$.marker_category') and ddd.db = 'ph_staging' and ddd.tablename = 'diif_info' and ddd.fieldname = 'diff_marker_category'
left join ph_staging.sys_store ss on ss.id =vrv.store_id
left join ph_staging.sys_manage_piece smp on smp.id = vrv.piece
left join ph_staging.sys_manage_region smr on smr.id = vrv.region
where
    bc.client_name = 'tiktok'
    and vrv.ticket_created_at >= '2023-08-09';
;-- -. . -..- - / . -. - .-. -.--
select
    vrv.link_id 单号
    ,bc.client_name 客户
    ,vrv.client_id 客户ID
    ,vrv.violation_remark 尝试派送次数
    ,ddd.CN_element 计入多次尝试派送回访前的标记
    ,ss.name 网点
    ,smp.name 片区
    ,smr.name 大区
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
left join dwm.dwd_dim_dict ddd on ddd.element = json_extract(vrv.extra_value, '$.marker_category') and ddd.db = 'ph_staging' and ddd.tablename = 'diif_info' and ddd.fieldname = 'diff_marker_category'
left join ph_staging.sys_store ss on ss.id =vrv.store_id
left join ph_staging.sys_manage_piece smp on smp.id = vrv.piece
left join ph_staging.sys_manage_region smr on smr.id = vrv.region
where
    bc.client_name = 'tiktok'
    and vrv.ticket_created_at >= '2023-08-09'
    and vrv.type = 8;
;-- -. . -..- - / . -. - .-. -.--
select json_extract(vrv.extra_value, '$.marker_category')  from nl_production.violation_return_visit vrv where vrv.id = 4360323;
;-- -. . -..- - / . -. - .-. -.--
select
    vrv.link_id 单号
    ,bc.client_name 客户
    ,vrv.client_id 客户ID
    ,vrv.violation_remark 尝试派送次数
    ,ddd.CN_element 计入多次尝试派送回访前的标记
    ,ss.name 网点
    ,smp.name 片区
    ,smr.name 大区
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
left join dwm.dwd_dim_dict ddd on ddd.element = json_extract(vrv.extra_value, '$.marker_category') and ddd.db = 'ph_staging' and ddd.tablename = 'diff_info' and ddd.fieldname = 'diff_marker_category'
left join ph_staging.sys_store ss on ss.id =vrv.store_id
left join ph_staging.sys_manage_piece smp on smp.id = vrv.piece
left join ph_staging.sys_manage_region smr on smr.id = vrv.region
where
    bc.client_name = 'tiktok'
    and vrv.ticket_created_at >= '2023-08-09'
    and vrv.type = 8;
;-- -. . -..- - / . -. - .-. -.--
select
    vrv.link_id 单号
    ,bc.client_name 客户
    ,ss.name 网点
    ,vrv.violation_remark 尝试派送次数
    ,vrv.mobile 客户联系方式
    ,smp.name 片区
    ,smr.name 大区
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on vrv.client_id = bc.client_id
left join ph_staging.sys_store ss on ss.id = vrv.store_id
left join ph_staging.sys_manage_piece smp on smp.id = ss.manage_piece
left join ph_staging.sys_manage_region smr on smr.id = ss.manage_region
where
    vrv.type = 8
    and ss.province_code = 'PH14'
    and vrv.visit_state = 1;
;-- -. . -..- - / . -. - .-. -.--
select
     oi.client_id as '客户ID client_id'
    , oi.ka_warehouse_id as '仓库ID warehouse_id'
    , kw.out_client_id as '卖家ID_Seller_ID'
    , oi.src_name as '卖家名称 Seller_name'
	, bpt.tracking_no as '回调系统运单号 system TN'
	, bpt.pno as '内部运单号 internal TN'
    , if(pi.returned=1,'退件单','正向单') as '是否退件单号 if return TN'
    , case when pi.state = 1 then '已揽收'
	    when pi.state = 2 then '运输中'
	    when pi.state = 3 then '派送中'
	    when pi.state = 4 then '已滞留'
	    when pi.state = 5 then '已签收'
	    when pi.state = 6 then '疑难件处理中'
	    when pi.state = 7 then '已退件'
	    when pi.state = 8 then '异常关闭'
	    when pi.state = 9 then '已撤销'
		end as '包裹最新状态 latest parcel status'
    , di.疑难件上报时间 as '疑难件上报时间 problematic parcel reporting time'
    , di.疑难件原因 as  '疑难件原因 problematic resaon'
    , di.疑难件处理机构  as '疑难件处理机构 problematic department'
    , di.疑难件处理情况 as '疑难件处理情况 problematic status'

    , ssd.src_store as '揽收网点 pickup DC'
    , ssd.src_piece as '揽收片区 pickup piece'
    , ssd.src_region as '揽收大区 pickup area'
     ,ssd.src_area_name as  '寄件人所在时效区域 area1'

    , sp1.name as '寄件人所在省份 seller_province'
    , ct1.name '寄件人所在城市 seller_city'
	, sd1.name '寄件人人所在的乡 seller_barangay'

    ,tpr.dst_area_code as '目的地网点所在时效区域 destination_area'
	 ,tpr.dst_province_name as '目的地网点所在省 destination province'
    , ssd.dst_store as '目的网点 destination DC'
    , ssd.dst_piece as '目的片区 destination district'
    , ssd.dst_region as '目的大区 destination area'


    ,ssd.dst_area_name as '收件人所在时效区域 consignee_area1'
    , sp2.name '收件人所在省 consignee province'
    , ct2.name '收件人所在城市 consignee city'
	, sd2.name '收件人所在的区域 consignee district'
   	, tt.dst_routed_at as '到达目的地网点时间 arrive destionation DC time'
     ,datediff(date(now()),date(convert_tz(tt.dst_routed_at,'+00:00','+08:00'))) as  '到目的地网点时间_天 datediff_now_dst_store'
    , datediff(date(convert_tz(tt.dst_routed_at,'+00:00','+08:00')),date(convert_tz(pi.created_at,'+00:00','+08:00'))) as  '揽收到目的地网点时间_天 datediff_pcikup_dst_store'
    , case when tt.dst_routed_at is not null then '在仓'
        when tt.dst_routed_at is null then '在途'
            else 'null' end as '在仓_or_在途 in DC or in transit'

    , concat(ssd.src_area_name,' to ',ssd.dst_area_name) as '流向 direction'
    , convert_tz(bpt.pickup_created_at,'+00:00','+08:00') as '回调揽收时间 callback pickup time'
    , date(convert_tz(bpt.pickup_created_at,'+00:00','+08:00') )as '回调揽收日期 callback pickup date'

    , ssd.sla as '时效天数 SLA'
    , ssd.end_date as '包裹普通超时时效截止日_整体 last day of SLA'
    ,if( ssd.end_7_date is null,ssd.end_date,ssd.end_7_date) as '包裹严重超时时效截止日_整体 last day of SLA+7/ 2sla+7'
    , pi.cod_amount/1000 as 'cod金额 cod amount'
	, convert_tz(bpt.latest_created_at,'+00:00','+08:00') as '回调最后一条路由时间last movement time'
	, bpt.action_code as '回调最后一条路由动作 last movement'
	, bpt.delivery_attempt_num as '回调尝试次数 callback attempt_times'
	, bpt.delivery_attempt_num as '回调第三次尝试时间 delivery_attempt_num'
	, pc.third_sorting_code as '三段码 delivery code'
    , convert_tz(pr2.routed_at,'+00:00','+08:00') as '最后一次交接时间 last handover time'
    , pr2.staff_info_id as '最后一次交接人 last handover courier'
    ,case when pi.dst_district_code in('PH180302','PH18030T','PH18030U','PH18030V','PH18030W','PH18030A','PH18030Z','PH180310','PH18030C','PH180313','PH180314','PH18030F','PH18031F','PH18031G','PH18030G','PH18031H','PH18031J','PH18031K','PH18031L','PH18031M','PH18031N','PH18031P','PH18030H','PH18031Q','PH18030N','PH18031W','PH18031X','PH18031Y','PH18031Z',
		'PH180320','PH180321','PH18030P','PH180322','PH180323','PH180324','PH180325') then 'flashhome代派' else '网点自派' end as '派送归属 belong_delivery'
    , case when tt.dst_routed_at is not null and tt.last_store_name<>ssd.dst_store then ssd.dst_store else tt.last_store_name end as '当前网点 current DC'
    , tt.last_route_time as '最后一次有效路由时间 last movement time'
    , tt.last_route_action as '最后一次有效路由动作 last vlid movement'
	, prlm.last_marker_time as '最后一次派件标记时间 last delivery mark time'
	, prlm.last_marker as '最后一次派件标记原因 last delivery mark'
	#, if(pi.discard_enabled=0,'否','是') as '是否丢弃 if discard'
    , di3.created_at as '最后一次进入闪速系统判责时间 latest Lost task system time'
    , if(di3.state is not null,'闪速系统判责中',null)  as '最后一次进入闪速系统判责进度 latest Lost task system process'
	, prm.SYSTEM_AUTO_RETURN_time as  '标记系统自动退件时间 auto return time'
	, prm.wait_return_time as '标记待打印退件时间 time of reprint waybill'
	, case when ssd.end_date>=current_date then '未超时效'
	    when ssd.end_date<current_date  and if( ssd.end_7_date is null,ssd.end_date,ssd.end_7_date) >=current_date then '普通超时效'
	    when if( ssd.end_7_date is null,ssd.end_date,ssd.end_7_date) <current_date then '严重超时效' else null end as '时效类别判断SLA category'
    , if(ssd.end_date<current_date,'已超时效','未超时效') as '是否超时效 if breach SLA'
    , datediff(ssd.end_date,current_date) as '距离超时效天数 breach in days'
    , case when datediff(ssd.end_date,current_date)<0 then '已超时效'
            when datediff(ssd.end_date,current_date)=0 then '即将超时效_距离超时效0天'
            when datediff(ssd.end_date,current_date)=1 then '即将超时效_距离超时效1天'
            when datediff(ssd.end_date,current_date)=2 then '即将超时效_距离超时效2天'
            when datediff(ssd.end_date,current_date)>2 then '即将超时效_距离超时效>2天'
        else null end as '超时风险类型 risk type of breach SLA'
	, datediff(current_date, date(convert_tz(bpt.latest_created_at,'+00:00','+08:00'))) as '最后一条回调距离今日的天数差 days from last callback until now'
	, case  when di3.state is not null then '丢失破损闪速判责中'
	        when  prm.SYSTEM_AUTO_RETURN_time is not null then '待退件'
	    	when  prm.wait_return_time is not null then '待退件'
	        when bpt.delivery_attempt_num >=3 then '满足三次尝试派送'
	    	when di2.pno is not null then '地址错分导致延迟'
	        when di.疑难件原因 is not null then '疑难件处理中'
	        when  datediff(date(now()),date(convert_tz(tt.dst_routed_at,'+00:00','+08:00')))>=3  then '网点未处理'
	        when  datediff(date(now()),date(convert_tz(tt.dst_routed_at,'+00:00','+08:00')))<3  then '到网点不够三次尝试'
			else null end as '滞留分析'
from tmpale.tmp_backlog_parcel_tiktok  bpt
left join ph_staging.order_info oi on bpt.tracking_no=oi.pno
left join ph_staging.parcel_info pi on bpt.pno=pi.pno
left join ph_staging.ka_warehouse kw on oi.ka_warehouse_id=kw.id
left join dwm.dwd_ex_ph_tiktok_sla_detail ssd on bpt.pno=ssd.pno
left join ph_staging.sys_store ss3 on ssd.dst_store_id=ss3.id


# 寄件人区域
left join ph_staging.sys_province sp1 on sp1.code=pi.src_province_code
left join ph_staging.sys_city ct1 on ct1.code=pi.src_city_code
left join ph_staging.sys_district sd1 on sd1.code=pi.src_district_code

# 收件人区域
left join ph_staging.sys_province sp2 on sp2.code=pi.dst_province_code
left join ph_staging.sys_city ct2 on ct2.code=pi.dst_city_code
left join ph_staging.sys_district sd2 on sd2.code=pi.dst_district_code


left join
(
	  select
	      distinct
		 tpr.dst_province_code
	    ,sp.name as dst_province_name
		 ,tpr.dst_area_code
	   from dwm.dwd_ph_dict_tiktok_period_rules tpr
	   join ph_staging.sys_province sp on tpr.dst_province_code=sp.code
	   where  tpr.sla_version='v2'
)tpr on ss3.province_code=tpr.dst_province_code # 收件人区域，寄件人区域

left join dwm.dwd_ex_ph_parcel_details tt on bpt.pno=tt.pno
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = tt.last_store_id and dp.stat_date =date_sub(current_date,interval 1 day)
left join ph_staging.sys_province sp on dp.province_code=sp.code
   left join
	(
		select
		        dt.pno
		        ,dt.staff_info_id
		        ,dt.created_at as delivery_created_at
		        ,tdt2.cn_element as last_marker
		        ,convert_tz(dm.created_at,'+00:00','+08:00') last_marker_time
		        ,row_number() over (partition by  dt.pno order by dt.created_at desc) as rk
		from ph_staging.ticket_delivery dt
		join tmpale.tmp_backlog_parcel_tiktok  dw on dt.pno=dw.pno
		left join ph_staging.ticket_delivery_marker dm on dt.id=dm.delivery_id
		left join dwm.dwd_dim_dict tdt2 on dm.marker_id= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category'
	) prlm on bpt.pno = prlm.pno and prlm.rk = 1 /*最后一条派件标记*/
left join
    (
			select
		        di.pno
		        ,di.staff_info_id
		        ,tdt2.cn_element as 疑难件原因
		         , convert_tz(di.created_at,'+00:00','+08:00') as 疑难件上报时间
			    ,if(cdt.operator_id=10001,'回访批量导入/自动处理',sd.name) as 疑难件处理机构
	          #  ,cdt.operator_id '客服操作人ID'
			    ,case cdt.state
					  when 0 then '未处理'
					  when 1 then '已处理'
					  when 2 then '正在沟通中'
					  when 3 then '财务驳回'
					  when 4 then '客户未处理'
					  when 5 then '转交闪速系统'
					  when 6 then '转交QAQC'
					  end '疑难件处理情况'
			 ,row_number() over (partition by di.pno order by convert_tz(di.created_at,'+00:00','+08:00') desc) as rk
		from tmpale.tmp_backlog_parcel_tiktok tt
		join ph_staging.diff_info di on tt.pno=di.pno
		left join dwm.dwd_dim_dict tdt2 on di.diff_marker_category= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category'
		left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id=di.id and cdt.organization_type=2
		left join ph_bi.hr_staff_info hi2 on hi2.staff_info_id=cdt.operator_id #疑难件处理人对应网点
		left join ph_bi.sys_department sd on sd.id=hi2.node_department_id # 待处理人部门
        where di.state=0
	)di on bpt.pno=di.pno and di.rk=1 /*疑难件原因*/
left join
    (
        select
	        di.pno
	        ,tdt2.cn_element as 疑难件原因
	        ,convert_tz(di.created_at,'+00:00','+08:00') as 疑难件上报时间
             ,row_number() over (partition by di.pno order by convert_tz(di.created_at,'+00:00','+08:00') desc) as rk
		from tmpale.tmp_backlog_parcel_tiktok tt
		join ph_staging.diff_info di on tt.pno=di.pno
		left join dwm.dwd_dim_dict tdt2 on di.diff_marker_category= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category'
		left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id=di.id and cdt.organization_type=2
        where di.state=1 and tdt2.element in(30,31,79,73,23)
    )di2 on bpt.pno=di2.pno and di2.rk=1  /*错分疑难件原因*/
left join
(
    select
		lt.pno
        ,convert_tz(lt.created_at,'+00:00','+08:00') as created_at
        ,lt.state
		,row_number() over (partition by lt.pno order by convert_tz(lt.created_at,'+00:00','+08:00') desc) as rk
	   from tmpale.tmp_backlog_parcel_tiktok tt
	  join ph_bi.parcel_lose_task lt on tt.pno=lt.pno
	   where lt.created_at>date_sub(CURRENT_DATE ,interval 30 day)
	   and lt.created_at < current_date()
	   and lt.state not in(5,6)
    )di3 on bpt.pno=di3.pno and di3.rk=1  /*丢失*/
left join
    (
	    select
	        pr.store_id
	        ,pr.pno
	        ,pr.store_name
	        ,pr.routed_at
	        ,pr.staff_info_id
	        ,pr.route_action
	    from
	        (
	            select
	                pr.pno
	                ,pr.store_id
	                ,pr.routed_at
	                ,pr.route_action
	                ,pr.store_name
	                ,pr.staff_info_id
	                ,row_number() over(partition by pr.pno order by pr.routed_at DESC ) as rn
	         from ph_staging.parcel_route pr
	         where pr.routed_at>= date_sub(now(),interval 1 month)
	         and pr.route_action in('DELIVERY_TICKET_CREATION_SCAN')
	        )pr
	    where pr.rn = 1
    ) pr2 on pr2.pno =bpt.pno -- 最后一次交接
left join
    (
	    select
			pc.pno
			,pc.sorting_code
	        ,pc.third_sorting_code
	        ,pc.line_code
	        ,row_number()over(partition by pc.pno order by pc.created_at desc) as rn
		from ph_drds.parcel_sorting_code_info pc
		join tmpale.tmp_backlog_parcel_tiktok   bpt on pc.pno=bpt.pno
	)pc on pc.pno =bpt.pno and pc.rn=1 -- 包裹最新派件码

left join
    (
           select
           pr.pno
           ,max(if(pr.route_action = 'SYSTEM_AUTO_RETURN',date(convert_tz(pr.routed_at, '+00:00', '+08:00')),null)) as SYSTEM_AUTO_RETURN_time
           ,max(if(pr.route_action in( 'PENDING_RETURN','DELAY_RETURN'),date(convert_tz(pr.routed_at, '+00:00', '+08:00')),null)) as wait_return_time
           from ph_staging.parcel_route pr
           join tmpale.tmp_backlog_parcel_tiktok  bpt on pr.pno=bpt.pno on pr.pno=bpt.pno
           where pr.route_action in( 'SYSTEM_AUTO_RETURN','PENDING_RETURN','DELAY_RETURN')
           and pr.routed_at >= date_sub(now(),interval 3 month)
           group by 1
    )prm on bpt.pno=prm.pno  -- 打印退件和待退件
where  datediff(ssd.end_date,current_date)<=0;
;-- -. . -..- - / . -. - .-. -.--
select
    vrv.link_id 单号
    ,bc.client_name 客户
    ,vrv.client_id 客户ID
    ,vrv.violation_remark 尝试派送次数
    ,ddd.CN_element 计入多次尝试派送回访前的标记
    ,ss.name 网点
    ,smp.name 片区
    ,smr.name 大区
    ,vrv.ticket_created_at 回访任务创建时间
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
left join dwm.dwd_dim_dict ddd on ddd.element = json_extract(vrv.extra_value, '$.marker_category') and ddd.db = 'ph_staging' and ddd.tablename = 'diff_info' and ddd.fieldname = 'diff_marker_category'
left join ph_staging.sys_store ss on ss.id =vrv.store_id
left join ph_staging.sys_manage_piece smp on smp.id = vrv.piece
left join ph_staging.sys_manage_region smr on smr.id = vrv.region
where
    bc.client_name = 'tiktok'
    and vrv.ticket_created_at >= '2023-08-01'
    and vrv.type = 8
    and vrv.violation_remark > 3;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
    ,pi.dst_phone
    ,pi.dst_home_phone
from ph_staging.parcel_info pi
where
    pi.pno in ('PT073122DJR94BF','PT370422DBQ18AS','PT520722BTH36AK','PT151622FAR19CB','PT150422GBGJ7AO','PT190522FMFX6AS','PT271522DRPZ8AK','PT390622BSPA7AT','PT121122G6795AH','PT020622CHZR2AP','PT071422E3J26AC','PT062622FNJF6AG','PT401922CB7F0BB','PT630222CWBT5AC','PT401422D2AZ4AF','PT210222EVNE7AK','PT070322CTH06AC','PT080422FMJY4AF','PT241922EC6K8AW','PT192522ENRX2AN','PT240622B1YD8AQ','PT160422DF056AC','PT203922CT9Y0BQ','PT344522DAJ97BE','PT612622DZDD5AH','PT192422FWY79BO','PT160722EXKZ0AI','PT150522F37C5BJ','PT150222CYRQ5AA','PT062522FHVR0AA','PT110322EYRV2AN','PT5207229CWG6AK','PT242422D7Y86AM','PT240522BEB62AJ','PT210422ES542BA','PT180622G5BX3CB','PT791122FRAU3AI','PT241822EBJF9AK','PT180222FBKS3AI','PT613022FR8P7AN','PT261222DR9M9AS','PT612522EDB28AP','PT610622E0Y96AV','PT140922G72V2AR','PT641022BM982AH','PT611822FWB08BQ','PT612022FPUM1CU','PT612722DHZP5AH','PT611822DB9T4AV','PT611722G00E3BA','PT611722F2QF1AO','PT070122D5HW3AQ','PT612022G2PA3EK','PT612722EEFH0AF','PT260122DDVX5AT','PT131722FA814AD','PT611822CBKB5AS','PT612722D1884AK','PT612722GCET9AD','PT044222FJNB8AN','PT611622G0HX0AJ','PT611622DH5E8AE','PT070822DSV98AZ','PT044222G9B20AA','PT171422FR1C5CF','PT612022FHW97FC','PT612322CWYJ1AK','PT611822DBR94EU','PT611822EU3N0EW','PT611822DBH34DX','PT611822FP365BE','PT611822E2NB4EK','PT261122DWKX8AS','PT612022FG970GF','PT800322FPPV7BG','PT800522FJ312BH','PT010522EN488BB','PT350622BS6K7AP','PT230322EVAU2AH','PT070222FT3N4BS','PT072422FC182AR','PT072422FC0C4AR','PT350822AKUE6AF','PT120722E3H33AB','PT390622BA2F5AX','PT390922DA4T9CE','PT080322F6SX9AM','PT660622D5QG6AH','PT132722ESKA0AD','PT611722E4XR6AE','PT612722DN3H3AA','PT612322G0CH8BD','PT611822CUNS6AW','PT611022FSDG9BQ','PT611822FM8N7AC','PT611822E6W92AF','PT261222D2MZ1AY','PT041422ETA37AM','PT331722CGFC3AI','PT122022FGSC2AG','PT800822DP9G1AM','PT352722DDZ09AN','PT122322FXEV1AF','PT062922FNTV0BV','PT070822CPJ73BO','PT490122CHD06AN','PT370422DGMV8AS','PT230522DDS68AZ','PT090122F8TH8AD','PT150422EN6C4AQ','PT192522FNSN2AO','PT150922FPD49AN','PT141622F7HB9AD','PT141622FM6W4AJ','PT611822D06B1FI','PT611822G6E88AW','PT140922EBNC7AP','PT612522FNY58AE','PT612722G84G4AL','PT612722DSFS4AL','PT610622G1EX2FG','PT612822DSGA3BR','PT613022FR4W6AE','PT612522CCME8AM','PT230322BQPK1AL','PT073522FUGQ5AY','PT192522FNWN0AN','PT151622FNFA2BP','PT210222DJND6AC','PT251122E1NX8AZ','PT122022F6MG1AG','PT080322FA0R2AQ','PT612022FSXD4GS','PT350222CQNM5AE','PT122022FQ522BS','PT660222D4H42AH','PT612822F8VV6CX','PT140122DS6B7AV','PT611822FAZZ3EP','PT141522FD9P3AL','PT141522F2A99AJ','PT140122EHP54AO','PT660622D7925AV','PT121222EV8E1AA','PT062922FHT87BB','PT062922FDRJ0AM','PT270922D8ND8AT','PT122322G9XS1AI','PT660622EGW69AH','PT180322EC2R1BJ','PT790122CBTW8AF','PT010522EENU9AC','PT180622G3G25AX','PT180422FKBT8AN','PT181522FKKB1AG','PT210222EDDQ0AE','PT402122CAQ64AM','PT181922F6TS3AF','PT210522EBVZ3AA','PT210522FGZZ5AA','PT400222C4665BD','PT240622D7390AN','PT630522F4DF2AT','PT630222D0FR0AJ','PT790922FR0W3AB','PT141622FNVP3AH','PT611822F9Y24FI','PT611822FGP43FI','PT612022F7YS1CL','PT612722F8327AL','PT170622FQX30AM','PT130822F3JY5AM','PT140922FS9D5AL','PT191122D74V2AA','PT150222FD8G9AL','PT062922EYRC8AG','PT062922F8Y28AY','PT090322EBMW7AN','PT800822DQ9R4CG','PT801222F7C88AA','PT121022F11M5AH','PT210822F5CB9AJ','PT210822G78V8AJ','PT0430229FUH3AJ','PT192522EF515AB','PT613022EZA50AB','PT611722DBA02AI','PT610822FKRV2AI','PT262122B3EM8AI','PT140122FF604BF','PT301522DKYZ1AD','PT062922FDMQ1AL','PT190422F4D68AL','PT204122CHS79AS','PT611822FZWJ7EO','PT640222F96F9EE','PT640222F0PD8AA','PT611822F1V50AE','PT044122FUVK8AQ','PT141522EW1S8AL','PT043122D38H2AA','PT130322F2TZ7CB','PT612722FZZU9AE','PT613022G4SE8AO','PT610622GBGU8EE','PT110622FYKJ3AD','PT790122DEA51AE','PT070822FRT92AA','PT231122EDJY3AF','PT071322FEE76AG','PT110322FMSA3AF','PT160522BR819AA','PT161422D5826AH','PT161422EE3S9AH','PT210522FH3W2AA','PT322122BSF59FD','PT140722FZHJ8AX','PT612322FU5H3AS','PT140122ERNQ3AG','PT612322G6BX0AS','PT612422F5HB6AJ','PT613022FCM14AJ','PT140922G5GB5AC','PT062922F7MU4BO','PT230322CA9C5AM','PT072622E9UT6AT','PT070822CV1P3BM','PT800822CEWU2CK','PT801222CNXR6AN','PT121322EC3T8AF','PT021422FBP90AZ','PT390922B1NF1AN','PT380822B7PU9AO','PT340422D2E21AG','PT221222CJ3B0AY','PT201822E8W86AB','PT611822FHJU2DK','PT362022D2PT4AE','PT341922CP2R5AJ','PT341922DRQX1AK','PT190222FG9X7AK','PT150222F1U64AA','PT150522FJ705BH','PT230322DWEZ7AO','PT071322F3YC7AJ','PT062922F1D66BO','PT110622FKFW4AB','PT061722DYNN3BC','PT190522DYZW9AU','PT121022E8GK7AA','PT121722G67X9AB','PT122022FRB18AG','PT420722B7YQ7CJ','PT122022F7S12BE','PT801122EHXP0AI','PT800422CHJR6AF','PT352422CD7C0BJ','PT271522DBZN5BL','PT121522FS7N7AQ','PT190322DZHT3AM','PT621022EWMH5AF','PT181022D1XB5AE','PT611022DF441AK','PT243722EHSM0AL','PT210522ETS09AB','PT141622GACU3AI','PT261222C6689AS','PT612722G0996AA','PT612722FWZ30AD','PT140422FGT15AS','PT171422CCFS2BY','PT611322ERCY8AB','PT641022EZR93AH','PT611822DZA69EU','PT611822F9C74ET','PT611822FG7T9CN','PT611822G2HX5BQ','PT611522FTND3AA','PT612022FPZD6GR','PT182222DKYP6AB','PT242422B8W59AI','PT182322F3512AF','PT210222G1169AI','PT011222EC467CZ','PT321522APUT0BB','PT243022CSUD3AU','PT230322ET7E9AO','PT370422B1A89AI','PT230322BAPZ4AG','PT111022ESNX9AS','PT062322D2466AC','PT230722BUYQ5AB','PT110722ED7P0AI','PT060822D1DD8AY','PT073522EKM95AO','PT612022F0BT0HF','PT140122EV1K3AD','PT611522FJGQ6AE','PT262122B9KT3AM','PT612022FQ1X2CS','PT610922FS0Z1AE','PT261522AT1E0AP','PT261122A76D5AH','PT141622F83C7AZ','PT042522DGMW2AR','PT140622G3MK2AI','PT610322DFNU1AC','PT612022DUZE6GD','PT140122ERQS1AV','PT611822E2WK4AY','PT611822G6FE7FH','PT611822G95X9DR','PT611822E9T72DD','PT611122D89X4AT','PT611822FRHP2EI','PT130222DQ945AF','PT611822E5VX1DW','PT611022EX944AF','PT640222EU6J2AX','PT612322F0YF1AH','PT044822DPPA2AO','PT260622B5P77AG','PT190322G4V92AV','PT180622DH1E2AN','PT241522EFH61AR','PT243722CFKS1AK','PT230322DTWP8AT','PT072222EB2M1AC','PT110422E1J85AZ','PT062922F91R4BP','PT230322DGTB7AM','PT230722C9AA9AY','PT210222FWAR1AB','PT321522D16A4AJ','PT211322FQU16AA','PT210222DFWT2AE','PT180822FVRT5AP','PT211322D2GH5AE','PT612322F1R73AD','PT612722E6SN8AH','PT613022DF5Q3AB','PT140722FFTG3AP','PT611622FUD96AN','PT611622EP3C8AB','PT140122F3060AE','PT140122EUZJ2AD','PT043822GFG16AC','PT611722G8A75AM','PT211322FEKU7AE','PT611722FVE75AG','PT612022DH3P7GV','PT260522B1MJ9AH','PT141822FG5E7AD','PT260122CM921AA','PT611822G7WB5AH','PT640222D0EG8DS','PT611522FBT85AA','PT612022G4JS5GT','PT791022F9SN8AR','PT791022EVW47AO','PT240622DMCK6BF','PT210222GG110AD','PT073522EC1R4AS','PT140322FKHC5AS','PT070822F41U6BJ','PT150522EKXH8BC','PT192822FQRM6AR','PT031422DJNG3AZ','PT160722EG302AJ','PT221122E0R82AM','PT342522D63D3AK','PT192522CF4T8AF','PT160122FTJR6AE','PT031422CSYJ0BZ','PT170422CESE3AI','PT610322FPKB3AA','PT611822FVAK3AQ','PT611822FMCJ2CN','PT611622G8VN4AH','PT612022FR3R4CU','PT611822DQEY8AV','PT612022FNPS1FL','PT612822GBTV8GQ','PT612822FWWF2GX','PT611522FP5J1AA','PT062922CC4E6BD','PT061322FAPY3BM','PT061222EPC54AJ','PT170522EJ937CF','PT031122DDRV6BI','PT151622G65U4BZ','PT151122CFQN9AO','PT161422FNGS0AH','PT790922FF7T1AL','PT182022FKJQ5AS','PT180222DD1M2AX','PT210822E9VN1AA','PT190322FP9A7AX','PT192422EHKP2BU','PT140122FFCX5AH','PT612322FZWA4AS','PT612022ESMA1HF','PT612022FSVD6AQ','PT610122EFX32DW','PT612122FGRA8AU','PT140922F4PX5AE','PT180322CWVB9BQ','PT612722FEC33AA','PT612022F5F24AK','PT613022E3AE0AM','PT611022G7AE2BI','PT640222F46K3BI','PT132822CFRA8BF','PT612022FV9B1GO','PT122022FJN53AP','PT023322FBCU5AQ','PT800922D4MK7AM','PT402322CE9Z4AL','PT192422G07H4AH','PT160722F37B1AG','PT160722EUTZ1AI','PT160722CA915AF','PT150422G87G5AP','PT170522DN4V1BY','PT040422FBAW0AC','PT611822FSPU2FI','PT611822FN262DA','PT611822EFBB6FI','PT044522G2FW0AA','PT641022DH5R6AH','PT130322FAE60AY','PT140922F7R83AK','PT042822F0N28AK','PT132122FNT54AI','PT640222FMVC0BL','PT611822G8G17DS','PT640222DBUG2AP','PT612522DFE05AB','PT140122EWW12AF','PT182022DPU71AS','PT151222FTWT1AC','PT391522CZSN5AR','PT140522D6HM7BE','PT121822FBVN8AD','PT800522E5U53AP','PT080522F9ME3AB','PT100722DHAB9AA','PT241522EUX86AI','PT242422CZ1E8AD','PT180322F87D5CU','PT210222G9576AD','PT210522ESW44AB','PT402722CZG42AW','PT241122CMN01AH','PT19282270QQ0AQ','PT192822G0Y88AQ','PT031422CFWW2CD','PT160122FTJY7AE','PT150522EWRD6BM','PT613022FV8M1AH','PT140922G4VZ7AG','PT610122G1G84GQ','PT611822E46C4CN','PT471722C38N4AZ','PT142122DZK92AB','PT640222F8GP5AB','PT141622F4TW5AO','PT171422EV400BY','PT171422F6VF2AC','PT610222DVFZ3AE','PT130322FDEJ3BA','PT641022FH534AK','PT611822G7X07BR','PT140622G26F8AU','PT240122EWE82AR','PT362022CBFN2AI','PT161422FPR27AI','PT161322C8WU9AB','PT640222FATP2CV','PT640222EYN25EA','PT611622FZXG8AM','PT611722FWVS2AS','PT611622DBUM3AA','PT140922DX365AE','PT043022F8W81AY','PT610122FF001BB','PT261122CYR31AX','PT611822ETNX6EQ','PT611822DF0A5DB','PT611822FG2C6EC','PT612822F6WB0AN','PT611822FC4A6EH','PT141322FQAG4AM','PT612022FFKW2CN','PT611722E6F95AQ','PT612522F1H20AB','PT140722FSNG1AF','PT043522EUWR3AC','PT612822EF6F7CX','PT044622C8CS0AZ','PT140922FSB89AL','PT031422ESF50AQ','PT7301229W4W5AF','PT243722CEP06AG','PT100322DUVV6AI','PT151622G8ND3CU','PT220322DHS38BQ','PT201822F96J7AZ','PT203822FEE01BE','PT612322FJ0H0AQ','PT042222DT499AB','PT611822FXW72BN','PT640222F4062AE','PT611822E7W11EG','PT613022F2RF3AH','PT042022G5XZ4AF','PT130322E5N16CQ','PT261522AWUR2AN','PT171922DRMM7BL','PT130422EME07AU','PT612722FC9F2AH','PT261222B2DA7BA','PT613022DJ662AH','PT141322F2Q83BO','PT612722FE244AG','PT612022FD108CW','PT042222EQEN9AY','PT172322DGQ63AX','PT4710229H6R5AM','PT612122G6CU5AG','PT130822FFRD6AJ','PT611822DDEE7CV','PT041822E9D90AT','PT640622FM3P6AG','PT261022D4N93AF','PT611822G1RV5EF','PT640222DT363DN','PT611822G1A16CP','PT612022FR209AH','PT612022FG3F7GF','PT612622FBHB7AF','PT612622FR361AF','PT150622G6973AY','PT230322EVB08AH','PT110522E5ZK6AD','PT110622FRZM4AH','PT073722DG2Q3BI','PT073522ET1Y9AZ','PT060622F7A10AA','PT022022FE7A5AE','PT122022G3BM2BW','PT331722BHCU6AK','PT660422D7Y56AT','PT080522DB8F8AJ','PT243622D4VP0AM','PT791022FEF81AR','PT012122F1X97AC','PT630522E7KQ1AE','PT630522DPBZ2AT','PT180622G5982CB','PT011122ETF56AJ','PT430922AGK50BB','PT200722ECQE3AE','PT220222D0CZ3AH','PT192822FHZJ8AP','PT160722FEZA8AJ','PT161222F8EE8AB','PT612622D8166AF','PT612322DNWK2AQ','PT612522E8ZP1BE','PT613022G3YV2AM','PT612822DZJ76BI','PT6121226ZXC7AJ','PT650922EGVQ8AF','PT612722D30D5AA','PT613022FJDN2AM','PT140322D7QZ4AU','PT641022FE421AE','PT042422FU1R5BU','PT611822EW7F2BC','PT611822FU181BI','PT612722708D2AF','PT171722FRU65AE','PT130322FH079CA','PT171422DTEC6AK','PT611522DJ2Y0AC','PT612322E8B71AR','PT800922CYW70BG','PT230822CZD85AZ','PT070822F8S97BH','PT060522F3UF0AZ','PT150922FWMF5AR','PT610622DG4K8AY','PT410522A9W59BR','PT150422EJD56AQ','PT190422FKQC1AJ','PT191922E9PJ4AN','PT402322D6MB8AH','PT203822F4YS5AR','PT344422DCYU6AN','PT660622DVYQ3BJ','PT420222B75D1BV','PT241522EWX20BA','PT023422FP3X8AA','PT140122EECH5AH','PT140122CZWP2AL','PT612322FHZA0AQ','PT140122ENNJ0AM','PT261222CX282AA','PT612122EKTZ0AJ','PT611822D6JC7EG','PT140922E9Q13AM','PT612522F9CF6BC','PT612822DKK75AN','PT072522EW390AN','PT060522FF5W9AS','PT120722FB4T8AH','PT021222EWR39AK','PT010522D05D8AB','PT431822D8YS6AS','PT210422FVC96AM','PT243022DJFD6AD','PT151622FCPQ9CB','PT201822FKA12AT','PT192822FP2K1AO','PT360222C0EW1AW','PT161422EEKH7AH','PT402322D5UQ5AH','PT612822D9T27HA','PT613022FCT69AO','PT130322DY7T0AP','PT611822EHHN5DE','PT612122GD8H5AK','PT141122FYEP9AU','PT130322EU169BJ','PT140922FPC84AX','PT610622CU8C7GM','PT140122EJCB5BF','PT611822FQH41BI','PT611822E7WV3AC','PT612522FWE47AP','PT044122EFDC7AW','PT610422DXFR8AI','PT190322G8FF5AS','PT180422FX9Q5AA','PT010522EWDP6BH','PT242422EFHP4AU','PT060222D5E30AH','PT073522DCWX6AY','PT280722BPDP3AI','PT080322EXK81AF','PT271522EXC32BL','PT190322FJR58AV','PT242522CW5J3AA','PT243122D3HE0AI','PT210822G61A2AJ','PT243722EBDZ4BO','PT210622EFHV7AH','PT181222EZF60AE','PT790822EVPM0AG','PT431022BF2J4AH','PT160722DGGV8AC','PT160922F51E6AF','PT150222FJTF6AL','PT362322BVSZ5AA','PT160122F5GS8AP','PT190422DVP58AE','PT161422C2G40AC','PT343322AAQ45AD','PT611822FSAT4DA','PT611822EH3U7CN','PT611822FNP48FI','PT611822FRN26BK','PT612522DKXZ5BC','PT612722DJQW6AJ','PT611922FJRH9AU','PT612822G55R5AY','PT260322BBV24AO','PT041122FW2Y6AW','PT610322EJSK6AF','PT612022DSQF2FY','PT042422D1TY9AY','PT611522D00R2AV','PT612022GE7M7GV','PT041822DGNH1AH','PT130322FJCM7CK','PT640222E72W7AA','PT612122D5VM9AI','PT390622BP2D4AZ','PT071222FRZX5AV','PT110722E3MJ3AP','PT073522F3KC7AY','PT070122F2725AW','PT331222CF773AA','PT121122FV6H3AA','PT122022F7SF0BE','PT7309229NEE0AD','PT180222FYJ00AC','PT400122D0FV2CB','PT210222FG888AO','PT790922EM0N5AI','PT211322G3Z17AE','PT180822F8FR7BD','PT210222FD228AD','PT210222FW1W9AB','PT210522DVRV3AF','PT211122FRHP1AH','PT612022FGED6BE','PT171422DMRX7BJ','PT141722EE5S0AM','PT611822EBR91BJ','PT171922DRCE2BL','PT611622FRF84AG','PT611722D6BD3AS','PT132322EE270AK','PT611922E97W4AM','PT130222CU6R2AL','PT613022DMHX3AR','PT613022DMHP4AL','PT612522FHBJ2AP','PT140722FZGX8AX','PT133122EH6B7AN','PT611422FZ5F4CN','PT261522D9Y74AR','PT611822EBAT2EO','PT261722CFDA6AL','PT611822D6PE4BN','PT640222DE3V6BP','PT130322FJHV8AG','PT044722D93X4AF','PT611822FSV95AR','PT611822EWK54AJ','PT130322EK9S0AF','PT141522FTRK4AD','PT640222CUV98EL','PT613022G3AR5AO','PT170522CN890EA','PT612022G5W57AL','PT041822D2623AF','PT142222FSVK3AI','PT043822FVJ06AQ','PT170522CN8A4EA','PT612722DAHE2AM','PT141022DJX54AO','PT611822F8CJ5CC','PT260522AEPZ2AZ','PT611722FK089AW','PT180322ENJ91CB','PT210222CX9Y4AB','PT210222CZ4G6AB','PT343022D5H64BY','PT160422F6BU1AC','PT271122DV138AM','PT611822EFW17BE','PT611822FR0D4BE','PT044522ENE21AC','PT611822DY9G0EC','PT611822FYAD7AK','PT611822G5BW5CR','PT641022DHRH0AH','PT611822DDER3CR','PT641022DUP58AH','PT140622EXXX5BE','PT140922FS7C1AL','PT612822FD593CX','PT610122FWDG3GN','PT612522FXHK7AR','PT640222FGDD8AD','PT130322FGVB7CT','PT042622EJ855AM','PT011222EUQ57BZ','PT180922FS3V6CV','PT180322FMB28AY','PT520322A5CA6AL','PT072622FF6P0AV','PT031422CFVU0CD','PT190122EXTT3AE','PT221022D72A8AK','PT192822FP065AO','PT161422ER6C1AH','PT611422EUPK9AA','PT140122EUXT4AG','PT041922FGCU0AM','PT612822CYX10AA','PT261222DN5C9AA','PT641022FNZM4AH','PT641022ESJ91AH','PT612022DUV40BH','PT641222EX8R5AH','PT611822F9QV4EP','PT611822EMW20AW','PT611822DQCH9AF','PT641222F6H59AE','PT140622EEYP6AS','PT130322DZHF8AX','PT612722GGK51AP','PT612022E5702GT','PT260522DPYH3AZ','PT612722EGQW3AN','PT612022DKQV9FU','PT132622BRP03AY','PT610522FN537AH','PT611622FZHJ0AE','PT260522DBVV7AZ','PT173122FHDD1BB','PT612022EGS34FU','PT061322FAM38AC','PT110822EN642AA','PT230722CE882AB','PT322122B0YR1BB','PT210122E4FD4AJ','PT180122G04S6AO','PT181922CZ657AF','PT210222F7VN1AB','PT122322E0UK7AK','PT801522D4R22AF','PT354722D88H9AO','PT141622F5D07AA','PT612122FDBZ3AN','PT612122DN6V4AR','PT611822DQ9Y2FI','PT130322CF076AM','PT130322FG514AI','PT611822EX082AJ','PT612522FHMX8AP','PT140122EPS04BF','PT172322DDDT6AX','PT170522FEKR8AL','PT612422G36H2AQ','PT132122FNJK7AI','PT043522EV6A4AC','PT010422FFVY1AM','PT071422CH033AE','PT230522CBSC0AN','PT110722DPKM1AN','PT073522CVZX4AG','PT150222FRY25AA','PT150222G75R1AO','PT150822CDKN5AV','PT410122C9MT1AF','PT151622EJ6Z1AN','PT160722EUAV0AJ','PT151622FG849CF','PT361922CMMZ0AQ','PT121122G9H22AF','PT800522ET0D9BC','PT122222FX5A6AI','PT121022G3QH3AA','PT122222G7336AC','PT132722CX3E8AO','PT130422CG6T1AL','PT612422FVWX5AR','PT042422F0PK8AD','PT261222BT8Y6AZ','PT611622G2XA7AH','PT613022EC900AR','PT790622EZMR9AC','PT790522F2C19AI','PT241222DR4X0AL','PT230722C5FY9AY','PT343122AYVT8AN','PT160122EKEH0BD','PT612722G4ME1AM','PT261222BQGW0AA','PT041722FYXD3AB','PT132622FHQK2AK','PT261022DM799AF','PT611622G2NT2AG','PT132922FKKY0AN','PT611722FT8W2AO','PT041822E0HZ0AT','PT613022FW875AA','PT611822E6HZ4EU','PT611822EP590CK','PT640222E0JF6AN','PT611122DMEG1BO','PT612022F6XQ7FZ','PT612022FG972GF','PT011222DVKG2CW','PT011222F8GN8BJ','PT210522G3X67AE','PT210822G3MJ6AJ','PT150522FDX82BL','PT271522DPT51AG','PT121222ENC91AB','PT023422EU735AM','PT660622F3CD7AR','PT800522FKVU5BH','PT120922E3876AM','PT021422F2HW0BG','PT660422F9BE6AT','PT780422F0P56AM','PT130322E8K75AI','PT130322CV7J4CZ','PT611822DMQV1CR','PT611822F6UY1DD','PT140122G6YZ5AG','PT260622AGYA3AU','PT141522EVZS5AL','PT043122BKD00AR','PT131922F4HE8AB','PT612422FRTN4AP','PT612022EGHG3AH','PT612822F98X2ED','PT180622G3KT4AX','PT431822CHME2AA','PT790222EZX06AE','PT242422EFAA4AN','PT182022EU4F8AX','PT620122FU8H7AB','PT211322GE024AE','PT790922FGYT9AI','PT011222DT3M3BX','PT210222G8966AD','PT610522G6TX5CS','PT612122G87M7AO','PT171422CBYB3CB','PT612022FCQ73GS','PT612722ETPG7AA','PT612722F30Q4AA','PT612722FF2U3AA','PT612722FGZ48AI','PT130322CYSR8CI','PT044622EUMB9BC','PT260522D2G72BF');
;-- -. . -..- - / . -. - .-. -.--
SELECT
    vrv.link_id
     , IF( vrv.type = 3, '收件人拒收','多次尝试派送') AS 回访类型
    ,vrv.visit_num 回访次数
FROM nl_production.violation_return_visit vrv
WHERE id IN(
    SELECT
       MAX( vrv1.d)
    FROM nl_production.violation_return_visit  vrv1
    WHERE  vrv1.type IN(3,8)
    AND  vrv1.visit_state = 6
    AND vrv1. overtime IS NOT NULL
    #AND link_id = 'P61281YC2SKDG'
    GROUP BY  vrv1.link_id;
;-- -. . -..- - / . -. - .-. -.--
SELECT
    vrv.link_id
     , IF( vrv.type = 3, '收件人拒收','多次尝试派送') AS 回访类型
    ,vrv.visit_num 回访次数
FROM nl_production.violation_return_visit vrv
WHERE vrv.id IN (SELECT MAX(vrv1.id)
                 FROM nl_production.violation_return_visit vrv1
                 WHERE vrv1.type IN (3, 8)
                   AND vrv1.visit_state = 6
                   AND vrv1.overtime IS NOT NULL
                 #AND link_id = 'P61281YC2SKDG'
                 GROUP BY vrv1.link_id);
;-- -. . -..- - / . -. - .-. -.--
SELECT
    vrv.link_id
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end 包裹状态
     , IF( vrv.type = 3, '收件人拒收','多次尝试派送') AS 回访类型
    ,vrv.visit_num 回访次数
FROM nl_production.violation_return_visit vrv
left join ph_staging.parcel_info pi on pi.pno = vrv.link_id
WHERE vrv.id IN (SELECT MAX(vrv1.id)
                 FROM nl_production.violation_return_visit vrv1
                 WHERE vrv1.type IN (3, 8)
                   AND vrv1.visit_state = 6
                   AND vrv1.overtime IS NOT NULL
                 #AND link_id = 'P61281YC2SKDG'
                 GROUP BY vrv1.link_id);
;-- -. . -..- - / . -. - .-. -.--
SELECT
    vrv.link_id
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end 包裹状态
     , IF( vrv.type = 3, '收件人拒收','多次尝试派送') AS 回访类型
    ,vrv.visit_num 回访次数
    ,ss.name 上报网点
    ,convert_tz(di.created_at, '+00:00', '+08:00') 上报时间
    ,date(convert_tz(di.created_at, '+00:00', '+08:00')) 上报日期
    ,case cdt.state
        when 0 then '未处理'
        when 1 then '已处理'
        when 2 then '沟通中'
        when 3 then '支付驳回'
        when 4 then '客户未处理'
        when 5 then '转交闪速系统'
        when 6 then '转交QAQC'
    end 问题件处理状态
FROM nl_production.violation_return_visit vrv
left join ph_staging.parcel_info pi on pi.pno = vrv.link_id
left join ph_staging.diff_info di on di.id = json_extract(vrv.extra_value, '$.diff_id')
left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
left join ph_staging.sys_store ss on ss.id = di.store_id
WHERE vrv.id IN (SELECT MAX(vrv1.id)
                 FROM nl_production.violation_return_visit vrv1
                 WHERE vrv1.type IN (3, 8)
                   AND vrv1.visit_state = 6
                   AND vrv1.overtime IS NOT NULL
                 #AND link_id = 'P61281YC2SKDG'
                 GROUP BY vrv1.link_id);
;-- -. . -..- - / . -. - .-. -.--
SELECT
    vrv.link_id
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end 包裹状态
     , IF( vrv.type = 3, '收件人拒收','多次尝试派送') AS 回访类型
    ,vrv.visit_num 回访次数
    ,dp.store_name 上报网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,convert_tz(di.created_at, '+00:00', '+08:00') 上报时间
    ,date(convert_tz(di.created_at, '+00:00', '+08:00')) 上报日期
    ,case cdt.state
        when 0 then '未处理'
        when 1 then '已处理'
        when 2 then '沟通中'
        when 3 then '支付驳回'
        when 4 then '客户未处理'
        when 5 then '转交闪速系统'
        when 6 then '转交QAQC'
    end 问题件处理状态
FROM nl_production.violation_return_visit vrv
left join ph_staging.parcel_info pi on pi.pno = vrv.link_id
left join ph_staging.diff_info di on di.id = json_extract(vrv.extra_value, '$.diff_id')
left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = di.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
WHERE vrv.id IN (SELECT MAX(vrv1.id)
                 FROM nl_production.violation_return_visit vrv1
                 WHERE vrv1.type IN (3, 8)
                   AND vrv1.visit_state = 6
                   AND vrv1.overtime IS NOT NULL
                 #AND link_id = 'P61281YC2SKDG'
                 GROUP BY vrv1.link_id);
;-- -. . -..- - / . -. - .-. -.--
select
    case
        when bc.`client_id` is not null then bc.client_name
        when kp.id is not null and bc.id is null then '普通ka'
        when kp.`id` is null then '小c'
    end as  客户类型
    ,pi.pno
    ,ddd.CN_element 问题件类型
    ,case ss2.category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 揽收网点类型
from ph_staging.parcel_info pi
left join ph_staging.sys_store ss on ss.id = pi.dst_store_id
left join ph_staging.sys_store ss2 on ss2.id = pi.ticket_pickup_store_id
left join ph_staging.ka_profile kp on kp.id = pi.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
left join ph_staging.diff_info di on di.pno = pi.pno and di.state != 1
left join dwm.dwd_dim_dict ddd on ddd.element = di.diff_marker_category and ddd.db = 'ph_staging' and ddd.tablename = 'diff_info' and ddd.fieldname = 'diff_marker_category'
where
    pi.state = 6
    and pi.dst_store_id in ('PH14010F01', 'PH17080300');
;-- -. . -..- - / . -. - .-. -.--
select
    case
        when bc.`client_id` is not null then bc.client_name
        when kp.id is not null and bc.client_id is null then '普通ka'
        when kp.`id` is null then '小c'
    end as  客户类型
    ,pi.pno
    ,ddd.CN_element 问题件类型
    ,case ss2.category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 揽收网点类型
from ph_staging.parcel_info pi
left join ph_staging.sys_store ss on ss.id = pi.dst_store_id
left join ph_staging.sys_store ss2 on ss2.id = pi.ticket_pickup_store_id
left join ph_staging.ka_profile kp on kp.id = pi.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
left join ph_staging.diff_info di on di.pno = pi.pno and di.state != 1
left join dwm.dwd_dim_dict ddd on ddd.element = di.diff_marker_category and ddd.db = 'ph_staging' and ddd.tablename = 'diff_info' and ddd.fieldname = 'diff_marker_category'
where
    pi.state = 6
    and pi.dst_store_id in ('PH14010F01', 'PH17080300');
;-- -. . -..- - / . -. - .-. -.--
select
    ds.pno
    ,pi.duty_store_id
from ph_bi.dc_should_delivery_today ds
left join ph_staging.parcel_info pi on pi.pno = ds.pno
where
    ds.store_id=  'PH14010F01'
    and ds.stat_date = curdate();
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
    ,pi.dst_store_id
    ,pi.state
from ph_staging.parcel_info pi
where
    pi.dst_store_id in ('PH14010F01', 'PH17080300')
    and pi.interrupt_category = 3;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
    ,pi.dst_store_id
    ,pi.state
    ,pi.finished_at
from ph_staging.parcel_info pi
where
    pi.dst_store_id in ('PH14010F01', 'PH17080300')
    and pi.interrupt_category = 3;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
    ,pi.dst_store_id
    ,pi.state
    ,
from ph_staging.parcel_info pi
where
    pi.dst_store_id in ('PH14010F01', 'PH17080300')
    and pi.interrupt_category = 3
    and pi.returned_pno is null;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
    ,pi.dst_store_id
    ,pi.state

from ph_staging.parcel_info pi
where
    pi.dst_store_id in ('PH14010F01', 'PH17080300')
    and pi.interrupt_category = 3
    and pi.returned_pno is null;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
    ,ss.name 网点
    ,pr.staff_info_id 操作待退件员工
    ,pr.store_name 操作部门
    ,convert_tz(pr.routed_at, '+00:00', '+08:00') 操作时间
    ,'待退件标记未退件' 类型
from ph_staging.parcel_info pi
left join ph_staging.parcel_route pr on pr.pno = pi.pno and pr.route_action = 'PENDING_RETURN'
left join ph_staging.sys_store ss on ss.id = pi.dst_store_id
where
    pi.dst_store_id in ('PH14010F01', 'PH17080300')
    and pi.interrupt_category = 3
    and pi.returned_pno is null

union all

select
    pr2.pno
    ,ss2.name  网点
    ,pr2.staff_info_id 操作待退件员工
    ,pr2.store_name 操作部门
    ,convert_tz(pr2.routed_at, '+00:00', '+08:00') 操作时间
    ,'今日退件打印' 类型
from ph_staging.parcel_route pr2
left join ph_staging.sys_store ss2 on ss2.id = pr2.store_id
where
    pr2.store_id in ('PH14010F01', 'PH17080300')
    and pr2.route_action = 'SYSTEM_AUTO_RETURN';
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
    ,ss.name 网点
    ,pr.staff_info_id 操作待退件员工
    ,pr.store_name 操作部门
    ,convert_tz(pr.routed_at, '+00:00', '+08:00') 操作时间
    ,'待退件标记未退件' 类型
from ph_staging.parcel_info pi
left join ph_staging.parcel_route pr on pr.pno = pi.pno and pr.route_action = 'PENDING_RETURN'
left join ph_staging.sys_store ss on ss.id = pi.dst_store_id
where
    pi.dst_store_id in ('PH14010F01', 'PH17080300')
    and pi.interrupt_category = 3
    and pi.returned_pno is null

union all

select
    pr2.pno
    ,ss2.name  网点
    ,pr2.staff_info_id 操作待退件员工
    ,pr2.store_name 操作部门
    ,convert_tz(pr2.routed_at, '+00:00', '+08:00') 操作时间
    ,'今日退件打印' 类型
from ph_staging.parcel_route pr2
left join ph_staging.sys_store ss2 on ss2.id = pr2.store_id
where
    pr2.store_id in ('PH14010F01', 'PH17080300')
    and pr2.route_action = 'SYSTEM_AUTO_RETURN'
    and pr2.routed_at > '2023-08-08 16:00:00';
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.CT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-08-09'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.CT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-08-09'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-08-09', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with d as
(
    select
         ds.dst_store_id store_id
        ,ds.pno
        ,ds.p_date stat_date
    from dwm.dwd_ph_dc_should_be_delivery ds
    where
        ds.should_delevry_type = '1派应派包裹'
        and ds.p_date = '2023-08-09'
)
, t as
(
    select
         ds.store_id
        ,ds.pno
        ,ds.stat_date
    from d ds
    left join
        (
            select
                pr.pno
                ,ds.stat_date
                ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
            from ph_staging.parcel_route pr
            join d ds on pr.pno = ds.pno
            where 1=1
                and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                and pr.route_action = 'DETAIN_WAREHOUSE'
                and pr.marker_category in (42,43) ##岛屿,偏远地区
            group by 1,2
        ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
    left join
        (
            select
               pr.pno
                ,ds.stat_date
               ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
               ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
            from ph_staging.parcel_route pr
            join d ds on ds.pno = pr.pno
            where 1=1
                and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                and pr.route_action = 'DETAIN_WAREHOUSE'
                and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                and pr.marker_category in (9,14,70) ##客户改约时间
        ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
    left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
    where
        case
            when pr1.pno is not null then 'N'
            when pr2.pno is not null then 'N'
            when ds1.pno is not null  then 'N'  else 'Y'
        end = 'Y'
)
select
    a.stat_date 日期
    ,a.store_id 网点ID
    ,dp.store_name 网点名称
    ,dp.opening_at 开业时间
    ,case
        when dp.region_name in ('Area3', 'Area6') then '彭万松'
        when dp.region_name in ('Area4', 'Area9') then '韩钥'
        when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
        when dp.region_name in ( 'Area8') then '黄勇'
        when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
    end 区域
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,a.应交接
    ,a.已交接
    ,concat(round(a.交接率*100,2),'%') as 交接率
    ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
    ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
    ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
    ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
    ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
from
    (
        select
            t1.store_id
            ,t1.stat_date
            ,count(t1.pno) 应交接
            ,count(if(sc.pno is not null , t1.pno, null)) 已交接
            ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
            ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
            ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
            ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
            ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

            ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
            ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
            ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
            ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
        from t t1
        left join
            (
                select
                    sc.*
                from
                    (
                        select
                            pr.pno
                            ,pr.store_id
                            ,pr.store_name
                            ,t1.stat_date
                            ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                            ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                            ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                        from ph_staging.parcel_route pr
                        join t t1 on t1.pno = pr.pno
                        where
                            pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                           and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                          and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                    ) sc
                where
                    sc.rk = 1
            ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
        group by 1,2
    ) a
join
    (
        select
            sd.store_id
        from ph_staging.sys_district sd
        where
            sd.deleted = 0
            and sd.store_id is not null
        group by 1

        union all

        select
            sd.separation_store_id store_id
        from ph_staging.sys_district sd
        where
            sd.deleted = 0
            and sd.separation_store_id is not null
        group by 1
    ) sd on sd.store_id = a.store_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
where
    dp.store_category in (1,10,13);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-08-09'
        and pr.routed_at >= date_sub('2023-08-09', interval 8 hour )
        and pr.routed_at < date_add('2023-08-09', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id = 'PH61060300'
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end 评级
        ,a2.code_num
        ,a2.staff_code_num
        ,a2.staff_num
        ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-09'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-08-09')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-08-09'
        and pi.finished_at >= date_sub('2023-08-09', interval 8 hour )
        and pi.finished_at < date_add('2023-08-09', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-08-09'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
select
    t.*
 from dwm.dwd_ph_dc_should_be_delivery t
 left join ph_staging.parcel_route pr on pr.pno = t.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
 where
    t.p_date = '2023-08-09'
    and  t.dst_store_id in ('PH35172802','PH35300N03','PH35300M02')
    and pr.routed_at > '2023-08-08 16:00:00';
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-08-09'
        and pr.routed_at >= date_sub('2023-08-09', interval 8 hour )
        and pr.routed_at < date_add('2023-08-09', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
        and ds.dst_store_id = 'PH35172802'
)
#     select
#         dr.store_id 网点ID
#         ,dr.store_name 网点
#         ,coalesce(dr.opening_at, '未记录') 开业时间
#         ,case dr.store_category
#             when 1 then 'SP'
#             when 2 then 'DC'
#             when 4 then 'SHOP'
#             when 5 then 'SHOP'
#             when 6 then 'FH'
#             when 7 then 'SHOP'
#             when 8 then 'Hub'
#             when 9 then 'Onsite'
#             when 10 then 'BDC'
#             when 11 then 'fulfillment'
#             when 12 then 'B-HUB'
#             when 13 then 'CDC'
#             when 14 then 'PDC'
#         end 网点类型
#         ,dr.piece_name 片区
#         ,dr.region_name 大区
#         ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
#         ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
#         ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
#         ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数
#
#         ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
#         ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
#         ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量
#
#         ,coalesce(sdb.code_num, 0) 网点三段码数量
#         ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
#         ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
#         ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
#         ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
#         ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
#         ,case
#             when a2.avg_code_staff < 2 then 'A'
#             when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
#             when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
#             when a2.avg_code_staff >= 4 then 'D'
#         end 评级
#         ,a2.code_num
#         ,a2.staff_code_num
#         ,a2.staff_num
#         ,a2.fin_staff_code_num
#     from
#         (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-08-09'
        and pr.routed_at >= date_sub('2023-08-09', interval 8 hour )
        and pr.routed_at < date_add('2023-08-09', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
        and ds.dst_store_id = 'PH35172802'
)
#     select
#         dr.store_id 网点ID
#         ,dr.store_name 网点
#         ,coalesce(dr.opening_at, '未记录') 开业时间
#         ,case dr.store_category
#             when 1 then 'SP'
#             when 2 then 'DC'
#             when 4 then 'SHOP'
#             when 5 then 'SHOP'
#             when 6 then 'FH'
#             when 7 then 'SHOP'
#             when 8 then 'Hub'
#             when 9 then 'Onsite'
#             when 10 then 'BDC'
#             when 11 then 'fulfillment'
#             when 12 then 'B-HUB'
#             when 13 then 'CDC'
#             when 14 then 'PDC'
#         end 网点类型
#         ,dr.piece_name 片区
#         ,dr.region_name 大区
#         ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
#         ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
#         ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
#         ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数
#
#         ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
#         ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
#         ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量
#
#         ,coalesce(sdb.code_num, 0) 网点三段码数量
#         ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
#         ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
#         ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
#         ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
#         ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
#         ,case
#             when a2.avg_code_staff < 2 then 'A'
#             when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
#             when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
#             when a2.avg_code_staff >= 4 then 'D'
#         end 评级
#         ,a2.code_num
#         ,a2.staff_code_num
#         ,a2.staff_num
#         ,a2.fin_staff_code_num
#     from
#         (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-08-09'
        and pr.routed_at >= date_sub('2023-08-09', interval 8 hour )
        and pr.routed_at < date_add('2023-08-09', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
        and ds.dst_store_id = 'PH35172802';
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-08-09'
        and pr.routed_at >= date_sub('2023-08-09', interval 8 hour )
        and pr.routed_at < date_add('2023-08-09', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
        and ds.dst_store_id = 'PH35172802'
)
#     select
#         dr.store_id 网点ID
#         ,dr.store_name 网点
#         ,coalesce(dr.opening_at, '未记录') 开业时间
#         ,case dr.store_category
#             when 1 then 'SP'
#             when 2 then 'DC'
#             when 4 then 'SHOP'
#             when 5 then 'SHOP'
#             when 6 then 'FH'
#             when 7 then 'SHOP'
#             when 8 then 'Hub'
#             when 9 then 'Onsite'
#             when 10 then 'BDC'
#             when 11 then 'fulfillment'
#             when 12 then 'B-HUB'
#             when 13 then 'CDC'
#             when 14 then 'PDC'
#         end 网点类型
#         ,dr.piece_name 片区
#         ,dr.region_name 大区
#         ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
#         ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
#         ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
#         ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数
#
#         ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
#         ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
#         ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量
#
#         ,coalesce(sdb.code_num, 0) 网点三段码数量
#         ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
#         ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
#         ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
#         ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
#         ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
#         ,case
#             when a2.avg_code_staff < 2 then 'A'
#             when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
#             when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
#             when a2.avg_code_staff >= 4 then 'D'
#         end 评级
#         ,a2.code_num
#         ,a2.staff_code_num
#         ,a2.staff_num
#         ,a2.fin_staff_code_num
#     from
#         (
#             select
#                 a1.store_id
#                 ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
#                 ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
#                 ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
#                 ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
#                 ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
#                 ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
#                 ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
#                 ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
#                 ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
#             from
#                 (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
    ,ddd.CN_element 疑难件原因
    ,convert_tz(di.created_at, '+00:00', '+08:00')  提交问题件时间
    ,case
        when bc.`client_id` is not null then bc.client_name
        when kp.id is not null and bc.client_id is null then '普通ka'
        when kp.`id` is null then '小c'
    end  客户类型
    ,if(vrv.link_id is not null , '是' , '否') 是否进入收件人拒收回访
    ,if(vrv2.link_id is not null , '是' , '否') 是否进入多次尝试派送回访
from ph_staging.parcel_info pi
left join ph_staging.diff_info di on di.pno = pi.pno and di.state = 0
left join dwm.dwd_dim_dict ddd on ddd.element = di.diff_marker_category and ddd.db = 'ph_staging' and ddd.tablename = 'diff_info' and ddd.fieldname = 'diff_marker_category'
left join ph_staging.ka_profile kp on kp.id = pi.client_id
left join dwm.dwd_dim_bigClient  bc on bc.client_id = pi.client_id
left join nl_production.violation_return_visit vrv on vrv.link_id = pi.pno and vrv.type = 3
left join nl_production.violation_return_visit vrv2 on vrv2.link_id = pi.pno and vrv.type = 8
where
    pi.state = 6
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
    ,case di.diff_marker_category # 疑难原因
            when 1 then '客户不在家/电话无人接听'
            when 2 then '收件人拒收'
            when 3 then '快件分错网点'
            when 4 then '外包装破损'
            when 5 then '货物破损'
            when 6 then '货物短少'
            when 7 then '货物丢失'
            when 8 then '电话联系不上'
            when 9 then '客户改约时间'
            when 10 then '客户不在'
            when 11 then '客户取消任务'
            when 12 then '无人签收'
            when 13 then '客户周末或假期不收货'
            when 14 then '客户改约时间'
            when 15 then '当日运力不足，无法派送'
            when 16 then '联系不上收件人'
            when 17 then '收件人拒收'
            when 18 then '快件分错网点'
            when 19 then '外包装破损'
            when 20 then '货物破损'
            when 21 then '货物短少'
            when 22 then '货物丢失'
            when 23 then '详细地址错误'
            when 24 then '收件地址已废弃或不存在'
            when 25 then '收件人电话号码错误'
            when 26 then 'cod金额不正确'
            when 27 then '无实际包裹'
            when 28 then '已妥投未交接'
            when 29 then '收件人电话号码是空号'
            when 30 then '送错网点'
            when 31 then '省市乡邮编错误'
            when 32 then '禁运品'
            when 33 then '严重破损（丢弃）'
            when 34 then '退件两次尝试派送失败'
            when 35 then '不能打开locker'
            when 36 then 'locker不能使用'
            when 37 then '该地址找不到lockerstation'
            when 38 then '一票多件'
            when 39 then '多次尝试派件失败'
            when 40 then '客户不在家/电话无人接听'
            when 41 then '错过班车时间'
            when 42 then '目的地是偏远地区,留仓待次日派送'
            when 43 then '目的地是岛屿,留仓待次日派送'
            when 44 then '企业/机构当天已下班'
            when 45 then '子母件包裹未全部到达网点'
            when 46 then '不可抗力原因留仓(台风)'
            when 47 then '虚假包裹'
            when 50 then '客户取消寄件'
            when 51 then '信息录入错误'
            when 52 then '客户取消寄件'
            when 53 then 'lazada仓库拒收'
            when 69 then '禁运品'
            when 70 then '客户改约时间'
            when 71 then '当日运力不足，无法派送'
            when 72 then '客户周末或假期不收货'
            when 73 then '详细地址错误'
            when 74 then '收件地址已废弃或不存在'
            when 75 then '收件人电话号码错误'
            when 76 then 'cod金额不正确'
            when 77 then '企业/机构当天已下班'
            when 78 then '收件人电话号码是空号'
            when 79 then '快件分错网点-地址错误'
            when 80 then '客户取消任务'
            when 81 then '重复下单'
            when 82 then '已完成揽件'
            when 83 then '联系不上客户'
            when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
            when 85 then '寄件人电话号码是空号'
            when 86 then '包裹不符合揽收条件超大件'
            when 87 then '包裹不符合揽收条件违禁品'
            when 88 then '寄件人地址为岛屿'
            when 89 then '运力短缺，跟客户协商推迟揽收'
            when 90 then '包裹未准备好推迟揽收'
            when 91 then '包裹包装不符合运输标准'
            when 92 then '客户提供的清单里没有此包裹'
            when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
            when 94 then '客户取消寄件/客户实际不想寄此包裹'
            when 95 then '车辆/人力短缺推迟揽收'
            when 96 then '遗漏揽收(已停用)'
            when 97 then '子母件(一个单号多个包裹)'
            when 98 then '地址错误addresserror'
            when 99 then '包裹不符合揽收条件：超大件'
            when 100 then '包裹不符合揽收条件：违禁品'
            when 101 then '包裹包装不符合运输标准'
            when 102 then '包裹未准备好'
            when 103 then '运力短缺，跟客户协商推迟揽收'
            when 104 then '子母件(一个单号多个包裹)'
            when 105 then '破损包裹'
            when 106 then '空包裹'
            when 107 then '不能打开locker(密码错误)'
            when 108 then 'locker不能使用'
            when 109 then 'locker找不到'
            when 110 then '运单号与实际包裹的单号不一致'
            when 111 then 'box客户取消任务'
            when 112 then '不能打开locker(密码错误)'
            when 113 then 'locker不能使用'
            when 114 then 'locker找不到'
            when 115 then '实际重量尺寸大于客户下单的重量尺寸'
            when 116 then '客户仓库关闭'
            when 117 then '客户仓库关闭'
            when 118 then 'SHOPEE订单系统自动关闭'
            when 119 then '客户取消包裹'
            when 121 then '地址错误'
            when 122 then '当日运力不足，无法揽收'
        end  as 疑难件原因
    ,convert_tz(di.created_at, '+00:00', '+08:00')  提交问题件时间
    ,case
        when bc.`client_id` is not null then bc.client_name
        when kp.id is not null and bc.client_id is null then '普通ka'
        when kp.`id` is null then '小c'
    end  客户类型
    ,if(vrv.link_id is not null , '是' , '否') 是否进入收件人拒收回访
    ,if(vrv2.link_id is not null , '是' , '否') 是否进入多次尝试派送回访
from ph_staging.parcel_info pi
left join ph_staging.diff_info di on di.pno = pi.pno and di.state = 0
left join ph_staging.ka_profile kp on kp.id = pi.client_id
left join dwm.dwd_dim_bigClient  bc on bc.client_id = pi.client_id
left join nl_production.violation_return_visit vrv on vrv.link_id = pi.pno and vrv.type = 3
left join nl_production.violation_return_visit vrv2 on vrv2.link_id = pi.pno and vrv.type = 8
where
    pi.state = 6
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
    ,ss.name 网点
    ,pr.staff_info_id 操作待退件员工
    ,pr.store_name 操作部门
    ,convert_tz(pr.routed_at, '+00:00', '+08:00') 操作时间
    ,'待退件标记未退件' 类型
from ph_staging.parcel_info pi
left join ph_staging.parcel_route pr on pr.pno = pi.pno and pr.route_action = 'PENDING_RETURN'
left join ph_staging.sys_store ss on ss.id = pi.dst_store_id
where
    pi.dst_store_id in ('PH14010F01', 'PH14010F00')
    and pi.interrupt_category = 3
    and pi.returned_pno is null

union all

select
    pr2.pno
    ,ss2.name  网点
    ,pr2.staff_info_id 操作待退件员工
    ,pr2.store_name 操作部门
    ,convert_tz(pr2.routed_at, '+00:00', '+08:00') 操作时间
    ,'今日退件打印' 类型
from ph_staging.parcel_route pr2
left join ph_staging.sys_store ss2 on ss2.id = pr2.store_id
where
    pr2.store_id in ('PH14010F01', 'PH14010F00')
    and pr2.route_action = 'SYSTEM_AUTO_RETURN'
    and pr2.routed_at > '2023-08-08 16:00:00'
    and pr2.routed_at < '2023-08-09 16:00:00';
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
    ,case di.diff_marker_category # 疑难原因
            when 1 then '客户不在家/电话无人接听'
            when 2 then '收件人拒收'
            when 3 then '快件分错网点'
            when 4 then '外包装破损'
            when 5 then '货物破损'
            when 6 then '货物短少'
            when 7 then '货物丢失'
            when 8 then '电话联系不上'
            when 9 then '客户改约时间'
            when 10 then '客户不在'
            when 11 then '客户取消任务'
            when 12 then '无人签收'
            when 13 then '客户周末或假期不收货'
            when 14 then '客户改约时间'
            when 15 then '当日运力不足，无法派送'
            when 16 then '联系不上收件人'
            when 17 then '收件人拒收'
            when 18 then '快件分错网点'
            when 19 then '外包装破损'
            when 20 then '货物破损'
            when 21 then '货物短少'
            when 22 then '货物丢失'
            when 23 then '详细地址错误'
            when 24 then '收件地址已废弃或不存在'
            when 25 then '收件人电话号码错误'
            when 26 then 'cod金额不正确'
            when 27 then '无实际包裹'
            when 28 then '已妥投未回COD'
            when 29 then '收件人电话号码是空号'
            when 30 then '送错网点'
            when 31 then '省市乡邮编错误'
            when 32 then '禁运品'
            when 33 then '严重破损（丢弃）'
            when 34 then '退件两次尝试派送失败'
            when 35 then '不能打开locker'
            when 36 then 'locker不能使用'
            when 37 then '该地址找不到lockerstation'
            when 38 then '一票多件'
            when 39 then '多次尝试派件失败'
            when 40 then '客户不在家/电话无人接听'
            when 41 then '错过班车时间'
            when 42 then '目的地是偏远地区,留仓待次日派送'
            when 43 then '目的地是岛屿,留仓待次日派送'
            when 44 then '企业/机构当天已下班'
            when 45 then '子母件包裹未全部到达网点'
            when 46 then '不可抗力原因留仓(台风)'
            when 47 then '虚假包裹'
            when 50 then '客户取消寄件'
            when 51 then '信息录入错误'
            when 52 then '客户取消寄件'
            when 53 then 'lazada仓库拒收'
            when 69 then '禁运品'
            when 70 then '客户改约时间'
            when 71 then '当日运力不足，无法派送'
            when 72 then '客户周末或假期不收货'
            when 73 then '详细地址错误'
            when 74 then '收件地址已废弃或不存在'
            when 75 then '收件人电话号码错误'
            when 76 then 'cod金额不正确'
            when 77 then '企业/机构当天已下班'
            when 78 then '收件人电话号码是空号'
            when 79 then '快件分错网点-地址错误'
            when 80 then '客户取消任务'
            when 81 then '重复下单'
            when 82 then '已完成揽件'
            when 83 then '联系不上客户'
            when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
            when 85 then '寄件人电话号码是空号'
            when 86 then '包裹不符合揽收条件超大件'
            when 87 then '包裹不符合揽收条件违禁品'
            when 88 then '寄件人地址为岛屿'
            when 89 then '运力短缺，跟客户协商推迟揽收'
            when 90 then '包裹未准备好推迟揽收'
            when 91 then '包裹包装不符合运输标准'
            when 92 then '客户提供的清单里没有此包裹'
            when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
            when 94 then '客户取消寄件/客户实际不想寄此包裹'
            when 95 then '车辆/人力短缺推迟揽收'
            when 96 then '遗漏揽收(已停用)'
            when 97 then '子母件(一个单号多个包裹)'
            when 98 then '地址错误addresserror'
            when 99 then '包裹不符合揽收条件：超大件'
            when 100 then '包裹不符合揽收条件：违禁品'
            when 101 then '包裹包装不符合运输标准'
            when 102 then '包裹未准备好'
            when 103 then '运力短缺，跟客户协商推迟揽收'
            when 104 then '子母件(一个单号多个包裹)'
            when 105 then '破损包裹'
            when 106 then '空包裹'
            when 107 then '不能打开locker(密码错误)'
            when 108 then 'locker不能使用'
            when 109 then 'locker找不到'
            when 110 then '运单号与实际包裹的单号不一致'
            when 111 then 'box客户取消任务'
            when 112 then '不能打开locker(密码错误)'
            when 113 then 'locker不能使用'
            when 114 then 'locker找不到'
            when 115 then '实际重量尺寸大于客户下单的重量尺寸'
            when 116 then '客户仓库关闭'
            when 117 then '客户仓库关闭'
            when 118 then 'SHOPEE订单系统自动关闭'
            when 119 then '客户取消包裹'
            when 121 then '地址错误'
            when 122 then '当日运力不足，无法揽收'
        end  as 疑难件原因
    ,convert_tz(di.created_at, '+00:00', '+08:00')  提交问题件时间
    ,case
        when bc.`client_id` is not null then bc.client_name
        when kp.id is not null and bc.client_id is null then '普通ka'
        when kp.`id` is null then '小c'
    end  客户类型
    ,if(vrv.link_id is not null , '是' , '否') 是否进入收件人拒收回访
    ,if(vrv2.link_id is not null , '是' , '否') 是否进入多次尝试派送回访
from ph_staging.parcel_info pi
left join ph_staging.diff_info di on di.pno = pi.pno and di.state = 0
left join ph_staging.ka_profile kp on kp.id = pi.client_id
left join dwm.dwd_dim_bigClient  bc on bc.client_id = pi.client_id
left join nl_production.violation_return_visit vrv on vrv.link_id = pi.pno and vrv.type = 3
left join nl_production.violation_return_visit vrv2 on vrv2.link_id = pi.pno and vrv.type = 8
where
    pi.state = 6
    and pi.returned = 0
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    vrv.link_id
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
left join ph_staging.diff_info di on di.id = json_extract(vrv.extra_value, '$.diff_id')
where
    vrv.type = 8
    and vrv.visit_state in (3,4,5,6,7)
    and di.state = 0;
;-- -. . -..- - / . -. - .-. -.--
select
    vrv.link_id

from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
left join ph_staging.diff_info di on di.id = json_extract(vrv.extra_value, '$.diff_id')
where
    vrv.type = 8
    and vrv.visit_state in (3,4,5,6,7)
    and di.state = 0;
;-- -. . -..- - / . -. - .-. -.--
select
    vrv.link_id

from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
left join ph_staging.parcel_info pi on pi.pno = vrv.link_id
left join ph_staging.diff_info di on di.id = json_extract(vrv.extra_value, '$.diff_id')
where
    vrv.type = 8
    and vrv.visit_state in (3,4,5,6,7)
    and pi.state = 6;
;-- -. . -..- - / . -. - .-. -.--
select
    vrv.link_id
    ,if(di2.id = di.id , 'y', 'n') 是否相同

from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
left join ph_staging.parcel_info pi on pi.pno = vrv.link_id
left join ph_staging.diff_info di on di.id = json_extract(vrv.extra_value, '$.diff_id')
left join ph_staging.diff_info di2 on di2.pno = pi.pno and di2.state = 0
where
    vrv.type = 8
    and vrv.visit_state in (3,4,5,6,7)
    and pi.state = 6;
;-- -. . -..- - / . -. - .-. -.--
select
    bc.client_name
    ,count(if(vrv.visit_state = 1, vrv.id, null)) 待回访
    ,count(if(vrv.visit_state = 2, vrv.id, null)) 沟通中
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
where
    vrv.visit_state in (1,2)
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    bc.client_name
    ,count(if(vrv.visit_state = 1, vrv.id, null)) 待回访
    ,count(if(vrv.visit_state = 2, vrv.id, null)) 沟通中
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
where
    vrv.visit_state in (1,2)
    and vrv.type = 8
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
    ,pi.dst_detail_address 收件人地址
    ,seal.pack_no
    ,case pr.route_action
         when 'ACCEPT_PARCEL' then '接件扫描'
         when 'ARRIVAL_GOODS_VAN_CHECK_SCAN' then '车货关联到港'
         when 'ARRIVAL_WAREHOUSE_SCAN' then '到件入仓扫描'
         when 'CANCEL_ARRIVAL_WAREHOUSE_SCAN' then '取消到件入仓扫描'
         when 'CANCEL_PARCEL' then '撤销包裹'
         when 'CANCEL_SHIPMENT_WAREHOUSE' then '取消发件出仓'
         when 'CHANGE_PARCEL_CANCEL' then '修改包裹为撤销'
         when 'CHANGE_PARCEL_CLOSE' then '修改包裹为异常关闭'
         when 'CHANGE_PARCEL_IN_TRANSIT' then '修改包裹为运输中'
         when 'CHANGE_PARCEL_INFO' then '修改包裹信息'
         when 'CHANGE_PARCEL_SIGNED' then '修改包裹为签收'
         when 'CLAIMS_CLOSE' then '理赔关闭'
         when 'CLAIMS_COMPLETE' then '理赔完成'
         when 'CLAIMS_CONTACT' then '已联系客户'
         when 'CLAIMS_TRANSFER_CS' then '转交总部cs处理'
         when 'CLOSE_ORDER' then '关闭订单'
         when 'CONTINUE_TRANSPORT' then '疑难件继续配送'
         when 'CREATE_WORK_ORDER' then '创建工单'
         when 'CUSTOMER_CHANGE_PARCEL_INFO' then '客户修改包裹信息'
         when 'CUSTOMER_OPERATING_RETURN' then '客户操作退回寄件人'
         when 'DELIVERY_CONFIRM' then '确认妥投'
         when 'DELIVERY_MARKER' then '派件标记'
         when 'DELIVERY_PICKUP_STORE_SCAN' then '自提取件扫描'
         when 'DELIVERY_TICKET_CREATION_SCAN' then '交接扫描'
         when 'DELIVERY_TRANSFER' then '派件转单'
         when 'DEPARTURE_GOODS_VAN_CK_SCAN' then '车货关联出港'
         when 'DETAIN_WAREHOUSE' then '货件留仓'
         when 'DIFFICULTY_FINISH_INDEMNITY' then '疑难件支付赔偿'
         when 'DIFFICULTY_HANDOVER' then '疑难件交接'
         when 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE' then '疑难件交接货件留仓'
         when 'DIFFICULTY_RE_TRANSIT' then '疑难件退回区域总部/重启运送'
         when 'DIFFICULTY_RETURN' then '疑难件退回寄件人'
         when 'DIFFICULTY_SEAL' then '集包异常'
         when 'DISCARD_RETURN_BKK' then '丢弃包裹的，换单后寄回BKK'
         when 'DISTRIBUTION_INVENTORY' then '分拨盘库'
         when 'DWS_WEIGHT_IMAGE' then 'DWS复秤照片'
         when 'EXCHANGE_PARCEL' then '换货'
         when 'FAKE_CANCEL_HANDLE' then '虚假撤销判责'
         when 'FLASH_HOME_SCAN' then 'FH交接扫描'
         when 'FORCE_TAKE_PHOTO' then '强制拍照路由'
         when 'HAVE_HAIR_SCAN_NO_TO' then '有发无到'
         when 'HURRY_PARCEL' then '催单'
         when 'INCOMING_CALL' then '来电接听'
         when 'INTERRUPT_PARCEL_AND_RETURN' then '中断运输并退回'
         when 'INVENTORY' then '盘库'
         when 'LOSE_PARCEL_TEAM_OPERATION' then '丢失件团队处理'
         when 'MANUAL_REMARK' then '添加备注'
         when 'MISS_PICKUP_HANDLE' then '漏包裹揽收判责'
         when 'MISSING_PARCEL_SCAN' then '丢失件包裹操作'
         when 'NOTICE_LOST_PARTS_TEAM' then '已通知丢失件团队'
         when 'PARCEL_HEADLESS_CLAIMED' then '无头件包裹已认领'
         when 'PARCEL_HEADLESS_PRINTED' then '无头件包裹已打单'
         when 'PENDING_RETURN' then '待退件'
         when 'PHONE' then '电话联系'
         when 'PICK_UP_STORE' then '待自提取件'
         when 'PICKUP_RETURN_RECEIPT' then '签回单揽收'
         when 'PRINTING' then '打印面单'
         when 'QAQC_OPERATION' then 'QAQC判责'
         when 'RECEIVE_WAREHOUSE_SCAN' then '收件入仓'
         when 'RECEIVED' then '已揽收,初始化动作，实际情况并没有作用'
         when 'REFUND_CONFIRM' then '退件妥投'
         when 'REPAIRED' then '上报问题修复路由'
         when 'REPLACE_PNO' then '换单'
         when 'REPLY_WORK_ORDER' then '回复工单'
         when 'REVISION_TIME' then '改约时间'
         when 'SEAL' then '集包'
         when 'SEAL_NUMBER_CHANGE' then '集包件数变化'
         when 'SHIPMENT_WAREHOUSE_SCAN' then '发件出仓扫描'
         when 'SORTER_WEIGHT_IMAGE' then '分拣机复秤照片'
         when 'SORTING_SCAN' then '分拣扫描'
         when 'STAFF_INFO_UPDATE_WEIGHT' then '快递员修改重量'
         when 'STORE_KEEPER_UPDATE_WEIGHT' then '仓管员复秤'
         when 'STORE_SORTER_UPDATE_WEIGHT' then '分拣机复秤'
         when 'SYSTEM_AUTO_RETURN' then '系统自动退件'
         when 'TAKE_PHOTO' then '异常打单拍照'
         when 'THIRD_EXPRESS_ROUTE' then '第三方公司路由'
         when 'THIRD_PARTY_REASON_DETAIN' then '第三方原因滞留'
         when 'TICKET_WEIGHT_IMAGE' then '揽收称重照片'
         when 'TRANSFER_LOST_PARTS_TEAM' then '已转交丢失件团队'
         when 'TRANSFER_QAQC' then '转交QAQC处理'
         when 'UNSEAL' then '拆包'
         when 'UNSEAL_NO_PARCEL' then '上报包裹不在集包里'
         when 'UNSEAL_NOT_SCANNED' then '集包已拆包，本包裹未被扫描'
         when 'VEHICLE_ACCIDENT_REG' then '车辆车祸登记'
         when 'VEHICLE_ACCIDENT_REGISTRATION' then '车辆车祸登记'
         when 'VEHICLE_WET_DAMAGE_REG' then '车辆湿损登记'
         when 'VEHICLE_WET_DAMAGE_REGISTRATION' then '车辆湿损登记'
    end as 最后一条有效路由
    ,ss.name 最后有效路由操作网点
from ph_staging.parcel_info pi
join tmpale.tmp_ph_pno_lj_0810 t on t.pno = pi.pno
left join
    (
        select
            pr.pno
            ,pr.route_action
            ,pr.store_id
            ,row_number() over (partition by pr.pno order by pr.routed_at desc) rk
        from ph_staging.parcel_route pr
        join tmpale.tmp_ph_pno_lj_0810 t on t.pno = pr.pno
        where
            pr.route_action in ('RECEIVED','RECEIVE_WAREHOUSE_SCAN','SORTING_SCAN','DELIVERY_TICKET_CREATION_SCAN','ARRIVAL_WAREHOUSE_SCAN','SHIPMENT_WAREHOUSE_SCAN','DETAIN_WAREHOUSE','DELIVERY_CONFIRM','DELIVERY_MARKER','REPLACE_PNO','SEAL','UNSEAL','PARCEL_HEADLESS_PRINTED','STAFF_INFO_UPDATE_WEIGHT','STORE_KEEPER_UPDATE_WEIGHT','STORE_SORTER_UPDATE_WEIGHT','DISCARD_RETURN_BKK','DELIVERY_TRANSFER','PICKUP_RETURN_RECEIPT','FLASH_HOME_SCAN','seal.ARRIVAL_WAREHOUSE_SCAN','INVENTORY','SORTING_SCAN','DELIVERY_PICKUP_STORE_SCAN','DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE','REFUND_CONFIRM','ACCEPT_PARCEL')
    ) pr on pr.pno = pi.pno and pr.rk = 1
left join ph_staging.sys_store ss on ss.id = pr.store_id
left join
    (
        select
            psd.pno
            ,psd.pack_no
            ,row_number() over (partition by psd.pno order by psd.created_at desc ) rk
        from ph_staging.pack_seal_detail psd
        join tmpale.tmp_ph_pno_lj_0810 t on t.pno = psd.pno
    ) seal on seal.pno = pi.pno and seal.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
select
    vrv.link_id 运单号
    ,case vrv.type
        when 1 then '揽件任务异常取消'
        when 2 then '虚假妥投'
        when 3 then '收件人拒收'
        when 4 then '标记客户改约时间'
        when 5 then 'KA现场不揽收'
        when 6 then '包裹未准备好'
        when 7 then '上报错分未妥投'
        when 8 then '多次尝试派送失败'
    end 违规类型
    ,bc.client_name 客户明细
    ,case vrv.visit_state
        when 1 then '待回访'
        when 2 then '沟通中'
        when 3 then '多次未联系上客户'
        when 4 then '已回访'
        when 5 then '因同包裹生成其他回访任务关闭'
        when 6 then 'VR回访结果=99关闭'
        when 7 then '超回访时效关闭'
    end  回访状态
    ,vrv.created_at 回访任务创建时间
    ,if(vrv.visit_state in (3,4,5,6,7), vrv.updated_at, null) 结束时间
    ,if(vrv.visit_state in (3,4,5,6,7), timestampdiff(second , vrv.created_at, vrv.updated_at)/3600, null ) '处理时长/小时'
    ,vrv.visit_num 回访次数
    ,case
        when vrv.visit_state in (4,6) and vrv.visit_num = 1  and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 120 then '否'
        when vrv.visit_state in (4,6) and vrv.visit_num = 1  and timestampdiff(minute , vrv.created_at, vrv.updated_at) >= 120 then '是'
        when vrv.visit_state in (4,6) and vrv.visit_num > 1 and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 240 then '否'
        when vrv.visit_state in (4,6) and vrv.visit_num > 1 and timestampdiff(minute , vrv.created_at, vrv.updated_at) >= 240 then '是'

        when vrv.visit_state in (3,5) and timestampdiff(minute , vrv.created_at, vrv.updated_at) < 240 then '否'
        when vrv.visit_state in (3,5) and timestampdiff(minute , vrv.created_at, vrv.updated_at) >= 240 then '是'
        when vrv.visit_state in (7) then '是'

    end 是否超时

from nl_production.violation_return_visit vrv
join dwm.dwd_dim_bigClient bc on vrv.client_id = bc.client_id
where
    vrv.created_at >= date_sub('2023-08-10', interval 4 hour)
    and vrv.created_at < date_add('2023-08-10', interval 20 hour)
    and vrv.type in (3,8);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.CT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-08-10'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.CT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-08-10'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-08-10', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with d as
(
    select
         ds.dst_store_id store_id
        ,ds.pno
        ,ds.p_date stat_date
    from dwm.dwd_ph_dc_should_be_delivery ds
    where
        ds.should_delevry_type = '1派应派包裹'
        and ds.p_date = '2023-08-10'
)
, t as
(
    select
         ds.store_id
        ,ds.pno
        ,ds.stat_date
    from d ds
    left join
        (
            select
                pr.pno
                ,ds.stat_date
                ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
            from ph_staging.parcel_route pr
            join d ds on pr.pno = ds.pno
            where 1=1
                and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                and pr.route_action = 'DETAIN_WAREHOUSE'
                and pr.marker_category in (42,43) ##岛屿,偏远地区
            group by 1,2
        ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
    left join
        (
            select
               pr.pno
                ,ds.stat_date
               ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
               ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
            from ph_staging.parcel_route pr
            join d ds on ds.pno = pr.pno
            where 1=1
                and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                and pr.route_action = 'DETAIN_WAREHOUSE'
                and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                and pr.marker_category in (9,14,70) ##客户改约时间
        ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
    left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
    where
        case
            when pr1.pno is not null then 'N'
            when pr2.pno is not null then 'N'
            when ds1.pno is not null  then 'N'  else 'Y'
        end = 'Y'
)
select
    a.stat_date 日期
    ,a.store_id 网点ID
    ,dp.store_name 网点名称
    ,dp.opening_at 开业时间
    ,case
        when dp.region_name in ('Area3', 'Area6') then '彭万松'
        when dp.region_name in ('Area4', 'Area9') then '韩钥'
        when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
        when dp.region_name in ( 'Area8') then '黄勇'
        when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
    end 区域
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,a.应交接
    ,a.已交接
    ,concat(round(a.交接率*100,2),'%') as 交接率
    ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
    ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
    ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
    ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
    ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
from
    (
        select
            t1.store_id
            ,t1.stat_date
            ,count(t1.pno) 应交接
            ,count(if(sc.pno is not null , t1.pno, null)) 已交接
            ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
            ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
            ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
            ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
            ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

            ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
            ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
            ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
            ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
        from t t1
        left join
            (
                select
                    sc.*
                from
                    (
                        select
                            pr.pno
                            ,pr.store_id
                            ,pr.store_name
                            ,t1.stat_date
                            ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                            ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                            ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                        from ph_staging.parcel_route pr
                        join t t1 on t1.pno = pr.pno
                        where
                            pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                           and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                          and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                    ) sc
                where
                    sc.rk = 1
            ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
        group by 1,2
    ) a
join
    (
        select
            sd.store_id
        from ph_staging.sys_district sd
        where
            sd.deleted = 0
            and sd.store_id is not null
        group by 1

        union all

        select
            sd.separation_store_id store_id
        from ph_staging.sys_district sd
        where
            sd.deleted = 0
            and sd.separation_store_id is not null
        group by 1
    ) sd on sd.store_id = a.store_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
where
    dp.store_category in (1,10,13);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-08-10'
        and pr.routed_at >= date_sub('2023-08-10', interval 8 hour )
        and pr.routed_at < date_add('2023-08-10', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
        and ds.dst_store_id = 'PH35172802'
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end 评级
        ,a2.code_num
        ,a2.staff_code_num
        ,a2.staff_num
        ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-08-10'
        and pr.routed_at >= date_sub('2023-08-10', interval 8 hour )
        and pr.routed_at < date_add('2023-08-10', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id = 'PH35172802'
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end 评级
        ,a2.code_num
        ,a2.staff_code_num
        ,a2.staff_num
        ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
select -- 基于当日应派取扫描率
    tt.store_id 网点ID
    ,tt.store_name 网点名称
    ,tt.store_type 网点分类
    ,tt.piece_name 片区
    ,tt.region_name 大区
    ,tt.shoud_counts 应派总数
    ,tt.scan_fished_counts 分拣扫描数
    ,ifnull(tt.scan_fished_counts/shoud_counts,0) 分拣扫描率

    ,tt.youxiao_counts 有效分拣扫描数
    ,ifnull(tt.youxiao_counts/tt.scan_fished_counts,0) 有效分拣扫描率

    ,tt.1pai_counts 一派应派数
    ,tt.1pai_scan_fished_counts 一派分拣扫描数
    ,ifnull(tt.1pai_scan_fished_counts/tt.1pai_counts,0) 一派分拣扫描率

    ,tt.1pai_youxiao_counts 一派有效分拣扫描数
    ,ifnull(tt.1pai_youxiao_counts/tt.1pai_scan_fished_counts,0) 一派有效分拣扫描率
    ,
    case
	    when tt.1pai_youxiao_counts/tt.1pai_scan_fished_counts>=0.95 then 'A'
	    when tt.1pai_youxiao_counts/tt.1pai_scan_fished_counts>=0.90 then 'B'
	    when tt.1pai_youxiao_counts/tt.1pai_scan_fished_counts>=0.85 then 'C'
	    when tt.1pai_youxiao_counts/tt.1pai_scan_fished_counts>=0.80 then 'D'
	    else 'E'
	 end 一派有效分拣评级 -- 一派有效分拣

	 ,case
        when tt.1pai_hour_8_fished_counts/tt.1pai_counts>=0.95  then 'A'
        when tt.1pai_hour_8ban_fished_counts/tt.1pai_counts>=0.95  then 'B'
        when tt.1pai_hour_9_fished_counts/tt.1pai_counts>=0.95  then 'C'
        when tt.1pai_hour_9ban_fished_counts/tt.1pai_counts>=0.95  then 'D'
        else 'E'
       end 一派分拣评级

    ,ifnull(tt.1pai_hour_8_fished_counts/tt.1pai_counts,0) 一派8点前扫描占比
    ,ifnull(tt.1pai_hour_8ban_fished_counts/tt.1pai_counts,0) 一派8点半前扫描占比
    ,ifnull(tt.1pai_hour_9_fished_counts/tt.1pai_counts,0) 一派9点前扫描占比
    ,ifnull(tt.1pai_hour_9ban_fished_counts/tt.1pai_counts,0) 一派9点半前扫描占比
	,tt2.late_proof_counts 是否有迟到超过规划时间20分钟的常规车
    ,tt2.max_real_arrive_time_normal 一派常规车最晚实际到达时间
    ,tt2.max_real_arrive_proof_id 一派常规车最晚实际到达车线
    ,tt2.max_real_arrive_vol 一派常规车最晚实际到达车线包裹量
    ,tt2.line_1_latest_plan_arrive_time 一派常规车最晚规划到达时间
    ,tt2.max_real_arrive_time_innormal 一派加班车最晚实际到达时间
    ,tt2.max_real_arrive_innormal_proof_id  一派加班车最晚实际到达车线
    ,tt2.max_real_arrive_innormal_vol  一派加班车最晚实际到达包裹量
    ,tt2.max_actual_plan_arrive_time_innormal 一派加班车最晚规划到达时间


from
(
    select
       base.store_id
       ,base.store_name
       ,base.store_type
       ,base.piece_name
       ,base.region_name
       ,count(distinct base.pno) shoud_counts
       ,count(distinct case when base.min_fenjian_scan_time is not null then base.pno else null end ) scan_fished_counts
       ,count(distinct case when base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then base.pno else null end ) youxiao_counts

       ,count(distinct case when base.type='一派' then  base.pno else null end ) 1pai_counts
       ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null then  base.pno else null end ) 1pai_scan_fished_counts
       ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then  base.pno else null end ) 1pai_youxiao_counts

       ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:00:00' then base.pno else null end) 1pai_hour_8_fished_counts
       ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:30:00' then base.pno else null end) 1pai_hour_8ban_fished_counts
       ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:00:00' then base.pno else null end) 1pai_hour_9_fished_counts
       ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:30:00' then base.pno else null end) 1pai_hour_9ban_fished_counts

    from
    (
       select
       t.*,
       case when t.should_delevry_type='1派应派包裹' then '一派' else null end 'type'
       from dwm.dwd_ph_dc_should_be_delivery_sort_scan t
       join ph_staging.sys_store ss
       on t.store_id =ss.id
    ) base
    group by base.store_id,base.store_name,base.store_type,base.piece_name,base.region_name
) tt

left join
(
    select
       bl.store_id
       ,bl.max_real_arrive_time_normal
       ,bl.max_real_arrive_proof_id
       ,bl.max_real_arrive_vol
       ,bl.line_1_latest_plan_arrive_time
       ,bl.max_actual_plan_arrive_time_innormal
       ,bl.max_actual_plan_arrive_innormal_proof_id
       ,bl.max_actual_plan_arrive_innormal_vol
       ,bl.max_real_arrive_time_innormal
       ,bl.max_real_arrive_innormal_proof_id
       ,bl.max_real_arrive_innormal_vol
	   ,late_proof_counts
    from dwm.fleet_real_detail_today bl
    group by 1,2,3,4,5,6,7,8,9,10,11
) tt2 on tt.store_id=tt2.store_id;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-10'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-08-10')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-08-10'
        and pi.finished_at >= date_sub('2023-08-10', interval 8 hour )
        and pi.finished_at < date_add('2023-08-10', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-08-10'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
select
    vrv.link_id
    ,if(di2.id = di.id , 'y', 'n') 是否相同

from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
left join ph_staging.parcel_info pi on pi.pno = vrv.link_id
left join ph_staging.diff_info di on di.id = json_extract(vrv.extra_value, '$.diff_id')
left join ph_staging.diff_info di2 on di2.pno = pi.pno
join ph_staging.store_diff_ticket sdt on sdt.diff_info_id = di2.id and sdt.state != 2
where
    vrv.type = 8
    and vrv.visit_state in (3,4,5,6,7)
    and pi.state = 6;
;-- -. . -..- - / . -. - .-. -.--
select
    bc.client_name
    ,count(if(vrv.visit_state = 1, vrv.id, null)) 待回访
    ,count(if(vrv.visit_state = 2, vrv.id, null)) 沟通中
    ,count(if(di.created_at < '2023-08-09 16:00:00', vrv.id, null)) 今日之前创建疑难件
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
left join ph_staging.diff_info di on di.id = json_extract(vrv.extra_value, '$.diff_id')
where
    vrv.visit_state in (1,2)
    and vrv.type = 8
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
    ,case di.diff_marker_category # 疑难原因
            when 1 then '客户不在家/电话无人接听'
            when 2 then '收件人拒收'
            when 3 then '快件分错网点'
            when 4 then '外包装破损'
            when 5 then '货物破损'
            when 6 then '货物短少'
            when 7 then '货物丢失'
            when 8 then '电话联系不上'
            when 9 then '客户改约时间'
            when 10 then '客户不在'
            when 11 then '客户取消任务'
            when 12 then '无人签收'
            when 13 then '客户周末或假期不收货'
            when 14 then '客户改约时间'
            when 15 then '当日运力不足，无法派送'
            when 16 then '联系不上收件人'
            when 17 then '收件人拒收'
            when 18 then '快件分错网点'
            when 19 then '外包装破损'
            when 20 then '货物破损'
            when 21 then '货物短少'
            when 22 then '货物丢失'
            when 23 then '详细地址错误'
            when 24 then '收件地址已废弃或不存在'
            when 25 then '收件人电话号码错误'
            when 26 then 'cod金额不正确'
            when 27 then '无实际包裹'
            when 28 then '已妥投未回COD'
            when 29 then '收件人电话号码是空号'
            when 30 then '送错网点'
            when 31 then '省市乡邮编错误'
            when 32 then '禁运品'
            when 33 then '严重破损（丢弃）'
            when 34 then '退件两次尝试派送失败'
            when 35 then '不能打开locker'
            when 36 then 'locker不能使用'
            when 37 then '该地址找不到lockerstation'
            when 38 then '一票多件'
            when 39 then '多次尝试派件失败'
            when 40 then '客户不在家/电话无人接听'
            when 41 then '错过班车时间'
            when 42 then '目的地是偏远地区,留仓待次日派送'
            when 43 then '目的地是岛屿,留仓待次日派送'
            when 44 then '企业/机构当天已下班'
            when 45 then '子母件包裹未全部到达网点'
            when 46 then '不可抗力原因留仓(台风)'
            when 47 then '虚假包裹'
            when 50 then '客户取消寄件'
            when 51 then '信息录入错误'
            when 52 then '客户取消寄件'
            when 53 then 'lazada仓库拒收'
            when 69 then '禁运品'
            when 70 then '客户改约时间'
            when 71 then '当日运力不足，无法派送'
            when 72 then '客户周末或假期不收货'
            when 73 then '详细地址错误'
            when 74 then '收件地址已废弃或不存在'
            when 75 then '收件人电话号码错误'
            when 76 then 'cod金额不正确'
            when 77 then '企业/机构当天已下班'
            when 78 then '收件人电话号码是空号'
            when 79 then '快件分错网点-地址错误'
            when 80 then '客户取消任务'
            when 81 then '重复下单'
            when 82 then '已完成揽件'
            when 83 then '联系不上客户'
            when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
            when 85 then '寄件人电话号码是空号'
            when 86 then '包裹不符合揽收条件超大件'
            when 87 then '包裹不符合揽收条件违禁品'
            when 88 then '寄件人地址为岛屿'
            when 89 then '运力短缺，跟客户协商推迟揽收'
            when 90 then '包裹未准备好推迟揽收'
            when 91 then '包裹包装不符合运输标准'
            when 92 then '客户提供的清单里没有此包裹'
            when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
            when 94 then '客户取消寄件/客户实际不想寄此包裹'
            when 95 then '车辆/人力短缺推迟揽收'
            when 96 then '遗漏揽收(已停用)'
            when 97 then '子母件(一个单号多个包裹)'
            when 98 then '地址错误addresserror'
            when 99 then '包裹不符合揽收条件：超大件'
            when 100 then '包裹不符合揽收条件：违禁品'
            when 101 then '包裹包装不符合运输标准'
            when 102 then '包裹未准备好'
            when 103 then '运力短缺，跟客户协商推迟揽收'
            when 104 then '子母件(一个单号多个包裹)'
            when 105 then '破损包裹'
            when 106 then '空包裹'
            when 107 then '不能打开locker(密码错误)'
            when 108 then 'locker不能使用'
            when 109 then 'locker找不到'
            when 110 then '运单号与实际包裹的单号不一致'
            when 111 then 'box客户取消任务'
            when 112 then '不能打开locker(密码错误)'
            when 113 then 'locker不能使用'
            when 114 then 'locker找不到'
            when 115 then '实际重量尺寸大于客户下单的重量尺寸'
            when 116 then '客户仓库关闭'
            when 117 then '客户仓库关闭'
            when 118 then 'SHOPEE订单系统自动关闭'
            when 119 then '客户取消包裹'
            when 121 then '地址错误'
            when 122 then '当日运力不足，无法揽收'
        end  as 疑难件原因
    ,convert_tz(di.created_at, '+00:00', '+08:00')  提交问题件时间
    ,case
        when bc.`client_id` is not null then bc.client_name
        when kp.id is not null and bc.client_id is null then '普通ka'
        when kp.`id` is null then '小c'
    end  客户类型
    ,if(vrv.link_id is not null , '是' , '否') 是否进入收件人拒收回访
    ,if(vrv2.link_id is not null , '是' , '否') 是否进入多次尝试派送回访
from ph_staging.parcel_info pi
left join ph_staging.diff_info di on di.pno = pi.pno and di.state = 0
left join ph_staging.ka_profile kp on kp.id = pi.client_id
left join dwm.dwd_dim_bigClient  bc on bc.client_id = pi.client_id
left join nl_production.violation_return_visit vrv on vrv.link_id = pi.pno and vrv.type = 3
left join nl_production.violation_return_visit vrv2 on vrv2.link_id = pi.pno and vrv2.type = 8
where
    pi.state = 6
    and pi.returned = 0
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    a.*
from
    (
        select
            pi.client_id
            ,count(distinct pi.pno)/count(distinct date(convert_tz(pi.created_at, '+00:00', '+08:00'))) pi_num
        from ph_staging.parcel_info pi
        left join ph_staging.sys_store ss on ss.id = pi.ticket_pickup_store_id
        join ph_staging.ka_profile kp on kp.id = pi.client_id
        where
            pi.created_at >= '2023-07-31 16:00:00'
            and pi.created_at < '2023-08-10 16:00:00'
            and ss.name in ('AGL_SP', 'AGS_SP', 'CUT_SP', 'SSN_SP', 'CLK_SP')
        group by 1
    ) a
where
    a.pi_num > 10;
;-- -. . -..- - / . -. - .-. -.--
select
            pi.client_id
            ,count(distinct date(convert_tz(pi.created_at, '+00:00', '+08:00'))) dat
            ,count(distinct pi.pno)/count(distinct date(convert_tz(pi.created_at, '+00:00', '+08:00'))) pi_num
        from ph_staging.parcel_info pi
        left join ph_staging.sys_store ss on ss.id = pi.ticket_pickup_store_id
        join ph_staging.ka_profile kp on kp.id = pi.client_id
        where
            pi.created_at >= '2023-07-31 16:00:00'
            and pi.created_at < '2023-08-10 16:00:00'
            and ss.name in ('AGL_SP', 'AGS_SP', 'CUT_SP', 'SSN_SP', 'CLK_SP')
        group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    a.*
from
    (
        select
            pi.client_id
            ,ss.name
            ,count(distinct date(convert_tz(pi.created_at, '+00:00', '+08:00'))) dat
            ,count(distinct pi.pno)/count(distinct date(convert_tz(pi.created_at, '+00:00', '+08:00'))) pi_num
        from ph_staging.parcel_info pi
        left join ph_staging.sys_store ss on ss.id = pi.ticket_pickup_store_id
        join ph_staging.ka_profile kp on kp.id = pi.client_id
        where
            pi.created_at >= '2023-07-31 16:00:00'
            and pi.created_at < '2023-08-10 16:00:00'
            and ss.name in ('AGL_SP', 'AGS_SP', 'CUT_SP', 'SSN_SP', 'CLK_SP')
        group by 1,2
    ) a
where
    a.pi_num > 10;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
    ,ss.name 网点
    ,pr.staff_info_id 操作待退件员工
    ,pr.store_name 操作部门
    ,convert_tz(pr.routed_at, '+00:00', '+08:00') 操作时间
    ,'待退件标记未退件' 类型
from ph_staging.parcel_info pi
left join ph_staging.parcel_route pr on pr.pno = pi.pno and pr.route_action = 'PENDING_RETURN'
left join ph_staging.sys_store ss on ss.id = pi.dst_store_id
where
    pi.dst_store_id in ('PH14010F01', 'PH14010F00')
    and pi.interrupt_category = 3
    and pi.returned_pno is null

union all

select
    pr2.pno
    ,ss2.name  网点
    ,pr2.staff_info_id 操作待退件员工
    ,pr2.store_name 操作部门
    ,convert_tz(pr2.routed_at, '+00:00', '+08:00') 操作时间
    ,'今日退件打印' 类型
from ph_staging.parcel_route pr2
left join ph_staging.sys_store ss2 on ss2.id = pr2.store_id
where
    pr2.store_id in ('PH14010F01', 'PH14010F00')
    and pr2.route_action = 'SYSTEM_AUTO_RETURN'
    and pr2.routed_at > '2023-08-09 16:00:00'
    and pr2.routed_at < '2023-08-10 16:00:00';
;-- -. . -..- - / . -. - .-. -.--
select
	 di.pno '运单号'
     ,case
          when dd.`client_id` is not null then dd.client_name
          when kp.id is not null and dd.client_id is null then '普通ka'
          when kp.`id` is null then '小c'
      end 客户名称
	 ,convert_tz(pi.created_at,'+00:00','+08:00') '揽收日期'
	 ,ss.name '揽收网点'
	 ,case pi.state
		  when 1 then '已揽收'
		  when 2 then '运输中'
		  when 3 then '派送中'
		  when 4 then '已滞留'
		  when 5 then '已签收'
		  when 6 then '疑难件处理中'
		  when 7 then '已退件'
		  when 8 then '异常关闭'
		  when 9 then '已撤销'
		  ELSE pi.state
		  end as '包裹状态'
	 ,ss1.name '目的地网点'
	 ,ss2.name '上报疑难件网点'
	, di.diff_marker_category
    ,case di.diff_marker_category # 疑难原因
            when 1 then '客户不在家/电话无人接听'
            when 2 then '收件人拒收'
            when 3 then '快件分错网点'
            when 4 then '外包装破损'
            when 5 then '货物破损'
            when 6 then '货物短少'
            when 7 then '货物丢失'
            when 8 then '电话联系不上'
            when 9 then '客户改约时间'
            when 10 then '客户不在'
            when 11 then '客户取消任务'
            when 12 then '无人签收'
            when 13 then '客户周末或假期不收货'
            when 14 then '客户改约时间'
            when 15 then '当日运力不足，无法派送'
            when 16 then '联系不上收件人'
            when 17 then '收件人拒收'
            when 18 then '快件分错网点'
            when 19 then '外包装破损'
            when 20 then '货物破损'
            when 21 then '货物短少'
            when 22 then '货物丢失'
            when 23 then '详细地址错误'
            when 24 then '收件地址已废弃或不存在'
            when 25 then '收件人电话号码错误'
            when 26 then 'cod金额不正确'
            when 27 then '无实际包裹'
            when 28 then '已妥投未交接'
            when 29 then '收件人电话号码是空号'
            when 30 then '送错网点'
            when 31 then '省市乡邮编错误'
            when 32 then '禁运品'
            when 33 then '严重破损（丢弃）'
            when 34 then '退件两次尝试派送失败'
            when 35 then '不能打开locker'
            when 36 then 'locker不能使用'
            when 37 then '该地址找不到lockerstation'
            when 38 then '一票多件'
            when 39 then '多次尝试派件失败'
            when 40 then '客户不在家/电话无人接听'
            when 41 then '错过班车时间'
            when 42 then '目的地是偏远地区,留仓待次日派送'
            when 43 then '目的地是岛屿,留仓待次日派送'
            when 44 then '企业/机构当天已下班'
            when 45 then '子母件包裹未全部到达网点'
            when 46 then '不可抗力原因留仓(台风)'
            when 47 then '虚假包裹'
            when 50 then '客户取消寄件'
            when 51 then '信息录入错误'
            when 52 then '客户取消寄件'
            when 53 then 'lazada仓库拒收'
            when 69 then '禁运品'
            when 70 then '客户改约时间'
            when 71 then '当日运力不足，无法派送'
            when 72 then '客户周末或假期不收货'
            when 73 then '详细地址错误'
            when 74 then '收件地址已废弃或不存在'
            when 75 then '收件人电话号码错误'
            when 76 then 'cod金额不正确'
            when 77 then '企业/机构当天已下班'
            when 78 then '收件人电话号码是空号'
            when 79 then '快件分错网点-地址错误'
            when 80 then '客户取消任务'
            when 81 then '重复下单'
            when 82 then '已完成揽件'
            when 83 then '联系不上客户'
            when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
            when 85 then '寄件人电话号码是空号'
            when 86 then '包裹不符合揽收条件超大件'
            when 87 then '包裹不符合揽收条件违禁品'
            when 88 then '寄件人地址为岛屿'
            when 89 then '运力短缺，跟客户协商推迟揽收'
            when 90 then '包裹未准备好推迟揽收'
            when 91 then '包裹包装不符合运输标准'
            when 92 then '客户提供的清单里没有此包裹'
            when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
            when 94 then '客户取消寄件/客户实际不想寄此包裹'
            when 95 then '车辆/人力短缺推迟揽收'
            when 96 then '遗漏揽收(已停用)'
            when 97 then '子母件(一个单号多个包裹)'
            when 98 then '地址错误addresserror'
            when 99 then '包裹不符合揽收条件：超大件'
            when 100 then '包裹不符合揽收条件：违禁品'
            when 101 then '包裹包装不符合运输标准'
            when 102 then '包裹未准备好'
            when 103 then '运力短缺，跟客户协商推迟揽收'
            when 104 then '子母件(一个单号多个包裹)'
            when 105 then '破损包裹'
            when 106 then '空包裹'
            when 107 then '不能打开locker(密码错误)'
            when 108 then 'locker不能使用'
            when 109 then 'locker找不到'
            when 110 then '运单号与实际包裹的单号不一致'
            when 111 then 'box客户取消任务'
            when 112 then '不能打开locker(密码错误)'
            when 113 then 'locker不能使用'
            when 114 then 'locker找不到'
            when 115 then '实际重量尺寸大于客户下单的重量尺寸'
            when 116 then '客户仓库关闭'
            when 117 then '客户仓库关闭'
            when 118 then 'SHOPEE订单系统自动关闭'
            when 119 then '客户取消包裹'
            when 121 then '地址错误'
            when 122 then '当日运力不足，无法揽收'
        end  as ' 疑难件原因 '
	 ,convert_tz(di.created_at,'+00:00','+08:00') '上报时间'
     ,date(convert_tz(di.created_at,'+00:00','+08:00')) '上报日期'
	 ,di.staff_info_id '上报人'
	 ,hi.name '上报人姓名'
	 ,sd.name '处理机构'
	 ,cdt.operator_id '客服操作人ID'
	 ,convert_tz(cdt.first_operated_at,'+00:00','+08:00') '第一次处理时间'
	 ,ifnull(convert_tz(cdt.last_operated_at,'+00:00','+08:00'),convert_tz(cdt.first_operated_at,'+00:00','+08:00')) '最后一次处理时间'
	 ,case cdt.state
		  when 0 then '未处理'
		  when 1 then '已处理'
		  when 2 then '正在沟通中'
		  when 3 then '财务驳回'
		  when 4 then '客户未处理'
		  when 5 then '转交闪速系统'
		  when 6 then '转交QAQC'
		  else cdt.state
		  end '客服处理情况'

     ,case cdt.negotiation_result_category
          when 1 then '赔偿'
          when 2        then '关闭订单(不赔偿不退货)'
          when 3        then'退货'
          when 4        then '退货并赔偿'
          when 5        then '继续配送'
          when 6        then '继续配送并赔偿'
          when 7        then '正在沟通中'
          when 8        then '丢弃包裹的，换单后寄回BKK'
          when 9        then '货物找回，继续派送'
          when 10       then  '改包裹状态'
          when 11       then '需客户修改信息'
          when 12       then '丢弃并赔偿（包裹发到内部拍卖仓）'
	  end '处理结果'
	 ,datediff('hour',convert_tz(di.created_at,'+00:00','+08:00'),ifnull(convert_tz(cdt.last_operated_at,'+00:00','+08:00'),convert_tz(cdt.first_operated_at,'+00:00','+08:00'))) '客服处理-上报时长/h'
	 ,case di.state
		  when 0 then '未处理'
		  when 1 then '已处理'
		  else di.state
      end '疑难件处理情况'
	 ,if(di.state=1,convert_tz(cdt.updated_at,'+00:00','+08:00'),null)  '疑难件处理完成时间'
# 	 ,datediff('hour',convert_tz(di.created_at,'+00:00','+08:00'),if(di.state=1,convert_tz(di.updated_at,'+00:00','+08:00'),null)) '疑难件处理时长/h'
# 	 ,datediff(now(),if(di.state=0,convert_tz(di.created_at,'+00:00','+08:00'),null) ) '未处理当前时间-上报时间/d'
#     ,if(di.state = 0 and di.created_at >= concat(curdate(), ' 12:00:00'), '当日20点后', '之前') 8点判断
    ,case
        when di.created_at >= date_add('2023-08-10', interval 12 hour ) then '当日20点后'
        when di.created_at < date_add('2023-08-10', interval 12 hour ) and di.created_at >= date_sub('2023-08-10', interval 8 hour ) then '积压时间 0 day'
        when di.created_at < date_sub('2023-08-10', interval 8 hour ) then concat('积压时间', datediff('2023-08-10', convert_tz(di.created_at , '+00:00', '+08:00'), ' day'))
    end 积压时长
    ,case
        when cdt.state = 1 and cdt.updated_at <= date_add(cdt.created_at, interval  2 hour) then '及时'
        when cdt.state = 1 and cdt.updated_at > date_add(cdt.created_at, interval  2 hour) then '不及时'
        else null
    end 是否及时
    ,if(di.state = 1 , round(timestampdiff(second, di.created_at, di.updated_at )/ 3600, 2), null) 处理时长_h
from ph_staging.diff_info di
# left join dwm.dwd_dim_dict tdt2 on di.diff_marker_category= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category' -- 标记原因
join ph_staging.parcel_info pi on pi.pno=di.pno
left join dwm.dwd_dim_bigClient dd on dd.client_id = pi.client_id and dd.client_name in ('lazada', 'shopee', 'tiktok')
left join ph_staging.ka_profile kp on kp.id = pi.client_id
left join ph_bi.sys_store ss on ss.id=pi.ticket_pickup_store_id #揽收网点
left join ph_bi.sys_store ss1 on ss1.id=pi.dst_store_id#目的地网点
left join ph_bi.sys_store ss2 on ss2.id=di.store_id #上报当前网点
left join ph_bi.hr_staff_info hi on hi.staff_info_id=di.staff_info_id #疑难件处理人对应网点
join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id=di.id and cdt.organization_type=2 #疑难件处理进度
left join ph_bi.hr_staff_info hi2 on hi2.staff_info_id=cdt.operator_id #疑难件处理人对应网点
left join ph_bi.sys_department sd on sd.id=hi2.node_department_id
left join nl_production.violation_return_visit vrv on vrv.type in (3,8)  and json_extract(vrv.extra_value, '$.diff_id') = di.id
where
    di.diff_marker_category not in (7,22,5,20,6,21,15,71,34,69,32,39,53,28)
    and di.created_at >= date_add('2023-08-10', interval  1 hour)
    and di.created_at < date_add('2023-08-10', interval 12 hour)
    and vrv.link_id is null;
;-- -. . -..- - / . -. - .-. -.--
select
	 di.pno '运单号'
     ,case
          when dd.`client_id` is not null then dd.client_name
          when kp.id is not null and dd.client_id is null then '普通ka'
          when kp.`id` is null then '小c'
      end 客户名称
	 ,convert_tz(pi.created_at,'+00:00','+08:00') '揽收日期'
	 ,ss.name '揽收网点'
	 ,case pi.state
		  when 1 then '已揽收'
		  when 2 then '运输中'
		  when 3 then '派送中'
		  when 4 then '已滞留'
		  when 5 then '已签收'
		  when 6 then '疑难件处理中'
		  when 7 then '已退件'
		  when 8 then '异常关闭'
		  when 9 then '已撤销'
		  ELSE pi.state
		  end as '包裹状态'
	 ,ss1.name '目的地网点'
	 ,ss2.name '上报疑难件网点'
	, di.diff_marker_category
    ,case di.diff_marker_category # 疑难原因
            when 1 then '客户不在家/电话无人接听'
            when 2 then '收件人拒收'
            when 3 then '快件分错网点'
            when 4 then '外包装破损'
            when 5 then '货物破损'
            when 6 then '货物短少'
            when 7 then '货物丢失'
            when 8 then '电话联系不上'
            when 9 then '客户改约时间'
            when 10 then '客户不在'
            when 11 then '客户取消任务'
            when 12 then '无人签收'
            when 13 then '客户周末或假期不收货'
            when 14 then '客户改约时间'
            when 15 then '当日运力不足，无法派送'
            when 16 then '联系不上收件人'
            when 17 then '收件人拒收'
            when 18 then '快件分错网点'
            when 19 then '外包装破损'
            when 20 then '货物破损'
            when 21 then '货物短少'
            when 22 then '货物丢失'
            when 23 then '详细地址错误'
            when 24 then '收件地址已废弃或不存在'
            when 25 then '收件人电话号码错误'
            when 26 then 'cod金额不正确'
            when 27 then '无实际包裹'
            when 28 then '已妥投未交接'
            when 29 then '收件人电话号码是空号'
            when 30 then '送错网点'
            when 31 then '省市乡邮编错误'
            when 32 then '禁运品'
            when 33 then '严重破损（丢弃）'
            when 34 then '退件两次尝试派送失败'
            when 35 then '不能打开locker'
            when 36 then 'locker不能使用'
            when 37 then '该地址找不到lockerstation'
            when 38 then '一票多件'
            when 39 then '多次尝试派件失败'
            when 40 then '客户不在家/电话无人接听'
            when 41 then '错过班车时间'
            when 42 then '目的地是偏远地区,留仓待次日派送'
            when 43 then '目的地是岛屿,留仓待次日派送'
            when 44 then '企业/机构当天已下班'
            when 45 then '子母件包裹未全部到达网点'
            when 46 then '不可抗力原因留仓(台风)'
            when 47 then '虚假包裹'
            when 50 then '客户取消寄件'
            when 51 then '信息录入错误'
            when 52 then '客户取消寄件'
            when 53 then 'lazada仓库拒收'
            when 69 then '禁运品'
            when 70 then '客户改约时间'
            when 71 then '当日运力不足，无法派送'
            when 72 then '客户周末或假期不收货'
            when 73 then '详细地址错误'
            when 74 then '收件地址已废弃或不存在'
            when 75 then '收件人电话号码错误'
            when 76 then 'cod金额不正确'
            when 77 then '企业/机构当天已下班'
            when 78 then '收件人电话号码是空号'
            when 79 then '快件分错网点-地址错误'
            when 80 then '客户取消任务'
            when 81 then '重复下单'
            when 82 then '已完成揽件'
            when 83 then '联系不上客户'
            when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
            when 85 then '寄件人电话号码是空号'
            when 86 then '包裹不符合揽收条件超大件'
            when 87 then '包裹不符合揽收条件违禁品'
            when 88 then '寄件人地址为岛屿'
            when 89 then '运力短缺，跟客户协商推迟揽收'
            when 90 then '包裹未准备好推迟揽收'
            when 91 then '包裹包装不符合运输标准'
            when 92 then '客户提供的清单里没有此包裹'
            when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
            when 94 then '客户取消寄件/客户实际不想寄此包裹'
            when 95 then '车辆/人力短缺推迟揽收'
            when 96 then '遗漏揽收(已停用)'
            when 97 then '子母件(一个单号多个包裹)'
            when 98 then '地址错误addresserror'
            when 99 then '包裹不符合揽收条件：超大件'
            when 100 then '包裹不符合揽收条件：违禁品'
            when 101 then '包裹包装不符合运输标准'
            when 102 then '包裹未准备好'
            when 103 then '运力短缺，跟客户协商推迟揽收'
            when 104 then '子母件(一个单号多个包裹)'
            when 105 then '破损包裹'
            when 106 then '空包裹'
            when 107 then '不能打开locker(密码错误)'
            when 108 then 'locker不能使用'
            when 109 then 'locker找不到'
            when 110 then '运单号与实际包裹的单号不一致'
            when 111 then 'box客户取消任务'
            when 112 then '不能打开locker(密码错误)'
            when 113 then 'locker不能使用'
            when 114 then 'locker找不到'
            when 115 then '实际重量尺寸大于客户下单的重量尺寸'
            when 116 then '客户仓库关闭'
            when 117 then '客户仓库关闭'
            when 118 then 'SHOPEE订单系统自动关闭'
            when 119 then '客户取消包裹'
            when 121 then '地址错误'
            when 122 then '当日运力不足，无法揽收'
        end  as ' 疑难件原因 '
	 ,convert_tz(di.created_at,'+00:00','+08:00') '上报时间'
     ,date(convert_tz(di.created_at,'+00:00','+08:00')) '上报日期'
	 ,di.staff_info_id '上报人'
	 ,hi.name '上报人姓名'
	 ,sd.name '处理机构'
	 ,cdt.operator_id '客服操作人ID'
	 ,convert_tz(cdt.first_operated_at,'+00:00','+08:00') '第一次处理时间'
	 ,ifnull(convert_tz(cdt.last_operated_at,'+00:00','+08:00'),convert_tz(cdt.first_operated_at,'+00:00','+08:00')) '最后一次处理时间'
	 ,case cdt.state
		  when 0 then '未处理'
		  when 1 then '已处理'
		  when 2 then '正在沟通中'
		  when 3 then '财务驳回'
		  when 4 then '客户未处理'
		  when 5 then '转交闪速系统'
		  when 6 then '转交QAQC'
		  else cdt.state
		  end '客服处理情况'

     ,case cdt.negotiation_result_category
          when 1 then '赔偿'
          when 2        then '关闭订单(不赔偿不退货)'
          when 3        then'退货'
          when 4        then '退货并赔偿'
          when 5        then '继续配送'
          when 6        then '继续配送并赔偿'
          when 7        then '正在沟通中'
          when 8        then '丢弃包裹的，换单后寄回BKK'
          when 9        then '货物找回，继续派送'
          when 10       then  '改包裹状态'
          when 11       then '需客户修改信息'
          when 12       then '丢弃并赔偿（包裹发到内部拍卖仓）'
	  end '处理结果'
	 ,datediff('hour',convert_tz(di.created_at,'+00:00','+08:00'),ifnull(convert_tz(cdt.last_operated_at,'+00:00','+08:00'),convert_tz(cdt.first_operated_at,'+00:00','+08:00'))) '客服处理-上报时长/h'
	 ,case di.state
		  when 0 then '未处理'
		  when 1 then '已处理'
		  else di.state
      end '疑难件处理情况'
	 ,if(di.state=1,convert_tz(cdt.updated_at,'+00:00','+08:00'),null)  '疑难件处理完成时间'
# 	 ,datediff('hour',convert_tz(di.created_at,'+00:00','+08:00'),if(di.state=1,convert_tz(di.updated_at,'+00:00','+08:00'),null)) '疑难件处理时长/h'
# 	 ,datediff(now(),if(di.state=0,convert_tz(di.created_at,'+00:00','+08:00'),null) ) '未处理当前时间-上报时间/d'
#     ,if(di.state = 0 and di.created_at >= concat(curdate(), ' 12:00:00'), '当日20点后', '之前') 8点判断
    ,case
        when di.created_at >= date_add('2023-08-10', interval 12 hour ) then '当日20点后'
        when di.created_at < date_add('2023-08-10', interval 12 hour ) and di.created_at >= date_sub('2023-08-10', interval 8 hour ) then '积压时间 0 day'
        when di.created_at < date_sub('2023-08-10', interval 8 hour ) then concat('积压时间', datediff('2023-08-10', convert_tz(di.created_at , '+00:00', '+08:00'), ' day'))
    end 积压时长
    ,case
        when cdt.state = 1 and cdt.updated_at <= date_add(cdt.created_at, interval  2 hour) then '及时'
        when cdt.state = 1 and cdt.updated_at > date_add(cdt.created_at, interval  2 hour) then '不及时'
        else null
    end 是否及时
    ,if(di.state = 1 , round(timestampdiff(second, di.created_at, di.updated_at )/ 3600, 2), null) 处理时长_h
from ph_staging.diff_info di
# left join dwm.dwd_dim_dict tdt2 on di.diff_marker_category= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category' -- 标记原因
join ph_staging.parcel_info pi on pi.pno=di.pno
left join dwm.dwd_dim_bigClient dd on dd.client_id = pi.client_id and dd.client_name in ('lazada', 'shopee', 'tiktok')
left join ph_staging.ka_profile kp on kp.id = pi.client_id
left join ph_bi.sys_store ss on ss.id=pi.ticket_pickup_store_id #揽收网点
left join ph_bi.sys_store ss1 on ss1.id=pi.dst_store_id#目的地网点
left join ph_bi.sys_store ss2 on ss2.id=di.store_id #上报当前网点
left join ph_bi.hr_staff_info hi on hi.staff_info_id=di.staff_info_id #疑难件处理人对应网点
join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id=di.id  #疑难件处理进度
left join ph_bi.hr_staff_info hi2 on hi2.staff_info_id=cdt.operator_id #疑难件处理人对应网点
left join ph_bi.sys_department sd on sd.id=hi2.node_department_id
left join nl_production.violation_return_visit vrv on vrv.type in (3,8)  and json_extract(vrv.extra_value, '$.diff_id') = di.id
where
    di.diff_marker_category not in (7,22,5,20,6,21,15,71,34,69,32,39,53,28)
    and di.created_at >= date_add('2023-08-10', interval  1 hour)
    and di.created_at < date_add('2023-08-10', interval 12 hour)
    and vrv.link_id is null
    and kp.id is null;