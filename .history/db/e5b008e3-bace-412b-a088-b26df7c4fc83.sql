select
    bc.client_name
    ,vrv.visit_num
    ,vrv.id
    ,timestampdiff(second ,vrv.created_at, vrv.updated_at)/3600 diff_time
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
where
    vrv.visit_staff_id = 10001 -- IVR回访
    and vrv.type = 8 -- 多次尝试派送回访
    and vrv.visit_state = 4 -- 已回访
    and vrv.created_at >= '2023-08-16 09:00:00'
    and vrv.created_at < '2023-08-16 20:00:00'
    and vrv.visit_num in (1,2,3);
;-- -. . -..- - / . -. - .-. -.--
select
    a.client_name
    ,sum(if(a.visit_num = 1, a.diff_time, 0 ))/count(if(a.visit_num = 1, a.id, null)) 第一次拿到结果的平均时长
    ,sum(if(a.visit_num = 2, a.diff_time, 0 ))/count(if(a.visit_num = 2, a.id, null)) 第二次拿到结果的平均时长
    ,sum(if(a.visit_num = 3, a.diff_time, 0 ))/count(if(a.visit_num = 3, a.id, null)) 第三次拿到结果的平均时长
from
    (
        select
            bc.client_name
            ,vrv.visit_num
            ,vrv.id
            ,timestampdiff(second ,vrv.created_at, vrv.updated_at)/3600 diff_time
        from nl_production.violation_return_visit vrv
        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        where
            vrv.visit_staff_id = 10001 -- IVR回访
            and vrv.type = 8 -- 多次尝试派送回访
            and vrv.visit_state = 4 -- 已回访
            and vrv.created_at >= '2023-08-15 09:00:00'
            and vrv.created_at < '2023-08-15 20:00:00'
            and vrv.visit_num in (1,2,3)
    ) a
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    '9-20' 时间段
    ,bc.client_name 客户
    ,count(distinct if(vrv.visit_num = 1, vrv.link_id, null)) 第一次拿到结果包裹量
    ,count(distinct if(vrv.visit_num = 2, vrv.link_id, null)) 第二次拿到结果包裹量
    ,count(distinct if(vrv.visit_num = 3, vrv.link_id, null)) 第三次次拿到结果包裹量
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
where
    vrv.visit_staff_id = 10001 -- IVR回访
    and vrv.type = 8 -- 多次尝试派送回访
    and vrv.visit_state = 4 -- 已回访
    and vrv.created_at >= '2023-08-15 09:00:00'
    and vrv.created_at < '2023-08-15 20:00:00'
group by 1,2;
;-- -. . -..- - / . -. - .-. -.--
select
    bc.client_name
    ,vrv.visit_num
    ,vrv.id
    ,timestampdiff(second ,vrv.created_at, vrv.updated_at)/3600 diff_time
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
where
    vrv.visit_staff_id = 10001 -- IVR回访
    and vrv.type = 8 -- 多次尝试派送回访
    and vrv.visit_state = 4 -- 已回访
    and vrv.created_at >= '2023-08-15 09:00:00'
    and vrv.created_at < '2023-08-15 20:00:00'
    and vrv.visit_num in (1,2,3);
;-- -. . -..- - / . -. - .-. -.--
select
    a.client_name
    ,sum(if(a.visit_num = 1, a.diff_time, 0 ))/count(if(a.visit_num = 1, a.id, null)) 第一次拿到结果的平均时长
    ,sum(if(a.visit_num = 2, a.diff_time, 0 ))/count(if(a.visit_num = 2, a.id, null)) 第二次拿到结果的平均时长
    ,sum(if(a.visit_num = 3, a.diff_time, 0 ))/count(if(a.visit_num = 3, a.id, null)) 第三次拿到结果的平均时长
from
    (
        select
            bc.client_name
            ,vrv.visit_num
            ,vrv.id
            ,timestampdiff(second ,vrv.created_at, vrv.updated_at)/3600 diff_time
        from nl_production.violation_return_visit vrv
        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        where
            vrv.visit_staff_id = 10001 -- IVR回访
            and vrv.type = 8 -- 多次尝试派送回访
            and vrv.visit_state in (3,4) -- 已回访
            and vrv.created_at >= '2023-08-15 09:00:00'
            and vrv.created_at < '2023-08-15 20:00:00'
            and vrv.updated_at < '2023-008-16 00:00:00'
            and vrv.visit_num in (1,2,3)
    ) a
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
            bc.client_name
            ,vrv.visit_num
            ,vrv.id
            ,vrv.updated_at
            ,timestampdiff(second ,vrv.created_at, vrv.updated_at)/3600 diff_time
        from nl_production.violation_return_visit vrv
        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        where
            vrv.visit_staff_id = 10001 -- IVR回访
            and vrv.type = 8 -- 多次尝试派送回访
            and vrv.visit_state in (3,4) -- 已回访
            and vrv.created_at >= '2023-08-15 09:00:00'
            and vrv.created_at < '2023-08-15 20:00:00'
#             and vrv.updated_at < '2023-008-16 00:00:00'
            and vrv.visit_num in (1,2,3);
;-- -. . -..- - / . -. - .-. -.--
select
    a.client_name
    ,sum(if(a.visit_num = 1, a.diff_time, 0 ))/count(if(a.visit_num = 1, a.id, null)) 第一次拿到结果的平均时长
    ,sum(if(a.visit_num = 2, a.diff_time, 0 ))/count(if(a.visit_num = 2, a.id, null)) 第二次拿到结果的平均时长
    ,sum(if(a.visit_num = 3, a.diff_time, 0 ))/count(if(a.visit_num = 3, a.id, null)) 第三次拿到结果的平均时长
from
    (
        select
            bc.client_name
            ,vrv.visit_num
            ,vrv.id
            ,vrv.updated_at
            ,timestampdiff(second ,vrv.created_at, vrv.updated_at)/3600 diff_time
        from nl_production.violation_return_visit vrv
        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        where
            vrv.visit_staff_id = 10001 -- IVR回访
            and vrv.type = 8 -- 多次尝试派送回访
            and vrv.visit_state in (3,4) -- 已回访
            and vrv.created_at >= '2023-08-15 09:00:00'
            and vrv.created_at < '2023-08-15 20:00:00'
            and vrv.updated_at < '2023-08-16 00:00:00'
            and vrv.visit_num in (1,2,3)
    ) a
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    '9-20' 时间段
    ,bc.client_name 客户
    ,count(distinct if(vrv.visit_num = 1, vrv.link_id, null)) 第一次拿到结果包裹量
    ,count(distinct if(vrv.visit_num = 2, vrv.link_id, null)) 第二次拿到结果包裹量
    ,count(distinct if(vrv.visit_num = 3, vrv.link_id, null)) 第三次次拿到结果包裹量
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
where
    vrv.visit_staff_id = 10001 -- IVR回访
    and vrv.type = 8 -- 多次尝试派送回访
    and vrv.visit_state = 4 -- 已回访
    and vrv.created_at >= '2023-08-15 09:00:00'
    and vrv.created_at < '2023-08-15 20:00:00'
    and vrv.updated_at < '2023-08-16 00:00:00'
group by 1,2;
;-- -. . -..- - / . -. - .-. -.--
select
    '9-20' 时间段
    ,bc.client_name 客户
    ,count(distinct if(vrv.visit_num = 1, vrv.link_id, null)) 第一次拿到结果包裹量
    ,count(distinct if(vrv.visit_num = 2, vrv.link_id, null)) 第二次拿到结果包裹量
    ,count(distinct if(vrv.visit_num = 3, vrv.link_id, null)) 第三次次拿到结果包裹量
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
where
    vrv.visit_staff_id = 10001 -- IVR回访
    and vrv.type = 8 -- 多次尝试派送回访
    and vrv.visit_state in (3,4) -- 已回访
    and vrv.created_at >= '2023-08-15 09:00:00'
    and vrv.created_at < '2023-08-15 20:00:00'
    and vrv.updated_at < '2023-08-16 00:00:00'
group by 1,2;
;-- -. . -..- - / . -. - .-. -.--
select
    '9-20' 时间段
    ,bc.client_name 客户
    ,vrv.link_id
    ,vrv.visit_state
#     ,count(distinct if(vrv.visit_num = 1, vrv.link_id, null)) 第一次拿到结果包裹量
#     ,count(distinct if(vrv.visit_num = 2, vrv.link_id, null)) 第二次拿到结果包裹量
#     ,count(distinct if(vrv.visit_num = 3, vrv.link_id, null)) 第三次次拿到结果包裹量
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
where
    vrv.visit_staff_id = 10001 -- IVR回访
    and vrv.type = 8 -- 多次尝试派送回访
    and vrv.visit_state in (3,4) -- 已回访
    and vrv.created_at >= '2023-08-15 09:00:00'
    and vrv.created_at < '2023-08-15 20:00:00'
    and vrv.updated_at < '2023-08-16 00:00:00'
    and visit_num = 3
    and bc.client_name = 'shopee';
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        t.pno
        ,vrv.type
        ,case vrv.visit_state
            when 1 then '待回访'
            when 2 then '沟通中'
            when 3 then '多次未联系上客户'
            when 4 then '已回访'
            when 5 then '因同包裹生成其他回访任务关闭'
            when 6 then 'VR回访结果=99关闭'
            when 7 then '超回访时效关闭'
        end visit_stat
        ,vrv.visit_staff_id
        ,case vrv.visit_result
            when 1 then '联系不上'
            when 2 then '取消原因属实、合理'
            when 3 then '快递员虚假标记/违背客户意愿要求取消'
            when 4 then '多次联系不上客户'
            when 5 then '收件人已签收包裹'
            when 6 then '收件人未收到包裹'
            when 7 then '未经收件人允许投放他处/让他人代收'
            when 8 then '快递员没有联系客户，直接标记收件人拒收'
            when 9 then '收件人拒收情况属实'
            when 10 then '快递员服务态度差'
            when 11 then '因快递员未按照收件人地址送货，客户不方便去取货'
            when 12 then '网点派送速度慢，客户不想等'
            when 13 then '非快递员问题，个人原因拒收'
            when 14 then '其它'
            when 15 then '未经客户同意改约派件时间'
            when 16 then '未按约定时间派送'
            when 17 then '派件前未提前联系客户'
            when 18 then '收件人拒收情况不属实'
            when 19 then '快递员联系客户，但未经客户同意标记收件人拒收'
            when 20 then '快递员要求/威胁客户拒收'
            when 21 then '快递员引导客户拒收'
            when 22 then '其他'
            when 23 then '情况不属实，快递员虚假标记'
            when 24 then '情况不属实，快递员诱导客户改约时间'
            when 25 then '情况属实，客户原因改约时间'
            when 26 then '客户退货，不想购买该商品'
            when 27 then '客户未购买商品'
            when 28 then '客户本人/家人对包裹不知情而拒收'
            when 29 then '商家发错商品'
            when 30 then '包裹物流派送慢超时效'
            when 31 then '快递员服务态度差'
            when 32 then '因快递员未按照收件人地址送货，客户不方便去取货'
            when 33 then '货物验收破损'
            when 34 then '无人在家不便签收'
            when 35 then '客户错误拒收包裹'
            when 36 then '快递员按照要求当场扫描揽收'
            when 37 then '快递员未按照要求当场扫描揽收'
            when 38 then '无所谓，客户无要求'
            when 39 then '包裹未准备好 - 情况不属实，快递员虚假标记'
            when 40 then '包裹未准备好 - 情况属实，客户存在未准备好的包裹'
            when 41 then '虚假修改包裹信息'
            when 42 then '修改包裹信息属实'
        end as result
    from tmpale.tmp_ph_pno_0814 t
    left join nl_production.violation_return_visit vrv on vrv.link_id = t.pno
)
select
    t1.pno
    ,if(t3.pno is not null, '是', '否') 是否进入拒收回访
    ,if(t3.visit_staff_id != 10001, t3.visit_stat, null) 拒收人工回访状态
    ,if(t3.visit_staff_id != 10001, t3.result, null) 拒收人工回访结果
    ,if(t4.pno is not null, '是', '否') 是否进入拒收ivr回访
    ,t4.visit_stat 拒收IVR回访状态
    ,t4.result 拒收IVR回访结果
    ,if(t5.pno is not null, '是', '否') 是否进入三次尝试派送回访
    ,if(t5.visit_staff_id != 10001, t5.visit_stat, null) 三次尝试派送人工回访状态
    ,if(t5.visit_staff_id != 10001, t5.result, null) 三次尝试派送人工回访结果
    ,if(t6.pno is not null, '是', '否') 是否进入三次尝试派送ivr回访
    ,t6.visit_stat 三次尝试派送IVR回访状态
    ,t6.result 三次尝试派送IVR回访结果
from
    (
        select
            t1.pno
        from t t1
        group by 1
    )t1
left join
    (
        select
            t1.pno
            ,t1.visit_stat
            ,t1.visit_staff_id
            ,t1.result
        from t t1
        where
            t1.type = 3
        group by 1,2,3
    ) t3 on t3.pno = t1.pno
left join
    (
        select
            t1.pno
            ,t1.visit_stat
            ,t1.visit_staff_id
            ,t1.result
        from t t1
        where
            t1.type = 3
            and t1.visit_staff_id = 10001
        group by 1,2,3
    ) t4 on t4.pno = t1.pno
left join
    (
        select
            t1.pno
            ,t1.visit_stat
            ,t1.visit_staff_id
            ,t1.result
        from t t1
        where
            t1.type = 8
        group by 1,2,3
    ) t5 on t5.pno = t1.pno
left join
    (
        select
            t1.pno
            ,t1.visit_stat
            ,t1.visit_staff_id
            ,t1.result
        from t t1
        where
            t1.type = 8
            and t1.visit_staff_id = 10001
        group by 1,2,3
    ) t6 on t6.pno = t1.pno;
;-- -. . -..- - / . -. - .-. -.--
select
    t.pno
    ,vrv.created_at 回访创建时间
    ,case vrv.visit_state
        when 1 then '待回访'
        when 2 then '沟通中'
        when 3 then '多次未联系上客户'
        when 4 then '已回访'
        when 5 then '因同包裹生成其他回访任务关闭'
        when 6 then 'VR回访结果=99关闭'
        when 7 then '超回访时效关闭'
    end 回访状态
    ,vrv.visit_staff_id 回访员工
    ,case vrv.visit_result
        when 1 then '联系不上'
        when 2 then '取消原因属实、合理'
        when 3 then '快递员虚假标记/违背客户意愿要求取消'
        when 4 then '多次联系不上客户'
        when 5 then '收件人已签收包裹'
        when 6 then '收件人未收到包裹'
        when 7 then '未经收件人允许投放他处/让他人代收'
        when 8 then '快递员没有联系客户，直接标记收件人拒收'
        when 9 then '收件人拒收情况属实'
        when 10 then '快递员服务态度差'
        when 11 then '因快递员未按照收件人地址送货，客户不方便去取货'
        when 12 then '网点派送速度慢，客户不想等'
        when 13 then '非快递员问题，个人原因拒收'
        when 14 then '其它'
        when 15 then '未经客户同意改约派件时间'
        when 16 then '未按约定时间派送'
        when 17 then '派件前未提前联系客户'
        when 18 then '收件人拒收情况不属实'
        when 19 then '快递员联系客户，但未经客户同意标记收件人拒收'
        when 20 then '快递员要求/威胁客户拒收'
        when 21 then '快递员引导客户拒收'
        when 22 then '其他'
        when 23 then '情况不属实，快递员虚假标记'
        when 24 then '情况不属实，快递员诱导客户改约时间'
        when 25 then '情况属实，客户原因改约时间'
        when 26 then '客户退货，不想购买该商品'
        when 27 then '客户未购买商品'
        when 28 then '客户本人/家人对包裹不知情而拒收'
        when 29 then '商家发错商品'
        when 30 then '包裹物流派送慢超时效'
        when 31 then '快递员服务态度差'
        when 32 then '因快递员未按照收件人地址送货，客户不方便去取货'
        when 33 then '货物验收破损'
        when 34 then '无人在家不便签收'
        when 35 then '客户错误拒收包裹'
        when 36 then '快递员按照要求当场扫描揽收'
        when 37 then '快递员未按照要求当场扫描揽收'
        when 38 then '无所谓，客户无要求'
        when 39 then '包裹未准备好 - 情况不属实，快递员虚假标记'
        when 40 then '包裹未准备好 - 情况属实，客户存在未准备好的包裹'
        when 41 then '虚假修改包裹信息'
        when 42 then '修改包裹信息属实'
    end as 回访结果
from tmpale.tmp_ph_pno_0814 t
left join nl_production.violation_return_visit vrv on vrv.link_id = t.pno;
;-- -. . -..- - / . -. - .-. -.--
select
    t.pno
    ,vrv.created_at 回访创建时间
    ,case vrv.visit_state
            when 0 then '终态或变更派件标记等无须回访'
            when 1 then '待回访'
            when 2 then '沟通中'
            when 3 then '多次未联系上客户'
            when 4 then '已回访'
            when 5 then '因同包裹生成其他回访任务关闭'
            when 6 then 'VR回访结果=99关闭'
            when 7 then '超回访时效关闭'
        end  回访状态
    ,vrv.visit_staff_id 回访员工
    ,case vrv.visit_result
        when 1 then '联系不上'
        when 2 then '取消原因属实、合理'
        when 3 then '快递员虚假标记/违背客户意愿要求取消'
        when 4 then '多次联系不上客户'
        when 5 then '收件人已签收包裹'
        when 6 then '收件人未收到包裹'
        when 7 then '未经收件人允许投放他处/让他人代收'
        when 8 then '快递员没有联系客户，直接标记收件人拒收'
        when 9 then '收件人拒收情况属实'
        when 10 then '快递员服务态度差'
        when 11 then '因快递员未按照收件人地址送货，客户不方便去取货'
        when 12 then '网点派送速度慢，客户不想等'
        when 13 then '非快递员问题，个人原因拒收'
        when 14 then '其它'
        when 15 then '未经客户同意改约派件时间'
        when 16 then '未按约定时间派送'
        when 17 then '派件前未提前联系客户'
        when 18 then '收件人拒收情况不属实'
        when 19 then '快递员联系客户，但未经客户同意标记收件人拒收'
        when 20 then '快递员要求/威胁客户拒收'
        when 21 then '快递员引导客户拒收'
        when 22 then '其他'
        when 23 then '情况不属实，快递员虚假标记'
        when 24 then '情况不属实，快递员诱导客户改约时间'
        when 25 then '情况属实，客户原因改约时间'
        when 26 then '客户退货，不想购买该商品'
        when 27 then '客户未购买商品'
        when 28 then '客户本人/家人对包裹不知情而拒收'
        when 29 then '商家发错商品'
        when 30 then '包裹物流派送慢超时效'
        when 31 then '快递员服务态度差'
        when 32 then '因快递员未按照收件人地址送货，客户不方便去取货'
        when 33 then '货物验收破损'
        when 34 then '无人在家不便签收'
        when 35 then '客户错误拒收包裹'
        when 36 then '快递员按照要求当场扫描揽收'
        when 37 then '快递员未按照要求当场扫描揽收'
        when 38 then '无所谓，客户无要求'
        when 39 then '包裹未准备好 - 情况不属实，快递员虚假标记'
        when 40 then '包裹未准备好 - 情况属实，客户存在未准备好的包裹'
        when 41 then '虚假修改包裹信息'
        when 42 then '修改包裹信息属实'
    end as 回访结果
from tmpale.tmp_ph_pno_0814 t
left join nl_production.violation_return_visit vrv on vrv.link_id = t.pno;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.CT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-08-16'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.CT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-08-16'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-08-16', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with d as
    (
        select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-08-16'
    )
    , t as
    (
        select
             ds.store_id
            ,ds.pno
            ,ds.stat_date
        from d ds
        left join
            (
                select
                    pr.pno
                    ,ds.stat_date
                    ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
                from ph_staging.parcel_route pr
                join d ds on pr.pno = ds.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                    and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and pr.marker_category in (42,43) ##岛屿,偏远地区
                group by 1,2
            ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
        left join
            (
                select
                   pr.pno
                    ,ds.stat_date
                   ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
                   ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
                from ph_staging.parcel_route pr
                join d ds on ds.pno = pr.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                    and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                    and pr.marker_category in (9,14,70) ##客户改约时间
            ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
        left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
        where
            case
                when pr1.pno is not null then 'N'
                when pr2.pno is not null then 'N'
                when ds1.pno is not null  then 'N'  else 'Y'
            end = 'Y'
    )
    select
        a.stat_date 日期
        ,a.store_id 网点ID
        ,dp.store_name 网点名称
        ,dp.opening_at 开业时间
        ,case
            when dp.region_name in ('Area3', 'Area6') then '彭万松'
            when dp.region_name in ('Area4', 'Area9') then '韩钥'
            when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
            when dp.region_name in ( 'Area8') then '黄勇'
            when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
        end 区域
        ,dp.region_name 大区
        ,dp.piece_name 片区
        ,a.应交接
        ,a.已交接
        ,concat(round(a.交接率*100,2),'%') as 交接率
        ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
        ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
        ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
        ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
        ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
    from
        (
            select
                t1.store_id
                ,t1.stat_date
                ,count(t1.pno) 应交接
                ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
            from t t1
            left join
                (
                    select
                        sc.*
                    from
                        (
                            select
                                pr.pno
                                ,pr.store_id
                                ,pr.store_name
                                ,t1.stat_date
                                ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                            from ph_staging.parcel_route pr
                            join t t1 on t1.pno = pr.pno
                            where
                                pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                               and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                              and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                        ) sc
                    where
                        sc.rk = 1
                ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
            group by 1,2
        ) a
    join
        (
            select
                sd.store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.store_id is not null
            group by 1

            union all

            select
                sd.separation_store_id store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.separation_store_id is not null
            group by 1
        ) sd on sd.store_id = a.store_id
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    where
        dp.store_category in (1,10);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-08-16'
        and pr.routed_at >= date_sub('2023-08-16', interval 8 hour )
        and pr.routed_at < date_add('2023-08-16', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end 评级
        ,a2.code_num
        ,a2.staff_code_num
        ,a2.staff_num
        ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
select -- 基于当日应派取扫描率
    tt.store_id 网点ID
    ,tt.store_name 网点名称
    ,tt.store_type 网点分类
    ,tt.piece_name 片区
    ,tt.region_name 大区
    ,tt.shoud_counts 应派总数
    ,tt.scan_fished_counts 分拣扫描数
    ,ifnull(tt.scan_fished_counts/shoud_counts,0) 分拣扫描率

    ,tt.youxiao_counts 有效分拣扫描数
    ,ifnull(tt.youxiao_counts/tt.scan_fished_counts,0) 有效分拣扫描率

    ,tt.1pai_counts 一派应派数
    ,tt.1pai_scan_fished_counts 一派分拣扫描数
    ,ifnull(tt.1pai_scan_fished_counts/tt.1pai_counts,0) 一派分拣扫描率

    ,tt.1pai_youxiao_counts 一派有效分拣扫描数
    ,ifnull(tt.1pai_youxiao_counts/tt.1pai_scan_fished_counts,0) 一派有效分拣扫描率
    ,
    case
	    when tt.1pai_youxiao_counts/tt.1pai_scan_fished_counts>=0.95 then 'A'
	    when tt.1pai_youxiao_counts/tt.1pai_scan_fished_counts>=0.90 then 'B'
	    when tt.1pai_youxiao_counts/tt.1pai_scan_fished_counts>=0.85 then 'C'
	    when tt.1pai_youxiao_counts/tt.1pai_scan_fished_counts>=0.80 then 'D'
	    else 'E'
	 end 一派有效分拣评级 -- 一派有效分拣

	 ,case
        when tt.1pai_hour_8_fished_counts/tt.1pai_counts>=0.95  then 'A'
        when tt.1pai_hour_8ban_fished_counts/tt.1pai_counts>=0.95  then 'B'
        when tt.1pai_hour_9_fished_counts/tt.1pai_counts>=0.95  then 'C'
        when tt.1pai_hour_9ban_fished_counts/tt.1pai_counts>=0.95  then 'D'
        else 'E'
       end 一派分拣评级

    ,ifnull(tt.1pai_hour_8_fished_counts/tt.1pai_counts,0) 一派8点前扫描占比
    ,ifnull(tt.1pai_hour_8ban_fished_counts/tt.1pai_counts,0) 一派8点半前扫描占比
    ,ifnull(tt.1pai_hour_9_fished_counts/tt.1pai_counts,0) 一派9点前扫描占比
    ,ifnull(tt.1pai_hour_9ban_fished_counts/tt.1pai_counts,0) 一派9点半前扫描占比
	,tt2.late_proof_counts 是否有迟到超过规划时间20分钟的常规车
    ,tt2.max_real_arrive_time_normal 一派常规车最晚实际到达时间
    ,tt2.max_real_arrive_proof_id 一派常规车最晚实际到达车线
    ,tt2.max_real_arrive_vol 一派常规车最晚实际到达车线包裹量
    ,tt2.line_1_latest_plan_arrive_time 一派常规车最晚规划到达时间
    ,tt2.max_real_arrive_time_innormal 一派加班车最晚实际到达时间
    ,tt2.max_real_arrive_innormal_proof_id  一派加班车最晚实际到达车线
    ,tt2.max_real_arrive_innormal_vol  一派加班车最晚实际到达包裹量
    ,tt2.max_actual_plan_arrive_time_innormal 一派加班车最晚规划到达时间


from
(
    select
       base.store_id
       ,base.store_name
       ,base.store_type
       ,base.piece_name
       ,base.region_name
       ,count(distinct base.pno) shoud_counts
       ,count(distinct case when base.min_fenjian_scan_time is not null then base.pno else null end ) scan_fished_counts
       ,count(distinct case when base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then base.pno else null end ) youxiao_counts

       ,count(distinct case when base.type='一派' then  base.pno else null end ) 1pai_counts
       ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null then  base.pno else null end ) 1pai_scan_fished_counts
       ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then  base.pno else null end ) 1pai_youxiao_counts

       ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:00:00' then base.pno else null end) 1pai_hour_8_fished_counts
       ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:30:00' then base.pno else null end) 1pai_hour_8ban_fished_counts
       ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:00:00' then base.pno else null end) 1pai_hour_9_fished_counts
       ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:30:00' then base.pno else null end) 1pai_hour_9ban_fished_counts

    from
    (
       select
       t.*,
       case when t.should_delevry_type='1派应派包裹' then '一派' else null end 'type'
       from dwm.dwd_ph_dc_should_be_delivery_sort_scan t
       join ph_staging.sys_store ss
       on t.store_id =ss.id
    ) base
    group by base.store_id,base.store_name,base.store_type,base.piece_name,base.region_name
) tt

left join
(
    select
       bl.store_id
       ,bl.max_real_arrive_time_normal
       ,bl.max_real_arrive_proof_id
       ,bl.max_real_arrive_vol
       ,bl.line_1_latest_plan_arrive_time
       ,bl.max_actual_plan_arrive_time_innormal
       ,bl.max_actual_plan_arrive_innormal_proof_id
       ,bl.max_actual_plan_arrive_innormal_vol
       ,bl.max_real_arrive_time_innormal
       ,bl.max_real_arrive_innormal_proof_id
       ,bl.max_real_arrive_innormal_vol
	   ,late_proof_counts
    from dwm.fleet_real_detail_today bl
    group by 1,2,3,4,5,6,7,8,9,10,11
) tt2 on tt.store_id=tt2.store_id;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-16'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-08-16')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-08-16'
        and pi.finished_at >= date_sub('2023-08-16', interval 8 hour )
        and pi.finished_at < date_add('2023-08-16', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-08-16'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
select
    t.pno
    ,vrv.created_at 回访创建时间
    ,case vrv.visit_state
            when 0 then '终态或变更派件标记等无须回访'
            when 1 then '待回访'
            when 2 then '沟通中'
            when 3 then '多次未联系上客户'
            when 4 then '已回访'
            when 5 then '因同包裹生成其他回访任务关闭'
            when 6 then 'VR回访结果=99关闭'
            when 7 then '超回访时效关闭'
        end  回访状态
    ,vrv.visit_staff_id 回访员工
    ,case vrv.visit_result
        when 1 then '联系不上'
        when 2 then '取消原因属实、合理'
        when 3 then '快递员虚假标记/违背客户意愿要求取消'
        when 4 then '多次联系不上客户'
        when 5 then '收件人已签收包裹'
        when 6 then '收件人未收到包裹'
        when 7 then '未经收件人允许投放他处/让他人代收'
        when 8 then '快递员没有联系客户，直接标记收件人拒收'
        when 9 then '收件人拒收情况属实'
        when 10 then '快递员服务态度差'
        when 11 then '因快递员未按照收件人地址送货，客户不方便去取货'
        when 12 then '网点派送速度慢，客户不想等'
        when 13 then '非快递员问题，个人原因拒收'
        when 14 then '其它'
        when 15 then '未经客户同意改约派件时间'
        when 16 then '未按约定时间派送'
        when 17 then '派件前未提前联系客户'
        when 18 then '收件人拒收情况不属实'
        when 19 then '快递员联系客户，但未经客户同意标记收件人拒收'
        when 20 then '快递员要求/威胁客户拒收'
        when 21 then '快递员引导客户拒收'
        when 22 then '其他'
        when 23 then '情况不属实，快递员虚假标记'
        when 24 then '情况不属实，快递员诱导客户改约时间'
        when 25 then '情况属实，客户原因改约时间'
        when 26 then '客户退货，不想购买该商品'
        when 27 then '客户未购买商品'
        when 28 then '客户本人/家人对包裹不知情而拒收'
        when 29 then '商家发错商品'
        when 30 then '包裹物流派送慢超时效'
        when 31 then '快递员服务态度差'
        when 32 then '因快递员未按照收件人地址送货，客户不方便去取货'
        when 33 then '货物验收破损'
        when 34 then '无人在家不便签收'
        when 35 then '客户错误拒收包裹'
        when 36 then '快递员按照要求当场扫描揽收'
        when 37 then '快递员未按照要求当场扫描揽收'
        when 38 then '无所谓，客户无要求'
        when 39 then '包裹未准备好 - 情况不属实，快递员虚假标记'
        when 40 then '包裹未准备好 - 情况属实，客户存在未准备好的包裹'
        when 41 then '虚假修改包裹信息'
        when 42 then '修改包裹信息属实'
        when 44 then '客户需要包裹，继续派送'
        when 45 then '客户不需要包裹，操作退件'
    end as 回访结果
from tmpale.tmp_ph_pno_0814 t
left join nl_production.violation_return_visit vrv on vrv.link_id = t.pno;
;-- -. . -..- - / . -. - .-. -.--
select
    count(vrv.id) 任务量
    ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at <  date_add('2023-08-14', interval 1 day), vrv.id, null))/count(vrv.id) 今日完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 18:00:00'), vrv.id, null))/count(vrv.id) 18点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 19:00:00'), vrv.id, null))/count(vrv.id) 19点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 20:00:00'), vrv.id, null))/count(vrv.id) 20点前完成占比
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
where
    vrv.visit_staff_id in (10001, 0) -- IVR已回访+ 等待ivr回访
    and vrv.type = 8
    and vrv.created_at >= concat('2023-08-14', ' 09:00:00')
    and vrv.created_at < concat('2023-08-14', ' 17:00:00');
;-- -. . -..- - / . -. - .-. -.--
select
    count(vrv.id) 任务量
    ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at <  date_add('2023-08-14', interval 1 day), vrv.id, null))/count(vrv.id) 今日完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 18:00:00'), vrv.id, null))/count(vrv.id) 18点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 19:00:00'), vrv.id, null))/count(vrv.id) 19点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 20:00:00'), vrv.id, null))/count(vrv.id) 20点前完成占比
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
where
    vrv.visit_staff_id in (10001, 0) -- IVR已回访+ 等待ivr回访
    and vrv.type = 8
    and vrv.created_at >= concat('2023-08-14', ' 09:00:00')
    and vrv.created_at < concat('2023-08-14', ' 18:00:00');
;-- -. . -..- - / . -. - .-. -.--
select
    count(vrv.id) 任务量
    ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at <  date_add('2023-08-14', interval 1 day), vrv.id, null))/count(vrv.id) 今日完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 18:00:00'), vrv.id, null))/count(vrv.id) 18点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 19:00:00'), vrv.id, null))/count(vrv.id) 19点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 20:00:00'), vrv.id, null))/count(vrv.id) 20点前完成占比
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
where
    vrv.visit_staff_id in (10001, 0) -- IVR已回访+ 等待ivr回访
    and vrv.type = 8
    and vrv.created_at >= concat('2023-08-14', ' 09:00:00')
    and vrv.created_at < concat('2023-08-14', ' 19:00:00');
;-- -. . -..- - / . -. - .-. -.--
select
    count(vrv.id) 任务量
    ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at <  date_add('2023-08-14', interval 1 day), vrv.id, null))/count(vrv.id) 今日完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 18:00:00'), vrv.id, null))/count(vrv.id) 18点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 19:00:00'), vrv.id, null))/count(vrv.id) 19点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 20:00:00'), vrv.id, null))/count(vrv.id) 20点前完成占比
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
where
    vrv.visit_staff_id in (10001, 0) -- IVR已回访+ 等待ivr回访
    and vrv.type = 8
    and vrv.created_at >= concat('2023-08-14', ' 09:00:00')
    and vrv.created_at < concat('2023-08-14', ' 16:00:00');
;-- -. . -..- - / . -. - .-. -.--
select
    count(vrv.id) 任务量
    ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at <  date_add('2023-08-15', interval 1 day), vrv.id, null))/count(vrv.id) 今日完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 18:00:00'), vrv.id, null))/count(vrv.id) 18点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 19:00:00'), vrv.id, null))/count(vrv.id) 19点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 20:00:00'), vrv.id, null))/count(vrv.id) 20点前完成占比
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
where
    vrv.visit_staff_id in (10001, 0) -- IVR已回访+ 等待ivr回访
    and vrv.type = 8
    and vrv.created_at >= concat('2023-08-15', ' 09:00:00')
    and vrv.created_at < concat('2023-08-15', ' 16:00:00');
;-- -. . -..- - / . -. - .-. -.--
select
    count(vrv.id) 任务量
    ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at <  date_add('2023-08-15', interval 1 day), vrv.id, null))/count(vrv.id) 今日完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 18:00:00'), vrv.id, null))/count(vrv.id) 18点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 19:00:00'), vrv.id, null))/count(vrv.id) 19点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 20:00:00'), vrv.id, null))/count(vrv.id) 20点前完成占比
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
where
    vrv.visit_staff_id in (10001, 0) -- IVR已回访+ 等待ivr回访
    and vrv.type = 8
    and vrv.created_at >= concat('2023-08-15', ' 09:00:00')
    and vrv.created_at < concat('2023-08-15', ' 17:00:00');
;-- -. . -..- - / . -. - .-. -.--
select
    count(vrv.id) 任务量
    ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at <  date_add('2023-08-15', interval 1 day), vrv.id, null))/count(vrv.id) 今日完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 18:00:00'), vrv.id, null))/count(vrv.id) 18点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 19:00:00'), vrv.id, null))/count(vrv.id) 19点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 20:00:00'), vrv.id, null))/count(vrv.id) 20点前完成占比
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
where
    vrv.visit_staff_id in (10001, 0) -- IVR已回访+ 等待ivr回访
    and vrv.type = 8
    and vrv.created_at >= concat('2023-08-15', ' 09:00:00')
    and vrv.created_at < concat('2023-08-15', ' 18:00:00');
;-- -. . -..- - / . -. - .-. -.--
select
    count(vrv.id) 任务量
    ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at <  date_add('2023-08-15', interval 1 day), vrv.id, null))/count(vrv.id) 今日完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 18:00:00'), vrv.id, null))/count(vrv.id) 18点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 19:00:00'), vrv.id, null))/count(vrv.id) 19点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 20:00:00'), vrv.id, null))/count(vrv.id) 20点前完成占比
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
where
    vrv.visit_staff_id in (10001, 0) -- IVR已回访+ 等待ivr回访
    and vrv.type = 8
    and vrv.created_at >= concat('2023-08-15', ' 09:00:00')
    and vrv.created_at < concat('2023-08-15', ' 19:00:00');
;-- -. . -..- - / . -. - .-. -.--
select
    count(vrv.id) 任务量
    ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at <  date_add('2023-08-16', interval 1 day), vrv.id, null))/count(vrv.id) 今日完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 18:00:00'), vrv.id, null))/count(vrv.id) 18点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 19:00:00'), vrv.id, null))/count(vrv.id) 19点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 20:00:00'), vrv.id, null))/count(vrv.id) 20点前完成占比
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
where
    vrv.visit_staff_id in (10001, 0) -- IVR已回访+ 等待ivr回访
    and vrv.type = 8
    and vrv.created_at >= concat('2023-08-16', ' 09:00:00')
    and vrv.created_at < concat('2023-08-16', ' 19:00:00');
;-- -. . -..- - / . -. - .-. -.--
select
    count(vrv.id) 任务量
    ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at <  date_add('2023-08-16', interval 1 day), vrv.id, null))/count(vrv.id) 今日完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 18:00:00'), vrv.id, null))/count(vrv.id) 18点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 19:00:00'), vrv.id, null))/count(vrv.id) 19点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 20:00:00'), vrv.id, null))/count(vrv.id) 20点前完成占比
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
where
    vrv.visit_staff_id in (10001, 0) -- IVR已回访+ 等待ivr回访
    and vrv.type = 8
    and vrv.created_at >= concat('2023-08-16', ' 09:00:00')
    and vrv.created_at < concat('2023-08-16', ' 18:00:00');
;-- -. . -..- - / . -. - .-. -.--
select
    count(vrv.id) 任务量
    ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at <  date_add('2023-08-16', interval 1 day), vrv.id, null))/count(vrv.id) 今日完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 18:00:00'), vrv.id, null))/count(vrv.id) 18点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 19:00:00'), vrv.id, null))/count(vrv.id) 19点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 20:00:00'), vrv.id, null))/count(vrv.id) 20点前完成占比
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
where
    vrv.visit_staff_id in (10001, 0) -- IVR已回访+ 等待ivr回访
    and vrv.type = 8
    and vrv.created_at >= concat('2023-08-16', ' 09:00:00')
    and vrv.created_at < concat('2023-08-16', ' 17:00:00');
;-- -. . -..- - / . -. - .-. -.--
select
    count(vrv.id) 任务量
    ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at <  date_add('2023-08-16', interval 1 day), vrv.id, null))/count(vrv.id) 今日完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 18:00:00'), vrv.id, null))/count(vrv.id) 18点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 19:00:00'), vrv.id, null))/count(vrv.id) 19点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 20:00:00'), vrv.id, null))/count(vrv.id) 20点前完成占比
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
where
    vrv.visit_staff_id in (10001, 0) -- IVR已回访+ 等待ivr回访
    and vrv.type = 8
    and vrv.created_at >= concat('2023-08-16', ' 09:00:00')
    and vrv.created_at < concat('2023-08-16', ' 16:00:00');
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        t.pno
        ,vrv.type
        ,case vrv.visit_state
            when 0 then '终态或变更派件标记等无须回访'
            when 1 then '待回访'
            when 2 then '沟通中'
            when 3 then '多次未联系上客户'
            when 4 then '已回访'
            when 5 then '因同包裹生成其他回访任务关闭'
            when 6 then 'VR回访结果=99关闭'
            when 7 then '超回访时效关闭'
        end visit_stat
        ,vrv.visit_staff_id
        ,case vrv.visit_result
            when 1 then '联系不上'
            when 2 then '取消原因属实、合理'
            when 3 then '快递员虚假标记/违背客户意愿要求取消'
            when 4 then '多次联系不上客户'
            when 5 then '收件人已签收包裹'
            when 6 then '收件人未收到包裹'
            when 7 then '未经收件人允许投放他处/让他人代收'
            when 8 then '快递员没有联系客户，直接标记收件人拒收'
            when 9 then '收件人拒收情况属实'
            when 10 then '快递员服务态度差'
            when 11 then '因快递员未按照收件人地址送货，客户不方便去取货'
            when 12 then '网点派送速度慢，客户不想等'
            when 13 then '非快递员问题，个人原因拒收'
            when 14 then '其它'
            when 15 then '未经客户同意改约派件时间'
            when 16 then '未按约定时间派送'
            when 17 then '派件前未提前联系客户'
            when 18 then '收件人拒收情况不属实'
            when 19 then '快递员联系客户，但未经客户同意标记收件人拒收'
            when 20 then '快递员要求/威胁客户拒收'
            when 21 then '快递员引导客户拒收'
            when 22 then '其他'
            when 23 then '情况不属实，快递员虚假标记'
            when 24 then '情况不属实，快递员诱导客户改约时间'
            when 25 then '情况属实，客户原因改约时间'
            when 26 then '客户退货，不想购买该商品'
            when 27 then '客户未购买商品'
            when 28 then '客户本人/家人对包裹不知情而拒收'
            when 29 then '商家发错商品'
            when 30 then '包裹物流派送慢超时效'
            when 31 then '快递员服务态度差'
            when 32 then '因快递员未按照收件人地址送货，客户不方便去取货'
            when 33 then '货物验收破损'
            when 34 then '无人在家不便签收'
            when 35 then '客户错误拒收包裹'
            when 36 then '快递员按照要求当场扫描揽收'
            when 37 then '快递员未按照要求当场扫描揽收'
            when 38 then '无所谓，客户无要求'
            when 39 then '包裹未准备好 - 情况不属实，快递员虚假标记'
            when 40 then '包裹未准备好 - 情况属实，客户存在未准备好的包裹'
            when 41 then '虚假修改包裹信息'
            when 42 then '修改包裹信息属实'
        end as result
    from tmpale.tmp_ph_pno_0814 t
    left join nl_production.violation_return_visit vrv on vrv.link_id = t.pno
)
select
    t1.pno
    ,if(t3.pno is not null, '是', '否') 是否进入拒收回访
    ,if(t3.visit_staff_id != 10001, t3.visit_stat, null) 拒收人工回访状态
    ,if(t3.visit_staff_id != 10001, t3.result, null) 拒收人工回访结果
    ,if(t4.pno is not null, '是', '否') 是否进入拒收ivr回访
    ,t4.visit_stat 拒收IVR回访状态
    ,t4.result 拒收IVR回访结果
    ,if(t5.pno is not null, '是', '否') 是否进入三次尝试派送回访
    ,if(t5.visit_staff_id != 10001, t5.visit_stat, null) 三次尝试派送人工回访状态
    ,if(t5.visit_staff_id != 10001, t5.result, null) 三次尝试派送人工回访结果
    ,if(t6.pno is not null, '是', '否') 是否进入三次尝试派送ivr回访
    ,t6.visit_stat 三次尝试派送IVR回访状态
    ,t6.result 三次尝试派送IVR回访结果
from
    (
        select
            t1.pno
        from t t1
        group by 1
    )t1
left join
    (
        select
            t1.pno
            ,t1.visit_stat
            ,t1.visit_staff_id
            ,t1.result
        from t t1
        where
            t1.type = 3
        group by 1,2,3
    ) t3 on t3.pno = t1.pno
left join
    (
        select
            t1.pno
            ,t1.visit_stat
            ,t1.visit_staff_id
            ,t1.result
        from t t1
        where
            t1.type = 3
            and t1.visit_staff_id = 10001
        group by 1,2,3
    ) t4 on t4.pno = t1.pno
left join
    (
        select
            t1.pno
            ,t1.visit_stat
            ,t1.visit_staff_id
            ,t1.result
        from t t1
        where
            t1.type = 8
        group by 1,2,3
    ) t5 on t5.pno = t1.pno
left join
    (
        select
            t1.pno
            ,t1.visit_stat
            ,t1.visit_staff_id
            ,t1.result
        from t t1
        where
            t1.type = 8
            and t1.visit_staff_id = 10001
        group by 1,2,3
    ) t6 on t6.pno = t1.pno;
;-- -. . -..- - / . -. - .-. -.--
select
    t.pno
    ,vrv.created_at 回访创建时间
    ,case vrv.visit_state
            when 0 then '终态或变更派件标记等无须回访'
            when 1 then '待回访'
            when 2 then '沟通中'
            when 3 then '多次未联系上客户'
            when 4 then '已回访'
            when 5 then '因同包裹生成其他回访任务关闭'
            when 6 then 'VR回访结果=99关闭'
            when 7 then '超回访时效关闭'
        end  回访状态
    ,vrv.visit_staff_id 回访员工
    ,case vrv.visit_result
        when 1 then '联系不上'
        when 2 then '取消原因属实、合理'
        when 3 then '快递员虚假标记/违背客户意愿要求取消'
        when 4 then '多次联系不上客户'
        when 5 then '收件人已签收包裹'
        when 6 then '收件人未收到包裹'
        when 7 then '未经收件人允许投放他处/让他人代收'
        when 8 then '快递员没有联系客户，直接标记收件人拒收'
        when 9 then '收件人拒收情况属实'
        when 10 then '快递员服务态度差'
        when 11 then '因快递员未按照收件人地址送货，客户不方便去取货'
        when 12 then '网点派送速度慢，客户不想等'
        when 13 then '非快递员问题，个人原因拒收'
        when 14 then '其它'
        when 15 then '未经客户同意改约派件时间'
        when 16 then '未按约定时间派送'
        when 17 then '派件前未提前联系客户'
        when 18 then '收件人拒收情况不属实'
        when 19 then '快递员联系客户，但未经客户同意标记收件人拒收'
        when 20 then '快递员要求/威胁客户拒收'
        when 21 then '快递员引导客户拒收'
        when 22 then '其他'
        when 23 then '情况不属实，快递员虚假标记'
        when 24 then '情况不属实，快递员诱导客户改约时间'
        when 25 then '情况属实，客户原因改约时间'
        when 26 then '客户退货，不想购买该商品'
        when 27 then '客户未购买商品'
        when 28 then '客户本人/家人对包裹不知情而拒收'
        when 29 then '商家发错商品'
        when 30 then '包裹物流派送慢超时效'
        when 31 then '快递员服务态度差'
        when 32 then '因快递员未按照收件人地址送货，客户不方便去取货'
        when 33 then '货物验收破损'
        when 34 then '无人在家不便签收'
        when 35 then '客户错误拒收包裹'
        when 36 then '快递员按照要求当场扫描揽收'
        when 37 then '快递员未按照要求当场扫描揽收'
        when 38 then '无所谓，客户无要求'
        when 39 then '包裹未准备好 - 情况不属实，快递员虚假标记'
        when 40 then '包裹未准备好 - 情况属实，客户存在未准备好的包裹'
        when 41 then '虚假修改包裹信息'
        when 42 then '修改包裹信息属实'
        when 43 then '客户需要包裹，继续派送'
        when 44 then '客户不需要包裹，操作退件'
    end as 回访结果
from tmpale.tmp_ph_pno_0814 t
left join nl_production.violation_return_visit vrv on vrv.link_id = t.pno;
;-- -. . -..- - / . -. - .-. -.--
select
    pr.pno
    ,ss.name 网点
    ,convert_tz(pr.routed_at, '+00:00', '+08:00') 妥投时间
    ,pr.staff_info_id 妥投员工
from ph_staging.parcel_route pr
left join ph_staging.parcel_info pi on pi.pno = pr.pno
left join ph_staging.sys_store ss on ss.id = pi.dst_store_id
where
    pr.route_action = 'DELIVERY_CONFIRM'
    and cast(json_extract(pr.extra_value, '$.offlineDelivery') as string) = 1
    and pr.routed_at > '2023-07-31 16:00:00'
    and pi.dst_store_id in ('PH77190100','PH73090800','PH73020100','PH77030100','PH77050A00','PH76120H00','PH74060200','PH76090C00','PH74010100','PH76040A00','PH73030300','PH76190100','PH74120A00','PH75060200','PH51050301','PH47170100','PH51050500','PH49040100','PH51030400','PH51020J00','PH47140200','PH49040102','PH47210100','PH51100100','PH47080301','PH51080100','PH49040101','PH47070A00','PH47200600','PH47120100','PH47150100','PH51080101','PH51120B01','PH45210101','PH45212600','PH50100100','PH46020100','PH45130F00','PH46050101','PH45200H00','PH44020100','PH44180100','PH46150100','PH45210100','PH45010100','PH44010T00','PH50100200','PH45140300','PH14010F00','PH14010F00','PH22130500','PH23100300');
;-- -. . -..- - / . -. - .-. -.--
select
    count(vrv.id) 任务量
    ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at <  date_add('2023-08-16', interval 1 day), vrv.id, null))/count(vrv.id) 今日完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 18:00:00'), vrv.id, null))/count(vrv.id) 18点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 19:00:00'), vrv.id, null))/count(vrv.id) 19点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 20:00:00'), vrv.id, null))/count(vrv.id) 20点前完成占比
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
where
    (vrv.visit_staff_id = 10001 OR ( vrv.visit_staff_id = 0 AND vrv.visit_state = 2 )) -- IVR已回访+ 等待ivr回访
    and vrv.type = 8
    and vrv.created_at >= concat('2023-08-16', ' 09:00:00')
    and vrv.created_at < concat('2023-08-16', ' 16:00:00');
;-- -. . -..- - / . -. - .-. -.--
select
    count(vrv.id) 任务量
    ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at <  date_add('2023-08-16', interval 1 day), vrv.id, null))/count(vrv.id) 今日完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 18:00:00'), vrv.id, null))/count(vrv.id) 18点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 19:00:00'), vrv.id, null))/count(vrv.id) 19点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 20:00:00'), vrv.id, null))/count(vrv.id) 20点前完成占比
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
where
    (vrv.visit_staff_id = 10001 OR ( vrv.visit_staff_id = 0 AND vrv.visit_state = 2 )) -- IVR已回访+ 等待ivr回访
    and vrv.type = 8
    and vrv.created_at >= concat('2023-08-16', ' 09:00:00')
    and vrv.created_at < concat('2023-08-16', ' 17:00:00');
;-- -. . -..- - / . -. - .-. -.--
select
    count(vrv.id) 任务量
    ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at <  date_add('2023-08-16', interval 1 day), vrv.id, null))/count(vrv.id) 今日完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 18:00:00'), vrv.id, null))/count(vrv.id) 18点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 19:00:00'), vrv.id, null))/count(vrv.id) 19点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 20:00:00'), vrv.id, null))/count(vrv.id) 20点前完成占比
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
where
    (vrv.visit_staff_id = 10001 OR ( vrv.visit_staff_id = 0 AND vrv.visit_state = 2 )) -- IVR已回访+ 等待ivr回访
    and vrv.type = 8
    and vrv.created_at >= concat('2023-08-16', ' 09:00:00')
    and vrv.created_at < concat('2023-08-16', ' 18:00:00');
;-- -. . -..- - / . -. - .-. -.--
select
    count(vrv.id) 任务量
    ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at <  date_add('2023-08-16', interval 1 day), vrv.id, null))/count(vrv.id) 今日完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 18:00:00'), vrv.id, null))/count(vrv.id) 18点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 19:00:00'), vrv.id, null))/count(vrv.id) 19点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 20:00:00'), vrv.id, null))/count(vrv.id) 20点前完成占比
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
where
    (vrv.visit_staff_id = 10001 OR ( vrv.visit_staff_id = 0 AND vrv.visit_state = 2 )) -- IVR已回访+ 等待ivr回访
    and vrv.type = 8
    and vrv.created_at >= concat('2023-08-16', ' 09:00:00')
    and vrv.created_at < concat('2023-08-16', ' 19:00:00');
;-- -. . -..- - / . -. - .-. -.--
select date_add('2023-08-16', interval 34 hour );
;-- -. . -..- - / . -. - .-. -.--
select
        pr.pno
        ,ss.name
#         ,pr.routed_at
#         ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
    from ph_staging.parcel_info pi
    left join ph_staging.parcel_route  pr on pi.pno = pr.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.sys_store ss on ss.id = pi.dst_store_id
    where
        pr.routed_at is not null
        and pi.state  = 3
#         and pr.routed_at < '2023-08-13 16:00:00'
        and pi.dst_store_id in ('PH77190100','PH73090800','PH73020100','PH77030100','PH77050A00','PH76120H00','PH74060200','PH76090C00','PH74010100','PH76040A00','PH73030300','PH76190100','PH74120A00','PH75060200','PH51050301','PH47170100','PH51050500','PH49040100','PH51030400','PH51020J00','PH47140200','PH49040102','PH47210100','PH51100100','PH47080301','PH51080100','PH49040101','PH47070A00','PH47200600','PH47120100','PH47150100','PH51080101','PH51120B01','PH45210101','PH45212600','PH50100100','PH46020100','PH45130F00','PH46050101','PH45200H00','PH44020100','PH44180100','PH46150100','PH45210100','PH45010100','PH44010T00','PH50100200','PH45140300','PH14010F00','PH14010F00','PH22130500','PH23100300')
    group by 1,2;
;-- -. . -..- - / . -. - .-. -.--
select
    count(vrv.id) 任务量
    ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at <  date_add('2023-08-16', interval 36 hour), vrv.id, null))/count(vrv.id) 次日12点完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 18:00:00'), vrv.id, null))/count(vrv.id) 18点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 19:00:00'), vrv.id, null))/count(vrv.id) 19点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 20:00:00'), vrv.id, null))/count(vrv.id) 20点前完成占比
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
where
    (vrv.visit_staff_id = 10001 OR ( vrv.visit_staff_id = 0 AND vrv.visit_state = 2 )) -- IVR已回访+ 等待ivr回访
    and vrv.type = 8
    and vrv.created_at >= concat('2023-08-16', ' 16:00:00')
    and vrv.created_at < date_add('2023-08-16', interval 34 hour);
;-- -. . -..- - / . -. - .-. -.--
select
    count(vrv.id) 任务量
    ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at <  date_add('2023-08-15', interval 36 hour), vrv.id, null))/count(vrv.id) 次日12点完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 18:00:00'), vrv.id, null))/count(vrv.id) 18点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 19:00:00'), vrv.id, null))/count(vrv.id) 19点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 20:00:00'), vrv.id, null))/count(vrv.id) 20点前完成占比
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
where
    (vrv.visit_staff_id = 10001 OR ( vrv.visit_staff_id = 0 AND vrv.visit_state = 2 )) -- IVR已回访+ 等待ivr回访
    and vrv.type = 8
    and vrv.created_at >= concat('2023-08-15', ' 16:00:00')
    and vrv.created_at < date_add('2023-08-15', interval 34 hour);
;-- -. . -..- - / . -. - .-. -.--
select
    count(vrv.id) 任务量
    ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at <  date_add('2023-08-14', interval 36 hour), vrv.id, null))/count(vrv.id) 次日12点完成占比
    ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at <  date_add('2023-08-14', interval 37 hour), vrv.id, null))/count(vrv.id) 次日13点完成占比
    ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at <  date_add('2023-08-14', interval 38 hour), vrv.id, null))/count(vrv.id) 次日14点完成占比
    ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at <  date_add('2023-08-14', interval 39 hour), vrv.id, null))/count(vrv.id) 次日15点完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 18:00:00'), vrv.id, null))/count(vrv.id) 18点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 19:00:00'), vrv.id, null))/count(vrv.id) 19点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 20:00:00'), vrv.id, null))/count(vrv.id) 20点前完成占比
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
where
    (vrv.visit_staff_id = 10001 OR ( vrv.visit_staff_id = 0 AND vrv.visit_state = 2 )) -- IVR已回访+ 等待ivr回访
    and vrv.type = 8
    and vrv.created_at >= concat('2023-08-14', ' 16:00:00')
    and vrv.created_at < date_add('2023-08-14', interval 34 hour);
;-- -. . -..- - / . -. - .-. -.--
select
    count(vrv.id) 任务量
    ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at <  date_add('2023-08-15', interval 36 hour), vrv.id, null))/count(vrv.id) 次日12点完成占比
    ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at <  date_add('2023-08-15', interval 37 hour), vrv.id, null))/count(vrv.id) 次日13点完成占比
    ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at <  date_add('2023-08-15', interval 38 hour), vrv.id, null))/count(vrv.id) 次日14点完成占比
    ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at <  date_add('2023-08-15', interval 39 hour), vrv.id, null))/count(vrv.id) 次日15点完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 18:00:00'), vrv.id, null))/count(vrv.id) 18点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 19:00:00'), vrv.id, null))/count(vrv.id) 19点前完成占比
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < concat('${date}', ' 20:00:00'), vrv.id, null))/count(vrv.id) 20点前完成占比
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
where
    (vrv.visit_staff_id = 10001 OR ( vrv.visit_staff_id = 0 AND vrv.visit_state = 2 )) -- IVR已回访+ 等待ivr回访
    and vrv.type = 8
    and vrv.created_at >= concat('2023-08-15', ' 16:00:00')
    and vrv.created_at < date_add('2023-08-15', interval 34 hour);
;-- -. . -..- - / . -. - .-. -.--
select date_format(now() ,'%y-%m-01');
;-- -. . -..- - / . -. - .-. -.--
select date_format(now() ,'%Y-%m-01');
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        plt2.pno
        ,pcol.created_at
        ,plt2.client_id
        ,plt2.parcel_created_at
        ,plt2.id
        ,group_concat(distinct ss.name) ss_name
    from ph_bi.parcel_cs_operation_log pcol
    left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
    left join ph_bi.parcel_lose_responsible plr on plr.lose_task_id = plt2.id
    left join ph_staging.sys_store ss on ss.id = plr.store_id
    where
        pcol.type = 1
        and pcol.action = 4
        and pcol.operator_id != 10001
    group by 1,2,3,4,5
)
select
    a.pno
    ,concat(kp.id ,  '_', kp.name) Customer
    ,a.parcel_created_at Pickup_Date
    ,a.created_at Close_Date
    ,a.ss_name Responsible_DC
    ,convert_tz(a.routed_at, '+00:00', '+08:00') Effective_status_Date
    ,a.store_name Effective_status_DC
    ,dp.piece_name District
    ,dp.region_name  Area
    ,case pi.state
        when 1 then 'RECEIVED'
        when 2 then 'IN_TRANSIT'
        when 3 then 'DELIVERING'
        when 4 then 'STRANDED'
        when 5 then 'SIGNED'
        when 6 then 'IN_DIFFICULTY'
        when 7 then 'RETURNED'
        when 8 then 'ABNORMAL_CLOSED'
        when 9 then 'CANCEL'
    end as parcel_tatus
from
    (
        select
            t1.*
            ,ddd.CN_element
            ,pr.routed_at
            ,pr.store_name
            ,pr.store_id
            ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno
        join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
        where
            pr.routed_at > date_sub(date_format(now() ,'%Y-%m-01'), interval 8 hour)
    ) a
left join ph_staging.ka_profile kp on kp.id = a.client_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id
left join ph_staging.parcel_info pi on pi.pno = a.pno
where
    a.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.client_id
    ,pi.pno
from ph_staging.diff_info di
left join ph_staging.parcel_info pi on pi.pno = di.pno
where
    di.diff_marker_category in (2,17)
    and di.created_at >= '2023-08-15: 16:00:00'
    and di.created_at < '2023-08-16 16:00:00';
;-- -. . -..- - / . -. - .-. -.--
select
    pi.client_id
    ,pi.pno
from ph_staging.diff_info di
left join ph_staging.parcel_info pi on pi.pno = di.pno
where
    di.diff_marker_category in (2,17)
    and di.created_at >= '2023-08-15: 16:00:00'
    and di.created_at < '2023-08-16 16:00:00'
    and pi.client_id in ('BA0260','BA0593','CA0242','CA0268','CA2469','CA3525','CA3585','CA3671');
;-- -. . -..- - / . -. - .-. -.--
select
    pi.client_id
    ,count((pi.pno) num
from ph_staging.parcel_info pi
where
    pi.created_at >= '2023-08-15: 16:00:00'
    and pi.created_at < '2023-08-16 16:00:00'
    and pi.client_id in ('BA0260','BA0593','CA0242','CA0268','CA2469','CA3525','CA3585','CA3671')
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.client_id
    ,count(pi.pno) num
from ph_staging.parcel_info pi
where
    pi.created_at >= '2023-08-15: 16:00:00'
    and pi.created_at < '2023-08-16 16:00:00'
    and pi.client_id in ('BA0260','BA0593','CA0242','CA0268','CA2469','CA3525','CA3585','CA3671')
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.client_id
    ,pi.pno
    ,date(convert_tz(di.created_at, '+00:00', '+08:00')) diff_date
from ph_staging.diff_info di
left join ph_staging.parcel_info pi on pi.pno = di.pno
where
    di.diff_marker_category in (2,17)
    and di.created_at >= '2023-07-31: 16:00:00'
#     and di.created_at < '2023-08-16 16:00:00'
    and pi.client_id in ('BA0260','BA0593','CA0242','CA0268','CA2469','CA3525','CA3585','CA3671');
;-- -. . -..- - / . -. - .-. -.--
select
    pi.client_id
    ,pi.pno
    ,date(convert_tz(di.created_at, '+00:00', '+08:00')) diff_date
from ph_staging.diff_info di
left join ph_staging.parcel_info pi on pi.pno = di.pno
where
    di.diff_marker_category in (2,17)
    and di.created_at >= '2023-07-31 16:00:00'
#     and di.created_at < '2023-08-16 16:00:00'
    and pi.client_id in ('BA0260','BA0593','CA0242','CA0268','CA2469','CA3525','CA3585','CA3671');
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        plt2.pno
        ,pcol.created_at
        ,plt2.client_id
        ,plt2.parcel_created_at
        ,plt2.id
        ,group_concat(distinct ss.name) ss_name
    from ph_bi.parcel_cs_operation_log pcol
    left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
    left join ph_bi.parcel_lose_responsible plr on plr.lose_task_id = plt2.id
    left join ph_staging.sys_store ss on ss.id = plr.store_id
    where
        pcol.type = 1
        and pcol.action = 4
        and pcol.operator_id != 10001
    group by 1,2,3,4,5
)
select
    a.Pno
    ,concat(kp.id ,  '_', kp.name) Customer
    ,a.parcel_created_at Pickup_Date
    ,a.created_at Close_Date
    ,a.ss_name Responsible_DC
    ,convert_tz(a.routed_at, '+00:00', '+08:00') Effective_status_Date
    ,a.store_name Effective_status_DC
    ,dp.piece_name District
    ,dp.region_name  Area
    ,case pi.state
        when 1 then 'RECEIVED'
        when 2 then 'IN_TRANSIT'
        when 3 then 'DELIVERING'
        when 4 then 'STRANDED'
        when 5 then 'SIGNED'
        when 6 then 'IN_DIFFICULTY'
        when 7 then 'RETURNED'
        when 8 then 'ABNORMAL_CLOSED'
        when 9 then 'CANCEL'
    end as parcel_tatus
from
    (
        select
            t1.*
            ,ddd.CN_element
            ,pr.routed_at
            ,pr.store_name
            ,pr.store_id
            ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno
        join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
        where
            pr.routed_at > date_sub(date_format(now() ,'%Y-%m-01'), interval 8 hour)
    ) a
left join ph_staging.ka_profile kp on kp.id = a.client_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id
left join ph_staging.parcel_info pi on pi.pno = a.pno
where
    a.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        plt2.pno
        ,pcol.created_at
        ,plt2.client_id
        ,plt2.parcel_created_at
        ,plt2.id
        ,group_concat(distinct ss.name) ss_name
    from ph_bi.parcel_cs_operation_log pcol
    left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
    left join ph_bi.parcel_lose_responsible plr on plr.lose_task_id = plt2.id
    left join ph_staging.sys_store ss on ss.id = plr.store_id
    where
        pcol.type = 1
        and pcol.action = 4
        and pcol.operator_id != 10001
    group by 1,2,3,4,5
)
select
    a.Pno
    ,concat(kp.id ,  '_', kp.name) Customer
    ,a.parcel_created_at Pickup_Date
    ,a.created_at Close_Date
    ,a.ss_name Responsible_DC
    ,convert_tz(a.routed_at, '+00:00', '+08:00') Effective_status_Date
    ,a.store_name Effective_status_DC
    ,a.CN_element
    ,dp.piece_name District
    ,dp.region_name  Area
    ,case pi.state
        when 1 then 'RECEIVED'
        when 2 then 'IN_TRANSIT'
        when 3 then 'DELIVERING'
        when 4 then 'STRANDED'
        when 5 then 'SIGNED'
        when 6 then 'IN_DIFFICULTY'
        when 7 then 'RETURNED'
        when 8 then 'ABNORMAL_CLOSED'
        when 9 then 'CANCEL'
    end as parcel_tatus
from
    (
        select
            t1.*
            ,ddd.CN_element
            ,pr.routed_at
            ,pr.store_name
            ,pr.store_id
            ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno
        join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
        where
            pr.routed_at > date_sub(date_format(now() ,'%Y-%m-01'), interval 8 hour)
    ) a
left join ph_staging.ka_profile kp on kp.id = a.client_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id
left join ph_staging.parcel_info pi on pi.pno = a.pno
where
    a.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        plt2.pno
        ,pcol.created_at
        ,plt2.client_id
        ,plt2.parcel_created_at
        ,plt2.id
        ,group_concat(distinct ss.name) ss_name
    from ph_bi.parcel_cs_operation_log pcol
    left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
    left join ph_bi.parcel_lose_responsible plr on plr.lose_task_id = plt2.id
    left join ph_staging.sys_store ss on ss.id = plr.store_id
    where
        pcol.type = 1
        and pcol.action = 4
        and pcol.operator_id != 10001
    group by 1,2,3,4,5
)
select
    a.Pno
    ,concat(kp.id ,  '_', kp.name) Customer
    ,a.parcel_created_at Pickup_Date
    ,a.created_at Close_Date
    ,a.ss_name Responsible_DC
    ,convert_tz(a.routed_at, '+00:00', '+08:00') Effective_status_Date
    ,a.store_name Effective_status_DC
    ,a.CN_element
    ,dp.piece_name District
    ,dp.region_name  Area
    ,case pi.state
        when 1 then 'RECEIVED'
        when 2 then 'IN_TRANSIT'
        when 3 then 'DELIVERING'
        when 4 then 'STRANDED'
        when 5 then 'SIGNED'
        when 6 then 'IN_DIFFICULTY'
        when 7 then 'RETURNED'
        when 8 then 'ABNORMAL_CLOSED'
        when 9 then 'CANCEL'
    end as parcel_tatus
from
    (
        select
            t1.*
            ,ddd.CN_element
            ,pr.routed_at
            ,pr.store_name
            ,pr.store_id
            ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno
        join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
        where
            pr.routed_at > date_sub(date_format(now() ,'%Y-%m-01'), interval 8 hour)
    ) a
left join ph_staging.ka_profile kp on kp.id = a.client_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day )
left join ph_staging.parcel_info pi on pi.pno = a.pno
where
    a.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        plt2.pno
        ,pcol.created_at
        ,plt2.client_id
        ,plt2.parcel_created_at
        ,plt2.id
        ,group_concat(distinct ss.name) ss_name
    from ph_bi.parcel_cs_operation_log pcol
    left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
    left join ph_bi.parcel_lose_responsible plr on plr.lose_task_id = plt2.id
    left join ph_staging.sys_store ss on ss.id = plr.store_id
    where
        pcol.type = 1
        and pcol.action = 4
        and pcol.operator_id != 10001
    group by 1,2,3,4,5
)
select
    a.Pno
    ,concat(kp.id ,  '_', kp.name) Customer
    ,a.parcel_created_at Pickup_Date
    ,a.created_at Close_Date
    ,a.ss_name Responsible_DC
    ,convert_tz(a.routed_at, '+00:00', '+08:00') Effective_status_Date
    ,a.store_name Effective_status_DC
    ,a.CN_element
    ,dp.piece_name District
    ,dp.region_name  Area
    ,case pi.state
        when 1 then 'RECEIVED'
        when 2 then 'IN_TRANSIT'
        when 3 then 'DELIVERING'
        when 4 then 'STRANDED'
        when 5 then 'SIGNED'
        when 6 then 'IN_DIFFICULTY'
        when 7 then 'RETURNED'
        when 8 then 'ABNORMAL_CLOSED'
        when 9 then 'CANCEL'
    end as parcel_tatus
from
    (
        select
            t1.*
            ,ddd.CN_element
            ,pr.routed_at
            ,pr.store_name
            ,pr.store_id
            ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno
        join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
        where
            pr.routed_at > date_sub(date_format(now() ,'%Y-%m-01'), interval 8 hour)
            and pr.routed_at > date_sub(t1.created_at, interval 8 hour )
    ) a
left join ph_staging.ka_profile kp on kp.id = a.client_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day )
left join ph_staging.parcel_info pi on pi.pno = a.pno
where
    a.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
    ,pi.dst_phone
from ph_staging.parcel_info pi
where
    pi.pno in ('P28161ZS9Z7AO','P322120DG6KAZ','P44021ZM41EAU','P361320DG97AM','P490420DG6SAO','P440220DG8PAE','P490520DG9DAV','P44021ZZ78YAQ','P76191ZZ797CB','P1904211JKYAN','P352621Q7FHAS','P344620UH5CBP','P355020CTVKAQ','P61162226QHAC','P470421CJVNAZ','P4521216KXVDA','P530321CJVTAZ','P352621CJTEAM','P730321CJX9BD','P760421CJX4AE','P650521WBXPAM','P130721PNGPAN','P612021W2FAAB','P130321WRP8CI','P131121P6M6CA','P044721DMZ0AU','P122321PNKBAO','P060521NP7ABA','P130321PNF3CK','P062321WR7PAG','P3007212BFYBE','P81151Z8MGKAB','P122321Q2WGAF','P140621Q2WRAY','P241721DXGHBF','P612021Q2MWBQ','P403120EFQBAC','P182121Q2P3AH','P210221Q2WAAE','P830120P73DAH','P590520TA3ZZZ','P530220TA5QDB','P140120TA4YZZ','P440220TA35AM','P530220TA4EBF','P301420TA5NAR','P403020TA36DT','P403920TA4MEL','P330120TA41BY','P122020TA3SAJ','P072221XHB4AH','P404021H9GYBT','P070821XHA0BO','P430721JU29BN','P140421H9KAAE','P590221BMYVAH','P612022318CBB','P590521084AAL','P570521BN5MAA','P470721BMZUAL','P353020106WAI','P2206200U96AV','P6503201022AB','P12151Z7WSAAB','P18141YT0Q3AS','P36211YEWHNAP','P17281Z85MGAM','P61011Z84ZYAZ','P81161XUPFDCE','P81161XUPNJAB','P81161XUPPWBV','P81161XUPMGCB','P81161XFZCACL','P81181XUPGHZZ','P81161XFZHZCL','P81011XUPCXAL','P45201Y5PKYAS','P49041XUPDXAT','P26171ZFRZVAI','P53021ZFS1AGP','P35171ZFS2PBK','P61181ZFS35CP','P47121ZFS1SAR','P49041ZN8QWAT','P14161ZN8QYAD','P45211ZFS0MCN','P64021ZFS33BI','P35261ZFS2GAL','P81181YQCZ4BB','P29111ZRW9UAT','P81161YC2EXCB','P50121ZJVWFAX','P81161YC288CN','P81151YHV4TAN','P74061ZRWDWAO','P51141Z58VQAH','P47171ZCVWMAA','P73081ZCVUUAA','P81161YJN8UBS','P81161YEGGQBS','P81151XH2C2AN','P14051YJNHBAU','P01121YJNA8CL','P81161YEGQ1CB','P44021Y6Q5WAD','P60111YJNDQAI','P44011Y6Q66BR','P40301YJNFRDP','P420320C83UBN','P2112217AR9AP','P341420C83SAT','P6402217ANVAN','P192820K50VAB','P0122217AP2AD','P1504217ASDAT','P1710217AQGAO','P35191ZXB4SAC','P1803217ANBZZ','P2102217ASFAH','P81161XU8GUBG','P81161XU8B8BU','P81161XU8AQBT','P40171Z45J1AF','P81061XU8HHAO','P81161XU8E9BU','P60111Z45J7AA','P80051Z45J5AS','P61181Z45JFCU','P61271Z45JVAG','P612721BNAXAG','P120821BNAWAN','P51051ZXB13CK','P35171ZJB8EBD','P4605202BWUAF','P4605202BWUAF','P33011ZR6Y5CF','P35241ZJB81AR','P5709202BWCBM','P4013202BX1BQ','P81161YHMNUBS','P81161XZ18ABT','P16071Y6HV3AH','P81051Y6HWSAM','P81051XZ14TAM','P81161XZ172AY','P81161XYZW2BS','P81161Y6HSMZZ','P81051XZ0TSAM','P81151XZ0PGAN','P81161XZ14BCM','P4715209Q75AN','P6502213D3HAD','P1731219BMYBL','P180820QBQ5AY','P5707200SBZAZ','P33011YT5EWCC','P33011YT5EWCC','P06291Z3BZ3BG');
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
    ,pi.dst_store_id
    ,ss.name 
from ph_staging.parcel_info pi
left join ph_staging.sys_store ss on ss.id = pi.dst_store_id
where
    pi.pno in ('P180621SHNHCG','P612721SGH0I','P171421SJZVAL','P612521SJWRAX','P611721SHNBA','P192821SHNAO','P613021SGHVAB','P613021SHN6AT','P190421SHMVAO','P180621SJZFCG','P19281SHNPAO','P612721SVQFAI','P180821SGWRAK','P192221SJXBA','P173121SJZKH','P612521SJWSAX','P612421STDXAA','P800421SHNTA','P612421SGX0AL','P180421SGJ3AE','P612721SHMSAI','P190521SGHXA','P190421SHMHAO','P170821SHM6AC','P180421SHNFAE','P171421SJZSAL','P192521S6H3AI','P180421S4XHAE','P192521S9QYAI','P180421SCT9AE','P61721S6WBA','P211321SRAQAD','P192821SRB3AE','P170521SRAZBT','P611721S66JAO','P612521SAFVAX','P611721S66WAA','P211321S66PAD','P612421S7CEAA','P211321SBYHAD','P611721SSQQBD','P1806223QU1C','P201821SJXMAY','P612521SF5PAX','P612721SJYCAI','P612721STDTAD','P611521SF69AM','P1905222PP7AZ','P1731223M91AH','P612721STE9AD','P1905222PP1AZ','P611521SF6AAM','P612721SJWZAD','P180921SSGBBW','P180921SSGCBW','P1809222QQ3BW','P6125223QUVAX','P611721SF5CAA','P180421SVQJAE','P180921SSNRBX','P612721SSQRAD','P180421SVQHAE','P612721SSQCAI','P180421SFTRAE','P173121SJYYAH','P170521SGH8BT','P180421SF7ZAE','P171421SSPYAL','P201821SJXNAY','P171421SSPXAL','P170521SF58BT','P612721SVQGAI','P173121SJYXAH','P612421SF6UAL','P612721SGGUAD','P180921SSGABW','P1806222QPSCG','P612721SJYDAI','P6127223M9RAD','P170521SGX1BT','P6127223QV4AD','P613021SF6GAB','P1804222QPFAE','P1804222NV2AE','P1904222NUTAB','P612721STE1A','P612421TG1TAL','P612421SGHKAL','P6115223QU7AM','P171421SSQ5AL','P1806222NUQCG','P180921SSG9BW','P211321SJWDAD','P611721SFTNAO','P612421TG1SAL','P611721SF6CAO');
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.CT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-08-17'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.CT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-08-17'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-08-17', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with d as
    (
        select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-08-17'
    )
    , t as
    (
        select
             ds.store_id
            ,ds.pno
            ,ds.stat_date
        from d ds
        left join
            (
                select
                    pr.pno
                    ,ds.stat_date
                    ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
                from ph_staging.parcel_route pr
                join d ds on pr.pno = ds.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                    and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and pr.marker_category in (42,43) ##岛屿,偏远地区
                group by 1,2
            ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
        left join
            (
                select
                   pr.pno
                    ,ds.stat_date
                   ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
                   ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
                from ph_staging.parcel_route pr
                join d ds on ds.pno = pr.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                    and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                    and pr.marker_category in (9,14,70) ##客户改约时间
            ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
        left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
        where
            case
                when pr1.pno is not null then 'N'
                when pr2.pno is not null then 'N'
                when ds1.pno is not null  then 'N'  else 'Y'
            end = 'Y'
    )
    select
        a.stat_date 日期
        ,a.store_id 网点ID
        ,dp.store_name 网点名称
        ,dp.opening_at 开业时间
        ,case
            when dp.region_name in ('Area3', 'Area6') then '彭万松'
            when dp.region_name in ('Area4', 'Area9') then '韩钥'
            when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
            when dp.region_name in ( 'Area8') then '黄勇'
            when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
        end 区域
        ,dp.region_name 大区
        ,dp.piece_name 片区
        ,a.应交接
        ,a.已交接
        ,concat(round(a.交接率*100,2),'%') as 交接率
        ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
        ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
        ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
        ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
        ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
    from
        (
            select
                t1.store_id
                ,t1.stat_date
                ,count(t1.pno) 应交接
                ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
            from t t1
            left join
                (
                    select
                        sc.*
                    from
                        (
                            select
                                pr.pno
                                ,pr.store_id
                                ,pr.store_name
                                ,t1.stat_date
                                ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                            from ph_staging.parcel_route pr
                            join t t1 on t1.pno = pr.pno
                            where
                                pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                               and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                              and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                        ) sc
                    where
                        sc.rk = 1
                ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
            group by 1,2
        ) a
    join
        (
            select
                sd.store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.store_id is not null
            group by 1

            union all

            select
                sd.separation_store_id store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.separation_store_id is not null
            group by 1
        ) sd on sd.store_id = a.store_id
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    where
        dp.store_category in (1,10);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-08-17'
        and pr.routed_at >= date_sub('2023-08-17', interval 8 hour )
        and pr.routed_at < date_add('2023-08-17', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end 评级
        ,a2.code_num
        ,a2.staff_code_num
        ,a2.staff_num
        ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-17'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-08-17')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-08-17'
        and pi.finished_at >= date_sub('2023-08-17', interval 8 hour )
        and pi.finished_at < date_add('2023-08-17', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-08-17'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
select
    case
        when vrv.created_at < '2023-08-01' then '0701-0731'
        when vrv.created_at >= '2023-8-01' then '0801-0817'
    end period
    ,sum(vrv.visit_num) 回访总数
    ,count(if(vrv.visit_result = 43, vrv.id, null)) 多次尝试派送失败回访继续派送量
    ,count(if(json_extract(vrv.extra_value, '$.rejection_delivery_again') = 2, vrv.id, null)) 收件人拒收回访继续派送量
from nl_production.violation_return_visit vrv
join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id and bc.client_name = 'tiktok'
where
    vrv.visit_num > 0
    and vrv.type in (3,8)
    and vrv.created_at >= '2023-07-01'
    and vrv.created_at < '2023-08-18'
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    case
        when vrv.created_at < '2023-08-01' then '0701-0731'
        when vrv.created_at >= '2023-8-01' then '0801-0817'
    end period
    ,sum(vrv.visit_num) 回访总数
    ,count(if(vrv.visit_result = 43, vrv.id, null)) 多次尝试派送失败回访继续派送量
    ,count(if(vrv.visit_result = 43 and pi.state = 5, vrv.id, null)) 多次尝试派送失败回访继续派送妥投量
    ,count(if(json_extract(vrv.extra_value, '$.rejection_delivery_again') = 2, vrv.id, null)) 收件人拒收回访继续派送量
    ,count(if(json_extract(vrv.extra_value, '$.rejection_delivery_again') = 2 and pi.state = 5, vrv.id, null)) 收件人拒收回访继续派送妥投量
from nl_production.violation_return_visit vrv
join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id and bc.client_name = 'tiktok'
left join ph_staging.parcel_info pi on pi.pno = vrv.link_id
where
    vrv.visit_num > 0
    and vrv.type in (3,8)
    and vrv.created_at >= '2023-07-01'
    and vrv.created_at < '2023-08-18'
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    min(vrv.created_at)
from nl_production.violation_return_visit vrv
join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id and bc.client_name = 'tiktok'
where
    vrv.visit_num > 0
    and vrv.type in (3,8)
    and vrv.created_at >= '2023-07-01'
    and vrv.created_at < '2023-08-18'
    and json_extract(vrv.extra_value, '$.rejection_delivery_again') = 2;
;-- -. . -..- - / . -. - .-. -.--
select
    min(vrv.created_at)
from nl_production.violation_return_visit vrv
join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id and bc.client_name = 'tiktok'
where
    vrv.visit_num > 0
    and vrv.type in (3,8)
    and vrv.created_at >= '2023-07-01'
    and vrv.created_at < '2023-08-18'
    and vrv.visit_result = 43;
;-- -. . -..- - / . -. - .-. -.--
select
    case
        when vrv.created_at < '2023-08-01' then '0701-0731'
        when vrv.created_at >= '2023-8-01' then '0801-0817'
    end period
    ,case
        when vrv.type = 3 then '收件人拒收回访'
        when vrv.type = 8 then '多次尝试派送失败回访'
    end 回访类型
    ,sum(vrv.visit_num) 回访总数
    ,count(if(vrv.visit_result = 43, vrv.id, null)) 多次尝试派送失败回访继续派送量
    ,count(if(vrv.visit_result = 43 and pi.state = 5, vrv.id, null)) 多次尝试派送失败回访继续派送妥投量
    ,count(if(json_extract(vrv.extra_value, '$.rejection_delivery_again') = 2, vrv.id, null)) 收件人拒收回访继续派送量
    ,count(if(json_extract(vrv.extra_value, '$.rejection_delivery_again') = 2 and pi.state = 5, vrv.id, null)) 收件人拒收回访继续派送妥投量
from nl_production.violation_return_visit vrv
join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id and bc.client_name = 'tiktok'
left join ph_staging.parcel_info pi on pi.pno = vrv.link_id
where
    vrv.visit_num > 0
    and vrv.type in (3,8)
    and vrv.created_at >= '2023-07-01'
    and vrv.created_at < '2023-08-18'
group by 1,2;
;-- -. . -..- - / . -. - .-. -.--
select
    pr.pno
    ,ss.name
#         ,pr.routed_at
#         ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
from ph_staging.parcel_info pi
left join ph_staging.parcel_route  pr on pi.pno = pr.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
left join ph_staging.sys_store ss on ss.id = pi.dst_store_id
where
    pr.routed_at is not null
    and pi.state  = 3
#         and pr.routed_at < '2023-08-13 16:00:00'
    and pi.dst_store_id in ('PH77190100','PH73090800','PH73020100','PH77030100','PH77050A00','PH76120H00','PH74060200','PH76090C00','PH74010100','PH76040A00','PH73030300','PH76190100','PH74120A00','PH75060200','PH51050301','PH47170100','PH51050500','PH49040100','PH51030400','PH51020J00','PH47140200','PH49040102','PH47210100','PH51100100','PH47080301','PH51080100','PH49040101','PH47070A00','PH47200600','PH47120100','PH47150100','PH51080101','PH51120B01','PH45210101','PH45212600','PH50100100','PH46020100','PH45130F00','PH46050101','PH45200H00','PH44020100','PH44180100','PH46150100','PH45210100','PH45010100','PH44010T00','PH50100200','PH45140300','PH14010F00','PH14010F00','PH22130500','PH23100300')
group by 1,2;
;-- -. . -..- - / . -. - .-. -.--
select t1.delivery_dt
    ,t2.region_name
    ,t2.piece_name
    ,t2.store_id
    ,t2.store_name
    ,t2.DC_type
    ,t2.tiktok_area
    ,t2.lazada_area
    ,t2.shopee_area
    ,t2.province_code
    ,t2.province_name
    ,t2.city_code
    ,t2.city_name
    ,t2.barangay_code
    ,t2.barangay_name
    ,t2.delivery_code
    ,count(distinct if(t1.staff_info_id = t2.staff_info_id,t2.pno,null)) delivery_pnos_correct
    ,count(distinct if(t1.staff_info_id <> t2.staff_info_id,t2.pno,null)) delivery_pnos_wrong
    ,count(distinct if(t1.staff_info_id is null,t2.pno,null)) delivery_pnos_none

from (
##包裹实际交接情况
select td.pno
    ,date(convert_tz(td.delivery_at,'+00:00','+08:00')) as delivery_dt
    ,mr.name region_name
    ,mp.name piece_name
    ,dsdt.dst_store_id store_id
    ,ssd.name store_name
    ,case when ssd.category = '1' then 'SP' when ssd.category = '10' then 'BDC' end DC_type
    ,tiktok_area.area_name tiktok_area
    ,lazada_area.area_name lazada_area
    ,case shopee_area.area_id when 1 then 'MM'  when 2 then 'GMA '  when 3 then 'Luz 1'  when 4 then 'Luz 2'  when 5 then 'Luz 3' when 6 then 'Vis 1'  when 7 then 'Vis 2'  when 8 then 'Min 1'  when 9 then 'Min 2'  when 10 then 'Luz 4' end as shopee_area
    ,hsi.name staff_name
    ,td.staff_info_id staff_info_id
    ,sd.province_code as province_code
    ,sp.name as province_name
    ,sd.city_code as city_code
    ,sc.name as city_name
    ,sd.code barangay_code
    ,sd.name barangay_name
    ,if(hsi.job_title = 13,'BIKE',if(hsi.job_title = 110,'VAN',if(hsi.job_title = 452,'BOAT',if(hsi.job_title = 1000,'Tricycle','other')))) job_title
    ,ddpsci.third_sorting_code as delivery_code
    ##,sdmzc.当日在仓
    ##,count(distinct td.pno) delivery_pnos
    ##,nth_value(count(distinct td.pno),2) over(partition by ssd.name,td.staff_info_id order by count(distinct td.pno) desc) 第二区域交接数

from ph_staging.ticket_delivery td

##left join ph_staging.parcel_info pi
##on pi.pno = td.pno

join dwm.dwd_ph_non_end_pno_detl_d dsdt##在仓表
on td.pno = dsdt.pno

left join ph_staging.parcel_info pi
on pi.pno = dsdt.pno

left join ph_staging.sys_district sd ##brgy的码
on pi.dst_district_code = sd.code

left join ph_bi.sys_city sc
on sc.code = sd.city_code

left join ph_bi.sys_province sp
on sp.code = sd.province_code

left join
(
    select
        ddpsci.pno
        ,ddpsci.dst_store_id
        ,ddpsci.dst_province_code
        ,ddpsci.dst_city_code
        ,ddpsci.dst_district_code
        ,ddpsci.third_sorting_code
        ,row_number() over(partition by ddpsci.pno order by ddpsci.created_at desc) rk
    from ph_drds.parcel_sorting_code_info ddpsci
    where 1=1
        and ddpsci.created_at >= date_sub(current_date(),91)
) ddpsci
on dsdt.pno = ddpsci.pno and ddpsci.rk = 1


left join ph_staging.sys_store ssd
on dsdt.dst_store_id = ssd.id

left join dwm.dwd_ph_dict_lazada_period_rules lazada_area
on ssd.province_code = lazada_area.province_code

left join ph_staging.shopee_period_limitation_rules_area shopee_area
on ssd.province_code = shopee_area.province_code

left join
(
    select distinct
        tiktok_area.dst_province_code province_code
        ,case tiktok_area.dst_area_code
            when 'MM' then 'MM'
            when 'GMA' then 'GMA'
            when 'LUZON 1' then 'Luz 1'
            when 'LUZON 2' then 'Luz 2'
            when 'LUZON 3' then 'Luz 3'
            when 'LUZON 4' then 'Luz 4'
            when 'MINDANAO 1' then 'Min 1'
            when 'MINDANAO 2' then 'Min 2'
            when 'VISAYAS 1' then 'Vis 1'
            when 'VISAYAS 2' then 'Vis 2'
        end area_name
    from dwm.dwd_ph_dict_tiktok_period_rules tiktok_area
) tiktok_area
on ssd.province_code = tiktok_area.province_code

LEFT JOIN ph_staging.sys_manage_region mr
ON ssd.manage_region = mr.id

LEFT JOIN ph_staging.sys_manage_piece mp
ON ssd.manage_piece = mp.id

left join ph_bi.hr_staff_info hsi
on td.staff_info_id = hsi.staff_info_id

left join
(#网点各三段码在仓、已交接、积压
    SELECT
        dsdt.stat_date
        ,ssd.id `store_id`
        ,ssd.name `网点名称`
        ,ddpsci.third_sorting_code `区域编码`

        ,count(dsdt.pno) '当日在仓'
        ,count(case when dsdt.is_handover = 1 then dsdt.pno else null end)  `已交接量`
        ,count(case when dsdt.state not in ('已签收','疑难件','已退件','异常关闭') then dsdt.pno else null end) `积压件量`

    FROM dwm.dwd_ph_non_end_pno_detl_d dsdt

    left join ph_staging.parcel_info pi
    on dsdt.pno = pi.pno

    left join
    (
        select
            ddpsci.pno
            ,ddpsci.third_sorting_code
            ,row_number() over(partition by ddpsci.pno order by ddpsci.created_at desc) rk
        from ph_drds.parcel_sorting_code_info ddpsci
        where 1=1
            and ddpsci.created_at >= date_sub(current_date(),91)
    ) ddpsci
    on pi.pno = ddpsci.pno
    and ddpsci.rk = 1

    left join ph_staging.sys_store ssd
    on dsdt.dst_store_id = ssd.id

    where 1=1
        and dsdt.stat_date = date_sub(current_date(),0)
        and dsdt.stat_date >='2023-08-17'
        and dsdt.stat_date <='2023-08-17'
        and ssd.category in ('1','10')##SP网点
    GROUP BY 1,2,3,4
    order by 1,2,3,4
)sdmzc
on sdmzc.网点名称 = ssd.name and sdmzc.区域编码 = ddpsci.third_sorting_code

where 1=1
    ##and td.created_at >= convert_tz(date_sub(curdate(),0),'+08:00','+00:00')  为什么用created_at？？
    and date(convert_tz(td.created_at,'+00:00','+08:00')) >='2023-08-17'
    and date(convert_tz(td.created_at,'+00:00','+08:00')) <='2023-08-17'
    and td.state <> 3
group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20

)t1

right join
(
# 包裹理论交接情况，快递员绑定情况
select td.pno
    ,sdbsi.store_id store_id
    ,ss.name store_name
    ,mr.name region_name
    ,mp.name piece_name
    ,tiktok_area.area_name tiktok_area
    ,lazada_area.area_name lazada_area
    ,case shopee_area.area_id when 1 then 'MM'  when 2 then 'GMA '  when 3 then 'Luz 1'  when 4 then 'Luz 2'  when 5 then 'Luz 3' when 6 then 'Vis 1'  when 7 then 'Vis 2'  when 8 then 'Min 1'  when 9 then 'Min 2'  when 10 then 'Luz 4' end as shopee_area
    ,case when ss.category = '1' then 'SP' when ss.category = '10' then 'BDC' end DC_type
    ,sd.province_code as province_code
    ,sp.name as province_name
    ,sd.city_code as city_code
    ,sc.name as city_name
    ,sd.code barangay_code
    ,sd.name barangay_name
    ,sdbsi.delivery_code delivery_code
    ,sdbsi.staff_info_id as staff_info_id
    ##,count(distinct t.delivery_code) 三段码绑定数量
    ##,group_concat(distinct t.delivery_code SEPARATOR ' / ') 三段码绑定情况
    ##,count(distinct t.district_code) barangay绑定数量
    ##,group_concat(concat(t.delivery_code,':',t.barangay_name) order by t.delivery_code SEPARATOR ' / ') 绑定明细情况

    from ph_staging.ticket_delivery td

    left join ph_staging.parcel_info pi
    on pi.pno = td.pno

    left join ph_staging.store_delivery_barangay_staff_info sdbsi
    on pi.dst_store_id = sdbsi.store_id

    left join ph_staging.sys_district sd
    on sdbsi.district_code  = sd.code

    left join ph_bi.sys_city sc
    on sc.code = sd.city_code

    left join ph_bi.sys_province sp
    on sp.code = sd.province_code

    left join ph_staging.sys_store ss
    on sdbsi.store_id  = ss.id

    LEFT JOIN ph_staging.sys_manage_region mr
    ON ss.manage_region = mr.id

    LEFT JOIN ph_staging.sys_manage_piece mp
    ON ss.manage_piece = mp.id

    left join dwm.dwd_ph_dict_lazada_period_rules lazada_area
    on ss.province_code = lazada_area.province_code

    left join ph_staging.shopee_period_limitation_rules_area shopee_area
    on ss.province_code = shopee_area.province_code

    left join

    (
        select distinct
        tiktok_area.dst_province_code province_code
        ,case tiktok_area.dst_area_code
        when 'MM' then 'MM'
        when 'GMA' then 'GMA'
        when 'LUZON 1' then 'Luz 1'
        when 'LUZON 2' then 'Luz 2'
        when 'LUZON 3' then 'Luz 3'
        when 'LUZON 4' then 'Luz 4'
        when 'MINDANAO 1' then 'Min 1'
        when 'MINDANAO 2' then 'Min 2'
        when 'VISAYAS 1' then 'Vis 1'
        when 'VISAYAS 2' then 'Vis 2'
        end area_name
        from dwm.dwd_ph_dict_tiktok_period_rules tiktok_area
    ) tiktok_area
    on ss.province_code = tiktok_area.province_code

where 1=1
    and date(convert_tz(td.created_at,'+00:00','+08:00')) >='2023-08-17'
    and date(convert_tz(td.created_at,'+00:00','+08:00')) <='2023-08-17'
    and td.state <> 3
    and sdbsi.deleted = 0 # 非剔除记录
    and ss.category  = 1 # SP网点
group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17

)t2

on t1.store_id = t2.store_id
and t1.store_name = t2.store_name
and t1.delivery_code = t2.delivery_code
and t1.province_code = t2.province_code
and t1.province_name = t2.province_name
and t1.city_code = t2.city_code
and t1.city_name = t2.city_name
and t1.barangay_code = t2.barangay_code
and t1.barangay_name = t2.barangay_name

group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16;
;-- -. . -..- - / . -. - .-. -.--
SELECT
*
,COUNT(tt.staff_info_id) over (PARTITION by tt.当日所属网点,tt.stat_date) 网点当日派件人数
,ROW_NUMBER() OVER (PARTITION by tt.当日所属网点,tt.stat_date order by tt.当天派件数 desc) 人效排名
from
(
    SELECT
    ##IFNULL(swa.attendance_date,DATE(convert_tz(NOW(),'+08:00','+08:00'))) 统计日期
    swa.stat_date
    ,hsi.staff_info_id
    ,swa.state_desc 状态描述
    ,case when swa.wait_leave_state in ('0') then '非待离职'
        when swa.wait_leave_state in ('1') then '待离职'
    else swa.wait_leave_state end as 是否待离职
    ,swa.attendance_hour       工作时长
    ,ROUND(time_to_sec(timediff(swa.shift_start,date_format(swa.attendance_started_at,"%H:%i:%s"))) /60,2) 迟到时长
    ,case when swa.is_plan_rest = 1 then '排休无需打卡'
        when  swa.is_plan_rest = 0 and swa.attendance_started_at is null then '无上班打卡时间'
        when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 59 then '未迟到'
        when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 359 then '迟到5min内'
        when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 659 then '迟到5-10min'
        when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 959 then '迟到10-15min'
        when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 1259 then '迟到15-20min'
        when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 1559 then '迟到20-25min'
        when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 1859 then '迟到25-30min'
    else '迟到30min以上' end as 迟到情况
    ,case when swa.is_outsource = 1 then '是' else '否' end as 是否外协
    ,case when swa.is_plan_rest = 1 then '是' else '否' end as 是否排休
    ,swa.hire_days 在职天数
    ,swa.job_title_desc 岗位描述
    ,hsi.mobile 员工手机号
    ,DATEDIFF(swa.stat_date,hsi.hire_date) 工龄
    ,swa.store_id as           归属网点ID
    ,swa.store_name as         归属网点名称
    ,swa.store_category_desc as网点类型描述
    ,swa.region_name as        归属大区
    ,swa.piece_name as          归属片区
    ,swa.formal as             员工的属性
    ,CASE
        WHEN hsi.job_title = 13  THEN 'Bike'
        WHEN hsi.job_title = 110 THEN 'VAN'
        WHEN hsi.job_title = 452 THEN 'Boat'
        WHEN hsi.job_title = 1000 THEN 'Tricycle'
        WHEN hsi.job_title = 37  THEN '仓管'
        WHEN hsi.job_title = 16  THEN '主管'
    END AS 当日岗位
    ,ss.name 当日所属网点
    ,CASE
        WHEN ss.category = 1  THEN 'SP'
        WHEN ss.category = 10 THEN 'BDC'
        WHEN ss.category = 14  THEN 'PDC'
    END 网点类型
    ,smr.name 大区
    ,smp.name 片区
    ,CASE WHEN hsi.formal = 0 THEN '外协员工'
          when hsi.sys_store_id = ss.id then '自有员工'
          when hsi.sys_store_id <> ss.id THEN '支援员工'
          END AS 员工属性

    ,lanshou.揽件量
    ,jiaojie.交接量
    ,tuotou.当天派件数
    ,pp.拒收包裹数
    ,pp.运力不足包裹数
    ,pp.改约包裹数
    ,pp.客户不在家_电话无人接听包裹数
    ,pp.收件人号码空号包裹数
    ,pp.收件人号码错误包裹数
    ,pp.收件人地址不清晰或不正确包裹数
    ,pp.货物丢失包裹数
    ,pp.货物短少包裹数
    ,pp.货物破损包裹数
    ,pp.外包装破损包裹数

    ,IF(tuotou.当天派件数=1,TIMESTAMPDIFF(MINUTE,tuotou.finished_min,tuotou.finished_max),ROUND(TIMESTAMPDIFF(MINUTE,tuotou.finished_min,tuotou.finished_max) / (tuotou.当天派件数-1),2)) '派件间隔(分钟)'
    ,ROUND(tuotou.当天派件数 / jiaojie.交接量,2) '派件/交接'
    ,tuotou.'5KG以上'
    ,tuotou.tuotou_num_50 as '网点50米内派件量'
    ,jiaojie.delivery_min 最早交接时间
    ,jiaojie.delivery_max 最晚交接时间
    ,ROUND(TIMESTAMPDIFF(MINUTE,jiaojie.delivery_min,jiaojie.delivery_max)/60,2) '交接工作时间'
    ,tuotou.finished_min  最早派件时间
    ,tuotou.finished_max  最近派件时间
    ,ROUND(TIMESTAMPDIFF(MINUTE,tuotou.finished_min,tuotou.finished_max)/60,2) '派件工作时间'
    ,lanshou.created_min  最早揽件时间
    ,lanshou.created_max  最近揽件时间
    ,ROUND(TIMESTAMPDIFF(MINUTE,lanshou.created_min,lanshou.created_max)/60,2) '揽件工作时间'


    FROM ph_bi.hr_staff_info hsi

    ##left join ph_backyard.staff_work_attendance swa
    ##on swa.staff_info_id=hsi.staff_info_id
    ##and swa.attendance_date = date(convert_tz(now(),'+08:00','+08:00'))


    left join dwm.dws_ph_staff_wide_s swa
    on swa.staff_info_id=hsi.staff_info_id

    left join ph_staging.sys_store ss
    on ss.category in (1,10)
    ##on swa.started_store_id = ss.id

    left join ph_staging.sys_manage_piece smp
    on smp.id=ss.manage_piece

    left join ph_staging.sys_manage_region smr
    on smr.id=ss.manage_region

    left join
    (
        select
            pi.dst_store_id ##目的地网点
            ,td2.staff_info_id
            ,date(convert_tz(td2.created_at,'+00:00','+08:00')) as created_dt
            ,COUNT(DISTINCT td2.pno) '交接量'
            ##,MIN(DATE_FORMAT(convert_tz(td2.created_at,'+00:00','+08:00'),'%T')) AS delivery_min ##最早交接时间
            ##,MAX(DATE_FORMAT(convert_tz(td2.created_at,'+00:00','+08:00'),'%T')) AS delivery_max ##最近交接时间
            ,MIN(convert_tz(td2.created_at,'+00:00','+08:00')) AS delivery_min ##最早交接时间
            ,MAX(convert_tz(td2.created_at,'+00:00','+08:00')) AS delivery_max ##最近交接时间

        ##FROM tmpale.parcel_in_warehouse_today dsdt
        ##JOIN  ph_staging.ticket_delivery td2
        from ph_staging.ticket_delivery td2
        left join ph_staging.parcel_info pi
        ON pi.pno = td2.pno
        WHERE 1=1
            and date(convert_tz(td2.created_at,'+00:00','+08:00')) >='2023-08-21'
            and date(convert_tz(td2.created_at,'+00:00','+08:00')) <='2023-08-21'
            ##td2.delivery_at >= convert_tz(DATE(convert_tz(NOW(),'+08:00','+08:00')),'+08:00','+00:00')
            ##AND td2.created_at < convert_tz(DATE_ADD(DATE(convert_tz(NOW(),'+08:00','+08:00')),INTERVAL 1 DAY),'+08:00','+00:00')
            AND td2.state <> 3 # stata=3(已关闭)
        GROUP BY 1,2,3
    ) jiaojie # 交接量
    ON jiaojie.staff_info_id = hsi.staff_info_id and jiaojie.dst_store_id =  ss.id and swa.stat_date = jiaojie.created_dt

    LEFT JOIN
    (
        SELECT
            pi.dst_store_id
            ,pi.ticket_delivery_staff_info_id
            ,date(convert_tz(pi.finished_at,'+00:00','+08:00')) as finished_dt
            ,MIN((convert_tz(pi.finished_at,'+00:00','+08:00')))  AS finished_min ##派件开始时间
            ,MAX((convert_tz(pi.finished_at,'+00:00','+08:00')))  AS finished_max ##派件结束时间
            ,COUNT(DISTINCT if(ROUND(st_distance_sphere(point(pi.ticket_delivery_staff_lng,pi.ticket_delivery_staff_lat), point(ss.lng,ss.lat)),0) < 50,pi.pno,null))  as tuotou_num_50
            ,IFNULL(COUNT(DISTINCT pi.pno),0) '当天派件数'
            ,COUNT(DISTINCT CASE WHEN (pi.exhibition_length + pi.exhibition_width + pi.exhibition_height > 80 OR pi.exhibition_weight > 5000) THEN pi.pno ELSE NULL END)'5KG以上'
            ##,CASE WHEN ROUND(st_distance_sphere(point(pi.ticket_delivery_staff_lng,pi.ticket_delivery_staff_lat), point(ss.lng,ss.lat)),0) >= 50 THEN MIN((convert_tz(pi.finished_at,'+00:00','+08:00'))) END AS 派件开始时间
            ##,CASE WHEN ROUND(st_distance_sphere(point(pi.ticket_delivery_staff_lng,pi.ticket_delivery_staff_lat), point(ss.lng,ss.lat)),0) >= 50 THEN MAX((convert_tz(pi.finished_at,'+00:00','+08:00'))) END AS 派件结束时间

        ##FROM tmpale.parcel_in_warehouse_today dsdt  ##在仓表

        from ph_staging.parcel_info pi
        ##ON dsdt.pno = pi.pno

        LEFT JOIN ph_staging.sys_store ss
        on ss.id = pi.dst_store_id

        WHERE  1=1
            ##and dsdt.stat_date = date(convert_tz(now(),'+08:00','+08:00'))
            ##and date(dsdt.stat_date) >='${sdate}'
            ##and date(dsdt.stat_date) <='${edate}'
            and date(convert_tz(pi.finished_at,'+00:00','+08:00')) >='2023-08-21'
            and date(convert_tz(pi.finished_at,'+00:00','+08:00')) <='2023-08-21'
            and pi.state in ('5')
        GROUP BY 1,2,3
    )tuotou # 妥投
    ON tuotou.ticket_delivery_staff_info_id = hsi.staff_info_id and tuotou.dst_store_id = ss.id and swa.stat_date = tuotou.finished_dt

    LEFT JOIN
    (
        SELECT
            pi.ticket_pickup_store_id
            ,pi.ticket_pickup_staff_info_id
            ,date(convert_tz(pi.created_at,'+00:00','+08:00')) as created_at
            ,COUNT(DISTINCT(pi.pno))  '揽件量'
            ,MIN((convert_tz(pi.created_at,'+00:00','+08:00'))) AS created_min ##揽件开始时间
            ,MAX((convert_tz(pi.created_at,'+00:00','+08:00'))) AS created_max ##揽件结束时间

        FROM ph_staging.parcel_info pi

        WHERE 1=1
            and pi.state <> 9
            and pi.returned = 0
            ##and pi.created_at >= convert_tz(DATE(convert_tz(NOW(),'+08:00','+08:00')) ,'+08:00','+00:00')
            ##AND pi.created_at < convert_tz(DATE_ADD(DATE(convert_tz(NOW(),'+08:00','+08:00')),INTERVAL 1 DAY) ,'+08:00','+00:00')
            and date(convert_tz(pi.created_at,'+00:00','+08:00')) >='2023-08-21'
            and date(convert_tz(pi.created_at,'+00:00','+08:00')) <='2023-08-21'
        GROUP BY 1,2,3
    ) lanshou # 揽收量
    ON lanshou.ticket_pickup_staff_info_id = hsi.staff_info_id and lanshou.ticket_pickup_store_id = ss.id and swa.stat_date = lanshou.created_at

    LEFT JOIN
    (
        SELECT
            pi.dst_store_id
            ,pr.staff_info_id
            ,date(convert_tz(pr.routed_at,'+00:00','+08:00')) as routed_at
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (2)    THEN pr.pno ELSE NULL END)) 拒收包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (70) THEN pr.pno ELSE NULL END)) 改约包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (71)   THEN pr.pno ELSE NULL END)) 运力不足包裹数
            ##,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (8,16)    THEN pr.pno ELSE NULL END)) 联系不上包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (1)    THEN pr.pno ELSE NULL END))  客户不在家_电话无人接听包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (78)   THEN pr.pno ELSE NULL END)) 收件人号码空号包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (75)   THEN pr.pno ELSE NULL END)) 收件人号码错误包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (73)   THEN pr.pno ELSE NULL END)) 收件人地址不清晰或不正确包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (7)    THEN pr.pno ELSE NULL END)) 货物丢失包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (6)    THEN pr.pno ELSE NULL END)) 货物短少包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (5)    THEN pr.pno ELSE NULL END)) 货物破损包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (4)    THEN pr.pno ELSE NULL END)) 外包装破损包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (69)    THEN pr.pno ELSE NULL END)) 禁运品包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category not IN (1,2,4,5,6,7,69,70,71,73,75,78)    THEN pr.pno ELSE NULL END)) 其他派件标记包裹数


        ##FROM tmpale.parcel_in_warehouse_today dsdt

        from ph_staging.parcel_route pr
        left join ph_staging.parcel_info pi
        ON pi.pno = pr.pno

        WHERE 1=1
            ##AND pr.marker_category IN (2,17,9,14,70,15,71,16,1,40,29,78,25,75,23,73,7,22,6,21,5,20,4,19) # 2 17拒收 9 14 70 改约 15 71 运力不足
            AND pr.route_action = 'DELIVERY_MARKER' #派件标记
            and date(convert_tz(pr.routed_at,'+00:00','+08:00')) >='2023-08-21'
            and date(convert_tz(pr.routed_at,'+00:00','+08:00')) <='2023-08-21'
            ##AND pr.routed_at >= convert_tz(DATE(convert_tz(NOW(),'+08:00','+08:00')),'+08:00','+00:00')
            ##AND pr.routed_at < convert_tz(DATE_ADD(DATE(convert_tz(NOW(),'+08:00','+08:00')),INTERVAL 1 DAY),'+08:00','+00:00')
        GROUP BY 1,2,3
    )pp #问题包裹数
    ON pp.staff_info_id = hsi.staff_info_id and pp.dst_store_id = ss.id and pp.routed_at = swa.stat_date

    WHERE 1=1
    AND (
            (
                    DATE(swa.stat_date) between '2023-08-21' and '2023-08-21' and hsi.sys_store_id = ss.id
            )

        or lanshou.揽件量 is not null
        or jiaojie.交接量 is not null
        )
    AND hsi.state = 1
    AND hsi.job_title IN (13,110,1000)
    AND ss.category IN (1,10) # 网点类型 1,10

)tt;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
from ph_staging.parcel_info pi
where
    pi.state = 8
    and pi.finished_at > date_sub(curdate(), interval 31 day )
    and pi.src_phone = 09164934277;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        pi.pno
        ,pi.state
        ,pi.ticket_pickup_store_id
        ,pi.returned
        ,pi.dst_store_id
        ,pi.client_id
        ,pi.cod_enabled
    from ph_staging.parcel_info pi
    where
        pi.created_at < '2023-08-01 16:00:00'
        and pi.state not in (5,7,8,9)
)
select
    t1.pno
    ,if(t1.returned = 1, '退件', '正向件')  方向
    ,t1.client_id 客户ID
    ,case
        when bc.`client_id` is not null then bc.client_name
        when kp.id is not null and bc.client_id is null then '普通ka'
        when kp.`id` is null then '小c'
    end as 客户类型
    ,case t1.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,case di.diff_marker_category # 疑难原因
        when 1 then '客户不在家/电话无人接听'
        when 2 then '收件人拒收'
        when 3 then '快件分错网点'
        when 4 then '外包装破损'
        when 5 then '货物破损'
        when 6 then '货物短少'
        when 7 then '货物丢失'
        when 8 then '电话联系不上'
        when 9 then '客户改约时间'
        when 10 then '客户不在'
        when 11 then '客户取消任务'
        when 12 then '无人签收'
        when 13 then '客户周末或假期不收货'
        when 14 then '客户改约时间'
        when 15 then '当日运力不足，无法派送'
        when 16 then '联系不上收件人'
        when 17 then '收件人拒收'
        when 18 then '快件分错网点'
        when 19 then '外包装破损'
        when 20 then '货物破损'
        when 21 then '货物短少'
        when 22 then '货物丢失'
        when 23 then '收件人/地址不清晰或不正确'
        when 24 then '收件地址已废弃或不存在'
        when 25 then '收件人电话号码错误'
        when 26 then 'cod金额不正确'
        when 27 then '无实际包裹'
        when 28 then '已妥投未交接'
        when 29 then '收件人电话号码是空号'
        when 30 then '快件分错网点-地址正确'
        when 31 then '快件分错网点-地址错误'
        when 32 then '禁运品'
        when 33 then '严重破损（丢弃）'
        when 34 then '退件两次尝试派送失败'
        when 35 then '不能打开locker'
        when 36 then 'locker不能使用'
        when 37 then '该地址找不到lockerstation'
        when 38 then '一票多件'
        when 39 then '多次尝试派件失败'
        when 40 then '客户不在家/电话无人接听'
        when 41 then '错过班车时间'
        when 42 then '目的地是偏远地区,留仓待次日派送'
        when 43 then '目的地是岛屿,留仓待次日派送'
        when 44 then '企业/机构当天已下班'
        when 45 then '子母件包裹未全部到达网点'
        when 46 then '不可抗力原因留仓(台风)'
        when 47 then '虚假包裹'
        when 48 then '转交FH包裹留仓'
        when 50 then '客户取消寄件'
        when 51 then '信息录入错误'
        when 52 then '客户取消寄件'
        when 53 then 'lazada仓库拒收'
        when 69 then '禁运品'
        when 70 then '客户改约时间'
        when 71 then '当日运力不足，无法派送'
        when 72 then '客户周末或假期不收货'
        when 73 then '收件人/地址不清晰或不正确'
        when 74 then '收件地址已废弃或不存在'
        when 75 then '收件人电话号码错误'
        when 76 then 'cod金额不正确'
        when 77 then '企业/机构当天已下班'
        when 78 then '收件人电话号码是空号'
        when 79 then '快件分错网点-地址错误'
        when 80 then '客户取消任务'
        when 81 then '重复下单'
        when 82 then '已完成揽件'
        when 83 then '联系不上客户'
        when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
        when 85 then '寄件人电话号码是空号'
        when 86 then '包裹不符合揽收条件超大件'
        when 87 then '包裹不符合揽收条件违禁品'
        when 88 then '寄件人地址为岛屿'
        when 89 then '运力短缺，跟客户协商推迟揽收'
        when 90 then '包裹未准备好推迟揽收'
        when 91 then '包裹包装不符合运输标准'
        when 92 then '客户提供的清单里没有此包裹'
        when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
        when 94 then '客户取消寄件/客户实际不想寄此包裹'
        when 95 then '车辆/人力短缺推迟揽收'
        when 96 then '遗漏揽收(已停用)'
        when 97 then '子母件(一个单号多个包裹)'
        when 98 then '地址错误addresserror'
        when 99 then '包裹不符合揽收条件：超大件'
        when 100 then '包裹不符合揽收条件：违禁品'
        when 101 then '包裹包装不符合运输标准'
        when 102 then '包裹未准备好'
        when 103 then '运力短缺，跟客户协商推迟揽收'
        when 104 then '子母件(一个单号多个包裹)'
        when 105 then '破损包裹'
        when 106 then '空包裹'
        when 107 then '不能打开locker(密码错误)'
        when 108 then 'locker不能使用'
        when 109 then 'locker找不到'
        when 110 then '运单号与实际包裹的单号不一致'
        when 111 then 'box客户取消任务'
        when 112 then '不能打开locker(密码错误)'
        when 113 then 'locker不能使用'
        when 114 then 'locker找不到'
        when 115 then '实际重量尺寸大于客户下单的重量尺寸'
        when 116 then '客户仓库关闭'
        when 117 then '客户仓库关闭'
        when 118 then 'SHOPEE订单系统自动关闭'
        when 119 then '客户取消包裹'
        when 121 then '地址错误'
        when 122 then '当日运力不足，无法揽收'
    end as 疑难原因
#     ,case
#         when t1.state = 6 and di.pno is not null then 'KAM/揽件网点未协商'
#         when t1.state = 6 and di.pno is null  then '闪速系统沟通处理中'
#         when t1.state != 6 and plt.pno is not null and plt2.pno is not null then '闪速系统沟通处理中'
#         when plt.pno is null and pct.pno is not null then '闪速超时效理赔未完成'
#         when de.last_store_id = t1.ticket_pickup_store_id and plt2.pno is null then '揽件未发出'
#         when t1.dst_store_id = 'PH19040F05' and plt2.pno is null then '弃件未到拍卖仓'
#         when t1.state != 6 and datediff(now(), convert_tz(pr.routed_at, '+00:00', '+08:00')) > 7 and plt2.pno is not null then 'QAQC无须追责后长期无有效路由'
#         else null
#     end 卡点原因
#     ,de.last_store_name 当前节点
    ,datediff(now(), convert_tz(pr.routed_at, '+00:00', '+08:00')) 最后有效路由距今天数
    ,case pr.route_action # 路由动作
         when 'ACCEPT_PARCEL' then '接件扫描'
         when 'ARRIVAL_GOODS_VAN_CHECK_SCAN' then '车货关联到港'
         when 'ARRIVAL_WAREHOUSE_SCAN' then '到件入仓扫描'
         when 'CANCEL_ARRIVAL_WAREHOUSE_SCAN' then '取消到件入仓扫描'
         when 'CANCEL_PARCEL' then '撤销包裹'
         when 'CANCEL_SHIPMENT_WAREHOUSE' then '取消发件出仓'
         when 'CHANGE_PARCEL_CANCEL' then '修改包裹为撤销'
         when 'CHANGE_PARCEL_CLOSE' then '修改包裹为异常关闭'
         when 'CHANGE_PARCEL_IN_TRANSIT' then '修改包裹为运输中'
         when 'CHANGE_PARCEL_INFO' then '修改包裹信息'
         when 'CHANGE_PARCEL_SIGNED' then '修改包裹为签收'
         when 'CLAIMS_CLOSE' then '理赔关闭'
         when 'CLAIMS_COMPLETE' then '理赔完成'
         when 'CLAIMS_CONTACT' then '已联系客户'
         when 'CLAIMS_TRANSFER_CS' then '转交总部cs处理'
         when 'CLOSE_ORDER' then '关闭订单'
         when 'CONTINUE_TRANSPORT' then '疑难件继续配送'
         when 'CREATE_WORK_ORDER' then '创建工单'
         when 'CUSTOMER_CHANGE_PARCEL_INFO' then '客户修改包裹信息'
         when 'CUSTOMER_OPERATING_RETURN' then '客户操作退回寄件人'
         when 'DELIVERY_CONFIRM' then '确认妥投'
         when 'DELIVERY_MARKER' then '派件标记'
         when 'DELIVERY_PICKUP_STORE_SCAN' then '自提取件扫描'
         when 'DELIVERY_TICKET_CREATION_SCAN' then '交接扫描'
         when 'DELIVERY_TRANSFER' then '派件转单'
         when 'DEPARTURE_GOODS_VAN_CK_SCAN' then '车货关联出港'
         when 'DETAIN_WAREHOUSE' then '货件留仓'
         when 'DIFFICULTY_FINISH_INDEMNITY' then '疑难件支付赔偿'
         when 'DIFFICULTY_HANDOVER' then '疑难件交接'
         when 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE' then '疑难件交接货件留仓'
         when 'DIFFICULTY_RE_TRANSIT' then '疑难件退回区域总部/重启运送'
         when 'DIFFICULTY_RETURN' then '疑难件退回寄件人'
         when 'DIFFICULTY_SEAL' then '集包异常'
         when 'DISCARD_RETURN_BKK' then '丢弃包裹的，换单后寄回BKK'
         when 'DISTRIBUTION_INVENTORY' then '分拨盘库'
         when 'DWS_WEIGHT_IMAGE' then 'DWS复秤照片'
         when 'EXCHANGE_PARCEL' then '换货'
         when 'FAKE_CANCEL_HANDLE' then '虚假撤销判责'
         when 'FLASH_HOME_SCAN' then 'FH交接扫描'
         when 'FORCE_TAKE_PHOTO' then '强制拍照路由'
         when 'HAVE_HAIR_SCAN_NO_TO' then '有发无到'
         when 'HURRY_PARCEL' then '催单'
         when 'INCOMING_CALL' then '来电接听'
         when 'INTERRUPT_PARCEL_AND_RETURN' then '中断运输并退回'
         when 'INVENTORY' then '盘库'
         when 'LOSE_PARCEL_TEAM_OPERATION' then '丢失件团队处理'
         when 'MANUAL_REMARK' then '添加备注'
         when 'MISS_PICKUP_HANDLE' then '漏包裹揽收判责'
         when 'MISSING_PARCEL_SCAN' then '丢失件包裹操作'
         when 'NOTICE_LOST_PARTS_TEAM' then '已通知丢失件团队'
         when 'PARCEL_HEADLESS_CLAIMED' then '无头件包裹已认领'
         when 'PARCEL_HEADLESS_PRINTED' then '无头件包裹已打单'
         when 'PENDING_RETURN' then '待退件'
         when 'PHONE' then '电话联系'
         when 'PICK_UP_STORE' then '待自提取件'
         when 'PICKUP_RETURN_RECEIPT' then '签回单揽收'
         when 'PRINTING' then '打印面单'
         when 'QAQC_OPERATION' then 'QAQC判责'
         when 'RECEIVE_WAREHOUSE_SCAN' then '收件入仓'
         when 'RECEIVED' then '已揽收'
         when 'REFUND_CONFIRM' then '退件妥投'
         when 'REPAIRED' then '上报问题修复路由'
         when 'REPLACE_PNO' then '换单'
         when 'REPLY_WORK_ORDER' then '回复工单'
         when 'REVISION_TIME' then '改约时间'
         when 'SEAL' then '集包'
         when 'SEAL_NUMBER_CHANGE' then '集包件数变化'
         when 'SHIPMENT_WAREHOUSE_SCAN' then '发件出仓扫描'
         when 'SORTER_WEIGHT_IMAGE' then '分拣机复秤照片'
         when 'SORTING_SCAN' then '分拣扫描'
         when 'STAFF_INFO_UPDATE_WEIGHT' then '快递员修改重量'
         when 'STORE_KEEPER_UPDATE_WEIGHT' then '仓管员复秤'
         when 'STORE_SORTER_UPDATE_WEIGHT' then '分拣机复秤'
         when 'SYSTEM_AUTO_RETURN' then '系统自动退件'
         when 'TAKE_PHOTO' then '异常打单拍照'
         when 'THIRD_EXPRESS_ROUTE' then '第三方公司路由'
         when 'THIRD_PARTY_REASON_DETAIN' then '第三方原因滞留'
         when 'TICKET_WEIGHT_IMAGE' then '揽收称重照片'
         when 'TRANSFER_LOST_PARTS_TEAM' then '已转交丢失件团队'
         when 'TRANSFER_QAQC' then '转交QAQC处理'
         when 'UNSEAL' then '拆包'
         when 'UNSEAL_NO_PARCEL' then '上报包裹不在集包里'
         when 'UNSEAL_NOT_SCANNED' then '集包已拆包，本包裹未被扫描'
         when 'VEHICLE_ACCIDENT_REG' then '车辆车祸登记'
         when 'VEHICLE_ACCIDENT_REGISTRATION' then '车辆车祸登记'
         when 'VEHICLE_WET_DAMAGE_REG' then '车辆湿损登记'
         when 'VEHICLE_WET_DAMAGE_REGISTRATION' then '车辆湿损登记'
        end as 最后一条路由
    ,pr.store_name 最后有效路由动作网点
    ,convert_tz(pr.routed_at ,'+00:00', '+08:00') 最新一条有效路由时间
    ,datediff(now(), de.dst_routed_at) 目的地网点停留时间
    ,de.dst_store 目的地网点
    ,de.dst_piece
    ,de.dst_region
    ,de.src_store 揽收网点
    ,de.pickup_time 揽收时间
    ,de.pick_date 揽收日期
    ,if(hold.pno is not null, 'yes', 'no' ) 是否有holding标记
    ,if(pr3.pno is not null, 'yes', 'no') 是否有待退件标记
    ,td.try_num 尝试派送次数
from t t1
left join ph_staging.ka_profile kp on t1.client_id = kp.id
left join dwm.dwd_dim_bigClient bc on bc.client_id = t1.client_id
left join dwm.dwd_ex_ph_parcel_details de on de.pno = t1.pno
left join
    (
        select
            plt.pno
            ,group_concat(ss.name ) should_do
        from ph_bi.parcel_lose_task plt
        join t t1 on t1.pno = plt.pno
        left join ph_bi.work_order wo on wo.loseparcel_task_id = plt.id
        left join ph_staging.sys_store ss on ss.id = wo.store_id
        where
            plt.state in (3)
            and wo.status in (1,2)
        group by 1

        union  all

        select
            plt.pno
            ,'QAQC' should_do
        from ph_bi.parcel_lose_task plt
        join t t1 on t1.pno = plt.pno
        where
            plt.state in (1,2,4)
    ) plt on plt.pno = t1.pno
left join
    (
        select
            t2.pno
            ,cdt.negotiation_result_category
            ,di.diff_marker_category
            ,case
                when di.diff_marker_category in (20,21)  and cdt.vip_enable = 1 then 'KAM'
                when di.diff_marker_category not in (20,21) and cdt.vip_enable = 1 then 'KAM'
                when di.diff_marker_category not in (20,21) and cdt.vip_enable = 0 then ss2.name
                WHEN di.diff_marker_category in (20,21) and cdt.vip_enable = 0 then ss2.name
            end sh_do
        from ph_staging.diff_info di
        join t t2 on t2.pno = di.pno
        join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
        left join ph_bi.parcel_lose_task plt on plt.source_id = cdt.id
        left join ph_staging.sys_store ss2 on ss2.id = t2.ticket_pickup_store_id
        where
            cdt.negotiation_result_category is null
    ) di on di.pno = t1.pno
left join  
    (
        select
            pr.pno
            ,pr.store_name
            ,pr.routed_at
            ,pr.route_action
            ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
        from  ph_staging.parcel_route pr
        join t t3 on t3.pno = pr.pno
        where
            pr.route_action in ('INVENTORY','RECEIVED' ,'RECEIVE_WAREHOUSE_SCAN', 'SORTING_SCAN', 'DELIVERY_TICKET_CREATION_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SHIPMENT_WAREHOUSE_SCAN', 'DETAIN_WAREHOUSE', 'DELIVERY_CONFIRM', 'DIFFICULTY_HANDOVER', 'DELIVERY_MARKER', 'REPLACE_PNO','SEAL', 'UNSEAL', 'STAFF_INFO_UPDATE_WEIGHT', 'STORE_KEEPER_UPDATE_WEIGHT', 'STORE_SORTER_UPDATE_WEIGHT', 'DISCARD_RETURN_BKK', 'DELIVERY_TRANSFER', 'PICKUP_RETURN_RECEIPT', 'FLASH_HOME_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SORTING_SCAN ', 'DELIVERY_PICKUP_STORE_SCAN', 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE', 'REFUND_CONFIRM', 'ACCEPT_PARCEL')
            and pr.organization_type = 1
        ) pr on pr.pno = t1.pno and pr.rk = 1
left join
    (
        select
            plt.pno
        from ph_bi.parcel_lose_task plt
        join t t1 on t1.pno = plt.pno
        where
            plt.state = 5
            and plt.operator_id not in (10000,10001,10002)
        group by 1
    ) plt2 on plt2.pno = t1.pno
left join
    (
        select
            plt.pno
        from ph_bi.parcel_claim_task plt
        join t t4  on t4.pno = plt.pno
        where
            plt.state not in (6,7,8)
            and plt.source = 11
        group by 1
    ) pct on pct.pno = t1.pno
left join
    (
        select
            pr2.pno
        from ph_staging.parcel_route pr2
        join t t1 on t1.pno = pr2.pno
        where
            pr2.route_action = 'REFUND_CONFIRM'
        group by 1
    ) hold on hold.pno = t1.pno
left join
    (
        select
            pr2.pno
        from  ph_staging.parcel_route pr2
        join t t1 on t1.pno = pr2.pno
        where
            pr2.route_action = 'PENDING_RETURN'
        group by 1
    ) pr3 on pr3.pno = t1.pno
left join
    (
        select
            td.pno
            ,count(distinct date(convert_tz(tdm.created_at, '+00:00', '+08:00'))) try_num
        from ph_staging.ticket_delivery td
        join t t1 on t1.pno = td.pno
        left join ph_staging.ticket_delivery_marker tdm on tdm.delivery_id = td.id
        group by 1
    ) td on td.pno = t1.pno
group by t1.pno;
;-- -. . -..- - / . -. - .-. -.--
select
    pr.pno
    ,convert_tz(pr.routed_at, '+00:00', '+08:00') 标记时间
    ,json_extract(pr1.extra_value, '$.callDuration') 通话时长
    ,convert_tz(pr1.routed_at, '+00:00', '+08:00') 通话时间
from ph_staging.parcel_route pr
join
    (
        select
            pr.pno
            ,pr.routed_at
            ,pr.extra_value
        from ph_staging.parcel_route pr
        where
            pr.routed_at > '2023-08-21 16:00:00'
            and pr.routed_at < '2023-08-22 16:00:00'
            and pr.route_action = 'DELIVERY_MARKER'
            and pr.marker_category in (2,17)
    ) pr1 on pr1.pno = pr.pno
where
    pr1.routed_at > '2023-08-21 16:00:00'
    and pr1.routed_at < '2023-08-22 16:00:00'
    and pr1.routed_at < pr.routed_at;
;-- -. . -..- - / . -. - .-. -.--
select
    pr.pno
    ,convert_tz(pr.routed_at, '+00:00', '+08:00') 标记时间
    ,json_extract(pr1.extra_value, '$.callDuration') 通话时长
    ,convert_tz(pr1.routed_at, '+00:00', '+08:00') 通话时间
from ph_staging.parcel_route pr
join
    (
        select
            pr.pno
            ,pr.routed_at
            ,pr.extra_value
        from ph_staging.parcel_route pr
        where
            pr.routed_at > '2023-08-21 16:00:00'
            and pr.routed_at < '2023-08-22 16:00:00'
            and pr.route_action = 'DELIVERY_MARKER'
            and pr.marker_category in (2,17)
    ) pr1 on pr1.pno = pr.pno
where
    pr1.routed_at > '2023-08-21 16:00:00'
    and pr1.routed_at < '2023-08-22 16:00:00'
    and pr1.routed_at < pr.routed_at
    and pr.route_action = 'PHONE';
;-- -. . -..- - / . -. - .-. -.--
select
    pr.pno
    ,convert_tz(pr1.routed_at, '+00:00', '+08:00') 标记时间
    ,json_extract(pr.extra_value, '$.callDuration') 通话时长
    ,convert_tz(pr.routed_at, '+00:00', '+08:00') 通话时间
from ph_staging.parcel_route pr
join
    (
        select
            pr.pno
            ,pr.routed_at
            ,pr.extra_value
        from ph_staging.parcel_route pr
        where
            pr.routed_at > '2023-08-21 16:00:00'
            and pr.routed_at < '2023-08-22 16:00:00'
            and pr.route_action = 'DELIVERY_MARKER'
            and pr.marker_category in (2,17)
    ) pr1 on pr1.pno = pr.pno
where
    pr1.routed_at > '2023-08-21 16:00:00'
    and pr1.routed_at < '2023-08-22 16:00:00'
    and pr1.routed_at < pr.routed_at
    and pr.route_action = 'PHONE';
;-- -. . -..- - / . -. - .-. -.--
select
    pr.pno
    ,convert_tz(pr1.routed_at, '+00:00', '+08:00') 标记时间
    ,json_extract(pr.extra_value, '$.callDuration') 通话时长
    ,convert_tz(pr.routed_at, '+00:00', '+08:00') 通话时间
from ph_staging.parcel_route pr
join
    (
        select
            pr.pno
            ,pr.routed_at
            ,pr.extra_value
        from ph_staging.parcel_route pr
        where
            pr.routed_at > '2023-08-21 16:00:00'
            and pr.routed_at < '2023-08-22 16:00:00'
            and pr.route_action = 'DELIVERY_MARKER'
            and pr.marker_category in (2,17)
    ) pr1 on pr1.pno = pr.pno
where
    pr1.routed_at > '2023-08-21 16:00:00'
    and pr1.routed_at < '2023-08-22 16:00:00'
    and pr1.routed_at > pr.routed_at
    and pr.route_action = 'PHONE';
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.CT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-08-23'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.CT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-08-23'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-08-23', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with d as
    (
        select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-08-23'
    )
    , t as
    (
        select
             ds.store_id
            ,ds.pno
            ,ds.stat_date
        from d ds
        left join
            (
                select
                    pr.pno
                    ,ds.stat_date
                    ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
                from ph_staging.parcel_route pr
                join d ds on pr.pno = ds.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                    and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and pr.marker_category in (42,43) ##岛屿,偏远地区
                group by 1,2
            ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
        left join
            (
                select
                   pr.pno
                    ,ds.stat_date
                   ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
                   ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
                from ph_staging.parcel_route pr
                join d ds on ds.pno = pr.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                    and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                    and pr.marker_category in (9,14,70) ##客户改约时间
            ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
        left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
        where
            case
                when pr1.pno is not null then 'N'
                when pr2.pno is not null then 'N'
                when ds1.pno is not null  then 'N'  else 'Y'
            end = 'Y'
    )
    select
        a.stat_date 日期
        ,a.store_id 网点ID
        ,dp.store_name 网点名称
        ,dp.opening_at 开业时间
        ,case
            when dp.region_name in ('Area3', 'Area6') then '彭万松'
            when dp.region_name in ('Area4', 'Area9') then '韩钥'
            when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
            when dp.region_name in ( 'Area8') then '黄勇'
            when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
        end 区域
        ,dp.region_name 大区
        ,dp.piece_name 片区
        ,a.应交接
        ,a.已交接
        ,concat(round(a.交接率*100,2),'%') as 交接率
        ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
        ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
        ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
        ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
        ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
    from
        (
            select
                t1.store_id
                ,t1.stat_date
                ,count(t1.pno) 应交接
                ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
            from t t1
            left join
                (
                    select
                        sc.*
                    from
                        (
                            select
                                pr.pno
                                ,pr.store_id
                                ,pr.store_name
                                ,t1.stat_date
                                ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                            from ph_staging.parcel_route pr
                            join t t1 on t1.pno = pr.pno
                            where
                                pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                               and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                              and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                        ) sc
                    where
                        sc.rk = 1
                ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
            group by 1,2
        ) a
    join
        (
            select
                sd.store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.store_id is not null
            group by 1

            union all

            select
                sd.separation_store_id store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.separation_store_id is not null
            group by 1
        ) sd on sd.store_id = a.store_id
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    where
        dp.store_category in (1,10);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-08-23'
        and pr.routed_at >= date_sub('2023-08-23', interval 8 hour )
        and pr.routed_at < date_add('2023-08-23', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end 评级
        ,a2.code_num
        ,a2.staff_code_num
        ,a2.staff_num
        ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-23'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-08-23')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-08-23'
        and pi.finished_at >= date_sub('2023-08-23', interval 8 hour )
        and pi.finished_at < date_add('2023-08-23', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-08-23'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
SELECT
    swa.stat_date
    ,hsi.staff_info_id
    ,swa.state_desc 状态描述
    ,case when swa.wait_leave_state in ('0') then '非待离职'
        when swa.wait_leave_state in ('1') then '待离职'
    else swa.wait_leave_state end as 是否待离职
    ,swa.attendance_started_at
    ,swa.attendance_end_at
    ,swa.attendance_hour   工作时长
    ,ROUND(time_to_sec(timediff(swa.shift_start,date_format(swa.attendance_started_at,"%H:%i:%s"))) /60,2) 迟到时长
    ,case when swa.is_plan_rest = 1 then '排休无需打卡'
        when  swa.is_plan_rest = 0 and swa.attendance_started_at is null then '无上班打卡时间'
        when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 59 then '未迟到'
        when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 359 then '迟到5min内'
        when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 659 then '迟到5-10min'
        when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 959 then '迟到10-15min'
        when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 1259 then '迟到15-20min'
        when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 1559 then '迟到20-25min'
        when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 1859 then '迟到25-30min'
    else '迟到30min以上' end as 迟到情况
    ,case when swa.is_outsource = 1 then '是' else '否' end as 是否外协
    ,case when swa.is_plan_rest = 1 then '是' else '否' end as 是否排休
    ,swa.hire_days 在职天数
    ,swa.job_title_desc 岗位描述
    ,hsi.mobile 员工手机号
    ,DATEDIFF(swa.stat_date,hsi.hire_date) 工龄
    ,swa.store_id as           归属网点ID
    ,swa.store_name as         归属网点名称
    ,swa.store_category_desc as 网点类型描述
    ,swa.region_name as        归属大区
    ,swa.piece_name as          归属片区
    ,swa.formal as             员工的属性
    ,CASE
        WHEN hsi.job_title = 13  THEN 'Bike'
        WHEN hsi.job_title = 110 THEN 'VAN'
        WHEN hsi.job_title = 452 THEN 'Boat'
        WHEN hsi.job_title = 1000 THEN 'Tricycle'
        WHEN hsi.job_title = 37  THEN '仓管'
        WHEN hsi.job_title = 16  THEN '主管'
    END AS 当日岗位
    ,ss.name 当日所属网点
    ,ss.id store_id
    ,CASE
        WHEN ss.category = 1  THEN 'SP'
        WHEN ss.category = 10 THEN 'BDC'
        WHEN ss.category = 14  THEN 'PDC'
    END 网点类型
    ,smr.name 大区
    ,smp.name 片区
    ,CASE WHEN hsi.formal = 0 THEN '外协员工'
          when hsi.sys_store_id = ss.id then '自有员工'
          when hsi.sys_store_id <> ss.id THEN '支援员工'
          END AS 员工属性

    ,lanshou.揽件量
    ,jiaojie.交接量
    ,tuotou.当天派件数
    ,pp.拒收包裹数
    ,pp.运力不足包裹数
    ,pp.改约包裹数
    ,pp.客户不在家_电话无人接听包裹数
    ,pp.收件人号码空号包裹数
    ,pp.收件人号码错误包裹数
    ,pp.收件人地址不清晰或不正确包裹数
    ,pp.货物丢失包裹数
    ,pp.货物短少包裹数
    ,pp.货物破损包裹数
    ,pp.外包装破损包裹数
    ,pp.禁运品包裹数
    ,pp.其他派件标记包裹数

    ,IF(tuotou.当天派件数=1,TIMESTAMPDIFF(MINUTE,tuotou.finished_min,tuotou.finished_max),ROUND(TIMESTAMPDIFF(MINUTE,tuotou.finished_min,tuotou.finished_max) / (tuotou.当天派件数-1),2)) '派件间隔(分钟)'
    ,ROUND(tuotou.当天派件数 / jiaojie.交接量,2) '派件/交接'
    ,jiaojie.'交接5KG以上'
    ,tuotou.'妥投5KG以上'
    ,tuotou.tuotou_num_50 as '网点50米内派件量'
    ,jiaojie.delivery_min 最早交接时间
    ,jiaojie.delivery_max 最近交接时间
    ,ROUND(TIMESTAMPDIFF(MINUTE,jiaojie.delivery_min,jiaojie.delivery_max)/60,2) '交接工作时间'
    ,tuotou.finished_min  最早派件时间
    ,tuotou.finished_max  最近派件时间
    ,ROUND(TIMESTAMPDIFF(MINUTE,tuotou.finished_min,tuotou.finished_max)/60,2) '派件工作时间'
    ,lanshou.created_min  最早揽件时间
    ,lanshou.created_max  最近揽件时间
    ,ROUND(TIMESTAMPDIFF(MINUTE,lanshou.created_min,lanshou.created_max)/60,2) '揽件工作时间'


    FROM ph_bi.hr_staff_info hsi

    ##left join ph_backyard.staff_work_attendance swa
    ##on swa.staff_info_id=hsi.staff_info_id
    ##and swa.attendance_date = date(convert_tz(now(),'+08:00','+08:00'))


    left join dwm.dws_ph_staff_wide_s swa
    on swa.staff_info_id=hsi.staff_info_id

    left join ph_staging.sys_store ss
    on ss.category in (1,10)
    ##on swa.started_store_id = ss.id

    left join ph_staging.sys_manage_piece smp
    on smp.id=ss.manage_piece

    left join ph_staging.sys_manage_region smr
    on smr.id=ss.manage_region

    left join
    (
        select
            pi.dst_store_id ##目的地网点
            ,td2.staff_info_id
            ,date(convert_tz(td2.created_at,'+00:00','+08:00')) as created_dt
            ,COUNT(DISTINCT td2.pno) '交接量'
            ,COUNT(DISTINCT CASE WHEN (pi.exhibition_length + pi.exhibition_width + pi.exhibition_height > 80 OR pi.exhibition_weight > 5000) THEN td2.pno ELSE NULL END)'交接5KG以上'
            ##,MIN(DATE_FORMAT(convert_tz(td2.created_at,'+00:00','+08:00'),'%T')) AS delivery_min ##最早交接时间
            ##,MAX(DATE_FORMAT(convert_tz(td2.created_at,'+00:00','+08:00'),'%T')) AS delivery_max ##最近交接时间
            ,MIN(convert_tz(td2.created_at,'+00:00','+08:00')) AS delivery_min ##最早交接时间
            ,MAX(convert_tz(td2.created_at,'+00:00','+08:00')) AS delivery_max ##最近交接时间

        ##FROM tmpale.parcel_in_warehouse_today dsdt
        ##JOIN  ph_staging.ticket_delivery td2
        from ph_staging.ticket_delivery td2
        left join ph_staging.parcel_info pi
        ON pi.pno = td2.pno
        WHERE 1=1
            ##and date(convert_tz(td2.created_at,'+00:00','+08:00')) >='${sdate}'
            ##and date(convert_tz(td2.created_at,'+00:00','+08:00')) <='${edate}'
            and td2.created_at >= date_sub('2023-08-23', interval 8 hour )
            and td2.created_at < date_sub(date_add('2023-08-23', interval 1 day ), interval 8 hour )
            ##td2.delivery_at >= convert_tz(DATE(convert_tz(NOW(),'+08:00','+08:00')),'+08:00','+00:00')
            ##AND td2.created_at < convert_tz(DATE_ADD(DATE(convert_tz(NOW(),'+08:00','+08:00')),INTERVAL 1 DAY),'+08:00','+00:00')
            AND td2.state <> 3 # stata=3(已关闭)
        GROUP BY 1,2,3
    ) jiaojie # 交接量
    ON jiaojie.staff_info_id = hsi.staff_info_id and jiaojie.dst_store_id =  ss.id and swa.stat_date = jiaojie.created_dt

    LEFT JOIN
    (
        SELECT
            pi.dst_store_id
            ,pi.ticket_delivery_staff_info_id
            ,date(convert_tz(pi.finished_at,'+00:00','+08:00')) as finished_dt
            ,MIN((convert_tz(pi.finished_at,'+00:00','+08:00')))  AS finished_min ##派件开始时间
            ,MAX((convert_tz(pi.finished_at,'+00:00','+08:00')))  AS finished_max ##派件结束时间
            ,COUNT(DISTINCT if(ROUND(st_distance_sphere(point(pi.ticket_delivery_staff_lng,pi.ticket_delivery_staff_lat), point(ss.lng,ss.lat)),0) < 50,pi.pno,null))  as tuotou_num_50
            ,IFNULL(COUNT(DISTINCT pi.pno),0) '当天派件数'
            ,COUNT(DISTINCT CASE WHEN (pi.exhibition_length + pi.exhibition_width + pi.exhibition_height > 80 OR pi.exhibition_weight > 5000) THEN pi.pno ELSE NULL END)'妥投5KG以上'
            ##,CASE WHEN ROUND(st_distance_sphere(point(pi.ticket_delivery_staff_lng,pi.ticket_delivery_staff_lat), point(ss.lng,ss.lat)),0) >= 50 THEN MIN((convert_tz(pi.finished_at,'+00:00','+08:00'))) END AS 派件开始时间
            ##,CASE WHEN ROUND(st_distance_sphere(point(pi.ticket_delivery_staff_lng,pi.ticket_delivery_staff_lat), point(ss.lng,ss.lat)),0) >= 50 THEN MAX((convert_tz(pi.finished_at,'+00:00','+08:00'))) END AS 派件结束时间

        ##FROM tmpale.parcel_in_warehouse_today dsdt  ##在仓表

        from ph_staging.parcel_info pi
        ##ON dsdt.pno = pi.pno

        LEFT JOIN ph_staging.sys_store ss
        on ss.id = pi.dst_store_id

        WHERE  1=1
            ##and dsdt.stat_date = date(convert_tz(now(),'+08:00','+08:00'))
            ##and date(dsdt.stat_date) >='${sdate}'
            ##and date(dsdt.stat_date) <='${edate}'
            ##and date(convert_tz(pi.finished_at,'+00:00','+08:00')) >='${sdate}'
            ##and date(convert_tz(pi.finished_at,'+00:00','+08:00')) <='${edate}'
            and pi.finished_at >= date_sub('2023-08-23', interval 8 hour )
            and pi.finished_at < date_sub(date_add('2023-08-23', interval 1 day ), interval 8 hour )
            and pi.state in ('5')
        GROUP BY 1,2,3
    )tuotou # 妥投
    ON tuotou.ticket_delivery_staff_info_id = hsi.staff_info_id and tuotou.dst_store_id = ss.id and swa.stat_date = tuotou.finished_dt

    LEFT JOIN
    (
        SELECT
            pi.ticket_pickup_store_id
            ,pi.ticket_pickup_staff_info_id
            ,date(convert_tz(pi.created_at,'+00:00','+08:00')) as created_at
            ,COUNT(DISTINCT(pi.pno))  '揽件量'
            ,MIN((convert_tz(pi.created_at,'+00:00','+08:00'))) AS created_min ##揽件开始时间
            ,MAX((convert_tz(pi.created_at,'+00:00','+08:00'))) AS created_max ##揽件结束时间

        FROM ph_staging.parcel_info pi

        WHERE 1=1
            and pi.state <> 9
            and pi.returned = 0
            ##and pi.created_at >= convert_tz(DATE(convert_tz(NOW(),'+08:00','+08:00')) ,'+08:00','+00:00')
            ##AND pi.created_at < convert_tz(DATE_ADD(DATE(convert_tz(NOW(),'+08:00','+08:00')),INTERVAL 1 DAY) ,'+08:00','+00:00')
            ##and date(convert_tz(pi.created_at,'+00:00','+08:00')) >='${sdate}'
            ##and date(convert_tz(pi.created_at,'+00:00','+08:00')) <='${edate}'
            and pi.created_at >= date_sub('2023-08-23', interval 8 hour )
            and pi.created_at < date_sub(date_add('2023-08-23', interval 1 day ), interval 8 hour )
        GROUP BY 1,2,3
    ) lanshou # 揽收量
    ON lanshou.ticket_pickup_staff_info_id = hsi.staff_info_id and lanshou.ticket_pickup_store_id = ss.id and swa.stat_date = lanshou.created_at

    LEFT JOIN
    (
        SELECT
            pi.dst_store_id
            ,pr.staff_info_id
            ,date(convert_tz(pr.routed_at,'+00:00','+08:00')) as routed_at
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (2)    THEN pr.pno ELSE NULL END)) 拒收包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (70) THEN pr.pno ELSE NULL END)) 改约包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (71)   THEN pr.pno ELSE NULL END)) 运力不足包裹数
            ##,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (8,16)    THEN pr.pno ELSE NULL END)) 联系不上包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (1)    THEN pr.pno ELSE NULL END))  客户不在家_电话无人接听包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (78)   THEN pr.pno ELSE NULL END)) 收件人号码空号包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (75)   THEN pr.pno ELSE NULL END)) 收件人号码错误包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (73)   THEN pr.pno ELSE NULL END)) 收件人地址不清晰或不正确包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (7)    THEN pr.pno ELSE NULL END)) 货物丢失包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (6)    THEN pr.pno ELSE NULL END)) 货物短少包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (5)    THEN pr.pno ELSE NULL END)) 货物破损包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (4)    THEN pr.pno ELSE NULL END)) 外包装破损包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (69)    THEN pr.pno ELSE NULL END)) 禁运品包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category not IN (1,2,4,5,6,7,69,70,71,73,75,78)    THEN pr.pno ELSE NULL END)) 其他派件标记包裹数


        ##FROM tmpale.parcel_in_warehouse_today dsdt

        from ph_staging.parcel_route pr
        left join ph_staging.parcel_info pi
        ON pi.pno = pr.pno

        WHERE 1=1
            ##AND pr.marker_category IN (2,17,9,14,70,15,71,16,1,40,29,78,25,75,23,73,7,22,6,21,5,20,4,19) # 2 17拒收 9 14 70 改约 15 71 运力不足
            AND pr.route_action = 'DELIVERY_MARKER' #派件标记
            ##and date(convert_tz(pr.routed_at,'+00:00','+08:00')) >='${sdate}'
            ##and date(convert_tz(pr.routed_at,'+00:00','+08:00')) <='${edate}'
            and pr.routed_at >= date_sub('2023-08-23', interval 8 hour )
            and pr.routed_at < date_sub(date_add('2023-08-23', interval 1 day ), interval 8 hour )
            ##AND pr.routed_at >= convert_tz(DATE(convert_tz(NOW(),'+08:00','+08:00')),'+08:00','+00:00')
            ##AND pr.routed_at < convert_tz(DATE_ADD(DATE(convert_tz(NOW(),'+08:00','+08:00')),INTERVAL 1 DAY),'+08:00','+00:00')
        GROUP BY 1,2,3
    )pp #问题包裹数
    ON pp.staff_info_id = hsi.staff_info_id and pp.dst_store_id = ss.id and pp.routed_at = swa.stat_date

    WHERE 1=1
    AND (
            (
            DATE(swa.stat_date) between '2023-08-23' and '2023-08-23' and hsi.sys_store_id = ss.id
            )
            or lanshou.揽件量 is not null
            or jiaojie.交接量 is not null
        )
    AND hsi.state = 1
    AND hsi.job_title IN (13,110,1000)
    AND ss.category IN (1,10,14) # 网点类型 1,10
    and swa.job_title IN (13,110,1000);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        plt2.pno
        ,pcol.created_at
        ,plt2.client_id
        ,plt2.parcel_created_at
        ,plt2.id
        ,group_concat(distinct ss.name) ss_name
    from ph_bi.parcel_cs_operation_log pcol
    left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
    left join ph_bi.parcel_lose_responsible plr on plr.lose_task_id = plt2.id
    left join ph_staging.sys_store ss on ss.id = plr.store_id
    where
        pcol.type = 1
        and pcol.action = 4
        and pcol.operator_id != 10001
        and pcol.created_at >= '2023-07-01'
        and pcol.created_at < '2023-08-01'
    group by 1,2,3,4,5
)
, pr as
(
    select
        t1.*
        ,ddd.EN_element
        ,pr.routed_at
        ,pr.store_name
        ,pr.store_id
        ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk2
    from ph_staging.parcel_route pr
    join t t1 on t1.pno = pr.pno
    join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
    where
        pr.routed_at > '2023-07-01'
)
select
    a.PNO
    ,case
        when bc.client_id is not null then bc.client_name
        when bc.client_id is null and kp.id is not null then 'KA'
        when kp.id is null then 'GE'
    end 客户类型
    ,case
        when a.diff_hour < 24 then '24小时内'
        when a.diff_hour >= 24 and a.diff_hour < 48 then '24-48小时'
        when a.diff_hour >= 48 and a.diff_hour < 72 then '48-72小时'
        when a.diff_hour >= 72 and a.diff_hour < 96 then '72-96小时'
        when a.diff_hour >= 96 and a.diff_hour < 120 then '96-120小时'
        when a.diff_hour >= 120 then '120小时以上'
    end 判责丢失后找回包裹时效
    ,if(pi.cod_enabled = 1, '是', '否') 是否COD
    ,if(pi.state = 5 , datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), a.created_at), null) 判责丢失后几天内投妥成功
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,if(a2.store_name = 'PN5-CS(INVENTORY)', '是', '否') 是否到拍卖场
    ,if(bc.client_name is not null ,
        case
            when bc.client_name = 'lazada' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= la.whole_end_date then '是'
            when bc.client_name = 'shopee' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= sh.end_date then '是'
            when bc.client_name = 'tiktok' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= if( tt.end_7_date is null, tt.end_date, tt.end_7_date) then '是'
            when bc.client_name = 'shein' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= ein.sla_final_end_time then '是'
            else '否'
        end, null) 是否在丢弃时效前有有效路由
from
    (
        select
            a.*
            ,timestampdiff(hour, a.created_at, convert_tz(a.routed_at, '+00:00', '+08：00')) diff_hour
        from pr a
        where
            a.rk = 1
    ) a
left join ph_staging.ka_profile kp on kp.id = a.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = a.client_id
left join ph_staging.ka_profile kp on kp.id = a.client_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day )
left join ph_staging.parcel_info pi on pi.pno = a.pno
left join
    (
        select
            a.*
        from pr a
        where
            a.rk2 = 1
    ) a2 on a2.pno = a.pno
left join dwm.dwd_ex_ph_lazada_pno_period la on la.pno = a.pno
left join dwm.dwd_ex_shopee_lost_pno_period sh on sh.pno = a.pno
left join dwm.dwd_ex_ph_tiktok_sla_detail tt on tt.pno = a.pno
left join dwm.dwd_ex_ph_shein_sla_detail ein on ein.pno = a.pno;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        plt2.pno
        ,pcol.created_at
        ,plt2.client_id
        ,plt2.parcel_created_at
        ,plt2.id
        ,group_concat(distinct ss.name) ss_name
    from ph_bi.parcel_cs_operation_log pcol
    left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
    left join ph_bi.parcel_lose_responsible plr on plr.lose_task_id = plt2.id
    left join ph_staging.sys_store ss on ss.id = plr.store_id
    where
        pcol.type = 1
        and pcol.action = 4
        and pcol.operator_id != 10001
        and pcol.created_at >= '2023-07-01'
        and pcol.created_at < '2023-08-01'
    group by 1,2,3,4,5
)
, pr as
(
    select
        t1.*
        ,ddd.EN_element
        ,pr.routed_at
        ,pr.store_name
        ,pr.store_id
        ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk2
    from ph_staging.parcel_route pr
    join t t1 on t1.pno = pr.pno
    join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
    where
        pr.routed_at > '2023-07-01'
)
select
    a.PNO
    ,case
        when bc.client_id is not null then bc.client_name
        when bc.client_id is null and kp.id is not null then 'KA'
        when kp.id is null then 'GE'
    end 客户类型
    ,case
        when a.diff_hour < 24 then '24小时内'
        when a.diff_hour >= 24 and a.diff_hour < 48 then '24-48小时'
        when a.diff_hour >= 48 and a.diff_hour < 72 then '48-72小时'
        when a.diff_hour >= 72 and a.diff_hour < 96 then '72-96小时'
        when a.diff_hour >= 96 and a.diff_hour < 120 then '96-120小时'
        when a.diff_hour >= 120 then '120小时以上'
    end 判责丢失后找回包裹时效
    ,if(pi.cod_enabled = 1, '是', '否') 是否COD
    ,if(pi.state = 5 , datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), a.created_at), null) 判责丢失后几天内投妥成功
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,if(a2.store_name = 'PN5-CS(INVENTORY)', '是', '否') 是否到拍卖场
    ,if(bc.client_name is not null ,
        case
            when bc.client_name = 'lazada' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= la.whole_end_date then '是'
            when bc.client_name = 'shopee' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= sh.end_date then '是'
            when bc.client_name = 'tiktok' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= if( tt.end_7_date is null, tt.end_date, tt.end_7_date) then '是'
            when bc.client_name = 'shein' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= ein.sla_final_end_time then '是'
            else '否'
        end, null) 是否在丢弃时效前有有效路由
from
    (
        select
            a.*
            ,timestampdiff(hour, a.created_at, convert_tz(a.routed_at, '+00:00', '+08：00')) diff_hour
        from pr a
        where
            a.rk = 1
    ) a
left join ph_staging.ka_profile kp on kp.id = a.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = a.client_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day )
left join ph_staging.parcel_info pi on pi.pno = a.pno
left join
    (
        select
            a.*
        from pr a
        where
            a.rk2 = 1
    ) a2 on a2.pno = a.pno
left join dwm.dwd_ex_ph_lazada_pno_period la on la.pno = a.pno
left join dwm.dwd_ex_shopee_lost_pno_period sh on sh.pno = a.pno
left join dwm.dwd_ex_ph_tiktok_sla_detail tt on tt.pno = a.pno
left join dwm.dwd_ex_ph_shein_sla_detail ein on ein.pno = a.pno;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        plt2.pno
        ,pcol.created_at
        ,plt2.client_id
        ,plt2.parcel_created_at
        ,plt2.id
        ,group_concat(distinct ss.name) ss_name
    from ph_bi.parcel_cs_operation_log pcol
    left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
    left join ph_bi.parcel_lose_responsible plr on plr.lose_task_id = plt2.id
    left join ph_staging.sys_store ss on ss.id = plr.store_id
    where
        pcol.type = 1
        and pcol.action = 4
        and pcol.operator_id != 10001
        and pcol.created_at >= '2023-07-01'
        and pcol.created_at < '2023-08-01'
    group by 1,2,3,4,5
)
, pr as
(
    select
        t1.*
        ,ddd.EN_element
        ,pr.routed_at
        ,pr.store_name
        ,pr.store_id
        ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk2
    from ph_staging.parcel_route pr
    join t t1 on t1.pno = pr.pno
    join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
    where
        pr.routed_at > '2023-07-01'
)
select
    a.PNO
    ,case
        when bc.client_id is not null then bc.client_name
        when bc.client_id is null and kp.id is not null then 'KA'
        when kp.id is null then 'GE'
    end 客户类型
    ,case
        when a.diff_hour < 24 then '24小时内'
        when a.diff_hour >= 24 and a.diff_hour < 48 then '24-48小时'
        when a.diff_hour >= 48 and a.diff_hour < 72 then '48-72小时'
        when a.diff_hour >= 72 and a.diff_hour < 96 then '72-96小时'
        when a.diff_hour >= 96 and a.diff_hour < 120 then '96-120小时'
        when a.diff_hour >= 120 then '120小时以上'
    end 判责丢失后找回包裹时效
    ,if(pi.cod_enabled = 1, '是', '否') 是否COD
    ,if(pi.state = 5 , datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), a.created_at), null) 判责丢失后几天内投妥成功
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,if(a2.store_name = 'PN5-CS(INVENTORY)', '是', '否') 是否到拍卖场
    ,if(bc.client_name is not null ,
        case
            when bc.client_name = 'lazada' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= la.whole_end_date then '是'
            when bc.client_name = 'shopee' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= sh.end_date then '是'
            when bc.client_name = 'tiktok' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= if( tt.end_7_date is null, tt.end_date, tt.end_7_date) then '是'
            when bc.client_name = 'shein' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= ein.whole_end_date then '是'
            else '否'
        end, null) 是否在丢弃时效前有有效路由
from
    (
        select
            a.*
            ,timestampdiff(hour, a.created_at, convert_tz(a.routed_at, '+00:00', '+08：00')) diff_hour
        from pr a
        where
            a.rk = 1
    ) a
left join ph_staging.ka_profile kp on kp.id = a.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = a.client_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day )
left join ph_staging.parcel_info pi on pi.pno = a.pno
left join
    (
        select
            a.*
        from pr a
        where
            a.rk2 = 1
    ) a2 on a2.pno = a.pno
left join dwm.dwd_ex_ph_lazada_pno_period la on la.pno = a.pno
left join dwm.dwd_ex_shopee_lost_pno_period sh on sh.pno = a.pno
left join dwm.dwd_ex_ph_tiktok_sla_detail tt on tt.pno = a.pno
left join dwm.dwd_ex_ph_shein_sla_detail ein on ein.pno = a.pno;
;-- -. . -..- - / . -. - .-. -.--
select
        plt2.pno
        ,pcol.created_at
        ,plt2.client_id
        ,plt2.parcel_created_at
        ,plt2.id
        ,group_concat(distinct ss.name) ss_name
    from ph_bi.parcel_cs_operation_log pcol
    left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
    left join ph_bi.parcel_lose_responsible plr on plr.lose_task_id = plt2.id
    left join ph_staging.sys_store ss on ss.id = plr.store_id
    where
        pcol.type = 1
        and pcol.action = 4
        and pcol.operator_id != 10001
        and pcol.created_at >= '2023-07-01'
        and pcol.created_at < '2023-08-01'
    group by 1,2,3,4,5;
;-- -. . -..- - / . -. - .-. -.--
select
        plt2.pno
        ,pcol.created_at
        ,plt2.client_id
        ,plt2.parcel_created_at
        ,plt2.id
    from ph_bi.parcel_cs_operation_log pcol
    left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
    left join ph_bi.parcel_lose_responsible plr on plr.lose_task_id = plt2.id
    left join ph_staging.sys_store ss on ss.id = plr.store_id
    where
        pcol.type = 1
        and pcol.action = 4
        and pcol.operator_id != 10001
        and pcol.created_at >= '2023-07-01'
        and pcol.created_at < '2023-08-01';
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        plt2.pno
        ,pcol.created_at
        ,plt2.client_id
        ,plt2.parcel_created_at
        ,plt2.id
    from ph_bi.parcel_cs_operation_log pcol
    left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
    where
        pcol.type = 1
        and pcol.action = 4
        and pcol.operator_id != 10001
        and pcol.created_at >= '2023-07-01'
        and pcol.created_at < '2023-08-01'
)
, pr as
(
    select
        t1.*
        ,ddd.EN_element
        ,pr.routed_at
        ,pr.store_name
        ,pr.store_id
        ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk2
    from ph_staging.parcel_route pr
    join t t1 on t1.pno = pr.pno
    join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
    where
        pr.routed_at > '2023-07-01'
)
select
    a.PNO
    ,case
        when bc.client_id is not null then bc.client_name
        when bc.client_id is null and kp.id is not null then 'KA'
        when kp.id is null then 'GE'
    end 客户类型
    ,case
        when a.diff_hour < 24 then '24小时内'
        when a.diff_hour >= 24 and a.diff_hour < 48 then '24-48小时'
        when a.diff_hour >= 48 and a.diff_hour < 72 then '48-72小时'
        when a.diff_hour >= 72 and a.diff_hour < 96 then '72-96小时'
        when a.diff_hour >= 96 and a.diff_hour < 120 then '96-120小时'
        when a.diff_hour >= 120 then '120小时以上'
    end 判责丢失后找回包裹时效
    ,if(pi.cod_enabled = 1, '是', '否') 是否COD
    ,if(pi.state = 5 , datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), a.created_at), null) 判责丢失后几天内投妥成功
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,if(a2.store_name = 'PN5-CS(INVENTORY)', '是', '否') 是否到拍卖场
    ,if(bc.client_name is not null ,
        case
            when bc.client_name = 'lazada' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= la.whole_end_date then '是'
            when bc.client_name = 'shopee' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= sh.end_date then '是'
            when bc.client_name = 'tiktok' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= if( tt.end_7_date is null, tt.end_date, tt.end_7_date) then '是'
            when bc.client_name = 'shein' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= ein.whole_end_date then '是'
            else '否'
        end, null) 是否在丢弃时效前有有效路由
from
    (
        select
            a.*
            ,timestampdiff(hour, a.created_at, convert_tz(a.routed_at, '+00:00', '+08：00')) diff_hour
        from pr a
        where
            a.rk = 1
    ) a
left join ph_staging.ka_profile kp on kp.id = a.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = a.client_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day )
left join ph_staging.parcel_info pi on pi.pno = a.pno
left join
    (
        select
            a.*
        from pr a
        where
            a.rk2 = 1
    ) a2 on a2.pno = a.pno
left join dwm.dwd_ex_ph_lazada_pno_period la on la.pno = a.pno
left join dwm.dwd_ex_shopee_lost_pno_period sh on sh.pno = a.pno
left join dwm.dwd_ex_ph_tiktok_sla_detail tt on tt.pno = a.pno
left join dwm.dwd_ex_ph_shein_sla_detail ein on ein.pno = a.pno;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        plt2.pno
        ,pcol.created_at
        ,plt2.client_id
        ,plt2.parcel_created_at
        ,plt2.id
    from ph_bi.parcel_cs_operation_log pcol
    left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
    where
        pcol.type = 1
        and pcol.action = 4
        and pcol.operator_id != 10001
        and pcol.created_at >= '2023-07-01'
        and pcol.created_at < '2023-08-01'
)
, pr as
(
    select
        t1.*
        ,ddd.EN_element
        ,pr.routed_at
        ,pr.store_name
        ,pr.store_id
        ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk2
    from ph_staging.parcel_route pr
    join t t1 on t1.pno = pr.pno
    join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
    where
        pr.routed_at > '2023-07-01'
        and pr.routed_at > date_sub(t1.created_at, interval 8 hour )
)
select
    a.PNO
    ,case
        when bc.client_id is not null then bc.client_name
        when bc.client_id is null and kp.id is not null then 'KA'
        when kp.id is null then 'GE'
    end 客户类型
    ,case
        when a.diff_hour < 24 then '24小时内'
        when a.diff_hour >= 24 and a.diff_hour < 48 then '24-48小时'
        when a.diff_hour >= 48 and a.diff_hour < 72 then '48-72小时'
        when a.diff_hour >= 72 and a.diff_hour < 96 then '72-96小时'
        when a.diff_hour >= 96 and a.diff_hour < 120 then '96-120小时'
        when a.diff_hour >= 120 then '120小时以上'
    end 判责丢失后找回包裹时效
    ,if(pi.cod_enabled = 1, '是', '否') 是否COD
    ,if(pi.state = 5 , datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), a.created_at), null) 判责丢失后几天内投妥成功
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,if(a2.store_name = 'PN5-CS(INVENTORY)', '是', '否') 是否到拍卖场
    ,if(bc.client_name is not null ,
        case
            when bc.client_name = 'lazada' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= la.whole_end_date then '是'
            when bc.client_name = 'shopee' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= sh.end_date then '是'
            when bc.client_name = 'tiktok' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= if( tt.end_7_date is null, tt.end_date, tt.end_7_date) then '是'
            when bc.client_name = 'shein' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= ein.whole_end_date then '是'
            else '否'
        end, null) 是否在丢弃时效前有有效路由
from
    (
        select
            a.*
            ,timestampdiff(hour, a.created_at, convert_tz(a.routed_at, '+00:00', '+08：00')) diff_hour
        from pr a
        where
            a.rk = 1
    ) a
left join ph_staging.ka_profile kp on kp.id = a.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = a.client_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day )
left join ph_staging.parcel_info pi on pi.pno = a.pno
left join
    (
        select
            a.*
        from pr a
        where
            a.rk2 = 1
    ) a2 on a2.pno = a.pno
left join dwm.dwd_ex_ph_lazada_pno_period la on la.pno = a.pno
left join dwm.dwd_ex_shopee_lost_pno_period sh on sh.pno = a.pno
left join dwm.dwd_ex_ph_tiktok_sla_detail tt on tt.pno = a.pno
left join dwm.dwd_ex_ph_shein_sla_detail ein on ein.pno = a.pno;
;-- -. . -..- - / . -. - .-. -.--
select
        plt2.pno
        ,pcol.created_at
        ,plt2.client_id
        ,plt2.parcel_created_at
        ,plt2.id
    from ph_bi.parcel_cs_operation_log pcol
    left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
    where
        pcol.type = 1
        and pcol.action = 4
        and pcol.operator_id != 10001
        and pcol.created_at >= '2023-07-01'
        and pcol.created_at < '2023-08-01'
);
;-- -. . -..- - / . -. - .-. -.--
select
        t1.*
        ,ddd.EN_element
        ,pr.routed_at
        ,pr.store_name
        ,pr.store_id
        ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk2
    from ph_staging.parcel_route pr
    join t t1 on t1.pno = pr.pno
    join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
    where
        pr.routed_at > '2023-07-01'
        and pr.routed_at > date_sub(t1.created_at, interval 8 hour );
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        plt2.pno
        ,pcol.created_at
        ,plt2.client_id
        ,plt2.parcel_created_at
        ,plt2.id
    from ph_bi.parcel_cs_operation_log pcol
    left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
    where
        pcol.type = 1
        and pcol.action = 4
        and pcol.operator_id != 10001
        and pcol.created_at >= '2023-07-01'
        and pcol.created_at < '2023-08-01'
)
# , pr as
# (
    select
        t1.*
        ,ddd.EN_element
        ,pr.routed_at
        ,pr.store_name
        ,pr.store_id
        ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk2
    from ph_staging.parcel_route pr
    join t t1 on t1.pno = pr.pno
    join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
    where
        pr.routed_at > '2023-07-01'
        and pr.routed_at > date_sub(t1.created_at, interval 8 hour );
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        plt2.pno
        ,pcol.created_at
        ,plt2.client_id
        ,plt2.parcel_created_at
        ,plt2.id
    from ph_bi.parcel_cs_operation_log pcol
    left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
    where
        pcol.type = 1
        and pcol.action = 4
        and pcol.operator_id != 10001
        and pcol.created_at >= '2023-07-01'
        and pcol.created_at < '2023-08-01'
)
# , pr as
# (
    select
        t1.*
        ,ddd.EN_element
        ,pr.routed_at
        ,pr.store_name
        ,pr.store_id
        ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk2
    from ph_staging.parcel_route pr
    join t t1 on t1.pno = pr.pno
    join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
    where
        pr.routed_at > date_sub(t1.created_at, interval 8 hour );
;-- -. . -..- - / . -. - .-. -.--
select
        plt2.pno
        ,pcol.created_at
        ,plt2.client_id
        ,plt2.parcel_created_at
        ,plt2.id
    from ph_bi.parcel_cs_operation_log pcol
    left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
    where
        pcol.type = 1
        and pcol.action = 4
        and pcol.operator_id != 10001
        and pcol.created_at >= '2023-07-01'
        and pcol.created_at < '2023-08-01';
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        plt2.pno
        ,convert_tz(pcol.created_at, '+08:00', '+00:00') created_time
        ,plt2.client_id
        ,plt2.parcel_created_at
        ,plt2.id
    from ph_bi.parcel_cs_operation_log pcol
    left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
    where
        pcol.type = 1
        and pcol.action = 4
        and pcol.operator_id != 10001
        and pcol.created_at >= '2023-07-01'
        and pcol.created_at < '2023-08-01'
)
# , pr as
# (
    select
        t1.*
        ,ddd.EN_element
        ,pr.routed_at
        ,pr.store_name
        ,pr.store_id
        ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk2
    from ph_staging.parcel_route pr
    join t t1 on t1.pno = pr.pno
    join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
    where
        pr.routed_at > t1.created_time;
;-- -. . -..- - / . -. - .-. -.--
select
        plt2.pno
        ,convert_tz(pcol.created_at, '+08:00', '+00:00') created_time
        ,plt2.client_id
        ,plt2.parcel_created_at
        ,plt2.id
    from ph_bi.parcel_cs_operation_log pcol
    left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
    where
        pcol.type = 1
        and pcol.action = 4
        and pcol.operator_id != 10001
        and pcol.created_at >= '2023-07-01'
        and pcol.created_at < '2023-08-01';
;-- -. . -..- - / . -. - .-. -.--
with
#     t as
# (
#     select
#         plt2.pno
#         ,convert_tz(pcol.created_at, '+08:00', '+00:00') created_time
#         ,plt2.client_id
#         ,plt2.parcel_created_at
#         ,plt2.id
#     from ph_bi.parcel_cs_operation_log pcol
#     left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
#     where
#         pcol.type = 1
#         and pcol.action = 4
#         and pcol.operator_id != 10001
#         and pcol.created_at >= '2023-07-01'
#         and pcol.created_at < '2023-08-01'
# )
# ,
    pr as
(
    select
        t1.*
        ,ddd.EN_element
        ,pr.routed_at
        ,pr.store_name
        ,pr.store_id
        ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk2
    from ph_staging.parcel_route pr
    join tmpale.tmp_ph_pno_0825 t1 on t1.pno = pr.pno
    join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
    where
        pr.routed_at > t1.created_time
)
select
    a.PNO
    ,case
        when bc.client_id is not null then bc.client_name
        when bc.client_id is null and kp.id is not null then 'KA'
        when kp.id is null then 'GE'
    end 客户类型
    ,case
        when a.diff_hour < 24 then '24小时内'
        when a.diff_hour >= 24 and a.diff_hour < 48 then '24-48小时'
        when a.diff_hour >= 48 and a.diff_hour < 72 then '48-72小时'
        when a.diff_hour >= 72 and a.diff_hour < 96 then '72-96小时'
        when a.diff_hour >= 96 and a.diff_hour < 120 then '96-120小时'
        when a.diff_hour >= 120 then '120小时以上'
    end 判责丢失后找回包裹时效
    ,if(pi.cod_enabled = 1, '是', '否') 是否COD
    ,if(pi.state = 5 , datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), a.created_at), null) 判责丢失后几天内投妥成功
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,if(a2.store_name = 'PN5-CS(INVENTORY)', '是', '否') 是否到拍卖场
    ,if(bc.client_name is not null ,
        case
            when bc.client_name = 'lazada' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= la.whole_end_date then '是'
            when bc.client_name = 'shopee' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= sh.end_date then '是'
            when bc.client_name = 'tiktok' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= if( tt.end_7_date is null, tt.end_date, tt.end_7_date) then '是'
            when bc.client_name = 'shein' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= ein.whole_end_date then '是'
            else '否'
        end, null) 是否在丢弃时效前有有效路由
from
    (
        select
            a.*
            ,timestampdiff(hour, a.created_at, convert_tz(a.routed_at, '+00:00', '+08：00')) diff_hour
        from pr a
        where
            a.rk = 1
    ) a
left join ph_staging.ka_profile kp on kp.id = a.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = a.client_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day )
left join ph_staging.parcel_info pi on pi.pno = a.pno
left join
    (
        select
            a.*
        from pr a
        where
            a.rk2 = 1
    ) a2 on a2.pno = a.pno
left join dwm.dwd_ex_ph_lazada_pno_period la on la.pno = a.pno
left join dwm.dwd_ex_shopee_lost_pno_period sh on sh.pno = a.pno
left join dwm.dwd_ex_ph_tiktok_sla_detail tt on tt.pno = a.pno
left join dwm.dwd_ex_ph_shein_sla_detail ein on ein.pno = a.pno;
;-- -. . -..- - / . -. - .-. -.--
select
        plt2.pno
        ,pcol.created_at
        ,convert_tz(pcol.created_at, '+08:00', '+00:00') created_time
        ,plt2.client_id
        ,plt2.parcel_created_at
        ,plt2.id
    from ph_bi.parcel_cs_operation_log pcol
    left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
    where
        pcol.type = 1
        and pcol.action = 4
        and pcol.operator_id != 10001
        and pcol.created_at >= '2023-07-01'
        and pcol.created_at < '2023-08-01';
;-- -. . -..- - / . -. - .-. -.--
with
#     t as
# (
#     select
#         plt2.pno
#         ,pcol.created_at
#         ,convert_tz(pcol.created_at, '+08:00', '+00:00') created_time
#         ,plt2.client_id
#         ,plt2.parcel_created_at
#         ,plt2.id
#     from ph_bi.parcel_cs_operation_log pcol
#     left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
#     where
#         pcol.type = 1
#         and pcol.action = 4
#         and pcol.operator_id != 10001
#         and pcol.created_at >= '2023-07-01'
#         and pcol.created_at < '2023-08-01'
# )
# ,
    pr as
(
    select
        t1.*
        ,ddd.EN_element
        ,pr.routed_at
        ,pr.store_name
        ,pr.store_id
        ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk2
    from ph_staging.parcel_route pr
    join tmpale.tmp_ph_pno_0825 t1 on t1.pno = pr.pno
    join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
    where
        pr.routed_at > t1.created_time
)
select
    a.PNO
    ,case
        when bc.client_id is not null then bc.client_name
        when bc.client_id is null and kp.id is not null then 'KA'
        when kp.id is null then 'GE'
    end 客户类型
    ,case
        when a.diff_hour < 24 then '24小时内'
        when a.diff_hour >= 24 and a.diff_hour < 48 then '24-48小时'
        when a.diff_hour >= 48 and a.diff_hour < 72 then '48-72小时'
        when a.diff_hour >= 72 and a.diff_hour < 96 then '72-96小时'
        when a.diff_hour >= 96 and a.diff_hour < 120 then '96-120小时'
        when a.diff_hour >= 120 then '120小时以上'
    end 判责丢失后找回包裹时效
    ,if(pi.cod_enabled = 1, '是', '否') 是否COD
    ,if(pi.state = 5 , datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), a.created_at), null) 判责丢失后几天内投妥成功
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,if(a2.store_name = 'PN5-CS(INVENTORY)', '是', '否') 是否到拍卖场
    ,if(bc.client_name is not null ,
        case
            when bc.client_name = 'lazada' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= la.whole_end_date then '是'
            when bc.client_name = 'shopee' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= sh.end_date then '是'
            when bc.client_name = 'tiktok' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= if( tt.end_7_date is null, tt.end_date, tt.end_7_date) then '是'
            when bc.client_name = 'shein' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= ein.whole_end_date then '是'
            else '否'
        end, null) 是否在丢弃时效前有有效路由
from
    (
        select
            a.*
            ,timestampdiff(hour, a.created_at, convert_tz(a.routed_at, '+00:00', '+08：00')) diff_hour
        from pr a
        where
            a.rk = 1
    ) a
left join ph_staging.ka_profile kp on kp.id = a.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = a.client_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day )
left join ph_staging.parcel_info pi on pi.pno = a.pno
left join
    (
        select
            a.*
        from pr a
        where
            a.rk2 = 1
    ) a2 on a2.pno = a.pno
left join dwm.dwd_ex_ph_lazada_pno_period la on la.pno = a.pno
left join dwm.dwd_ex_shopee_lost_pno_period sh on sh.pno = a.pno
left join dwm.dwd_ex_ph_tiktok_sla_detail tt on tt.pno = a.pno
left join dwm.dwd_ex_ph_shein_sla_detail ein on ein.pno = a.pno;
;-- -. . -..- - / . -. - .-. -.--
select
        t1.*
        ,ddd.EN_element
        ,pr.routed_at
        ,pr.store_name
        ,pr.store_id
        ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk2
    from ph_staging.parcel_route pr
    join tmpale.tmp_ph_pno_0825 t1 on t1.pno = pr.pno
    join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
    where
        pr.routed_at > t1.created_time;
;-- -. . -..- - / . -. - .-. -.--
with
    t as
(
    select
        plt2.pno
        ,pcol.created_at
        ,convert_tz(pcol.created_at, '+08:00', '+00:00') created_time
        ,plt2.client_id
        ,plt2.parcel_created_at
        ,plt2.id
    from ph_bi.parcel_cs_operation_log pcol
    left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
    where
        pcol.type = 1
        and pcol.action = 4
        and pcol.operator_id != 10001
        and pcol.created_at >= '2023-07-01'
        and pcol.created_at < '2023-07-11'
)
,
    pr as
(
    select
        t1.*
        ,ddd.EN_element
        ,pr.routed_at
        ,pr.store_name
        ,pr.store_id
        ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk2
    from ph_staging.parcel_route pr
    join t t1 on t1.pno = pr.pno
    join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
    where
        pr.routed_at > t1.created_time
)
select
    a.PNO
    ,case
        when bc.client_id is not null then bc.client_name
        when bc.client_id is null and kp.id is not null then 'KA'
        when kp.id is null then 'GE'
    end 客户类型
    ,case
        when a.diff_hour < 24 then '24小时内'
        when a.diff_hour >= 24 and a.diff_hour < 48 then '24-48小时'
        when a.diff_hour >= 48 and a.diff_hour < 72 then '48-72小时'
        when a.diff_hour >= 72 and a.diff_hour < 96 then '72-96小时'
        when a.diff_hour >= 96 and a.diff_hour < 120 then '96-120小时'
        when a.diff_hour >= 120 then '120小时以上'
    end 判责丢失后找回包裹时效
    ,if(pi.cod_enabled = 1, '是', '否') 是否COD
    ,if(pi.state = 5 , datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), a.created_at), null) 判责丢失后几天内投妥成功
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,if(a2.store_name = 'PN5-CS(INVENTORY)', '是', '否') 是否到拍卖场
    ,if(bc.client_name is not null ,
        case
            when bc.client_name = 'lazada' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= la.whole_end_date then '是'
            when bc.client_name = 'shopee' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= sh.end_date then '是'
            when bc.client_name = 'tiktok' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= if( tt.end_7_date is null, tt.end_date, tt.end_7_date) then '是'
            when bc.client_name = 'shein' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= ein.whole_end_date then '是'
            else '否'
        end, null) 是否在丢弃时效前有有效路由
from
    (
        select
            a.*
            ,timestampdiff(hour, a.created_at, convert_tz(a.routed_at, '+00:00', '+08：00')) diff_hour
        from pr a
        where
            a.rk = 1
    ) a
left join ph_staging.ka_profile kp on kp.id = a.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = a.client_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day )
left join ph_staging.parcel_info pi on pi.pno = a.pno
left join
    (
        select
            a.*
        from pr a
        where
            a.rk2 = 1
    ) a2 on a2.pno = a.pno
left join dwm.dwd_ex_ph_lazada_pno_period la on la.pno = a.pno
left join dwm.dwd_ex_shopee_lost_pno_period sh on sh.pno = a.pno
left join dwm.dwd_ex_ph_tiktok_sla_detail tt on tt.pno = a.pno
left join dwm.dwd_ex_ph_shein_sla_detail ein on ein.pno = a.pno;
;-- -. . -..- - / . -. - .-. -.--
with
    t as
(
    select
        plt2.pno
        ,pcol.created_at
        ,convert_tz(pcol.created_at, '+08:00', '+00:00') created_time
        ,plt2.client_id
        ,plt2.parcel_created_at
        ,plt2.id
    from ph_bi.parcel_cs_operation_log pcol
    left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
    where
        pcol.type = 1
        and pcol.action = 4
        and pcol.operator_id != 10001
        and pcol.created_at >= '2023-07-01'
        and pcol.created_at < '2023-07-06'
)
,
    pr as
(
    select
        t1.*
        ,ddd.EN_element
        ,pr.routed_at
        ,pr.store_name
        ,pr.store_id
        ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk2
    from ph_staging.parcel_route pr
    join t t1 on t1.pno = pr.pno
    join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
    where
        pr.routed_at > t1.created_time
)
select
    a.PNO
    ,case
        when bc.client_id is not null then bc.client_name
        when bc.client_id is null and kp.id is not null then 'KA'
        when kp.id is null then 'GE'
    end 客户类型
    ,case
        when a.diff_hour < 24 then '24小时内'
        when a.diff_hour >= 24 and a.diff_hour < 48 then '24-48小时'
        when a.diff_hour >= 48 and a.diff_hour < 72 then '48-72小时'
        when a.diff_hour >= 72 and a.diff_hour < 96 then '72-96小时'
        when a.diff_hour >= 96 and a.diff_hour < 120 then '96-120小时'
        when a.diff_hour >= 120 then '120小时以上'
    end 判责丢失后找回包裹时效
    ,if(pi.cod_enabled = 1, '是', '否') 是否COD
    ,if(pi.state = 5 , datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), a.created_at), null) 判责丢失后几天内投妥成功
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,if(a2.store_name = 'PN5-CS(INVENTORY)', '是', '否') 是否到拍卖场
    ,if(bc.client_name is not null ,
        case
            when bc.client_name = 'lazada' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= la.whole_end_date then '是'
            when bc.client_name = 'shopee' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= sh.end_date then '是'
            when bc.client_name = 'tiktok' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= if( tt.end_7_date is null, tt.end_date, tt.end_7_date) then '是'
            when bc.client_name = 'shein' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= ein.whole_end_date then '是'
            else '否'
        end, null) 是否在丢弃时效前有有效路由
from
    (
        select
            a.*
            ,timestampdiff(hour, a.created_at, convert_tz(a.routed_at, '+00:00', '+08：00')) diff_hour
        from pr a
        where
            a.rk = 1
    ) a
left join ph_staging.ka_profile kp on kp.id = a.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = a.client_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day )
left join ph_staging.parcel_info pi on pi.pno = a.pno
left join
    (
        select
            a.*
        from pr a
        where
            a.rk2 = 1
    ) a2 on a2.pno = a.pno
left join dwm.dwd_ex_ph_lazada_pno_period la on la.pno = a.pno
left join dwm.dwd_ex_shopee_lost_pno_period sh on sh.pno = a.pno
left join dwm.dwd_ex_ph_tiktok_sla_detail tt on tt.pno = a.pno
left join dwm.dwd_ex_ph_shein_sla_detail ein on ein.pno = a.pno;
;-- -. . -..- - / . -. - .-. -.--
select
        plt2.pno
        ,pcol.created_at
        ,convert_tz(pcol.created_at, '+08:00', '+00:00') created_time
        ,plt2.client_id
        ,plt2.parcel_created_at
        ,plt2.id
    from ph_bi.parcel_cs_operation_log pcol
    left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
    where
        pcol.type = 1
        and pcol.action = 4
        and pcol.operator_id != 10001
        and pcol.created_at >= '2023-07-01'
        and pcol.created_at < '2023-07-06';
;-- -. . -..- - / . -. - .-. -.--
with
    t as
(
    select
        plt2.pno
        ,pcol.created_at
        ,convert_tz(pcol.created_at, '+08:00', '+00:00') created_time
        ,plt2.client_id
        ,plt2.parcel_created_at
        ,plt2.id
    from ph_bi.parcel_cs_operation_log pcol
    left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
    where
        pcol.type = 1
        and pcol.action = 4
        and pcol.operator_id != 10001
        and pcol.created_at >= '2023-07-01'
        and pcol.created_at < '2023-07-04'
)
,
    pr as
(
    select
        t1.*
        ,ddd.EN_element
        ,pr.routed_at
        ,pr.store_name
        ,pr.store_id
        ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk2
    from ph_staging.parcel_route pr
    join t t1 on t1.pno = pr.pno
    join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
    where
        pr.routed_at > t1.created_time
)
select
    a.PNO
    ,case
        when bc.client_id is not null then bc.client_name
        when bc.client_id is null and kp.id is not null then 'KA'
        when kp.id is null then 'GE'
    end 客户类型
    ,case
        when a.diff_hour < 24 then '24小时内'
        when a.diff_hour >= 24 and a.diff_hour < 48 then '24-48小时'
        when a.diff_hour >= 48 and a.diff_hour < 72 then '48-72小时'
        when a.diff_hour >= 72 and a.diff_hour < 96 then '72-96小时'
        when a.diff_hour >= 96 and a.diff_hour < 120 then '96-120小时'
        when a.diff_hour >= 120 then '120小时以上'
    end 判责丢失后找回包裹时效
    ,if(pi.cod_enabled = 1, '是', '否') 是否COD
    ,if(pi.state = 5 , datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), a.created_at), null) 判责丢失后几天内投妥成功
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,if(a2.store_name = 'PN5-CS(INVENTORY)', '是', '否') 是否到拍卖场
    ,if(bc.client_name is not null ,
        case
            when bc.client_name = 'lazada' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= la.whole_end_date then '是'
            when bc.client_name = 'shopee' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= sh.end_date then '是'
            when bc.client_name = 'tiktok' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= if( tt.end_7_date is null, tt.end_date, tt.end_7_date) then '是'
            when bc.client_name = 'shein' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= ein.whole_end_date then '是'
            else '否'
        end, null) 是否在丢弃时效前有有效路由
from
    (
        select
            a.*
            ,timestampdiff(hour, a.created_at, convert_tz(a.routed_at, '+00:00', '+08：00')) diff_hour
        from pr a
        where
            a.rk = 1
    ) a
left join ph_staging.ka_profile kp on kp.id = a.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = a.client_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day )
left join ph_staging.parcel_info pi on pi.pno = a.pno
left join
    (
        select
            a.*
        from pr a
        where
            a.rk2 = 1
    ) a2 on a2.pno = a.pno
left join dwm.dwd_ex_ph_lazada_pno_period la on la.pno = a.pno
left join dwm.dwd_ex_shopee_lost_pno_period sh on sh.pno = a.pno
left join dwm.dwd_ex_ph_tiktok_sla_detail tt on tt.pno = a.pno
left join dwm.dwd_ex_ph_shein_sla_detail ein on ein.pno = a.pno;
;-- -. . -..- - / . -. - .-. -.--
with
    t as
(
    select
        plt2.pno
        ,pcol.created_at
        ,convert_tz(pcol.created_at, '+08:00', '+00:00') created_time
        ,plt2.client_id
        ,plt2.parcel_created_at
        ,plt2.id
    from ph_bi.parcel_cs_operation_log pcol
    left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
    where
        pcol.type = 1
        and pcol.action = 4
        and pcol.operator_id != 10001
        and pcol.created_at >= '2023-07-01'
        and pcol.created_at < '2023-07-02'
)
,
    pr as
(
    select
        t1.*
        ,ddd.EN_element
        ,pr.routed_at
        ,pr.store_name
        ,pr.store_id
        ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk2
    from ph_staging.parcel_route pr
    join t t1 on t1.pno = pr.pno
    join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
    where
        pr.routed_at > t1.created_time
)
select
    a.PNO
    ,case
        when bc.client_id is not null then bc.client_name
        when bc.client_id is null and kp.id is not null then 'KA'
        when kp.id is null then 'GE'
    end 客户类型
    ,case
        when a.diff_hour < 24 then '24小时内'
        when a.diff_hour >= 24 and a.diff_hour < 48 then '24-48小时'
        when a.diff_hour >= 48 and a.diff_hour < 72 then '48-72小时'
        when a.diff_hour >= 72 and a.diff_hour < 96 then '72-96小时'
        when a.diff_hour >= 96 and a.diff_hour < 120 then '96-120小时'
        when a.diff_hour >= 120 then '120小时以上'
    end 判责丢失后找回包裹时效
    ,if(pi.cod_enabled = 1, '是', '否') 是否COD
    ,if(pi.state = 5 , datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), a.created_at), null) 判责丢失后几天内投妥成功
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,if(a2.store_name = 'PN5-CS(INVENTORY)', '是', '否') 是否到拍卖场
    ,if(bc.client_name is not null ,
        case
            when bc.client_name = 'lazada' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= la.whole_end_date then '是'
            when bc.client_name = 'shopee' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= sh.end_date then '是'
            when bc.client_name = 'tiktok' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= if( tt.end_7_date is null, tt.end_date, tt.end_7_date) then '是'
            when bc.client_name = 'shein' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= ein.whole_end_date then '是'
            else '否'
        end, null) 是否在丢弃时效前有有效路由
from
    (
        select
            a.*
            ,timestampdiff(hour, a.created_at, convert_tz(a.routed_at, '+00:00', '+08：00')) diff_hour
        from pr a
        where
            a.rk = 1
    ) a
left join ph_staging.ka_profile kp on kp.id = a.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = a.client_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day )
left join ph_staging.parcel_info pi on pi.pno = a.pno
left join
    (
        select
            a.*
        from pr a
        where
            a.rk2 = 1
    ) a2 on a2.pno = a.pno
left join dwm.dwd_ex_ph_lazada_pno_period la on la.pno = a.pno
left join dwm.dwd_ex_shopee_lost_pno_period sh on sh.pno = a.pno
left join dwm.dwd_ex_ph_tiktok_sla_detail tt on tt.pno = a.pno
left join dwm.dwd_ex_ph_shein_sla_detail ein on ein.pno = a.pno;
;-- -. . -..- - / . -. - .-. -.--
with
    t as
(
    select
        plt2.pno
        ,pcol.created_at
        ,convert_tz(pcol.created_at, '+08:00', '+00:00') created_time
        ,plt2.client_id
        ,plt2.parcel_created_at
        ,plt2.id
    from ph_bi.parcel_cs_operation_log pcol
    left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
    where
        pcol.type = 1
        and pcol.action = 4
        and pcol.operator_id != 10001
        and pcol.created_at >= '2023-07-01'
        and pcol.created_at < '2023-07-02'
)
# ,
#     pr as
# (
    select
        t1.*
        ,ddd.EN_element
        ,pr.routed_at
        ,pr.store_name
        ,pr.store_id
        ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk2
    from ph_staging.parcel_route pr
    join t t1 on t1.pno = pr.pno
    join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
    where
        pr.routed_at > t1.created_time;
;-- -. . -..- - / . -. - .-. -.--
with
    t as
(
    select
        plt2.pno
        ,pcol.created_at
        ,convert_tz(pcol.created_at, '+08:00', '+00:00') created_time
        ,plt2.client_id
        ,plt2.parcel_created_at
        ,plt2.id
    from ph_bi.parcel_cs_operation_log pcol
    left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
    where
        pcol.type = 1
        and pcol.action = 4
        and pcol.operator_id != 10001
        and pcol.created_at >= '2023-07-01'
        and pcol.created_at < '2023-07-02'
)
# ,
#     pr as
# (
    select
        t1.*
        ,ddd.EN_element
        ,pr.routed_at
        ,pr.store_name
        ,pr.store_id
        ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk2
    from ph_staging.parcel_route pr
    join t t1 on t1.pno = pr.pno
#     join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
    where
        pr.routed_at > t1.created_time
        and pr.route_action in ('SORTING_SCAN','DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE','DISTRIBUTION_INVENTORY','DELIVERY_TICKET_CREATION_SCAN','ARRIVAL_WAREHOUSE_SCAN','SHIPMENT_WAREHOUSE_SCAN','STAFF_INFO_UPDATE_WEIGHT','DELIVERY_CONFIRM','ACCEPT_PARCEL','REPLACE_PNO','UNSEAL','STORE_SORTER_UPDATE_WEIGHT','RECEIVED','PARCEL_HEADLESS_PRINTED','SEAL','DIFFICULTY_HANDOVER','DETAIN_WAREHOUSE','REFUND_CONFIRM','FLASH_HOME_SCAN','RECEIVE_WAREHOUSE_SCAN','PICKUP_RETURN_RECEIPT','STORE_KEEPER_UPDATE_WEIGHT','INVENTORY','DELIVERY_TRANSFER','DELIVERY_MARKER','DISCARD_RETURN_BKK','DELIVERY_PICKUP_STORE_SCAN');
;-- -. . -..- - / . -. - .-. -.--
with
    t as
(
    select
        plt2.pno
        ,pcol.created_at
        ,convert_tz(pcol.created_at, '+08:00', '+00:00') created_time
        ,plt2.client_id
        ,plt2.parcel_created_at
        ,plt2.id
    from ph_bi.parcel_cs_operation_log pcol
    left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
    where
        pcol.type = 1
        and pcol.action = 4
        and pcol.operator_id != 10001
        and pcol.created_at >= '2023-07-01'
        and pcol.created_at < '2023-07-02'
)
# ,
#     pr as
# (
    select
        t1.*
        ,pr.route_action
        ,pr.routed_at
        ,pr.store_name
        ,pr.store_id
        ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk2
    from ph_staging.parcel_route pr
    join t t1 on t1.pno = pr.pno
#     join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
    where
        pr.routed_at > t1.created_time
        and pr.route_action in ('SORTING_SCAN','DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE','DISTRIBUTION_INVENTORY','DELIVERY_TICKET_CREATION_SCAN','ARRIVAL_WAREHOUSE_SCAN','SHIPMENT_WAREHOUSE_SCAN','STAFF_INFO_UPDATE_WEIGHT','DELIVERY_CONFIRM','ACCEPT_PARCEL','REPLACE_PNO','UNSEAL','STORE_SORTER_UPDATE_WEIGHT','RECEIVED','PARCEL_HEADLESS_PRINTED','SEAL','DIFFICULTY_HANDOVER','DETAIN_WAREHOUSE','REFUND_CONFIRM','FLASH_HOME_SCAN','RECEIVE_WAREHOUSE_SCAN','PICKUP_RETURN_RECEIPT','STORE_KEEPER_UPDATE_WEIGHT','INVENTORY','DELIVERY_TRANSFER','DELIVERY_MARKER','DISCARD_RETURN_BKK','DELIVERY_PICKUP_STORE_SCAN');
;-- -. . -..- - / . -. - .-. -.--
with
    t as
(
    select
        plt2.pno
        ,pcol.created_at
        ,convert_tz(pcol.created_at, '+08:00', '+00:00') created_time
        ,plt2.client_id
        ,plt2.parcel_created_at
        ,plt2.id
    from ph_bi.parcel_cs_operation_log pcol
    left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
    where
        pcol.type = 1
        and pcol.action = 4
        and pcol.operator_id != 10001
        and pcol.created_at >= '2023-07-01'
        and pcol.created_at < '2023-07-02'
)
,
    pr as
(
    select
        t1.*
        ,pr.route_action
        ,pr.routed_at
        ,pr.store_name
        ,pr.store_id
        ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk2
    from ph_staging.parcel_route pr
    join t t1 on t1.pno = pr.pno
#     join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
    where
        pr.routed_at > t1.created_time
        and pr.route_action in ('SORTING_SCAN','DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE','DISTRIBUTION_INVENTORY','DELIVERY_TICKET_CREATION_SCAN','ARRIVAL_WAREHOUSE_SCAN','SHIPMENT_WAREHOUSE_SCAN','STAFF_INFO_UPDATE_WEIGHT','DELIVERY_CONFIRM','ACCEPT_PARCEL','REPLACE_PNO','UNSEAL','STORE_SORTER_UPDATE_WEIGHT','RECEIVED','PARCEL_HEADLESS_PRINTED','SEAL','DIFFICULTY_HANDOVER','DETAIN_WAREHOUSE','REFUND_CONFIRM','FLASH_HOME_SCAN','RECEIVE_WAREHOUSE_SCAN','PICKUP_RETURN_RECEIPT','STORE_KEEPER_UPDATE_WEIGHT','INVENTORY','DELIVERY_TRANSFER','DELIVERY_MARKER','DISCARD_RETURN_BKK','DELIVERY_PICKUP_STORE_SCAN')
)
select
    a.PNO
    ,case
        when bc.client_id is not null then bc.client_name
        when bc.client_id is null and kp.id is not null then 'KA'
        when kp.id is null then 'GE'
    end 客户类型
    ,case
        when a.diff_hour < 24 then '24小时内'
        when a.diff_hour >= 24 and a.diff_hour < 48 then '24-48小时'
        when a.diff_hour >= 48 and a.diff_hour < 72 then '48-72小时'
        when a.diff_hour >= 72 and a.diff_hour < 96 then '72-96小时'
        when a.diff_hour >= 96 and a.diff_hour < 120 then '96-120小时'
        when a.diff_hour >= 120 then '120小时以上'
    end 判责丢失后找回包裹时效
    ,if(pi.cod_enabled = 1, '是', '否') 是否COD
    ,if(pi.state = 5 , datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), a.created_at), null) 判责丢失后几天内投妥成功
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,if(a2.store_name = 'PN5-CS(INVENTORY)', '是', '否') 是否到拍卖场
    ,if(bc.client_name is not null ,
        case
            when bc.client_name = 'lazada' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= la.whole_end_date then '是'
            when bc.client_name = 'shopee' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= sh.end_date then '是'
            when bc.client_name = 'tiktok' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= if( tt.end_7_date is null, tt.end_date, tt.end_7_date) then '是'
            when bc.client_name = 'shein' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= ein.whole_end_date then '是'
            else '否'
        end, null) 是否在丢弃时效前有有效路由
from
    (
        select
            a.*
            ,timestampdiff(hour, a.created_at, convert_tz(a.routed_at, '+00:00', '+08：00')) diff_hour
        from pr a
        where
            a.rk = 1
    ) a
left join ph_staging.ka_profile kp on kp.id = a.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = a.client_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day )
left join ph_staging.parcel_info pi on pi.pno = a.pno
left join
    (
        select
            a.*
        from pr a
        where
            a.rk2 = 1
    ) a2 on a2.pno = a.pno
left join dwm.dwd_ex_ph_lazada_pno_period la on la.pno = a.pno
left join dwm.dwd_ex_shopee_lost_pno_period sh on sh.pno = a.pno
left join dwm.dwd_ex_ph_tiktok_sla_detail tt on tt.pno = a.pno
left join dwm.dwd_ex_ph_shein_sla_detail ein on ein.pno = a.pno;
;-- -. . -..- - / . -. - .-. -.--
with
    t as
(
    select
        plt2.pno
        ,pcol.created_at
        ,convert_tz(pcol.created_at, '+08:00', '+00:00') created_time
        ,plt2.client_id
        ,plt2.parcel_created_at
        ,plt2.id
    from ph_bi.parcel_cs_operation_log pcol
    left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
    where
        pcol.type = 1
        and pcol.action = 4
        and pcol.operator_id != 10001
        and pcol.created_at >= '2023-07-01'
        and pcol.created_at < '2023-07-02'
)
,
    pr as
(
    select
        t1.*
        ,pr.route_action
        ,pr.routed_at
        ,pr.store_name
        ,pr.store_id
        ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk2
    from ph_staging.parcel_route pr
    join t t1 on t1.pno = pr.pno
#     join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
    where
        pr.routed_at > t1.created_time
        and pr.route_action in ('SORTING_SCAN','DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE','DISTRIBUTION_INVENTORY','DELIVERY_TICKET_CREATION_SCAN','ARRIVAL_WAREHOUSE_SCAN','SHIPMENT_WAREHOUSE_SCAN','STAFF_INFO_UPDATE_WEIGHT','DELIVERY_CONFIRM','ACCEPT_PARCEL','REPLACE_PNO','UNSEAL','STORE_SORTER_UPDATE_WEIGHT','RECEIVED','PARCEL_HEADLESS_PRINTED','SEAL','DIFFICULTY_HANDOVER','DETAIN_WAREHOUSE','REFUND_CONFIRM','FLASH_HOME_SCAN','RECEIVE_WAREHOUSE_SCAN','PICKUP_RETURN_RECEIPT','STORE_KEEPER_UPDATE_WEIGHT','INVENTORY','DELIVERY_TRANSFER','DELIVERY_MARKER','DISCARD_RETURN_BKK','DELIVERY_PICKUP_STORE_SCAN')
)
select
    a.PNO
    ,case
        when bc.client_id is not null then bc.client_name
        when bc.client_id is null and kp.id is not null then 'KA'
        when kp.id is null then 'GE'
    end 客户类型
    ,case
        when a.diff_hour < 24 then '24小时内'
        when a.diff_hour >= 24 and a.diff_hour < 48 then '24-48小时'
        when a.diff_hour >= 48 and a.diff_hour < 72 then '48-72小时'
        when a.diff_hour >= 72 and a.diff_hour < 96 then '72-96小时'
        when a.diff_hour >= 96 and a.diff_hour < 120 then '96-120小时'
        when a.diff_hour >= 120 then '120小时以上'
    end 判责丢失后找回包裹时效
    ,if(pi.cod_enabled = 1, '是', '否') 是否COD
    ,if(pi.state = 5 , datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), a.created_at), null) 判责丢失后几天内投妥成功
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,if(a2.store_name = 'PN5-CS(INVENTORY)', '是', '否') 是否到拍卖场
    ,if(bc.client_name is not null ,
        case
            when bc.client_name = 'lazada' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= la.whole_end_date then '是'
            when bc.client_name = 'shopee' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= sh.end_date then '是'
            when bc.client_name = 'tiktok' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= if( tt.end_7_date is null, tt.end_date, tt.end_7_date) then '是'
            when bc.client_name = 'shein' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= ein.whole_end_date then '是'
            else '否'
        end, null) 是否在丢弃时效前有有效路由
from
    (
        select
            a.*
            ,timestampdiff(hour, a.created_at, convert_tz(a.routed_at, '+00:00', '+08:00')) diff_hour
        from pr a
        where
            a.rk = 1
    ) a
left join ph_staging.ka_profile kp on kp.id = a.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = a.client_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day )
left join ph_staging.parcel_info pi on pi.pno = a.pno
left join
    (
        select
            a.*
        from pr a
        where
            a.rk2 = 1
    ) a2 on a2.pno = a.pno
left join dwm.dwd_ex_ph_lazada_pno_period la on la.pno = a.pno
left join dwm.dwd_ex_shopee_lost_pno_period sh on sh.pno = a.pno
left join dwm.dwd_ex_ph_tiktok_sla_detail tt on tt.pno = a.pno
left join dwm.dwd_ex_ph_shein_sla_detail ein on ein.pno = a.pno;
;-- -. . -..- - / . -. - .-. -.--
select
        plt2.pno
        ,pcol.created_at
        ,convert_tz(pcol.created_at, '+08:00', '+00:00') created_time
        ,plt2.client_id
        ,plt2.parcel_created_at
        ,plt2.id
    from ph_bi.parcel_cs_operation_log pcol
    left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
    where
        pcol.type = 1
        and pcol.action = 4
        and pcol.operator_id != 10001
        and pcol.created_at >= '2023-07-01'
        and pcol.created_at < '2023-07-02';
;-- -. . -..- - / . -. - .-. -.--
with
    t as
(
    select
        plt2.pno
        ,pcol.created_at
        ,convert_tz(pcol.created_at, '+08:00', '+00:00') created_time
        ,plt2.client_id
        ,plt2.parcel_created_at
        ,plt2.id
    from ph_bi.parcel_cs_operation_log pcol
    left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
    where
        pcol.type = 1
        and pcol.action = 4
        and pcol.operator_id != 10001
        and pcol.created_at >= '2023-07-02'
        and pcol.created_at < '2023-08-01'
)
,
    pr as
(
    select
        t1.*
        ,pr.route_action
        ,pr.routed_at
        ,pr.store_name
        ,pr.store_id
        ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk2
    from ph_staging.parcel_route pr
    join t t1 on t1.pno = pr.pno
#     join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
    where
        pr.routed_at > t1.created_time
        and pr.route_action in ('SORTING_SCAN','DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE','DISTRIBUTION_INVENTORY','DELIVERY_TICKET_CREATION_SCAN','ARRIVAL_WAREHOUSE_SCAN','SHIPMENT_WAREHOUSE_SCAN','STAFF_INFO_UPDATE_WEIGHT','DELIVERY_CONFIRM','ACCEPT_PARCEL','REPLACE_PNO','UNSEAL','STORE_SORTER_UPDATE_WEIGHT','RECEIVED','PARCEL_HEADLESS_PRINTED','SEAL','DIFFICULTY_HANDOVER','DETAIN_WAREHOUSE','REFUND_CONFIRM','FLASH_HOME_SCAN','RECEIVE_WAREHOUSE_SCAN','PICKUP_RETURN_RECEIPT','STORE_KEEPER_UPDATE_WEIGHT','INVENTORY','DELIVERY_TRANSFER','DELIVERY_MARKER','DISCARD_RETURN_BKK','DELIVERY_PICKUP_STORE_SCAN')
)
select
    a.PNO
    ,case
        when bc.client_id is not null then bc.client_name
        when bc.client_id is null and kp.id is not null then 'KA'
        when kp.id is null then 'GE'
    end 客户类型
    ,case
        when a.diff_hour < 24 then '24小时内'
        when a.diff_hour >= 24 and a.diff_hour < 48 then '24-48小时'
        when a.diff_hour >= 48 and a.diff_hour < 72 then '48-72小时'
        when a.diff_hour >= 72 and a.diff_hour < 96 then '72-96小时'
        when a.diff_hour >= 96 and a.diff_hour < 120 then '96-120小时'
        when a.diff_hour >= 120 then '120小时以上'
    end 判责丢失后找回包裹时效
    ,if(pi.cod_enabled = 1, '是', '否') 是否COD
    ,if(pi.state = 5 , datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), a.created_at), null) 判责丢失后几天内投妥成功
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,if(a2.store_name = 'PN5-CS(INVENTORY)', '是', '否') 是否到拍卖场
    ,if(bc.client_name is not null ,
        case
            when bc.client_name = 'lazada' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= la.whole_end_date then '是'
            when bc.client_name = 'shopee' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= sh.end_date then '是'
            when bc.client_name = 'tiktok' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= if( tt.end_7_date is null, tt.end_date, tt.end_7_date) then '是'
            when bc.client_name = 'shein' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= ein.whole_end_date then '是'
            else '否'
        end, null) 是否在丢弃时效前有有效路由
from
    (
        select
            a.*
            ,timestampdiff(hour, a.created_at, convert_tz(a.routed_at, '+00:00', '+08:00')) diff_hour
        from pr a
        where
            a.rk = 1
    ) a
left join ph_staging.ka_profile kp on kp.id = a.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = a.client_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day )
left join ph_staging.parcel_info pi on pi.pno = a.pno
left join
    (
        select
            a.*
        from pr a
        where
            a.rk2 = 1
    ) a2 on a2.pno = a.pno
left join dwm.dwd_ex_ph_lazada_pno_period la on la.pno = a.pno
left join dwm.dwd_ex_shopee_lost_pno_period sh on sh.pno = a.pno
left join dwm.dwd_ex_ph_tiktok_sla_detail tt on tt.pno = a.pno
left join dwm.dwd_ex_ph_shein_sla_detail ein on ein.pno = a.pno;
;-- -. . -..- - / . -. - .-. -.--
with
    t as
(
    select
        plt2.pno
        ,pcol.created_at
        ,convert_tz(pcol.created_at, '+08:00', '+00:00') created_time
        ,plt2.client_id
        ,plt2.parcel_created_at
        ,plt2.id
    from ph_bi.parcel_cs_operation_log pcol
    left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
    where
        pcol.type = 1
        and pcol.action = 4
        and pcol.operator_id != 10001
        and pcol.created_at >= '2023-07-01'
        and pcol.created_at < '2023-08-01'
)
,
    pr as
(
    select
        t1.*
        ,pr.route_action
        ,pr.routed_at
        ,pr.store_name
        ,pr.store_id
        ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk2
    from ph_staging.parcel_route pr
    join t t1 on t1.pno = pr.pno
#     join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
    where
        pr.routed_at > t1.created_time
        and pr.route_action in ('SORTING_SCAN','DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE','DISTRIBUTION_INVENTORY','DELIVERY_TICKET_CREATION_SCAN','ARRIVAL_WAREHOUSE_SCAN','SHIPMENT_WAREHOUSE_SCAN','STAFF_INFO_UPDATE_WEIGHT','DELIVERY_CONFIRM','ACCEPT_PARCEL','REPLACE_PNO','UNSEAL','STORE_SORTER_UPDATE_WEIGHT','RECEIVED','PARCEL_HEADLESS_PRINTED','SEAL','DIFFICULTY_HANDOVER','DETAIN_WAREHOUSE','REFUND_CONFIRM','FLASH_HOME_SCAN','RECEIVE_WAREHOUSE_SCAN','PICKUP_RETURN_RECEIPT','STORE_KEEPER_UPDATE_WEIGHT','INVENTORY','DELIVERY_TRANSFER','DELIVERY_MARKER','DISCARD_RETURN_BKK','DELIVERY_PICKUP_STORE_SCAN')
)
select
    a.PNO
    ,case
        when bc.client_id is not null then bc.client_name
        when bc.client_id is null and kp.id is not null then 'KA'
        when kp.id is null then 'GE'
    end 客户类型
    ,case
        when a.diff_hour < 24 then '24小时内'
        when a.diff_hour >= 24 and a.diff_hour < 48 then '24-48小时'
        when a.diff_hour >= 48 and a.diff_hour < 72 then '48-72小时'
        when a.diff_hour >= 72 and a.diff_hour < 96 then '72-96小时'
        when a.diff_hour >= 96 and a.diff_hour < 120 then '96-120小时'
        when a.diff_hour >= 120 then '120小时以上'
    end 判责丢失后找回包裹时效
    ,if(pi.cod_enabled = 1, '是', '否') 是否COD
    ,if(pi.state = 5 , datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), a.created_at), null) 判责丢失后几天内投妥成功
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,if(a2.store_name = 'PN5-CS(INVENTORY)', '是', '否') 是否到拍卖场
    ,if(bc.client_name is not null ,
        case
            when bc.client_name = 'lazada' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= la.whole_end_date then '是'
            when bc.client_name = 'shopee' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= sh.end_date then '是'
            when bc.client_name = 'tiktok' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= if( tt.end_7_date is null, tt.end_date, tt.end_7_date) then '是'
            when bc.client_name = 'shein' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= ein.whole_end_date then '是'
            else '否'
        end, null) 是否在丢弃时效前有有效路由
from
    (
        select
            a.*
            ,timestampdiff(hour, a.created_at, convert_tz(a.routed_at, '+00:00', '+08:00')) diff_hour
        from pr a
        where
            a.rk = 1
    ) a
left join ph_staging.ka_profile kp on kp.id = a.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = a.client_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day )
left join ph_staging.parcel_info pi on pi.pno = a.pno
left join
    (
        select
            a.*
        from pr a
        where
            a.rk2 = 1
    ) a2 on a2.pno = a.pno
left join dwm.dwd_ex_ph_lazada_pno_period la on la.pno = a.pno
left join dwm.dwd_ex_shopee_lost_pno_period sh on sh.pno = a.pno
left join dwm.dwd_ex_ph_tiktok_sla_detail tt on tt.pno = a.pno
left join dwm.dwd_ex_ph_shein_sla_detail ein on ein.pno = a.pno;
;-- -. . -..- - / . -. - .-. -.--
select
   pi.pno
    ,pi.state
from ph_staging.parcel_info pi
where
    pi.pno in ('P8301211MUXAB','P83012172M6BG','P452120KVTBAM','P4521206GWNCF','P45211ZYFCJCF','P45211ZZDUPDA','P452120P7RHDR','P452120WMYJDR','P452120GWC5BP','P452120F8UNBO','P830120D6CSAE','PD830120C3QQAE','P830120J4EGAE','P830120T793AE','P830120N5EWAE','P830120HX86AE','P512320AC72AF','P4521208JFVAZ','P4521202H28AB','P452120KMD8AB','P7619218HRAAJ','P7619218FS0BZ','P45211YWWJ3DQ','P452120K013DQ','P452120EZRDDQ','P45211Z7DWNBA','P452120B6C5CB','P452120AXDPCB','P4521209GP4BA','P452120RR4ABA','P452120VANHCB','P4521209BQSCI','P6401216PCNAE','P640821X9XGAC','P4521205RWVDJ','P4521213E2QDJ','P490420GUYRBE','P490420HVNKBB','P49102119D6AE','P491020Z8E8AC','PD351720R5G7CW','P351720YKYGCW','P700420MZ20AD','P700420MM08AV','P7004211EDDAV','P761920HPEYBU','P3517211JX5CE','P3517219N03AY','P351721AE3GCR','P510520DT4KCK','P641420NQC2AE','P641421DHPFAA','P6414214KQ2AC','P64142133XAAC','P641421QXY0AE','P452120E6SYCZ','P701020X40RAD','P7010210EMKAD','P45212042RYCS','P452120G7E7AP','P490420N2JVAJ','P351720MNUABJ','P351720F3Q4BJ','P351720J0FTBJ','P351720E30TBJ','P700420JHAJAL','P700420GUZJAC','P700420BX7KAA','P700420PV3KAL','P700420SU6WAI','P700420MAFFAA','P700420NFRYAA','P700420H0W0AA','P700420NFSJAC','P70041X990GAA','P70041XFM5RAA','P701020Y51DAH','P7010211GAZAL','P4521206KF9DA','P351720WQ4MAP','PD351720ZXE2AP','PD351720ZEYKBJ','P35172199UTAP','P3517212H5ZAP','P351720W9WBBJ','P351720P81VAP','P35172184AFBJ','P351721D1T3AP','PD351721DKUQBR','P351720G0GEBJ','P3517204U35BJ','P351720NFVUBJ','P351720QJQDBJ','P351720FDDUBJ','P351720D291BJ','P452120FA1ZAJ','P4521203BD5DT','P4521201WJBDR','P4521203ZHGAJ','P4521203KG1DR','P452120DAUPAX','P45212096UGAJ','P452120559PAX','P452120FZJSAX','P452120C3ZHDR','P45211ZYTUKAX','P452120J4M7AJ','P452120C924AX','P4521205CDXCK','P452120KZRYAX','P351720ZZ62AP','P351721784UBJ','P351721290GBJ','P3517210C8KAP','P35172176SQBJ','P351721AMZ3BJ','P351720D49RBJ','P351720P2E3BJ','P351721CUU7BJ','P452120NDD6DN','P6414217V1CAA','P641421CNA9AA','P490720AHUZAA','PD5124201J36AH','P512420MKZ1AE','P51062134YCAG','P5106210PWRAG','P490420JB2ZAS','P490420JAZ0AS','P490420A2V2AX','P490420TC00AN','P7004211FMTAD','P70042112V5AA','P7004215YCZAA','P452120MVEXDC','P452120CKNJDC','P45211ZGB6QCY','P452120HZ85BU','P4521208GXRCY','P452120882GBU','P4713207E3HAH','P512420BKUWAF','P452120VX28CI','P701020XCVXAJ','P491020490GAH','P4902208ZUMAU','P490221108NAO','P490220KG8YAP','P490220K1QHAQ','P490220NGGTAN','P490220HS09AN','P490220GYH7AJ','P490220J70VAN','P701020G8JHAG','P701020CQE5AH','P701020QHZ7AL','P701020WATCAV','P701020S2RYAH','P7010216TXUAG','P702320Y3VUAK','P5105208QQNAF','P70102152DEAL','P70102115VPAI','P830120Y9GYAQ','P830120CZQPAC','P830120RWWZAC','P452120EF6NCJ','P45212048XUCQ','P4521202W4NDQ','P452120XRMCBT','P4521207GYCAY','P452120NPRWAY','P700420JYU7AV','PD49041ZZ5BHAN','P4904202VGDBE','P3517213B1CBJ','P351721CXZ4BJ','P351721DPKJBJ','P701020WU2CAH','P351721CR5DCJ','P351721F0RMCJ','P452120B7WNDB','P35171ZS19CBJ','PD4521204NBCAJ','P45211YT2KQBU','P452120VXP1AR','P452120J1XPBU','P45212052GZAR','P7619210ZCPBU','P830120CEWUAC','P830120JXF0AC','P830120Y3AXAC','P83012114CRAC');
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        a.*
        ,row_number() over (partition by a.dst_store_id, a.third_sorting_code order by a.routed_at) rk1
        ,row_number() over (partition by a.dst_store_id, a.third_sorting_code order by a.routed_at desc ) rk2
    from
        (
            select
                a.*
                ,row_number() over (partition by a.pno order by a.routed_at) rk
            from
                (
                    select
                        ds.dst_store_id
                        ,dp.third_sorting_code
                        ,ds.pno
                        ,ds.should_delevry_type
                        ,pr.staff_info_id
                        ,pr.routed_at
                        ,rank() over (partition by ds.pno order by dp.created_at desc ) rn
                    from dwm.dwd_ph_dc_should_be_delivery_d ds
                    left join dwm.drds_ph_parcel_sorting_code_info dp on ds.pno = dp.pno and ds.dst_store_id = dp.dst_store_id
                    join ph_staging.parcel_route pr on pr.pno = dp.pno and pr.route_action = 'SORTING_SCAN' and pr.routed_at >= '2023-08-23 17:00:00' and pr.routed_at < '2023-08-24 17:00:00'
                    where
                        ds.p_date = '2023-08-24'
#                         and ds.should_delevry_type = '1派应派包裹'
                ) a
            where
                a.rn = 1
        ) a
    where
        a.rk = 1
)
select
    t1.dst_store_id 网点id
    ,dt.store_name 网点
    ,dt.piece_name 片区
    ,dt.region_name 大区
    ,t1.third_sorting_code 三段码
    ,convert_tz(t1.routed_at, '+00:00', '+07:00') 第一次分拣扫描时间
    ,convert_tz(t2.routed_at, '+00:00', '+07:00') 最后一次分拣扫描时间
    ,count(distinct t3.pno) 该三段码第一次与最后一次分拣扫描时间之间扫描单量
    ,count(distinct if(t3.third_sorting_code = t1.third_sorting_code, t3.pno, null))/count(distinct t3.pno) 本三段码扫描占比
from
    (
        select
            t1.*
        from t t1
        where
            t1.rk1 = 1
    ) t1
left join
    (
        select
            t1.*
        from t t1
        where
            t1.rk2 = 1
    ) t2 on t2.dst_store_id = t1.dst_store_id and t2.third_sorting_code = t1.third_sorting_code
left join t t3 on t3.dst_store_id = t1.dst_store_id and t3.routed_at >= t1.routed_at and t3.routed_at <= t2.routed_at
left join dwm.dim_ph_sys_store_rd dt on dt.store_id = t1.dst_store_id and dt.stat_date = date_sub(curdate(), interval 1 day)
group by 1,2,3,4,5,6,7;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        a.*
        ,row_number() over (partition by a.dst_store_id, a.third_sorting_code order by a.routed_at) rk1
        ,row_number() over (partition by a.dst_store_id, a.third_sorting_code order by a.routed_at desc ) rk2
    from
        (
            select
                a.*
                ,row_number() over (partition by a.pno order by a.routed_at) rk
            from
                (
                    select
                        ds.dst_store_id
                        ,dp.third_sorting_code
                        ,ds.pno
                        ,ds.should_delevry_type
                        ,pr.staff_info_id
                        ,pr.routed_at
                        ,rank() over (partition by ds.pno order by dp.created_at desc ) rn
                    from dwm.dwd_ph_dc_should_be_delivery_d ds
                    left join dwm.drds_ph_parcel_sorting_code_info dp on ds.pno = dp.pno and ds.dst_store_id = dp.dst_store_id
                    join ph_staging.parcel_route pr on pr.pno = dp.pno and pr.route_action = 'SORTING_SCAN' and pr.routed_at >= '2023-08-23 16:00:00' and pr.routed_at < '2023-08-24 16:00:00'
                    where
                        ds.p_date = '2023-08-24'
#                         and ds.should_delevry_type = '1派应派包裹'
                ) a
            where
                a.rn = 1
        ) a
    where
        a.rk = 1
)
select
    t1.dst_store_id 网点id
    ,dt.store_name 网点
    ,dt.piece_name 片区
    ,dt.region_name 大区
    ,t1.third_sorting_code 三段码
    ,convert_tz(t1.routed_at, '+00:00', '+08:00') 第一次分拣扫描时间
    ,convert_tz(t2.routed_at, '+00:00', '+08:00') 最后一次分拣扫描时间
    ,count(distinct t3.pno) 该三段码第一次与最后一次分拣扫描时间之间扫描单量
    ,count(distinct if(t3.third_sorting_code = t1.third_sorting_code, t3.pno, null))/count(distinct t3.pno) 本三段码扫描占比
from
    (
        select
            t1.*
        from t t1
        where
            t1.rk1 = 1
    ) t1
left join
    (
        select
            t1.*
        from t t1
        where
            t1.rk2 = 1
    ) t2 on t2.dst_store_id = t1.dst_store_id and t2.third_sorting_code = t1.third_sorting_code
left join t t3 on t3.dst_store_id = t1.dst_store_id and t3.routed_at >= t1.routed_at and t3.routed_at <= t2.routed_at
left join dwm.dim_ph_sys_store_rd dt on dt.store_id = t1.dst_store_id and dt.stat_date = date_sub(curdate(), interval 1 day)
group by 1,2,3,4,5,6,7;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        a.*
        ,row_number() over (partition by a.dst_store_id, a.third_sorting_code order by a.routed_at) rk1
        ,row_number() over (partition by a.dst_store_id, a.third_sorting_code order by a.routed_at desc ) rk2
    from
        (
            select
                a.*
                ,row_number() over (partition by a.pno order by a.routed_at) rk
            from
                (
                    select
                        ds.dst_store_id
                        ,dp.third_sorting_code
                        ,ds.pno
                        ,ds.should_delevry_type
                        ,pr.staff_info_id
                        ,pr.routed_at
                        ,rank() over (partition by ds.pno order by dp.created_at desc ) rn
                    from dwm.dwd_ph_dc_should_be_delivery_d ds
                    left join dwm.drds_ph_parcel_sorting_code_info dp on ds.pno = dp.pno and ds.dst_store_id = dp.dst_store_id
                    join ph_staging.parcel_route pr on pr.pno = dp.pno and pr.route_action = 'SORTING_SCAN' and pr.routed_at >= '2023-08-23 16:00:00' and pr.routed_at < '2023-08-24 16:00:00'
                    where
                        ds.p_date = '2023-08-24'
#                         and ds.should_delevry_type = '1派应派包裹'
                ) a
            where
                a.rn = 1
        ) a
    where
        a.rk = 1
)
select
    t1.dst_store_id 网点id
    ,dt.store_name 网点
    ,dt.piece_name 片区
    ,dt.region_name 大区
    ,t1.third_sorting_code 三段码
    ,convert_tz(t1.routed_at, '+00:00', '+08:00') 第一次分拣扫描时间
    ,convert_tz(t2.routed_at, '+00:00', '+08:00') 最后一次分拣扫描时间
#     ,count(distinct t3.pno) 该三段码第一次与最后一次分拣扫描时间之间扫描单量
#     ,count(distinct if(t3.third_sorting_code = t1.third_sorting_code, t3.pno, null))/count(distinct t3.pno) 本三段码扫描占比
    ,t3.pno
    ,convert_tz(t3.routed_at, '+00:00', '+08:00') 分拣时间

from
    (
        select
            t1.*
        from t t1
        where
            t1.rk1 = 1
    ) t1
left join
    (
        select
            t1.*
        from t t1
        where
            t1.rk2 = 1
    ) t2 on t2.dst_store_id = t1.dst_store_id and t2.third_sorting_code = t1.third_sorting_code
left join t t3 on t3.dst_store_id = t1.dst_store_id and t3.routed_at >= t1.routed_at and t3.routed_at <= t2.routed_at
left join dwm.dim_ph_sys_store_rd dt on dt.store_id = t1.dst_store_id and dt.stat_date = date_sub(curdate(), interval 1 day)
where
    t1.dst_store_id = 'PH61205504';
;-- -. . -..- - / . -. - .-. -.--
select
    a.dst_store_id 网点ID
    ,dt.store_name 网点
    ,dt.piece_name 片区
    ,dt.region_name 大区
    ,a.third_sorting_code 三段码
    ,a.pno
    ,a.should_delevry_type
    ,a.staff_info_id
    ,convert_tz(a.routed_at, '+00:00', '+08:00') 分拣时间
    ,row_number() over (partition by a.dst_store_id, a.third_sorting_code order by a.routed_at) 正向排序
    ,row_number() over (partition by a.dst_store_id, a.third_sorting_code order by a.routed_at desc ) 逆向排序
from
    (
        select
            a.*
            ,row_number() over (partition by a.pno order by a.routed_at) rk
        from
            (
                select
                    ds.dst_store_id
                    ,dp.third_sorting_code
                    ,ds.pno
                    ,ds.should_delevry_type
                    ,pr.staff_info_id
                    ,pr.routed_at
                    ,rank() over (partition by ds.pno order by dp.created_at desc ) rn
                from dwm.dwd_ph_dc_should_be_delivery_d ds
                left join dwm.drds_ph_parcel_sorting_code_info  dp on ds.pno = dp.pno and ds.dst_store_id = dp.dst_store_id
                join ph_staging.parcel_route pr on pr.pno = dp.pno and pr.route_action = 'SORTING_SCAN' and pr.routed_at >= '2023-08-23 16:00:00' and pr.routed_at < '2023-08-24 16:00:00'
                where
                    ds.p_date = '2023-08-24'
            ) a
        where
            a.rn = 1
    ) a
left join dwm.dim_ph_sys_store_rd dt on dt.store_id = a.dst_store_id and dt.stat_date = date_sub(curdate(), interval 1 day)
where
    a.rk = 1
    and dt.store_name in ('JEN_SP','INT_SP','TAD_SP','VER_SP','MBT_SP','RIZ_SP','MSN_SP','NHC_SP','DMS_SP','CAG_SP');
;-- -. . -..- - / . -. - .-. -.--
select date_sub(curdate(), interval 14 day);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        pi.pno
        ,pi.state
        ,pi.ticket_pickup_store_id
        ,pi.returned
        ,pi.dst_store_id
        ,pi.client_id
        ,pi.cod_enabled
    from ph_staging.parcel_info pi
    where
        pi.created_at < '2023-08-09 16:00:00'
        and pi.state not in (5,7,8,9)
)
select
    t1.pno
    ,if(t1.returned = 1, '退件', '正向件')  方向
    ,t1.client_id 客户ID
    ,case
        when bc.`client_id` is not null then bc.client_name
        when kp.id is not null and bc.client_id is null then '普通ka'
        when kp.`id` is null then '小c'
    end as 客户类型
    ,case t1.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,case di.diff_marker_category # 疑难原因
        when 1 then '客户不在家/电话无人接听'
        when 2 then '收件人拒收'
        when 3 then '快件分错网点'
        when 4 then '外包装破损'
        when 5 then '货物破损'
        when 6 then '货物短少'
        when 7 then '货物丢失'
        when 8 then '电话联系不上'
        when 9 then '客户改约时间'
        when 10 then '客户不在'
        when 11 then '客户取消任务'
        when 12 then '无人签收'
        when 13 then '客户周末或假期不收货'
        when 14 then '客户改约时间'
        when 15 then '当日运力不足，无法派送'
        when 16 then '联系不上收件人'
        when 17 then '收件人拒收'
        when 18 then '快件分错网点'
        when 19 then '外包装破损'
        when 20 then '货物破损'
        when 21 then '货物短少'
        when 22 then '货物丢失'
        when 23 then '收件人/地址不清晰或不正确'
        when 24 then '收件地址已废弃或不存在'
        when 25 then '收件人电话号码错误'
        when 26 then 'cod金额不正确'
        when 27 then '无实际包裹'
        when 28 then '已妥投未交接'
        when 29 then '收件人电话号码是空号'
        when 30 then '快件分错网点-地址正确'
        when 31 then '快件分错网点-地址错误'
        when 32 then '禁运品'
        when 33 then '严重破损（丢弃）'
        when 34 then '退件两次尝试派送失败'
        when 35 then '不能打开locker'
        when 36 then 'locker不能使用'
        when 37 then '该地址找不到lockerstation'
        when 38 then '一票多件'
        when 39 then '多次尝试派件失败'
        when 40 then '客户不在家/电话无人接听'
        when 41 then '错过班车时间'
        when 42 then '目的地是偏远地区,留仓待次日派送'
        when 43 then '目的地是岛屿,留仓待次日派送'
        when 44 then '企业/机构当天已下班'
        when 45 then '子母件包裹未全部到达网点'
        when 46 then '不可抗力原因留仓(台风)'
        when 47 then '虚假包裹'
        when 48 then '转交FH包裹留仓'
        when 50 then '客户取消寄件'
        when 51 then '信息录入错误'
        when 52 then '客户取消寄件'
        when 53 then 'lazada仓库拒收'
        when 69 then '禁运品'
        when 70 then '客户改约时间'
        when 71 then '当日运力不足，无法派送'
        when 72 then '客户周末或假期不收货'
        when 73 then '收件人/地址不清晰或不正确'
        when 74 then '收件地址已废弃或不存在'
        when 75 then '收件人电话号码错误'
        when 76 then 'cod金额不正确'
        when 77 then '企业/机构当天已下班'
        when 78 then '收件人电话号码是空号'
        when 79 then '快件分错网点-地址错误'
        when 80 then '客户取消任务'
        when 81 then '重复下单'
        when 82 then '已完成揽件'
        when 83 then '联系不上客户'
        when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
        when 85 then '寄件人电话号码是空号'
        when 86 then '包裹不符合揽收条件超大件'
        when 87 then '包裹不符合揽收条件违禁品'
        when 88 then '寄件人地址为岛屿'
        when 89 then '运力短缺，跟客户协商推迟揽收'
        when 90 then '包裹未准备好推迟揽收'
        when 91 then '包裹包装不符合运输标准'
        when 92 then '客户提供的清单里没有此包裹'
        when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
        when 94 then '客户取消寄件/客户实际不想寄此包裹'
        when 95 then '车辆/人力短缺推迟揽收'
        when 96 then '遗漏揽收(已停用)'
        when 97 then '子母件(一个单号多个包裹)'
        when 98 then '地址错误addresserror'
        when 99 then '包裹不符合揽收条件：超大件'
        when 100 then '包裹不符合揽收条件：违禁品'
        when 101 then '包裹包装不符合运输标准'
        when 102 then '包裹未准备好'
        when 103 then '运力短缺，跟客户协商推迟揽收'
        when 104 then '子母件(一个单号多个包裹)'
        when 105 then '破损包裹'
        when 106 then '空包裹'
        when 107 then '不能打开locker(密码错误)'
        when 108 then 'locker不能使用'
        when 109 then 'locker找不到'
        when 110 then '运单号与实际包裹的单号不一致'
        when 111 then 'box客户取消任务'
        when 112 then '不能打开locker(密码错误)'
        when 113 then 'locker不能使用'
        when 114 then 'locker找不到'
        when 115 then '实际重量尺寸大于客户下单的重量尺寸'
        when 116 then '客户仓库关闭'
        when 117 then '客户仓库关闭'
        when 118 then 'SHOPEE订单系统自动关闭'
        when 119 then '客户取消包裹'
        when 121 then '地址错误'
        when 122 then '当日运力不足，无法揽收'
    end as 疑难原因
#     ,case
#         when t1.state = 6 and di.pno is not null then 'KAM/揽件网点未协商'
#         when t1.state = 6 and di.pno is null  then '闪速系统沟通处理中'
#         when t1.state != 6 and plt.pno is not null and plt2.pno is not null then '闪速系统沟通处理中'
#         when plt.pno is null and pct.pno is not null then '闪速超时效理赔未完成'
#         when de.last_store_id = t1.ticket_pickup_store_id and plt2.pno is null then '揽件未发出'
#         when t1.dst_store_id = 'PH19040F05' and plt2.pno is null then '弃件未到拍卖仓'
#         when t1.state != 6 and datediff(now(), convert_tz(pr.routed_at, '+00:00', '+08:00')) > 7 and plt2.pno is not null then 'QAQC无须追责后长期无有效路由'
#         else null
#     end 卡点原因
#     ,de.last_store_name 当前节点
    ,datediff(now(), convert_tz(pr.routed_at, '+00:00', '+08:00')) 最后有效路由距今天数
    ,case pr.route_action # 路由动作
         when 'ACCEPT_PARCEL' then '接件扫描'
         when 'ARRIVAL_GOODS_VAN_CHECK_SCAN' then '车货关联到港'
         when 'ARRIVAL_WAREHOUSE_SCAN' then '到件入仓扫描'
         when 'CANCEL_ARRIVAL_WAREHOUSE_SCAN' then '取消到件入仓扫描'
         when 'CANCEL_PARCEL' then '撤销包裹'
         when 'CANCEL_SHIPMENT_WAREHOUSE' then '取消发件出仓'
         when 'CHANGE_PARCEL_CANCEL' then '修改包裹为撤销'
         when 'CHANGE_PARCEL_CLOSE' then '修改包裹为异常关闭'
         when 'CHANGE_PARCEL_IN_TRANSIT' then '修改包裹为运输中'
         when 'CHANGE_PARCEL_INFO' then '修改包裹信息'
         when 'CHANGE_PARCEL_SIGNED' then '修改包裹为签收'
         when 'CLAIMS_CLOSE' then '理赔关闭'
         when 'CLAIMS_COMPLETE' then '理赔完成'
         when 'CLAIMS_CONTACT' then '已联系客户'
         when 'CLAIMS_TRANSFER_CS' then '转交总部cs处理'
         when 'CLOSE_ORDER' then '关闭订单'
         when 'CONTINUE_TRANSPORT' then '疑难件继续配送'
         when 'CREATE_WORK_ORDER' then '创建工单'
         when 'CUSTOMER_CHANGE_PARCEL_INFO' then '客户修改包裹信息'
         when 'CUSTOMER_OPERATING_RETURN' then '客户操作退回寄件人'
         when 'DELIVERY_CONFIRM' then '确认妥投'
         when 'DELIVERY_MARKER' then '派件标记'
         when 'DELIVERY_PICKUP_STORE_SCAN' then '自提取件扫描'
         when 'DELIVERY_TICKET_CREATION_SCAN' then '交接扫描'
         when 'DELIVERY_TRANSFER' then '派件转单'
         when 'DEPARTURE_GOODS_VAN_CK_SCAN' then '车货关联出港'
         when 'DETAIN_WAREHOUSE' then '货件留仓'
         when 'DIFFICULTY_FINISH_INDEMNITY' then '疑难件支付赔偿'
         when 'DIFFICULTY_HANDOVER' then '疑难件交接'
         when 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE' then '疑难件交接货件留仓'
         when 'DIFFICULTY_RE_TRANSIT' then '疑难件退回区域总部/重启运送'
         when 'DIFFICULTY_RETURN' then '疑难件退回寄件人'
         when 'DIFFICULTY_SEAL' then '集包异常'
         when 'DISCARD_RETURN_BKK' then '丢弃包裹的，换单后寄回BKK'
         when 'DISTRIBUTION_INVENTORY' then '分拨盘库'
         when 'DWS_WEIGHT_IMAGE' then 'DWS复秤照片'
         when 'EXCHANGE_PARCEL' then '换货'
         when 'FAKE_CANCEL_HANDLE' then '虚假撤销判责'
         when 'FLASH_HOME_SCAN' then 'FH交接扫描'
         when 'FORCE_TAKE_PHOTO' then '强制拍照路由'
         when 'HAVE_HAIR_SCAN_NO_TO' then '有发无到'
         when 'HURRY_PARCEL' then '催单'
         when 'INCOMING_CALL' then '来电接听'
         when 'INTERRUPT_PARCEL_AND_RETURN' then '中断运输并退回'
         when 'INVENTORY' then '盘库'
         when 'LOSE_PARCEL_TEAM_OPERATION' then '丢失件团队处理'
         when 'MANUAL_REMARK' then '添加备注'
         when 'MISS_PICKUP_HANDLE' then '漏包裹揽收判责'
         when 'MISSING_PARCEL_SCAN' then '丢失件包裹操作'
         when 'NOTICE_LOST_PARTS_TEAM' then '已通知丢失件团队'
         when 'PARCEL_HEADLESS_CLAIMED' then '无头件包裹已认领'
         when 'PARCEL_HEADLESS_PRINTED' then '无头件包裹已打单'
         when 'PENDING_RETURN' then '待退件'
         when 'PHONE' then '电话联系'
         when 'PICK_UP_STORE' then '待自提取件'
         when 'PICKUP_RETURN_RECEIPT' then '签回单揽收'
         when 'PRINTING' then '打印面单'
         when 'QAQC_OPERATION' then 'QAQC判责'
         when 'RECEIVE_WAREHOUSE_SCAN' then '收件入仓'
         when 'RECEIVED' then '已揽收'
         when 'REFUND_CONFIRM' then '退件妥投'
         when 'REPAIRED' then '上报问题修复路由'
         when 'REPLACE_PNO' then '换单'
         when 'REPLY_WORK_ORDER' then '回复工单'
         when 'REVISION_TIME' then '改约时间'
         when 'SEAL' then '集包'
         when 'SEAL_NUMBER_CHANGE' then '集包件数变化'
         when 'SHIPMENT_WAREHOUSE_SCAN' then '发件出仓扫描'
         when 'SORTER_WEIGHT_IMAGE' then '分拣机复秤照片'
         when 'SORTING_SCAN' then '分拣扫描'
         when 'STAFF_INFO_UPDATE_WEIGHT' then '快递员修改重量'
         when 'STORE_KEEPER_UPDATE_WEIGHT' then '仓管员复秤'
         when 'STORE_SORTER_UPDATE_WEIGHT' then '分拣机复秤'
         when 'SYSTEM_AUTO_RETURN' then '系统自动退件'
         when 'TAKE_PHOTO' then '异常打单拍照'
         when 'THIRD_EXPRESS_ROUTE' then '第三方公司路由'
         when 'THIRD_PARTY_REASON_DETAIN' then '第三方原因滞留'
         when 'TICKET_WEIGHT_IMAGE' then '揽收称重照片'
         when 'TRANSFER_LOST_PARTS_TEAM' then '已转交丢失件团队'
         when 'TRANSFER_QAQC' then '转交QAQC处理'
         when 'UNSEAL' then '拆包'
         when 'UNSEAL_NO_PARCEL' then '上报包裹不在集包里'
         when 'UNSEAL_NOT_SCANNED' then '集包已拆包，本包裹未被扫描'
         when 'VEHICLE_ACCIDENT_REG' then '车辆车祸登记'
         when 'VEHICLE_ACCIDENT_REGISTRATION' then '车辆车祸登记'
         when 'VEHICLE_WET_DAMAGE_REG' then '车辆湿损登记'
         when 'VEHICLE_WET_DAMAGE_REGISTRATION' then '车辆湿损登记'
        end as 最后一条路由
    ,pr.store_name 最后有效路由动作网点
    ,convert_tz(pr.routed_at ,'+00:00', '+08:00') 最新一条有效路由时间
    ,datediff(now(), de.dst_routed_at) 目的地网点停留时间
    ,de.dst_store 目的地网点
    ,de.dst_piece
    ,de.dst_region
    ,de.src_store 揽收网点
    ,de.pickup_time 揽收时间
    ,de.pick_date 揽收日期
    ,if(hold.pno is not null, 'yes', 'no' ) 是否有holding标记
    ,if(pr3.pno is not null, 'yes', 'no') 是否有待退件标记
    ,td.try_num 尝试派送次数
from t t1
left join ph_staging.ka_profile kp on t1.client_id = kp.id
left join dwm.dwd_dim_bigClient bc on bc.client_id = t1.client_id
left join dwm.dwd_ex_ph_parcel_details de on de.pno = t1.pno
left join
    (
        select
            plt.pno
            ,group_concat(ss.name ) should_do
        from ph_bi.parcel_lose_task plt
        join t t1 on t1.pno = plt.pno
        left join ph_bi.work_order wo on wo.loseparcel_task_id = plt.id
        left join ph_staging.sys_store ss on ss.id = wo.store_id
        where
            plt.state in (3)
            and wo.status in (1,2)
        group by 1

        union  all

        select
            plt.pno
            ,'QAQC' should_do
        from ph_bi.parcel_lose_task plt
        join t t1 on t1.pno = plt.pno
        where
            plt.state in (1,2,4)
    ) plt on plt.pno = t1.pno
left join
    (
        select
            t2.pno
            ,cdt.negotiation_result_category
            ,di.diff_marker_category
            ,case
                when di.diff_marker_category in (20,21)  and cdt.vip_enable = 1 then 'KAM'
                when di.diff_marker_category not in (20,21) and cdt.vip_enable = 1 then 'KAM'
                when di.diff_marker_category not in (20,21) and cdt.vip_enable = 0 then ss2.name
                WHEN di.diff_marker_category in (20,21) and cdt.vip_enable = 0 then ss2.name
            end sh_do
        from ph_staging.diff_info di
        join t t2 on t2.pno = di.pno
        join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
        left join ph_bi.parcel_lose_task plt on plt.source_id = cdt.id
        left join ph_staging.sys_store ss2 on ss2.id = t2.ticket_pickup_store_id
        where
            cdt.negotiation_result_category is null
    ) di on di.pno = t1.pno
left join  
    (
        select
            pr.pno
            ,pr.store_name
            ,pr.routed_at
            ,pr.route_action
            ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
        from  ph_staging.parcel_route pr
        join t t3 on t3.pno = pr.pno
        where
            pr.route_action in ('INVENTORY','RECEIVED' ,'RECEIVE_WAREHOUSE_SCAN', 'SORTING_SCAN', 'DELIVERY_TICKET_CREATION_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SHIPMENT_WAREHOUSE_SCAN', 'DETAIN_WAREHOUSE', 'DELIVERY_CONFIRM', 'DIFFICULTY_HANDOVER', 'DELIVERY_MARKER', 'REPLACE_PNO','SEAL', 'UNSEAL', 'STAFF_INFO_UPDATE_WEIGHT', 'STORE_KEEPER_UPDATE_WEIGHT', 'STORE_SORTER_UPDATE_WEIGHT', 'DISCARD_RETURN_BKK', 'DELIVERY_TRANSFER', 'PICKUP_RETURN_RECEIPT', 'FLASH_HOME_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SORTING_SCAN ', 'DELIVERY_PICKUP_STORE_SCAN', 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE', 'REFUND_CONFIRM', 'ACCEPT_PARCEL')
            and pr.organization_type = 1
        ) pr on pr.pno = t1.pno and pr.rk = 1
left join
    (
        select
            plt.pno
        from ph_bi.parcel_lose_task plt
        join t t1 on t1.pno = plt.pno
        where
            plt.state = 5
            and plt.operator_id not in (10000,10001,10002)
        group by 1
    ) plt2 on plt2.pno = t1.pno
left join
    (
        select
            plt.pno
        from ph_bi.parcel_claim_task plt
        join t t4  on t4.pno = plt.pno
        where
            plt.state not in (6,7,8)
            and plt.source = 11
        group by 1
    ) pct on pct.pno = t1.pno
left join
    (
        select
            pr2.pno
        from ph_staging.parcel_route pr2
        join t t1 on t1.pno = pr2.pno
        where
            pr2.route_action = 'REFUND_CONFIRM'
        group by 1
    ) hold on hold.pno = t1.pno
left join
    (
        select
            pr2.pno
        from  ph_staging.parcel_route pr2
        join t t1 on t1.pno = pr2.pno
        where
            pr2.route_action = 'PENDING_RETURN'
        group by 1
    ) pr3 on pr3.pno = t1.pno
left join
    (
        select
            td.pno
            ,count(distinct date(convert_tz(tdm.created_at, '+00:00', '+08:00'))) try_num
        from ph_staging.ticket_delivery td
        join t t1 on t1.pno = td.pno
        left join ph_staging.ticket_delivery_marker tdm on tdm.delivery_id = td.id
        group by 1
    ) td on td.pno = t1.pno
group by t1.pno;
;-- -. . -..- - / . -. - .-. -.--
select
    a.pno
    ,convert_tz(a.min_route_time, '+00:00', '+08:00') 第一次标记成功时间
    ,convert_tz(pr.routed_at, '+00:00', '+08:00') 电话时间
    ,json_extract(pr.extra_value, '$.callDuration') 通话时长
from ph_staging.parcel_route pr
join
    (
        select
            pr.pno
            ,min(pr.routed_at) min_route_time
        from ph_staging.parcel_route pr
        where
            pr.routed_at > '2023-08-21 16:00:00'
            and pr.routed_at < '2023-08-22 16:00:00'
            and pr.route_action = 'DELIVERY_MARKER'
            and pr.marker_category in (2,17)
        group by 1
    ) a on pr.pno = a.pno
where
    pr.route_action = 'PHONE'
    and pr.routed_at > '2023-08-21 16:00:00'
    and pr.routed_at < '2023-08-22 16:00:00'
    and pr.routed_at < a.min_route_time;
;-- -. . -..- - / . -. - .-. -.--
select
    a.pno
    ,convert_tz(a.min_route_time, '+00:00', '+08:00') 第一次标记成功时间
    ,convert_tz(pr.routed_at, '+00:00', '+08:00') 电话时间
    ,json_extract(pr.extra_value, '$.callDuration') 通话时长
    ,count(pr.routed_at) over (partition by a.pno) 该单号尝试拨打次数
from ph_staging.parcel_route pr
join
    (
        select
            pr.pno
            ,min(pr.routed_at) min_route_time
        from ph_staging.parcel_route pr
        where
            pr.routed_at > '2023-08-21 16:00:00'
            and pr.routed_at < '2023-08-22 16:00:00'
            and pr.route_action = 'DELIVERY_MARKER'
            and pr.marker_category in (2,17)
        group by 1
    ) a on pr.pno = a.pno
where
    pr.route_action = 'PHONE'
    and pr.routed_at > '2023-08-21 16:00:00'
    and pr.routed_at < '2023-08-22 16:00:00'
    and pr.routed_at < a.min_route_time;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.CT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-08-25'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.CT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-08-25'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-08-25', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
select -- 基于当日应派取扫描率
    tt.store_id 网点ID
    ,tt.store_name 网点名称
    ,tt.store_type 网点分类
    ,tt.piece_name 片区
    ,tt.region_name 大区
    ,tt.shoud_counts 应派总数
    ,tt.scan_fished_counts 分拣扫描数
    ,ifnull(tt.scan_fished_counts/shoud_counts,0) 分拣扫描率

    ,tt.youxiao_counts 有效分拣扫描数
    ,ifnull(tt.youxiao_counts/tt.scan_fished_counts,0) 有效分拣扫描率

    ,tt.1pai_counts 一派应派数
    ,tt.1pai_scan_fished_counts 一派分拣扫描数
    ,ifnull(tt.1pai_scan_fished_counts/tt.1pai_counts,0) 一派分拣扫描率

    ,tt.1pai_youxiao_counts 一派有效分拣扫描数
    ,ifnull(tt.1pai_youxiao_counts/tt.1pai_scan_fished_counts,0) 一派有效分拣扫描率
    ,
    case
	    when tt.1pai_youxiao_counts/tt.1pai_scan_fished_counts>=0.95 then 'A'
	    when tt.1pai_youxiao_counts/tt.1pai_scan_fished_counts>=0.90 then 'B'
	    when tt.1pai_youxiao_counts/tt.1pai_scan_fished_counts>=0.85 then 'C'
	    when tt.1pai_youxiao_counts/tt.1pai_scan_fished_counts>=0.80 then 'D'
	    else 'E'
	 end 一派有效分拣评级 -- 一派有效分拣

	 ,case
        when tt.1pai_hour_8_fished_counts/tt.1pai_counts>=0.95  then 'A'
        when tt.1pai_hour_8ban_fished_counts/tt.1pai_counts>=0.95  then 'B'
        when tt.1pai_hour_9_fished_counts/tt.1pai_counts>=0.95  then 'C'
        when tt.1pai_hour_9ban_fished_counts/tt.1pai_counts>=0.95  then 'D'
        else 'E'
       end 一派分拣评级

    ,ifnull(tt.1pai_hour_8_fished_counts/tt.1pai_counts,0) 一派8点前扫描占比
    ,ifnull(tt.1pai_hour_8ban_fished_counts/tt.1pai_counts,0) 一派8点半前扫描占比
    ,ifnull(tt.1pai_hour_9_fished_counts/tt.1pai_counts,0) 一派9点前扫描占比
    ,ifnull(tt.1pai_hour_9ban_fished_counts/tt.1pai_counts,0) 一派9点半前扫描占比
	,if(tt2.late_proof_counts is null , '否', '是') 是否有迟到超过规划时间20分钟的常规车
    ,tt2.max_real_arrive_time_normal 一派常规车最晚实际到达时间
#     ,tt2.max_real_arrive_proof_id 一派常规车最晚实际到达车线
#     ,tt2.max_real_arrive_vol 一派常规车最晚实际到达车线包裹量
    ,tt2.line_1_latest_plan_arrive_time 一派常规车最晚规划到达时间
    ,tt2.max_real_arrive_time_innormal 一派加班车最晚实际到达时间
#     ,tt2.max_real_arrive_innormal_proof_id  一派加班车最晚实际到达车线
#     ,tt2.max_real_arrive_innormal_vol  一派加班车最晚实际到达包裹量
    ,tt2.max_actual_plan_arrive_time_innormal 一派加班车最晚规划到达时间


from
(
    select
       base.store_id
       ,base.store_name
       ,base.store_type
       ,base.piece_name
       ,base.region_name
       ,count(distinct base.pno) shoud_counts
       ,count(distinct case when base.min_fenjian_scan_time is not null then base.pno else null end ) scan_fished_counts
       ,count(distinct case when base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then base.pno else null end ) youxiao_counts

       ,count(distinct case when base.type='一派' then  base.pno else null end ) 1pai_counts
       ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null then  base.pno else null end ) 1pai_scan_fished_counts
       ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then  base.pno else null end ) 1pai_youxiao_counts

       ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:00:00' then base.pno else null end) 1pai_hour_8_fished_counts
       ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:30:00' then base.pno else null end) 1pai_hour_8ban_fished_counts
       ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:00:00' then base.pno else null end) 1pai_hour_9_fished_counts
       ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:30:00' then base.pno else null end) 1pai_hour_9ban_fished_counts

    from
    (
       select
       t.*,
       case when t.should_delevry_type='1派应派包裹' then '一派' else null end 'type'
       from dwm.dwd_ph_dc_should_be_delivery_sort_scan t
       join ph_staging.sys_store ss
       on t.store_id =ss.id
    ) base
    group by base.store_id,base.store_name,base.store_type,base.piece_name,base.region_name
) tt

left join
(
    select
       bl.store_id
       ,bl.max_real_arrive_time_normal
       ,bl.max_real_arrive_proof_id
       ,bl.max_real_arrive_vol
       ,bl.line_1_latest_plan_arrive_time
       ,bl.max_actual_plan_arrive_time_innormal
       ,bl.max_actual_plan_arrive_innormal_proof_id
       ,bl.max_actual_plan_arrive_innormal_vol
       ,bl.max_real_arrive_time_innormal
       ,bl.max_real_arrive_innormal_proof_id
       ,bl.max_real_arrive_innormal_vol
	   ,late_proof_counts
    from dwm.fleet_real_detail_today bl
    group by 1,2,3,4,5,6,7,8,9,10,11
) tt2 on tt.store_id=tt2.store_id;
;-- -. . -..- - / . -. - .-. -.--
with d as
    (
        select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-08-25'
    )
    , t as
    (
        select
             ds.store_id
            ,ds.pno
            ,ds.stat_date
        from d ds
        left join
            (
                select
                    pr.pno
                    ,ds.stat_date
                    ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
                from ph_staging.parcel_route pr
                join d ds on pr.pno = ds.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                    and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and pr.marker_category in (42,43) ##岛屿,偏远地区
                group by 1,2
            ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
        left join
            (
                select
                   pr.pno
                    ,ds.stat_date
                   ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
                   ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
                from ph_staging.parcel_route pr
                join d ds on ds.pno = pr.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                    and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                    and pr.marker_category in (9,14,70) ##客户改约时间
            ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
        left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
        where
            case
                when pr1.pno is not null then 'N'
                when pr2.pno is not null then 'N'
                when ds1.pno is not null  then 'N'  else 'Y'
            end = 'Y'
    )
    select
        a.stat_date 日期
        ,a.store_id 网点ID
        ,dp.store_name 网点名称
        ,dp.opening_at 开业时间
        ,case
            when dp.region_name in ('Area3', 'Area6') then '彭万松'
            when dp.region_name in ('Area4', 'Area9') then '韩钥'
            when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
            when dp.region_name in ( 'Area8') then '黄勇'
            when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
        end 区域
        ,dp.region_name 大区
        ,dp.piece_name 片区
        ,a.应交接
        ,a.已交接
        ,concat(round(a.交接率*100,2),'%') as 交接率
        ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
        ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
        ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
        ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
        ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
    from
        (
            select
                t1.store_id
                ,t1.stat_date
                ,count(t1.pno) 应交接
                ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
            from t t1
            left join
                (
                    select
                        sc.*
                    from
                        (
                            select
                                pr.pno
                                ,pr.store_id
                                ,pr.store_name
                                ,t1.stat_date
                                ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                            from ph_staging.parcel_route pr
                            join t t1 on t1.pno = pr.pno
                            where
                                pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                               and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                              and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                        ) sc
                    where
                        sc.rk = 1
                ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
            group by 1,2
        ) a
    join
        (
            select
                sd.store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.store_id is not null
            group by 1

            union all

            select
                sd.separation_store_id store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.separation_store_id is not null
            group by 1
        ) sd on sd.store_id = a.store_id
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    where
        dp.store_category in (1,10);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-08-25'
        and pr.routed_at >= date_sub('2023-08-25', interval 8 hour )
        and pr.routed_at < date_add('2023-08-25', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end 评级
        ,a2.code_num
        ,a2.staff_code_num
        ,a2.staff_num
        ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-25'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-08-25')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-08-25'
        and pi.finished_at >= date_sub('2023-08-25', interval 8 hour )
        and pi.finished_at < date_add('2023-08-25', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-08-25'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
select
    t.pno
    ,ss.name 目的地网点
    ,convert_tz(t.created_at, '+00:00', '+08:00') 揽收时间
    ,case t.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
from
    (
        select
            pi.pno
            ,ps.third_sorting_code
            ,pi.state
            ,pi.created_at
            ,ps.dst_store_id
            ,row_number() over (partition by pi.pno order by ps.created_at desc ) rk
        from ph_staging.parcel_info pi
        left join ph_drds.parcel_sorting_code_info ps on ps.pno = pi.pno
        where
            pi.interrupt_category != 3 -- 没有待退件标记
            and pi.state not in (5,7,8,9)
    ) t
left join ph_staging.sys_store ss on ss.id = t.dst_store_id
where
    t.rk = 1
    and t.third_sorting_code = 'XX';
;-- -. . -..- - / . -. - .-. -.--
select
    t.pno
    ,ss.name 目的地网点
    ,convert_tz(t.created_at, '+00:00', '+08:00') 揽收时间
    ,case t.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
from
    (
        select
            pi.pno
            ,ps.third_sorting_code
            ,pi.state
            ,pi.created_at
            ,ps.dst_store_id
            ,row_number() over (partition by pi.pno order by ps.created_at desc ) rk
        from ph_staging.parcel_info pi
        left join ph_drds.parcel_sorting_code_info ps on ps.pno = pi.pno
        where
            pi.interrupt_category != 3  or pi.interrupt_category is null -- 没有待退件标记
            and pi.state not in (5,7,8,9)
    ) t
left join ph_staging.sys_store ss on ss.id = t.dst_store_id
where
    t.rk = 1
    and t.third_sorting_code = 'XX';
;-- -. . -..- - / . -. - .-. -.--
select
    *
from
    (

        select
            t.pno
            ,ss.name 目的地网点
            ,convert_tz(t.created_at, '+00:00', '+08:00') 揽收时间
            ,case t.state
                when 1 then '已揽收'
                when 2 then '运输中'
                when 3 then '派送中'
                when 4 then '已滞留'
                when 5 then '已签收'
                when 6 then '疑难件处理中'
                when 7 then '已退件'
                when 8 then '异常关闭'
                when 9 then '已撤销'
            end as 包裹状态
            ,t.third_sorting_code
        from
            (
                select
                    pi.pno
                    ,ps.third_sorting_code
                    ,pi.state
                    ,pi.created_at
                    ,ps.dst_store_id
                    ,row_number() over (partition by pi.pno order by ps.created_at desc ) rk
                from ph_staging.parcel_info pi
                left join ph_drds.parcel_sorting_code_info ps on ps.pno = pi.pno
                where
                    pi.interrupt_category != 3  or pi.interrupt_category is null -- 没有待退件标记
                    and pi.state not in (5,7,8,9)
            ) t
        left join ph_staging.sys_store ss on ss.id = t.dst_store_id
        where
            t.rk = 1
    ) a
where
    a.third_sorting_code != 'XX';
;-- -. . -..- - / . -. - .-. -.--
select
    *
from
    (

        select
            t.pno
            ,ss.name 目的地网点
            ,convert_tz(t.created_at, '+00:00', '+08:00') 揽收时间
            ,case t.state
                when 1 then '已揽收'
                when 2 then '运输中'
                when 3 then '派送中'
                when 4 then '已滞留'
                when 5 then '已签收'
                when 6 then '疑难件处理中'
                when 7 then '已退件'
                when 8 then '异常关闭'
                when 9 then '已撤销'
            end as 包裹状态
            ,t.third_sorting_code
        from
            (
                select
                    pi.pno
                    ,ps.third_sorting_code
                    ,pi.state
                    ,pi.created_at
                    ,ps.dst_store_id
                    ,row_number() over (partition by pi.pno order by ps.created_at desc ) rk
                from ph_staging.parcel_info pi
                left join ph_drds.parcel_sorting_code_info ps on ps.pno = pi.pno
                where
                    pi.interrupt_category != 3  or pi.interrupt_category is null -- 没有待退件标记
                    and pi.state not in (5,7,8,9)
            ) t
        left join ph_staging.sys_store ss on ss.id = t.dst_store_id
        where
            t.rk = 1
    ) a
where
    a.third_sorting_code = 'XX';
;-- -. . -..- - / . -. - .-. -.--
SELECT DISTINCT

	plt.created_at '任务生成时间 Task generation time'
    ,CONCAT('SSRD',plt.`id`) '任务ID Task ID'
	,plt.`pno`  '运单号 Waybill'
	,case plt.`vip_enable`
    when 0 then '普通客户'
    when 1 then 'KAM客户'
    end as '客户类型 Client type'
	,case plt.`duty_result`
	when 1 then '丢失'
	when 2 then '破损'
	when 3 then '超时效'
	end as '判责类型Judgement type'
	,t.`t_value` '原因 Reason'
	,plt.`client_id` '客户ID Client ID'
	,pi.`cod_amount`/100 'COD金额 COD'
	,plt.`parcel_created_at` '揽收时间 Pick up time'
	,cast(pi.exhibition_weight as double)/1000 '重量 Weight'
    ,concat(pi.exhibition_length,'*',pi.exhibition_width,'*',pi.exhibition_height) '尺寸 Size'
	,case pi.parcel_category
     when '0' then '文件'
     when '1' then '干燥食品'
     when '10' then '家居用具'
    when '11' then '水果'
     when '2' then '日用品'
     when '3' then '数码产品'
     when '4' then '衣物'
     when '5' then '书刊'
    when '6' then '汽车配件'
     when '7' then '鞋包'
    when '8' then '体育器材'
     when '9' then '化妆品'
    when '99' then '其它'
    end  as '包裹品类 Item type'
	,pr.route_action 最后一条有效路由动作
	,wo.`order_no` '工单号 Ticket No.'
	,case  plt.`source`
        WHEN 1 THEN 'A-问题件-丢失'
        WHEN 2 THEN 'B-记录本-丢失'
        WHEN 3 THEN 'C-包裹状态未更新'
        WHEN 4 THEN 'D-问题件-破损/短少'
        WHEN 5 THEN 'E-记录本-索赔-丢失'
        WHEN 6 THEN 'F-记录本-索赔-破损/短少'
        WHEN 7 THEN 'G-记录本-索赔-其他'
        WHEN 8 THEN 'H-包裹状态未更新-IPC计数'
        WHEN 9 THEN 'I-问题件-外包装破损险'
        WHEN 10 THEN 'J-问题记录本-外包装破损险'
		WHEN 11 THEN 'K-超时效'
		when 12 then 'L-高度疑似丢失'
		END AS '问题件来源渠道 Source channel of issue'
	,case plt.`state`
	when 5 then '无需追责'
	when 6 then '责任人已认定'
	end  as '状态 Status'
    ,plt.`fleet_stores` '异常区间 Abnormal interval'
    ,ft.`line_name`  '异常车线  Abnormal LH'
	,plt.`operator_id` '处理人 Handler'
	,plt.`updated_at` '处理时间 Handle time'
	,plt.`penalty_base` '判罚依据 Basis of penalty'
    ,case plt.`link_type`
    WHEN 0 THEN 'ipc计数后丢失'
    WHEN 1 THEN '揽收网点已揽件，未收件入仓'
    WHEN 2 THEN '揽收网点已收件入仓，未发件出仓'
    WHEN 3 THEN '中转已到件入仓扫描，中转未发件出仓'
    WHEN 4 THEN '揽收网点已发件出仓扫描，分拨未到件入仓(集包)'
    WHEN 5 THEN '揽收网点已发件出仓扫描，分拨未到件入仓(单件)'
    WHEN 6 THEN '分拨发件出仓扫描，目的地未到件入仓(集包)'
    WHEN 7 THEN '分拨发件出仓扫描，目的地未到件入仓(单件)'
    WHEN 8 THEN '目的地到件入仓扫描，目的地未交接,当日遗失'
    WHEN 9 THEN '目的地到件入仓扫描，目的地未交接,次日遗失'
    WHEN 10 THEN '目的地交接扫描，目的地未妥投'
    WHEN 11 THEN '目的地妥投后丢失'
    WHEN 12 THEN '途中破损/短少'
    WHEN 13 THEN '妥投后破损/短少'
    WHEN 14 THEN '揽收网点已揽件，未收件入仓'
    WHEN 15 THEN '揽收网点已收件入仓，未发件出仓'
    WHEN 16 THEN '揽收网点发件出仓到分拨了'
    WHEN 17 THEN '目的地到件入仓扫描，目的地未交接'
    WHEN 18 THEN '目的地交接扫描，目的地未妥投'
    WHEN 19 THEN '目的地妥投后破损短少'
    WHEN 20 THEN '分拨已发件出仓，下一站分拨未到件入仓(集包)'
    WHEN 21 THEN '分拨已发件出仓，下一站分拨未到件入仓(单件)'
    WHEN 22 THEN 'ipc计数后丢失'
    WHEN 23 THEN '超时效SLA'
    WHEN 24 THEN '分拨发件出仓到下一站分拨了'
	end as '判责环节 Judgement'
    ,case if(plt.state= 6,plt.`duty_type`,null)
	when 1 then '快递员100%套餐'
    when 2 then '仓7主3套餐(仓管70%主管30%)'
 	when 4 then '双黄套餐(A网点仓管40%主管10%B网点仓管40%主管10%)'
    when 5 then  '快递员721套餐(快递员70%仓管20%主管10%)'
    when 6 then  '仓管721套餐(仓管70%快递员20%主管10%)'
    when 8 then  'LH全责（LH100%）'
    when 7 then  '其他(仅勾选“该运单的责任人需要特殊处理”时才能使用该项)'
    when 21 then  '仓7主3套餐(仓管70%主管30%)'
	end as '套餐 Penalty plan'
	,ss3.`name` '责任网点 Resposible DC'
	,case pct.state
                when 1 then '丢失件待协商'
                when 2 then '协商不一致'
                when 3 then '待财务核实'
                when 4 then '待财务支付'
                when 5 then '支付驳回'
                when 6 then '理赔完成'
                when 7 then '理赔终止'
                when 8 then '异常关闭'
                end as '理赔处理状态 Status of claim'
	,if(pct.state=6,pcn.claim_money,0) '理赔金额 Claim amount'
	,timestampdiff( hour ,plt.`created_at` ,plt.`updated_at`) '处理时效 Processing SLA'
	,DATE_FORMAT(plt.`updated_at`,'%Y%m%d') '统计日期 Statistical date'
	,plt.`remark` 备注




FROM  `ph_bi`.`parcel_lose_task` plt
LEFT JOIN `ph_staging`.`parcel_info`  pi on pi.pno = plt.pno
LEFT JOIN `ph_bi`.`sys_store` ss on ss.id = pi.`ticket_pickup_store_id`
LEFT JOIN `ph_bi`.`sys_store` ss1 on ss1.id = pi.`dst_store_id`

LEFT JOIN `ph_bi`.`work_order` wo on wo.`loseparcel_task_id` = plt.`id`
LEFT JOIN `ph_bi`.`fleet_time` ft on ft.`proof_id` =LEFT (plt.`fleet_routeids`,11)
LEFT JOIN `ph_bi`.`parcel_lose_stat_detail` pld on pld. `lose_task_id`=plt.`id`
LEFT JOIN `ph_bi`.`parcel_lose_responsible` plr on plr.`lose_task_id`=plt.`id`
LEFT JOIN `ph_bi`.`sys_store` ss3 on ss3.id = plr.store_id
LEFT JOIN `ph_bi`.`translations` t ON plt.duty_reasons = t.t_key AND t.`lang` = 'zh-CN'
LEFT JOIN
(

    SELECT *
     FROM
           (
                 SELECT pct.`pno`
                               ,pct.`id`
                    ,pct.`finance_updated_at`
                             ,pct.`state`
                               ,pct.`created_at`
                        ,row_number() over (partition by pct.`pno` order by pct.`created_at` DESC ) row_num
             FROM `ph_bi`.parcel_claim_task pct

           )t0
    WHERE t0.row_num=1
)pct on pct.pno=plt.pno
LEFT  join
        (
            select *
            from
                (
                select
                pcn.`task_id`
                ,replace(json_extract(pcn.`neg_result`,'$.money'),'\"','') claim_money
                ,row_number() over (partition by pcn.`task_id` order by pcn.`created_at` DESC ) row_num
                from `ph_bi`.parcel_claim_negotiation pcn
                ) t1
            where t1.row_num=1
        )pcn on pcn.task_id =pct.`id`
LEFT JOIN (select pr.`pno`,pr.store_id,pr.`routed_at`,pr.route_action,pr.store_name,pr.staff_info_id,pr.staff_info_phone,pr.staff_info_name,pr.extra_value
           from (select
         pr.`pno`,pr.store_id,pr.`routed_at`,pr.route_action,pr.store_name,pr.staff_info_id,pr.staff_info_phone,pr.staff_info_name,pr.extra_value,
         row_number() over(partition by pr.`pno` order by pr.`routed_at` desc) as rn
         from `ph_staging`.`parcel_route` pr
         where pr.`routed_at`>= CONVERT_TZ('2022-12-01','+08:00','+00:00')
         and pr.`route_action` in(
             select dd.`element`  from dwm.dwd_dim_dict dd where dd.remark ='valid')
                ) pr
         where pr.rn = 1
        ) pr on pr.pno=plt.`pno`
where 1=1
and plt.`state` in (6)
and plt.`operator_id` not in ('10000','10001')
and plt.`updated_at` >= '2023-01-01'
and plt.`updated_at` < '2023-04-01'
and plt.source in (1,2,3,5)
GROUP BY 2
ORDER BY 2;
;-- -. . -..- - / . -. - .-. -.--
with
    t as
(
    select
        plt2.pno
        ,pcol.created_at
        ,convert_tz(pcol.created_at, '+08:00', '+00:00') created_time
        ,plt2.client_id
        ,plt2.parcel_created_at
        ,plt2.id
    from ph_bi.parcel_cs_operation_log pcol
    left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
    where
        pcol.type = 1
        and pcol.action = 4
        and pcol.operator_id != 10001
        and pcol.created_at >= '2023-06-01'
        and pcol.created_at < '2023-07-01'
)
,
    pr as
(
    select
        t1.*
        ,pr.route_action
        ,pr.routed_at
        ,pr.store_name
        ,pr.store_id
        ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk2
    from ph_staging.parcel_route pr
    join t t1 on t1.pno = pr.pno
#     join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
    where
        pr.routed_at > t1.created_time
        and pr.route_action in ('SORTING_SCAN','DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE','DISTRIBUTION_INVENTORY','DELIVERY_TICKET_CREATION_SCAN','ARRIVAL_WAREHOUSE_SCAN','SHIPMENT_WAREHOUSE_SCAN','STAFF_INFO_UPDATE_WEIGHT','DELIVERY_CONFIRM','ACCEPT_PARCEL','REPLACE_PNO','UNSEAL','STORE_SORTER_UPDATE_WEIGHT','RECEIVED','PARCEL_HEADLESS_PRINTED','SEAL','DIFFICULTY_HANDOVER','DETAIN_WAREHOUSE','REFUND_CONFIRM','FLASH_HOME_SCAN','RECEIVE_WAREHOUSE_SCAN','PICKUP_RETURN_RECEIPT','STORE_KEEPER_UPDATE_WEIGHT','INVENTORY','DELIVERY_TRANSFER','DELIVERY_MARKER','DISCARD_RETURN_BKK','DELIVERY_PICKUP_STORE_SCAN')
)
select
    a.PNO
    ,case
        when bc.client_id is not null then bc.client_name
        when bc.client_id is null and kp.id is not null then 'KA'
        when kp.id is null then 'GE'
    end 客户类型
    ,case
        when a.diff_hour < 24 then '24小时内'
        when a.diff_hour >= 24 and a.diff_hour < 48 then '24-48小时'
        when a.diff_hour >= 48 and a.diff_hour < 72 then '48-72小时'
        when a.diff_hour >= 72 and a.diff_hour < 96 then '72-96小时'
        when a.diff_hour >= 96 and a.diff_hour < 120 then '96-120小时'
        when a.diff_hour >= 120 then '120小时以上'
    end 判责丢失后找回包裹时效
    ,if(pi.cod_enabled = 1, '是', '否') 是否COD
    ,if(pi.state = 5 , datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), a.created_at), null) 判责丢失后几天内投妥成功
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,if(a2.store_name = 'PN5-CS(INVENTORY)', '是', '否') 是否到拍卖场
    ,if(bc.client_name is not null ,
        case
            when bc.client_name = 'lazada' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= la.whole_end_date then '是'
            when bc.client_name = 'shopee' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= sh.end_date then '是'
            when bc.client_name = 'tiktok' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= if( tt.end_7_date is null, tt.end_date, tt.end_7_date) then '是'
            when bc.client_name = 'shein' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= ein.whole_end_date then '是'
            else '否'
        end, null) 是否在丢弃时效前有有效路由
from
    (
        select
            a.*
            ,timestampdiff(hour, a.created_at, convert_tz(a.routed_at, '+00:00', '+08:00')) diff_hour
        from pr a
        where
            a.rk = 1
    ) a
left join ph_staging.ka_profile kp on kp.id = a.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = a.client_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day )
left join ph_staging.parcel_info pi on pi.pno = a.pno
left join
    (
        select
            a.*
        from pr a
        where
            a.rk2 = 1
    ) a2 on a2.pno = a.pno
left join dwm.dwd_ex_ph_lazada_pno_period la on la.pno = a.pno
left join dwm.dwd_ex_shopee_lost_pno_period sh on sh.pno = a.pno
left join dwm.dwd_ex_ph_tiktok_sla_detail tt on tt.pno = a.pno
left join dwm.dwd_ex_ph_shein_sla_detail ein on ein.pno = a.pno;
;-- -. . -..- - / . -. - .-. -.--
with
    t as
(
    select
        plt2.pno
        ,pcol.created_at
        ,convert_tz(pcol.created_at, '+08:00', '+00:00') created_time
        ,plt2.client_id
        ,plt2.parcel_created_at
        ,plt2.id
    from ph_bi.parcel_cs_operation_log pcol
    left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
    where
        pcol.type = 1
        and pcol.action = 4
        and pcol.operator_id != 10001
        and pcol.created_at >= '2023-08-01'
        and pcol.created_at < '2023-09-01'
)
,
    pr as
(
    select
        t1.*
        ,pr.route_action
        ,pr.routed_at
        ,pr.store_name
        ,pr.store_id
        ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk2
    from ph_staging.parcel_route pr
    join t t1 on t1.pno = pr.pno
#     join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
    where
        pr.routed_at > t1.created_time
        and pr.route_action in ('SORTING_SCAN','DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE','DISTRIBUTION_INVENTORY','DELIVERY_TICKET_CREATION_SCAN','ARRIVAL_WAREHOUSE_SCAN','SHIPMENT_WAREHOUSE_SCAN','STAFF_INFO_UPDATE_WEIGHT','DELIVERY_CONFIRM','ACCEPT_PARCEL','REPLACE_PNO','UNSEAL','STORE_SORTER_UPDATE_WEIGHT','RECEIVED','PARCEL_HEADLESS_PRINTED','SEAL','DIFFICULTY_HANDOVER','DETAIN_WAREHOUSE','REFUND_CONFIRM','FLASH_HOME_SCAN','RECEIVE_WAREHOUSE_SCAN','PICKUP_RETURN_RECEIPT','STORE_KEEPER_UPDATE_WEIGHT','INVENTORY','DELIVERY_TRANSFER','DELIVERY_MARKER','DISCARD_RETURN_BKK','DELIVERY_PICKUP_STORE_SCAN')
)
select
    a.PNO
    ,case
        when bc.client_id is not null then bc.client_name
        when bc.client_id is null and kp.id is not null then 'KA'
        when kp.id is null then 'GE'
    end 客户类型
    ,case
        when a.diff_hour < 24 then '24小时内'
        when a.diff_hour >= 24 and a.diff_hour < 48 then '24-48小时'
        when a.diff_hour >= 48 and a.diff_hour < 72 then '48-72小时'
        when a.diff_hour >= 72 and a.diff_hour < 96 then '72-96小时'
        when a.diff_hour >= 96 and a.diff_hour < 120 then '96-120小时'
        when a.diff_hour >= 120 then '120小时以上'
    end 判责丢失后找回包裹时效
    ,case pi.cod_enabled
        when 0 then '否'
        when 1 then '是'
    end 是否COD
    ,if(pi.state = 5 , datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), a.created_at), null) 判责丢失后几天内投妥成功
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,if(a2.store_name = 'PN5-CS(INVENTORY)', '是', '否') 是否到拍卖场
    ,if(bc.client_name is not null ,
        case
            when bc.client_name = 'lazada' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= la.whole_end_date then '是'
            when bc.client_name = 'shopee' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= sh.end_date then '是'
            when bc.client_name = 'tiktok' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= if( tt.end_7_date is null, tt.end_date, tt.end_7_date) then '是'
            when bc.client_name = 'shein' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= ein.whole_end_date then '是'
            else '否'
        end, null) 是否在丢弃时效前有有效路由
from
    (
        select
            a.*
            ,timestampdiff(hour, a.created_at, convert_tz(a.routed_at, '+00:00', '+08:00')) diff_hour
        from pr a
        where
            a.rk = 1
    ) a
left join ph_staging.ka_profile kp on kp.id = a.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = a.client_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day )
left join ph_staging.parcel_info pi on pi.pno = a.pno
left join
    (
        select
            a.*
        from pr a
        where
            a.rk2 = 1
    ) a2 on a2.pno = a.pno
left join dwm.dwd_ex_ph_lazada_pno_period la on la.pno = a.pno
left join dwm.dwd_ex_shopee_lost_pno_period sh on sh.pno = a.pno
left join dwm.dwd_ex_ph_tiktok_sla_detail tt on tt.pno = a.pno
left join dwm.dwd_ex_ph_shein_sla_detail ein on ein.pno = a.pno;
;-- -. . -..- - / . -. - .-. -.--
with
    t as
(
    select
        plt2.pno
        ,pcol.created_at
        ,convert_tz(pcol.created_at, '+08:00', '+00:00') created_time
        ,plt2.client_id
        ,plt2.parcel_created_at
        ,plt2.id
    from ph_bi.parcel_cs_operation_log pcol
    left join ph_bi.parcel_lose_task plt2 on pcol.task_id = plt2.id
    where
        pcol.type = 1
        and pcol.action = 4
        and pcol.operator_id != 10001
        and pcol.created_at >= '2023-06-01'
        and pcol.created_at < '2023-07-01'
)
,
    pr as
(
    select
        t1.*
        ,pr.route_action
        ,pr.routed_at
        ,pr.store_name
        ,pr.store_id
        ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk2
    from ph_staging.parcel_route pr
    join t t1 on t1.pno = pr.pno
#     join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
    where
        pr.routed_at > t1.created_time
        and pr.route_action in ('SORTING_SCAN','DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE','DISTRIBUTION_INVENTORY','DELIVERY_TICKET_CREATION_SCAN','ARRIVAL_WAREHOUSE_SCAN','SHIPMENT_WAREHOUSE_SCAN','STAFF_INFO_UPDATE_WEIGHT','DELIVERY_CONFIRM','ACCEPT_PARCEL','REPLACE_PNO','UNSEAL','STORE_SORTER_UPDATE_WEIGHT','RECEIVED','PARCEL_HEADLESS_PRINTED','SEAL','DIFFICULTY_HANDOVER','DETAIN_WAREHOUSE','REFUND_CONFIRM','FLASH_HOME_SCAN','RECEIVE_WAREHOUSE_SCAN','PICKUP_RETURN_RECEIPT','STORE_KEEPER_UPDATE_WEIGHT','INVENTORY','DELIVERY_TRANSFER','DELIVERY_MARKER','DISCARD_RETURN_BKK','DELIVERY_PICKUP_STORE_SCAN')
)
select
    a.PNO
    ,a.parcel_created_at
    ,case
        when bc.client_id is not null then bc.client_name
        when bc.client_id is null and kp.id is not null then 'KA'
        when kp.id is null then 'GE'
    end 客户类型
    ,case
        when a.diff_hour < 24 then '24小时内'
        when a.diff_hour >= 24 and a.diff_hour < 48 then '24-48小时'
        when a.diff_hour >= 48 and a.diff_hour < 72 then '48-72小时'
        when a.diff_hour >= 72 and a.diff_hour < 96 then '72-96小时'
        when a.diff_hour >= 96 and a.diff_hour < 120 then '96-120小时'
        when a.diff_hour >= 120 then '120小时以上'
    end 判责丢失后找回包裹时效
    ,case pi.cod_enabled
        when 0 then '否'
        when 1 then '是'
    end 是否COD
    ,if(pi.state = 5 , datediff(convert_tz(pi.finished_at, '+00:00', '+08:00'), a.created_at), null) 判责丢失后几天内投妥成功
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,if(a2.store_name = 'PN5-CS(INVENTORY)', '是', '否') 是否到拍卖场
    ,if(bc.client_name is not null ,
        case
            when bc.client_name = 'lazada' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= la.whole_end_date then '是'
            when bc.client_name = 'shopee' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= sh.end_date then '是'
            when bc.client_name = 'tiktok' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= if( tt.end_7_date is null, tt.end_date, tt.end_7_date) then '是'
            when bc.client_name = 'shein' and date(convert_tz(a.routed_at, '+00:00', '+08:00')) <= ein.whole_end_date then '是'
            else '否'
        end, null) 是否在丢弃时效前有有效路由
from
    (
        select
            a.*
            ,timestampdiff(hour, a.created_at, convert_tz(a.routed_at, '+00:00', '+08:00')) diff_hour
        from pr a
        where
            a.rk = 1
    ) a
left join ph_staging.ka_profile kp on kp.id = a.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = a.client_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day )
left join ph_staging.parcel_info pi on pi.pno = a.pno
left join
    (
        select
            a.*
        from pr a
        where
            a.rk2 = 1
    ) a2 on a2.pno = a.pno
left join dwm.dwd_ex_ph_lazada_pno_period la on la.pno = a.pno
left join dwm.dwd_ex_shopee_lost_pno_period sh on sh.pno = a.pno
left join dwm.dwd_ex_ph_tiktok_sla_detail tt on tt.pno = a.pno
left join dwm.dwd_ex_ph_shein_sla_detail ein on ein.pno = a.pno;
;-- -. . -..- - / . -. - .-. -.--
select
    plt.pno
    ,plt.parcel_created_at
from ph_bi.parcel_lose_task plt
join tmpale.tmp_ph_pno_plt_0828 t on t.pno = plt.pno
group by 1,2;
;-- -. . -..- - / . -. - .-. -.--
select
    td.pno
    ,ss.name 网点
    ,convert_tz(pi.created_at, '+00:00', '+08:00') 揽收时间
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
from ph_staging.ticket_delivery td
left join ph_staging.parcel_info pi on pi.pno = td.pno
left join ph_staging.sys_store ss on ss.id = pi.ticket_pickup_store_id
left join ph_staging.ticket_delivery td2 on td2.pno = td.pno and td2.created_at > '2023-08-28 18:00:00'
where
    td.created_at <= '2023-08-28 18:00:00'
    and td.delivery_opt = 4
    and pi.state = 3
    and td.store_id in ('PH77190100','PH73090800','PH73020100','PH77030100','PH77050A00','PH76120H00','PH74060200','PH76090C00','PH74010100','PH76040A00','PH73030300','PH76190100','PH74120A00','PH75060200','PH51050301','PH47170100','PH51050500','PH49040100','PH51030400','PH51020J00','PH47140200','PH49040102','PH47210100','PH51100100','PH47080301','PH51080100','PH49040101','PH47070A00','PH47200600','PH47120100','PH47150100','PH51080101','PH51120B01','PH45210101','PH45212600','PH50100100','PH46020100','PH45130F00','PH46050101','PH45200H00','PH44020100','PH44180100','PH46150100','PH45210100','PH45010100','PH44010T00','PH50100200','PH45140300','PH14010F00','PH14010F00','PH22130500','PH23100300')
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    td.pno
    ,ss.name 网点
    ,convert_tz(pi.created_at, '+00:00', '+08:00') 揽收时间
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
from ph_staging.ticket_delivery td
left join ph_staging.parcel_info pi on pi.pno = td.pno
left join ph_staging.sys_store ss on ss.id = pi.ticket_pickup_store_id
left join ph_staging.ticket_delivery td2 on td2.pno = td.pno and td2.created_at > '2023-08-28 18:00:00'
where
    td.created_at <= '2023-08-28 18:00:00'
    and td.delivery_opt = 4
    and pi.state = 3
    and td2.pno is null
    and td.store_id in ('PH77190100','PH73090800','PH73020100','PH77030100','PH77050A00','PH76120H00','PH74060200','PH76090C00','PH74010100','PH76040A00','PH73030300','PH76190100','PH74120A00','PH75060200','PH51050301','PH47170100','PH51050500','PH49040100','PH51030400','PH51020J00','PH47140200','PH49040102','PH47210100','PH51100100','PH47080301','PH51080100','PH49040101','PH47070A00','PH47200600','PH47120100','PH47150100','PH51080101','PH51120B01','PH45210101','PH45212600','PH50100100','PH46020100','PH45130F00','PH46050101','PH45200H00','PH44020100','PH44180100','PH46150100','PH45210100','PH45010100','PH44010T00','PH50100200','PH45140300','PH14010F00','PH14010F00','PH22130500','PH23100300')
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    td.pno
    ,ss.name 网点
    ,convert_tz(pi.created_at, '+00:00', '+08:00') 揽收时间
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
from ph_staging.ticket_delivery td
left join ph_staging.parcel_info pi on pi.pno = td.pno
left join ph_staging.sys_store ss on ss.id = td.store_id
left join ph_staging.ticket_delivery td2 on td2.pno = td.pno and td2.created_at > '2023-08-28 18:00:00'
where
    td.created_at <= '2023-08-28 18:00:00'
    and td.delivery_opt = 4
    and pi.state = 3
    and td2.pno is null
    and td.store_id in ('PH77190100','PH73090800','PH73020100','PH77030100','PH77050A00','PH76120H00','PH74060200','PH76090C00','PH74010100','PH76040A00','PH73030300','PH76190100','PH74120A00','PH75060200','PH51050301','PH47170100','PH51050500','PH49040100','PH51030400','PH51020J00','PH47140200','PH49040102','PH47210100','PH51100100','PH47080301','PH51080100','PH49040101','PH47070A00','PH47200600','PH47120100','PH47150100','PH51080101','PH51120B01','PH45210101','PH45212600','PH50100100','PH46020100','PH45130F00','PH46050101','PH45200H00','PH44020100','PH44180100','PH46150100','PH45210100','PH45010100','PH44010T00','PH50100200','PH45140300','PH14010F00','PH14010F00','PH22130500','PH23100300')
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    vrv.type
    ,vrv.visit_result
from nl_production.violation_return_visit vrv
where
    vrv.created_at >= '2023-08-01'
    and vrv.type in (3,8);
;-- -. . -..- - / . -. - .-. -.--
select
    vrv.type
    ,vrv.visit_result
from nl_production.violation_return_visit vrv
where
    vrv.created_at >= '2023-08-01'
    and vrv.type in (3,8)
    and visit_state in (3,4,5,6,7)
group by 1,2;
;-- -. . -..- - / . -. - .-. -.--
select
    vrv.type
    ,vrv.visit_result
    ,count(vrv.id)
from nl_production.violation_return_visit vrv
where
    vrv.created_at >= '2023-08-01'
    and vrv.type in (3,8)
    and visit_state in (3,4,5,6,7)
    and vrv.created_at >= date_sub(curdate(), interval 7 day)
group by 1,2;
;-- -. . -..- - / . -. - .-. -.--
select
    ppl.replace_pno 输入单号
    ,case
        when bc.`client_id` is not null then bc.client_name
        when kp.id is not null and bc.client_id is null then '普通ka'
        when kp.`id` is null then '小c'
    end as  客户类型
    ,loi.item_name 产品名称
    ,if(bc.client_name = 'lazada', oi.insure_declare_value/100, oi.cogs_amount/100) 物品价值
    ,pi2.cod_amount/100 COD金额
from ph_staging.parcel_pno_log ppl
left join ph_staging.parcel_info pi on pi.pno = ppl.initial_pno
left join ph_staging.parcel_info pi2 on if(pi.returned = 0, pi.pno, pi.customary_pno) = pi2.pno
left join ph_drds.lazada_order_info_d loi on loi.pno = pi2.pno
left join ph_staging.order_info oi on oi.pno = pi2.pno
left join ph_staging.ka_profile kp on kp.id = pi2.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = pi2.client_id
join tmpale.tmp_ph_pno_lj_0829 t on t.pno = ppl.replace_pno
# where
#     ppl.replace_pno in ('${SUBSTITUTE(SUBSTITUTE(p2,"\n",","),",","','")}')

union all

select
    pi.pno 输入单号
    ,case
        when bc.`client_id` is not null then bc.client_name
        when kp.id is not null and bc.client_id is null then '普通ka'
        when kp.`id` is null then '小c'
    end as  客户类型
    ,loi.item_name 产品名称
    ,if(bc.client_name = 'lazada', oi.insure_declare_value/100, oi.cogs_amount/100) 物品价值
    ,pi2.cod_amount/100 COD金额
from ph_staging.parcel_info pi
left join ph_staging.parcel_info pi2 on if(pi.returned = 0, pi.pno, pi.customary_pno) = pi2.pno
left join ph_drds.lazada_order_info_d loi on loi.pno = pi2.pno
left join ph_staging.order_info oi on oi.pno = pi2.pno
left join ph_staging.ka_profile kp on kp.id = pi2.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = pi2.client_id
join tmpale.tmp_ph_pno_lj_0829 t on t.pno = pi.pno;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        pi.pno
        ,pi.state
        ,pi.ticket_pickup_store_id
        ,pi.returned
        ,pi.dst_store_id
        ,pi.client_id
        ,pi.cod_enabled
    from ph_staging.parcel_info pi
    where
        pi.created_at < '2023-08-19 16:00:00'
        and pi.state not in (5,7,8,9)
)
select
    t1.pno
    ,if(t1.returned = 1, '退件', '正向件')  方向
    ,t1.client_id 客户ID
    ,case
        when bc.`client_id` is not null then bc.client_name
        when kp.id is not null and bc.client_id is null then '普通ka'
        when kp.`id` is null then '小c'
    end as 客户类型
    ,case t1.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,case di.diff_marker_category # 疑难原因
        when 1 then '客户不在家/电话无人接听'
        when 2 then '收件人拒收'
        when 3 then '快件分错网点'
        when 4 then '外包装破损'
        when 5 then '货物破损'
        when 6 then '货物短少'
        when 7 then '货物丢失'
        when 8 then '电话联系不上'
        when 9 then '客户改约时间'
        when 10 then '客户不在'
        when 11 then '客户取消任务'
        when 12 then '无人签收'
        when 13 then '客户周末或假期不收货'
        when 14 then '客户改约时间'
        when 15 then '当日运力不足，无法派送'
        when 16 then '联系不上收件人'
        when 17 then '收件人拒收'
        when 18 then '快件分错网点'
        when 19 then '外包装破损'
        when 20 then '货物破损'
        when 21 then '货物短少'
        when 22 then '货物丢失'
        when 23 then '收件人/地址不清晰或不正确'
        when 24 then '收件地址已废弃或不存在'
        when 25 then '收件人电话号码错误'
        when 26 then 'cod金额不正确'
        when 27 then '无实际包裹'
        when 28 then '已妥投未交接'
        when 29 then '收件人电话号码是空号'
        when 30 then '快件分错网点-地址正确'
        when 31 then '快件分错网点-地址错误'
        when 32 then '禁运品'
        when 33 then '严重破损（丢弃）'
        when 34 then '退件两次尝试派送失败'
        when 35 then '不能打开locker'
        when 36 then 'locker不能使用'
        when 37 then '该地址找不到lockerstation'
        when 38 then '一票多件'
        when 39 then '多次尝试派件失败'
        when 40 then '客户不在家/电话无人接听'
        when 41 then '错过班车时间'
        when 42 then '目的地是偏远地区,留仓待次日派送'
        when 43 then '目的地是岛屿,留仓待次日派送'
        when 44 then '企业/机构当天已下班'
        when 45 then '子母件包裹未全部到达网点'
        when 46 then '不可抗力原因留仓(台风)'
        when 47 then '虚假包裹'
        when 48 then '转交FH包裹留仓'
        when 50 then '客户取消寄件'
        when 51 then '信息录入错误'
        when 52 then '客户取消寄件'
        when 53 then 'lazada仓库拒收'
        when 69 then '禁运品'
        when 70 then '客户改约时间'
        when 71 then '当日运力不足，无法派送'
        when 72 then '客户周末或假期不收货'
        when 73 then '收件人/地址不清晰或不正确'
        when 74 then '收件地址已废弃或不存在'
        when 75 then '收件人电话号码错误'
        when 76 then 'cod金额不正确'
        when 77 then '企业/机构当天已下班'
        when 78 then '收件人电话号码是空号'
        when 79 then '快件分错网点-地址错误'
        when 80 then '客户取消任务'
        when 81 then '重复下单'
        when 82 then '已完成揽件'
        when 83 then '联系不上客户'
        when 84 then '包裹不符合揽收条件（超大件、违禁物品）'
        when 85 then '寄件人电话号码是空号'
        when 86 then '包裹不符合揽收条件超大件'
        when 87 then '包裹不符合揽收条件违禁品'
        when 88 then '寄件人地址为岛屿'
        when 89 then '运力短缺，跟客户协商推迟揽收'
        when 90 then '包裹未准备好推迟揽收'
        when 91 then '包裹包装不符合运输标准'
        when 92 then '客户提供的清单里没有此包裹'
        when 93 then '包裹不符合揽收条件（超大件、违禁物品）'
        when 94 then '客户取消寄件/客户实际不想寄此包裹'
        when 95 then '车辆/人力短缺推迟揽收'
        when 96 then '遗漏揽收(已停用)'
        when 97 then '子母件(一个单号多个包裹)'
        when 98 then '地址错误addresserror'
        when 99 then '包裹不符合揽收条件：超大件'
        when 100 then '包裹不符合揽收条件：违禁品'
        when 101 then '包裹包装不符合运输标准'
        when 102 then '包裹未准备好'
        when 103 then '运力短缺，跟客户协商推迟揽收'
        when 104 then '子母件(一个单号多个包裹)'
        when 105 then '破损包裹'
        when 106 then '空包裹'
        when 107 then '不能打开locker(密码错误)'
        when 108 then 'locker不能使用'
        when 109 then 'locker找不到'
        when 110 then '运单号与实际包裹的单号不一致'
        when 111 then 'box客户取消任务'
        when 112 then '不能打开locker(密码错误)'
        when 113 then 'locker不能使用'
        when 114 then 'locker找不到'
        when 115 then '实际重量尺寸大于客户下单的重量尺寸'
        when 116 then '客户仓库关闭'
        when 117 then '客户仓库关闭'
        when 118 then 'SHOPEE订单系统自动关闭'
        when 119 then '客户取消包裹'
        when 121 then '地址错误'
        when 122 then '当日运力不足，无法揽收'
    end as 疑难原因
#     ,case
#         when t1.state = 6 and di.pno is not null then 'KAM/揽件网点未协商'
#         when t1.state = 6 and di.pno is null  then '闪速系统沟通处理中'
#         when t1.state != 6 and plt.pno is not null and plt2.pno is not null then '闪速系统沟通处理中'
#         when plt.pno is null and pct.pno is not null then '闪速超时效理赔未完成'
#         when de.last_store_id = t1.ticket_pickup_store_id and plt2.pno is null then '揽件未发出'
#         when t1.dst_store_id = 'PH19040F05' and plt2.pno is null then '弃件未到拍卖仓'
#         when t1.state != 6 and datediff(now(), convert_tz(pr.routed_at, '+00:00', '+08:00')) > 7 and plt2.pno is not null then 'QAQC无须追责后长期无有效路由'
#         else null
#     end 卡点原因
#     ,de.last_store_name 当前节点
    ,datediff(now(), convert_tz(pr.routed_at, '+00:00', '+08:00')) 最后有效路由距今天数
    ,case pr.route_action # 路由动作
         when 'ACCEPT_PARCEL' then '接件扫描'
         when 'ARRIVAL_GOODS_VAN_CHECK_SCAN' then '车货关联到港'
         when 'ARRIVAL_WAREHOUSE_SCAN' then '到件入仓扫描'
         when 'CANCEL_ARRIVAL_WAREHOUSE_SCAN' then '取消到件入仓扫描'
         when 'CANCEL_PARCEL' then '撤销包裹'
         when 'CANCEL_SHIPMENT_WAREHOUSE' then '取消发件出仓'
         when 'CHANGE_PARCEL_CANCEL' then '修改包裹为撤销'
         when 'CHANGE_PARCEL_CLOSE' then '修改包裹为异常关闭'
         when 'CHANGE_PARCEL_IN_TRANSIT' then '修改包裹为运输中'
         when 'CHANGE_PARCEL_INFO' then '修改包裹信息'
         when 'CHANGE_PARCEL_SIGNED' then '修改包裹为签收'
         when 'CLAIMS_CLOSE' then '理赔关闭'
         when 'CLAIMS_COMPLETE' then '理赔完成'
         when 'CLAIMS_CONTACT' then '已联系客户'
         when 'CLAIMS_TRANSFER_CS' then '转交总部cs处理'
         when 'CLOSE_ORDER' then '关闭订单'
         when 'CONTINUE_TRANSPORT' then '疑难件继续配送'
         when 'CREATE_WORK_ORDER' then '创建工单'
         when 'CUSTOMER_CHANGE_PARCEL_INFO' then '客户修改包裹信息'
         when 'CUSTOMER_OPERATING_RETURN' then '客户操作退回寄件人'
         when 'DELIVERY_CONFIRM' then '确认妥投'
         when 'DELIVERY_MARKER' then '派件标记'
         when 'DELIVERY_PICKUP_STORE_SCAN' then '自提取件扫描'
         when 'DELIVERY_TICKET_CREATION_SCAN' then '交接扫描'
         when 'DELIVERY_TRANSFER' then '派件转单'
         when 'DEPARTURE_GOODS_VAN_CK_SCAN' then '车货关联出港'
         when 'DETAIN_WAREHOUSE' then '货件留仓'
         when 'DIFFICULTY_FINISH_INDEMNITY' then '疑难件支付赔偿'
         when 'DIFFICULTY_HANDOVER' then '疑难件交接'
         when 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE' then '疑难件交接货件留仓'
         when 'DIFFICULTY_RE_TRANSIT' then '疑难件退回区域总部/重启运送'
         when 'DIFFICULTY_RETURN' then '疑难件退回寄件人'
         when 'DIFFICULTY_SEAL' then '集包异常'
         when 'DISCARD_RETURN_BKK' then '丢弃包裹的，换单后寄回BKK'
         when 'DISTRIBUTION_INVENTORY' then '分拨盘库'
         when 'DWS_WEIGHT_IMAGE' then 'DWS复秤照片'
         when 'EXCHANGE_PARCEL' then '换货'
         when 'FAKE_CANCEL_HANDLE' then '虚假撤销判责'
         when 'FLASH_HOME_SCAN' then 'FH交接扫描'
         when 'FORCE_TAKE_PHOTO' then '强制拍照路由'
         when 'HAVE_HAIR_SCAN_NO_TO' then '有发无到'
         when 'HURRY_PARCEL' then '催单'
         when 'INCOMING_CALL' then '来电接听'
         when 'INTERRUPT_PARCEL_AND_RETURN' then '中断运输并退回'
         when 'INVENTORY' then '盘库'
         when 'LOSE_PARCEL_TEAM_OPERATION' then '丢失件团队处理'
         when 'MANUAL_REMARK' then '添加备注'
         when 'MISS_PICKUP_HANDLE' then '漏包裹揽收判责'
         when 'MISSING_PARCEL_SCAN' then '丢失件包裹操作'
         when 'NOTICE_LOST_PARTS_TEAM' then '已通知丢失件团队'
         when 'PARCEL_HEADLESS_CLAIMED' then '无头件包裹已认领'
         when 'PARCEL_HEADLESS_PRINTED' then '无头件包裹已打单'
         when 'PENDING_RETURN' then '待退件'
         when 'PHONE' then '电话联系'
         when 'PICK_UP_STORE' then '待自提取件'
         when 'PICKUP_RETURN_RECEIPT' then '签回单揽收'
         when 'PRINTING' then '打印面单'
         when 'QAQC_OPERATION' then 'QAQC判责'
         when 'RECEIVE_WAREHOUSE_SCAN' then '收件入仓'
         when 'RECEIVED' then '已揽收'
         when 'REFUND_CONFIRM' then '退件妥投'
         when 'REPAIRED' then '上报问题修复路由'
         when 'REPLACE_PNO' then '换单'
         when 'REPLY_WORK_ORDER' then '回复工单'
         when 'REVISION_TIME' then '改约时间'
         when 'SEAL' then '集包'
         when 'SEAL_NUMBER_CHANGE' then '集包件数变化'
         when 'SHIPMENT_WAREHOUSE_SCAN' then '发件出仓扫描'
         when 'SORTER_WEIGHT_IMAGE' then '分拣机复秤照片'
         when 'SORTING_SCAN' then '分拣扫描'
         when 'STAFF_INFO_UPDATE_WEIGHT' then '快递员修改重量'
         when 'STORE_KEEPER_UPDATE_WEIGHT' then '仓管员复秤'
         when 'STORE_SORTER_UPDATE_WEIGHT' then '分拣机复秤'
         when 'SYSTEM_AUTO_RETURN' then '系统自动退件'
         when 'TAKE_PHOTO' then '异常打单拍照'
         when 'THIRD_EXPRESS_ROUTE' then '第三方公司路由'
         when 'THIRD_PARTY_REASON_DETAIN' then '第三方原因滞留'
         when 'TICKET_WEIGHT_IMAGE' then '揽收称重照片'
         when 'TRANSFER_LOST_PARTS_TEAM' then '已转交丢失件团队'
         when 'TRANSFER_QAQC' then '转交QAQC处理'
         when 'UNSEAL' then '拆包'
         when 'UNSEAL_NO_PARCEL' then '上报包裹不在集包里'
         when 'UNSEAL_NOT_SCANNED' then '集包已拆包，本包裹未被扫描'
         when 'VEHICLE_ACCIDENT_REG' then '车辆车祸登记'
         when 'VEHICLE_ACCIDENT_REGISTRATION' then '车辆车祸登记'
         when 'VEHICLE_WET_DAMAGE_REG' then '车辆湿损登记'
         when 'VEHICLE_WET_DAMAGE_REGISTRATION' then '车辆湿损登记'
        end as 最后一条路由
    ,pr.store_name 最后有效路由动作网点
    ,convert_tz(pr.routed_at ,'+00:00', '+08:00') 最新一条有效路由时间
    ,datediff(now(), de.dst_routed_at) 目的地网点停留时间
    ,de.dst_store 目的地网点
    ,de.dst_piece
    ,de.dst_region
    ,de.src_store 揽收网点
    ,de.pickup_time 揽收时间
    ,de.pick_date 揽收日期
    ,if(hold.pno is not null, 'yes', 'no' ) 是否有holding标记
    ,if(pr3.pno is not null, 'yes', 'no') 是否有待退件标记
    ,td.try_num 尝试派送次数
from t t1
left join ph_staging.ka_profile kp on t1.client_id = kp.id
left join dwm.dwd_dim_bigClient bc on bc.client_id = t1.client_id
left join dwm.dwd_ex_ph_parcel_details de on de.pno = t1.pno
left join
    (
        select
            plt.pno
            ,group_concat(ss.name ) should_do
        from ph_bi.parcel_lose_task plt
        join t t1 on t1.pno = plt.pno
        left join ph_bi.work_order wo on wo.loseparcel_task_id = plt.id
        left join ph_staging.sys_store ss on ss.id = wo.store_id
        where
            plt.state in (3)
            and wo.status in (1,2)
        group by 1

        union  all

        select
            plt.pno
            ,'QAQC' should_do
        from ph_bi.parcel_lose_task plt
        join t t1 on t1.pno = plt.pno
        where
            plt.state in (1,2,4)
    ) plt on plt.pno = t1.pno
left join
    (
        select
            t2.pno
            ,cdt.negotiation_result_category
            ,di.diff_marker_category
            ,case
                when di.diff_marker_category in (20,21)  and cdt.vip_enable = 1 then 'KAM'
                when di.diff_marker_category not in (20,21) and cdt.vip_enable = 1 then 'KAM'
                when di.diff_marker_category not in (20,21) and cdt.vip_enable = 0 then ss2.name
                WHEN di.diff_marker_category in (20,21) and cdt.vip_enable = 0 then ss2.name
            end sh_do
        from ph_staging.diff_info di
        join t t2 on t2.pno = di.pno
        join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
        left join ph_bi.parcel_lose_task plt on plt.source_id = cdt.id
        left join ph_staging.sys_store ss2 on ss2.id = t2.ticket_pickup_store_id
        where
            cdt.negotiation_result_category is null
    ) di on di.pno = t1.pno
left join  
    (
        select
            pr.pno
            ,pr.store_name
            ,pr.routed_at
            ,pr.route_action
            ,row_number() over (partition by pr.pno order by pr.routed_at desc ) rk
        from  ph_staging.parcel_route pr
        join t t3 on t3.pno = pr.pno
        where
            pr.route_action in ('INVENTORY','RECEIVED' ,'RECEIVE_WAREHOUSE_SCAN', 'SORTING_SCAN', 'DELIVERY_TICKET_CREATION_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SHIPMENT_WAREHOUSE_SCAN', 'DETAIN_WAREHOUSE', 'DELIVERY_CONFIRM', 'DIFFICULTY_HANDOVER', 'DELIVERY_MARKER', 'REPLACE_PNO','SEAL', 'UNSEAL', 'STAFF_INFO_UPDATE_WEIGHT', 'STORE_KEEPER_UPDATE_WEIGHT', 'STORE_SORTER_UPDATE_WEIGHT', 'DISCARD_RETURN_BKK', 'DELIVERY_TRANSFER', 'PICKUP_RETURN_RECEIPT', 'FLASH_HOME_SCAN', 'ARRIVAL_WAREHOUSE_SCAN', 'SORTING_SCAN ', 'DELIVERY_PICKUP_STORE_SCAN', 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE', 'REFUND_CONFIRM', 'ACCEPT_PARCEL')
            and pr.organization_type = 1
        ) pr on pr.pno = t1.pno and pr.rk = 1
left join
    (
        select
            plt.pno
        from ph_bi.parcel_lose_task plt
        join t t1 on t1.pno = plt.pno
        where
            plt.state = 5
            and plt.operator_id not in (10000,10001,10002)
        group by 1
    ) plt2 on plt2.pno = t1.pno
left join
    (
        select
            plt.pno
        from ph_bi.parcel_claim_task plt
        join t t4  on t4.pno = plt.pno
        where
            plt.state not in (6,7,8)
            and plt.source = 11
        group by 1
    ) pct on pct.pno = t1.pno
left join
    (
        select
            pr2.pno
        from ph_staging.parcel_route pr2
        join t t1 on t1.pno = pr2.pno
        where
            pr2.route_action = 'REFUND_CONFIRM'
        group by 1
    ) hold on hold.pno = t1.pno
left join
    (
        select
            pr2.pno
        from  ph_staging.parcel_route pr2
        join t t1 on t1.pno = pr2.pno
        where
            pr2.route_action = 'PENDING_RETURN'
        group by 1
    ) pr3 on pr3.pno = t1.pno
left join
    (
        select
            td.pno
            ,count(distinct date(convert_tz(tdm.created_at, '+00:00', '+08:00'))) try_num
        from ph_staging.ticket_delivery td
        join t t1 on t1.pno = td.pno
        left join ph_staging.ticket_delivery_marker tdm on tdm.delivery_id = td.id
        group by 1
    ) td on td.pno = t1.pno
group by t1.pno;
;-- -. . -..- - / . -. - .-. -.--
select
    vrv.type
    ,vrv.visit_state
    ,count(vrv.id)
from nl_production.violation_return_visit vrv
where
    vrv.created_at >= '2023-08-01'
    and vrv.type in (3,8)
    and visit_state in (3,4,5,6,7)
    and vrv.created_at >= date_sub(curdate(), interval 7 day)
group by 1,2;
;-- -. . -..- - / . -. - .-. -.--
select
    vrv.type
    ,vrv.visit_state
    ,vrv.visit_result
    ,count(vrv.id)
from nl_production.violation_return_visit vrv
where
    vrv.created_at >= '2023-08-01'
    and vrv.type in (3,8)
    and visit_state in (3,4,5,6,7)
    and vrv.created_at >= date_sub(curdate(), interval 7 day)
group by 1,2,3;
;-- -. . -..- - / . -. - .-. -.--
select
    vrv.type
    ,case vrv.visit_state
            when 0 then '终态或变更派件标记等无须回访'
            when 1 then '待回访'
            when 2 then '沟通中'
            when 3 then '多次未联系上客户'
            when 4 then '已回访'
            when 5 then '因同包裹生成其他回访任务关闭'
            when 6 then 'VR回访结果=99关闭'
            when 7 then '超回访时效关闭'
        end 回访状态
    ,case vrv.visit_result
        when 1 then '联系不上'
        when 2 then '取消原因属实、合理'
        when 3 then '快递员虚假标记/违背客户意愿要求取消'
        when 4 then '多次联系不上客户'
        when 5 then '收件人已签收包裹'
        when 6 then '收件人未收到包裹'
        when 7 then '未经收件人允许投放他处/让他人代收'
        when 8 then '快递员没有联系客户，直接标记收件人拒收'
        when 9 then '收件人拒收情况属实'
        when 10 then '快递员服务态度差'
        when 11 then '因快递员未按照收件人地址送货，客户不方便去取货'
        when 12 then '网点派送速度慢，客户不想等'
        when 13 then '非快递员问题，个人原因拒收'
        when 14 then '其它'
        when 15 then '未经客户同意改约派件时间'
        when 16 then '未按约定时间派送'
        when 17 then '派件前未提前联系客户'
        when 18 then '收件人拒收情况不属实'
        when 19 then '快递员联系客户，但未经客户同意标记收件人拒收'
        when 20 then '快递员要求/威胁客户拒收'
        when 21 then '快递员引导客户拒收'
        when 22 then '其他'
        when 23 then '情况不属实，快递员虚假标记'
        when 24 then '情况不属实，快递员诱导客户改约时间'
        when 25 then '情况属实，客户原因改约时间'
        when 26 then '客户退货，不想购买该商品'
        when 27 then '客户未购买商品'
        when 28 then '客户本人/家人对包裹不知情而拒收'
        when 29 then '商家发错商品'
        when 30 then '包裹物流派送慢超时效'
        when 31 then '快递员服务态度差'
        when 32 then '因快递员未按照收件人地址送货，客户不方便去取货'
        when 33 then '货物验收破损'
        when 34 then '无人在家不便签收'
        when 35 then '客户错误拒收包裹'
        when 36 then '快递员按照要求当场扫描揽收'
        when 37 then '快递员未按照要求当场扫描揽收'
        when 38 then '无所谓，客户无要求'
        when 39 then '包裹未准备好 - 情况不属实，快递员虚假标记'
        when 40 then '包裹未准备好 - 情况属实，客户存在未准备好的包裹'
        when 41 then '虚假修改包裹信息'
        when 42 then '修改包裹信息属实'
        when 43 then '客户需要包裹，继续派送'
        when 44 then '客户不需要包裹，操作退件'
    end as 回访结果
    ,count(vrv.id)
from nl_production.violation_return_visit vrv
where
    vrv.created_at >= '2023-08-01'
    and vrv.type in (3,8)
    and visit_state in (3,4,5,6,7)
    and vrv.created_at >= date_sub(curdate(), interval 7 day)
group by 1,2,3;
;-- -. . -..- - / . -. - .-. -.--
select
    vrv.type
    ,case vrv.visit_state
            when 0 then '终态或变更派件标记等无须回访'
            when 1 then '待回访'
            when 2 then '沟通中'
            when 3 then '多次未联系上客户'
            when 4 then '已回访'
            when 5 then '因同包裹生成其他回访任务关闭'
            when 6 then 'VR回访结果=99关闭'
            when 7 then '超回访时效关闭'
        end 回访状态
    ,case vrv.visit_result
        when 1 then '联系不上'
        when 2 then '取消原因属实、合理'
        when 3 then '快递员虚假标记/违背客户意愿要求取消'
        when 4 then '多次联系不上客户'
        when 5 then '收件人已签收包裹'
        when 6 then '收件人未收到包裹'
        when 7 then '未经收件人允许投放他处/让他人代收'
        when 8 then '快递员没有联系客户，直接标记收件人拒收'
        when 9 then '收件人拒收情况属实'
        when 10 then '快递员服务态度差'
        when 11 then '因快递员未按照收件人地址送货，客户不方便去取货'
        when 12 then '网点派送速度慢，客户不想等'
        when 13 then '非快递员问题，个人原因拒收'
        when 14 then '其它'
        when 15 then '未经客户同意改约派件时间'
        when 16 then '未按约定时间派送'
        when 17 then '派件前未提前联系客户'
        when 18 then '收件人拒收情况不属实'
        when 19 then '快递员联系客户，但未经客户同意标记收件人拒收'
        when 20 then '快递员要求/威胁客户拒收'
        when 21 then '快递员引导客户拒收'
        when 22 then '其他'
        when 23 then '情况不属实，快递员虚假标记'
        when 24 then '情况不属实，快递员诱导客户改约时间'
        when 25 then '情况属实，客户原因改约时间'
        when 26 then '客户退货，不想购买该商品'
        when 27 then '客户未购买商品'
        when 28 then '客户本人/家人对包裹不知情而拒收'
        when 29 then '商家发错商品'
        when 30 then '包裹物流派送慢超时效'
        when 31 then '快递员服务态度差'
        when 32 then '因快递员未按照收件人地址送货，客户不方便去取货'
        when 33 then '货物验收破损'
        when 34 then '无人在家不便签收'
        when 35 then '客户错误拒收包裹'
        when 36 then '快递员按照要求当场扫描揽收'
        when 37 then '快递员未按照要求当场扫描揽收'
        when 38 then '无所谓，客户无要求'
        when 39 then '包裹未准备好 - 情况不属实，快递员虚假标记'
        when 40 then '包裹未准备好 - 情况属实，客户存在未准备好的包裹'
        when 41 then '虚假修改包裹信息'
        when 42 then '修改包裹信息属实'
        when 43 then '客户需要包裹，继续派送'
        when 44 then '客户不需要包裹，操作退件'
    end as 回访结果
    ,count(vrv.id)
from nl_production.violation_return_visit vrv
join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id and bc.client_name = 'tiktok'
where
    vrv.created_at >= '2023-08-01'
    and vrv.type in (3,8)
    and visit_state in (3,4,5,6,7)
    and vrv.created_at >= date_sub(curdate(), interval 7 day)
group by 1,2,3;
;-- -. . -..- - / . -. - .-. -.--
select
    td.pno
    ,ss.name 网点
    ,convert_tz(pi.created_at, '+00:00', '+08:00') 揽收时间
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
from ph_staging.ticket_delivery td
left join ph_staging.parcel_info pi on pi.pno = td.pno
left join ph_staging.sys_store ss on ss.id = td.store_id
left join ph_staging.ticket_delivery td2 on td2.pno = td.pno and td2.created_at > '2023-08-29 18:00:00'
where
    td.created_at <= '2023-08-29 18:00:00'
    and td.delivery_opt = 4
    and pi.state = 3
    and td2.pno is null
    and td.store_id in ('PH77190100','PH73090800','PH73020100','PH77030100','PH77050A00','PH76120H00','PH74060200','PH76090C00','PH74010100','PH76040A00','PH73030300','PH76190100','PH74120A00','PH75060200','PH51050301','PH47170100','PH51050500','PH49040100','PH51030400','PH51020J00','PH47140200','PH49040102','PH47210100','PH51100100','PH47080301','PH51080100','PH49040101','PH47070A00','PH47200600','PH47120100','PH47150100','PH51080101','PH51120B01','PH45210101','PH45212600','PH50100100','PH46020100','PH45130F00','PH46050101','PH45200H00','PH44020100','PH44180100','PH46150100','PH45210100','PH45010100','PH44010T00','PH50100200','PH45140300','PH14010F00','PH14010F00','PH22130500','PH23100300')
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
*
from tmpale.tmp_ph_client_type_info t;
;-- -. . -..- - / . -. - .-. -.--
select
    t.type
    ,t.client_name

from tmpale.tmp_ph_client_visit_info t;
;-- -. . -..- - / . -. - .-. -.--
select
    t.type
    ,t.client_name
    ,his.回访任务量 历史积压量
    ,his.历史积压当日处理完成量
    ,his.历史积压未完成量
    ,upp.ticket_count '昨日17-今日9点创建量'
    ,upp.done_ticket_count '昨日17-今日9点处理完成量'
    ,upp.deal_rate '昨日17-今日9点完成率'
    ,low.ticket_count '今日9点-今日17点生成量'
    ,low.done_ticket_count '今日9点-今日17点处理完成量'
    ,low.deal_rate '今日9点-今日17点处理完成率'
    ,tod.未开始拨打数量
    ,tod.拨打一次数量
    ,tod.拨打两次数量
    ,tod.拨打完成数量
    ,total.ticket_count  当日总任务量 -- 17-17
    ,total.day_deal_rate 当日处理完成率  -- 17-17
    ,total.undeal_diff_count 处理完包裹中关联的疑难件未解锁的量 -- 17-17
    ,result.delivery_again_count 继续派送量
    ,result.rts_count 退件量
    ,result.close_count 异常关闭量
from tmpale.tmp_ph_client_visit_info t
left join
    (
        select
#             case vrv.type
#                 when 1 then '揽件任务异常取消'
#                 when 2 then '虚假妥投'
#                 when 3 then '收件人拒收'
#                 when 4 then '标记客户改约时间'
#                 when 5 then 'KA现场不揽收'
#                 when 6 then '包裹未准备好'
#                 when 7 then '上报错分未妥投'
#                 when 8 then '多次尝试派送失败'
#             end vrv_type
            vrv.type
            ,bc.client_name
            ,count(vrv.id) 回访任务量
            ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at >= '2023-08-30' and vrv.updated_at < date_add('2023-08-30', interval 1 day), vrv.id, null)) 历史积压当日处理完成量 -- 查训当日处理完成量
            ,count(if(vrv.visit_state in (1,2), vrv.id, null )) 历史积压未完成量
        from nl_production.violation_return_visit vrv
        join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        where
            vrv.type in (3,8)
            and vrv.created_at <= date_sub('2023-08-30', interval 7 hour) -- 昨天17点之前
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                (
                    (vrv.visit_state in (3,4,5,6,7) and vrv.updated_at > date_sub('2023-08-30', interval 7 hour)) -- 查询日期17点之后处理
                    or vrv.visit_state in (1,2) -- 至今也是未处理
                )
            and
                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ) ) -- IVR应处理
        group by 1,2
    ) his on his.client_name = t.client_name and his.type = t.type
left join
    (
        select
            vrv.type
            ,bc.client_name
            ,count(vrv.id) ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) , vrv.id, null)) done_ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) , vrv.id, null))/count(vrv.id) deal_rate
        from nl_production.violation_return_visit vrv
        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        where
            vrv.type in (3,8)
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ) )
            and vrv.created_at >= date_sub('2023-08-30', interval 7 hour)
            and vrv.created_at < date_add('2023-08-30', interval 9 hour) -- 昨日17至今日9点
        group by 1,2
    ) upp on upp.type = t.type and upp.client_name = t.client_name
left join
    (
        select
            vrv.type
            ,bc.client_name
            ,count(vrv.id) ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) , vrv.id, null)) done_ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) , vrv.id, null))/count(vrv.id) deal_rate
        from nl_production.violation_return_visit vrv
        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        where
            vrv.type in (3,8)
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ) )
            and vrv.created_at >= date_add('2023-08-30', interval 9 hour)
            and vrv.created_at < date_add('2023-08-30', interval 17 hour) -- 昨日17至今日9点
        group by 1,2
    ) low on low.type = t.type and low.client_name = t.client_name
left join
    (
        select
            vrv.type
            ,bc.client_name
            ,count(vrv.id) ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < date_add('2023-08-30', interval 1 day), vrv.id, null))/count(vrv.id) day_deal_rate
            ,count(if(cdt.state != 1, vrv.id, null)) undeal_diff_count
        from nl_production.violation_return_visit vrv
        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = json_extract(vrv.extra_value, '$.diff_id')
        where
            vrv.type in (3,8)
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ))
            and vrv.created_at >= date_sub('2023-08-30', interval 7 hour)
            and vrv.created_at < date_add('2023-08-30', interval 17 hour) -- 17-17
        group by 1,2
    ) total on total.type = t.type and total.client_name = t.client_name
left join
    (
        select
            a1.type
            ,a1.client_name
            ,count(if(a1.result = '退件', a1.id, null)) rts_count
            ,count(if(a1.result = '继续派送', a1.id, null)) delivery_again_count
            ,count(if(a1.result = '异常关闭', a1.id, null)) close_count
        from
            (
                select
                    a.type
                    ,a.client_name
                    ,case
                        when a.type = 3 and a.visit_state in (3,7) or a.rejection_delivery_again = 1 then '退件' -- 多次联系不上、超时效和回访结果是退件
                        when a.type = 3 and a.rejection_delivery_again = 2 then '继续派送' -- 继续派送
                        when a.type = 8 and a.visit_state in (3,7) or a.visit_result = 44 then '退件' --  多次联系不上和回访结果是退件
                        when a.type = 8 and  a.visit_result = 43 then '继续派送'
                        else '异常关闭'
                    end result
                    ,a.id
                from
                    (
                        select
                            vrv.type
                            ,bc.client_name
                            ,vrv.visit_state
                            ,vrv.visit_result
                            ,vrv.id
                            ,json_extract(vrv.extra_value, '$.rejection_delivery_again') rejection_delivery_again
                        from nl_production.violation_return_visit vrv
                        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
                        where
                            vrv.type in (3,8)
                            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
                            and
                                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ))
                            and vrv.created_at >= date_sub('2023-08-30', interval 7 hour)
                            and vrv.created_at < date_add('2023-08-30', interval 17 hour)
                    ) a
            ) a1
        group by 1,2
    ) result on result.type = t.type and result.client_name = t.client_name
left join
    (
        select
            vrv.type
            ,bc.client_name
            ,count(if(vrv.visit_num = 0 ,vrv.id, null)) 未开始拨打数量
            ,count(if(vrv.visit_num = 1, vrv.id, null)) 拨打一次数量
            ,count(if(vrv.visit_num = 2, vrv.id, null)) 拨打两次数量
            ,count(if(vrv.visit_state in (3,4,5,6,7), vrv.id, null)) 拨打完成数量
        from nl_production.violation_return_visit vrv
        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        where
            vrv.type in (3,8)
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ))
            and vrv.created_at >= date_add('2023-08-30', interval 17 hour)
            and vrv.created_at < date_add('2023-08-30', interval 20 hour) -- 当日17-20
        group by 1,2
    ) tod on tod.type = t.type and tod.client_name = t.client_name;
;-- -. . -..- - / . -. - .-. -.--
select
    t.type
    ,t.client_name
    ,his.回访任务量 历史积压量
    ,his.历史积压当日处理完成量
    ,his.历史积压未完成量
    ,upp.ticket_count '昨日17-今日9点创建量'
    ,upp.done_ticket_count '昨日17-今日9点处理完成量'
    ,upp.deal_rate '昨日17-今日9点完成率'
    ,low.ticket_count '今日9点-今日17点生成量'
    ,low.done_ticket_count '今日9点-今日17点处理完成量'
    ,low.deal_rate '今日9点-今日17点处理完成率'
    ,tod.未开始拨打数量
    ,tod.拨打一次数量
    ,tod.拨打两次数量
    ,tod.拨打完成数量
    ,total.ticket_count  当日总任务量 -- 17-17
    ,total.day_deal_rate 当日处理完成率  -- 17-17
    ,total.undeal_diff_count 处理完包裹中关联的疑难件未解锁的量 -- 17-17
    ,result.delivery_again_count 继续派送量
    ,result.rts_count 退件量
    ,result.close_count 异常关闭量
from tmpale.tmp_ph_client_visit_info t
left join
    (
        select
#             case vrv.type
#                 when 1 then '揽件任务异常取消'
#                 when 2 then '虚假妥投'
#                 when 3 then '收件人拒收'
#                 when 4 then '标记客户改约时间'
#                 when 5 then 'KA现场不揽收'
#                 when 6 then '包裹未准备好'
#                 when 7 then '上报错分未妥投'
#                 when 8 then '多次尝试派送失败'
#             end vrv_type
            vrv.type
            ,bc.client_name
            ,count(vrv.id) 回访任务量
            ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at >= date_sub('2023-08-30', interval 7 hour), vrv.id, null)) 历史积压处理完成量 -- 查训当日处理完成量
            ,count(if(vrv.visit_state in (1,2), vrv.id, null )) 历史积压未完成量
        from nl_production.violation_return_visit vrv
        join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        where
            vrv.type in (3,8)
            and vrv.created_at <= date_sub('2023-08-30', interval 7 hour) -- 昨天17点之前
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                (
                    (vrv.visit_state in (3,4,5,6,7) and vrv.updated_at > date_sub('2023-08-30', interval 7 hour)) -- 查询日期17点之后处理
                    or vrv.visit_state in (1,2) -- 至今也是未处理
                )
            and
                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ) ) -- IVR应处理
        group by 1,2
    ) his on his.client_name = t.client_name and his.type = t.type
left join
    (
        select
            vrv.type
            ,bc.client_name
            ,count(vrv.id) ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) , vrv.id, null)) done_ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) , vrv.id, null))/count(vrv.id) deal_rate
        from nl_production.violation_return_visit vrv
        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        where
            vrv.type in (3,8)
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ) )
            and vrv.created_at >= date_sub('2023-08-30', interval 7 hour)
            and vrv.created_at < date_add('2023-08-30', interval 9 hour) -- 昨日17至今日9点
        group by 1,2
    ) upp on upp.type = t.type and upp.client_name = t.client_name
left join
    (
        select
            vrv.type
            ,bc.client_name
            ,count(vrv.id) ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) , vrv.id, null)) done_ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) , vrv.id, null))/count(vrv.id) deal_rate
        from nl_production.violation_return_visit vrv
        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        where
            vrv.type in (3,8)
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ) )
            and vrv.created_at >= date_add('2023-08-30', interval 9 hour)
            and vrv.created_at < date_add('2023-08-30', interval 17 hour) -- 昨日17至今日9点
        group by 1,2
    ) low on low.type = t.type and low.client_name = t.client_name
left join
    (
        select
            vrv.type
            ,bc.client_name
            ,count(vrv.id) ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < date_add('2023-08-30', interval 1 day), vrv.id, null))/count(vrv.id) day_deal_rate
            ,count(if(cdt.state != 1, vrv.id, null)) undeal_diff_count
        from nl_production.violation_return_visit vrv
        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = json_extract(vrv.extra_value, '$.diff_id')
        where
            vrv.type in (3,8)
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ))
            and vrv.created_at >= date_sub('2023-08-30', interval 7 hour)
            and vrv.created_at < date_add('2023-08-30', interval 17 hour) -- 17-17
        group by 1,2
    ) total on total.type = t.type and total.client_name = t.client_name
left join
    (
        select
            a1.type
            ,a1.client_name
            ,count(if(a1.result = '退件', a1.id, null)) rts_count
            ,count(if(a1.result = '继续派送', a1.id, null)) delivery_again_count
            ,count(if(a1.result = '异常关闭', a1.id, null)) close_count
        from
            (
                select
                    a.type
                    ,a.client_name
                    ,case
                        when a.type = 3 and a.visit_state in (3,7) or a.rejection_delivery_again = 1 then '退件' -- 多次联系不上、超时效和回访结果是退件
                        when a.type = 3 and a.rejection_delivery_again = 2 then '继续派送' -- 继续派送
                        when a.type = 8 and a.visit_state in (3,7) or a.visit_result = 44 then '退件' --  多次联系不上和回访结果是退件
                        when a.type = 8 and  a.visit_result = 43 then '继续派送'
                        else '异常关闭'
                    end result
                    ,a.id
                from
                    (
                        select
                            vrv.type
                            ,bc.client_name
                            ,vrv.visit_state
                            ,vrv.visit_result
                            ,vrv.id
                            ,json_extract(vrv.extra_value, '$.rejection_delivery_again') rejection_delivery_again
                        from nl_production.violation_return_visit vrv
                        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
                        where
                            vrv.type in (3,8)
                            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
                            and
                                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ))
                            and vrv.created_at >= date_sub('2023-08-30', interval 7 hour)
                            and vrv.created_at < date_add('2023-08-30', interval 17 hour)
                    ) a
            ) a1
        group by 1,2
    ) result on result.type = t.type and result.client_name = t.client_name
left join
    (
        select
            vrv.type
            ,bc.client_name
            ,count(if(vrv.visit_num = 0 ,vrv.id, null)) 未开始拨打数量
            ,count(if(vrv.visit_num = 1, vrv.id, null)) 拨打一次数量
            ,count(if(vrv.visit_num = 2, vrv.id, null)) 拨打两次数量
            ,count(if(vrv.visit_state in (3,4,5,6,7), vrv.id, null)) 拨打完成数量
        from nl_production.violation_return_visit vrv
        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        where
            vrv.type in (3,8)
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ))
            and vrv.created_at >= date_add('2023-08-30', interval 17 hour)
            and vrv.created_at < date_add('2023-08-30', interval 20 hour) -- 当日17-20
        group by 1,2
    ) tod on tod.type = t.type and tod.client_name = t.client_name;
;-- -. . -..- - / . -. - .-. -.--
select
    t.type
    ,t.client_name
    ,his.回访任务量 历史积压量
    ,his.历史积压处理完成量
    ,his.历史积压未完成量
    ,upp.ticket_count '昨日17-今日9点创建量'
    ,upp.done_ticket_count '昨日17-今日9点处理完成量'
    ,upp.deal_rate '昨日17-今日9点完成率'
    ,low.ticket_count '今日9点-今日17点生成量'
    ,low.done_ticket_count '今日9点-今日17点处理完成量'
    ,low.deal_rate '今日9点-今日17点处理完成率'
    ,tod.未开始拨打数量
    ,tod.拨打一次数量
    ,tod.拨打两次数量
    ,tod.拨打完成数量
    ,total.ticket_count  当日总任务量 -- 17-17
    ,total.day_deal_rate 当日处理完成率  -- 17-17
    ,total.undeal_diff_count 处理完包裹中关联的疑难件未解锁的量 -- 17-17
    ,result.delivery_again_count 继续派送量
    ,result.rts_count 退件量
    ,result.close_count 异常关闭量
from tmpale.tmp_ph_client_visit_info t
left join
    (
        select
#             case vrv.type
#                 when 1 then '揽件任务异常取消'
#                 when 2 then '虚假妥投'
#                 when 3 then '收件人拒收'
#                 when 4 then '标记客户改约时间'
#                 when 5 then 'KA现场不揽收'
#                 when 6 then '包裹未准备好'
#                 when 7 then '上报错分未妥投'
#                 when 8 then '多次尝试派送失败'
#             end vrv_type
            vrv.type
            ,bc.client_name
            ,count(vrv.id) 回访任务量
            ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at >= date_sub('2023-08-30', interval 7 hour), vrv.id, null)) 历史积压处理完成量 -- 查训当日处理完成量
            ,count(if(vrv.visit_state in (1,2), vrv.id, null )) 历史积压未完成量
        from nl_production.violation_return_visit vrv
        join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        where
            vrv.type in (3,8)
            and vrv.created_at <= date_sub('2023-08-30', interval 7 hour) -- 昨天17点之前
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                (
                    (vrv.visit_state in (3,4,5,6,7) and vrv.updated_at > date_sub('2023-08-30', interval 7 hour)) -- 查询日期17点之后处理
                    or vrv.visit_state in (1,2) -- 至今也是未处理
                )
            and
                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ) ) -- IVR应处理
        group by 1,2
    ) his on his.client_name = t.client_name and his.type = t.type
left join
    (
        select
            vrv.type
            ,bc.client_name
            ,count(vrv.id) ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) , vrv.id, null)) done_ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) , vrv.id, null))/count(vrv.id) deal_rate
        from nl_production.violation_return_visit vrv
        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        where
            vrv.type in (3,8)
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ) )
            and vrv.created_at >= date_sub('2023-08-30', interval 7 hour)
            and vrv.created_at < date_add('2023-08-30', interval 9 hour) -- 昨日17至今日9点
        group by 1,2
    ) upp on upp.type = t.type and upp.client_name = t.client_name
left join
    (
        select
            vrv.type
            ,bc.client_name
            ,count(vrv.id) ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) , vrv.id, null)) done_ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) , vrv.id, null))/count(vrv.id) deal_rate
        from nl_production.violation_return_visit vrv
        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        where
            vrv.type in (3,8)
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ) )
            and vrv.created_at >= date_add('2023-08-30', interval 9 hour)
            and vrv.created_at < date_add('2023-08-30', interval 17 hour) -- 昨日17至今日9点
        group by 1,2
    ) low on low.type = t.type and low.client_name = t.client_name
left join
    (
        select
            vrv.type
            ,bc.client_name
            ,count(vrv.id) ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < date_add('2023-08-30', interval 1 day), vrv.id, null))/count(vrv.id) day_deal_rate
            ,count(if(cdt.state != 1, vrv.id, null)) undeal_diff_count
        from nl_production.violation_return_visit vrv
        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = json_extract(vrv.extra_value, '$.diff_id')
        where
            vrv.type in (3,8)
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ))
            and vrv.created_at >= date_sub('2023-08-30', interval 7 hour)
            and vrv.created_at < date_add('2023-08-30', interval 17 hour) -- 17-17
        group by 1,2
    ) total on total.type = t.type and total.client_name = t.client_name
left join
    (
        select
            a1.type
            ,a1.client_name
            ,count(if(a1.result = '退件', a1.id, null)) rts_count
            ,count(if(a1.result = '继续派送', a1.id, null)) delivery_again_count
            ,count(if(a1.result = '异常关闭', a1.id, null)) close_count
        from
            (
                select
                    a.type
                    ,a.client_name
                    ,case
                        when a.type = 3 and a.visit_state in (3,7) or a.rejection_delivery_again = 1 then '退件' -- 多次联系不上、超时效和回访结果是退件
                        when a.type = 3 and a.rejection_delivery_again = 2 then '继续派送' -- 继续派送
                        when a.type = 8 and a.visit_state in (3,7) or a.visit_result = 44 then '退件' --  多次联系不上和回访结果是退件
                        when a.type = 8 and  a.visit_result = 43 then '继续派送'
                        else '异常关闭'
                    end result
                    ,a.id
                from
                    (
                        select
                            vrv.type
                            ,bc.client_name
                            ,vrv.visit_state
                            ,vrv.visit_result
                            ,vrv.id
                            ,json_extract(vrv.extra_value, '$.rejection_delivery_again') rejection_delivery_again
                        from nl_production.violation_return_visit vrv
                        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
                        where
                            vrv.type in (3,8)
                            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
                            and
                                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ))
                            and vrv.created_at >= date_sub('2023-08-30', interval 7 hour)
                            and vrv.created_at < date_add('2023-08-30', interval 17 hour)
                    ) a
            ) a1
        group by 1,2
    ) result on result.type = t.type and result.client_name = t.client_name
left join
    (
        select
            vrv.type
            ,bc.client_name
            ,count(if(vrv.visit_num = 0 ,vrv.id, null)) 未开始拨打数量
            ,count(if(vrv.visit_num = 1, vrv.id, null)) 拨打一次数量
            ,count(if(vrv.visit_num = 2, vrv.id, null)) 拨打两次数量
            ,count(if(vrv.visit_state in (3,4,5,6,7), vrv.id, null)) 拨打完成数量
        from nl_production.violation_return_visit vrv
        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        where
            vrv.type in (3,8)
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ))
            and vrv.created_at >= date_add('2023-08-30', interval 17 hour)
            and vrv.created_at < date_add('2023-08-30', interval 20 hour) -- 当日17-20
        group by 1,2
    ) tod on tod.type = t.type and tod.client_name = t.client_name;
;-- -. . -..- - / . -. - .-. -.--
select
    vrv.type
    ,case vrv.visit_state
            when 0 then '终态或变更派件标记等无须回访'
            when 1 then '待回访'
            when 2 then '沟通中'
            when 3 then '多次未联系上客户'
            when 4 then '已回访'
            when 5 then '因同包裹生成其他回访任务关闭'
            when 6 then 'VR回访结果=99关闭'
            when 7 then '超回访时效关闭'
        end 回访状态
    ,case vrv.visit_result
        when 1 then '联系不上'
        when 2 then '取消原因属实、合理'
        when 3 then '快递员虚假标记/违背客户意愿要求取消'
        when 4 then '多次联系不上客户'
        when 5 then '收件人已签收包裹'
        when 6 then '收件人未收到包裹'
        when 7 then '未经收件人允许投放他处/让他人代收'
        when 8 then '快递员没有联系客户，直接标记收件人拒收'
        when 9 then '收件人拒收情况属实'
        when 10 then '快递员服务态度差'
        when 11 then '因快递员未按照收件人地址送货，客户不方便去取货'
        when 12 then '网点派送速度慢，客户不想等'
        when 13 then '非快递员问题，个人原因拒收'
        when 14 then '其它'
        when 15 then '未经客户同意改约派件时间'
        when 16 then '未按约定时间派送'
        when 17 then '派件前未提前联系客户'
        when 18 then '收件人拒收情况不属实'
        when 19 then '快递员联系客户，但未经客户同意标记收件人拒收'
        when 20 then '快递员要求/威胁客户拒收'
        when 21 then '快递员引导客户拒收'
        when 22 then '其他'
        when 23 then '情况不属实，快递员虚假标记'
        when 24 then '情况不属实，快递员诱导客户改约时间'
        when 25 then '情况属实，客户原因改约时间'
        when 26 then '客户退货，不想购买该商品'
        when 27 then '客户未购买商品'
        when 28 then '客户本人/家人对包裹不知情而拒收'
        when 29 then '商家发错商品'
        when 30 then '包裹物流派送慢超时效'
        when 31 then '快递员服务态度差'
        when 32 then '因快递员未按照收件人地址送货，客户不方便去取货'
        when 33 then '货物验收破损'
        when 34 then '无人在家不便签收'
        when 35 then '客户错误拒收包裹'
        when 36 then '快递员按照要求当场扫描揽收'
        when 37 then '快递员未按照要求当场扫描揽收'
        when 38 then '无所谓，客户无要求'
        when 39 then '包裹未准备好 - 情况不属实，快递员虚假标记'
        when 40 then '包裹未准备好 - 情况属实，客户存在未准备好的包裹'
        when 41 then '虚假修改包裹信息'
        when 42 then '修改包裹信息属实'
        when 43 then '客户需要包裹，继续派送'
        when 44 then '客户不需要包裹，操作退件'
    end as 回访结果
    ,json_extract(vrv.extra_value, '$.rejection_delivery_again') delivery_again
    ,count(vrv.id)
from nl_production.violation_return_visit vrv
join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id and bc.client_name = 'tiktok'
where
    vrv.created_at >= '2023-08-01'
    and vrv.type in (3)
    and visit_state in (4)
    and vrv.created_at >= date_sub(curdate(), interval 7 day)
group by 1,2,3;
;-- -. . -..- - / . -. - .-. -.--
select
    case t.type
        when 1 then '揽件任务异常取消'
        when 2 then '虚假妥投'
        when 3 then '收件人拒收'
        when 4 then '标记客户改约时间'
        when 5 then 'KA现场不揽收'
        when 6 then '包裹未准备好'
        when 7 then '上报错分未妥投'
        when 8 then '多次尝试派送失败'
    end 回访类型
    ,t.client_name 客户名称
    ,his.回访任务量 历史积压量
    ,his.历史积压处理完成量
    ,his.历史积压未完成量
    ,upp.ticket_count '昨日17-今日9点创建量'
    ,upp.done_ticket_count '昨日17-今日9点处理完成量'
    ,upp.deal_rate '昨日17-今日9点完成率'
    ,low.ticket_count '今日9点-今日17点生成量'
    ,low.done_ticket_count '今日9点-今日17点处理完成量'
    ,low.deal_rate '今日9点-今日17点处理完成率'
    ,tod.未开始拨打数量
    ,tod.拨打一次数量
    ,tod.拨打两次数量
    ,tod.拨打完成数量
    ,total.ticket_count  当日总任务量 -- 17-17
    ,total.day_deal_rate 当日处理完成率  -- 17-17
    ,total.undeal_diff_count 处理完包裹中关联的疑难件未解锁的量 -- 17-17
    ,result.delivery_again_count 继续派送量
    ,result.rts_count 退件量
    ,result.close_count 异常关闭量
from tmpale.tmp_ph_client_visit_info t
left join
    (
        select
#             case vrv.type
#                 when 1 then '揽件任务异常取消'
#                 when 2 then '虚假妥投'
#                 when 3 then '收件人拒收'
#                 when 4 then '标记客户改约时间'
#                 when 5 then 'KA现场不揽收'
#                 when 6 then '包裹未准备好'
#                 when 7 then '上报错分未妥投'
#                 when 8 then '多次尝试派送失败'
#             end vrv_type
            vrv.type
            ,bc.client_name
            ,count(vrv.id) 回访任务量
            ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at >= date_sub('2023-08-29', interval 7 hour), vrv.id, null)) 历史积压处理完成量 -- 查训当日处理完成量
            ,count(if(vrv.visit_state in (1,2), vrv.id, null )) 历史积压未完成量
        from nl_production.violation_return_visit vrv
        join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        where
            vrv.type in (3,8)
            and vrv.created_at <= date_sub('2023-08-29', interval 7 hour) -- 昨天17点之前
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                (
                    (vrv.visit_state in (3,4,5,6,7) and vrv.updated_at > date_sub('2023-08-29', interval 7 hour)) -- 查询日期17点之后处理
                    or vrv.visit_state in (1,2) -- 至今也是未处理
                )
            and
                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ) ) -- IVR应处理
        group by 1,2
    ) his on his.client_name = t.client_name and his.type = t.type
left join
    (
        select
            vrv.type
            ,bc.client_name
            ,count(vrv.id) ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) , vrv.id, null)) done_ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) , vrv.id, null))/count(vrv.id) deal_rate
        from nl_production.violation_return_visit vrv
        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        where
            vrv.type in (3,8)
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ) )
            and vrv.created_at >= date_sub('2023-08-29', interval 7 hour)
            and vrv.created_at < date_add('2023-08-29', interval 9 hour) -- 昨日17至今日9点
        group by 1,2
    ) upp on upp.type = t.type and upp.client_name = t.client_name
left join
    (
        select
            vrv.type
            ,bc.client_name
            ,count(vrv.id) ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) , vrv.id, null)) done_ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) , vrv.id, null))/count(vrv.id) deal_rate
        from nl_production.violation_return_visit vrv
        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        where
            vrv.type in (3,8)
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ) )
            and vrv.created_at >= date_add('2023-08-29', interval 9 hour)
            and vrv.created_at < date_add('2023-08-29', interval 17 hour) -- 昨日17至今日9点
        group by 1,2
    ) low on low.type = t.type and low.client_name = t.client_name
left join
    (
        select
            vrv.type
            ,bc.client_name
            ,count(vrv.id) ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < date_add('2023-08-29', interval 1 day), vrv.id, null))/count(vrv.id) day_deal_rate
            ,count(if(cdt.state != 1, vrv.id, null)) undeal_diff_count
        from nl_production.violation_return_visit vrv
        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = json_extract(vrv.extra_value, '$.diff_id')
        where
            vrv.type in (3,8)
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ))
            and vrv.created_at >= date_sub('2023-08-29', interval 7 hour)
            and vrv.created_at < date_add('2023-08-29', interval 17 hour) -- 17-17
        group by 1,2
    ) total on total.type = t.type and total.client_name = t.client_name
left join
    (
        select
            a1.type
            ,a1.client_name
            ,count(if(a1.result = '退件', a1.id, null)) rts_count
            ,count(if(a1.result = '继续派送', a1.id, null)) delivery_again_count
            ,count(if(a1.result = '异常关闭', a1.id, null)) close_count
        from
            (
                select
                    a.type
                    ,a.client_name
                    ,case
                        when a.type = 3 and a.visit_state in (3,7) or a.rejection_delivery_again = 1 then '退件' -- 多次联系不上、超时效和回访结果是退件
                        when a.type = 3 and a.rejection_delivery_again = 2 then '继续派送' -- 继续派送
                        when a.type = 8 and a.visit_state in (3,7) or a.visit_result = 44 then '退件' --  多次联系不上和回访结果是退件
                        when a.type = 8 and  a.visit_result = 43 then '继续派送'
                        else '异常关闭'
                    end result
                    ,a.id
                from
                    (
                        select
                            vrv.type
                            ,bc.client_name
                            ,vrv.visit_state
                            ,vrv.visit_result
                            ,vrv.id
                            ,json_extract(vrv.extra_value, '$.rejection_delivery_again') rejection_delivery_again
                        from nl_production.violation_return_visit vrv
                        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
                        where
                            vrv.type in (3,8)
                            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
                            and
                                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ))
                            and vrv.created_at >= date_sub('2023-08-29', interval 7 hour)
                            and vrv.created_at < date_add('2023-08-29', interval 17 hour)
                    ) a
            ) a1
        group by 1,2
    ) result on result.type = t.type and result.client_name = t.client_name
left join
    (
        select
            vrv.type
            ,bc.client_name
            ,count(if(vrv.visit_num = 0 ,vrv.id, null)) 未开始拨打数量
            ,count(if(vrv.visit_num = 1, vrv.id, null)) 拨打一次数量
            ,count(if(vrv.visit_num = 2, vrv.id, null)) 拨打两次数量
            ,count(if(vrv.visit_state in (3,4,5,6,7), vrv.id, null)) 拨打完成数量
        from nl_production.violation_return_visit vrv
        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        where
            vrv.type in (3,8)
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ))
            and vrv.created_at >= date_add('2023-08-29', interval 17 hour)
            and vrv.created_at < date_add('2023-08-29', interval 20 hour) -- 当日17-20
        group by 1,2
    ) tod on tod.type = t.type and tod.client_name = t.client_name;
;-- -. . -..- - / . -. - .-. -.--
select
    case t.type
        when 1 then '揽件任务异常取消'
        when 2 then '虚假妥投'
        when 3 then '收件人拒收'
        when 4 then '标记客户改约时间'
        when 5 then 'KA现场不揽收'
        when 6 then '包裹未准备好'
        when 7 then '上报错分未妥投'
        when 8 then '多次尝试派送失败'
    end 回访类型
    ,t.client_name 客户名称
    ,his.回访任务量 历史积压量
    ,his.历史积压处理完成量
    ,his.历史积压未完成量
    ,upp.ticket_count '昨日17-今日9点创建量'
    ,upp.done_ticket_count '昨日17-今日9点处理完成量'
    ,upp.deal_rate '昨日17-今日9点完成率'
    ,low.ticket_count '今日9点-今日17点生成量'
    ,low.done_ticket_count '今日9点-今日17点处理完成量'
    ,low.deal_rate '今日9点-今日17点处理完成率'
    ,tod.未开始拨打数量
    ,tod.拨打一次数量
    ,tod.拨打两次数量
    ,tod.拨打完成数量
    ,total.ticket_count  当日总任务量 -- 17-17
    ,total.day_deal_rate 当日处理完成率  -- 17-17
    ,total.undeal_diff_count 处理完包裹中关联的疑难件未解锁的量 -- 17-17
    ,result.delivery_again_count 继续派送量
    ,result.rts_count 退件量
    ,result.close_count 异常关闭量
from tmpale.tmp_ph_client_visit_info t
left join
    (
        select
#             case vrv.type
#                 when 1 then '揽件任务异常取消'
#                 when 2 then '虚假妥投'
#                 when 3 then '收件人拒收'
#                 when 4 then '标记客户改约时间'
#                 when 5 then 'KA现场不揽收'
#                 when 6 then '包裹未准备好'
#                 when 7 then '上报错分未妥投'
#                 when 8 then '多次尝试派送失败'
#             end vrv_type
            vrv.type
            ,bc.client_name
            ,count(vrv.id) 回访任务量
            ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at >= date_sub('2023-08-30', interval 7 hour), vrv.id, null)) 历史积压处理完成量 -- 查训当日处理完成量
            ,count(if(vrv.visit_state in (1,2), vrv.id, null )) 历史积压未完成量
        from nl_production.violation_return_visit vrv
        join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        where
            vrv.type in (3,8)
            and vrv.created_at <= date_sub('2023-08-30', interval 7 hour) -- 昨天17点之前
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                (
                    (vrv.visit_state in (3,4,5,6,7) and vrv.updated_at > date_sub('2023-08-30', interval 7 hour)) -- 查询日期17点之后处理
                    or vrv.visit_state in (1,2) -- 至今也是未处理
                )
            and
                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ) ) -- IVR应处理
        group by 1,2
    ) his on his.client_name = t.client_name and his.type = t.type
left join
    (
        select
            vrv.type
            ,bc.client_name
            ,count(vrv.id) ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) , vrv.id, null)) done_ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) , vrv.id, null))/count(vrv.id) deal_rate
        from nl_production.violation_return_visit vrv
        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        where
            vrv.type in (3,8)
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ) )
            and vrv.created_at >= date_sub('2023-08-30', interval 7 hour)
            and vrv.created_at < date_add('2023-08-30', interval 9 hour) -- 昨日17至今日9点
        group by 1,2
    ) upp on upp.type = t.type and upp.client_name = t.client_name
left join
    (
        select
            vrv.type
            ,bc.client_name
            ,count(vrv.id) ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) , vrv.id, null)) done_ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) , vrv.id, null))/count(vrv.id) deal_rate
        from nl_production.violation_return_visit vrv
        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        where
            vrv.type in (3,8)
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ) )
            and vrv.created_at >= date_add('2023-08-30', interval 9 hour)
            and vrv.created_at < date_add('2023-08-30', interval 17 hour) -- 昨日17至今日9点
        group by 1,2
    ) low on low.type = t.type and low.client_name = t.client_name
left join
    (
        select
            vrv.type
            ,bc.client_name
            ,count(vrv.id) ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < date_add('2023-08-30', interval 1 day), vrv.id, null))/count(vrv.id) day_deal_rate
            ,count(if(cdt.state != 1, vrv.id, null)) undeal_diff_count
        from nl_production.violation_return_visit vrv
        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = json_extract(vrv.extra_value, '$.diff_id')
        where
            vrv.type in (3,8)
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ))
            and vrv.created_at >= date_sub('2023-08-30', interval 7 hour)
            and vrv.created_at < date_add('2023-08-30', interval 17 hour) -- 17-17
        group by 1,2
    ) total on total.type = t.type and total.client_name = t.client_name
left join
    (
        select
            a1.type
            ,a1.client_name
            ,count(if(a1.result = '退件', a1.id, null)) rts_count
            ,count(if(a1.result = '继续派送', a1.id, null)) delivery_again_count
            ,count(if(a1.result = '异常关闭', a1.id, null)) close_count
        from
            (
                select
                    a.type
                    ,a.client_name
                    ,case
                        when a.type = 3 and a.visit_state in (3,7) or a.rejection_delivery_again = 1 then '退件' -- 多次联系不上、超时效和回访结果是退件
                        when a.type = 3 and a.rejection_delivery_again = 2 then '继续派送' -- 继续派送
                        when a.type = 8 and a.visit_state in (3,7) or a.visit_result = 44 then '退件' --  多次联系不上和回访结果是退件
                        when a.type = 8 and  a.visit_result = 43 then '继续派送'
                        else '异常关闭'
                    end result
                    ,a.id
                from
                    (
                        select
                            vrv.type
                            ,bc.client_name
                            ,vrv.visit_state
                            ,vrv.visit_result
                            ,vrv.id
                            ,json_extract(vrv.extra_value, '$.rejection_delivery_again') rejection_delivery_again
                        from nl_production.violation_return_visit vrv
                        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
                        where
                            vrv.type in (3,8)
                            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
                            and
                                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ))
                            and vrv.created_at >= date_sub('2023-08-30', interval 7 hour)
                            and vrv.created_at < date_add('2023-08-30', interval 17 hour)
                    ) a
            ) a1
        group by 1,2
    ) result on result.type = t.type and result.client_name = t.client_name
left join
    (
        select
            vrv.type
            ,bc.client_name
            ,count(if(vrv.visit_num = 0 ,vrv.id, null)) 未开始拨打数量
            ,count(if(vrv.visit_num = 1, vrv.id, null)) 拨打一次数量
            ,count(if(vrv.visit_num = 2, vrv.id, null)) 拨打两次数量
            ,count(if(vrv.visit_state in (3,4,5,6,7), vrv.id, null)) 拨打完成数量
        from nl_production.violation_return_visit vrv
        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        where
            vrv.type in (3,8)
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ))
            and vrv.created_at >= date_add('2023-08-30', interval 17 hour)
            and vrv.created_at < date_add('2023-08-30', interval 20 hour) -- 当日17-20
        group by 1,2
    ) tod on tod.type = t.type and tod.client_name = t.client_name;
;-- -. . -..- - / . -. - .-. -.--
select
    vrv.type
    ,bc.client_name
    ,cdt.diff_info_id
    ,di.pno
#     ,count(vrv.id) ticket_count
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < date_add('${date}', interval 1 day), vrv.id, null))/count(vrv.id) day_deal_rate
#     ,count(if(cdt.state != 1 and vrv.visit_state in (3,4,5,6,7) and cdt.id is not null, vrv.id, null)) undeal_diff_count
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = json_extract(vrv.extra_value, '$.diff_id')
left join ph_staging.diff_info di on di.id = cdt.diff_info_id
where
    vrv.type in (3,8)
    and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
    and
        ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ))
    and vrv.created_at >= date_sub('2023-08-30', interval 7 hour)
    and vrv.created_at < date_add('2023-08-30', interval 17 hour) -- 17-17
    and cdt.state != 1
    and vrv.visit_state in (3,4,5,6,7)
    and cdt.id is not null;
;-- -. . -..- - / . -. - .-. -.--
select
    case t.type
        when 1 then '揽件任务异常取消'
        when 2 then '虚假妥投'
        when 3 then '收件人拒收'
        when 4 then '标记客户改约时间'
        when 5 then 'KA现场不揽收'
        when 6 then '包裹未准备好'
        when 7 then '上报错分未妥投'
        when 8 then '多次尝试派送失败'
    end 回访类型
    ,t.client_name 客户名称
    ,his.回访任务量 历史积压量
    ,his.历史积压处理完成量
    ,his.历史积压未完成量
    ,upp.ticket_count '昨日17-今日9点创建量'
    ,upp.done_ticket_count '昨日17-今日9点处理完成量'
    ,upp.deal_rate '昨日17-今日9点完成率'
    ,low.ticket_count '今日9点-今日17点生成量'
    ,low.done_ticket_count '今日9点-今日17点处理完成量'
    ,low.deal_rate '今日9点-今日17点处理完成率'
    ,tod.未开始拨打数量
    ,tod.拨打一次数量
    ,tod.拨打两次数量
    ,tod.拨打完成数量
    ,total.ticket_count  当日总任务量 -- 17-17
    ,total.day_deal_rate 当日处理完成率  -- 17-17
    ,total.undeal_diff_count 处理完包裹中关联的疑难件未解锁的量 -- 17-17
    ,result.delivery_again_count 继续派送量
    ,result.rts_count 退件量
    ,result.close_count 异常关闭量
from tmpale.tmp_ph_client_visit_info t
left join
    (
        select
#             case vrv.type
#                 when 1 then '揽件任务异常取消'
#                 when 2 then '虚假妥投'
#                 when 3 then '收件人拒收'
#                 when 4 then '标记客户改约时间'
#                 when 5 then 'KA现场不揽收'
#                 when 6 then '包裹未准备好'
#                 when 7 then '上报错分未妥投'
#                 when 8 then '多次尝试派送失败'
#             end vrv_type
            vrv.type
            ,bc.client_name
            ,count(vrv.id) 回访任务量
            ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at >= date_sub('2023-08-30', interval 7 hour), vrv.id, null)) 历史积压处理完成量 -- 查训当日处理完成量
            ,count(if(vrv.visit_state in (1,2), vrv.id, null )) 历史积压未完成量
        from nl_production.violation_return_visit vrv
        join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        where
            vrv.type in (3,8)
            and vrv.created_at <= date_sub('2023-08-30', interval 7 hour) -- 昨天17点之前
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                (
                    (vrv.visit_state in (3,4,5,6,7) and vrv.updated_at > date_sub('2023-08-30', interval 7 hour)) -- 查询日期17点之后处理
                    or vrv.visit_state in (1,2) -- 至今也是未处理
                )
            and
                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ) ) -- IVR应处理
        group by 1,2
    ) his on his.client_name = t.client_name and his.type = t.type
left join
    (
        select
            vrv.type
            ,bc.client_name
            ,count(vrv.id) ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) , vrv.id, null)) done_ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) , vrv.id, null))/count(vrv.id) deal_rate
        from nl_production.violation_return_visit vrv
        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        where
            vrv.type in (3,8)
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ) )
            and vrv.created_at >= date_sub('2023-08-30', interval 7 hour)
            and vrv.created_at < date_add('2023-08-30', interval 9 hour) -- 昨日17至今日9点
        group by 1,2
    ) upp on upp.type = t.type and upp.client_name = t.client_name
left join
    (
        select
            vrv.type
            ,bc.client_name
            ,count(vrv.id) ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) , vrv.id, null)) done_ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) , vrv.id, null))/count(vrv.id) deal_rate
        from nl_production.violation_return_visit vrv
        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        where
            vrv.type in (3,8)
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ) )
            and vrv.created_at >= date_add('2023-08-30', interval 9 hour)
            and vrv.created_at < date_add('2023-08-30', interval 17 hour) -- 昨日17至今日9点
        group by 1,2
    ) low on low.type = t.type and low.client_name = t.client_name
left join
    (
        select
            vrv.type
            ,bc.client_name
            ,count(vrv.id) ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < date_add('2023-08-30', interval 1 day), vrv.id, null))/count(vrv.id) day_deal_rate
            ,count(if(cdt.state != 1 and vrv.visit_state in (3,4,7) and cdt.id is not null, vrv.id, null)) undeal_diff_count
        from nl_production.violation_return_visit vrv
        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = json_extract(vrv.extra_value, '$.diff_id')
        where
            vrv.type in (3,8)
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ))
            and vrv.created_at >= date_sub('2023-08-30', interval 7 hour)
            and vrv.created_at < date_add('2023-08-30', interval 17 hour) -- 17-17
        group by 1,2
    ) total on total.type = t.type and total.client_name = t.client_name
left join
    (
        select
            a1.type
            ,a1.client_name
            ,count(if(a1.result = '退件', a1.id, null)) rts_count
            ,count(if(a1.result = '继续派送', a1.id, null)) delivery_again_count
            ,count(if(a1.result = '异常关闭', a1.id, null)) close_count
        from
            (
                select
                    a.type
                    ,a.client_name
                    ,case
                        when a.type = 3 and a.visit_state in (3,7) or a.rejection_delivery_again = 1 then '退件' -- 多次联系不上、超时效和回访结果是退件
                        when a.type = 3 and a.rejection_delivery_again = 2 then '继续派送' -- 继续派送
                        when a.type = 8 and a.visit_state in (3,7) or a.visit_result = 44 then '退件' --  多次联系不上和回访结果是退件
                        when a.type = 8 and  a.visit_result = 43 then '继续派送'
                        else '异常关闭'
                    end result
                    ,a.id
                from
                    (
                        select
                            vrv.type
                            ,bc.client_name
                            ,vrv.visit_state
                            ,vrv.visit_result
                            ,vrv.id
                            ,json_extract(vrv.extra_value, '$.rejection_delivery_again') rejection_delivery_again
                        from nl_production.violation_return_visit vrv
                        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
                        where
                            vrv.type in (3,8)
                            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
                            and
                                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ))
                            and vrv.created_at >= date_sub('2023-08-30', interval 7 hour)
                            and vrv.created_at < date_add('2023-08-30', interval 17 hour)
                    ) a
            ) a1
        group by 1,2
    ) result on result.type = t.type and result.client_name = t.client_name
left join
    (
        select
            vrv.type
            ,bc.client_name
            ,count(if(vrv.visit_num = 0 ,vrv.id, null)) 未开始拨打数量
            ,count(if(vrv.visit_num = 1, vrv.id, null)) 拨打一次数量
            ,count(if(vrv.visit_num = 2, vrv.id, null)) 拨打两次数量
            ,count(if(vrv.visit_state in (3,4,5,6,7), vrv.id, null)) 拨打完成数量
        from nl_production.violation_return_visit vrv
        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        where
            vrv.type in (3,8)
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ))
            and vrv.created_at >= date_add('2023-08-30', interval 17 hour)
            and vrv.created_at < date_add('2023-08-30', interval 20 hour) -- 当日17-20
        group by 1,2
    ) tod on tod.type = t.type and tod.client_name = t.client_name;
;-- -. . -..- - / . -. - .-. -.--
select
    case t.type
        when 1 then '揽件任务异常取消'
        when 2 then '虚假妥投'
        when 3 then '收件人拒收'
        when 4 then '标记客户改约时间'
        when 5 then 'KA现场不揽收'
        when 6 then '包裹未准备好'
        when 7 then '上报错分未妥投'
        when 8 then '多次尝试派送失败'
    end 回访类型
    ,t.client_name 客户名称
    ,his.回访任务量 历史积压量
    ,his.历史积压处理完成量
    ,his.历史积压未完成量
    ,upp.ticket_count '昨日17-今日9点创建量'
    ,upp.done_ticket_count '昨日17-今日9点处理完成量'
    ,upp.deal_rate '昨日17-今日9点完成率'
    ,low.ticket_count '今日9点-今日17点生成量'
    ,low.done_ticket_count '今日9点-今日17点处理完成量'
    ,low.deal_rate '今日9点-今日17点处理完成率'
    ,tod.未开始拨打数量
    ,tod.拨打一次数量
    ,tod.拨打两次数量
    ,tod.拨打完成数量
    ,total.ticket_count  当日总任务量 -- 17-17
    ,total.day_deal_rate 当日处理完成率  -- 17-17
    ,total.undeal_diff_count 处理完包裹中关联的疑难件未解锁的量 -- 17-17
    ,result.delivery_again_count 继续派送量
    ,result.rts_count 退件量
    ,result.close_count 异常关闭量
from tmpale.tmp_ph_client_visit_info t
left join
    (
        select
#             case vrv.type
#                 when 1 then '揽件任务异常取消'
#                 when 2 then '虚假妥投'
#                 when 3 then '收件人拒收'
#                 when 4 then '标记客户改约时间'
#                 when 5 then 'KA现场不揽收'
#                 when 6 then '包裹未准备好'
#                 when 7 then '上报错分未妥投'
#                 when 8 then '多次尝试派送失败'
#             end vrv_type
            vrv.type
            ,bc.client_name
            ,count(vrv.id) 回访任务量
            ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at >= date_sub('2023-08-30', interval 7 hour), vrv.id, null)) 历史积压处理完成量 -- 查训当日处理完成量
            ,count(if(vrv.visit_state in (1,2), vrv.id, null )) 历史积压未完成量
        from nl_production.violation_return_visit vrv
        join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        where
            vrv.type in (3,8)
            and vrv.created_at <= date_sub('2023-08-30', interval 7 hour) -- 昨天17点之前
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                (
                    (vrv.visit_state in (3,4,5,6,7) and vrv.updated_at > date_sub('2023-08-30', interval 7 hour)) -- 查询日期17点之后处理
                    or vrv.visit_state in (1,2) -- 至今也是未处理
                )
            and
                ( vrv.visit_staff_id != 10001 and ( vrv.visit_staff_id != 0 or vrv.visit_state != 2 ) ) -- IVR应处理
        group by 1,2
    ) his on his.client_name = t.client_name and his.type = t.type
left join
    (
        select
            vrv.type
            ,bc.client_name
            ,count(vrv.id) ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) , vrv.id, null)) done_ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) , vrv.id, null))/count(vrv.id) deal_rate
        from nl_production.violation_return_visit vrv
        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        where
            vrv.type in (3,8)
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                (vrv.visit_staff_id != 10001 and ( vrv.visit_staff_id != 0 or vrv.visit_state != 2 ))
            and vrv.created_at >= date_sub('2023-08-30', interval 7 hour)
            and vrv.created_at < date_add('2023-08-30', interval 9 hour) -- 昨日17至今日9点
        group by 1,2
    ) upp on upp.type = t.type and upp.client_name = t.client_name
left join
    (
        select
            vrv.type
            ,bc.client_name
            ,count(vrv.id) ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) , vrv.id, null)) done_ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) , vrv.id, null))/count(vrv.id) deal_rate
        from nl_production.violation_return_visit vrv
        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        where
            vrv.type in (3,8)
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                ( vrv.visit_staff_id != 10001 and ( vrv.visit_staff_id != 0 or vrv.visit_state != 2 ) )
            and vrv.created_at >= date_add('2023-08-30', interval 9 hour)
            and vrv.created_at < date_add('2023-08-30', interval 17 hour) -- 昨日17至今日9点
        group by 1,2
    ) low on low.type = t.type and low.client_name = t.client_name
left join
    (
        select
            vrv.type
            ,bc.client_name
            ,count(vrv.id) ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < date_add('2023-08-30', interval 1 day), vrv.id, null))/count(vrv.id) day_deal_rate
            ,count(if(cdt.state != 1 and vrv.visit_state in (3,4,7) and cdt.id is not null, vrv.id, null)) undeal_diff_count
        from nl_production.violation_return_visit vrv
        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = json_extract(vrv.extra_value, '$.diff_id')
        where
            vrv.type in (3,8)
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                ( vrv.visit_staff_id != 10001 and ( vrv.visit_staff_id != 0 or vrv.visit_state != 2 ))
            and vrv.created_at >= date_sub('2023-08-30', interval 7 hour)
            and vrv.created_at < date_add('2023-08-30', interval 17 hour) -- 17-17
        group by 1,2
    ) total on total.type = t.type and total.client_name = t.client_name
left join
    (
        select
            a1.type
            ,a1.client_name
            ,count(if(a1.result = '退件', a1.id, null)) rts_count
            ,count(if(a1.result = '继续派送', a1.id, null)) delivery_again_count
            ,count(if(a1.result = '异常关闭', a1.id, null)) close_count
        from
            (
                select
                    a.type
                    ,a.client_name
                    ,case
                        when a.type = 3 and a.visit_state in (3,7) or a.rejection_delivery_again = 1 then '退件' -- 多次联系不上、超时效和回访结果是退件
                        when a.type = 3 and a.rejection_delivery_again = 2 then '继续派送' -- 继续派送
                        when a.type = 8 and a.visit_state in (3,7) or a.visit_result = 44 then '退件' --  多次联系不上和回访结果是退件
                        when a.type = 8 and  a.visit_result = 43 then '继续派送'
                        else '异常关闭'
                    end result
                    ,a.id
                from
                    (
                        select
                            vrv.type
                            ,bc.client_name
                            ,vrv.visit_state
                            ,vrv.visit_result
                            ,vrv.id
                            ,json_extract(vrv.extra_value, '$.rejection_delivery_again') rejection_delivery_again
                        from nl_production.violation_return_visit vrv
                        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
                        where
                            vrv.type in (3,8)
                            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
                            and
                                ( vrv.visit_staff_id != 10001 and ( vrv.visit_staff_id != 0 or vrv.visit_state != 2 ))
                            and vrv.created_at >= date_sub('2023-08-30', interval 7 hour)
                            and vrv.created_at < date_add('2023-08-30', interval 17 hour)
                    ) a
            ) a1
        group by 1,2
    ) result on result.type = t.type and result.client_name = t.client_name
left join
    (
        select
            vrv.type
            ,bc.client_name
            ,count(if(vrv.visit_num = 0 ,vrv.id, null)) 未开始拨打数量
            ,count(if(vrv.visit_num = 1, vrv.id, null)) 拨打一次数量
            ,count(if(vrv.visit_num = 2, vrv.id, null)) 拨打两次数量
            ,count(if(vrv.visit_state in (3,4,5,6,7), vrv.id, null)) 拨打完成数量
        from nl_production.violation_return_visit vrv
        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        where
            vrv.type in (3,8)
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                ( vrv.visit_staff_id != 10001 and ( vrv.visit_staff_id != 0 or vrv.visit_state != 2 ))
            and vrv.created_at >= date_add('2023-08-30', interval 17 hour)
            and vrv.created_at < date_add('2023-08-30', interval 20 hour) -- 当日17-20
        group by 1,2
    ) tod on tod.type = t.type and tod.client_name = t.client_name;
;-- -. . -..- - / . -. - .-. -.--
select
    vrv.type
    ,bc.client_name
    ,cdt.diff_info_id
    ,di.pno
#     ,count(vrv.id) ticket_count
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < date_add('${date}', interval 1 day), vrv.id, null))/count(vrv.id) day_deal_rate
#     ,count(if(cdt.state != 1 and vrv.visit_state in (3,4,5,6,7) and cdt.id is not null, vrv.id, null)) undeal_diff_count
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = json_extract(vrv.extra_value, '$.diff_id')
left join ph_staging.diff_info di on di.id = cdt.diff_info_id
where
    vrv.type in (3)
            and vrv.created_at <= date_sub('2023-08-30', interval 7 hour) -- 昨天17点之前
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                (
                    (vrv.visit_state in (3,4,5,6,7) and vrv.updated_at > date_sub('2023-08-30', interval 7 hour)) -- 查询日期17点之后处理
                    or vrv.visit_state in (1,2) -- 至今也是未处理
                )
            and
                ( vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ) ) -- IVR应处理
        and vrv.visit_state in (1,2);
;-- -. . -..- - / . -. - .-. -.--
SELECT
date(convert_tz(cdt.updated_at,'+00:00','+08:00')) 'DATE'
,pi.out_trade_no 'ORDER ID'
,pr.pno 'Tracking number'
,pi.client_id 'Seller User ID'
,bc.client_name 'Seller username'
,case pi.article_category
    when 0 then '文件/document'
    when 1 then '干燥食品/dry food'
    when 2 then '日用品/daily necessities'
    when 3 then '数码产品/digital product'
    when 4 then '衣物/clothes'
    when 5 then '书刊/Books'
    when 6 then '汽车配件/auto parts'
    when 7 then '鞋包/shoe bag'
    when 8 then '体育器材/sports equipment'
    when 9 then '化妆品/cosmetics'
    when 10 then '家居用具/Houseware'
    when 11 then '水果/fruit'
    when 99 then '其它/other'
end 'Goods name'
,cdt.remark 'Reason'
,if(cdt.negotiation_result_category=3,'YES','NO') 'PACKAGE STILL RETURNABLE, YES OR NO?'
,if(cdt.negotiation_result_category in (12),'Valid','Invalid') 'Valid/Invalid for Claims'
,group_concat(concat('https://fex-ph-asset-pro.oss-ap-southeast-1.aliyuncs.com/',sa.object_key) order by sa.id separator ',') Proof
,pr.store_name 'Concerned hub'
,null 'PROOF OF DISPOSA'
,convert_tz(cdt.updated_at,'+00:00','+08:00') 'DISPOSAL DATE'
,di.ct 'times'
,cdt.operator_id 'Operation ID'
,count(pr.pno)over(partition by date(convert_tz(cdt.updated_at,'+00:00','+08:00'))) 'Processing quantity'
from
(
	select pr.*
	from
	(
	select
		pr.pno
		,pr.store_name
		,json_extract(pr.extra_value,'$.diffInfoId') diffInfoId
		,json_extract(pr.extra_value,'$.routeExtraId') routeExtraId
		,row_number()over(partition by pr.pno order by pr.routed_at) rn
	from ph_staging.parcel_route pr
	where pr.route_action ='DIFFICULTY_HANDOVER'
	and pr.marker_category in (20,21)
	and pr.routed_at>=date_sub(curdate(),interval 10 day)

	)pr where pr.rn=1
)pr
left join ph_staging.parcel_info pi on pi.pno=pr.pno
left join dwm.dwd_dim_bigClient bc on bc.client_id =pi.client_id
left JOIN
(
	select
		di.pno
		,count() ct
	from ph_staging.diff_info di
	where di.created_at>=date_sub(curdate(),interval 10 day)
	group by 1
)di on pr.pno=di.pno
left join
    (
        select
            pre.pno
            ,pre.route_extra_id
            ,c
        from
        (
            select
                pre.pno
                ,pre.route_extra_id
                ,replace(replace(replace(json_extract(pre.extra_value, '$.images'), '"', ''),'[', ''),']', '') value
            from dwm.drds_ph_parcel_route_extra pre
            where pre.created_at>=date_sub(curdate(),interval 10 day)
        )pre
        lateral view explode(split(pre.value, ',')) id as c
    )pre on pr.routeExtraId=pre.route_extra_id
left join ph_staging.sys_attachment sa on sa.id=pre.c

left join ph_staging.customer_diff_ticket cdt on pr.diffInfoId=cdt.diff_info_id

where 1=1
-- pr.pno='PD10011QQYB1AJ'
and cdt.updated_at>=date_sub(date_sub(curdate(),interval 1 day),interval 8 hour)
and cdt.updated_at<date_sub(curdate(),interval 8 hour)
-- and cdt.negotiation_result_category in (3,8,12)
and cdt.organization_type=2 -- (KAM客服组)
and cdt.vip_enable=0
and cdt.service_type = 4
group by 1,2,3;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-08-30'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-08-30'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-08-30', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with d as
    (
        select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-08-30'
    )
    , t as
    (
        select
             ds.store_id
            ,ds.pno
            ,ds.stat_date
        from d ds
        left join
            (
                select
                    pr.pno
                    ,ds.stat_date
                    ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
                from ph_staging.parcel_route pr
                join d ds on pr.pno = ds.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                    and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and pr.marker_category in (42,43) ##岛屿,偏远地区
                group by 1,2
            ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
        left join
            (
                select
                   pr.pno
                    ,ds.stat_date
                   ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
                   ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
                from ph_staging.parcel_route pr
                join d ds on ds.pno = pr.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                    and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                    and pr.marker_category in (9,14,70) ##客户改约时间
            ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
        left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
        where
            case
                when pr1.pno is not null then 'N'
                when pr2.pno is not null then 'N'
                when ds1.pno is not null  then 'N'  else 'Y'
            end = 'Y'
    )
    select
        a.stat_date 日期
        ,a.store_id 网点ID
        ,dp.store_name 网点名称
        ,dp.opening_at 开业时间
        ,case
            when dp.region_name in ('Area3', 'Area6') then '彭万松'
            when dp.region_name in ('Area4', 'Area9') then '韩钥'
            when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
            when dp.region_name in ( 'Area8') then '黄勇'
            when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
        end 区域
        ,dp.region_name 大区
        ,dp.piece_name 片区
        ,a.应交接
        ,a.已交接
        ,concat(round(a.交接率*100,2),'%') as 交接率
        ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
        ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
        ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
        ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
        ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
    from
        (
            select
                t1.store_id
                ,t1.stat_date
                ,count(t1.pno) 应交接
                ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
            from t t1
            left join
                (
                    select
                        sc.*
                    from
                        (
                            select
                                pr.pno
                                ,pr.store_id
                                ,pr.store_name
                                ,t1.stat_date
                                ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                            from ph_staging.parcel_route pr
                            join t t1 on t1.pno = pr.pno
                            where
                                pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                               and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                              and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                        ) sc
                    where
                        sc.rk = 1
                ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
            group by 1,2
        ) a
    join
        (
            select
                sd.store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.store_id is not null
            group by 1

            union all

            select
                sd.separation_store_id store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.separation_store_id is not null
            group by 1
        ) sd on sd.store_id = a.store_id
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    where
        dp.store_category in (1,10);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-08-30'
        and pr.routed_at >= date_sub('2023-08-30', interval 8 hour )
        and pr.routed_at < date_add('2023-08-30', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end 评级
        ,a2.code_num
        ,a2.staff_code_num
        ,a2.staff_num
        ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-30'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-08-30')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-08-30'
        and pi.finished_at >= date_sub('2023-08-30', interval 8 hour )
        and pi.finished_at < date_add('2023-08-30', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-08-30'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
select
    td.pno
    ,ss.name 网点
    ,convert_tz(pi.created_at, '+00:00', '+08:00') 揽收时间
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
from ph_staging.ticket_delivery td
left join ph_staging.parcel_info pi on pi.pno = td.pno
left join ph_staging.sys_store ss on ss.id = td.store_id
where
    td.created_at <= date_add(curdate(), interval 1 day )
    and td.delivery_opt = 4
    and pi.state = 3
    and td.store_id in ('PH77190100','PH73090800','PH73020100','PH77030100','PH77050A00','PH76120H00','PH74060200','PH76090C00','PH74010100','PH76040A00','PH73030300','PH76190100','PH74120A00','PH75060200','PH51050301','PH47170100','PH51050500','PH49040100','PH51030400','PH51020J00','PH47140200','PH49040102','PH47210100','PH51100100','PH47080301','PH51080100','PH49040101','PH47070A00','PH47200600','PH47120100','PH47150100','PH51080101','PH51120B01','PH45210101','PH45212600','PH50100100','PH46020100','PH45130F00','PH46050101','PH45200H00','PH44020100','PH44180100','PH46150100','PH45210100','PH45010100','PH44010T00','PH50100200','PH45140300','PH14010F00','PH14010F00','PH22130500','PH23100300')
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    td.pno
    ,ss.name 网点
    ,convert_tz(pi.created_at, '+00:00', '+08:00') 揽收时间
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,case td.state
        when 0 then '待完成'
        when 1 then '已完成'
        when 2 then '已终止'
        when 3 then '已关闭'
    end 任务状态
from ph_staging.ticket_delivery td
left join ph_staging.parcel_info pi on pi.pno = td.pno
left join ph_staging.sys_store ss on ss.id = td.store_id
where
    td.created_at <= date_add(curdate(), interval 1 day )
    and td.delivery_opt = 4
    and pi.state = 3
    and td.store_id in ('PH77190100','PH73090800','PH73020100','PH77030100','PH77050A00','PH76120H00','PH74060200','PH76090C00','PH74010100','PH76040A00','PH73030300','PH76190100','PH74120A00','PH75060200','PH51050301','PH47170100','PH51050500','PH49040100','PH51030400','PH51020J00','PH47140200','PH49040102','PH47210100','PH51100100','PH47080301','PH51080100','PH49040101','PH47070A00','PH47200600','PH47120100','PH47150100','PH51080101','PH51120B01','PH45210101','PH45212600','PH50100100','PH46020100','PH45130F00','PH46050101','PH45200H00','PH44020100','PH44180100','PH46150100','PH45210100','PH45010100','PH44010T00','PH50100200','PH45140300','PH14010F00','PH14010F00','PH22130500','PH23100300');
;-- -. . -..- - / . -. - .-. -.--
select
    case vrv.type
        when 1 then '揽件任务异常取消'
        when 2 then '虚假妥投'
        when 3 then '收件人拒收'
        when 4 then '标记客户改约时间'
        when 5 then 'KA现场不揽收'
        when 6 then '包裹未准备好'
        when 7 then '上报错分未妥投'
        when 8 then '多次尝试派送失败'
    end 回访类型
    ,bc.client_name 客户
    ,vrv.link_id 单号
    ,case vrv.visit_state
        when 1 then '待回访'
        when 2 then '沟通中'
        when 3 then '多次未联系上客户'
        when 4 then '已回访'
        when 5 then '因同包裹生成其他回访任务关闭'
        when 6 then 'VR回访结果=99关闭'
        when 7 then '超回访时效关闭'
    end  回访状态
    ,if(vrv.visit_state in (3,4,5,6,7), '完成', '未完成') 是否完成
    ,vrv.created_at 回访任务创建时间
    ,case
        when vrv.created_at >= date_add('2023-08-30', interval 9 hour) and vrv.created_at < date_add('2023-08-30', interval 17 hour) then '今日9点-今日17点'
        when vrv.created_at >= date_sub('2023-08-30', interval 7 hour) and vrv.created_at < date_add('2023-08-30', interval 9 hour) then '昨日17点-今日9点'
    end 时间段
    ,vrv.visit_num 回访次数
    ,if(vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ), 'IVR', '人工') 应处理人
    ,case cdt.state
        when 0 then '未处理'
        when 1 then '已处理'
        when 2 then '沟通中'
        when 3 then '支付驳回'
        when 4 then '客户未处理'
        when 5 then '转交闪速系统'
        when 6 then '转交QAQC'
    end 绑定疑难件处理状态
    ,case
        when vrv.type = 3 and vrv.visit_state in (3,7) or json_extract(vrv.extra_value, '$.rejection_delivery_again') = 1 then '退件' -- 多次联系不上、超时效和回访结果是退件
        when vrv.type = 3 and json_extract(vrv.extra_value, '$.rejection_delivery_again') = 2 then '继续派送' -- 继续派送
        when vrv.type = 8 and vrv.visit_state in (3,7) or vrv.visit_result = 44 then '退件' --  多次联系不上和回访结果是退件
        when vrv.type = 8 and vrv.visit_result = 43 then '继续派送'
        else '异常关闭'
    end '回访处理结果（回访结果，不代表包裹最终结果）'
#     ,count(vrv.id) 回访任务量
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at >= date_sub('${date}', interval 7 hour), vrv.id, null)) 历史积压处理完成量 -- 查训当日处理完成量
#     ,count(if(vrv.visit_state in (1,2), vrv.id, null )) 历史积压未完成量
from nl_production.violation_return_visit vrv
join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
join tmpale.tmp_ph_client_visit_info t on t.type = vrv.type and bc.client_name = t.client_name
left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = json_extract(vrv.extra_value, '$.diff_id')
where
    vrv.type in (3,8)
#     and vrv.created_at <= date_sub('${date}', interval 7 hour) -- 昨天17点之前
    and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
    and
        (
            (vrv.visit_state in (3,4,5,6,7) and vrv.updated_at > date_sub('2023-08-30', interval 7 hour)) -- 查询日期17点之后处理
            or vrv.visit_state in (1,2) -- 至今也是未处理
        )
    and vrv.created_at >= date_add('2023-08-30', interval 17 hour)
    and vrv.created_at < date_add('2023-08-30', interval 20 hour);
;-- -. . -..- - / . -. - .-. -.--
select
    case vrv.type
        when 1 then '揽件任务异常取消'
        when 2 then '虚假妥投'
        when 3 then '收件人拒收'
        when 4 then '标记客户改约时间'
        when 5 then 'KA现场不揽收'
        when 6 then '包裹未准备好'
        when 7 then '上报错分未妥投'
        when 8 then '多次尝试派送失败'
    end 回访类型
    ,bc.client_name 客户
    ,vrv.link_id 单号
    ,case vrv.visit_state
        when 1 then '待回访'
        when 2 then '沟通中'
        when 3 then '多次未联系上客户'
        when 4 then '已回访'
        when 5 then '因同包裹生成其他回访任务关闭'
        when 6 then 'VR回访结果=99关闭'
        when 7 then '超回访时效关闭'
    end  回访状态
    ,if(vrv.visit_state in (3,4,5,6,7), '完成', '未完成') 是否完成
    ,vrv.created_at 回访任务创建时间
    ,case
        when vrv.created_at >= date_add('2023-08-30', interval 9 hour) and vrv.created_at < date_add('2023-08-30', interval 17 hour) then '今日9点-今日17点'
        when vrv.created_at >= date_sub('2023-08-30', interval 7 hour) and vrv.created_at < date_add('2023-08-30', interval 9 hour) then '昨日17点-今日9点'
    end 时间段
    ,vrv.visit_num 回访次数
    ,if(vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ), 'IVR', '人工') 应处理人
    ,case cdt.state
        when 0 then '未处理'
        when 1 then '已处理'
        when 2 then '沟通中'
        when 3 then '支付驳回'
        when 4 then '客户未处理'
        when 5 then '转交闪速系统'
        when 6 then '转交QAQC'
    end 绑定疑难件处理状态
    ,case
        when vrv.type = 3 and vrv.visit_state in (3,7) or json_extract(vrv.extra_value, '$.rejection_delivery_again') = 1 then '退件' -- 多次联系不上、超时效和回访结果是退件
        when vrv.type = 3 and json_extract(vrv.extra_value, '$.rejection_delivery_again') = 2 then '继续派送' -- 继续派送
        when vrv.type = 8 and vrv.visit_state in (3,7) or vrv.visit_result = 44 then '退件' --  多次联系不上和回访结果是退件
        when vrv.type = 8 and vrv.visit_result = 43 then '继续派送'
        else '异常关闭'
    end '回访处理结果（回访结果，不代表包裹最终结果）'
#     ,count(vrv.id) 回访任务量
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at >= date_sub('${date}', interval 7 hour), vrv.id, null)) 历史积压处理完成量 -- 查训当日处理完成量
#     ,count(if(vrv.visit_state in (1,2), vrv.id, null )) 历史积压未完成量
from nl_production.violation_return_visit vrv
join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
join tmpale.tmp_ph_client_visit_info t on t.type = vrv.type and bc.client_name = t.client_name
left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = json_extract(vrv.extra_value, '$.diff_id')
where
    vrv.type in (3,8)
#     and vrv.created_at <= date_sub('${date}', interval 7 hour) -- 昨天17点之前
    and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
    and
        (
            (vrv.visit_state in (3,4,5,6,7) and vrv.updated_at > date_sub('2023-08-30', interval 7 hour)) -- 查询日期17点之后处理
            or vrv.visit_state in (1,2) -- 至今也是未处理
        )
    and vrv.created_at >= date_sub('2023-08-30', interval 7 hour)
    and vrv.created_at < date_add('2023-08-30', interval 17 hour);
;-- -. . -..- - / . -. - .-. -.--
select
            vrv.type
            ,bc.client_name
            ,count(vrv.id) ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at < date_add(' 2023-08-30', interval 1 day), vrv.id, null))/count(vrv.id) day_deal_rate
            ,count(if(cdt.state != 1 and vrv.visit_state in (3,4,7) and cdt.id is not null, vrv.id, null)) undeal_diff_count
        from nl_production.violation_return_visit vrv
        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = json_extract(vrv.extra_value, '$.diff_id')
        where
            vrv.type in (3,8)
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                ( vrv.visit_staff_id != 10001 and ( vrv.visit_staff_id != 0 or vrv.visit_state != 2 ))
            and vrv.created_at >= date_sub(' 2023-08-30', interval 7 hour)
            and vrv.created_at < date_add(' 2023-08-30', interval 17 hour) -- 17-17
        group by 1,2;
;-- -. . -..- - / . -. - .-. -.--
select
            vrv.type
            ,bc.client_name
            ,count(vrv.id) ticket_count
            ,count(if(vrv.visit_state in (3,4,5,6,7) , vrv.id, null))/count(vrv.id) day_deal_rate
            ,count(if(cdt.state != 1 and vrv.visit_state in (3,4,7) and cdt.id is not null, vrv.id, null)) undeal_diff_count
        from nl_production.violation_return_visit vrv
        left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
        left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = json_extract(vrv.extra_value, '$.diff_id')
        where
            vrv.type in (3,8)
            and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
            and
                ( vrv.visit_staff_id != 10001 and ( vrv.visit_staff_id != 0 or vrv.visit_state != 2 ))
            and vrv.created_at >= date_sub(' 2023-08-30', interval 7 hour)
            and vrv.created_at < date_add(' 2023-08-30', interval 17 hour) -- 17-17
        group by 1,2;
;-- -. . -..- - / . -. - .-. -.--
select
    case vrv.type
        when 1 then '揽件任务异常取消'
        when 2 then '虚假妥投'
        when 3 then '收件人拒收'
        when 4 then '标记客户改约时间'
        when 5 then 'KA现场不揽收'
        when 6 then '包裹未准备好'
        when 7 then '上报错分未妥投'
        when 8 then '多次尝试派送失败'
    end 回访类型
    ,bc.client_name 客户
    ,vrv.link_id 单号
    ,case vrv.visit_state
        when 1 then '待回访'
        when 2 then '沟通中'
        when 3 then '多次未联系上客户'
        when 4 then '已回访'
        when 5 then '因同包裹生成其他回访任务关闭'
        when 6 then 'VR回访结果=99关闭'
        when 7 then '超回访时效关闭'
    end  回访状态
    ,if(vrv.visit_state in (3,4,5,6,7), '完成', '未完成') 是否完成
    ,vrv.created_at 回访任务创建时间
    ,case
        when vrv.created_at >= date_add('2023-08-30', interval 9 hour) and vrv.created_at < date_add('2023-08-30', interval 17 hour) then '今日9点-今日17点'
        when vrv.created_at >= date_sub('2023-08-30', interval 7 hour) and vrv.created_at < date_add('2023-08-30', interval 9 hour) then '昨日17点-今日9点'
    end 时间段
    ,vrv.visit_num 回访次数
    ,if(vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ), 'IVR', '人工') 应处理人
    ,case cdt.state
        when 0 then '未处理'
        when 1 then '已处理'
        when 2 then '沟通中'
        when 3 then '支付驳回'
        when 4 then '客户未处理'
        when 5 then '转交闪速系统'
        when 6 then '转交QAQC'
    end 绑定疑难件处理状态
    ,case
        when vrv.type = 3 and vrv.visit_state in (3,7) or json_extract(vrv.extra_value, '$.rejection_delivery_again') = 1 then '退件' -- 多次联系不上、超时效和回访结果是退件
        when vrv.type = 3 and json_extract(vrv.extra_value, '$.rejection_delivery_again') = 2 then '继续派送' -- 继续派送
        when vrv.type = 8 and vrv.visit_state in (3,7) or vrv.visit_result = 44 then '退件' --  多次联系不上和回访结果是退件
        when vrv.type = 8 and vrv.visit_result = 43 then '继续派送'
        else '异常关闭'
    end '回访处理结果（回访结果，不代表包裹最终结果）'
#     ,count(vrv.id) 回访任务量
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at >= date_sub('${date}', interval 7 hour), vrv.id, null)) 历史积压处理完成量 -- 查训当日处理完成量
#     ,count(if(vrv.visit_state in (1,2), vrv.id, null )) 历史积压未完成量
from nl_production.violation_return_visit vrv
join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
join tmpale.tmp_ph_client_visit_info t on t.type = vrv.type and bc.client_name = t.client_name
left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = json_extract(vrv.extra_value, '$.diff_id')
where
    vrv.type in (3,8)
#     and vrv.created_at <= date_sub('${date}', interval 7 hour) -- 昨天17点之前
    and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
#     and
#         (
#             (vrv.visit_state in (3,4,5,6,7) and vrv.updated_at > date_sub('${date}', interval 7 hour)) -- 查询日期17点之后处理
#             or vrv.visit_state in (1,2) -- 至今也是未处理
#         )
    and vrv.created_at >= date_sub('2023-08-30', interval 7 hour)
    and vrv.created_at < date_add('2023-08-30', interval 17 hour);
;-- -. . -..- - / . -. - .-. -.--
select
    case vrv.type
        when 1 then '揽件任务异常取消'
        when 2 then '虚假妥投'
        when 3 then '收件人拒收'
        when 4 then '标记客户改约时间'
        when 5 then 'KA现场不揽收'
        when 6 then '包裹未准备好'
        when 7 then '上报错分未妥投'
        when 8 then '多次尝试派送失败'
    end 回访类型
    ,bc.client_name 客户
    ,vrv.link_id 单号
    ,case vrv.visit_state
        when 1 then '待回访'
        when 2 then '沟通中'
        when 3 then '多次未联系上客户'
        when 4 then '已回访'
        when 5 then '因同包裹生成其他回访任务关闭'
        when 6 then 'VR回访结果=99关闭'
        when 7 then '超回访时效关闭'
    end  回访状态
    ,if(vrv.visit_state in (3,4,5,6,7), '完成', '未完成') 是否完成
    ,vrv.created_at 回访任务创建时间
    ,case
        when vrv.created_at >= date_add('2023-08-30', interval 9 hour) and vrv.created_at < date_add('2023-08-30', interval 17 hour) then '今日9点-今日17点'
        when vrv.created_at >= date_sub('2023-08-30', interval 7 hour) and vrv.created_at < date_add('2023-08-30', interval 9 hour) then '昨日17点-今日9点'
    end 时间段
    ,vrv.visit_num 回访次数
    ,if(vrv.visit_staff_id = 10001 or ( vrv.visit_staff_id = 0 and vrv.visit_state = 2 ), 'IVR', '人工') 应处理人
    ,case cdt.state
        when 0 then '未处理'
        when 1 then '已处理'
        when 2 then '沟通中'
        when 3 then '支付驳回'
        when 4 then '客户未处理'
        when 5 then '转交闪速系统'
        when 6 then '转交QAQC'
    end 绑定疑难件处理状态
    ,case
        when vrv.type = 3 and vrv.visit_state in (3,7) or json_extract(vrv.extra_value, '$.rejection_delivery_again') = 1 then '退件' -- 多次联系不上、超时效和回访结果是退件
        when vrv.type = 3 and json_extract(vrv.extra_value, '$.rejection_delivery_again') = 2 then '继续派送' -- 继续派送
        when vrv.type = 8 and vrv.visit_state in (3,7) or vrv.visit_result = 44 then '退件' --  多次联系不上和回访结果是退件
        when vrv.type = 8 and vrv.visit_result = 43 then '继续派送'
        else '异常关闭'
    end '回访处理结果（回访结果，不代表包裹最终结果）'
#     ,count(vrv.id) 回访任务量
#     ,count(if(vrv.visit_state in (3,4,5,6,7) and vrv.updated_at >= date_sub('${date}', interval 7 hour), vrv.id, null)) 历史积压处理完成量 -- 查训当日处理完成量
#     ,count(if(vrv.visit_state in (1,2), vrv.id, null )) 历史积压未完成量
from nl_production.violation_return_visit vrv
join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
join tmpale.tmp_ph_client_visit_info t on t.type = vrv.type and bc.client_name = t.client_name
left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = json_extract(vrv.extra_value, '$.diff_id')
where
    vrv.type in (3,8)
    and vrv.visit_state != 0
#     and vrv.created_at <= date_sub('${date}', interval 7 hour) -- 昨天17点之前
    and vrv.created_at >= date_sub(curdate(), interval 7 day ) -- 回访系统只呈现近7天时间
#     and
#         (
#             (vrv.visit_state in (3,4,5,6,7) and vrv.updated_at > date_sub('${date}', interval 7 hour)) -- 查询日期17点之后处理
#             or vrv.visit_state in (1,2) -- 至今也是未处理
#         )
    and vrv.created_at >= date_sub('2023-08-30', interval 7 hour)
    and vrv.created_at < date_add('2023-08-30', interval 17 hour);
;-- -. . -..- - / . -. - .-. -.--
select date_sub(curdate(), interval 2 day);
;-- -. . -..- - / . -. - .-. -.--
select
    plt.pno
    ,plt.id
    ,case plt.state
        when 1 then '丢失件待处理'
        when 2 then '疑似丢失件待处理'
        when 3 then '待工单回复'
        when 4 then '已工单回复'
        when 5 then '包裹未丢失'
        when 6 then '丢失件处理完成'
    end 状态
from ph_bi.parcel_lose_task plt
where
    plt.pno in ('P231223238AAM','P612723PWTZAH','P330822WCSPAD','P590222T7B9AG','PT150222UHS49AG','PT190522UT749BW','PT611422VJ0H8CL','PT612722T3PU4AF','P612522GQNEAT','PT612522VFHA5AP','P121022DMW5AW','P192423D1FTBG','PT610622UNJZ8AB','P61111UDNZ0AN','P172023PC87AL','P613022D9KSAT ','P1401228D24AR','P210923VQTDAB','P210823Q6ZXAJ','P27152374B3AE','P072222NCE2AG','P611522GUGDAE','PT613022UDRN8AL','PT612522S35M2AU','P61111S6JAUAN','PT640222QJPJ1EJ','PT611822V3HW3FI','PT612822VN2R3AH','P800922Q3D7AW','P613022UX7CAO','P612322W1C2AK','P420321QSEGFI','P080522NC8XAX','P140922VHMHAB','P61181VAUSYDB','P201822UJ5QAS','PT060422U4FP0BI','P210823FG2BAJ','P130323EWNDDF','P61111S97EBAN','P611523CEZKAP','P6114239HJ7CK','P0101239FVUAA','P611822YEQNEF','P210822TU9NAK','PT612522W7VZ9AN','P611920ZENUAB','P6107232JTRAL','P612622NPJKAB','PD611523CNDWBA','P191123NH13AI','P122023M61KAB','P2018236XX2AS','P611822X61WCX','PT210222V0DB7AB','P612021HG2MGV','P181923DUHYAL','PT612622U6W02AD','P121422MRS7AH','PT612022RHE76GU','PT120322TU4G0AT','P151623S5ABBS','P150323Q0UFBE','P6123225XRDAE','P613022RCD7AT','P613022UZUYAV','P590222TJA9AK','PT611622V75H1AE','P611423YE3CDE','PT611822T3116FI','PT611822T3116FI','P1925233FUAAV','P180923HEB3DC','P590321HKSUAO','P122023HDGEBA','P610123HJMSCP','P612523VMYPAI','P612823MST0CX','P1911220NV8AD','P612123KHVVAO','P611723R2UBBD','P121121AX7WAA','P612023GVHWDS','PT490422RWPT0BR','P0418202H2CAH','P40391XKYSXAH','PT611422W8T96CQ','P180923BRUJBV','P044423SS14AG','P180823J4U9AV','P6128201FBHFV','P180323Z9UCAR','PT122022WV2D1BS','P1928233ZMHAH','PT612822T2JT0CX','P192823ADU9AH','PT612822Q5BK2HM','PT612922V29R9AG','PT611022UBQW3AN','PT121322X9XE8AD','PT131222V89W5AU','P192822QD3WAH','PT612022KG8U6GJ','PT611722UUBW5AN','PT150722V8W71AT','P210822UNRTAB','P613122XHX8BO','P612023KS8QAY','P210823PSVNAB','P590222TJA9AK','P6401232STFAE','P5902230QEQAK','P612423EQCKAK','P201323C4H5BJ','P21052377X5AC','P420522JKJQBC','P322123GQBKCO','P611621K89QAN','P611723T7CDBD','P192822QZ7UAH','P121721TECMAL','P192822VHVMAH','P611723J63NAE','P1928223K0HAH','PD613023M3W1AC','P242922TMN3AR','P323322GRNSAJ','P61041ZCEEHAA','P610123RKJTJH','P61041ZDD25AA','P613123KV2EAK','P61041ZH8RUAA','P61041Z6GK7AA','P611121YVYABN','P610420AXBRAA','P611121MMH6BN','P611121HWCXBN','P6201234T6UBD','P612023SFXZGT','P210521HF9CAG','P420522JY46BC','P612122CK8RAE','P64022344YQDM','P612623EQRRAH','P211323C58AAE','P6117239JYYAQ','P172222ZNQ7BF','P343323098GAB','P611523BMRMAX','P192523M49UAR','P043823H8U2AH','P610420MKP8AA','P5105222TXDBO','P610420BBC9AA','P610421BFHMAA','P6126241T77AB','P610123C3J1JC','P61041YRYZTAA','P070823R2MJBZ','P35172379MDAG','P6131235P0CBQ','P171923P58SBM','P612022V745EE','PT180822TRFB2AB','P321822SJCTAD','P042723ZAW7CU','P2001239XT1AK','PT220622VTEA3BY','PT612422RYE45AL','PT612422RW1K0AL','PT170522UXR84AJ','P122023MAFXCE','PT611422UK686CF','P141723S9DYAN','P180623U9M0BU','P61182301BBFH','P510522JRT9BS','P61041ZBCK7AA','P6107227SGJAL','P611623YMECAE','P151723MJDNAS','PT610822W65V0AI','PT411322T9FE0AF','PT180922XD653AL','P180623NRUWAB','P324123SKS0AB','P611822MBT8FL','PT613122XBAK4AF','P1328236JQ2BA','P130323AYWJAA','P61042134G7AA','PT613022UUW64AE','PT180322UX9H4AP','P611723K45TAE','P611723JAN6AE','P180923ZCT5AB','PT010522UEEJ2BH','PT611822WX129EA','PT611422R6XC4AX','PT040422VM1X4AR','PT610622JEXP4AD','P61041Z8VSUAA','P192822F6XRAH','PT611822HW271FJ','P6123231H7PAD','P640220A67PAA','P6114244R8VCP','P612323USRJAS','P611722GK1XAK','P61182409YCFJ','P0606232EWWAV','P210223A6EXAF','P611523J3X8AV','P2102248T8QAC','PT351722S3QH1AZ','PT191122WGZG8AD','PT211322TDQP4AC','PT611722TQS01AK','PT611722X06C7AK','P3530245H5UAL','P130323YDFNDB','P352621C8BWAR','P640623R8V8AD','PT611422R6XC4AX','P612222F8JTAH','PT613022XGP99AM','P042923WBPKAM','P22012405XVBW','P611923ZE94AI','P611820Y5V6FJ','P611822BR4VCN','P21042312QQAC','P61041ZG1DNAA','PT612822WWQ73DI','PT353022UE7M4AC','PT612322XCMM6AK','P610223JSMRAC','PT140422VD644AG','P061923J9PKAC','P0438235RUVBA','P61172147P5BA','P611522WG3AAB','PT180822W60E6BF','P182023B3T9AW','P2701227BT1AO','P613023270YAR','PT612522Y0UW0AI','P6110225UREAO','P150823WBVTAP','P3517221TEDAJ','P61152403F9AS','P610521MZ0EBA','P1220249T8QAF','P2401248P45AS','P172723V0JZAE','P6125232RJGAU','PT210222XM7Z7AB','PT422522UWW64AT','P192822H2FJAH','P613023B3C3AP','PT180622WREY5AA','PT611022U19K3AH','P192821WEDYAH','P19281ZCDY8AH','P343322XVVAAC','PT210222XDSY3AA','P19281XFHQ6AH','P19281XEAWVAH','P19281W5V2PAH','P19281SQXQKAH','P19281S2UE6AH','P19281VK5EYAH','P19281W3UWAAH','P19281S8TKEAH','P610423JSD1AJ','PT270522WUDJ6AM','PT062922WEKY0AF','PT613022YKVK3AM','P61171411YUAA','PT171922Y6EW6AW','P611713TUJ5AA','PT612822UMSJ4AA','P6117143BU9AA','PT073122XVW57AJ','PT610122U1S14GM','P192820ZZJ0AH','P192821BB2PAH','P1928216A8BAH','P192820KSMTAH','PT611622SSEH6AM','P19281ZWY09AH','P192820ZAP6AH','P19281W4EZVAH','P19281VH19TAH','P19281VJZKRAH','P19281S8TQ5AH','P180124DP6PAT','P19281QP6HEAH','PT610622TWSX2AD','PT611522WQ187AS','P6118225R7SDS','P180622HKFVAB','P342722ENFAAO','P6126246JATAH','P140922MY0FAL','P1210246AYSBM','PT770122VSUN3AL','PT611722ZAHC2AK','P353023AWUUAZ','P6118233ERUFI','PT150722ZHTR6AB','PT612422YS1K3AN','P611522VBRWAV','P80022405G6AK','P220324CVBUAJ','P61231ZHYX5AB','P612320ZG2JAB','P612320M8NWAB','P61211YVZZSAD','P61181YWBVJBX','P12081ZC0UBAL','P61181YAKNJCP','P61021YK9B7AC','P61021YVBYSAA','P61031Z4E47AA','P61031Z797AAN','P61201ZJE1PDR','P12231Z472EAT','P180424BTDYAA');
;-- -. . -..- - / . -. - .-. -.--
select
    pr.pno
    ,convert_tz(pr.routed_at, '+00:00', '+08:00') scan_time
    ,if(coalesce(pi3.cod_enabled, pi.cod_enabled) = 1, 'COD', 'NO_COD') COD_OR_NOT
    ,case pi.state
        when 1 then 'RECEIVED'
        when 2 then 'IN_TRANSIT'
        when 3 then 'DELIVERING'
        when 4 then 'STRANDED'
        when 5 then 'SIGNED'
        when 6 then 'IN_DIFFICULTY'
        when 7 then 'RETURNED'
        when 8 then 'ABNORMAL_CLOSED'
        when 9 then 'CANCEL'
    end shipment_status
    ,pi.returned_pno
    ,case pi3.state
        when 1 then 'RECEIVED'
        when 2 then 'IN_TRANSIT'
        when 3 then 'DELIVERING'
        when 4 then 'STRANDED'
        when 5 then 'SIGNED'
        when 6 then 'IN_DIFFICULTY'
        when 7 then 'RETURNED'
        when 8 then 'ABNORMAL_CLOSED'
        when 9 then 'CANCEL'
    end returned_pno_shipment_status
from ph_staging.parcel_route pr
left join ph_staging.parcel_info pi on pi.pno = pr.pno
left join ph_staging.parcel_info pi2 on pi2.pno = pi.returned_pno
left join ph_staging.parcel_info pi3 on pi3.returned_pno = pi.pno
where
    pr.routed_at >= '2023-07-31 16:00:00'
    and pr.staff_info_id = 160732;
;-- -. . -..- - / . -. - .-. -.--
select
    pr.pno
    ,convert_tz(pr.routed_at, '+00:00', '+08:00') scan_time
    ,if(coalesce(pi3.cod_enabled, pi.cod_enabled) = 1, 'COD', 'NO_COD') COD_OR_NOT
    ,case pi.state
        when 1 then 'RECEIVED'
        when 2 then 'IN_TRANSIT'
        when 3 then 'DELIVERING'
        when 4 then 'STRANDED'
        when 5 then 'SIGNED'
        when 6 then 'IN_DIFFICULTY'
        when 7 then 'RETURNED'
        when 8 then 'ABNORMAL_CLOSED'
        when 9 then 'CANCEL'
    end shipment_status
    ,pi.returned_pno
    ,case pi2.state
        when 1 then 'RECEIVED'
        when 2 then 'IN_TRANSIT'
        when 3 then 'DELIVERING'
        when 4 then 'STRANDED'
        when 5 then 'SIGNED'
        when 6 then 'IN_DIFFICULTY'
        when 7 then 'RETURNED'
        when 8 then 'ABNORMAL_CLOSED'
        when 9 then 'CANCEL'
    end returned_pno_shipment_status
from ph_staging.parcel_route pr
left join ph_staging.parcel_info pi on pi.pno = pr.pno
left join ph_staging.parcel_info pi2 on pi2.pno = pi.returned_pno
left join ph_staging.parcel_info pi3 on pi3.returned_pno = pi.pno
where
    pr.routed_at >= '2023-07-31 16:00:00'
    and pr.staff_info_id = 160732;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-08-31'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-08-31'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-08-31', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with d as
    (
        select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-08-31'
    )
    , t as
    (
        select
             ds.store_id
            ,ds.pno
            ,ds.stat_date
        from d ds
        left join
            (
                select
                    pr.pno
                    ,ds.stat_date
                    ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
                from ph_staging.parcel_route pr
                join d ds on pr.pno = ds.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                    and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and pr.marker_category in (42,43) ##岛屿,偏远地区
                group by 1,2
            ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
        left join
            (
                select
                   pr.pno
                    ,ds.stat_date
                   ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
                   ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
                from ph_staging.parcel_route pr
                join d ds on ds.pno = pr.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                    and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                    and pr.marker_category in (9,14,70) ##客户改约时间
            ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
        left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
        where
            case
                when pr1.pno is not null then 'N'
                when pr2.pno is not null then 'N'
                when ds1.pno is not null  then 'N'  else 'Y'
            end = 'Y'
    )
    select
        a.stat_date 日期
        ,a.store_id 网点ID
        ,dp.store_name 网点名称
        ,dp.opening_at 开业时间
        ,case
            when dp.region_name in ('Area3', 'Area6') then '彭万松'
            when dp.region_name in ('Area4', 'Area9') then '韩钥'
            when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
            when dp.region_name in ( 'Area8') then '黄勇'
            when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
        end 区域
        ,dp.region_name 大区
        ,dp.piece_name 片区
        ,a.应交接
        ,a.已交接
        ,concat(round(a.交接率*100,2),'%') as 交接率
        ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
        ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
        ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
        ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
        ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
    from
        (
            select
                t1.store_id
                ,t1.stat_date
                ,count(t1.pno) 应交接
                ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
            from t t1
            left join
                (
                    select
                        sc.*
                    from
                        (
                            select
                                pr.pno
                                ,pr.store_id
                                ,pr.store_name
                                ,t1.stat_date
                                ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                            from ph_staging.parcel_route pr
                            join t t1 on t1.pno = pr.pno
                            where
                                pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                               and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                              and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                        ) sc
                    where
                        sc.rk = 1
                ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
            group by 1,2
        ) a
    join
        (
            select
                sd.store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.store_id is not null
            group by 1

            union all

            select
                sd.separation_store_id store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.separation_store_id is not null
            group by 1
        ) sd on sd.store_id = a.store_id
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    where
        dp.store_category in (1,10);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-08-31'
        and pr.routed_at >= date_sub('2023-08-31', interval 8 hour )
        and pr.routed_at < date_add('2023-08-31', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,if(a3.self_staff_num + other_staff_num > coalesce(sdb.code_num, 0),
           case
            when a2.avg_staff_code < 2 then 'A'
            when a2.avg_staff_code >= 2 and a2.avg_staff_code < 3 then 'B'
            when a2.avg_staff_code >= 3 and a2.avg_staff_code < 4 then 'C'
            when a2.avg_staff_code >= 4 then 'D'
        end,
           case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end ) 评级
#         ,a2.code_num
#         ,a2.staff_code_num
#         ,a2.staff_num
#         ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) avg_staff_code
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-08-31'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-08-31')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-08-31'
        and pi.finished_at >= date_sub('2023-08-31', interval 8 hour )
        and pi.finished_at < date_add('2023-08-31', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-08-31'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
select
    td.pno
    ,ss.name 网点
    ,convert_tz(pi.created_at, '+00:00', '+08:00') 揽收时间
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,case td.state
        when 0 then '待完成'
        when 1 then '已完成'
        when 2 then '已终止'
        when 3 then '已关闭'
    end 任务状态
from ph_staging.ticket_delivery td
left join ph_staging.parcel_info pi on pi.pno = td.pno
left join ph_staging.sys_store ss on ss.id = td.store_id
where
    td.created_at <= '2023-08-31 16:00:00'
    and td.delivery_opt = 4
    and td.state = 0
#     and pi.state = 3
    and td.store_id in ('PH77190100','PH73090800','PH73020100','PH77030100','PH77050A00','PH76120H00','PH74060200','PH76090C00','PH74010100','PH76040A00','PH73030300','PH76190100','PH74120A00','PH75060200','PH51050301','PH47170100','PH51050500','PH49040100','PH51030400','PH51020J00','PH47140200','PH49040102','PH47210100','PH51100100','PH47080301','PH51080100','PH49040101','PH47070A00','PH47200600','PH47120100','PH47150100','PH51080101','PH51120B01','PH45210101','PH45212600','PH50100100','PH46020100','PH45130F00','PH46050101','PH45200H00','PH44020100','PH44180100','PH46150100','PH45210100','PH45010100','PH44010T00','PH50100200','PH45140300','PH14010F00','PH14010F00','PH22130500','PH23100300');
;-- -. . -..- - / . -. - .-. -.--
select
    td.pno
    ,ss.name 网点
    ,convert_tz(pi.created_at, '+00:00', '+08:00') 揽收时间
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,case td.state
        when 0 then '待完成'
        when 1 then '已完成'
        when 2 then '已终止'
        when 3 then '已关闭'
    end 任务状态
from ph_staging.ticket_delivery td
left join ph_staging.parcel_info pi on pi.pno = td.pno
left join ph_staging.sys_store ss on ss.id = td.store_id
where
    td.created_at <= '2023-09-01 16:00:00'
    and td.delivery_opt = 4
    and td.state = 0
#     and pi.state = 3
    and td.store_id in ('PH77190100','PH73090800','PH73020100','PH77030100','PH77050A00','PH76120H00','PH74060200','PH76090C00','PH74010100','PH76040A00','PH73030300','PH76190100','PH74120A00','PH75060200','PH51050301','PH47170100','PH51050500','PH49040100','PH51030400','PH51020J00','PH47140200','PH49040102','PH47210100','PH51100100','PH47080301','PH51080100','PH49040101','PH47070A00','PH47200600','PH47120100','PH47150100','PH51080101','PH51120B01','PH45210101','PH45212600','PH50100100','PH46020100','PH45130F00','PH46050101','PH45200H00','PH44020100','PH44180100','PH46150100','PH45210100','PH45010100','PH44010T00','PH50100200','PH45140300','PH14010F00','PH14010F00','PH22130500','PH23100300');
;-- -. . -..- - / . -. - .-. -.--
select
    td.pno
    ,ss.name 网点
    ,convert_tz(pi.created_at, '+00:00', '+08:00') 揽收时间
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,case td.state
        when 0 then '待完成'
        when 1 then '已完成'
        when 2 then '已终止'
        when 3 then '已关闭'
    end 任务状态
from ph_staging.ticket_delivery td
left join ph_staging.parcel_info pi on pi.pno = td.pno
left join ph_staging.sys_store ss on ss.id = td.store_id
where
    td.created_at <= '2023-09-01 16:00:00'
    and td.delivery_opt = 4
#     and td.state = 0
    and pi.state = 3
    and td.store_id in ('PH77190100','PH73090800','PH73020100','PH77030100','PH77050A00','PH76120H00','PH74060200','PH76090C00','PH74010100','PH76040A00','PH73030300','PH76190100','PH74120A00','PH75060200','PH51050301','PH47170100','PH51050500','PH49040100','PH51030400','PH51020J00','PH47140200','PH49040102','PH47210100','PH51100100','PH47080301','PH51080100','PH49040101','PH47070A00','PH47200600','PH47120100','PH47150100','PH51080101','PH51120B01','PH45210101','PH45212600','PH50100100','PH46020100','PH45130F00','PH46050101','PH45200H00','PH44020100','PH44180100','PH46150100','PH45210100','PH45010100','PH44010T00','PH50100200','PH45140300','PH14010F00','PH14010F00','PH22130500','PH23100300');
;-- -. . -..- - / . -. - .-. -.--
select
    td.pno
    ,ss.name 网点
    ,convert_tz(pi.created_at, '+00:00', '+08:00') 揽收时间
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,case td.state
        when 0 then '待完成'
        when 1 then '已完成'
        when 2 then '已终止'
        when 3 then '已关闭'
    end 任务状态
from ph_staging.ticket_delivery td
left join ph_staging.parcel_info pi on pi.pno = td.pno
left join ph_staging.sys_store ss on ss.id = td.store_id
where
    td.created_at <= date_add(curdate(), interval 1 day )
    and td.delivery_opt = 4
    and td.state = 0
#     and pi.state = 3
    and td.store_id in ('PH77190100','PH73090800','PH73020100','PH77030100','PH77050A00','PH76120H00','PH74060200','PH76090C00','PH74010100','PH76040A00','PH73030300','PH76190100','PH74120A00','PH75060200','PH51050301','PH47170100','PH51050500','PH49040100','PH51030400','PH51020J00','PH47140200','PH49040102','PH47210100','PH51100100','PH47080301','PH51080100','PH49040101','PH47070A00','PH47200600','PH47120100','PH47150100','PH51080101','PH51120B01','PH45210101','PH45212600','PH50100100','PH46020100','PH45130F00','PH46050101','PH45200H00','PH44020100','PH44180100','PH46150100','PH45210100','PH45010100','PH44010T00','PH50100200','PH45140300','PH14010F00','PH14010F00','PH22130500','PH23100300');
;-- -. . -..- - / . -. - .-. -.--
select
    td.pno
    ,ss.name 网点
    ,convert_tz(pi.created_at, '+00:00', '+08:00') 揽收时间
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,case td.state
        when 0 then '待完成'
        when 1 then '已完成'
        when 2 then '已终止'
        when 3 then '已关闭'
    end 任务状态
from ph_staging.ticket_delivery td
left join ph_staging.parcel_info pi on pi.pno = td.pno
left join ph_staging.sys_store ss on ss.id = td.store_id
where
    td.created_at <= date_add(curdate(), interval 1 day )
    and td.delivery_opt = 4
#     and td.state = 0
#     and pi.state = 3
    and td.store_id in ('PH77190100','PH73090800','PH73020100','PH77030100','PH77050A00','PH76120H00','PH74060200','PH76090C00','PH74010100','PH76040A00','PH73030300','PH76190100','PH74120A00','PH75060200','PH51050301','PH47170100','PH51050500','PH49040100','PH51030400','PH51020J00','PH47140200','PH49040102','PH47210100','PH51100100','PH47080301','PH51080100','PH49040101','PH47070A00','PH47200600','PH47120100','PH47150100','PH51080101','PH51120B01','PH45210101','PH45212600','PH50100100','PH46020100','PH45130F00','PH46050101','PH45200H00','PH44020100','PH44180100','PH46150100','PH45210100','PH45010100','PH44010T00','PH50100200','PH45140300','PH14010F00','PH14010F00','PH22130500','PH23100300');
;-- -. . -..- - / . -. - .-. -.--
select
    td.pno
    ,ss.name 网点
    ,convert_tz(pi.created_at, '+00:00', '+08:00') 揽收时间
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end as 包裹状态
    ,case td.state
        when 0 then '待完成'
        when 1 then '已完成'
        when 2 then '已终止'
        when 3 then '已关闭'
    end 任务状态
from ph_staging.ticket_delivery td
left join ph_staging.parcel_info pi on pi.pno = td.pno
left join ph_staging.sys_store ss on ss.id = td.store_id
where
    td.created_at <= date_sub(date_add(curdate(), interval 1 day ), interval 8 hour )
    and td.delivery_opt = 4
#     and td.state = 0
    and pi.state = 3
    and td.store_id in ('PH77190100','PH73090800','PH73020100','PH77030100','PH77050A00','PH76120H00','PH74060200','PH76090C00','PH74010100','PH76040A00','PH73030300','PH76190100','PH74120A00','PH75060200','PH51050301','PH47170100','PH51050500','PH49040100','PH51030400','PH51020J00','PH47140200','PH49040102','PH47210100','PH51100100','PH47080301','PH51080100','PH49040101','PH47070A00','PH47200600','PH47120100','PH47150100','PH51080101','PH51120B01','PH45210101','PH45212600','PH50100100','PH46020100','PH45130F00','PH46050101','PH45200H00','PH44020100','PH44180100','PH46150100','PH45210100','PH45010100','PH44010T00','PH50100200','PH45140300','PH14010F00','PH14010F00','PH22130500','PH23100300');
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-01'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-01'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-09-01', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with d as
    (
        select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-09-01'
    )
    , t as
    (
        select
             ds.store_id
            ,ds.pno
            ,ds.stat_date
        from d ds
        left join
            (
                select
                    pr.pno
                    ,ds.stat_date
                    ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
                from ph_staging.parcel_route pr
                join d ds on pr.pno = ds.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                    and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and pr.marker_category in (42,43) ##岛屿,偏远地区
                group by 1,2
            ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
        left join
            (
                select
                   pr.pno
                    ,ds.stat_date
                   ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
                   ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
                from ph_staging.parcel_route pr
                join d ds on ds.pno = pr.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                    and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                    and pr.marker_category in (9,14,70) ##客户改约时间
            ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
        left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
        where
            case
                when pr1.pno is not null then 'N'
                when pr2.pno is not null then 'N'
                when ds1.pno is not null  then 'N'  else 'Y'
            end = 'Y'
    )
    select
        a.stat_date 日期
        ,a.store_id 网点ID
        ,dp.store_name 网点名称
        ,dp.opening_at 开业时间
        ,case
            when dp.region_name in ('Area3', 'Area6') then '彭万松'
            when dp.region_name in ('Area4', 'Area9') then '韩钥'
            when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
            when dp.region_name in ( 'Area8') then '黄勇'
            when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
        end 区域
        ,dp.region_name 大区
        ,dp.piece_name 片区
        ,a.应交接
        ,a.已交接
        ,concat(round(a.交接率*100,2),'%') as 交接率
        ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
        ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
        ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
        ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
        ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
    from
        (
            select
                t1.store_id
                ,t1.stat_date
                ,count(t1.pno) 应交接
                ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
            from t t1
            left join
                (
                    select
                        sc.*
                    from
                        (
                            select
                                pr.pno
                                ,pr.store_id
                                ,pr.store_name
                                ,t1.stat_date
                                ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                            from ph_staging.parcel_route pr
                            join t t1 on t1.pno = pr.pno
                            where
                                pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                               and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                              and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                        ) sc
                    where
                        sc.rk = 1
                ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
            group by 1,2
        ) a
    join
        (
            select
                sd.store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.store_id is not null
            group by 1

            union all

            select
                sd.separation_store_id store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.separation_store_id is not null
            group by 1
        ) sd on sd.store_id = a.store_id
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    where
        dp.store_category in (1,10);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-02'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-02'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-09-02', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with d as
    (
        select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-09-02'
    )
    , t as
    (
        select
             ds.store_id
            ,ds.pno
            ,ds.stat_date
        from d ds
        left join
            (
                select
                    pr.pno
                    ,ds.stat_date
                    ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
                from ph_staging.parcel_route pr
                join d ds on pr.pno = ds.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                    and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and pr.marker_category in (42,43) ##岛屿,偏远地区
                group by 1,2
            ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
        left join
            (
                select
                   pr.pno
                    ,ds.stat_date
                   ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
                   ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
                from ph_staging.parcel_route pr
                join d ds on ds.pno = pr.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                    and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                    and pr.marker_category in (9,14,70) ##客户改约时间
            ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
        left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
        where
            case
                when pr1.pno is not null then 'N'
                when pr2.pno is not null then 'N'
                when ds1.pno is not null  then 'N'  else 'Y'
            end = 'Y'
    )
    select
        a.stat_date 日期
        ,a.store_id 网点ID
        ,dp.store_name 网点名称
        ,dp.opening_at 开业时间
        ,case
            when dp.region_name in ('Area3', 'Area6') then '彭万松'
            when dp.region_name in ('Area4', 'Area9') then '韩钥'
            when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
            when dp.region_name in ( 'Area8') then '黄勇'
            when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
        end 区域
        ,dp.region_name 大区
        ,dp.piece_name 片区
        ,a.应交接
        ,a.已交接
        ,concat(round(a.交接率*100,2),'%') as 交接率
        ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
        ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
        ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
        ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
        ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
    from
        (
            select
                t1.store_id
                ,t1.stat_date
                ,count(t1.pno) 应交接
                ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
            from t t1
            left join
                (
                    select
                        sc.*
                    from
                        (
                            select
                                pr.pno
                                ,pr.store_id
                                ,pr.store_name
                                ,t1.stat_date
                                ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                            from ph_staging.parcel_route pr
                            join t t1 on t1.pno = pr.pno
                            where
                                pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                               and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                              and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                        ) sc
                    where
                        sc.rk = 1
                ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
            group by 1,2
        ) a
    join
        (
            select
                sd.store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.store_id is not null
            group by 1

            union all

            select
                sd.separation_store_id store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.separation_store_id is not null
            group by 1
        ) sd on sd.store_id = a.store_id
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    where
        dp.store_category in (1,10);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-02'
        and pr.routed_at >= date_sub('2023-09-02', interval 8 hour )
        and pr.routed_at < date_add('2023-09-02', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,if(a3.self_staff_num + other_staff_num > coalesce(sdb.code_num, 0),
           case
            when a2.avg_staff_code < 2 then 'A'
            when a2.avg_staff_code >= 2 and a2.avg_staff_code < 3 then 'B'
            when a2.avg_staff_code >= 3 and a2.avg_staff_code < 4 then 'C'
            when a2.avg_staff_code >= 4 then 'D'
        end,
           case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end ) 评级
#         ,a2.code_num
#         ,a2.staff_code_num
#         ,a2.staff_num
#         ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) avg_staff_code
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-09-02'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-09-02')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-09-02'
        and pi.finished_at >= date_sub('2023-09-02', interval 8 hour )
        and pi.finished_at < date_add('2023-09-02', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-09-02'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-03'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-03'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total = 10
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-09-03', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with d as
    (
        select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-09-03'
    )
    , t as
    (
        select
             ds.store_id
            ,ds.pno
            ,ds.stat_date
        from d ds
        left join
            (
                select
                    pr.pno
                    ,ds.stat_date
                    ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
                from ph_staging.parcel_route pr
                join d ds on pr.pno = ds.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                    and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and pr.marker_category in (42,43) ##岛屿,偏远地区
                group by 1,2
            ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
        left join
            (
                select
                   pr.pno
                    ,ds.stat_date
                   ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
                   ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
                from ph_staging.parcel_route pr
                join d ds on ds.pno = pr.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                    and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                    and pr.marker_category in (9,14,70) ##客户改约时间
            ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
        left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
        where
            case
                when pr1.pno is not null then 'N'
                when pr2.pno is not null then 'N'
                when ds1.pno is not null  then 'N'  else 'Y'
            end = 'Y'
    )
    select
        a.stat_date 日期
        ,a.store_id 网点ID
        ,dp.store_name 网点名称
        ,dp.opening_at 开业时间
        ,case
            when dp.region_name in ('Area3', 'Area6') then '彭万松'
            when dp.region_name in ('Area4', 'Area9') then '韩钥'
            when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
            when dp.region_name in ( 'Area8') then '黄勇'
            when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
        end 区域
        ,dp.region_name 大区
        ,dp.piece_name 片区
        ,a.应交接
        ,a.已交接
        ,concat(round(a.交接率*100,2),'%') as 交接率
        ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
        ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
        ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
        ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
        ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
    from
        (
            select
                t1.store_id
                ,t1.stat_date
                ,count(t1.pno) 应交接
                ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
            from t t1
            left join
                (
                    select
                        sc.*
                    from
                        (
                            select
                                pr.pno
                                ,pr.store_id
                                ,pr.store_name
                                ,t1.stat_date
                                ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                            from ph_staging.parcel_route pr
                            join t t1 on t1.pno = pr.pno
                            where
                                pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                               and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                              and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                        ) sc
                    where
                        sc.rk = 1
                ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
            group by 1,2
        ) a
    join
        (
            select
                sd.store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.store_id is not null
            group by 1

            union all

            select
                sd.separation_store_id store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.separation_store_id is not null
            group by 1
        ) sd on sd.store_id = a.store_id
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    where
        dp.store_category in (1,10);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-03'
        and pr.routed_at >= date_sub('2023-09-03', interval 8 hour )
        and pr.routed_at < date_add('2023-09-03', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,if(a3.self_staff_num + other_staff_num > coalesce(sdb.code_num, 0),
           case
            when a2.avg_staff_code < 2 then 'A'
            when a2.avg_staff_code >= 2 and a2.avg_staff_code < 3 then 'B'
            when a2.avg_staff_code >= 3 and a2.avg_staff_code < 4 then 'C'
            when a2.avg_staff_code >= 4 then 'D'
        end,
           case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end ) 评级
#         ,a2.code_num
#         ,a2.staff_code_num
#         ,a2.staff_num
#         ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) avg_staff_code
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-09-03'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-09-03')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-09-03'
        and pi.finished_at >= date_sub('2023-09-03', interval 8 hour )
        and pi.finished_at < date_add('2023-09-03', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-09-03'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
SELECT
	plt.`pno`  运单号
    ,plt.created_at 任务生成时间
    ,CONCAT('SSRD',plt.`id`) 任务ID
    ,case plt.`vip_enable`
    when 0 then '普通客户'
    when 1 then 'KAM客户'
    end as 客户类型
    ,plt.`client_id` 客户ID
    ,ss.`name` 始发地
    ,ss1.`name` 目的地
    ,if(plt.`fleet_routeids` is null,'一致','不一致') 解封车是否异常
    ,plt.`fleet_stores` 异常区间
    ,ft.`line_name`  异常车线
    ,plt.`parcel_created_at` 揽收时间
    ,case plt.`last_valid_action`
    when 'ARRIVAL_GOODS_VAN_CHECK_SCAN' then '车货关联到港'
 when 'ARRIVAL_WAREHOUSE_SCAN' then '到件入仓扫描'
 when 'CANCEL_ARRIVAL_WAREHOUSE_SCAN' then '取消到件入仓扫描'
 when 'CANCEL_PARCEL' then '撤销包裹'
 when 'CANCEL_SHIPMENT_WAREHOUSE' then '取消发件出仓'
 when 'CHANGE_PARCEL_CANCEL' then '修改包裹为撤销'
 when 'CHANGE_PARCEL_CLOSE' then '修改包裹为异常关闭'
 when 'CHANGE_PARCEL_IN_TRANSIT' then '修改包裹为运输中'
 when 'CHANGE_PARCEL_INFO' then '修改包裹信息'
 when 'CHANGE_PARCEL_SIGNED' then '修改包裹为签收'
 when 'CLAIMS_CLOSE' then '理赔关闭'
 when 'CLAIMS_COMPLETE' then '理赔完成'
 when 'CLAIMS_CONTACT' then '已联系客户'
 when 'CLAIMS_TRANSFER_CS' then '转交总部cs处理'
 when 'CLOSE_ORDER' then '关闭订单'
 when 'CONTINUE_TRANSPORT' then '疑难件继续配送'
 when 'CREATE_WORK_ORDER' then '创建工单'
 when 'CUSTOMER_CHANGE_PARCEL_INFO' then '客户修改包裹信息'
 when 'CUSTOMER_OPERATING_RETURN' then '客户操作退回寄件人'
 when 'DELIVERY_CONFIRM' then '确认妥投'
 when 'DELIVERY_MARKER' then '派件标记'
 when 'DELIVERY_PICKUP_STORE_SCAN' then '自提取件扫描'
 when 'DELIVERY_TICKET_CREATION_SCAN' then '交接扫描'
 when 'DELIVERY_TRANSFER' then '派件转单'
 when 'DEPARTURE_GOODS_VAN_CK_SCAN' then '车货关联出港'
 when 'DETAIN_WAREHOUSE' then '货件留仓'
 when 'DIFFICULTY_FINISH_INDEMNITY' then '疑难件支付赔偿'
 when 'DIFFICULTY_HANDOVER' then '疑难件交接'
 when 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE' then '疑难件交接货件留仓'
 when 'DIFFICULTY_RE_TRANSIT' then '疑难件退回区域总部/重启运送'
 when 'DIFFICULTY_RETURN' then '疑难件退回寄件人'
 when 'DIFFICULTY_SEAL' then '集包异常'
 when 'DISCARD_RETURN_BKK' then '丢弃包裹的，换单后寄回BKK'
 when 'DISTRIBUTION_INVENTORY' then '分拨盘库'
 when 'DWS_WEIGHT_IMAGE' then 'DWS复秤照片'
 when 'EXCHANGE_PARCEL' then '换货'
 when 'FAKE_CANCEL_HANDLE' then '虚假撤销判责'
 when 'FLASH_HOME_SCAN' then 'FH交接扫描'
 when 'FORCE_TAKE_PHOTO' then '强制拍照路由'
 when 'HAVE_HAIR_SCAN_NO_TO' then '有发无到'
 when 'HURRY_PARCEL' then '催单'
 when 'INCOMING_CALL' then '来电接听'
 when 'INTERRUPT_PARCEL_AND_RETURN' then '中断运输并退回'
 when 'INVENTORY' then '盘库'
 when 'LOSE_PARCEL_TEAM_OPERATION' then '丢失件团队处理'
 when 'MANUAL_REMARK' then '添加备注'
 when 'MISS_PICKUP_HANDLE' then '漏包裹揽收判责'
 when 'MISSING_PARCEL_SCAN' then '丢失件包裹操作'
 when 'NOTICE_LOST_PARTS_TEAM' then '已通知丢失件团队'
 when 'PARCEL_HEADLESS_CLAIMED' then '无头件包裹已认领'
 when 'PARCEL_HEADLESS_PRINTED' then '无头件包裹已打单'
 when 'PENDING_RETURN' then '待退件'
 when 'PHONE' then '电话联系'
 when 'PICK_UP_STORE' then '待自提取件'
 when 'PICKUP_RETURN_RECEIPT' then '签回单揽收'
 when 'PRINTING' then '打印面单'
 when 'QAQC_OPERATION' then 'QAQC判责'
 when 'RECEIVE_WAREHOUSE_SCAN' then '收件入仓'
 when 'RECEIVED' then '已揽收,初始化动作，实际情况并没有作用'
 when 'REFUND_CONFIRM' then '退件妥投'
 when 'REPAIRED' then '上报问题修复路由'
 when 'REPLACE_PNO' then '换单'
 when 'REPLY_WORK_ORDER' then '回复工单'
 when 'REVISION_TIME' then '改约时间'
 when 'SEAL' then '集包'
 when 'SEAL_NUMBER_CHANGE' then '集包件数变化'
 when 'SHIPMENT_WAREHOUSE_SCAN' then '发件出仓扫描'
 when 'SORTER_WEIGHT_IMAGE' then '分拣机复秤照片'
 when 'SORTING_SCAN' then '分拣扫描'
 when 'STAFF_INFO_UPDATE_WEIGHT' then '快递员修改重量'
 when 'STORE_KEEPER_UPDATE_WEIGHT' then '仓管员复秤'
 when 'STORE_SORTER_UPDATE_WEIGHT' then '分拣机复秤'
 when 'SYSTEM_AUTO_RETURN' then '系统自动退件'
 when 'TAKE_PHOTO' then '异常打单拍照'
 when 'THIRD_EXPRESS_ROUTE' then '第三方公司路由'
 when 'THIRD_PARTY_REASON_DETAIN' then '第三方原因滞留'
 when 'TICKET_WEIGHT_IMAGE' then '揽收称重照片'
 when 'TRANSFER_LOST_PARTS_TEAM' then '已转交丢失件团队'
 when 'TRANSFER_QAQC' then '转交QAQC处理'
 when 'UNSEAL' then '拆包'
 when 'UNSEAL_NO_PARCEL' then '上报包裹不在集包里'
 when 'UNSEAL_NOT_SCANNED' then '集包已拆包，本包裹未被扫描'
 when 'VEHICLE_ACCIDENT_REG' then '车辆车祸登记'
 when 'VEHICLE_ACCIDENT_REGISTRATION' then '车辆车祸登记'
 when 'VEHICLE_WET_DAMAGE_REG' then '车辆湿损登记'
 when 'VEHICLE_WET_DAMAGE_REGISTRATION' then '车辆湿损登记'
end as '最后有效路由'
 ,plt.`last_valid_staff_info_id` 最后操作人
 ,ss2.`name` 最后有效路由操作网点
 ,if(plt.`is_abnormal`=1,'是','否')  是否异常
 ,pr.`next_store_name`  下一站点
 ,wo.`order_no` 工单号
 ,case  plt.`source`
        WHEN 1 THEN 'A-问题件-丢失'
        WHEN 2 THEN 'B-记录本-丢失'
        WHEN 3 THEN 'C-包裹状态未更新'
        WHEN 4 THEN 'D-问题件-破损/短少'
        WHEN 5 THEN 'E-记录本-索赔-丢失'
        WHEN 6 THEN 'F-记录本-索赔-破损/短少'
        WHEN 7 THEN 'G-记录本-索赔-其他'
        WHEN 8 THEN 'H-包裹状态未更新-IPC计数'
        WHEN 9 THEN 'I-问题件-外包装破损险'
        WHEN 10 THEN 'J-问题记录本-外包装破损险'
		END AS '问题件来源渠道'
  ,case plt.`state`
  when 1 then '待处理'
  when 2 then '待处理'
  when 3 then '待处理'
  when 4 then '待处理'
  when 5 then '包裹未丢失'
  when 6 then '丢失件处理完成'
  end as '状态'
  ,plt.`operator_id` 处理人
  ,plt.`updated_at` 处理时间
FROM  `ph_bi`.`parcel_lose_task` plt
LEFT JOIN `ph_staging`.`parcel_info`  pi on pi.pno = plt.pno
LEFT JOIN `ph_bi`.`sys_store` ss on ss.id = pi.`ticket_pickup_store_id`
LEFT JOIN `ph_bi`.`sys_store` ss1 on ss1.id = pi.`dst_store_id`
LEFT JOIN `ph_bi`.`sys_store` ss2 on ss2.id = plt.`last_valid_store_id`
LEFT JOIN `ph_staging`.`parcel_route` pr on pr.`pno` = plt.`pno` and pr.`store_id` = plt.`last_valid_store_id`
LEFT JOIN `ph_bi`.`work_order` wo on wo.`loseparcel_task_id` = plt.`id`
LEFT JOIN ph_bi.`fleet_time` ft on ft.`proof_id` =LEFT (plt.`fleet_routeids`,11)
where 1=1 and plt.`state` in (1,2,3,4)
and  DATE_FORMAT(plt.created_at ,'%Y%m%d')=curdate();
;-- -. . -..- - / . -. - .-. -.--
SELECT DISTINCT
	plt.`pno`  运单号
    ,t.cod
    ,t.cogs
	,plt.created_at 任务生成时间
    ,CONCAT('SSRD',plt.`id`) 任务ID
	,case plt.`vip_enable`
    when 0 then '普通客户'
    when 1 then 'KAM客户'
    end as 客户类型
	,case plt.`duty_result`
	when 1 then '丢失'
	when 2 then '破损'
	end as '判责类型'
	,t.`t_value` 原因
	,plt.`client_id` 客户ID
	,if(plt.`fleet_routeids` is null,'一致','不一致') 解封车是否异常
    ,plt.`fleet_stores` 异常区间
    ,ft.`line_name`  异常车线
        ,plt.`parcel_created_at` 揽收时间
    ,case plt.`last_valid_action`
    when 'ARRIVAL_GOODS_VAN_CHECK_SCAN' then '车货关联到港'
 when 'ARRIVAL_WAREHOUSE_SCAN' then '到件入仓扫描'
 when 'CANCEL_ARRIVAL_WAREHOUSE_SCAN' then '取消到件入仓扫描'
 when 'CANCEL_PARCEL' then '撤销包裹'
 when 'CANCEL_SHIPMENT_WAREHOUSE' then '取消发件出仓'
 when 'CHANGE_PARCEL_CANCEL' then '修改包裹为撤销'
 when 'CHANGE_PARCEL_CLOSE' then '修改包裹为异常关闭'
 when 'CHANGE_PARCEL_IN_TRANSIT' then '修改包裹为运输中'
 when 'CHANGE_PARCEL_INFO' then '修改包裹信息'
 when 'CHANGE_PARCEL_SIGNED' then '修改包裹为签收'
 when 'CLAIMS_CLOSE' then '理赔关闭'
 when 'CLAIMS_COMPLETE' then '理赔完成'
 when 'CLAIMS_CONTACT' then '已联系客户'
 when 'CLAIMS_TRANSFER_CS' then '转交总部cs处理'
 when 'CLOSE_ORDER' then '关闭订单'
 when 'CONTINUE_TRANSPORT' then '疑难件继续配送'
 when 'CREATE_WORK_ORDER' then '创建工单'
 when 'CUSTOMER_CHANGE_PARCEL_INFO' then '客户修改包裹信息'
 when 'CUSTOMER_OPERATING_RETURN' then '客户操作退回寄件人'
 when 'DELIVERY_CONFIRM' then '确认妥投'
 when 'DELIVERY_MARKER' then '派件标记'
 when 'DELIVERY_PICKUP_STORE_SCAN' then '自提取件扫描'
 when 'DELIVERY_TICKET_CREATION_SCAN' then '交接扫描'
 when 'DELIVERY_TRANSFER' then '派件转单'
 when 'DEPARTURE_GOODS_VAN_CK_SCAN' then '车货关联出港'
 when 'DETAIN_WAREHOUSE' then '货件留仓'
 when 'DIFFICULTY_FINISH_INDEMNITY' then '疑难件支付赔偿'
 when 'DIFFICULTY_HANDOVER' then '疑难件交接'
 when 'DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE' then '疑难件交接货件留仓'
 when 'DIFFICULTY_RE_TRANSIT' then '疑难件退回区域总部/重启运送'
 when 'DIFFICULTY_RETURN' then '疑难件退回寄件人'
 when 'DIFFICULTY_SEAL' then '集包异常'
 when 'DISCARD_RETURN_BKK' then '丢弃包裹的，换单后寄回BKK'
 when 'DISTRIBUTION_INVENTORY' then '分拨盘库'
 when 'DWS_WEIGHT_IMAGE' then 'DWS复秤照片'
 when 'EXCHANGE_PARCEL' then '换货'
 when 'FAKE_CANCEL_HANDLE' then '虚假撤销判责'
 when 'FLASH_HOME_SCAN' then 'FH交接扫描'
 when 'FORCE_TAKE_PHOTO' then '强制拍照路由'
 when 'HAVE_HAIR_SCAN_NO_TO' then '有发无到'
 when 'HURRY_PARCEL' then '催单'
 when 'INCOMING_CALL' then '来电接听'
 when 'INTERRUPT_PARCEL_AND_RETURN' then '中断运输并退回'
 when 'INVENTORY' then '盘库'
 when 'LOSE_PARCEL_TEAM_OPERATION' then '丢失件团队处理'
 when 'MANUAL_REMARK' then '添加备注'
 when 'MISS_PICKUP_HANDLE' then '漏包裹揽收判责'
 when 'MISSING_PARCEL_SCAN' then '丢失件包裹操作'
 when 'NOTICE_LOST_PARTS_TEAM' then '已通知丢失件团队'
 when 'PARCEL_HEADLESS_CLAIMED' then '无头件包裹已认领'
 when 'PARCEL_HEADLESS_PRINTED' then '无头件包裹已打单'
 when 'PENDING_RETURN' then '待退件'
 when 'PHONE' then '电话联系'
 when 'PICK_UP_STORE' then '待自提取件'
 when 'PICKUP_RETURN_RECEIPT' then '签回单揽收'
 when 'PRINTING' then '打印面单'
 when 'QAQC_OPERATION' then 'QAQC判责'
 when 'RECEIVE_WAREHOUSE_SCAN' then '收件入仓'
 when 'RECEIVED' then '已揽收,初始化动作，实际情况并没有作用'
 when 'REFUND_CONFIRM' then '退件妥投'
 when 'REPAIRED' then '上报问题修复路由'
 when 'REPLACE_PNO' then '换单'
 when 'REPLY_WORK_ORDER' then '回复工单'
 when 'REVISION_TIME' then '改约时间'
 when 'SEAL' then '集包'
 when 'SEAL_NUMBER_CHANGE' then '集包件数变化'
 when 'SHIPMENT_WAREHOUSE_SCAN' then '发件出仓扫描'
 when 'SORTER_WEIGHT_IMAGE' then '分拣机复秤照片'
 when 'SORTING_SCAN' then '分拣扫描'
 when 'STAFF_INFO_UPDATE_WEIGHT' then '快递员修改重量'
 when 'STORE_KEEPER_UPDATE_WEIGHT' then '仓管员复秤'
 when 'STORE_SORTER_UPDATE_WEIGHT' then '分拣机复秤'
 when 'SYSTEM_AUTO_RETURN' then '系统自动退件'
 when 'TAKE_PHOTO' then '异常打单拍照'
 when 'THIRD_EXPRESS_ROUTE' then '第三方公司路由'
 when 'THIRD_PARTY_REASON_DETAIN' then '第三方原因滞留'
 when 'TICKET_WEIGHT_IMAGE' then '揽收称重照片'
 when 'TRANSFER_LOST_PARTS_TEAM' then '已转交丢失件团队'
 when 'TRANSFER_QAQC' then '转交QAQC处理'
 when 'UNSEAL' then '拆包'
 when 'UNSEAL_NO_PARCEL' then '上报包裹不在集包里'
 when 'UNSEAL_NOT_SCANNED' then '集包已拆包，本包裹未被扫描'
 when 'VEHICLE_ACCIDENT_REG' then '车辆车祸登记'
 when 'VEHICLE_ACCIDENT_REGISTRATION' then '车辆车祸登记'
 when 'VEHICLE_WET_DAMAGE_REG' then '车辆湿损登记'
 when 'VEHICLE_WET_DAMAGE_REGISTRATION' then '车辆湿损登记'
end as '最后有效路由'
 ,ss2.`name` 最后有效路由操作网点
 ,if(plt.`is_abnormal`=1,'是','否')  是否异常
 ,pr.`next_store_name`  下一站点
	,wo.`order_no` 工单号
	,case  plt.`source`
        WHEN 1 THEN 'A-问题件-丢失'
        WHEN 2 THEN 'B-记录本-丢失'
        WHEN 3 THEN 'C-包裹状态未更新'
        WHEN 4 THEN 'D-问题件-破损/短少'
        WHEN 5 THEN 'E-记录本-索赔-丢失'
        WHEN 6 THEN 'F-记录本-索赔-破损/短少'
        WHEN 7 THEN 'G-记录本-索赔-其他'
        WHEN 8 THEN 'H-包裹状态未更新-IPC计数'
        WHEN 9 THEN 'I-问题件-外包装破损险'
        WHEN 10 THEN 'J-问题记录本-外包装破损险'
		END AS '问题件来源渠道'
	,case plt.`state`
	when 5 then '无需追责'
	when 6 then '责任人已认定'
	end  状态
	,plt.`operator_id` 处理人
	,plt.`updated_at` 处理时间
	,case if(plt.state= 6,pld.`duty_type`,null)
	when 1 then	'快递员100%套餐'
	when 10	 then	'双黄套餐(计数网点仓管40%计数网点主管10%对接分拨仓管40%对接分拨主管10%)'
	when 19	 then	'双黄套餐(计数网点仓管40%计数网点主管10%对接分拨仓管40%对接分拨主管10%)'
	when 2	 then	'仓9主1套餐(仓管90%主管10%)'
	when 20	 then	'加盟商双黄套餐（加盟商50%网点仓管45%主管5%)'
	when 3	 then	'仓9主1套餐(仓管90%主管10%)'
	when 4	 then	'双黄套餐(A网点仓管40%主管10%B网点仓管40%主管10%)'
	when 5	 then	'快递员721套餐(快递员70%仓管20%主管10%)'
	when 6	 then	'仓管721套餐(仓管70%快递员20%主管10%)'
	when 7	 then	'其他(仅勾选“该运单的责任人需要特殊处理”时才能使用该项)'
	when 8	 then	'LH全责（LH100%)'
	when 9	 then	'加盟商套餐'
	end as '套餐'
	,group_concat(distinct ss3.name) 责任网点
FROM  `ph_bi`.`parcel_lose_task` plt
LEFT JOIN `ph_staging`.`parcel_info`  pi on pi.pno = plt.pno
LEFT JOIN `ph_bi`.`sys_store` ss on ss.id = pi.`ticket_pickup_store_id`
LEFT JOIN `ph_bi`.`sys_store` ss1 on ss1.id = pi.`dst_store_id`
LEFT JOIN `ph_bi`.`sys_store` ss2 on ss2.id = plt.`last_valid_store_id`
LEFT JOIN `ph_staging`.`parcel_route` pr on pr.`pno` = plt.`pno` and pr.`store_id` = plt.`last_valid_store_id`
LEFT JOIN `ph_bi`.`work_order` wo on wo.`loseparcel_task_id` = plt.`id`
LEFT JOIN `ph_bi`.`fleet_time` ft on ft.`proof_id` =LEFT (plt.`fleet_routeids`,11)
LEFT JOIN `ph_bi`.`parcel_lose_stat_detail` pld on pld. `lose_task_id`=plt.`id`
LEFT JOIN `ph_bi`.`parcel_lose_responsible` plr on plr.`lose_task_id`=plt.`id`
LEFT JOIN `ph_bi`.`sys_store` ss3 on ss3.id = plr.store_id
LEFT JOIN `ph_bi`.`translations` t ON plt.duty_reasons = t.t_key AND t.`lang` = 'zh-CN'
join tmpale.tmp_ph_pno_lj_0904 t on t.pno = plt.pno
where
    1=1
    and plt.`state` in (5,6)
group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    pr.pno
    ,pi.cod_amount/100 cod
from ph_staging.parcel_route pr
left join ph_staging.parcel_info pi on pi.pno = pr.pno
where
    pr.staff_info_id = '145208'
    and pr.routed_at > '2023-08-31 16:00:00'
    and pr.routed_at < '2023-09-01 16:00:00';
;-- -. . -..- - / . -. - .-. -.--
select
    pr.pno
    ,pi.cod_amount/100 cod
from ph_staging.parcel_route pr
left join ph_staging.parcel_info pi on pi.pno = pr.pno
where
    pr.staff_info_id = '145208'
    and pr.routed_at > '2023-08-31 16:00:00'
    and pr.routed_at < '2023-09-01 16:00:00'
    and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
group by 1,2;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-04'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 10
                    or (t1.total =  5 and t1.leave_time_type = 2)

                union all

                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 5
                    and t1.leave_time_type = 1 -- 上午请假
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-04'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 10
                                    or (t1.total =  5 and t1.leave_time_type = 2)

                                union all

                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 5
                                    and t1.leave_time_type = 1 -- 上午请假
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-09-04', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with d as
    (
        select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-09-04'
    )
    , t as
    (
        select
             ds.store_id
            ,ds.pno
            ,ds.stat_date
        from d ds
        left join
            (
                select
                    pr.pno
                    ,ds.stat_date
                    ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
                from ph_staging.parcel_route pr
                join d ds on pr.pno = ds.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                    and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and pr.marker_category in (42,43) ##岛屿,偏远地区
                group by 1,2
            ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
        left join
            (
                select
                   pr.pno
                    ,ds.stat_date
                   ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
                   ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
                from ph_staging.parcel_route pr
                join d ds on ds.pno = pr.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                    and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                    and pr.marker_category in (9,14,70) ##客户改约时间
            ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
        left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
        where
            case
                when pr1.pno is not null then 'N'
                when pr2.pno is not null then 'N'
                when ds1.pno is not null  then 'N'  else 'Y'
            end = 'Y'
    )
    select
        a.stat_date 日期
        ,a.store_id 网点ID
        ,dp.store_name 网点名称
        ,dp.opening_at 开业时间
        ,case
            when dp.region_name in ('Area3', 'Area6') then '彭万松'
            when dp.region_name in ('Area4', 'Area9') then '韩钥'
            when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
            when dp.region_name in ( 'Area8') then '黄勇'
            when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
        end 区域
        ,dp.region_name 大区
        ,dp.piece_name 片区
        ,a.应交接
        ,a.已交接
        ,concat(round(a.交接率*100,2),'%') as 交接率
        ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
        ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
        ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
        ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
        ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
    from
        (
            select
                t1.store_id
                ,t1.stat_date
                ,count(t1.pno) 应交接
                ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
            from t t1
            left join
                (
                    select
                        sc.*
                    from
                        (
                            select
                                pr.pno
                                ,pr.store_id
                                ,pr.store_name
                                ,t1.stat_date
                                ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                            from ph_staging.parcel_route pr
                            join t t1 on t1.pno = pr.pno
                            where
                                pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                               and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                              and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                        ) sc
                    where
                        sc.rk = 1
                ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
            group by 1,2
        ) a
    join
        (
            select
                sd.store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.store_id is not null
            group by 1

            union all

            select
                sd.separation_store_id store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.separation_store_id is not null
            group by 1
        ) sd on sd.store_id = a.store_id
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    where
        dp.store_category in (1,10);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-04'
        and pr.routed_at >= date_sub('2023-09-04', interval 8 hour )
        and pr.routed_at < date_add('2023-09-04', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,if(a3.self_staff_num + other_staff_num > coalesce(sdb.code_num, 0),
           case
            when a2.avg_staff_code < 2 then 'A'
            when a2.avg_staff_code >= 2 and a2.avg_staff_code < 3 then 'B'
            when a2.avg_staff_code >= 3 and a2.avg_staff_code < 4 then 'C'
            when a2.avg_staff_code >= 4 then 'D'
        end,
           case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end ) 评级
#         ,a2.code_num
#         ,a2.staff_code_num
#         ,a2.staff_num
#         ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) avg_staff_code
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-09-04'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-09-04')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-09-04'
        and pi.finished_at >= date_sub('2023-09-04', interval 8 hour )
        and pi.finished_at < date_add('2023-09-04', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-09-04'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
select
    *
from
    (
                select
            pr.pno
            ,ps.third_sorting_code
            ,row_number() over (partition by pr.pno order by ps.created_at desc ) rk
        from ph_staging.parcel_route pr
        join ph_drds.parcel_sorting_code_info ps on ps.pno = pr.pno
        where
            pr.staff_info_id = '159022'
            and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    ) a
where
    a.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
select
    *
from
    (
                select
            pr.pno
            ,ps.third_sorting_code
            ,row_number() over (partition by pr.pno order by ps.created_at desc ) rk
        from ph_staging.parcel_route pr
        join ph_drds.parcel_sorting_code_info ps on ps.pno = pr.pno
        where
            pr.staff_info_id = '159022'
            and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
            and pr.routed_at >= '2023-09-03 16:00:00'
            and pr.routed_at < '2023-09-04 16:00:00'
    ) a
where
    a.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
select
    *
from  tmpale.tmp_th_tgt_pop;
;-- -. . -..- - / . -. - .-. -.--
select
    pi2.pno 正向单号
    ,ss.name 正向揽收网点
    ,pi2.src_detail_address 正向寄件人地址
    ,pi2.client_id 客户ID
    ,pi2.src_name 寄件人姓名
    ,pi.dst_detail_address 退件包裹目的地地址
    ,ss2.name 退件目的地网点
from ph_staging.parcel_info pi
left join ph_staging.parcel_info pi2 on pi2.returned_pno = pi.pno
left join ph_staging.sys_store ss on ss.id = pi2.ticket_pickup_store_id
left join ph_staging.sys_store ss2 on ss2.id = pi.dst_store_id
where
    pi.returned = 1
    and pi.created_at >= date_sub(date_sub(curdate(), interval 7 day), interval 8 hour) -- 近一周退件
    and ss.category = 14
    and ss2.category != 14;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-05'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 10
                    or (t1.total =  5 and t1.leave_time_type = 2)

                union all

                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 5
                    and t1.leave_time_type = 1 -- 上午请假
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-05'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 10
                                    or (t1.total =  5 and t1.leave_time_type = 2)

                                union all

                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 5
                                    and t1.leave_time_type = 1 -- 上午请假
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-09-05', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-09-05';
;-- -. . -..- - / . -. - .-. -.--
with d as
    (
        select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-09-05'
    )
    , t as
    (
        select
             ds.store_id
            ,ds.pno
            ,ds.stat_date
        from d ds
        left join
            (
                select
                    pr.pno
                    ,ds.stat_date
                    ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
                from ph_staging.parcel_route pr
                join d ds on pr.pno = ds.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                    and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and pr.marker_category in (42,43) ##岛屿,偏远地区
                group by 1,2
            ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
        left join
            (
                select
                   pr.pno
                    ,ds.stat_date
                   ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
                   ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
                from ph_staging.parcel_route pr
                join d ds on ds.pno = pr.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                    and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                    and pr.marker_category in (9,14,70) ##客户改约时间
            ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
        left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
        where
            case
                when pr1.pno is not null then 'N'
                when pr2.pno is not null then 'N'
                when ds1.pno is not null  then 'N'  else 'Y'
            end = 'Y'
    )
    select
        a.stat_date 日期
        ,a.store_id 网点ID
        ,dp.store_name 网点名称
        ,dp.opening_at 开业时间
        ,case
            when dp.region_name in ('Area3', 'Area6') then '彭万松'
            when dp.region_name in ('Area4', 'Area9') then '韩钥'
            when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
            when dp.region_name in ( 'Area8') then '黄勇'
            when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
        end 区域
        ,dp.region_name 大区
        ,dp.piece_name 片区
        ,a.应交接
        ,a.已交接
        ,concat(round(a.交接率*100,2),'%') as 交接率
        ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
        ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
        ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
        ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
        ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
    from
        (
            select
                t1.store_id
                ,t1.stat_date
                ,count(t1.pno) 应交接
                ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
            from t t1
            left join
                (
                    select
                        sc.*
                    from
                        (
                            select
                                pr.pno
                                ,pr.store_id
                                ,pr.store_name
                                ,t1.stat_date
                                ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                            from ph_staging.parcel_route pr
                            join t t1 on t1.pno = pr.pno
                            where
                                pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                               and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                              and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                        ) sc
                    where
                        sc.rk = 1
                ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
            group by 1,2
        ) a
    join
        (
            select
                sd.store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.store_id is not null
            group by 1

            union all

            select
                sd.separation_store_id store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.separation_store_id is not null
            group by 1
        ) sd on sd.store_id = a.store_id
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    where
        dp.store_category in (1,10);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-05'
        and pr.routed_at >= date_sub('2023-09-05', interval 8 hour )
        and pr.routed_at < date_add('2023-09-05', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,if(a3.self_staff_num + other_staff_num > coalesce(sdb.code_num, 0),
           case
            when a2.avg_staff_code < 2 then 'A'
            when a2.avg_staff_code >= 2 and a2.avg_staff_code < 3 then 'B'
            when a2.avg_staff_code >= 3 and a2.avg_staff_code < 4 then 'C'
            when a2.avg_staff_code >= 4 then 'D'
        end,
           case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end ) 评级
#         ,a2.code_num
#         ,a2.staff_code_num
#         ,a2.staff_num
#         ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) avg_staff_code
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-09-05'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-09-05')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-09-05'
        and pi.finished_at >= date_sub('2023-09-05', interval 8 hour )
        and pi.finished_at < date_add('2023-09-05', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-09-05'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
select
    case
        when bc.`client_id` is not null then bc.client_name
        when kp.id is not null and bc.id is null then '普通ka'
        when kp.`id` is null then '小c'
    end as 客户类型
    ,plt.updated_at 判责时间
    ,plt.pno
    ,case plt.source
        WHEN 1 THEN 'A-问题件-丢失'
        WHEN 2 THEN 'B-记录本-丢失'
        WHEN 3 THEN 'C-包裹状态未更新'
        WHEN 4 THEN 'D-问题件-破损/短少'
        WHEN 5 THEN 'E-记录本-索赔-丢失'
        WHEN 6 THEN 'F-记录本-索赔-破损/短少'
        WHEN 7 THEN 'G-记录本-索赔-其他'
        WHEN 8 THEN 'H-包裹状态未更新-IPC计数'
        WHEN 9 THEN 'I-问题件-外包装破损险'
        WHEN 10 THEN 'J-问题记录本-外包装破损险'
        when 11 then 'K-超时效包裹'
        when 12 then 'L-高度疑似丢失'
    end 问题来源渠道
    ,ss.name 责任网点
from ph_bi.parcel_lose_task plt
left join ph_bi.parcel_lose_responsible plr on plr.lose_task_id = plt.id
left join ph_staging.ka_profile kp on kp.id = plt.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = plt.client_id
left join ph_staging.sys_store ss on ss.id = plr.store_id
where
    plt.state = 6
    and plt.updated_at >= '2023-06-01'
    and plt.updated_at < '2023-09-01'
    and ss.category = 6
group by 1,2,3,4;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-06'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 10
                    or (t1.total =  5 and t1.leave_time_type = 2)

                union all

                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 5
                    and t1.leave_time_type = 1 -- 上午请假
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-06'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 10
                                    or (t1.total =  5 and t1.leave_time_type = 2)

                                union all

                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 5
                                    and t1.leave_time_type = 1 -- 上午请假
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-09-06', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with d as
    (
        select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-09-06'
    )
    , t as
    (
        select
             ds.store_id
            ,ds.pno
            ,ds.stat_date
        from d ds
        left join
            (
                select
                    pr.pno
                    ,ds.stat_date
                    ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
                from ph_staging.parcel_route pr
                join d ds on pr.pno = ds.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                    and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and pr.marker_category in (42,43) ##岛屿,偏远地区
                group by 1,2
            ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
        left join
            (
                select
                   pr.pno
                    ,ds.stat_date
                   ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
                   ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
                from ph_staging.parcel_route pr
                join d ds on ds.pno = pr.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                    and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                    and pr.marker_category in (9,14,70) ##客户改约时间
            ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
        left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
        where
            case
                when pr1.pno is not null then 'N'
                when pr2.pno is not null then 'N'
                when ds1.pno is not null  then 'N'  else 'Y'
            end = 'Y'
    )
    select
        a.stat_date 日期
        ,a.store_id 网点ID
        ,dp.store_name 网点名称
        ,dp.opening_at 开业时间
        ,case
            when dp.region_name in ('Area3', 'Area6') then '彭万松'
            when dp.region_name in ('Area4', 'Area9') then '韩钥'
            when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
            when dp.region_name in ( 'Area8') then '黄勇'
            when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
        end 区域
        ,dp.region_name 大区
        ,dp.piece_name 片区
        ,a.应交接
        ,a.已交接
        ,concat(round(a.交接率*100,2),'%') as 交接率
        ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
        ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
        ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
        ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
        ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
    from
        (
            select
                t1.store_id
                ,t1.stat_date
                ,count(t1.pno) 应交接
                ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
            from t t1
            left join
                (
                    select
                        sc.*
                    from
                        (
                            select
                                pr.pno
                                ,pr.store_id
                                ,pr.store_name
                                ,t1.stat_date
                                ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                            from ph_staging.parcel_route pr
                            join t t1 on t1.pno = pr.pno
                            where
                                pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                               and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                              and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                        ) sc
                    where
                        sc.rk = 1
                ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
            group by 1,2
        ) a
    join
        (
            select
                sd.store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.store_id is not null
            group by 1

            union all

            select
                sd.separation_store_id store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.separation_store_id is not null
            group by 1
        ) sd on sd.store_id = a.store_id
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    where
        dp.store_category in (1,10);
;-- -. . -..- - / . -. - .-. -.--


    ,ifnull(tt.1pai_hour_8_fished_counts/tt.1pai_counts,0) 一派8点前扫描占比
    ,ifnull(tt.1pai_hour_8ban_fished_counts/tt.1pai_counts,0) 一派8点半前扫描占比
    ,ifnull(tt.1pai_hour_9_fished_counts/tt.1pai_counts,0) 一派9点前扫描占比
    ,ifnull(tt.1pai_hour_9ban_fished_counts/tt.1pai_counts,0) 一派9点半前扫描占比
	,if(tt2.late_proof_counts is null , '否', '是') 是否有迟到超过规划时间20分钟的常规车
    ,tt2.max_real_arrive_time_normal 一派常规车最晚实际到达时间
#     ,tt2.max_real_arrive_proof_id 一派常规车最晚实际到达车线
#     ,tt2.max_real_arrive_vol 一派常规车最晚实际到达车线包裹量
    ,tt2.line_1_latest_plan_arrive_time 一派常规车最晚规划到达时间
    ,tt2.max_real_arrive_time_innormal 一派加班车最晚实际到达时间
#     ,tt2.max_real_arrive_innormal_proof_id  一派加班车最晚实际到达车线
#     ,tt2.max_real_arrive_innormal_vol  一派加班车最晚实际到达包裹量
    ,tt2.max_actual_plan_arrive_time_innormal 一派加班车最晚规划到达时间


from
(
    select
       base.store_id
       ,base.store_name
       ,base.store_type
       ,base.piece_name
       ,base.region_name
       ,count(distinct base.pno) shoud_counts
       ,count(distinct case when base.min_fenjian_scan_time is not null then base.pno else null end ) scan_fished_counts
       ,count(distinct case when base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then base.pno else null end ) youxiao_counts

       ,count(distinct case when base.type='一派' then  base.pno else null end ) 1pai_counts
       ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null then  base.pno else null end ) 1pai_scan_fished_counts
       ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then  base.pno else null end ) 1pai_youxiao_counts

       ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:00:00' then base.pno else null end) 1pai_hour_8_fished_counts
       ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:30:00' then base.pno else null end) 1pai_hour_8ban_fished_counts
       ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:00:00' then base.pno else null end) 1pai_hour_9_fished_counts
       ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:30:00' then base.pno else null end) 1pai_hour_9ban_fished_counts

    from
    (
       select
       t.*,
       case when t.should_delevry_type='1派应派包裹' then '一派' else null end 'type'
       from dwm.dwd_ph_dc_should_be_delivery_sort_scan t
       join ph_staging.sys_store ss
       on t.store_id =ss.id
    ) base
    group by base.store_id,base.store_name,base.store_type,base.piece_name,base.region_name
) tt

left join
(
    select
       bl.store_id
       ,bl.max_real_arrive_time_normal
       ,bl.max_real_arrive_proof_id
       ,bl.max_real_arrive_vol
       ,bl.line_1_latest_plan_arrive_time
       ,bl.max_actual_plan_arrive_time_innormal
       ,bl.max_actual_plan_arrive_innormal_proof_id
       ,bl.max_actual_plan_arrive_innormal_vol
       ,bl.max_real_arrive_time_innormal
       ,bl.max_real_arrive_innormal_proof_id
       ,bl.max_real_arrive_innormal_vol
	   ,late_proof_counts
    from dwm.fleet_real_detail_today bl
    group by 1,2,3,4,5,6,7,8,9,10,11
) tt2 on tt.store_id=tt2.store_id;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-06'
        and pr.routed_at >= date_sub('2023-09-06', interval 8 hour )
        and pr.routed_at < date_add('2023-09-06', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,if(a3.self_staff_num + other_staff_num > coalesce(sdb.code_num, 0),
           case
            when a2.avg_staff_code < 2 then 'A'
            when a2.avg_staff_code >= 2 and a2.avg_staff_code < 3 then 'B'
            when a2.avg_staff_code >= 3 and a2.avg_staff_code < 4 then 'C'
            when a2.avg_staff_code >= 4 then 'D'
        end,
           case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end ) 评级
#         ,a2.code_num
#         ,a2.staff_code_num
#         ,a2.staff_num
#         ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) avg_staff_code
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-09-06'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-09-06')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-09-06'
        and pi.finished_at >= date_sub('2023-09-06', interval 8 hour )
        and pi.finished_at < date_add('2023-09-06', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-09-06'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        pi.pno
        ,case
            when bc.`client_id` is not null then bc.client_name
            when kp.id is not null and bc.client_id is null then '普通ka'
            when kp.`id` is null then '小c'
        end as client_type
        ,ss.name pick_store
        ,ss.id storeid
    from ph_staging.parcel_info pi
    left join ph_staging.sys_store ss on ss.id = pi.ticket_pickup_store_id
    left join ph_staging.ka_profile kp on kp.id = pi.client_id
    left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
    where
        pi.created_at >= '2023-05-31 16:00:00'
        and pi.created_at < '2023-08-31 16:00:00'
        and ss.category = 6 -- FH
        and pi.state < 9
),
res as
    (
        select
            t1.*
            ,min(pr.routed_at) min_route_at
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno and pr.route_action = 'RECEIVE_WAREHOUSE_SCAN' and pr.store_id = t1.storeid
        where
            pr.routed_at > '2023-05-31 16:00:00'
        group by t1.pno
    )

select
    t1.pno 包裹
    ,t1.client_type 客户类型
    ,t1.pick_store 揽收网点
    ,convert_tz(t2.min_route_at, '+00:00', '+08:00')  收件入仓时间
    ,a.route_action 收件入仓后第一个有效路由
    ,convert_tz(a.routed_at, '+00:00', '+08:00')  收件入仓后第一个有效路由时间
    ,case
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 < 24 then 0
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 >= 24 and timestampdiff(minute , t2.min_route_at, a.routed_at)/60 < 48 then 1
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 >= 48 and timestampdiff(minute , t2.min_route_at, a.routed_at)/60 < 72 then 2
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 > 72 then 3
     end 收件入仓与后续第一个路由时间差
from t t1
left join res t2 on t2.pno = t1.pno
left join
    (
        select
            t2.*
            ,pr.route_action
            ,pr.routed_at
            ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        from ph_staging.parcel_route pr
        join res t2 on t2.pno = pr.pno
        join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action
        where
            pr.routed_at > t2.min_route_at
            and pr.routed_at > '2023-05-31 16:00:00'
    ) a on a.pno = t1.pno and a.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        pi.pno
        ,case
            when bc.`client_id` is not null then bc.client_name
            when kp.id is not null and bc.client_id is null then '普通ka'
            when kp.`id` is null then '小c'
        end as client_type
        ,ss.name pick_store
        ,ss.id storeid
    from ph_staging.parcel_info pi
    left join ph_staging.sys_store ss on ss.id = pi.ticket_pickup_store_id
    left join ph_staging.ka_profile kp on kp.id = pi.client_id
    left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
    where
        pi.created_at >= '2023-05-31 16:00:00'
        and pi.created_at < '2023-08-31 16:00:00'
        and ss.category = 6 -- FH
        and pi.state < 9
),
res as
    (
        select
            t1.*
            ,min(pr.routed_at) min_route_at
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno and pr.route_action = 'RECEIVE_WAREHOUSE_SCAN' and pr.store_id = t1.storeid
        where
            pr.routed_at > '2023-05-31 16:00:00'
        group by 1,2,3,4
    )

select
    t1.pno 包裹
    ,t1.client_type 客户类型
    ,t1.pick_store 揽收网点
    ,convert_tz(t2.min_route_at, '+00:00', '+08:00')  收件入仓时间
    ,a.route_action 收件入仓后第一个有效路由
    ,convert_tz(a.routed_at, '+00:00', '+08:00')  收件入仓后第一个有效路由时间
    ,case
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 < 24 then 0
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 >= 24 and timestampdiff(minute , t2.min_route_at, a.routed_at)/60 < 48 then 1
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 >= 48 and timestampdiff(minute , t2.min_route_at, a.routed_at)/60 < 72 then 2
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 > 72 then 3
     end 收件入仓与后续第一个路由时间差
from t t1
left join res t2 on t2.pno = t1.pno
left join
    (
        select
            t2.*
            ,pr.route_action
            ,pr.routed_at
            ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        from ph_staging.parcel_route pr
        join res t2 on t2.pno = pr.pno
        join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action
        where
            pr.routed_at > t2.min_route_at
            and pr.routed_at > '2023-05-31 16:00:00'
    ) a on a.pno = t1.pno and a.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        pi.pno
        ,case
            when bc.`client_id` is not null then bc.client_name
            when kp.id is not null and bc.client_id is null then '普通ka'
            when kp.`id` is null then '小c'
        end as client_type
        ,ss.name pick_store
        ,ss.id storeid
    from ph_staging.parcel_info pi
    left join ph_staging.sys_store ss on ss.id = pi.ticket_pickup_store_id
    left join ph_staging.ka_profile kp on kp.id = pi.client_id
    left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
    where
        pi.created_at >= '2023-05-31 16:00:00'
        and pi.created_at < '2023-08-31 16:00:00'
        and ss.category = 6 -- FH
        and pi.state < 9
),
res as
    (
        select
            t1.*
            ,min(pr.routed_at) min_route_at
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno and pr.route_action = 'RECEIVE_WAREHOUSE_SCAN' and pr.store_id = t1.storeid
        where
            pr.routed_at > '2023-05-31 16:00:00'
        group by 1,2,3,4
    )

select
    t1.pno 包裹
    ,t1.client_type 客户类型
    ,t1.pick_store 揽收网点
    ,convert_tz(t2.min_route_at, '+00:00', '+08:00')  收件入仓时间
    ,a.route_action 收件入仓后第一个有效路由
    ,a.store_name 收件入仓后第一个有效路由网点
    ,convert_tz(a.routed_at, '+00:00', '+08:00')  收件入仓后第一个有效路由时间
    ,case
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 < 24 then 0
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 >= 24 and timestampdiff(minute , t2.min_route_at, a.routed_at)/60 < 48 then 1
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 >= 48 and timestampdiff(minute , t2.min_route_at, a.routed_at)/60 < 72 then 2
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 > 72 then 3
     end 收件入仓与后续第一个路由时间差
from t t1
left join res t2 on t2.pno = t1.pno
left join
    (
        select
            t2.*
            ,pr.route_action
            ,pr.store_id pr_store_id
            ,pr.store_name
            ,pr.routed_at
            ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        from ph_staging.parcel_route pr
        join res t2 on t2.pno = pr.pno
        join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action
        where
            pr.routed_at > t2.min_route_at
            and pr.routed_at > '2023-05-31 16:00:00'
            and pr.store_id != t2.storeid
    ) a on a.pno = t1.pno and a.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
select
    count(pi.pno)
from ph_staging.parcel_info pi
left join ph_staging.sys_store ss on ss.id = pi.ticket_pickup_store_id
where
    pi.created_at >= '2023-07-31 16:00:00'
    and pi.created_at < '2023-08-31 16:00:00'
    and ss.category = 6 -- FH
    and pi.state < 9;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        pi.pno
        ,case
            when bc.`client_id` is not null then bc.client_name
            when kp.id is not null and bc.client_id is null then '普通ka'
            when kp.`id` is null then '小c'
        end as client_type
        ,ss.name pick_store
        ,ss.id storeid
    from ph_staging.parcel_info pi
    left join ph_staging.sys_store ss on ss.id = pi.ticket_pickup_store_id
    left join ph_staging.ka_profile kp on kp.id = pi.client_id
    left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
    where
        pi.created_at >= '2023-07-31 16:00:00'
        and pi.created_at < '2023-08-31 16:00:00'
        and ss.category = 6 -- FH
        and pi.state < 9
),
res as
    (
        select
            t1.*
            ,min(pr.routed_at) min_route_at
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno and pr.route_action = 'RECEIVE_WAREHOUSE_SCAN' and pr.store_id = t1.storeid
        where
            pr.routed_at > '2023-07-31 16:00:00'
        group by 1,2,3,4
    )

select
    t1.pno 包裹
    ,t1.client_type 客户类型
    ,t1.pick_store 揽收网点
    ,convert_tz(t2.min_route_at, '+00:00', '+08:00')  收件入仓时间
    ,a.route_action 收件入仓后第一个有效路由
    ,a.store_name 收件入仓后第一个有效路由网点
    ,convert_tz(a.routed_at, '+00:00', '+08:00')  收件入仓后第一个有效路由时间
    ,case
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 < 24 then 0
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 >= 24 and timestampdiff(minute , t2.min_route_at, a.routed_at)/60 < 48 then 1
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 >= 48 and timestampdiff(minute , t2.min_route_at, a.routed_at)/60 < 72 then 2
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 > 72 then 3
     end 收件入仓与后续第一个路由时间差
from t t1
left join res t2 on t2.pno = t1.pno
left join
    (
        select
            t2.*
            ,pr.route_action
            ,pr.store_id pr_store_id
            ,pr.store_name
            ,pr.routed_at
            ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        from ph_staging.parcel_route pr
        join res t2 on t2.pno = pr.pno
        join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action
        where
            pr.routed_at > t2.min_route_at
            and pr.routed_at > '2023-07-31 16:00:00'
            and pr.store_id != t2.storeid
    ) a on a.pno = t1.pno and a.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
select
    case
        when bc.`client_id` is not null then bc.client_name
        when kp.id is not null and bc.client_id is null then '普通ka'
        when kp.`id` is null then '小c'
    end as 客户类型
    ,plt.updated_at 判责时间
    ,plt.pno
    ,case plt.source
        WHEN 1 THEN 'A-问题件-丢失'
        WHEN 2 THEN 'B-记录本-丢失'
        WHEN 3 THEN 'C-包裹状态未更新'
        WHEN 4 THEN 'D-问题件-破损/短少'
        WHEN 5 THEN 'E-记录本-索赔-丢失'
        WHEN 6 THEN 'F-记录本-索赔-破损/短少'
        WHEN 7 THEN 'G-记录本-索赔-其他'
        WHEN 8 THEN 'H-包裹状态未更新-IPC计数'
        WHEN 9 THEN 'I-问题件-外包装破损险'
        WHEN 10 THEN 'J-问题记录本-外包装破损险'
        when 11 then 'K-超时效包裹'
        when 12 then 'L-高度疑似丢失'
    end 问题来源渠道
    ,ss.name 责任网点
from ph_bi.parcel_lose_task plt
left join ph_bi.parcel_lose_responsible plr on plr.lose_task_id = plt.id
left join ph_staging.ka_profile kp on kp.id = plt.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = plt.client_id
left join ph_staging.sys_store ss on ss.id = plr.store_id
where
    plt.state = 6
    and plt.updated_at >= '2023-06-01'
    and plt.updated_at < '2023-09-01'
    and ss.category = 6
group by 1,2,3,4;
;-- -. . -..- - / . -. - .-. -.--
select
    a.*
    ,case
        when timestampdiff(minute , a.created_at, a.第一次回复时间)/60 < 24 then 0
        when timestampdiff(minute , a.created_at, a.第一次回复时间)/60 >= 24 and timestampdiff(minute , a.created_at, a.第一次回复时间)/60 < 48 then 1
        when timestampdiff(minute , a.created_at, a.第一次回复时间)/60 >= 48 and timestampdiff(minute , a.created_at, a.第一次回复时间)/60 < 72 then 2
        when timestampdiff(minute , a.created_at, a.第一次回复时间)/60 > 72 then 3
    end  回复时间
    ,case
        when timestampdiff(minute , a.created_at, a.工单关闭时间)/60 < 24 then 0
        when timestampdiff(minute , a.created_at, a.工单关闭时间)/60 >= 24 and timestampdiff(minute , a.created_at, a.工单关闭时间)/60 < 48 then 1
        when timestampdiff(minute , a.created_at, a.工单关闭时间)/60 >= 48 and timestampdiff(minute , a.created_at, a.工单关闭时间)/60 < 72 then 2
        when timestampdiff(minute , a.created_at, a.工单关闭时间)/60 > 72 then 3
    end  关闭时间
from
    (
        select
            wo.order_no 工单编号
            ,fp.id 加盟商ID
            ,wo.created_at
            ,case wo.order_type
                when 1 then '查找运单'
                when 2 then '加快处理'
                when 3 then '调查员工'
                when 4 then '其他'
                when 5 then '网点信息维护提醒'
                when 6 then '培训指导'
                when 7 then '异常业务询问'
                when 8 then '包裹丢失'
                when 9 then '包裹破损'
                when 10 then '货物短少'
                when 11 then '催单'
                when 12 then '有发无到'
                when 13 then '上报包裹不在集包里'
                when 16 then '漏揽收'
                when 50 then '虚假撤销'
                when 17 then '已签收未收到'
                when 18 then '客户投诉'
                when 19 then '修改包裹信息'
                when 20 then '修改 COD 金额'
                when 21 then '解锁包裹'
                when 22 then '申请索赔'
                when 23 then 'MS 问题反馈'
                when 24 then 'FBI 问题反馈'
                when 25 then 'KA System 问题反馈'
                when 26 then 'App 问题反馈'
                when 27 then 'KIT 问题反馈'
                when 28 then 'Backyard 问题反馈'
                when 29 then 'BS/FH 问题反馈'
                when 30 then '系统建议'
                when 31 then '申诉罚款'
                else wo.order_type
            end  工单类型
            ,pi.client_id
            ,coalesce(ss2.name, sd.name) 发起部门
            ,wo.closed_at 工单关闭时间
            ,min(wor.created_at) 第一次回复时间
        from ph_bi.work_order wo
        left join ph_staging.sys_store ss on ss.id = wo.store_id
        left join ph_staging.franchisee_profile fp on fp.id= ss.franchisee_id -- 加盟商ID
        left join ph_staging.parcel_info pi on pi.pno = wo.pnos
        left join ph_staging.sys_store ss2 on ss2.id = wo.created_store_id
        left join ph_staging.sys_department sd on sd.id = wo.created_store_id
        left join ph_bi.work_order_reply wor on wo.id = wor.order_id
        where
            ss.category = 6
            and wo.created_at >= '2023-06-01'
            and wo.created_at < '2023-09-01'
        group by 1
    ) a;
;-- -. . -..- - / . -. - .-. -.--
select
        t.*
    from tmpale.tmp_ph_courier_0907 t;
;-- -. . -..- - / . -. - .-. -.--
with a as
(
    select
        t.*
    from tmpale.tmp_ph_courier_0907 t
    where
        t.courier is not null
)
, mw as
(
    select
        mw.staff_info_id
        ,mw.id
        ,mw.created_at
        ,row_number() over (partition by mw.staff_info_id order by mw.created_at) rk
        ,count(id) over (partition by mw.staff_info_id) warn_num
    from ph_backyard.message_warning mw
    join
        (
            select
                a1.courier report_id
            from a a1
            group by 1
        )a1 on a1.report_id = mw.staff_info_id
    where
        mw.is_delete = 0
)
select
    hsi.staff_info_id 工号
    ,a1.id 举报记录ID
    ,a1.submitter_id 举报人工号
    ,a1.submitter_name 举报人姓名
    ,a1.submitter_job 举报人职位
    ,hsi.name 被举报人姓名
    ,date(hsi.hire_date) 入职日期
    ,hjt.job_name 岗位
    ,a1.event_date 违规日期
    ,a1.reason 举报原因
    ,a1.remark 事情描述
    ,a1.picture 图片
    ,hsi.mobile 手机号

    ,sc.num 员工当日交接量
    ,del.num 员工当日妥投量
    ,pick.num 员工当日揽件量
    ,mw1.warn_num 历史警告信次数
    ,mw1.created_at 第一次警告信时间
    ,mw2.created_at 第二次警告信时间
    ,mw3.created_at 第三次警告信时间

    ,ss2.name 网点
    ,smp.name 片区
    ,smr.name 大区
    ,case
        when smr.name in ('Area3', 'Area6') then '彭万松'
        when smr.name in ('Area4', 'Area9') then '韩钥'
        when smr.name in ('Area7', 'Area8','Area10', 'Area11','FHome') then '张可新'
        when smr.name in ('Area1', 'Area2','Area5', 'Area12') then '李俊'
    end 负责人
    ,emp_cnt.staf_num 现有快递员数
    ,shl_del.sh_del_num 网点当日应派件量
    ,shl_del.delivery_rate 当日妥投率
    ,att.atd_emp_cnt 网点当日出勤人数_快递员
    ,fin.fin_pno 网点当日妥投量
    ,last30.warn_num 过去30天警告信数量
    ,last30.warn_staff_num 过去30天警告信人数
    ,last7.warn_num 过去7天警告信数量
    ,last7.warn_staff_num 过去7天警告信人数
    ,coalesce(concat(round(last_month.当月离职人数*100/last_month.当月总人数 ,2), '%') ,0) 上月离职率
from ph_bi.hr_staff_info hsi
join a a1 on a1.courier = hsi.staff_info_id
left join ph_staging.sys_store ss2 on ss2.id = hsi.sys_store_id
left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
left join ph_bi.hr_job_title hjt on hjt.id = hsi.job_title
left join mw mw1 on mw1.staff_info_id = a1.courier and mw1.rk = 1
left join mw mw2 on mw2.staff_info_id = a1.courier and mw2.rk = 2
left join mw mw3 on mw3.staff_info_id = a1.courier and mw3.rk = 3
left join
    (
        select
            pr.staff_info_id
            ,a1.event_date
            ,count(distinct pr.pno) num
        from ph_staging.parcel_route pr
        join a a1 on a1.courier = pr.staff_info_id
        where
            pr.routed_at >= date_sub(a1.event_date, interval 8 hour)
            and pr.routed_at < date_add(a1.event_date, interval 16 hour)
            and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
        group by 1
    ) sc on sc.staff_info_id = a1.courier and sc.event_date = a1.event_date
left join
    (
        select
            pr.staff_info_id
            ,a1.event_date
            ,count(distinct pr.pno) num
        from ph_staging.parcel_route pr
        join a a1 on a1.courier = pr.staff_info_id
        where
            pr.routed_at >= date_sub(a1.event_date, interval 8 hour)
            and pr.routed_at < date_add(a1.event_date, interval 16 hour)
            and pr.route_action = 'DELIVERY_CONFIRM'
        group by 1
    ) del on del.staff_info_id = a1.courier and del.event_date = a1.event_date
left join
    (
        select
            pr.staff_info_id
            ,a1.event_date
            ,count(distinct pr.pno) num
        from ph_staging.parcel_route pr
        join a a1 on a1.courier = pr.staff_info_id
        where
            pr.routed_at >= date_sub(a1.event_date, interval 8 hour)
            and pr.routed_at < date_add(a1.event_date, interval 16 hour)
            and pr.route_action = 'RECEIVED'
        group by 1
    ) pick on pick.staff_info_id = a1.courier and pick.event_date = a1.event_date
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        join a a1 on a1.sys_store_id = hr.sys_store_id
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a1.sys_store_id
left join
    (
        select
            a1.sys_store_id
            ,a1.event_date
            ,count(distinct dc.pno) sh_del_num
            ,count(distinct if(pi2.state = 5, dc.pno, null)) sh_del_del_num
            ,concat(round(count(distinct if(pi2.state = 5, dc.pno, null))*100/count(distinct dc.pno) ,2) ,'%') delivery_rate
        from ph_bi.dc_should_delivery_today  dc
        join
            (
                select
                    a1.sys_store_id
                    ,a1.event_date
                from a a1
                group by 1
            )  a1 on a1.event_date = dc.stat_date and a1.sys_store_id = dc.store_id
        left join ph_staging.parcel_info pi2 on pi2.pno = dc.pno
        group by 1,2
    ) shl_del on shl_del.event_date = a1.event_date and shl_del.sys_store_id = a1.sys_store_id
left join
    (
        select
           ad.sys_store_id
           ,a1.event_date
           ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
       from ph_bi.attendance_data_v2 ad
       left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
       join
            (
                select
                    a1.sys_store_id
                    ,a1.event_date
                from a a1
                group by 1
            ) a1 on a1.sys_store_id = ad.sys_store_id and a1.event_date = ad.stat_date
       where
           (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
            and hr.job_title in (13,110,1000)
       group by 1,2
    ) att on att.sys_store_id = a1.sys_store_id and att.event_date = a1.event_date
left join
    (
        select
            a1.sys_store_id
            ,a1.event_date
            ,count(distinct pi.pno) fin_pno
        from ph_staging.parcel_info pi
        join
            (
                select
                    a1.sys_store_id
                    ,a1.event_date
                from a a1
                group by 1
            ) a1 on a1.sys_store_id = pi.ticket_delivery_store_id
        where
            pi.state = 5
            and pi.finished_at >= date_sub(a1.event_date, interval 8 hour)
            and pi.finished_at < date_add(a1.event_date, interval 16 hour)
        group by 1,2
    ) fin on fin.sys_store_id = a1.sys_store_id and fin.event_date = a1.event_date
left join
    (
        select
            hsi2.sys_store_id
            ,count(distinct mw.id) warn_num
            ,count(distinct mw.staff_info_id) warn_staff_num
        from ph_backyard.message_warning mw
        left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = mw.staff_info_id
        join
            (
                select
                    a1.sys_store_id
                from a a1
                group by 1
            ) a on hsi2.sys_store_id = a.sys_store_id
        where
            mw.created_at >= date_sub(curdate(), interval 30 day)
        group by 1
    ) last30 on last30.sys_store_id = a1.sys_store_id
left join
    (
        select
            hsi2.sys_store_id
            ,count(distinct mw.id) warn_num
            ,count(distinct mw.staff_info_id) warn_staff_num
        from ph_backyard.message_warning mw
        left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = mw.staff_info_id
        join
            (
                select
                    a1.sys_store_id
                from a a1
                group by 1
            ) a on hsi2.sys_store_id = a.sys_store_id
        where
            mw.created_at >= date_sub(curdate(), interval 7 day)
        group by 1
    ) last7 on last7.sys_store_id = a1.sys_store_id
left join
    (
        select
            hsi.sys_store_id
            ,ss.name
            ,count(distinct if(hsi.state in (1,3) ,hsi.staff_info_id ,null)) + count(distinct if(hsi.state = 2 and left(hsi.leave_date ,7) = date_format(date_sub(curdate(), interval 1 month),'%Y-%m') ,hsi.staff_info_id ,null)) '当月总人数'
            ,count(distinct if(hsi.state = 2 and left(hsi.leave_date ,7) = date_format(date_sub(curdate(), interval 1 month),'%Y-%m') ,hsi.staff_info_id ,null)) '当月离职人数'
        from ph_bi.hr_staff_info hsi
        left join ph_staging.sys_store ss  on ss.id =hsi.sys_store_id
        where
            hsi.formal = 1
            and hsi.is_sub_staff = 0
            and hsi.job_title in (13,110,1000,37)
            and ss.category in (1,10,13,14)
            and hsi.hire_date < date_format(now(), '%y-%m-01')
        group by 1
    ) last_month on last_month.sys_store_id = a1.sys_store_id;
;-- -. . -..- - / . -. - .-. -.--
with a as
(
    select
        t.*
    from tmpale.tmp_ph_courier_0907 t
    where
        t.courier is not null
)
, mw as
(
    select
        mw.staff_info_id
        ,mw.id
        ,mw.created_at
        ,row_number() over (partition by mw.staff_info_id order by mw.created_at) rk
        ,count(id) over (partition by mw.staff_info_id) warn_num
    from ph_backyard.message_warning mw
    join
        (
            select
                a1.courier report_id
            from a a1
            group by 1
        )a1 on a1.report_id = mw.staff_info_id
    where
        mw.is_delete = 0
)
select
    hsi.staff_info_id 工号

    ,hsi.name 被举报人姓名
    ,date(hsi.hire_date) 入职日期
    ,hjt.job_name 岗位
    ,a1.event_date 违规日期


    ,hsi.mobile 手机号

    ,sc.num 员工当日交接量
    ,del.num 员工当日妥投量
    ,pick.num 员工当日揽件量
    ,mw1.warn_num 历史警告信次数
    ,mw1.created_at 第一次警告信时间
    ,mw2.created_at 第二次警告信时间
    ,mw3.created_at 第三次警告信时间

    ,ss2.name 网点
    ,smp.name 片区
    ,smr.name 大区
    ,case
        when smr.name in ('Area3', 'Area6') then '彭万松'
        when smr.name in ('Area4', 'Area9') then '韩钥'
        when smr.name in ('Area7', 'Area8','Area10', 'Area11','FHome') then '张可新'
        when smr.name in ('Area1', 'Area2','Area5', 'Area12') then '李俊'
    end 负责人
    ,emp_cnt.staf_num 现有快递员数
    ,shl_del.sh_del_num 网点当日应派件量
    ,shl_del.delivery_rate 当日妥投率
    ,att.atd_emp_cnt 网点当日出勤人数_快递员
    ,fin.fin_pno 网点当日妥投量
    ,last30.warn_num 过去30天警告信数量
    ,last30.warn_staff_num 过去30天警告信人数
    ,last7.warn_num 过去7天警告信数量
    ,last7.warn_staff_num 过去7天警告信人数
    ,coalesce(concat(round(last_month.当月离职人数*100/last_month.当月总人数 ,2), '%') ,0) 上月离职率
from ph_bi.hr_staff_info hsi
join a a1 on a1.courier = hsi.staff_info_id
left join ph_staging.sys_store ss2 on ss2.id = hsi.sys_store_id
left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
left join ph_bi.hr_job_title hjt on hjt.id = hsi.job_title
left join mw mw1 on mw1.staff_info_id = a1.courier and mw1.rk = 1
left join mw mw2 on mw2.staff_info_id = a1.courier and mw2.rk = 2
left join mw mw3 on mw3.staff_info_id = a1.courier and mw3.rk = 3
left join
    (
        select
            pr.staff_info_id
            ,a1.event_date
            ,count(distinct pr.pno) num
        from ph_staging.parcel_route pr
        join a a1 on a1.courier = pr.staff_info_id
        where
            pr.routed_at >= date_sub(a1.event_date, interval 8 hour)
            and pr.routed_at < date_add(a1.event_date, interval 16 hour)
            and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
        group by 1
    ) sc on sc.staff_info_id = a1.courier and sc.event_date = a1.event_date
left join
    (
        select
            pr.staff_info_id
            ,a1.event_date
            ,count(distinct pr.pno) num
        from ph_staging.parcel_route pr
        join a a1 on a1.courier = pr.staff_info_id
        where
            pr.routed_at >= date_sub(a1.event_date, interval 8 hour)
            and pr.routed_at < date_add(a1.event_date, interval 16 hour)
            and pr.route_action = 'DELIVERY_CONFIRM'
        group by 1
    ) del on del.staff_info_id = a1.courier and del.event_date = a1.event_date
left join
    (
        select
            pr.staff_info_id
            ,a1.event_date
            ,count(distinct pr.pno) num
        from ph_staging.parcel_route pr
        join a a1 on a1.courier = pr.staff_info_id
        where
            pr.routed_at >= date_sub(a1.event_date, interval 8 hour)
            and pr.routed_at < date_add(a1.event_date, interval 16 hour)
            and pr.route_action = 'RECEIVED'
        group by 1
    ) pick on pick.staff_info_id = a1.courier and pick.event_date = a1.event_date
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        join a a1 on a1.sys_store_id = hr.sys_store_id
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a1.sys_store_id
left join
    (
        select
            a1.sys_store_id
            ,a1.event_date
            ,count(distinct dc.pno) sh_del_num
            ,count(distinct if(pi2.state = 5, dc.pno, null)) sh_del_del_num
            ,concat(round(count(distinct if(pi2.state = 5, dc.pno, null))*100/count(distinct dc.pno) ,2) ,'%') delivery_rate
        from ph_bi.dc_should_delivery_today  dc
        join
            (
                select
                    a1.sys_store_id
                    ,a1.event_date
                from a a1
                group by 1
            )  a1 on a1.event_date = dc.stat_date and a1.sys_store_id = dc.store_id
        left join ph_staging.parcel_info pi2 on pi2.pno = dc.pno
        group by 1,2
    ) shl_del on shl_del.event_date = a1.event_date and shl_del.sys_store_id = a1.sys_store_id
left join
    (
        select
           ad.sys_store_id
           ,a1.event_date
           ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
       from ph_bi.attendance_data_v2 ad
       left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
       join
            (
                select
                    a1.sys_store_id
                    ,a1.event_date
                from a a1
                group by 1
            ) a1 on a1.sys_store_id = ad.sys_store_id and a1.event_date = ad.stat_date
       where
           (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
            and hr.job_title in (13,110,1000)
       group by 1,2
    ) att on att.sys_store_id = a1.sys_store_id and att.event_date = a1.event_date
left join
    (
        select
            a1.sys_store_id
            ,a1.event_date
            ,count(distinct pi.pno) fin_pno
        from ph_staging.parcel_info pi
        join
            (
                select
                    a1.sys_store_id
                    ,a1.event_date
                from a a1
                group by 1
            ) a1 on a1.sys_store_id = pi.ticket_delivery_store_id
        where
            pi.state = 5
            and pi.finished_at >= date_sub(a1.event_date, interval 8 hour)
            and pi.finished_at < date_add(a1.event_date, interval 16 hour)
        group by 1,2
    ) fin on fin.sys_store_id = a1.sys_store_id and fin.event_date = a1.event_date
left join
    (
        select
            hsi2.sys_store_id
            ,count(distinct mw.id) warn_num
            ,count(distinct mw.staff_info_id) warn_staff_num
        from ph_backyard.message_warning mw
        left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = mw.staff_info_id
        join
            (
                select
                    a1.sys_store_id
                from a a1
                group by 1
            ) a on hsi2.sys_store_id = a.sys_store_id
        where
            mw.created_at >= date_sub(curdate(), interval 30 day)
        group by 1
    ) last30 on last30.sys_store_id = a1.sys_store_id
left join
    (
        select
            hsi2.sys_store_id
            ,count(distinct mw.id) warn_num
            ,count(distinct mw.staff_info_id) warn_staff_num
        from ph_backyard.message_warning mw
        left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = mw.staff_info_id
        join
            (
                select
                    a1.sys_store_id
                from a a1
                group by 1
            ) a on hsi2.sys_store_id = a.sys_store_id
        where
            mw.created_at >= date_sub(curdate(), interval 7 day)
        group by 1
    ) last7 on last7.sys_store_id = a1.sys_store_id
left join
    (
        select
            hsi.sys_store_id
            ,ss.name
            ,count(distinct if(hsi.state in (1,3) ,hsi.staff_info_id ,null)) + count(distinct if(hsi.state = 2 and left(hsi.leave_date ,7) = date_format(date_sub(curdate(), interval 1 month),'%Y-%m') ,hsi.staff_info_id ,null)) '当月总人数'
            ,count(distinct if(hsi.state = 2 and left(hsi.leave_date ,7) = date_format(date_sub(curdate(), interval 1 month),'%Y-%m') ,hsi.staff_info_id ,null)) '当月离职人数'
        from ph_bi.hr_staff_info hsi
        left join ph_staging.sys_store ss  on ss.id =hsi.sys_store_id
        where
            hsi.formal = 1
            and hsi.is_sub_staff = 0
            and hsi.job_title in (13,110,1000,37)
            and ss.category in (1,10,13,14)
            and hsi.hire_date < date_format(now(), '%y-%m-01')
        group by 1
    ) last_month on last_month.sys_store_id = a1.sys_store_id;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-07'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 10
                    or (t1.total =  5 and t1.leave_time_type = 2)

                union all

                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 5
                    and t1.leave_time_type = 1 -- 上午请假
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-07'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 10
                                    or (t1.total =  5 and t1.leave_time_type = 2)

                                union all

                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 5
                                    and t1.leave_time_type = 1 -- 上午请假
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-09-07', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with d as
    (
        select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-09-07'
    )
    , t as
    (
        select
             ds.store_id
            ,ds.pno
            ,ds.stat_date
        from d ds
        left join
            (
                select
                    pr.pno
                    ,ds.stat_date
                    ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
                from ph_staging.parcel_route pr
                join d ds on pr.pno = ds.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                    and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and pr.marker_category in (42,43) ##岛屿,偏远地区
                group by 1,2
            ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
        left join
            (
                select
                   pr.pno
                    ,ds.stat_date
                   ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
                   ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
                from ph_staging.parcel_route pr
                join d ds on ds.pno = pr.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                    and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                    and pr.marker_category in (9,14,70) ##客户改约时间
            ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
        left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
        where
            case
                when pr1.pno is not null then 'N'
                when pr2.pno is not null then 'N'
                when ds1.pno is not null  then 'N'  else 'Y'
            end = 'Y'
    )
    select
        a.stat_date 日期
        ,a.store_id 网点ID
        ,dp.store_name 网点名称
        ,dp.opening_at 开业时间
        ,case
            when dp.region_name in ('Area3', 'Area6') then '彭万松'
            when dp.region_name in ('Area4', 'Area9') then '韩钥'
            when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
            when dp.region_name in ( 'Area8') then '黄勇'
            when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
        end 区域
        ,dp.region_name 大区
        ,dp.piece_name 片区
        ,a.应交接
        ,a.已交接
        ,concat(round(a.交接率*100,2),'%') as 交接率
        ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
        ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
        ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
        ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
        ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
    from
        (
            select
                t1.store_id
                ,t1.stat_date
                ,count(t1.pno) 应交接
                ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
            from t t1
            left join
                (
                    select
                        sc.*
                    from
                        (
                            select
                                pr.pno
                                ,pr.store_id
                                ,pr.store_name
                                ,t1.stat_date
                                ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                            from ph_staging.parcel_route pr
                            join t t1 on t1.pno = pr.pno
                            where
                                pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                               and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                              and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                        ) sc
                    where
                        sc.rk = 1
                ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
            group by 1,2
        ) a
    join
        (
            select
                sd.store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.store_id is not null
            group by 1

            union all

            select
                sd.separation_store_id store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.separation_store_id is not null
            group by 1
        ) sd on sd.store_id = a.store_id
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    where
        dp.store_category in (1,10);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-07'
        and pr.routed_at >= date_sub('2023-09-07', interval 8 hour )
        and pr.routed_at < date_add('2023-09-07', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,if(a3.self_staff_num + other_staff_num > coalesce(sdb.code_num, 0),
           case
            when a2.avg_staff_code < 2 then 'A'
            when a2.avg_staff_code >= 2 and a2.avg_staff_code < 3 then 'B'
            when a2.avg_staff_code >= 3 and a2.avg_staff_code < 4 then 'C'
            when a2.avg_staff_code >= 4 then 'D'
        end,
           case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end ) 评级
#         ,a2.code_num
#         ,a2.staff_code_num
#         ,a2.staff_num
#         ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) avg_staff_code
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-09-07'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-09-07')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-09-07'
        and pi.finished_at >= date_sub('2023-09-07', interval 8 hour )
        and pi.finished_at < date_add('2023-09-07', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-09-07'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
from ph_staging.parcel_info pi
where
    pi.ticket_delivery_staff_info_id = '119309'
    and pi.created_at >= '2023-08-30 16:00:00'
    and  pi.created_at >= '2023-08-31 16:00:00';
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
from ph_staging.parcel_info pi
where
    pi.ticket_delivery_staff_info_id = '119309'
    and pi.finished_at >= '2023-08-30 16:00:00'
    and  pi.finished_at >= '2023-08-31 16:00:00';
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
from ph_staging.parcel_info pi
where
    pi.ticket_delivery_staff_info_id = '119309'
    and pi.finished_at >= '2023-08-30 16:00:00'
    and  pi.finished_at >= '2023-08-31 16:00:00'
    and pi.state = 5;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
from ph_staging.parcel_info pi
where
    pi.ticket_delivery_staff_info_id = '119309'
    and pi.finished_at >= '2023-08-30 16:00:00'
    and  pi.finished_at < '2023-08-31 16:00:00'
    and pi.state = 5;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
    ,pi.returned
from ph_staging.parcel_info pi
where
    pi.ticket_delivery_staff_info_id = '119309'
    and pi.finished_at >= '2023-08-30 16:00:00'
    and  pi.finished_at < '2023-08-31 16:00:00'
    and pi.state = 5;
;-- -. . -..- - / . -. - .-. -.--
select
    pi.pno
    ,pi.returned
from ph_staging.parcel_info pi
where
    pi.ticket_delivery_staff_info_id = '136472'
    and pi.finished_at >= '2023-08-30 16:00:00'
    and  pi.finished_at < '2023-08-31 16:00:00'
    and pi.state = 5;
;-- -. . -..- - / . -. - .-. -.--
with staff_id as (
##快递员当日出勤情况
select
    v2.stat_date              ##日期
    ,v2.staff_info_id         ##工号
    ,mr.name manage_region              #归属大区
    ,mp.name manage_piece               ##归属片区
    ,v2.sys_store_id          ##归属网点id
    ,ss.name                  ##归属网点名称
    ,ss.category              ##网点类型
    ,v2.attendance_started_at ##上班打卡时间
    ,v2.attendance_end_at     ##下班打卡时间
    ,v2.shift_start           ##班次开始时间
    ,v2.shift_end             ##班次结束时间
    ##,case when v2.attendance_time + v2.BT + v2.BT_Y + v2.AB = 10 then '应出勤' else '无需出勤' end as plan##培训假删掉
    ,case when (v2.attendance_time + v2.BT + v2.BT_Y + v2.AB) > 0 then '应出勤' else '无需出勤' end as plan##培训假删掉
    ,v2.shift_id
    ,case when v2.AB = 10 then '缺勤一天'
        when v2.AB = 5 then '缺勤半天'
        when v2.AB = 0 then '全勤'
    else v2.AB end as is_AB
    ,case when (v2.attendance_time + v2.BT + v2.BT_Y + v2.AB) <= 0 then '排休无需打卡'
        when  (v2.attendance_time + v2.BT + v2.BT_Y + v2.AB) > 0 and v2.attendance_started_at is null then '无上班打卡时间'
        when timestampdiff(SECOND,CONCAT(v2.stat_date," ",v2.shift_start),v2.attendance_started_at) <= 59 then '未迟到'
        when timestampdiff(SECOND,CONCAT(v2.stat_date," ",v2.shift_start),v2.attendance_started_at) <= 359 then '迟到5min内'
        #when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 659 then '迟到5-10min'
        #when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 959 then '迟到10-15min'
        #when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 1259 then '迟到15-20min'
        #when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 1559 then '迟到20-25min'
        when timestampdiff(SECOND,CONCAT(v2.stat_date," ",v2.shift_start),v2.attendance_started_at) <= 1859 then '迟到5-30min'
    else '迟到30min以上' end as chidao_ty
from ph_bi.attendance_data_v2 v2##研发刘春华，黄华
left join ph_staging.sys_store ss on ss.id = v2.sys_store_id ##网点编码
left join ph_staging.sys_manage_piece mp on mp.id = ss.manage_piece ##管理片区
left join ph_staging.sys_manage_region mr on mr.id = ss.manage_region ##管理大区
where date(v2.stat_date) = date_sub(curdate(),interval 1 day)
group by v2.stat_date
    ,v2.staff_info_id
    ,mr.name                  ##作业大区
    ,mp.name                  ##作业片区
    ,v2.sys_store_id          ##作业网点id
    ,ss.name                  ##作业网点名称
    ,v2.attendance_started_at ##上班打卡时间
    ,v2.attendance_end_at     ##下班打卡时间
    ,v2.shift_start           ##班次开始时间
    ,v2.shift_end             ##班次结束时间
    ,v2.shift_id
    ,case when v2.AB = 10 then '缺勤一天'
        when v2.AB = 5 then '缺勤半天'
        when v2.AB = 0 then '全勤'
    else v2.AB end
    ,case when (v2.attendance_time + v2.BT + v2.BT_Y + v2.AB) <= 0 then '排休无需打卡'
        when  (v2.attendance_time + v2.BT + v2.BT_Y + v2.AB) > 0 and v2.attendance_started_at is null then '无上班打卡时间'
        when timestampdiff(SECOND,CONCAT(v2.stat_date," ",v2.shift_start),v2.attendance_started_at) <= 59 then '未迟到'
        when timestampdiff(SECOND,CONCAT(v2.stat_date," ",v2.shift_start),v2.attendance_started_at) <= 359 then '迟到5min内'
        #when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 659 then '迟到5-10min'
        #when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 959 then '迟到10-15min'
        #when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 1259 then '迟到15-20min'
        #when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 1559 then '迟到20-25min'
        when timestampdiff(SECOND,CONCAT(v2.stat_date," ",v2.shift_start),v2.attendance_started_at) <= 1859 then '迟到5-30min'
    else '迟到30min以上' end
)


,staff_absence as (
#近14天排班的一个情况
select t1.staff_info_id
    ,count(distinct if(t1.attendance_type in ('迟到30min以上'), t1.stat_date,null)) as late_30min
    ,count(distinct if(t1.is_AB in ('缺勤一天','缺勤半天'), t1.stat_date,null)) as absence
from (
select
    v2.stat_date              ##日期
    ,v2.staff_info_id         ##工号
    ,mr.name manage_region              #归属大区
    ,mp.name manage_piece               ##归属片区
    ,v2.sys_store_id          ##归属网点id
    ,ss.name                  ##归属网点名称
    ,ss.category              ##网点类型
    ,v2.attendance_started_at ##上班打卡时间
    ,v2.attendance_end_at     ##下班打卡时间
    ,v2.shift_start           ##班次开始时间
    ,v2.shift_end             ##班次结束时间
    ,case when v2.attendance_started_at is null then '无上班打卡时间'
        when timestampdiff(SECOND,CONCAT(v2.stat_date," ",v2.shift_start),v2.attendance_started_at) <= 1859 then '迟到30min以内'
    else '迟到30min以上' end as attendance_type#迟到情况
    ,case when v2.AB = 10 then '缺勤一天'
        when v2.AB = 5 then '缺勤半天'
        when v2.AB = 0 then '全勤'
    else v2.AB end as is_AB
    ,ROW_NUMBER() OVER (PARTITION by v2.staff_info_id order by v2.stat_date desc) as rn
from ph_bi.attendance_data_v2 v2##研发刘春华，黄华
left join ph_staging.sys_store ss on ss.id = v2.sys_store_id ##网点编码
left join ph_staging.sys_manage_piece mp on mp.id = ss.manage_piece ##管理片区
left join ph_staging.sys_manage_region mr on mr.id = ss.manage_region ##管理大区
where date(v2.stat_date) >= date_sub(curdate(),interval 30 day)
    and date(v2.stat_date) <= date_sub(curdate(),interval 1 day)
    ##and v2.attendance_time + v2.BT + v2.BT_Y + v2.AB = 10 ##排班应出勤
    and (v2.attendance_time + v2.BT + v2.BT_Y + v2.AB) > 0
    and v2.job_title in (13,110,1000)
    and v2.state in (1)
    ##and hi.staff_info_id in ('118890','363229')
group by 1,2,3,4,5,6,7,8,9,10,11,12,13
)t1
where t1.rn <= 14
group by 1
)

,ticket_delivery_min5 as (
##前五件的时间
select n1.staff_info_id
    ,max(case when n1.rn = 1 then n1.created_time else null end) as time_one
    ,max(case when n1.rn = 2 then n1.created_time else null end) as time_two
    ,max(case when n1.rn = 3 then n1.created_time else null end) as time_three
    ,max(case when n1.rn = 4 then n1.created_time else null end) as time_four
    ,max(case when n1.rn = 5 then n1.created_time else null end) as time_five
from
(
    select n.staff_info_id
        ,n.created_time
        ,ROW_NUMBER() OVER (PARTITION by n.staff_info_id order by n.created_time asc) as rn
    from (
    select td.staff_info_id,convert_tz(td.created_at,'+00:00','+08:00') as created_time
    from ph_staging.ticket_delivery td
    WHERE 1=1
        and td.created_at >= date_sub(date_sub(curdate(), interval 1 day), interval 8 hour )
        and td.created_at < date_sub(curdate(), interval 8 hour)##正常的时间剪掉8h
        AND td.state <> 3 # stata=3(已关闭)
    GROUP BY 1,2
    )n
    group by 1,2
)n1
group by n1.staff_info_id
)


,delivery_percentage as (
##90%的包裹在两个小时之内交接完
##最早交接时间+2h时间内交接包裹量占总交接量的比例
#员工、交接时间、最早交接时间+2h，pno
#date_format(date_add(ft.arrive_time_first,interval 150 minute),'%H:%i')
select t2.staff_info_id
    ,t2.delivery_min
    ,t2.delivery_max
    ,count(distinct if(t2.created_time <= concat(date_format(date_sub(curdate(), interval 1 day),'%Y-%m-%d'),' 12:00:00'),t2.pno,null)) as 12_pnos
    ,count(distinct if(t2.created_time <= date_format(date_add(t2.delivery_min,interval 180 minute),'%Y-%m-%d %H:%i:%s'),t2.pno,null)) as 2h_pnos
    ,count(distinct t2.pno) as pnos
    ,round(count(distinct if(t2.created_time <= date_format(date_add(t2.delivery_min,interval 180 minute),'%Y-%m-%d %H:%i:%s'),t2.pno,null))/count(distinct t2.pno),2) 2h_percentage
    ,round(count(distinct if(t2.created_time <= concat(date_format(date_sub(curdate(), interval 1 day),'%Y-%m-%d'),' 12:00:00'),t2.pno,null))/count(distinct t2.pno),2) 12_percentage

from (

        select
            td.staff_info_id
            ,date(convert_tz(td.created_at,'+00:00','+08:00')) as created_dt
            ,convert_tz(td.created_at,'+00:00','+08:00') as created_time
            ,td.pno
            ,t1.delivery_min ##最早交接时间
            ,t1.delivery_max ##最晚交接时间

        from ph_staging.ticket_delivery td

        left join (
            select
                td.staff_info_id
                ,MIN(convert_tz(td.created_at,'+00:00','+08:00')) AS delivery_min ##最早交接时间
                ,MAX(convert_tz(td.created_at,'+00:00','+08:00')) AS delivery_max ##最晚交接时间

            from ph_staging.ticket_delivery td
            where 1=1
                and td.created_at >= date_sub(date_sub(curdate(), interval 1 day), interval 8 hour )
                and td.created_at < date_sub(curdate(), interval 8 hour)##正常的时间剪掉8h
                AND td.state <> 3 # stata=3(已关闭)
            group by 1
        )t1
        on td.staff_info_id = t1.staff_info_id

        WHERE 1=1
            and td.created_at >= date_sub(date_sub(curdate(), interval 1 day), interval 8 hour )
            and td.created_at < date_sub(curdate(), interval 8 hour)##正常的时间剪掉8h
            AND td.state <> 3 # stata=3(已关闭)
        GROUP BY 1,2,3,4,5,6
)t2
group by 1,2,3
)


,main as (

SELECT
*
,COUNT(tt.staff_info_id) over (PARTITION by tt.work_store_id) 网点当日派件人数
,ROW_NUMBER() OVER (PARTITION by tt.work_store_id order by tt.当天派件数 desc) 人效排名
from
(
    SELECT
    ##IFNULL(swa.attendance_date,DATE(convert_tz(NOW(),'+08:00','+08:00'))) 统计日期
    swa.stat_date
    ,swa.staff_info_id
    ,swa.staff_name
    ,swa.state_desc #状态描述
    ,case when swa.wait_leave_state in ('0') then '非待离职'
        when swa.wait_leave_state in ('1') then '待离职'
    else swa.wait_leave_state end as wait_leave_state #是否待离职
    ,swa.attendance_started_at #上班打卡时间
    ,swa.attendance_end_at     #下班打卡时间
    ,swa.attendance_hour       #工作时长
    ,ROUND(time_to_sec(timediff(swa.shift_start,date_format(swa.attendance_started_at,"%H:%i:%s"))) /60,2) 迟到时长
    ,case when swa.is_plan_rest = 1 then '排休无需打卡'
        when  swa.is_plan_rest = 0 and swa.attendance_started_at is null then '无上班打卡时间'
        when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 59 then '未迟到'
        when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 359 then '迟到5min内'
        #when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 659 then '迟到5-10min'
        #when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 959 then '迟到10-15min'
        #when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 1259 then '迟到15-20min'
        #when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 1559 then '迟到20-25min'
        when timestampdiff(SECOND,CONCAT(swa.stat_date," ",swa.shift_start),swa.attendance_started_at) <= 1859 then '迟到5-30min'
    else '迟到30min以上' end as 迟到情况
    ,case when swa.is_outsource = 1 then '是' else '否' end as is_outsource#是否外协
    ,case when swa.is_plan_rest = 1 then '是' else '否' end as is_plan_rest#是否排休
    ,swa.hire_days      #在职天数
    ,swa.job_title      #岗位
    ,swa.store_id       #归属网点ID
    ,swa.store_name     #归属网点名称
    ,swa.store_category_desc   #网点类型描述
    ,swa.region_name           #归属大区
    ,swa.piece_name            #归属片区
    ,tiktok_area.area_name tiktok_area
    ,swa.staff_attr
    ,case when swa.supply_store_id is null then swa.store_id else swa.supply_store_id end as work_store_id #当日所属网点
    ,case when swa.supply_store_id is not null then ss.name
        when swa.supply_store_id is null then swa.store_name
    end as work_store_name #当日所属网点

    ,lanshou.揽件量
    ,jiaojie.交接量
    ,tuotou.当天派件数
    ,pp.拒收包裹数
    ,pp.运力不足包裹数
    ,pp.改约包裹数
    ,pp.客户不在家_电话无人接听包裹数
    ,pp.收件人号码空号包裹数
    ,pp.收件人号码错误包裹数
    ,pp.收件人地址不清晰或不正确包裹数
    ,pp.货物丢失包裹数
    ,pp.货物短少包裹数
    ,pp.货物破损包裹数
    ,pp.外包装破损包裹数
    ,pp.禁运品包裹数
    ,pp.其他派件标记包裹数

    ,IF(tuotou.当天派件数=1,TIMESTAMPDIFF(MINUTE,tuotou.finished_min,tuotou.finished_max),ROUND(TIMESTAMPDIFF(MINUTE,tuotou.finished_min,tuotou.finished_max) / (tuotou.当天派件数-1),2)) '派件间隔(分钟)'
    ,ROUND(tuotou.当天派件数 / jiaojie.交接量,2) '派件/交接'
    ,jiaojie.'交接5KG以上'
    ,tuotou.'妥投5KG以上'
    ,tuotou.tuotou_num_50 as '网点50米内派件量'
    ,jiaojie.delivery_min 最早交接时间
    ,jiaojie.delivery_max 最近交接时间
    ,ROUND(TIMESTAMPDIFF(MINUTE,jiaojie.delivery_min,jiaojie.delivery_max)/60,2) '交接工作时间'
    ,tuotou.finished_min  最早派件时间
    ,tuotou.finished_max  最近派件时间
    ,ROUND(TIMESTAMPDIFF(MINUTE,tuotou.finished_min,tuotou.finished_max)/60,2) '派件工作时间'
    ,lanshou.created_min  最早揽件时间
    ,lanshou.created_max  最近揽件时间
    ,ROUND(TIMESTAMPDIFF(MINUTE,lanshou.created_min,lanshou.created_max)/60,2) '揽件工作时间'


    ,swa.handover_par_cnt
    ,swa.handover_start_at
    ,swa.handover_end_at
    ,swa.handover_hour
    ,swa.delivery_par_cnt
    ,swa.delivery_start_at
    ,swa.delivery_end_at
    ,swa.delivery_hour
    ,swa.delivery_end_at2
    ,swa.delivery_hour2


    ##FROM ph_bi.hr_staff_info hsi

    ##left join ph_backyard.staff_work_attendance swa
    ##on swa.staff_info_id=hsi.staff_info_id
    ##and swa.attendance_date = date(convert_tz(now(),'+08:00','+08:00'))


    from dwm.dws_ph_staff_wide_s swa

    left join ph_bi.hr_staff_info hsi
    on swa.staff_info_id=hsi.staff_info_id

    left join ph_staging.sys_store ssd
    on swa.store_id = ssd.id

    left join ph_staging.sys_store ss
    on swa.supply_store_id = ss.id
    #on ss.category in (1,10) and
    ##on swa.started_store_id = ss.id

    left join ph_staging.sys_manage_piece smp
    on smp.id=ss.manage_piece

    left join ph_staging.sys_manage_region smr
    on smr.id=ss.manage_region

    left join
    (
        select distinct
            tiktok_area.dst_province_code province_code
            ,case tiktok_area.dst_area_code
                when 'MM' then 'MM'
                when 'GMA' then 'GMA'
                when 'LUZON 1' then 'Luz 1'
                when 'LUZON 2' then 'Luz 2'
                when 'LUZON 3' then 'Luz 3'
                when 'LUZON 4' then 'Luz 4'
                when 'MINDANAO 1' then 'Min 1'
                when 'MINDANAO 2' then 'Min 2'
                when 'VISAYAS 1' then 'Vis 1'
                when 'VISAYAS 2' then 'Vis 2'
            end area_name
        from dwm.dwd_ph_dict_tiktok_period_rules tiktok_area
    ) tiktok_area
    on ssd.province_code = tiktok_area.province_code

    left join
    (
        select
            td2.staff_info_id
            ,COUNT(DISTINCT td2.pno) '交接量'
            ,COUNT(DISTINCT CASE WHEN (pi.exhibition_length + pi.exhibition_width + pi.exhibition_height > 80 OR pi.exhibition_weight > 5000) THEN td2.pno ELSE NULL END)'交接5KG以上'
            ##,MIN(DATE_FORMAT(convert_tz(td2.created_at,'+00:00','+08:00'),'%T')) AS delivery_min ##最早交接时间
            ##,MAX(DATE_FORMAT(convert_tz(td2.created_at,'+00:00','+08:00'),'%T')) AS delivery_max ##最近交接时间
            ,MIN(convert_tz(td2.created_at,'+00:00','+08:00')) AS delivery_min ##最早交接时间
            ,MAX(convert_tz(td2.created_at,'+00:00','+08:00')) AS delivery_max ##最近交接时间

        from ph_staging.ticket_delivery td2
        left join ph_staging.parcel_info pi
        ON pi.pno = td2.pno
        WHERE 1=1
            and td2.created_at >= date_sub(date_sub(curdate(), interval 1 day), interval 8 hour )
            and td2.created_at < date_sub(curdate(), interval 8 hour)##正常的时间剪掉8h
            AND td2.state <> 3 # stata=3(已关闭)
        GROUP BY 1
    ) jiaojie # 交接量
    ON jiaojie.staff_info_id = hsi.staff_info_id

    LEFT JOIN
    (
        SELECT
            pi.ticket_delivery_staff_info_id
            ,date(convert_tz(pi.finished_at,'+00:00','+08:00')) as finished_dt
            ,MIN((convert_tz(pi.finished_at,'+00:00','+08:00')))  AS finished_min ##派件开始时间
            ,MAX((convert_tz(pi.finished_at,'+00:00','+08:00')))  AS finished_max ##派件结束时间
            ,COUNT(DISTINCT if(ROUND(st_distance_sphere(point(pi.ticket_delivery_staff_lng,pi.ticket_delivery_staff_lat), point(ss.lng,ss.lat)),0) < 50,pi.pno,null))  as tuotou_num_50
            ,IFNULL(COUNT(DISTINCT pi.pno),0) '当天派件数'
            ,COUNT(DISTINCT CASE WHEN (pi.exhibition_length + pi.exhibition_width + pi.exhibition_height > 80 OR pi.exhibition_weight > 5000) THEN pi.pno ELSE NULL END) as 妥投5KG以上
            ##,CASE WHEN ROUND(st_distance_sphere(point(pi.ticket_delivery_staff_lng,pi.ticket_delivery_staff_lat), point(ss.lng,ss.lat)),0) >= 50 THEN MIN((convert_tz(pi.finished_at,'+00:00','+08:00'))) END AS 派件开始时间
            ##,CASE WHEN ROUND(st_distance_sphere(point(pi.ticket_delivery_staff_lng,pi.ticket_delivery_staff_lat), point(ss.lng,ss.lat)),0) >= 50 THEN MAX((convert_tz(pi.finished_at,'+00:00','+08:00'))) END AS 派件结束时间

        ##FROM tmpale.parcel_in_warehouse_today dsdt  ##在仓表

        from ph_staging.parcel_info pi
        ##ON dsdt.pno = pi.pno

        LEFT JOIN ph_staging.sys_store ss
        on ss.id = pi.dst_store_id

        WHERE  1=1
            and pi.finished_at >= date_sub(date_sub(curdate(), interval 1 day), interval 8 hour )
            and pi.finished_at < date_sub(curdate(), interval 8 hour)##正常的时间剪掉8h
            and pi.state in ('5')
        GROUP BY 1
    )tuotou # 妥投
    ON tuotou.ticket_delivery_staff_info_id = hsi.staff_info_id

    LEFT JOIN
    (
        SELECT
            pi.ticket_pickup_staff_info_id
            ,date(convert_tz(pi.created_at,'+00:00','+08:00')) as created_at
            ,COUNT(DISTINCT(pi.pno))  '揽件量'
            ,MIN((convert_tz(pi.created_at,'+00:00','+08:00'))) AS created_min ##揽件开始时间
            ,MAX((convert_tz(pi.created_at,'+00:00','+08:00'))) AS created_max ##揽件结束时间

        FROM ph_staging.parcel_info pi

        WHERE 1=1
            and pi.state <> 9
            and pi.returned = 0
            and pi.created_at >= date_sub(date_sub(curdate(), interval 1 day), interval 8 hour )
            and pi.created_at < date_sub(curdate(), interval 8 hour)##正常的时间剪掉8h
        GROUP BY 1
    ) lanshou # 揽收量
    ON lanshou.ticket_pickup_staff_info_id = hsi.staff_info_id

    LEFT JOIN
    (
        SELECT
            pr.staff_info_id
            ,date(convert_tz(pr.routed_at,'+00:00','+08:00')) as routed_at
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (2)    THEN pr.pno ELSE NULL END)) 拒收包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (70) THEN pr.pno ELSE NULL END)) 改约包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (71)   THEN pr.pno ELSE NULL END)) 运力不足包裹数
            ##,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (8,16)    THEN pr.pno ELSE NULL END)) 联系不上包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (1)    THEN pr.pno ELSE NULL END))  客户不在家_电话无人接听包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (78)   THEN pr.pno ELSE NULL END)) 收件人号码空号包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (75)   THEN pr.pno ELSE NULL END)) 收件人号码错误包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (73)   THEN pr.pno ELSE NULL END)) 收件人地址不清晰或不正确包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (7)    THEN pr.pno ELSE NULL END)) 货物丢失包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (6)    THEN pr.pno ELSE NULL END)) 货物短少包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (5)    THEN pr.pno ELSE NULL END)) 货物破损包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (4)    THEN pr.pno ELSE NULL END)) 外包装破损包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category IN (69)    THEN pr.pno ELSE NULL END)) 禁运品包裹数
            ,COUNT(DISTINCT (CASE WHEN pr.marker_category not IN (1,2,4,5,6,7,69,70,71,73,75,78)    THEN pr.pno ELSE NULL END)) 其他派件标记包裹数


        ##FROM tmpale.parcel_in_warehouse_today dsdt

        from ph_staging.parcel_route pr
        left join ph_staging.parcel_info pi
        ON pi.pno = pr.pno

        WHERE 1=1
            AND pr.route_action = 'DELIVERY_MARKER' #派件标记
            and pr.routed_at >= date_sub(date_sub(curdate(), interval 1 day), interval 8 hour )
            and pr.routed_at < date_sub(curdate(), interval 8 hour)##正常的时间剪掉8h
        GROUP BY 1
    )pp #问题包裹数
    ON pp.staff_info_id = hsi.staff_info_id

    WHERE 1=1
    AND DATE(swa.stat_date) = date_sub(curdate(),interval 1 day)
    AND swa.store_category IN (1,10,14) # 网点类型 1,10
    and hsi.state = 1
    and swa.job_title IN (13,110,1000)

)tt


)


, car_arrive  as (
##网点正班车到达时间
select date(ft.real_arrive_time) as proof_dt##日期
    ,ft.next_store_id
    ,ft.next_store_name
    ,ft33.plan_arrive_dt as plan_arrive_first##正班车第一趟计划到达时间
    ,ft11.real_arrive_time as arrive_time_first##正班车第一趟到达时间
    ,ft22.real_arrive_time as arrive_time_last##正班车最后一趟到达时间
    ,case when ft11.real_arrive_time = ft22.real_arrive_time then '只有一趟正班车' else '多趟正班车' end as proof_num
    ,case when date_format(ft11.real_arrive_time,'%H:%i') is null then '10:00'
          when date_format(ft11.real_arrive_time,'%H:%i') < '07:00' then '09:30'
          when date_format(ft11.real_arrive_time,'%H:%i') between '07:00' and '09:00' then date_format(date_add(ft11.real_arrive_time,interval 150 minute),'%H:%i')
          when date_format(ft11.real_arrive_time,'%H:%i') > '09:00' then '10:00'
    else '其他' end as min_tuotou_time

from (
        select next_store_id
            ,next_store_name
            ,real_arrive_time
            ,date(real_arrive_time) as real_arrive_dt
            ,proof_id
        from ph_bi.fleet_time
        where 1=1
            and line_mode =1##正班车
            and arrive_type in ('3','5')
            and fleet_status in ('1')
            and date(real_arrive_time) = date_sub(curdate(),interval 1 day)

) ft

left join
(##最早到达时间
    select ft1.next_store_id
        ,ft1.next_store_name
        ,ft1.real_arrive_time
        ,ft1.real_arrive_dt
        ,ft1.proof_id
        ,ft1.rn
    from
    (
        select next_store_id
            ,next_store_name
            ,real_arrive_time
            ,date(real_arrive_time) as real_arrive_dt
            ,proof_id
            ,row_number() over (partition by date(real_arrive_time),next_store_id,next_store_name order by real_arrive_time asc) as rn
        from ph_bi.fleet_time
        where 1=1
            and line_mode =1##正班车
            and arrive_type in ('3','5')
            and fleet_status in ('1')
            and date(real_arrive_time) = date_sub(curdate(),interval 1 day)
    )ft1
    where ft1.rn = 1
)ft11
on ft11.next_store_id = ft.next_store_id and ft11.real_arrive_dt = ft.real_arrive_dt
left join (
    ##最晚到达时间
    select ft2.next_store_id
        ,ft2.next_store_name
        ,ft2.real_arrive_time
        ,ft2.real_arrive_dt
        ,ft2.proof_id
        ,ft2.rn
    from (
        select next_store_id
            ,next_store_name
            ,real_arrive_time
            ,date(real_arrive_time) as real_arrive_dt
            ,proof_id
            ,row_number() over (partition by date(real_arrive_time),next_store_id,next_store_name order by real_arrive_time desc) as rn
        from ph_bi.fleet_time
        where 1=1
            and line_mode =1
            and arrive_type in ('3','5')
            and fleet_status in ('1')
            and date(real_arrive_time) = date_sub(curdate(),interval 1 day)
    )ft2
    where ft2.rn = 1
)ft22
on ft22.next_store_id = ft.next_store_id and ft22.real_arrive_dt = ft.real_arrive_dt

left join(
##第一趟正班车计划到达时间
    select ft1.next_store_id
        ,ft1.next_store_name
        ,ft1.plan_arrive_time
        ,ft1.plan_arrive_dt
        ,ft1.proof_id
        ,ft1.rn
    from
    (
        select next_store_id
            ,next_store_name
            ,plan_arrive_time
            ,date(plan_arrive_time) as plan_arrive_dt
            ,proof_id
            ,row_number() over (partition by date(plan_arrive_time),next_store_id,next_store_name order by plan_arrive_time asc) as rn
        from ph_bi.fleet_time
        where 1=1
            and line_mode =1##正班车
            and arrive_type in ('3','5')
            and fleet_status in ('1')
            and date(plan_arrive_time) = date_sub(curdate(),interval 1 day)
    )ft1
    where rn = 1

)ft33
on ft33.next_store_id = ft.next_store_id and ft33.plan_arrive_dt = ft.real_arrive_dt

where 1=1
    and date(ft.real_arrive_time) = date_sub(curdate(),interval 1 day)
    and ft11.real_arrive_time is not null
    and ft22.real_arrive_time is not null
group by 1,2,3,4,5,6,7,8
)


,staff_delivery_code as (
# 快递员绑定情况
select
    t.store_id
    ,t.name
    ,t.staff_info_id
    ,count(distinct t.delivery_code) 三段码绑定数量
    ,group_concat(distinct t.delivery_code SEPARATOR ' / ') 三段码绑定情况
    ,count(distinct t.district_code) barangay绑定数量
    ,group_concat(concat(t.delivery_code,':',t.barangay_name) order by t.delivery_code SEPARATOR ' / ') 绑定明细情况
from
    (
    select
        sdbsi.store_id # 网点id
        ,ss.name # 网点名称
        ,sdbsi.staff_info_id # 员工id
        ,sdbsi.delivery_code # 绑定的三段码
        ,sdbsi.district_code # 绑定的barangayID
        ,sd.name barangay_name # 绑定的barangay名称
    from ph_staging.store_delivery_barangay_staff_info sdbsi
    left join ph_staging.sys_district sd
    on sdbsi.district_code  = sd.code
    left join ph_staging.sys_store ss
    on sdbsi.store_id  = ss.id
    where 1=1
        and sdbsi.deleted = 0 # 非剔除记录
        and ss.category  = 1 # SP网点
    group by 1,2,3,4,5,6
    )t
group by 1,2,3
)


,handover_14days as (
##各区域近14天人均交接量
select m1.area_name
    ,m1.manage_region
    ,round(sum(avg_decnt)/14,0) per_capita_handover
    ,round((sum(avg_decnt)/14)*0.8,0) per_capita_h

from (
select
    date(convert_tz(td.created_at,"+00:00","+08:00")) stat_date
    ##,case when tiktok_area.area_name in ('MM') and mr.name in ('Area1') then 'MM_Area1'
    ##    when tiktok_area.area_name in ('GMA') and mr.name in ('Area1') then 'GMA_Area1'
    ##    when tiktok_area.area_name in ('Luz 3') and mr.name in ('Area1') then 'Luz3_Area1'
    ##else mr.name end as area
    ,tiktok_area.area_name
    ,mr.name manage_region
    ,COUNT(distinct td.pno)  pnos
    #,COUNT(DISTINCT CASE WHEN (pi.exhibition_length + pi.exhibition_width + pi.exhibition_height > 80 OR pi.exhibition_weight > 5000) THEN dc.pno ELSE NULL END) delivery_5KG
    ,count(distinct td.staff_info_id ) staff_cut
    ,round(COUNT(distinct td.pno)/count(distinct td.staff_info_id ) ,0) avg_decnt
FROM ph_staging.ticket_delivery td

##left join ph_staging.ticket_delivery td
##on td.pno =dc.pno and dc.stat_date =date(convert_tz(td.delivery_at,"+00:00","+08:00")) and td.state in (0,1,2)

left join ph_staging.parcel_info pi
ON td.pno = pi.pno

left join ph_bi.sys_store ssd
on ssd.id = pi.dst_store_id

left join dwm.dwd_ph_dict_lazada_period_rules lazada_area
on ssd.province_code = lazada_area.province_code

left join ph_staging.shopee_period_limitation_rules_area shopee_area
on ssd.province_code = shopee_area.province_code

left join
(
    select distinct
        tiktok_area.dst_province_code province_code
        ,case tiktok_area.dst_area_code
            when 'MM' then 'MM'
            when 'GMA' then 'GMA'
            when 'LUZON 1' then 'Luz 1'
            when 'LUZON 2' then 'Luz 2'
            when 'LUZON 3' then 'Luz 3'
            when 'LUZON 4' then 'Luz 4'
            when 'MINDANAO 1' then 'Min 1'
            when 'MINDANAO 2' then 'Min 2'
            when 'VISAYAS 1' then 'Vis 1'
            when 'VISAYAS 2' then 'Vis 2'
        end area_name
    from dwm.dwd_ph_dict_tiktok_period_rules tiktok_area
) tiktok_area
on ssd.province_code = tiktok_area.province_code

LEFT JOIN ph_staging.sys_manage_region mr
ON ssd.manage_region = mr.id

LEFT JOIN ph_staging.sys_manage_piece mp
ON ssd.manage_piece = mp.id

left join ph_bi.hr_staff_info hsi
on td.staff_info_id = hsi.staff_info_id

where 1=1
    ##and date(dc.stat_date) >= date_sub(curdate(),interval 14 day)

    and td.created_at >= date_sub(date_sub(curdate(), interval 14 day), interval 8 hour )
    and td.created_at < date_sub(curdate(), interval 8 hour)##正常的时间剪掉8h

    and ssd.category =1 ##sp网点
    and mr.name not in ('FHome')
    and hsi.job_title in ('13','110','452','1000')
GROUP BY 1,2,3
)m1
group by 1,2
)


,finished_14days as (
##各区域近14天人均妥投量
select
    m1.tiktok_area as area_name
    ,m1.manage_region
    ,round(sum(avg_decnt)/14,0) per_capita_finished
    ,round((sum(avg_decnt)/14)*0.8,0) per_capita_f

from (
select
    date(convert_tz(pi.finished_at,'+00:00','+08:00')) as finished_dt
    ,mr.name manage_region
    ,tiktok_area.area_name tiktok_area
    ,count(distinct pi.pno) pnos
    ##,COUNT(DISTINCT CASE WHEN (pi.exhibition_length + pi.exhibition_width + pi.exhibition_height > 80 OR pi.exhibition_weight > 5000) THEN pi.pno ELSE NULL END) finished_5KG
    ,count(distinct pi.ticket_delivery_staff_info_id) staff_info_id
    ,round(COUNT(distinct pi.pno)/count(distinct pi.ticket_delivery_staff_info_id) ,0) avg_decnt

from ph_staging.parcel_info pi

left join ph_staging.sys_store ssd
on pi.dst_store_id = ssd.id

left join dwm.dwd_ph_dict_lazada_period_rules lazada_area
on ssd.province_code = lazada_area.province_code

left join ph_staging.shopee_period_limitation_rules_area shopee_area
on ssd.province_code = shopee_area.province_code

left join
(
    select distinct
        tiktok_area.dst_province_code province_code
        ,case tiktok_area.dst_area_code
            when 'MM' then 'MM'
            when 'GMA' then 'GMA'
            when 'LUZON 1' then 'Luz 1'
            when 'LUZON 2' then 'Luz 2'
            when 'LUZON 3' then 'Luz 3'
            when 'LUZON 4' then 'Luz 4'
            when 'MINDANAO 1' then 'Min 1'
            when 'MINDANAO 2' then 'Min 2'
            when 'VISAYAS 1' then 'Vis 1'
            when 'VISAYAS 2' then 'Vis 2'
        end area_name
    from dwm.dwd_ph_dict_tiktok_period_rules tiktok_area
) tiktok_area
on ssd.province_code = tiktok_area.province_code

LEFT JOIN ph_staging.sys_manage_region mr
ON ssd.manage_region = mr.id

LEFT JOIN ph_staging.sys_manage_piece mp
ON ssd.manage_piece = mp.id

left join ph_bi.hr_staff_info hsi
on pi.ticket_delivery_staff_info_id = hsi.staff_info_id

where 1=1
    and pi.finished_at >= date_sub(date_sub(curdate(), interval 14 day), interval 8 hour )
    and pi.finished_at < date_sub(curdate(), interval 8 hour)##正常的时间剪掉8h
    and ssd.category =1 ##sp网点
    and pi.state = 5
    and mr.name not in ('FHome')
    and hsi.job_title in ('13','110','452','1000')
group by 1,2,3
)m1
group by 1,2
)

,should_delivery as
(#网点人均可交接
    select
        date(dc.stat_date) stat_date
        ,dc.store_id
        ,ss.name
        ,COUNT(distinct dc.`pno`)  cnt
        ,count(distinct td.`staff_info_id` ) staff_cut
        ,round(COUNT(distinct dc.`pno`)/count(distinct td.`staff_info_id` ) ,0) avg_decnt
    ##FROM dwm.dwd_ph_dc_should_delivery_d dc
    from ph_bi.dc_should_delivery_today dc
    left join `ph_staging`.`ticket_delivery` td
    on td.`pno` =dc.`pno` and dc.`stat_date` =date(convert_tz(td.`delivery_at`,"+00:00","+08:00")) and td.`state`in (0,1,2)
    left join ph_bi.`sys_store` ss on ss.`id` =dc.`store_id`
    where dc.`stat_date` = date_sub(CURRENT_DATE ,interval 1 day)
        and ss.`category` =1
        and dc.`state` <6
    GROUP BY 1,2,3
)

,area_delivery as (
    select
    t1.员工ID
    ,t1.交接区域数量_all
    ,t1.交接区域数量
    ,t1.交接数_all
    ,t1.交接数
    ,t1.第二区域交接数
    ,t1.交接情况
    ,t2.妥投区域数量
    ,t2.妥投数
    ,t2.妥投情况
    from
    (
        select
            tt.员工ID
            ,count(distinct tt.三段码) 交接区域数量_all
            ,count(distinct if(tt.`交接包裹数` > 3,tt.三段码,null)) 交接区域数量
            ,sum(tt.交接包裹数) 交接数_all
            ,sum(if(tt.`交接包裹数` > 3,tt.交接包裹数,0)) as 交接数
            ,group_concat(concat(tt.网点名称,':',tt.三段码,':',tt.交接包裹数,'(',tt.当日在仓,')') order by tt.交接包裹数 desc SEPARATOR ' / ') 交接情况
            ,tt.第二区域交接数
        from
        (
            select
                date(convert_tz(td.created_at,'+00:00','+08:00')) as delivery_dt
                ,mr.name `大区`
                ,mp.name `片区`
                ,dsdt.dst_store_id
                ,ssd.name `网点名称`
                ,tiktok_area.area_name tiktok_area
                ,lazada_area.area_name lazada_area
                ,case shopee_area.area_id when 1 then 'MM'  when 2 then 'GMA '  when 3 then 'Luz 1'  when 4 then 'Luz 2'  when 5 then 'Luz 3' when 6 then 'Vis 1'  when 7 then 'Vis 2'  when 8 then 'Min 1'  when 9 then 'Min 2'  when 10 then 'Luz 4' end as shopee_area
                ,hsi.name `快递员姓名`
                ,td.staff_info_id `员工ID`
                ,if(hsi.job_title = 13,'BIKE',if(hsi.job_title = 110,'VAN',if(hsi.job_title = 452,'BOAT',if(hsi.job_title = 1000,'Tricycle','other')))) `快递员职位`
                ,ddpsci.third_sorting_code `三段码`
                ,sdmzc.当日在仓
                ,count(distinct td.pno) `交接包裹数`
                ,nth_value(count(distinct td.pno),2) over(partition by ssd.name,td.staff_info_id order by count(distinct td.pno) desc) 第二区域交接数

            from ph_staging.ticket_delivery td

            ##left join ph_staging.parcel_info pi
            ##on pi.pno = td.pno

            left join dwm.dwd_ph_non_end_pno_detl_d dsdt
            on td.pno = dsdt.pno

            left join
            (
                select
                    ddpsci.pno
                    ,ddpsci.third_sorting_code
                    ,row_number() over(partition by ddpsci.pno order by ddpsci.created_at desc) rk
                from ph_drds.parcel_sorting_code_info ddpsci
                where 1=1
                    and ddpsci.created_at >= date_sub(current_date(),91)
            ) ddpsci
            on dsdt.pno = ddpsci.pno and ddpsci.rk = 1

            left join ph_staging.sys_store ssd
            on dsdt.dst_store_id = ssd.id

            left join dwm.dwd_ph_dict_lazada_period_rules lazada_area
            on ssd.province_code = lazada_area.province_code

            left join ph_staging.shopee_period_limitation_rules_area shopee_area
            on ssd.province_code = shopee_area.province_code

            left join

            (
                select distinct
                    tiktok_area.dst_province_code province_code
                    ,case tiktok_area.dst_area_code
                        when 'MM' then 'MM'
                        when 'GMA' then 'GMA'
                        when 'LUZON 1' then 'Luz 1'
                        when 'LUZON 2' then 'Luz 2'
                        when 'LUZON 3' then 'Luz 3'
                        when 'LUZON 4' then 'Luz 4'
                        when 'MINDANAO 1' then 'Min 1'
                        when 'MINDANAO 2' then 'Min 2'
                        when 'VISAYAS 1' then 'Vis 1'
                        when 'VISAYAS 2' then 'Vis 2'
                    end area_name
                from dwm.dwd_ph_dict_tiktok_period_rules tiktok_area
            ) tiktok_area
            on ssd.province_code = tiktok_area.province_code

            LEFT JOIN ph_staging.sys_manage_region mr
            ON ssd.manage_region = mr.id

            LEFT JOIN ph_staging.sys_manage_piece mp
            ON ssd.manage_piece = mp.id

            left join ph_bi.hr_staff_info hsi
            on td.staff_info_id = hsi.staff_info_id

            left join
            (#网点各三段码在仓、已交接、积压
                SELECT
                    dsdt.stat_date
                    ,ssd.id `store_id`
                    ,ssd.name `网点名称`
                    ,ddpsci.third_sorting_code `区域编码`

                    ,count(dsdt.pno) '当日在仓'
                    ,count(case when dsdt.is_handover = 1 then dsdt.pno else null end)  `已交接量`
                    ,count(case when dsdt.state not in ('已签收','疑难件','已退件','异常关闭') then dsdt.pno else null end) `积压件量`

                FROM dwm.dwd_ph_non_end_pno_detl_d dsdt

                left join ph_staging.parcel_info pi
                on dsdt.pno = pi.pno

                left join
                (
                    select
                        ddpsci.pno
                        ,ddpsci.third_sorting_code
                        ,row_number() over(partition by ddpsci.pno order by ddpsci.created_at desc) rk
                    from ph_drds.parcel_sorting_code_info ddpsci
                    where 1=1
                        and ddpsci.created_at >= date_sub(current_date(),91)
                ) ddpsci
                on pi.pno = ddpsci.pno
                and ddpsci.rk = 1

                left join ph_staging.sys_store ssd
                on dsdt.dst_store_id = ssd.id

                where 1=1
                    and dsdt.stat_date  = date_sub(curdate(),interval 1 day)
                    and ssd.category in ('1','10')##SP  网点
                GROUP BY 1,2,3,4
                order by 1,2,3,4
            )sdmzc
            on sdmzc.store_id = ssd.id
            and sdmzc.区域编码 = ddpsci.third_sorting_code

            where 1=1
                and td.created_at >= date_sub(date_sub(curdate(), interval 1 day), interval 8 hour )
                and td.created_at < date_sub(curdate(), interval 8 hour)##正常的时间剪掉8h
                and td.state <> 3
            group by 1,2,3,4,5,6,7,8,9,10,11,12,13
        ) tt
        group by 1
    ) t1

    left join

    (
        select
            tt.员工ID
            ,count(distinct tt.三段码) 妥投区域数量
            ,sum(tt.妥投包裹数) 妥投数
            ,group_concat(concat(tt.网点名称,':',tt.三段码,':',tt.妥投包裹数) order by tt.妥投包裹数 desc SEPARATOR ' / ') 妥投情况
        from
        (
            select date(convert_tz(pi.finished_at,'+00:00','+08:00')) as finished_dt
                ,mr.name `大区`
                ,mp.name `片区`
                ,ssd.sorting_no `分拣大区`
                ,dsdt.dst_store_id
                ,ssd.name `网点名称`
                ,tiktok_area.area_name tiktok_area
                ,lazada_area.area_name lazada_area
                ,case shopee_area.area_id when 1 then 'MM'  when 2 then 'GMA '  when 3 then 'Luz 1'  when 4 then 'Luz 2'  when 5 then 'Luz 3' when 6 then 'Vis 1'  when 7 then 'Vis 2'  when 8 then 'Min 1'  when 9 then 'Min 2'  when 10 then 'Luz 4' end as shopee_area
                ,hsi.name `快递员姓名`
                ,pi.ticket_delivery_staff_info_id `员工ID`
                ,if(hsi.job_title = 13,'BIKE',if(hsi.job_title = 110,'VAN',if(hsi.job_title = 452,'BOAT',if(hsi.job_title = 1000,'Tricycle','other')))) `快递员职位`
                ,ddpsci.third_sorting_code `三段码`
                ,count(distinct pi.pno) `妥投包裹数`

            from ph_staging.parcel_info pi

            left join dwm.dwd_ph_non_end_pno_detl_d dsdt
            on pi.pno = dsdt.pno

            left join
            (
                select
                    ddpsci.pno
                    ,ddpsci.third_sorting_code
                    ,row_number() over(partition by ddpsci.pno order by ddpsci.created_at desc) rk
                from ph_drds.parcel_sorting_code_info ddpsci
                where 1=1
                    and ddpsci.created_at >= date_sub(current_date(),91)
            ) ddpsci
            on dsdt.pno = ddpsci.pno and ddpsci.rk = 1

            left join ph_staging.sys_store ssd
            on dsdt.dst_store_id = ssd.id

            left join dwm.dwd_ph_dict_lazada_period_rules lazada_area
            on ssd.province_code = lazada_area.province_code

            left join ph_staging.shopee_period_limitation_rules_area shopee_area
            on ssd.province_code = shopee_area.province_code

            left join

            (
                select distinct
                    tiktok_area.dst_province_code province_code
                    ,case tiktok_area.dst_area_code
                        when 'MM' then 'MM'
                        when 'GMA' then 'GMA'
                        when 'LUZON 1' then 'Luz 1'
                        when 'LUZON 2' then 'Luz 2'
                        when 'LUZON 3' then 'Luz 3'
                        when 'LUZON 4' then 'Luz 4'
                        when 'MINDANAO 1' then 'Min 1'
                        when 'MINDANAO 2' then 'Min 2'
                        when 'VISAYAS 1' then 'Vis 1'
                        when 'VISAYAS 2' then 'Vis 2'
                    end area_name
                from dwm.dwd_ph_dict_tiktok_period_rules tiktok_area
            ) tiktok_area
            on ssd.province_code = tiktok_area.province_code

            LEFT JOIN ph_staging.sys_manage_region mr
            ON ssd.manage_region = mr.id

            LEFT JOIN ph_staging.sys_manage_piece mp
            ON ssd.manage_piece = mp.id

            left join ph_bi.hr_staff_info hsi
            on pi.ticket_delivery_staff_info_id = hsi.staff_info_id

            where 1=1
            and pi.finished_at >= date_sub(date_sub(curdate(), interval 1 day), interval 8 hour )
            and pi.finished_at < date_sub(curdate(), interval 8 hour)##正常的时间剪掉8h
            and pi.state = 5
            group by 1,2,3,4,5,6,7,8,9,10,11,12,13
        ) tt
        group by 1
    ) t2

    on t1.员工ID = t2.员工ID
)


,staff_de as (
select
    t1.staff_info_id
    ,count(distinct t1.delivery_code) delivery_delivery_num##交接区域数量
    ,count(distinct t1.pno) delivery_num##交接数量
    ,count(distinct if(t2.pno_code is not null,t1.pno,null)) delivery_pnos_correct#绑定码的交接数量
    ,count(distinct if(t2.pno_code is null, t1.pno,null)) delivery_pnos_wrong #非绑定码的交接数量
    ,round(count(distinct if(t2.pno_code is null, t1.pno,null))/count(distinct t1.pno) ,2) as pnos_wrong_bili


from (
##包裹实际交接情况
select
    td.pno
    ,date(convert_tz(td.created_at,'+00:00','+08:00')) as delivery_dt
    ,mr.name region_name
    ,mp.name piece_name
    ,dsdt.dst_store_id store_id
    ,ssd.name store_name
    ,case when ssd.category = '1' then 'SP' when ssd.category = '10' then 'BDC' end DC_type
    ,tiktok_area.area_name tiktok_area
    ,lazada_area.area_name lazada_area
    ,case shopee_area.area_id when 1 then 'MM'  when 2 then 'GMA '  when 3 then 'Luz 1'  when 4 then 'Luz 2'  when 5 then 'Luz 3' when 6 then 'Vis 1'  when 7 then 'Vis 2'  when 8 then 'Min 1'  when 9 then 'Min 2'  when 10 then 'Luz 4' end as shopee_area
    ,hsi.name staff_name
    ,td.staff_info_id staff_info_id
    ,sd.province_code as province_code
    ,sp.name as province_name
    ,sd.city_code as city_code
    ,sc.name as city_name
    ,sd.code barangay_code
    ,sd.name barangay_name
    ,if(hsi.job_title = 13,'BIKE',if(hsi.job_title = 110,'VAN',if(hsi.job_title = 452,'BOAT',if(hsi.job_title = 1000,'Tricycle','other')))) job_title
    ,ddpsci.third_sorting_code as delivery_code
    ,CONCAT(td.staff_info_id,"-",ddpsci.sorting_code) pno_code
    ##,sdmzc.当日在仓
    ##,count(distinct td.pno) delivery_pnos
    ##,nth_value(count(distinct td.pno),2) over(partition by ssd.name,td.staff_info_id order by count(distinct td.pno) desc) 第二区域交接数

from ph_staging.ticket_delivery td

##left join ph_staging.parcel_info pi
##on pi.pno = td.pno

join dwm.dwd_ph_non_end_pno_detl_d dsdt##在仓表
on td.pno = dsdt.pno and date(convert_tz(td.created_at,'+00:00','+08:00')) = date(dsdt.stat_date)

left join ph_staging.parcel_info pi
on pi.pno = dsdt.pno

left join ph_staging.sys_district sd ##brgy的码
on pi.dst_district_code = sd.code

left join ph_bi.sys_city sc
on sc.code = sd.city_code

left join ph_bi.sys_province sp
on sp.code = sd.province_code

left join
(
    select
        ddpsci.pno
        ,ddpsci.dst_store_id
        ,ddpsci.dst_province_code
        ,ddpsci.dst_city_code
        ,ddpsci.dst_district_code
        ,ddpsci.third_sorting_code
        ,ddpsci.sorting_code
        ,row_number() over(partition by ddpsci.pno order by ddpsci.created_at desc) rk
    from ph_drds.parcel_sorting_code_info ddpsci
    where 1=1
        and ddpsci.created_at >= date_sub(current_date(),91)
) ddpsci
on dsdt.pno = ddpsci.pno and ddpsci.rk = 1


left join ph_staging.sys_store ssd
on dsdt.dst_store_id = ssd.id

left join dwm.dwd_ph_dict_lazada_period_rules lazada_area
on ssd.province_code = lazada_area.province_code

left join ph_staging.shopee_period_limitation_rules_area shopee_area
on ssd.province_code = shopee_area.province_code

left join
(
    select distinct
        tiktok_area.dst_province_code province_code
        ,case tiktok_area.dst_area_code
            when 'MM' then 'MM'
            when 'GMA' then 'GMA'
            when 'LUZON 1' then 'Luz 1'
            when 'LUZON 2' then 'Luz 2'
            when 'LUZON 3' then 'Luz 3'
            when 'LUZON 4' then 'Luz 4'
            when 'MINDANAO 1' then 'Min 1'
            when 'MINDANAO 2' then 'Min 2'
            when 'VISAYAS 1' then 'Vis 1'
            when 'VISAYAS 2' then 'Vis 2'
        end area_name
    from dwm.dwd_ph_dict_tiktok_period_rules tiktok_area
) tiktok_area
on ssd.province_code = tiktok_area.province_code

LEFT JOIN ph_staging.sys_manage_region mr
ON ssd.manage_region = mr.id

LEFT JOIN ph_staging.sys_manage_piece mp
ON ssd.manage_piece = mp.id

left join ph_bi.hr_staff_info hsi
on td.staff_info_id = hsi.staff_info_id

left join
(#网点各三段码在仓、已交接、积压
    SELECT
        dsdt.stat_date
        ,ssd.id `store_id`
        ,ssd.name `网点名称`
        ,ddpsci.third_sorting_code `区域编码`

        ,count(dsdt.pno) '当日在仓'
        ,count(case when dsdt.is_handover = 1 then dsdt.pno else null end)  `已交接量`
        ,count(case when dsdt.state not in ('已签收','疑难件','已退件','异常关闭') then dsdt.pno else null end) `积压件量`

    FROM dwm.dwd_ph_non_end_pno_detl_d dsdt

    left join ph_staging.parcel_info pi
    on dsdt.pno = pi.pno

    left join
    (
        select
            ddpsci.pno
            ,ddpsci.third_sorting_code
            ,row_number() over(partition by ddpsci.pno order by ddpsci.created_at desc) rk
        from ph_drds.parcel_sorting_code_info ddpsci
        where 1=1
            and ddpsci.created_at >= date_sub(current_date(),91)
    ) ddpsci
    on pi.pno = ddpsci.pno
    and ddpsci.rk = 1

    left join ph_staging.sys_store ssd
    on dsdt.dst_store_id = ssd.id

    where 1=1
        and dsdt.stat_date = date_sub(curdate(),interval 1 day)
        and ssd.category in ('1','10')##SP网点
    GROUP BY 1,2,3,4
    order by 1,2,3,4
)sdmzc
on sdmzc.store_id = ssd.id and sdmzc.区域编码 = ddpsci.third_sorting_code

where 1=1
    and td.created_at >= date_sub(date_sub(curdate(), interval 1 day), interval 8 hour )
    and td.created_at < date_sub(curdate(), interval 8 hour)##正常的时间剪掉8h
    and td.state <> 3
group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21

)t1

left join
(
#包裹理论交接情况，快递员绑定情况
select td.pno
    ,date(convert_tz(td.created_at,'+00:00','+08:00')) as delivery_dt
    ,dsdt.dst_store_id store_id
    ,ss.name store_name
    ,mr.name region_name
    ,mp.name piece_name
    ,tiktok_area.area_name tiktok_area
    ,lazada_area.area_name lazada_area
    ,case shopee_area.area_id when 1 then 'MM'  when 2 then 'GMA '  when 3 then 'Luz 1'  when 4 then 'Luz 2'  when 5 then 'Luz 3' when 6 then 'Vis 1'  when 7 then 'Vis 2'  when 8 then 'Min 1'  when 9 then 'Min 2'  when 10 then 'Luz 4' end as shopee_area
    ,case when ss.category = '1' then 'SP' when ss.category = '10' then 'BDC' end DC_type
    ,sd.province_code as province_code
    ,sp.name as province_name
    ,sd.city_code as city_code
    ,sc.name as city_name
    ,sd.code barangay_code
    ,sd.name barangay_name
    ,sdbsi.delivery_code delivery_code
    ,sdbsi.staff_info_id as staff_info_id
    ,CONCAT(sdbsi.staff_info_id,"-",ddpsci.sorting_code) pno_code
    ##,count(distinct t.delivery_code) 三段码绑定数量
    ##,group_concat(distinct t.delivery_code SEPARATOR ' / ') 三段码绑定情况
    ##,count(distinct t.district_code) barangay绑定数量
    ##,group_concat(concat(t.delivery_code,':',t.barangay_name) order by t.delivery_code SEPARATOR ' / ') 绑定明细情况

    from ph_staging.ticket_delivery td

    join dwm.dwd_ph_non_end_pno_detl_d dsdt##在仓表
    on td.pno = dsdt.pno and date(convert_tz(td.created_at,'+00:00','+08:00')) = date(dsdt.stat_date)

    ##left join ph_staging.parcel_info pi
    ##on pi.pno = td.pno

    left join
    (
        select
            ddpsci.pno
            ,ddpsci.dst_store_id
            ,ddpsci.dst_province_code
            ,ddpsci.dst_city_code
            ,ddpsci.dst_district_code
            ,ddpsci.third_sorting_code
            ,ddpsci.sorting_code
            ,row_number() over(partition by ddpsci.pno order by ddpsci.created_at desc) rk
        from ph_drds.parcel_sorting_code_info ddpsci
        where 1=1
            and ddpsci.created_at >= date_sub(current_date(),91)
    ) ddpsci
    on dsdt.pno = ddpsci.pno and ddpsci.rk = 1

    left join (
        select
            store_id
            ,delivery_code
            ,district_code
            ,staff_info_id
            ,deleted
        from  ph_staging.store_delivery_barangay_staff_info
        where deleted = 0
        group by
            store_id
            ,delivery_code
            ,district_code
            ,staff_info_id
            ,deleted
        )sdbsi
    on ddpsci.dst_store_id = sdbsi.store_id #网点
    and ddpsci.third_sorting_code = sdbsi.delivery_code #派送码
    and ddpsci.dst_district_code = sdbsi.district_code #barangay code

    left join ph_staging.sys_district sd
    on sdbsi.district_code  = sd.code

    left join ph_bi.sys_city sc
    on sc.code = sd.city_code

    left join ph_bi.sys_province sp
    on sp.code = sd.province_code

    left join ph_staging.sys_store ss
    on sdbsi.store_id  = ss.id

    LEFT JOIN ph_staging.sys_manage_region mr
    ON ss.manage_region = mr.id

    LEFT JOIN ph_staging.sys_manage_piece mp
    ON ss.manage_piece = mp.id

    left join dwm.dwd_ph_dict_lazada_period_rules lazada_area
    on ss.province_code = lazada_area.province_code

    left join ph_staging.shopee_period_limitation_rules_area shopee_area
    on ss.province_code = shopee_area.province_code

    left join

    (
        select distinct
        tiktok_area.dst_province_code province_code
        ,case tiktok_area.dst_area_code
        when 'MM' then 'MM'
        when 'GMA' then 'GMA'
        when 'LUZON 1' then 'Luz 1'
        when 'LUZON 2' then 'Luz 2'
        when 'LUZON 3' then 'Luz 3'
        when 'LUZON 4' then 'Luz 4'
        when 'MINDANAO 1' then 'Min 1'
        when 'MINDANAO 2' then 'Min 2'
        when 'VISAYAS 1' then 'Vis 1'
        when 'VISAYAS 2' then 'Vis 2'
        end area_name
        from dwm.dwd_ph_dict_tiktok_period_rules tiktok_area
    ) tiktok_area
    on ss.province_code = tiktok_area.province_code

where 1=1
    and td.created_at >= date_sub(date_sub(curdate(), interval 1 day), interval 8 hour )
    and td.created_at < date_sub(curdate(), interval 8 hour)##正常的时间剪掉8h
    and td.state <> 3
    and sdbsi.deleted = 0 # 非剔除记录
    and ss.category  = 1 # SP网点
group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19

)t2

on t1.pno_code = t2.pno_code

group by 1
)

,prout as (

select p1.staff_info_id
from (
SELECT
    date(convert_tz(pr.routed_at , '+00:00', '+08:00' ) )  routed_at #路由日期
    ,convert_tz(pr.routed_at , '+00:00', '+08:00' ) routed_time #路由时间
    ,lead(convert_tz(pr.routed_at , '+00:00', '+08:00' )) over (PARTITION by pr.staff_info_id,date(convert_tz(pr.routed_at , '+00:00', '+08:00' ) )    order by convert_tz(pr.routed_at , '+00:00', '+08:00' ))   下一条路由
    ,lead(pr.route_action) over (PARTITION by pr.staff_info_id,date(convert_tz(pr.routed_at , '+00:00', '+08:00' ) )    order by convert_tz(pr.routed_at , '+00:00', '+08:00' ))   下一条路由动作
    ,timestampdiff(hour,convert_tz(pr.routed_at , '+00:00', '+08:00' ),lead(convert_tz(pr.routed_at , '+00:00', '+08:00' )) over (PARTITION by pr.staff_info_id,date(convert_tz(pr.routed_at , '+00:00', '+08:00' ) )    order by convert_tz(pr.routed_at , '+00:00', '+08:00' )))  路由间隔时间
    ##,pr.pno
    ,pr.route_action
    ,case when route_action='ACCEPT_PARCEL'  then  '接件扫描'
        when route_action='ARRIVAL_GOODS_VAN_CHECK_SCAN'  then  '车货关联到港'
        when route_action='ARRIVAL_WAREHOUSE_SCAN'  then  '到件入仓扫描'
        when route_action='CANCEL_ARRIVAL_WAREHOUSE_SCAN'  then  '取消到件入仓扫描'
        when route_action='CANCEL_PARCEL'  then  '撤销包裹'
        when route_action='CANCEL_SHIPMENT_WAREHOUSE'  then  '取消发件出仓'
        when route_action='CHANGE_PARCEL_CANCEL'  then  '修改包裹为撤销'
        when route_action='CHANGE_PARCEL_CLOSE'  then  '修改包裹为异常关闭'
        when route_action='CHANGE_PARCEL_IN_TRANSIT'  then  '修改包裹为运输中'
        when route_action='CHANGE_PARCEL_INFO'  then  '修改包裹信息'
        when route_action='CHANGE_PARCEL_SIGNED'  then  '修改包裹为签收'
        when route_action='CLAIMS_CLOSE'  then  '理赔关闭'
        when route_action='CLAIMS_COMPLETE'  then  '理赔完成'
        when route_action='CLAIMS_CONTACT'  then  '已联系客户'
        when route_action='CLAIMS_TRANSFER_CS'  then  '转交总部cs处理'
        when route_action='CLOSE_ORDER'  then  '关闭订单'
        when route_action='CONTINUE_TRANSPORT'  then  '疑难件继续配送'
        when route_action='CREATE_WORK_ORDER'  then  '创建工单'
        when route_action='CUSTOMER_CHANGE_PARCEL_INFO'  then  '客户修改包裹信息'
        when route_action='CUSTOMER_OPERATING_RETURN'  then  '客户操作退回寄件人'
        when route_action='DELIVERY_CONFIRM'  then  '确认妥投'
        when route_action='DELIVERY_MARKER'  then  '派件标记'
        when route_action='DELIVERY_PICKUP_STORE_SCAN'  then  '自提取件扫描'
        when route_action='DELIVERY_TICKET_CREATION_SCAN'  then  '交接扫描'
        when route_action='DELIVERY_TRANSFER'  then  '派件转单'
        when route_action='DEPARTURE_GOODS_VAN_CK_SCAN'  then  '车货关联出港'
        when route_action='DETAIN_WAREHOUSE'  then  '货件留仓'
        when route_action='DIFFICULTY_FINISH_INDEMNITY'  then  '疑难件支付赔偿'
        when route_action='DIFFICULTY_HANDOVER'  then  '疑难件交接'
        when route_action='DIFFICULTY_HANDOVER_DETAIN_WAREHOUSE'  then  '疑难件交接货件留仓'
        when route_action='DIFFICULTY_RE_TRANSIT'  then  '疑难件退回区域总部/重启运送'
        when route_action='DIFFICULTY_RETURN'  then  '疑难件退回寄件人'
        when route_action='DIFFICULTY_SEAL'  then  '集包异常'
        when route_action='DISCARD_RETURN_BKK'  then  '丢弃包裹的，换单后寄回BKK'
        when route_action='DISTRIBUTION_INVENTORY'  then  '分拨盘库'
        when route_action='DWS_WEIGHT_IMAGE'  then  'DWS复秤照片'
        when route_action='EXCHANGE_PARCEL'  then  '换货'
        when route_action='FAKE_CANCEL_HANDLE'  then  '虚假撤销判责'
        when route_action='FLASH_HOME_SCAN'  then  'FH交接扫描'
        when route_action='FORCE_TAKE_PHOTO'  then  '强制拍照路由'
        when route_action='HAVE_HAIR_SCAN_NO_TO'  then  '有发无到'
        when route_action='HURRY_PARCEL'  then  '催单'
        when route_action='INCOMING_CALL'  then  '来电接听'
        when route_action='INTERRUPT_PARCEL_AND_RETURN'  then  '中断运输并退回'
        when route_action='INVENTORY'  then  '盘库'
        when route_action='LOSE_PARCEL_TEAM_OPERATION'  then  '丢失件团队处理'
        when route_action='MANUAL_REMARK'  then  '添加备注'
        when route_action='MISS_PICKUP_HANDLE'  then  '漏包裹揽收判责'
        when route_action='MISSING_PARCEL_SCAN'  then  '丢失件包裹操作'
        when route_action='NOTICE_LOST_PARTS_TEAM'  then  '已通知丢失件团队'
        when route_action='PARCEL_HEADLESS_CLAIMED'  then  '无头件包裹已认领'
        when route_action='PARCEL_HEADLESS_PRINTED'  then  '无头件包裹已打单'
        when route_action='PENDING_RETURN'  then  '待退件'
        when route_action='PHONE'  then  '电话联系'
        when route_action='PICK_UP_STORE'  then  '待自提取件'
        when route_action='PICKUP_RETURN_RECEIPT'  then  '签回单揽收'
        when route_action='PRINTING'  then  '打印面单'
        when route_action='QAQC_OPERATION'  then  'QAQC判责'
        when route_action='RECEIVE_WAREHOUSE_SCAN'  then  '收件入仓'
        when route_action='RECEIVED'  then  '已揽收,初始化动作，实际情况并没有作用'
        when route_action='REFUND_CONFIRM'  then  '退件妥投'
        when route_action='REPAIRED'  then  '上报问题修复路由'
        when route_action='REPLACE_PNO'  then  '换单'
        when route_action='REPLY_WORK_ORDER'  then  '回复工单'
        when route_action='REVISION_TIME'  then  '改约时间'
        when route_action='SEAL'  then  '集包'
        when route_action='SEAL_NUMBER_CHANGE'  then  '集包件数变化'
        when route_action='SHIPMENT_WAREHOUSE_SCAN'  then  '发件出仓扫描'
        when route_action='SORTER_WEIGHT_IMAGE'  then  '分拣机复秤照片'
        when route_action='SORTING_SCAN'  then  '分拣扫描'
        when route_action='STAFF_INFO_UPDATE_WEIGHT'  then  '快递员修改重量'
        when route_action='STORE_KEEPER_UPDATE_WEIGHT'  then  '仓管员复秤'
        when route_action='STORE_SORTER_UPDATE_WEIGHT'  then  '分拣机复秤'
        when route_action='SYSTEM_AUTO_RETURN'  then  '系统自动退件'
        when route_action='TAKE_PHOTO'  then  '异常打单拍照'
        when route_action='THIRD_EXPRESS_ROUTE'  then  '第三方公司路由'
        when route_action='THIRD_PARTY_REASON_DETAIN'  then  '第三方原因滞留'
        when route_action='TICKET_WEIGHT_IMAGE'  then  '揽收称重照片'
        when route_action='TRANSFER_LOST_PARTS_TEAM'  then  '已转交丢失件团队'
        when route_action='TRANSFER_QAQC'  then  '转交QAQC处理'
        when route_action='UNSEAL'  then  '拆包'
        when route_action='UNSEAL_NO_PARCEL'  then  '上报包裹不在集包里'
        when route_action='UNSEAL_NOT_SCANNED'  then  '集包已拆包，本包裹未被扫描'
        when route_action='VEHICLE_ACCIDENT_REG'  then  '车辆车祸登记'
        when route_action='VEHICLE_ACCIDENT_REGISTRATION'  then  '车辆车祸登记'
        when route_action='VEHICLE_WET_DAMAGE_REG'  then  '车辆湿损登记'
        when route_action='VEHICLE_WET_DAMAGE_REGISTRATION'  then  '车辆湿损登记'

    end 路由动作
    ,pr.staff_info_id
    ,case WHEN hr.job_title =13 THEN 'Bike'
          WHEN hr.job_title =110 THEN 'Van'
          WHEN hr.job_title =452 THEN 'Boat'
          when hr.job_title=1000 then 'Tricycle'
    end as 岗位
    ,pr.store_id 路由发生网点
    ,hr.store_id 员工归属网点
    ,ss.name 员工归属网点名称
    ,sr.name as 员工归属网点名称area_name -- 大区,
    ,sp.name as 员工归属网点名称region_name -- 片区,

from ph_staging.parcel_route pr

join
(
    SELECT
        hr.`sys_store_id` as store_id,
        hr.staff_info_id,
        hr.job_title
    FROM `ph_bi`.`hr_staff_info` hr
    where hr.`is_sub_staff`= 0
        and hr.`state`= 1
        and  hr.job_title in ( '13', '110','1000')
        and hr.hire_date <= date_sub(CURRENT_DATE,interval 0 day)
) hr
on hr.staff_info_id=pr.staff_info_id

left join ph_staging.sys_store ss
on ss.id=hr.store_id

left join ph_staging.sys_manage_piece sp
on ss.manage_piece= sp.id

left join ph_staging.sys_manage_region sr
on ss.manage_region= sr.id

where pr.routed_at>=DATE_ADD(date_sub(convert_tz(CURRENT_DATE,'+08:00', '+00:00' ), interval 1 day),interval 6 hour)  #由于会出现十二点后由路由动作的情况，因此限制为6点过后的路由时间
    and pr.routed_at<date_sub(convert_tz(CURRENT_DATE,'+08:00', '+00:00' ), interval 0 day)
    and ss.state=1
)p1
where  p1.路由间隔时间 > 5
group by p1.staff_info_id
)



##晚上八点以后操作
,eight_act as (
##快递员、8点后首次联系在距离网点100米内并标记联系不上、拒收、改约、妥投总计包裹量、普遍的响铃时长（众数这个值）

#############求众数
###排序
select
    t1.路由日期
    ,t1.staff_info_id
    ,t1.总响铃包裹数
    ,t1.diaboloDuration
from (
SELECT
*
##,rank() over(PARTITION by 路由日期,staff_info_id  order by  diaboloDuration,次数_diaboloDuration desc )  rk
,row_number() over(PARTITION by 路由日期,staff_info_id  order by  次数_diaboloDuration desc )  rk

from (
###响铃时长计数
select
    temp.路由日期

    ,temp.staff_info_id
    ,temp.diaboloDuration##响铃时长（rk=1,众数）
    ,total_diaboloDuration.总响铃包裹数##晚上八点回网点联系的包裹量
    ,count(1)  次数_diaboloDuration##响铃时长对应的次数
    ,count(distinct temp.pno) 响铃包裹数##对应多少个包裹
    ,sum(count(1)) over(PARTITION  by temp.路由日期,temp.staff_info_id)  总次数_diaboloDuratio##累计联系次数
    #,count(distinct pno)   总响铃包裹数


from (
####半夜操作明细#############
    SELECT
        date(convert_tz(pr.routed_at , '+00:00', '+08:00' ) )  路由日期
        ,convert_tz(pr.routed_at , '+00:00', '+08:00' ) 路由时间
        ,st_distance_sphere(point(replace(json_extract(pr.extra_value, '$.lng'),'\"','')+0 ,replace(json_extract(pr.extra_value, '$.lat'),'\"','')+0),point(ss.lng,ss.lat))/1000 as 距离网点_直线距离_公里
        ,replace(json_extract(pr.extra_value, '$.diaboloDuration'),'\"','')  diaboloDuration
        ,replace(json_extract(pr.extra_value, '$.callDuration'),'\"','')   callDuration
        ,pr.pno
        ,pr.route_action
        ,pr.staff_info_id
        ,f_call.路由时间  当天该快递员第一次电话时间
        ,f_call.距离网点_直线距离_公里  当天该快递员第一次电话时间_距离网点_直线距离_公里

        ,case WHEN hr.job_title =13 THEN 'Bike'
            WHEN hr.job_title =110 THEN 'Van'
            WHEN hr.job_title =452 THEN 'Boat'
            when hr.job_title=1000 then 'Tricycle'
            end as 岗位
        ,pr.store_id 路由发生网点
        ,hr.store_id 员工归属网点
        ,ss.name 员工归属网点名称
        ,sr.name as 员工归属网点名称area_name -- 大区,
        ,sp.name as 员工归属网点名称region_name -- 片区,

    from ph_staging.parcel_route pr

     join
    (
     SELECT
          hr.`sys_store_id` as store_id,
          hr.staff_info_id,
          hr.job_title
      FROM `ph_bi`.`hr_staff_info` hr
      where hr.`is_sub_staff`= 0
          and hr.`formal`= 1
          and hr.`state`= 1
          and  hr.job_title in ( '13', '110','1000')
          and hr.hire_date <= date_sub(CURRENT_DATE,interval 0 day)
    ) hr
    on hr.staff_info_id=pr.staff_info_id

    #标记为联系不上客户,八点后标记，且离网点五百米内
    join
    (
        select *
        from (
            SELECT
                pr.staff_info_id
                ,date(convert_tz(pr.routed_at,'+00:00','+08:00')) as routed_at
                ,pr.pno
                ,st_distance_sphere(point(replace(json_extract(pr.extra_value, '$.lng'),'\"','')+0 ,replace(json_extract(pr.extra_value, '$.lat'),'\"','')+0),point(ss.lng,ss.lat))/1000 as 距离网点_直线距离_公里
            from ph_staging.parcel_route pr

            left join ph_staging.parcel_info pi
            ON pi.pno = pr.pno

            left join ph_staging.sys_store ss
            on ss.id=pi.dst_store_id
            WHERE 1=1
              ##AND pr.marker_category IN (2,17,9,14,70,15,71,16,1,40,29,78,25,75,23,73,7,22,6,21,5,20,4,19) # 2 17拒收 9 14 70 改约 15 71 运力不足
              AND pr.route_action = 'DELIVERY_MARKER' #派件标记
              and pr.routed_at>=DATE_ADD(date_sub(convert_tz(CURRENT_DATE,'+08:00', '+00:00' ), interval 1 day),interval 20 hour)  #20点过后的路由时间
              and pr.routed_at<DATE_ADD(date_sub(convert_tz(CURRENT_DATE,'+08:00', '+00:00' ), interval 0 day) ,interval 1 hour)
              and   pr.marker_category in ('1','2','70','71')##=1  #'联系不上包裹数'
              and ss.state=1
        )temp
        where temp.距离网点_直线距离_公里<0.1
    )  DELIVERY_MARKER
    on DELIVERY_MARKER.pno=pr.pno
    and DELIVERY_MARKER.routed_at=date(convert_tz(pr.routed_at , '+00:00', '+08:00' ) )
    and DELIVERY_MARKER.staff_info_id=pr.staff_info_id

    left join ph_staging.sys_store ss
    on ss.id=hr.store_id

    left join ph_staging.sys_manage_piece sp
    on ss.manage_piece= sp.id

    left join ph_staging.sys_manage_region sr
    on ss.manage_region= sr.id

    left join (
    #####包裹第一次电话联系时间
        select *
        from (
            SELECT
                date(convert_tz(pr.routed_at , '+00:00', '+08:00' ) )  路由日期
                ,convert_tz(pr.routed_at , '+00:00', '+08:00' ) 路由时间
                ,st_distance_sphere(point(replace(json_extract(pr.extra_value, '$.lng'),'\"','')+0 ,replace(json_extract(pr.extra_value, '$.lat'),'\"','')+0),point(ss.lng,ss.lat))/1000 as 距离网点_直线距离_公里
                ,replace(json_extract(pr.extra_value, '$.diaboloDuration'),'\"','')  diaboloDuration
                ,replace(json_extract(pr.extra_value, '$.callDuration'),'\"','')   callDuration
                ,pr.pno
                ,pr.staff_info_id
                ,case WHEN hr.job_title =13 THEN 'Bike'
                WHEN hr.job_title =110 THEN 'Van'
                WHEN hr.job_title =452 THEN 'Boat'
                when hr.job_title=1000 then 'Tricycle'
                end as 岗位
                ,pr.store_id 路由发生网点
                ,hr.store_id 员工归属网点
                ,ss.name 员工归属网点名称
                ,sr.name as 员工归属网点名称area_name -- 大区,
                ,sp.name as 员工归属网点名称region_name -- 片区,
                ,rank() over(PARTITION by pr.staff_info_id ,pr.pno ,date(convert_tz(pr.routed_at , '+00:00', '+08:00' ) )  order by pr.routed_at)  rk
            from ph_staging.parcel_route pr
            join
                (
                 SELECT
                      hr.`sys_store_id` as store_id,
                      hr.staff_info_id,
                      hr.job_title
                  FROM `ph_bi`.`hr_staff_info` hr
                  where hr.`is_sub_staff`= 0
                      and hr.`formal`= 1
                      and hr.`state`= 1
                      and  hr.job_title in ( '13', '110','1000')
                      and hr.hire_date <= date_sub(CURRENT_DATE,interval 0 day)
                ) hr
                on hr.staff_info_id=pr.staff_info_id
            left join ph_staging.sys_store ss
            on ss.id=hr.store_id
            left join ph_staging.sys_manage_piece sp
            on ss.manage_piece= sp.id
            left join ph_staging.sys_manage_region sr
            on ss.manage_region= sr.id
            where pr.routed_at>=DATE_ADD(date_sub(convert_tz(CURRENT_DATE,'+08:00', '+00:00' ), interval 1 day),interval 6 hour)  #6点过后的路由时间
              and pr.routed_at<DATE_ADD(date_sub(convert_tz(CURRENT_DATE,'+08:00', '+00:00' ), interval 0 day) ,interval 1 hour)
              and ss.state=1
              and pr.route_action='PHONE'
        )pr
        where pr.rk=1
    )  f_call
    on f_call.路由日期=date(convert_tz(pr.routed_at , '+00:00', '+08:00' ) )
    and f_call.staff_info_id=pr.staff_info_id
    and f_call.pno=pr.pno


    where pr.routed_at>=DATE_ADD(date_sub(convert_tz(CURRENT_DATE,'+08:00', '+00:00' ), interval 1 day),interval 20 hour)  #20点过后的路由时间
      and pr.routed_at<DATE_ADD(date_sub(convert_tz(CURRENT_DATE,'+08:00', '+00:00' ), interval 0 day) ,interval 1 hour)
      and ss.state=1
      and pr.route_action="PHONE"
      #第一电话是再网点打的，且八点后
      and  f_call.距离网点_直线距离_公里<0.1
      and hour(f_call.路由时间)>=20
) temp


#总响铃包裹数，第一电话是再网点打的，且八点后
left join (
    ###响铃时长计数
    select
    路由日期
    ,staff_info_id
    ,count(distinct pno) 总响铃包裹数
    from
    (
    ####半夜操作明细#############
    SELECT
        date(convert_tz(pr.routed_at , '+00:00', '+08:00' ) )  路由日期
        ,convert_tz(pr.routed_at , '+00:00', '+08:00' ) 路由时间
        ,st_distance_sphere(point(replace(json_extract(pr.extra_value, '$.lng'),'\"','')+0 ,replace(json_extract(pr.extra_value, '$.lat'),'\"','')+0),point(ss.lng,ss.lat))/1000 as 距离网点_直线距离_公里
        ,replace(json_extract(pr.extra_value, '$.diaboloDuration'),'\"','')  diaboloDuration
        ,replace(json_extract(pr.extra_value, '$.callDuration'),'\"','')   callDuration
        ,pr.pno
        ,pr.route_action
        ,pr.staff_info_id
        ,f_call.路由时间  当天该快递员第一次电话时间
        ,f_call.距离网点_直线距离_公里  当天该快递员第一次电话时间_距离网点_直线距离_公里

        ,case WHEN hr.job_title =13 THEN 'Bike'
        WHEN hr.job_title =110 THEN 'Van'
        WHEN hr.job_title =452 THEN 'Boat'
        when hr.job_title=1000 then 'Tricycle'
        end as 岗位
        ,pr.store_id 路由发生网点
        ,hr.store_id 员工归属网点
        ,ss.name 员工归属网点名称

    from ph_staging.parcel_route pr

    join (
        SELECT
            hr.`sys_store_id` as store_id,
            hr.staff_info_id,
            hr.job_title
        FROM `ph_bi`.`hr_staff_info` hr
        where hr.`is_sub_staff`= 0
          and hr.`formal`= 1
          and hr.`state`= 1
          and  hr.job_title in ( '13', '110','1000')
          and hr.hire_date <= date_sub(CURRENT_DATE,interval 0 day)
    ) hr
    on hr.staff_info_id=pr.staff_info_id

    #标记为联系不上客户,八点后标记，且离网点五百米内
    join
    (

        select
        *
        from (

            SELECT

                pr.staff_info_id
                ,date(convert_tz(pr.routed_at,'+00:00','+08:00')) as routed_at
                ,pr.pno
                ,st_distance_sphere(point(replace(json_extract(pr.extra_value, '$.lng'),'\"','')+0 ,replace(json_extract(pr.extra_value, '$.lat'),'\"','')+0),point(ss.lng,ss.lat))/1000 as 距离网点_直线距离_公里

            from ph_staging.parcel_route pr

            left join ph_staging.parcel_info pi
            ON pi.pno = pr.pno

            left join ph_staging.sys_store ss
            on ss.id=pi.dst_store_id

            WHERE 1=1
                ##AND pr.marker_category IN (2,17,9,14,70,15,71,16,1,40,29,78,25,75,23,73,7,22,6,21,5,20,4,19) # 2 17拒收 9 14 70 改约 15 71 运力不足
                AND pr.route_action = 'DELIVERY_MARKER' #派件标记
                and pr.routed_at>=DATE_ADD(date_sub(convert_tz(CURRENT_DATE,'+08:00', '+00:00' ), interval 1 day),interval 20 hour)  #20点过后的路由时间
                and pr.routed_at<DATE_ADD(date_sub(convert_tz(CURRENT_DATE,'+08:00', '+00:00' ), interval 0 day) ,interval 1 hour)
                and   pr.marker_category in ('1','2','70','71') #=1  #'联系不上包裹数'
                and ss.state=1
            )temp
            where temp.距离网点_直线距离_公里<0.1
    )  DELIVERY_MARKER
    on DELIVERY_MARKER.pno=pr.pno
    and DELIVERY_MARKER.routed_at=date(convert_tz(pr.routed_at , '+00:00', '+08:00' ) )
    and DELIVERY_MARKER.staff_info_id=pr.staff_info_id



    left join ph_staging.sys_store ss
    on ss.id=hr.store_id

    left join ph_staging.sys_manage_piece sp
    on ss.manage_piece= sp.id

    left join ph_staging.sys_manage_region sr
    on ss.manage_region= sr.id

    left join (
    #####包裹第一次电话联系时间
    select
    *
    from (
        SELECT
        date(convert_tz(pr.routed_at , '+00:00', '+08:00' ) )  路由日期
        ,convert_tz(pr.routed_at , '+00:00', '+08:00' ) 路由时间
        ,st_distance_sphere(point(replace(json_extract(pr.extra_value, '$.lng'),'\"','')+0 ,replace(json_extract(pr.extra_value, '$.lat'),'\"','')+0),point(ss.lng,ss.lat))/1000 as 距离网点_直线距离_公里
        ,replace(json_extract(pr.extra_value, '$.diaboloDuration'),'\"','')  diaboloDuration
        ,replace(json_extract(pr.extra_value, '$.callDuration'),'\"','')   callDuration
        ,pr.pno

        ,pr.staff_info_id
        ,case WHEN hr.job_title =13 THEN 'Bike'
        WHEN hr.job_title =110 THEN 'Van'
        WHEN hr.job_title =452 THEN 'Boat'
        when hr.job_title=1000 then 'Tricycle'
        end as 岗位
        ,pr.store_id 路由发生网点
        ,hr.store_id 员工归属网点
        ,ss.name 员工归属网点名称
        ,sr.name as 员工归属网点名称area_name -- 大区,
        ,sp.name as 员工归属网点名称region_name -- 片区,
        ,rank() over(PARTITION by pr.staff_info_id ,pr.pno ,date(convert_tz(pr.routed_at , '+00:00', '+08:00' ) )  order by pr.routed_at)  rk

        from ph_staging.parcel_route pr

         join
        (
         SELECT
                         hr.`sys_store_id` as store_id,
                       hr.staff_info_id,
                       hr.job_title
                   FROM `ph_bi`.`hr_staff_info` hr
                   where hr.`is_sub_staff`= 0
                   and hr.`formal`= 1
                   and hr.`state`= 1
                   and  hr.job_title in ( '13', '110','1000')
                   and hr.hire_date <= date_sub(CURRENT_DATE,interval 0 day)
        ) hr
        on hr.staff_info_id=pr.staff_info_id

        left join ph_staging.sys_store ss
        on ss.id=hr.store_id

        left join ph_staging.sys_manage_piece sp
                on ss.manage_piece= sp.id
                left join ph_staging.sys_manage_region sr
                on ss.manage_region= sr.id

        where

        pr.routed_at>=DATE_ADD(date_sub(convert_tz(CURRENT_DATE,'+08:00', '+00:00' ), interval 1 day),interval 6 hour)  #6点过后的路由时间
        and pr.routed_at<DATE_ADD(date_sub(convert_tz(CURRENT_DATE,'+08:00', '+00:00' ), interval 0 day) ,interval 1 hour)

        and ss.state=1
        and pr.route_action='PHONE'
        )
        pr
        where pr.rk=1
    )  f_call
    on f_call.路由日期=date(convert_tz(pr.routed_at , '+00:00', '+08:00' ) )
    and f_call.staff_info_id=pr.staff_info_id
    and f_call.pno=pr.pno


    where pr.routed_at>=DATE_ADD(date_sub(convert_tz(CURRENT_DATE,'+08:00', '+00:00' ), interval 1 day),interval 20 hour)  #20点过后的路由时间
        and pr.routed_at<DATE_ADD(date_sub(convert_tz(CURRENT_DATE,'+08:00', '+00:00' ), interval 0 day) ,interval 1 hour)

        and ss.state=1
        and pr.route_action="PHONE"
        #第一电话是再网点打的，且八点后
        and  f_call.距离网点_直线距离_公里<0.1
        and hour(f_call.路由时间)>=20
    )
    group by 1,2
) total_diaboloDuration
on total_diaboloDuration.路由日期=temp.路由日期 and total_diaboloDuration.staff_info_id=temp.staff_info_id

group by 1,2,3,4

)temp

)t1
where t1.rk = 1
group by t1.路由日期
    ,t1.staff_info_id
    ,t1.总响铃包裹数
    ,t1.diaboloDuration

)



select m1.*
,if(m1.是否应出勤 in ('应出勤') and m1.近14天排班旷工次数 >= 3 ,0.05,0) as 旷工_系数
,if(m1.是否应出勤 not in ('无需出勤') and m1.迟到情况 in ('迟到30min以上') and m1.近14天排班迟到30min以上次数 >= 3 ,0.05,0) as 迟到_系数
,if(m1.最早交接时间晚 in ('交接晚_第一趟正班车8:30分前到港_最早交接时间晚于10:00','交接晚_第一趟正班车到港后1.5h后未开始交接'),0.1,0) as 最早交接时间晚_系数
,if(m1.交接2h包裹比例 in ('2h内交接包裹量低于90') and m1.截至12点交接包裹比例 < 0.4 ,0.1,0) as 交接时间长_系数
,if(m1.交接量少 in ('低于同级别区域人均交接量的20%') ,0.1,0) as 交接量少_系数
,if(m1.交接非绑定区域包裹量比例  <= 0.2 ,0,0.1) as 乱交接_系数
,if(m1.出门晚 in ('最早妥投时间晚于比武规定时间') ,0.1,0) as 出门晚_系数
,if(m1.派件结束早 in ('15点前结束派件&妥投率低于70%'),0.1,0) as 派件结束早_系数
,if(m1.妥投量少 in ('低于同级别区域人均妥投量的20%'),0.1,0) as 妥投量少_系数
,if(m1.疑似存在偷懒 in ('存在5h以上无路由动作') ,0.05,0) as 疑似存在偷懒_系数
,if(m1.当日标记问题件数量多 in ('当日标记问题件数（拒收、运力不足、改约、联系不上）为交接包裹量的30%以上'),0.1,0) as 标记问题件多_系数
,if(m1.当日20点之后在网点100内进行首次联系的包裹量  > 15 ,0.05,0) as 回网点批量操作_系数

from (

SELECT
swrd.stat_date            统计日期
,swrd.staff_info_id       员工ID
,swrd.staff_name          员工姓名
,swrd.store_id            归属网点ID
,swrd.store_name          归属网点名称
,swrd.store_category_desc 网点类型描述
,swrd.tiktok_area         区域TT
,swrd.region_name         归属大区
,case
    when swrd.region_name in ('Area3', 'Area6') then '彭万松'
    when swrd.region_name in ('Area4', 'Area9') then '韩钥'
    when swrd.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
    when swrd.region_name in ( 'Area8') then '黄勇'
    when swrd.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
end                       管理者
,swrd.piece_name          归属片区
,swrd.staff_attr          员工属性
,CASE
        WHEN swrd.job_title = 13  THEN 'Bike'
        WHEN swrd.job_title = 110 THEN 'VAN'
        WHEN swrd.job_title = 452 THEN 'Boat'
        WHEN swrd.job_title = 1000 THEN 'Tricycle'
    END AS      员工岗位
,swrd.hire_days           员工在职天数
,swrd.work_store_id       工作网点ID
,swrd.work_store_name     工作网点名称
,swrd.state_desc                状态描述
,swrd.wait_leave_state          是否待离职
##,swa.shift_start                班次开始时间
##,swa.shift_end                  班次结束时间
,if(swa.shift_start is not null,swa.shift_start,staff_id.shift_start)     班次开始时间
,if(swa.shift_end is not null,swa.shift_end,staff_id.shift_end)           班次结束时间

##,swrd.is_plan_rest              是否排休
,swrd.attendance_started_at     上班打卡时间
,swrd.attendance_end_at         下班打卡时间
,swrd.attendance_hour           打卡时长
,swrd.迟到时长                   迟到时长

,staff_id.plan                  是否应出勤
,staff_id.is_AB                 出勤情况
,if(staff_absence.staff_info_id is not null,staff_absence.absence,null) 近14天排班旷工次数

##,swrd.迟到情况                   迟到情况
,staff_id.chidao_ty             迟到情况
,if(staff_absence.staff_info_id is not null,staff_absence.late_30min,null) 近14天排班迟到30min以上次数

,tdm.time_one                   交接第1件包裹时间
,tdm.time_two                   交接第2件包裹时间
,tdm.time_three                 交接第3件包裹时间
,tdm.time_four                  交接第4件包裹时间
,tdm.time_five                  交接第5件包裹时间
,case when date_format(ft.plan_arrive_first,'%Y-%m-%d %H:%i') is not null and date_format(ft.arrive_time_first,'%Y-%m-%d %H:%i') is null then '规划但无正班车到达'
    when date_format(ft.plan_arrive_first,'%Y-%m-%d %H:%i') is null and date_format(ft.arrive_time_first,'%Y-%m-%d %H:%i') is null then '未规划&无正班车到达'
    when date_format(ft.arrive_time_first,'%Y-%m-%d %H:%i') is null then '无正班车'
    when date_format(ft.arrive_time_first,'%H:%i') <= '08:30' and date_format(swrd.最早交接时间,'%H:%i') > '10:00' then '交接晚_第一趟正班车8:30分前到港_最早交接时间晚于10:00'
    when date_format(ft.arrive_time_first,'%H:%i') > '08:30' and date_format(swrd.最早交接时间,'%H:%i') >  date_format(date_add(ft.arrive_time_first,interval 150 minute),'%H:%i') then '交接晚_第一趟正班车到港后1.5h后未开始交接'
else '其他' end                 最早交接时间晚
,case when dp.2h_percentage = 0 or dp.2h_percentage is null then 'null'
    when dp.2h_percentage < 0.9 then '2h内交接包裹量低于90%'
else '2h内交接包裹量高于90%' end as 交接2h包裹比例
,dp.12_percentage 截至12点交接包裹比例
,swrd.交接量
##,swrd.handover_par_cnt
,area_delivery.交接区域数量_all 交接区域数量
,area_delivery.交接区域数量     交接区域数量_提除交接少于4的区域
,area_delivery.交接情况         交接区域情况
,sde.pnos_wrong_bili      交接非绑定区域包裹量比例

,h14.per_capita_handover      近14天人均交接量
,case when swrd.交接量 < h14.per_capita_h then '低于同级别区域人均交接量的20%' else null end as 交接量少
,sdbsi.三段码绑定数量
,sdbsi.三段码绑定情况
,sdbsi.barangay绑定数量
,sdbsi.绑定明细情况

,swrd.最早派件时间       最早妥投时间
,swrd.delivery_end_at2 倒数第二件妥投时间
,swrd.最近派件时间       最晚妥投时间
,case when time(swrd.最早派件时间) > ft.min_tuotou_time then '最早妥投时间晚于比武规定时间' else null end as 出门晚
,case when swrd.`派件/交接` < 0.7 and date_format(swrd.最近派件时间,'%H:%i') < '15:00' then '15点前结束派件&妥投率低于70%' else null end as 派件结束早
,swrd.当天派件数 as 妥投量
,f14.per_capita_finished 近14天人均妥投量
,case when swrd.当天派件数 < f14.per_capita_f then '低于同级别区域人均妥投量的20%' else null end as 妥投量少


,case when prout.staff_info_id is not null then '存在5h以上无路由动作'  else null end as 疑似存在偷懒
,CASE WHEN (swrd.work_store_name like '%_SP%'
    and ((
        ifnull(swrd.拒收包裹数,0)
        +ifnull(swrd.运力不足包裹数,0)
        +ifnull(swrd.改约包裹数,0)
        +ifnull(swrd.客户不在家_电话无人接听包裹数,0)
        )/swrd.交接量) > 0.3)
    THEN '当日标记问题件数（拒收、运力不足、改约、联系不上）为交接包裹量的30%以上'
    END 当日标记问题件数量多
,ea.总响铃包裹数 当日20点之后在网点100内进行首次联系的包裹量
,ea.diaboloDuration 电话联系响铃时长（众数）

,swrd.拒收包裹数
,swrd.运力不足包裹数
,swrd.改约包裹数
,swrd.客户不在家_电话无人接听包裹数
,swrd.收件人号码空号包裹数
,swrd.收件人号码错误包裹数
,swrd.收件人地址不清晰或不正确包裹数
,swrd.货物丢失包裹数
,swrd.货物短少包裹数
,swrd.货物破损包裹数
,swrd.外包装破损包裹数
,swrd.禁运品包裹数
,swrd.其他派件标记包裹数

,nwrd.当日应派  as 网点当日应派包裹量
,nwrd.当日到件入仓量
,nwrd.当日应派交接 as 网点当日应派交接包裹量
,nwrd.当日应派妥投 as 网点当日应派妥投包裹量
,nwrd.应派交接率   as 网点当日应派交接率
,nwrd.妥投率      as 网点当日应派妥投率
,nwrd.积压量
,nwrd.未交接量
,swrd.`网点当日派件人数`
,a.staff_cut 网点当日交接的快递员人数
,a.avg_decnt 网点人均可交接量


,swrd.`派件间隔(分钟)` '派件间隔(分钟)'
,swrd.`派件/交接` '妥投率'
,swrd.`交接5KG以上`
,swrd.`妥投5KG以上`
,swrd.`网点50米内派件量`
,swrd.`人效排名`



FROM main as swrd ## 快递员每日工作情况播报

LEFT JOIN tmpale.network_work_report_daily nwrd ## 网点每日工作情况播报
on swrd.work_store_name = nwrd.网点

##left join ph_bi.hr_staff_info hsi ##员工表
##on swrd.staff_info_id = hsi.staff_info_id

##left join ph_staging.sys_store ss ##网点表
##on hsi.sys_store_id = ss.id
##left join ph_staging.sys_manage_piece smp ##大区
##on smp.id=ss.manage_piece
##left join ph_staging.sys_manage_region smr ##片区
##on smr.id=ss.manage_region

LEFT JOIN ph_backyard.staff_work_attendance swa ##员工考勤表
ON swa.staff_info_id = swrd.staff_info_id and swa.attendance_date = swrd.stat_date
##AND swa.attendance_date = DATE(convert_tz(NOW(),'+08:00','+08:00'))


left join should_delivery as a
on a.store_id = swrd.work_store_id and a.stat_date=swrd.stat_date


left join car_arrive as ft
##日期+网点关联
on ft.next_store_id = swrd.work_store_id  and ft.proof_dt = swrd.stat_date

left join staff_delivery_code as sdbsi
# 快递员绑定情况
on sdbsi.store_id = swrd.store_id and sdbsi.staff_info_id = swrd.staff_info_id

left join staff_de sde on sde.staff_info_id = swrd.staff_info_id

#left join staff_delivery as m1
#on m1.delivery_dt = swrd.stat_date and m1.staff_info_id = swrd.staff_info_id and m1.store_name = swrd.当日所属网点

left join area_delivery on swrd.staff_info_id = area_delivery.员工ID


left join staff_id on staff_id.stat_date = swrd.stat_date and staff_id.staff_info_id = swrd.staff_info_id

left join staff_absence on staff_absence.staff_info_id = swrd.staff_info_id

left join ticket_delivery_min5 tdm on tdm.staff_info_id = swrd.staff_info_id

left join delivery_percentage dp on dp.staff_info_id = swrd.staff_info_id

left join handover_14days h14 on h14.area_name = swrd.tiktok_area and h14.manage_region = swrd.region_name

left join finished_14days f14 on f14.area_name = swrd.tiktok_area and f14.manage_region = swrd.region_name

left join eight_act as ea on ea.staff_info_id = swrd.staff_info_id and  ea.路由日期 = swrd.stat_date

left join prout on prout.staff_info_id = swrd.staff_info_id

WHERE date(swrd.stat_date) = date_sub(curdate(),interval 1 day)
and date(nwrd.统计日期) = date_sub(curdate(),interval 1 day)
and swrd.job_title in ('13','110','452','1000')

group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41
,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81
,82,83,84,85,86,87,88,89
)m1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        hsi.staff_info_id
        ,hsi.sys_store_id
        ,dp.on_emp_cnt
    from ph_bi.hr_staff_info hsi
    left join dwm.dwm_ph_network_wide_s dp on dp.store_id = hsi.sys_store_id and dp.stat_date = '2023-09-07'
    where
        hsi.staff_info_id in ('164967','164542','162414','164122','144323','161538','163540','164178','157428','158174','144145','162218','144557','165049','151151','152733','146976','155599','128331','158200','141418','143131','162964','161256','141319','163163','159579','130732','148142','155212','162836','155596','134588','154872','129689','162177','144776','161197','148083','156689','159242','153953','156346','152375','157321','153879','162281','144316','152683','154768','163634','162220','142365','157347','162207','162558','159003','143614','155128','160443','166347','127509','166085','166379','152108','121489','163011','161741','153174','147088','154865','155840','160778','159006','145826','139753','132687','159114','153066','151761','160258','157649','159824','162573','155835','164744','166179','120239','133206','159130','134802','160890','162811','165273','160019','147962','146632','143238','161094','155172','150100','150598','158727','132530','155259','145964','152922','150338','149692','159550','147911','163933','152055','162811','149799','148178','143422','162675','152387','142343','149274','141419','163312','164695','160485','166338','146817','164972','156965','155162','164335','125995','135476','164552','153874','150640','153948','150193','160763','145386','150384','137240','159939')
)
select
    t1.staff_info_id
    ,t1.sys_store_id 所属网点ID
    ,t1.on_emp_cnt 所属网点快递员数
    ,a.pi_count 揽收量
    ,a.no_return_count 正向揽收量
from t t1
left join
    (
        select
            t1.staff_info_id
            ,count(pi.pno) pi_count
            ,count(if(pi.returned = 0, pi.pno, null)) no_return_count
        from ph_staging.parcel_info pi
        join t t1 on t1.staff_info_id = pi.ticket_pickup_staff_info_id
        where
            pi.created_at >= '2023-09-06 16:00:00'
            and pi.created_at < '2023-09-07 16:00:00'
            and pi.state < 9
        group by 1
    ) a on a.staff_info_id = t1.staff_info_id;
;-- -. . -..- - / . -. - .-. -.--
select
    hsi.staff_info_id
    ,dp.store_name
    ,dp.piece_name
    ,dp.region_name
from ph_bi.hr_staff_info hsi
left join  dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi.sys_store_id and dp.stat_date = '2023-09-07'
where
    hsi.staff_info_id in ('143570','136488','127380','151910','122893','120156','120770','147668','164159','141652','141328','165936','161812','145180','143571','160280','164557','148940','133833','161313','156661','120611','141195','148356','166003','128792','143325','146366','165973','162934','145884','156086','128873','153606','163124','150635','142155','122788','147416','146856','138134','148747','148111','162743','165598','162519','133407','158301','156107','149787','159239','165834','158922','121928','122624','136312','138703','151162','139391','150162','151987','139480','148654','141384','119309','135218','129357','163686','165051','129003','152703','155262','125915','127043','140249','142850','120213','135239','157514','158830','158717','160793','149035','131010','149004','128031','159995','160559','155575','120323','143997','153933','128295','139295','165765','147973','121314','163778','139853','134272','164985','156634','165129','160807','136970','126451','121270','151961','154735','126897','144055','134601','146209','128306','147008','147592','120144','141102','119381','151102','136244','154612','131470','147364','141280','129468','130494','158205','130236','156307','165610','124359','155169','157685','156469','163691','165296','148727','164785','155435','147889','160428','138691','144437','141914','129483','119625','128730','162440','165962','138279','128144','131805','144949','136254','155367','136418','149547','127834','128139','152571','163528','149229','135031','127118','164712','126411','142725','128667','139185','149194','138913','147053','151436','147902','122749','126789','131076','164568','155146','142663','144438','119895','142162','136576','163929','165616','126311','165590','156466','147186','165237','146196','160814','164238','156675','157658','157855','124237','148287','137930','150181','125275','157225','162492','159332','131774','150940','128428','151797','151972','142203','146657','158994','163440','135544','151657','157060','157431','151613','161041','134123','122576','156568','126198','165785','155620','148396','127225','120658','157033','156857','141574','133888','163270','154827','160246','135787','149910','122302','146737','162424','164373','162919','161717','156367','148955','150281','163397','164570','120252','122483','122833','161562','133840','157671','152990','142685','140925','143703','123276','138360','163104','162113','163025','127931','155637','150677','132280','120914','135622','120471','157692','163108','131033','135785','123682','163169','164679','151144','122961','121364','158293','132246','158075','149374','147626','153538','164347','147958','165992','162477','145191','122855','146101','136854','143969','127910','129197','156087','136318','166308','148346','163805','121592','148847','146813','141932','130533','162679','119839','146172','165536','148797','129521','127909','121755','126685','152374','130109','150760','159753','161523','158139','162334','165576','138143','164651','120007','137809','151773','120307','131039','133430','164798','156730','146277','133728','134171','143694','128622','122404','139740','138243','163625','146215','124578','149358','164744','142592','126484','163540','145223','158995','150594','164970','127775','162977','154250','133689','121412','129363');
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-08'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 10
                    or (t1.total =  5 and t1.leave_time_type = 2)

                union all

                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 5
                    and t1.leave_time_type = 1 -- 上午请假
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-08'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 10
                                    or (t1.total =  5 and t1.leave_time_type = 2)

                                union all

                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 5
                                    and t1.leave_time_type = 1 -- 上午请假
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-09-08', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with d as
    (
        select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-09-08'
    )
    , t as
    (
        select
             ds.store_id
            ,ds.pno
            ,ds.stat_date
        from d ds
        left join
            (
                select
                    pr.pno
                    ,ds.stat_date
                    ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
                from ph_staging.parcel_route pr
                join d ds on pr.pno = ds.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                    and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and pr.marker_category in (42,43) ##岛屿,偏远地区
                group by 1,2
            ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
        left join
            (
                select
                   pr.pno
                    ,ds.stat_date
                   ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
                   ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
                from ph_staging.parcel_route pr
                join d ds on ds.pno = pr.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                    and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                    and pr.marker_category in (9,14,70) ##客户改约时间
            ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
        left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
        where
            case
                when pr1.pno is not null then 'N'
                when pr2.pno is not null then 'N'
                when ds1.pno is not null  then 'N'  else 'Y'
            end = 'Y'
    )
    select
        a.stat_date 日期
        ,a.store_id 网点ID
        ,dp.store_name 网点名称
        ,dp.opening_at 开业时间
        ,case
            when dp.region_name in ('Area3', 'Area6') then '彭万松'
            when dp.region_name in ('Area4', 'Area9') then '韩钥'
            when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
            when dp.region_name in ( 'Area8') then '黄勇'
            when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
        end 区域
        ,dp.region_name 大区
        ,dp.piece_name 片区
        ,a.应交接
        ,a.已交接
        ,concat(round(a.交接率*100,2),'%') as 交接率
        ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
        ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
        ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
        ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
        ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
    from
        (
            select
                t1.store_id
                ,t1.stat_date
                ,count(t1.pno) 应交接
                ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
            from t t1
            left join
                (
                    select
                        sc.*
                    from
                        (
                            select
                                pr.pno
                                ,pr.store_id
                                ,pr.store_name
                                ,t1.stat_date
                                ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                            from ph_staging.parcel_route pr
                            join t t1 on t1.pno = pr.pno
                            where
                                pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                               and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                              and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                        ) sc
                    where
                        sc.rk = 1
                ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
            group by 1,2
        ) a
    join
        (
            select
                sd.store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.store_id is not null
            group by 1

            union all

            select
                sd.separation_store_id store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.separation_store_id is not null
            group by 1
        ) sd on sd.store_id = a.store_id
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    where
        dp.store_category in (1,10);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-08'
        and pr.routed_at >= date_sub('2023-09-08', interval 8 hour )
        and pr.routed_at < date_add('2023-09-08', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,if(a3.self_staff_num + other_staff_num > coalesce(sdb.code_num, 0),
           case
            when a2.avg_staff_code < 2 then 'A'
            when a2.avg_staff_code >= 2 and a2.avg_staff_code < 3 then 'B'
            when a2.avg_staff_code >= 3 and a2.avg_staff_code < 4 then 'C'
            when a2.avg_staff_code >= 4 then 'D'
        end,
           case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end ) 评级
#         ,a2.code_num
#         ,a2.staff_code_num
#         ,a2.staff_num
#         ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) avg_staff_code
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-09-08'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-09-08')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-09-08'
        and pi.finished_at >= date_sub('2023-09-08', interval 8 hour )
        and pi.finished_at < date_add('2023-09-08', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-09-08'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        pi.pno
        ,case
            when bc.`client_id` is not null then bc.client_name
            when kp.id is not null and bc.client_id is null then '普通ka'
            when kp.`id` is null then '小c'
        end as client_type
        ,ss.name pick_store
        ,ss.id storeid
    from ph_staging.parcel_info pi
    left join ph_staging.sys_store ss on ss.id = pi.ticket_pickup_store_id
    left join ph_staging.ka_profile kp on kp.id = pi.client_id
    left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
    where
        pi.created_at >= '2023-07-31 16:00:00'
        and pi.created_at < '2023-08-31 16:00:00'
        and ss.category = 6 -- FH
        and pi.state < 9
),
res as
    (
        select
            t1.*
            ,min(pr.routed_at) min_route_at
        from ph_staging.parcel_route pr
        join t t1 on t1.pno = pr.pno and pr.route_action = 'RECEIVED' and pr.store_id = t1.storeid
        where
            pr.routed_at > '2023-07-31 16:00:00'
        group by 1,2,3,4
    )

select
    t1.pno 包裹
    ,t1.client_type 客户类型
    ,t1.pick_store 揽收网点
    ,convert_tz(t2.min_route_at, '+00:00', '+08:00')  收件入仓时间
    ,a.route_action 揽收后第一个有效路由
    ,a.store_name 揽收后第一个有效路由网点
    ,convert_tz(a.routed_at, '+00:00', '+08:00')  揽收后第一个有效路由时间
    ,case
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 < 24 then 0
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 >= 24 and timestampdiff(minute , t2.min_route_at, a.routed_at)/60 < 48 then 1
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 >= 48 and timestampdiff(minute , t2.min_route_at, a.routed_at)/60 < 72 then 2
        when timestampdiff(minute , t2.min_route_at, a.routed_at)/60 > 72 then 3
     end 揽收与后续第一个路由时间差
from t t1
left join res t2 on t2.pno = t1.pno
left join
    (
        select
            t2.*
            ,pr.route_action
            ,pr.store_id pr_store_id
            ,pr.store_name
            ,pr.routed_at
            ,row_number() over (partition by pr.pno order by pr.routed_at) rk
        from ph_staging.parcel_route pr
        join res t2 on t2.pno = pr.pno
        join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action
        where
            pr.routed_at > t2.min_route_at
            and pr.routed_at > '2023-07-31 16:00:00'
            and pr.store_id != t2.storeid
    ) a on a.pno = t1.pno and a.rk = 1;
;-- -. . -..- - / . -. - .-. -.--
select
    pr.pno
    ,case
        when bc.`client_id` is not null then bc.client_name
        when kp.id is not null and bc.client_id is null then '普通ka'
        when kp.`id` is null then '小c'
    end as 客户类型
    ,convert_tz(pr.routed_at, '+00:00', '+08:00') 操作时间
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end 包裹状态
from ph_staging.parcel_route pr
left join ph_staging.parcel_info pi on pi.pno = pr.pno
left join ph_staging.ka_profile kp on kp.id = pi.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
where
    pr.staff_info_id = '149733'
    and pr.routed_at >= '2023-009-07 16:00:00'
    and pr.routed_at < '2023-09-07 16:00:00'
    and pr.route_action = 'PRINT';
;-- -. . -..- - / . -. - .-. -.--
select
    pr.pno
    ,case
        when bc.`client_id` is not null then bc.client_name
        when kp.id is not null and bc.client_id is null then '普通ka'
        when kp.`id` is null then '小c'
    end as 客户类型
    ,convert_tz(pr.routed_at, '+00:00', '+08:00') 操作时间
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end 包裹状态
from ph_staging.parcel_route pr
left join ph_staging.parcel_info pi on pi.pno = pr.pno
left join ph_staging.ka_profile kp on kp.id = pi.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
where
    pr.staff_info_id = '149733'
    and pr.routed_at >= '2023-009-07 16:00:00'
    and pr.routed_at < '2023-09-07 16:00:00'
    and pr.route_action = 'PRINTING';
;-- -. . -..- - / . -. - .-. -.--
select
    pr.pno
    ,case
        when bc.`client_id` is not null then bc.client_name
        when kp.id is not null and bc.client_id is null then '普通ka'
        when kp.`id` is null then '小c'
    end as 客户类型
    ,convert_tz(pr.routed_at, '+00:00', '+08:00') 操作时间
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end 包裹状态
from ph_staging.parcel_route pr
left join ph_staging.parcel_info pi on pi.pno = pr.pno
left join ph_staging.ka_profile kp on kp.id = pi.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
where
    pr.staff_info_id = '149733'
    and pr.routed_at >= '2023-009-07 16:00:00'
    and pr.routed_at < '2023-09-08 16:00:00'
    and pr.route_action = 'PRINTING';
;-- -. . -..- - / . -. - .-. -.--
select
    pr.pno
    ,case
        when bc.`client_id` is not null then bc.client_name
        when kp.id is not null and bc.client_id is null then '普通ka'
        when kp.`id` is null then '小c'
    end as 客户类型
    ,convert_tz(pr.routed_at, '+00:00', '+08:00') 操作时间
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end 包裹状态
from ph_staging.parcel_route pr
left join ph_staging.parcel_info pi on pi.pno = pr.pno
left join ph_staging.ka_profile kp on kp.id = pi.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
where
    pr.staff_info_id = '149733'
    and pr.routed_at >= '2023-09-07 16:00:00'
    and pr.routed_at < '2023-09-08 16:00:00'
    and pr.route_action = 'PRINTING';
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-09'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 10
                    or (t1.total =  5 and t1.leave_time_type = 2)

                union all

                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 5
                    and t1.leave_time_type = 1 -- 上午请假
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '22023-09-09'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 10
                                    or (t1.total =  5 and t1.leave_time_type = 2)

                                union all

                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 5
                                    and t1.leave_time_type = 1 -- 上午请假
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('22023-09-09', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-09'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 10
                                    or (t1.total =  5 and t1.leave_time_type = 2)

                                union all

                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 5
                                    and t1.leave_time_type = 1 -- 上午请假
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-09-09', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with d as
    (
        select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-09-09'
    )
    , t as
    (
        select
             ds.store_id
            ,ds.pno
            ,ds.stat_date
        from d ds
        left join
            (
                select
                    pr.pno
                    ,ds.stat_date
                    ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
                from ph_staging.parcel_route pr
                join d ds on pr.pno = ds.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                    and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and pr.marker_category in (42,43) ##岛屿,偏远地区
                group by 1,2
            ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
        left join
            (
                select
                   pr.pno
                    ,ds.stat_date
                   ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
                   ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
                from ph_staging.parcel_route pr
                join d ds on ds.pno = pr.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                    and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                    and pr.marker_category in (9,14,70) ##客户改约时间
            ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
        left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
        where
            case
                when pr1.pno is not null then 'N'
                when pr2.pno is not null then 'N'
                when ds1.pno is not null  then 'N'  else 'Y'
            end = 'Y'
    )
    select
        a.stat_date 日期
        ,a.store_id 网点ID
        ,dp.store_name 网点名称
        ,dp.opening_at 开业时间
        ,case
            when dp.region_name in ('Area3', 'Area6') then '彭万松'
            when dp.region_name in ('Area4', 'Area9') then '韩钥'
            when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
            when dp.region_name in ( 'Area8') then '黄勇'
            when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
        end 区域
        ,dp.region_name 大区
        ,dp.piece_name 片区
        ,a.应交接
        ,a.已交接
        ,concat(round(a.交接率*100,2),'%') as 交接率
        ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
        ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
        ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
        ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
        ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
    from
        (
            select
                t1.store_id
                ,t1.stat_date
                ,count(t1.pno) 应交接
                ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
            from t t1
            left join
                (
                    select
                        sc.*
                    from
                        (
                            select
                                pr.pno
                                ,pr.store_id
                                ,pr.store_name
                                ,t1.stat_date
                                ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                            from ph_staging.parcel_route pr
                            join t t1 on t1.pno = pr.pno
                            where
                                pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                               and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                              and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                        ) sc
                    where
                        sc.rk = 1
                ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
            group by 1,2
        ) a
    join
        (
            select
                sd.store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.store_id is not null
            group by 1

            union all

            select
                sd.separation_store_id store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.separation_store_id is not null
            group by 1
        ) sd on sd.store_id = a.store_id
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    where
        dp.store_category in (1,10);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-09'
        and pr.routed_at >= date_sub('2023-09-09', interval 8 hour )
        and pr.routed_at < date_add('2023-09-09', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,if(a3.self_staff_num + other_staff_num > coalesce(sdb.code_num, 0),
           case
            when a2.avg_staff_code < 2 then 'A'
            when a2.avg_staff_code >= 2 and a2.avg_staff_code < 3 then 'B'
            when a2.avg_staff_code >= 3 and a2.avg_staff_code < 4 then 'C'
            when a2.avg_staff_code >= 4 then 'D'
        end,
           case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end ) 评级
#         ,a2.code_num
#         ,a2.staff_code_num
#         ,a2.staff_num
#         ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) avg_staff_code
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-09-09'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-09-09')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-09-09'
        and pi.finished_at >= date_sub('2023-09-09', interval 8 hour )
        and pi.finished_at < date_add('2023-09-09', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-09-09'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        hsi.staff_info_id
        ,hsi.sys_store_id
        ,dp.on_emp_cnt
    from ph_bi.hr_staff_info hsi
    left join dwm.dwm_ph_network_wide_s dp on dp.store_id = hsi.sys_store_id and dp.stat_date = '2023-09-08'
    where
        hsi.staff_info_id in ('162111','142269','162250','154819','127556','154394','158716','163312','154811','158031','159605','136187','162206','165787','149314','154880','145278','149274','164799','163655','152639','158335','163540','161053','157797','142928','159232','122661','158006','162167','166156','161019','159142','158452','128350','156346','152683','132720','148257','154261','144316','150502','162328','149102','163291','143224','159038','143822','141563','157322','158886','144776','156563','145655','154872','159363','153485','162407','144810','160747','154768','162220','159237','128337','130753','137624','159200','164428','161745','144557','165024','155212','136832','154831','166532','125426','145528','119296','153470','133823','163489','154034','161451','164876','147595','156556','149728','156733','164372','147053','141024','158174','141431','162513','163103','123253','154579','155840','151761','139697','145445','148488','143958','155247','152741','139796','161867','140269','162702','147217','160184','163800','143637','159222','161403','132682','153417','152555','136363','153365','161741','144240','163149','152389','156832','162273','159824','153416','132322','156659','150598','152922','163478','159945','160019','162655','140194','164818','161996','163669','143515','132226','133206','159360','151491')
)
select
    t1.staff_info_id
    ,t1.sys_store_id 所属网点ID
    ,t1.on_emp_cnt 所属网点快递员数
    ,a.pi_count 揽收量
    ,a.no_return_count 正向揽收量
from t t1
left join
    (
        select
            t1.staff_info_id
            ,count(pi.pno) pi_count
            ,count(if(pi.returned = 0, pi.pno, null)) no_return_count
        from ph_staging.parcel_info pi
        join t t1 on t1.staff_info_id = pi.ticket_pickup_staff_info_id
        where
            pi.created_at >= '2023-09-07 16:00:00'
            and pi.created_at < '2023-09-08 16:00:00'
            and pi.state < 9
        group by 1
    ) a on a.staff_info_id = t1.staff_info_id;
;-- -. . -..- - / . -. - .-. -.--
select
     oi.client_id as '客户ID client_id'
    , oi.ka_warehouse_id as '仓库ID warehouse_id'
    , kw.out_client_id as '卖家ID_Seller_ID'
    , oi.src_name as '卖家名称 Seller_name'
	, bpt.tracking_no as '回调系统运单号 system TN'
	, bpt.pno as '内部运单号 internal TN'
    , if(pi.returned=1,'退件单','正向单') as '是否退件单号 if return TN'
    , case when pi.state = 1 then '已揽收'
	    when pi.state = 2 then '运输中'
	    when pi.state = 3 then '派送中'
	    when pi.state = 4 then '已滞留'
	    when pi.state = 5 then '已签收'
	    when pi.state = 6 then '疑难件处理中'
	    when pi.state = 7 then '已退件'
	    when pi.state = 8 then '异常关闭'
	    when pi.state = 9 then '已撤销'
		end as '包裹最新状态 latest parcel status'
    , di.疑难件上报时间 as '疑难件上报时间 problematic parcel reporting time'
    , di.疑难件原因 as  '疑难件原因 problematic resaon'
    , di.疑难件处理机构  as '疑难件处理机构 problematic department'
    , di.疑难件处理情况 as '疑难件处理情况 problematic status'

    , ssd.src_store as '揽收网点 pickup DC'
    , ssd.src_piece as '揽收片区 pickup piece'
    , ssd.src_region as '揽收大区 pickup area'
     ,ssd.src_area_name as  '寄件人所在时效区域 area1'

    , sp1.name as '寄件人所在省份 seller_province'
    , ct1.name '寄件人所在城市 seller_city'
	, sd1.name '寄件人人所在的乡 seller_barangay'

    ,tpr.dst_area_code as '目的地网点所在时效区域 destination_area'
	 ,tpr.dst_province_name as '目的地网点所在省 destination province'
    , ssd.dst_store as '目的网点 destination DC'
    , ssd.dst_piece as '目的片区 destination district'
    , ssd.dst_region as '目的大区 destination area'


    ,ssd.dst_area_name as '收件人所在时效区域 consignee_area1'
    , sp2.name '收件人所在省 consignee province'
    , ct2.name '收件人所在城市 consignee city'
	, sd2.name '收件人所在的区域 consignee district'
    , pi.dst_phone as 收件人电话
    , pi.dst_name as 收件人姓名
   	, tt.dst_routed_at as '到达目的地网点时间 arrive destionation DC time'
     ,datediff(date(now()),date(convert_tz(tt.dst_routed_at,'+00:00','+08:00'))) as  '到目的地网点时间_天 datediff_now_dst_store'
    , datediff(date(convert_tz(tt.dst_routed_at,'+00:00','+08:00')),date(convert_tz(pi.created_at,'+00:00','+08:00'))) as  '揽收到目的地网点时间_天 datediff_pcikup_dst_store'
    , case when tt.dst_routed_at is not null then '在仓' when tt.dst_routed_at is null then '在途' else 'null' end as '在仓_or_在途 in DC or in transit'

    , concat(ssd.src_area_name,' to ',ssd.dst_area_name) as '流向 direction'
    , convert_tz(bpt.pickup_created_at,'+00:00','+08:00') as '回调揽收时间 callback pickup time'
    , date(convert_tz(bpt.pickup_created_at,'+00:00','+08:00') )as '回调揽收日期 callback pickup date'

    , ssd.sla as '时效天数 SLA'
    , ssd.end_date as '包裹普通超时时效截止日_整体 last day of SLA'
    ,if( ssd.end_7_date is null,ssd.end_date,ssd.end_7_date) as '包裹严重超时时效截止日_整体 last day of SLA+7/ 2sla+7'
    , pi.cod_amount/1000 as 'cod金额 cod amount'
	, convert_tz(bpt.latest_created_at,'+00:00','+08:00') as '回调最后一条路由时间last movement time'
	, bpt.action_code as '回调最后一条路由动作 last movement'
	, ifnull(bpt.delivery_attempt_num,0)as '回调尝试次数 callback attempt_times'
	, bpt.delivery_attempt_num as '回调第三次尝试时间 delivery_attempt_num'
	, pc.third_sorting_code as '三段码 delivery code'
    , convert_tz(pr2.routed_at,'+00:00','+08:00') as '最后一次交接时间 last handover time'
    , if(date(convert_tz(pr2.routed_at,'+00:00','+08:00'))=current_date,'是','否') as '是否当日交接 handover dateimte '
    , pr2.staff_info_id as '最后一次交接人 last handover courier'
    ,case when pi.dst_district_code in('PH180302','PH18030T','PH18030U','PH18030V','PH18030W','PH18030A','PH18030Z','PH180310','PH18030C','PH180313','PH180314','PH18030F','PH18031F','PH18031G','PH18030G','PH18031H','PH18031J','PH18031K','PH18031L','PH18031M','PH18031N','PH18031P','PH18030H','PH18031Q','PH18030N','PH18031W','PH18031X','PH18031Y','PH18031Z',
		'PH180320','PH180321','PH18030P','PH180322','PH180323','PH180324','PH180325') then 'flashhome代派' else '网点自派' end as '派送归属 belong_delivery'
    , case when tt.dst_routed_at is not null and tt.last_store_name<>ssd.dst_store then ssd.dst_store else tt.last_store_name end as '当前网点 current DC'
    , tt.last_route_time as '最后一次有效路由时间 last movement time'
    , tt.last_route_action as '最后一次有效路由动作 last vlid movement'
	, prlm.last_marker_time as '最后一次派件标记时间 last delivery mark time'
	, prlm.last_marker as '最后一次派件标记原因 last delivery mark'
	#, if(pi.discard_enabled=0,'否','是') as '是否丢弃 if discard'
    , di3.created_at as '最后一次进入闪速系统判责时间 latest Lost task system time'
    , if(di3.state is not null,'闪速系统判责中',null)  as '最后一次进入闪速系统判责进度 latest Lost task system process'
	, prm.SYSTEM_AUTO_RETURN_time as  '标记系统自动退件时间 auto return time'
	, prm.wait_return_time as '标记待打印退件时间 time of reprint waybill'
	, case when ssd.end_date>=current_date then '未超时效'
	    when ssd.end_date<current_date  and if( ssd.end_7_date is null,ssd.end_date,ssd.end_7_date) >=current_date then '普通超时效'
	    when if( ssd.end_7_date is null,ssd.end_date,ssd.end_7_date) <current_date then '严重超时效' else null end as '时效类别判断SLA category'
    , if(ssd.end_date<current_date,'已超时效','未超时效') as '是否超时效 if breach SLA'
    , datediff(ssd.end_date,current_date) as '距离超时效天数 breach in days'
    , case when datediff(ssd.end_date,current_date)<0 then '已超时效'
            when datediff(ssd.end_date,current_date)=0 then '即将超时效_距离超时效0天'
            when datediff(ssd.end_date,current_date)=1 then '即将超时效_距离超时效1天'
            when datediff(ssd.end_date,current_date)=2 then '即将超时效_距离超时效2天'
            when datediff(ssd.end_date,current_date)>2 then '即将超时效_距离超时效>2天'
        else null end as '超时风险类型 risk type of breach SLA'
	, datediff(current_date, date(convert_tz(bpt.latest_created_at,'+00:00','+08:00'))) as '最后一条回调距离今日的天数差 days from last callback until now'
	, case  when di3.state is not null then '丢失破损闪速判责中'
	        when  prm.SYSTEM_AUTO_RETURN_time is not null then '待退件'
	    	when  prm.wait_return_time is not null then '待退件'
	        when ifnull(bpt.delivery_attempt_num,0) >=3 then '满足三次尝试派送'
	        when datediff(date(now()),date(convert_tz(tt.dst_routed_at,'+00:00','+08:00')))>=3 and  ifnull(bpt.delivery_attempt_num,0) =2 and date(prlm.last_marker_time)=current_date then '满足三次尝试派送'
	    	when di2.pno is not null then '地址错分导致延迟'
	        when di.疑难件原因 is not null then '疑难件处理中'
	    	when  datediff(date(now()),date(convert_tz(tt.dst_routed_at,'+00:00','+08:00')))<3 and  datediff(date(now()),date(convert_tz(tt.dst_routed_at,'+00:00','+08:00')))>0 then '到目的地网点后不够三次尝试'
	        when datediff(date(now()),date(convert_tz(tt.dst_routed_at,'+00:00','+08:00')))>=3 and  ifnull(bpt.delivery_attempt_num,0) =2 and date(prlm.last_marker_time)<current_date then '包裹到网点>=3天但尝试次数<3'
	        when  datediff(date(now()),date(convert_tz(tt.dst_routed_at,'+00:00','+08:00')))>=3 and ifnull(bpt.delivery_attempt_num,0) <2  then '包裹到网点>=3天但尝试次数<3'
			else null end as '滞留分析'
from tmpale.tmp_backlog_parcel_tiktok  bpt
left join ph_staging.order_info oi on bpt.tracking_no=oi.pno
left join ph_staging.parcel_info pi on bpt.pno=pi.pno
left join ph_staging.ka_warehouse kw on oi.ka_warehouse_id=kw.id
left join dwm.dwd_ex_ph_tiktok_sla_detail ssd on bpt.pno=ssd.pno
left join ph_staging.sys_store ss3 on ssd.dst_store_id=ss3.id


# 寄件人区域
left join ph_staging.sys_province sp1 on sp1.code=pi.src_province_code
left join ph_staging.sys_city ct1 on ct1.code=pi.src_city_code
left join ph_staging.sys_district sd1 on sd1.code=pi.src_district_code

# 收件人区域
left join ph_staging.sys_province sp2 on sp2.code=pi.dst_province_code
left join ph_staging.sys_city ct2 on ct2.code=pi.dst_city_code
left join ph_staging.sys_district sd2 on sd2.code=pi.dst_district_code


left join
(
	  select
	      distinct
		 tpr.dst_province_code
	    ,sp.name as dst_province_name
		 ,tpr.dst_area_code
	   from dwm.dwd_ph_dict_tiktok_period_rules tpr
	   join ph_staging.sys_province sp on tpr.dst_province_code=sp.code
	   where  tpr.sla_version='v2'
)tpr on ss3.province_code=tpr.dst_province_code # 收件人区域，寄件人区域

left join dwm.dwd_ex_ph_parcel_details tt on bpt.pno=tt.pno
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = tt.last_store_id and dp.stat_date =date_sub(current_date,interval 1 day)
left join ph_staging.sys_province sp on dp.province_code=sp.code
left join
	(
		select
		        dt.pno
		        ,dt.staff_info_id
		        ,dt.created_at as delivery_created_at
		        ,tdt2.cn_element as last_marker
		        ,convert_tz(dm.created_at,'+00:00','+08:00') last_marker_time
		        ,row_number() over (partition by  dt.pno order by dt.created_at desc) as rk
		from ph_staging.ticket_delivery dt
		join tmpale.tmp_backlog_parcel_tiktok  dw on dt.pno=dw.pno
		left join ph_staging.ticket_delivery_marker dm on dt.id=dm.delivery_id
		left join dwm.dwd_dim_dict tdt2 on dm.marker_id= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category'
	) prlm on bpt.pno = prlm.pno and prlm.rk = 1 /*最后一条派件标记*/
left join
    (
			select
		        di.pno
		        ,di.staff_info_id
		        ,tdt2.cn_element as 疑难件原因
		         , convert_tz(di.created_at,'+00:00','+08:00') as 疑难件上报时间
			    ,if(cdt.operator_id=10001,'回访批量导入/自动处理',sd.name) as 疑难件处理机构
	          #  ,cdt.operator_id '客服操作人ID'
			    ,case cdt.state
					  when 0 then '未处理'
					  when 1 then '已处理'
					  when 2 then '正在沟通中'
					  when 3 then '财务驳回'
					  when 4 then '客户未处理'
					  when 5 then '转交闪速系统'
					  when 6 then '转交QAQC'
					  end '疑难件处理情况'
			 ,row_number() over (partition by di.pno order by convert_tz(di.created_at,'+00:00','+08:00') desc) as rk
		from tmpale.tmp_backlog_parcel_tiktok tt
		join ph_staging.diff_info di on tt.pno=di.pno
		left join dwm.dwd_dim_dict tdt2 on di.diff_marker_category= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category'
		left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id=di.id and cdt.organization_type=2
		left join ph_bi.hr_staff_info hi2 on hi2.staff_info_id=cdt.operator_id #疑难件处理人对应网点
		left join ph_bi.sys_department sd on sd.id=hi2.node_department_id # 待处理人部门
        where di.state=0
	)di on bpt.pno=di.pno and di.rk=1 /*疑难件原因*/
left join
    (
        select
	        di.pno
	        ,tdt2.cn_element as 疑难件原因
	        ,convert_tz(di.created_at,'+00:00','+08:00') as 疑难件上报时间
             ,row_number() over (partition by di.pno order by convert_tz(di.created_at,'+00:00','+08:00') desc) as rk
		from tmpale.tmp_backlog_parcel_tiktok tt
		join ph_staging.diff_info di on tt.pno=di.pno
		left join dwm.dwd_dim_dict tdt2 on di.diff_marker_category= tdt2.element and tdt2.db = 'ph_staging' and tdt2.tablename = 'diff_info' and tdt2.fieldname = 'diff_marker_category'
		left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id=di.id and cdt.organization_type=2
        where di.state=1 and tdt2.element in(30,31,79,73,23)
    )di2 on bpt.pno=di2.pno and di2.rk=1  /*错分疑难件原因*/
left join
	(
	    select
			lt.pno
	        ,lt.created_at as created_at
	        ,lt.state
			,row_number() over (partition by lt.pno order by lt.created_at desc) as rk
		   from tmpale.tmp_backlog_parcel_tiktok tt
		  join ph_bi.parcel_lose_task lt on tt.pno=lt.pno
		   where lt.created_at>date_sub(CURRENT_DATE ,interval 30 day)
		   and lt.created_at < current_date()
		   and lt.state not in(5,6)
    )di3 on bpt.pno=di3.pno and di3.rk=1  /*丢失*/
left join
    (
	    select
	        pr.store_id
	        ,pr.pno
	        ,pr.store_name
	        ,pr.routed_at
	        ,pr.staff_info_id
	        ,pr.route_action
	    from
	        (
	            select
	                pr.pno
	                ,pr.store_id
	                ,pr.routed_at
	                ,pr.route_action
	                ,pr.store_name
	                ,pr.staff_info_id
	                ,row_number() over(partition by pr.pno order by pr.routed_at DESC ) as rn
	         from ph_staging.parcel_route pr
	         join tmpale.tmp_backlog_parcel_tiktok  bpt on pr.pno=bpt.pno
	         where pr.routed_at>= date_sub(now(),interval 1 month)
	         and pr.route_action in('DELIVERY_TICKET_CREATION_SCAN')
	        )pr
	    where pr.rn = 1
    ) pr2 on pr2.pno =bpt.pno -- 最后一次交接
left join
    (
	    select
			pc.pno
			,pc.sorting_code
	        ,pc.third_sorting_code
	        ,pc.line_code
	        ,row_number()over(partition by pc.pno order by pc.created_at desc) as rn
		from ph_drds.parcel_sorting_code_info pc
		join tmpale.tmp_backlog_parcel_tiktok  bpt on pc.pno=bpt.pno
	)pc on pc.pno =bpt.pno and pc.rn=1 -- 包裹最新派件码
left join
    (
           select
           pr.pno
           ,max(if(pr.route_action = 'SYSTEM_AUTO_RETURN',date(convert_tz(pr.routed_at, '+00:00', '+08:00')),null)) as SYSTEM_AUTO_RETURN_time
           ,max(if(pr.route_action in( 'PENDING_RETURN','DELAY_RETURN'),date(convert_tz(pr.routed_at, '+00:00', '+08:00')),null)) as wait_return_time
           from ph_staging.parcel_route pr
           join tmpale.tmp_backlog_parcel_tiktok  bpt on pr.pno=bpt.pno
           where pr.route_action in( 'SYSTEM_AUTO_RETURN','PENDING_RETURN','DELAY_RETURN')
           and pr.routed_at >= date_sub(now(),interval 3 month)
           group by 1
    )prm on bpt.pno=prm.pno  -- 打印退件和待退件
left join
    (
           select
                pr.pno
           from ph_staging.parcel_route pr
           join tmpale.tmp_backlog_parcel_tiktok  bpt on pr.pno=bpt.pno
           where pr.route_action ='REFUND_CONFIRM'
           and pr.routed_at >= date_sub(now(),interval 10 month)
           group by 1
    )prm2 on bpt.pno=prm2.pno
where  datediff(ssd.end_date,current_date)<=0 and prm2.pno is null;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-10'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 10
                    or (t1.total =  5 and t1.leave_time_type = 2)

                union all

                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 5
                    and t1.leave_time_type = 1 -- 上午请假
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-10'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 10
                                    or (t1.total =  5 and t1.leave_time_type = 2)

                                union all

                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 5
                                    and t1.leave_time_type = 1 -- 上午请假
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-09-10', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-10'
        and pr.routed_at >= date_sub('2023-09-10', interval 8 hour )
        and pr.routed_at < date_add('2023-09-10', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,if(a3.self_staff_num + other_staff_num > coalesce(sdb.code_num, 0),
           case
            when a2.avg_staff_code < 2 then 'A'
            when a2.avg_staff_code >= 2 and a2.avg_staff_code < 3 then 'B'
            when a2.avg_staff_code >= 3 and a2.avg_staff_code < 4 then 'C'
            when a2.avg_staff_code >= 4 then 'D'
        end,
           case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end ) 评级
#         ,a2.code_num
#         ,a2.staff_code_num
#         ,a2.staff_num
#         ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) avg_staff_code
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
with d as
    (
        select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-09-10'
    )
    , t as
    (
        select
             ds.store_id
            ,ds.pno
            ,ds.stat_date
        from d ds
        left join
            (
                select
                    pr.pno
                    ,ds.stat_date
                    ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
                from ph_staging.parcel_route pr
                join d ds on pr.pno = ds.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                    and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and pr.marker_category in (42,43) ##岛屿,偏远地区
                group by 1,2
            ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
        left join
            (
                select
                   pr.pno
                    ,ds.stat_date
                   ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
                   ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
                from ph_staging.parcel_route pr
                join d ds on ds.pno = pr.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                    and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                    and pr.marker_category in (9,14,70) ##客户改约时间
            ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
        left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
        where
            case
                when pr1.pno is not null then 'N'
                when pr2.pno is not null then 'N'
                when ds1.pno is not null  then 'N'  else 'Y'
            end = 'Y'
    )
    select
        a.stat_date 日期
        ,a.store_id 网点ID
        ,dp.store_name 网点名称
        ,dp.opening_at 开业时间
        ,case
            when dp.region_name in ('Area3', 'Area6') then '彭万松'
            when dp.region_name in ('Area4', 'Area9') then '韩钥'
            when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
            when dp.region_name in ( 'Area8') then '黄勇'
            when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
        end 区域
        ,dp.region_name 大区
        ,dp.piece_name 片区
        ,a.应交接
        ,a.已交接
        ,concat(round(a.交接率*100,2),'%') as 交接率
        ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
        ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
        ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
        ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
        ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
    from
        (
            select
                t1.store_id
                ,t1.stat_date
                ,count(t1.pno) 应交接
                ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
            from t t1
            left join
                (
                    select
                        sc.*
                    from
                        (
                            select
                                pr.pno
                                ,pr.store_id
                                ,pr.store_name
                                ,t1.stat_date
                                ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                            from ph_staging.parcel_route pr
                            join t t1 on t1.pno = pr.pno
                            where
                                pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                               and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                              and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                        ) sc
                    where
                        sc.rk = 1
                ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
            group by 1,2
        ) a
    join
        (
            select
                sd.store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.store_id is not null
            group by 1

            union all

            select
                sd.separation_store_id store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.separation_store_id is not null
            group by 1
        ) sd on sd.store_id = a.store_id
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    where
        dp.store_category in (1,10);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-09-10'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-09-10')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-09-10'
        and pi.finished_at >= date_sub('2023-09-10', interval 8 hour )
        and pi.finished_at < date_add('2023-09-10', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-09-10'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
select
    fn.region_name as 大区
	,fn.piece_name as 片区
	,fn.store_name as 网点
    ,fn.staff_info_id as 员工ID
	,count(distinct fn.pno) as '今日交接量(最后一次交接人为准)'
    ,count(distinct if(fn.pi_state = 5, fn.pno, null)) 今日交接妥投量
	,count(distinct if(fn.handover_type='17点前交接' ,fn.pno, null)) as 17点前交接量
    ,count(distinct if(fn.handover_type='17点前交接' and fn.pi_state = 5,fn.pno,null)) 17点前交接包裹妥投量
    ,count(distinct if(fn.handover_type='17点前交接' and fn.pi_state = 7,fn.pno,null)) 17点前交接包裹退件量
    ,count(distinct if(fn.handover_type='17点前交接' and fn.pi_state = 8,fn.pno,null)) 17点前交接包裹异常关闭量

    ,count(distinct if(fn.handover_type='17点前交接' and fn.pi_state not in (5,7,8,9),fn.pno,null)) 17点前交接包裹未终态量

	,count(distinct case when fn.handover_type='17点前交接' and fn.pi_state not in (5,7,8,9) and fn.before_17_calltimes is null then fn.pno else null end) as 17点前交接包裹未妥投且未拨打电话量
	,count(distinct case when fn.handover_type='17点前交接'  and fn.pi_state not in (5,7,8,9) and fn.before_17_calltimes = 1 then fn.pno else null end) as 17点前交接包裹未妥投且拨打电话1次量
	,count(distinct case when fn.handover_type='17点前交接'  and fn.pi_state not in (5,7,8,9) and fn.before_17_calltimes = 2 then fn.pno else null end) as 17点前交接包裹未妥投且拨打电话2次量
	,count(distinct case when fn.handover_type='17点前交接'  and fn.pi_state not in (5,7,8,9) and fn.before_17_calltimes = 3 then fn.pno else null end) as 17点前交接包裹未妥投且拨打电话3次量
	,count(distinct case when fn.handover_type='17点前交接'  and fn.pi_state not in (5,7,8,9) and fn.before_17_calltimes > 3 then fn.pno else null end) as 17点前交接包裹未妥投且拨打电话3次以上量
from
    (
        select
            pr.pno
            ,pr.store_id
            ,pr.store_name
            ,pr.piece_name
            ,pr.region_name
            ,pr.routed_date
            ,pr.pi_state
            ,pr.staff_info_id
            ,pr.handover_type
            ,pr.finished_at
            ,pr2.before_17_calltimes
        from
            ( # 所有交接包裹
                select
                    pr.*
                    ,if(hour(pr.routed_at) < 17, '17点前交接', '17点后交接') handover_type
                from
                    (
                        select
                            pr.pno
                            ,pr.staff_info_id
                            ,pr.store_id
                            ,dp.store_name
                            ,dp.piece_name
                            ,dp.region_name
                            ,pi.state pi_state
                            ,convert_tz(pr.routed_at,'+00:00','+08:00') as routed_at
                            ,convert_tz(pi.finished_at,'+00:00','+08:00') as finished_at
                            ,date(convert_tz(pr.routed_at,'+00:00','+08:00'))  as routed_date
                            ,row_number() over(partition by pr.pno,date(convert_tz(pr.routed_at,'+00:00','+08:00')) order by convert_tz(pr.routed_at,'+00:00','+08:00') desc) as rnk
                        from ph_staging.parcel_route pr
                        left join dwm.dim_ph_sys_store_rd dp on dp.store_id = pr.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
                        left join ph_staging.parcel_info pi on pr.pno = pi.pno
                        where
                            pr.routed_at >= date_sub(curdate(), interval 8 hour)
                            and pr.routed_at < date_add(curdate(), interval 16 hour)
                            and pr.route_action in ('DELIVERY_TICKET_CREATION_SCAN')
                            and dp.store_category = 1 -- 限制SP
                    ) pr
                where
                    pr.rnk=1
            ) pr
        left join
            (
                select
                    pr.pno
                    ,count(pr.call_datetime) as before_17_calltimes
                from
                    (
                            select
                                pr.pno
                                ,pr.staff_info_id
                                ,convert_tz(pr.routed_at,'+00:00','+08:00')  as call_datetime
                         from ph_staging.parcel_route pr
                         left join ph_staging.parcel_info pi on pr.pno=pi.pno
                         where
                            pr.routed_at >= date_sub(curdate(), interval 8 hour)
                            and pr.routed_at < date_add(curdate(), interval 9 hour)
                            and pr.route_action in ('PHONE')
                    )pr
                group by 1
            )pr2 on pr.pno = pr2.pno
    )fn
group by 1,2,3,4
order by 1,2,3;
;-- -. . -..- - / . -. - .-. -.--
select datediff(now(),now());
;-- -. . -..- - / . -. - .-. -.--
select
            ds.dst_store_id
            ,count(distinct ds.pno) in_house_count
            ,count(distinct if(pi.exhibition_weight > 5000 or pi.exhibition_length + pi.exhibition_width + pi.exhibition_height > 80, ds.pno, null)) big_in_house_count
            ,count(distinct if(bc.client_id is not null, ds.pno, null)) big_client_count
            ,count(distinct if(bc.client_id is null, ds.pno, null)) small_client_count
            ,count(distinct if(datediff(now(), ds.first_valid_routed_at) <= 3 and bc.client_id is not null, ds.pno, null)) 3_within_backlog_bigclient
            ,count(distinct if(datediff(now(), ds.first_valid_routed_at) > 3 and datediff(now(), ds.first_valid_routed_at) <= 5 and bc.client_id is not null, ds.pno, null)) 3_5_backlog_bigclient
            ,count(distinct if(datediff(now(), ds.first_valid_routed_at) > 5 and bc.client_id is not null, ds.pno, null)) 5_more_backlog_bigclient
        from dwm.dwd_ph_dc_should_be_delivery ds
        join ph_staging.parcel_info pi on pi.pno = ds.pno
        left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
        where
            pi.state not in (5,7,8,9)
            and ds.p_date = '2023-09-11'
        group by 1;
;-- -. . -..- - / . -. - .-. -.--
select
    fn.region_name as 大区
	,fn.piece_name as 片区
	,fn.store_name as 网点
    ,fn.staff_info_id as 员工ID

	,count(distinct if(fn.handover_type='17点前交接', fn.pno ,null)) as 17点前交接量
    ,count(distinct if(fn.handover_type='17点前交接' and fn.pi_state = 5 ,fn.pno ,null)) 17点前交接包裹妥投量
    ,count(distinct if(fn.handover_type='17点前交接' and fn.pi_state = 7 ,fn.pno ,null)) 17点前交接包裹退件量
    ,count(distinct if(fn.handover_type='17点前交接' and fn.pi_state = 8 ,fn.pno ,null)) 17点前交接包裹异常关闭量

    ,count(distinct if(fn.handover_type='17点前交接' and fn.pi_state not in (5,7,8,9),fn.pno,null)) 17点前交接包裹未终态量

	,count(distinct case when fn.handover_type='17点前交接' and fn.pi_state not in (5,7,8,9) and fn.before_17_calltimes is null then fn.pno else null end) as 17点前交接包裹未妥投且未拨打电话量
	,count(distinct case when fn.handover_type='17点前交接'  and fn.pi_state not in (5,7,8,9) and fn.before_17_calltimes = 1 then fn.pno else null end) as 17点前交接包裹未妥投且拨打电话1次量
	,count(distinct case when fn.handover_type='17点前交接'  and fn.pi_state not in (5,7,8,9) and fn.before_17_calltimes = 2 then fn.pno else null end) as 17点前交接包裹未妥投且拨打电话2次量
	,count(distinct case when fn.handover_type='17点前交接'  and fn.pi_state not in (5,7,8,9) and fn.before_17_calltimes = 3 then fn.pno else null end) as 17点前交接包裹未妥投且拨打电话3次量
	,count(distinct case when fn.handover_type='17点前交接'  and fn.pi_state not in (5,7,8,9) and fn.before_17_calltimes > 3 then fn.pno else null end) as 17点前交接包裹未妥投且拨打电话3次以上量
from
    (
        select
            pr.pno
            ,pr.store_id
            ,pr.store_name
            ,pr.piece_name
            ,pr.region_name
            ,pr.routed_date
            ,pr.pi_state
            ,pr.staff_info_id
            ,pr.handover_type
            ,pr.finished_at
            ,pr2.before_17_calltimes
        from
            ( # 所有交接包裹
                select
                    pr.*
                    ,if(hour(pr.routed_at) < 17, '17点前交接', '17点后交接') handover_type
                from
                    (
                        select
                            pr.pno
                            ,pr.staff_info_id
                            ,pr.store_id
                            ,dp.store_name
                            ,dp.piece_name
                            ,dp.region_name
                            ,pi.state pi_state
                            ,convert_tz(pr.routed_at,'+00:00','+08:00') as routed_at
                            ,convert_tz(pi.finished_at,'+00:00','+08:00') as finished_at
                            ,date(convert_tz(pr.routed_at,'+00:00','+08:00'))  as routed_date
                            ,row_number() over(partition by pr.pno,date(convert_tz(pr.routed_at,'+00:00','+08:00')) order by convert_tz(pr.routed_at,'+00:00','+08:00') desc) as rnk
                        from ph_staging.parcel_route pr
                        left join dwm.dim_ph_sys_store_rd dp on dp.store_id = pr.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
                        left join ph_staging.parcel_info pi on pr.pno = pi.pno
                        where
                            pr.routed_at >= date_sub(curdate(), interval 8 hour)
                            and pr.routed_at < date_add(curdate(), interval 16 hour)
                            and pr.route_action in ('DELIVERY_TICKET_CREATION_SCAN')
                            and dp.store_category = 1 -- 限制SP
                    ) pr
                where
                    pr.rnk=1
            ) pr
        left join
            (
                select
                    pr.pno
                    ,count(pr.call_datetime) as before_17_calltimes
                from
                    (
                            select
                                pr.pno
                                ,pr.staff_info_id
                                ,convert_tz(pr.routed_at,'+00:00','+08:00')  as call_datetime
                         from ph_staging.parcel_route pr
                         left join ph_staging.parcel_info pi on pr.pno=pi.pno
                         where
                            pr.routed_at >= date_sub(curdate(), interval 8 hour)
                            and pr.routed_at < date_add(curdate(), interval 9 hour)
                            and pr.route_action in ('PHONE')
                    )pr
                group by 1
            )pr2 on pr.pno = pr2.pno
    ) fn
group by 1,2,3,4
order by 1,2,3;
;-- -. . -..- - / . -. - .-. -.--
SELECT DATE_SUB(CURTIME(), INTERVAL (MINUTE(CURTIME()) + SECOND(CURTIME()) / 60) MINUTE) AS previous_hour;
;-- -. . -..- - / . -. - .-. -.--
SELECT DATE_SUB(CURTIME(), INTERVAL (MINUTE(CURTIME()) + SECOND(CURTIME()) / 60) MINUTE);
;-- -. . -..- - / . -. - .-. -.--
SELECT DATE_SUB(now(), INTERVAL (MINUTE(ow()) + SECOND(ow()) / 60) MINUTE);
;-- -. . -..- - / . -. - .-. -.--
SELECT DATE_SUB(now(), INTERVAL (MINUTE(now()) + SECOND(now()) / 60) MINUTE);
;-- -. . -..- - / . -. - .-. -.--
SELECT DATE_SUB(now(), INTERVAL (MINUTE(now())*60 + SECOND(now())) second );
;-- -. . -..- - / . -. - .-. -.--
SELECT date_add(date_sub(now(), interval (minute(now())*60 + second(now())) second), interval  8 hour);
;-- -. . -..- - / . -. - .-. -.--
SELECT date_sub(date_sub(now(), interval (minute(now())*60 + second(now())) second), interval  8 hour);
;-- -. . -..- - / . -. - .-. -.--
select date_sub(now(), interval (minute(now())*60 + second(now())) second);
;-- -. . -..- - / . -. - .-. -.--
select date_sub(date_sub(now(), interval (minute(now())*60 + second(now())) second), interval  8 hour);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-11'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    st.staff_info_id 工号
    ,if(hsi2.sys_store_id = '-1', 'Head office', dp.store_name) 网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,case
        when hsi2.job_title in (13,110,1000) then '快递员'
        when hsi2.job_title in (37) then '仓管员'
        when hsi2.job_title in (16) then '主管'
    end 角色
    ,st.late_num 迟到次数
    ,st.absence_sum 缺勤数据
    ,st.late_time_sum 迟到时长
    ,case
        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
        when st.absence_sum >= 2 or st.late_num >= 3  then 'C'
        else 'B'
    end 出勤评级
from
    (
        select
            a.staff_info_id
            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
            ,sum(a.absence_time) absence_sum
        from
            (
                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 10
                    or (t1.total =  5 and t1.leave_time_type = 2)

                union all

                select
                    t1.*
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                    ,t1.AB/10 absence_time
                from t t1
                where
                    t1.total = 5
                    and t1.leave_time_type = 1 -- 上午请假
            ) a
        group by 1
    ) st
left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
order by 2,1;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        *
    from
        (
            select
                ad.*
                ,row_number() over (partition by ad.staff_info_id order by ad.stat_date desc) rk
            from
                (
                    select
                        ad.*
                        ,ad.attendance_time + ad.BT + ad.BT_Y + ad.AB total
                    from ph_bi.attendance_data_v2 ad
                    join ph_bi.hr_staff_info hsi on hsi.staff_info_id = ad.staff_info_id and hsi.state = 1 and hsi.wait_leave_state = 0 and hsi.job_title in (13,110,1000,37,16) -- 在职且非待离职
                    where
                        ad.stat_date < '2023-09-11'
#                         and hsi.hire_date <= date_sub(curdate(), interval 7 day )
#                         and ad.stat_date >= date_sub(curdate(), interval 30 day )
                ) ad
            where
                ad.total > 0
        ) ad
    where
        ad.rk < 8
)
select
    ss.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,case dp.store_category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 网点类型
    ,dp.region_name 大区
    ,dp.piece_name 片区
    ,case
        when ss.num/dp.on_emp_cnt < 0.05 then 'A'
        when ss.num/dp.on_emp_cnt >= 0.05 and ss.num/dp.on_emp_cnt < 0.1 then 'B'
        when ss.num/dp.on_emp_cnt >= 0.1 then 'C'
    end 出勤评级
    ,ss.num/dp.on_emp_cnt C级员工占比
    ,ss.num C级员工数
    ,dp.on_emp_cnt 在职员工数
    ,dp.on_dcs_cnt 主管数
    ,dp.on_dco_cnt 仓管数
    ,dp.on_dri_cnt 快递员数

    ,ss.avg_absence_num 近7天缺勤人次
    ,ss.avg_absence_num/7 近7天平均每天缺勤人次
    ,ss.avg_late_num 近7天迟到人次
    ,ss.avg_late_num/7 近7天平均每天迟到人次
from
    (
        select
            s.store_id
            ,count(if(s.ss_level = 'C', s.staff_info_id, null)) num
            ,sum(s.late_num) avg_late_num
            ,sum(s.absence_sum) avg_absence_num
        from
            (
                select
                    st.staff_info_id
                    ,dp.store_id
                    ,dp.store_name
                    ,dp.piece_name
                    ,dp.region_name
                    ,case
                        when hsi2.job_title in (13,110,1000) then '快递员'
                        when hsi2.job_title in (37) then '仓管员'
                        when hsi2.job_title in (16) then '主管'
                    end roles
                    ,st.late_num
                    ,st.absence_sum
                    ,case
                        when st.absence_sum = 0 and st.late_num <= 1 and st.late_time_sum < 30 then 'A'
                        when st.absence_sum >= 2 or st.late_num >= 3 then 'C'
                        else 'B'
                    end ss_level
                from
                    (
                        select
                            a.staff_info_id
                            ,count(if(a.late_or_not = 'y' ,a.stat_date, null)) late_num
#                             ,count(if(a.early_or_not = 'y', a.stat_date, null)) early_num
                            ,sum(if(a.late_or_not = 'y', a.late_time, 0)) late_time_sum
#                             ,sum(if(a.early_or_not = 'y', a.early_yime, 0)) early_time_sum
                            ,sum(a.absence_time) absence_sum
                        from
                            (
                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 1 minute ) , timestampdiff(minute , concat(t1.stat_date, ' ', t1.shift_start), t1.attendance_started_at), 0) late_time
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
#                                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 10
                                    or (t1.total =  5 and t1.leave_time_type = 2)

                                union all

                                select
                                    t1.*
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , 'y', 'n') late_or_not
                                    ,if(t1.attendance_started_at > date_add(date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), interval 1 minute ) , timestampdiff(minute , date_add(concat(t1.stat_date, ' ', t1.shift_start), interval 5 hour), t1.attendance_started_at), 0) late_time
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, 'y', 'n' ) early_or_not
                #                     ,if(date_format(t1.attendance_end_at, '%H:%i') < t1.shift_end, timestampdiff(second, t1.attendance_end_at, t1.shift_end)/60, 0) early_yime
                                    ,t1.AB/10 absence_time
                                from t t1
                                where
                                    t1.total = 5
                                    and t1.leave_time_type = 1 -- 上午请假
                            ) a
                        group by 1
                    ) st
                left join ph_bi.hr_staff_info hsi2 on hsi2.staff_info_id = st.staff_info_id
                left join dwm.dim_ph_sys_store_rd dp on dp.store_id = hsi2.sys_store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
            ) s
        group by 1
    ) ss
left join
    (
        select
            hsi3.store_id store_id
            ,ss2.name store_name
            ,smp.name piece_name
            ,smr.name region_name
            ,ss2.category store_category
            ,ss2.opening_at
            ,count(if(hsi3.job_title in (13,110,1000,37,16), hsi3.staff_info_id, null)) on_emp_cnt
            ,count(if(hsi3.job_title in (13,110,1000), hsi3.staff_info_id, null)) on_dri_cnt
            ,count(if(hsi3.job_title in (37), hsi3.staff_info_id, null)) on_dco_cnt
            ,count(if(hsi3.job_title in (16), hsi3.staff_info_id, null)) on_dcs_cnt
        from ph_bi.hr_staff_transfer  hsi3
        left join ph_staging.sys_store ss2 on ss2.id = hsi3.store_id
        left join ph_staging.sys_manage_piece smp on smp.id = ss2.manage_piece
        left join ph_staging.sys_manage_region smr on smr.id = ss2.manage_region
        where
            hsi3.state = 1
            and hsi3.formal=1
            and hsi3.stat_date = date_sub('2023-09-11', interval 1 day)
        group by 1,2,3,4,5,6
    )dp on dp.store_id = ss.store_id
where
    dp.store_category = 1;
;-- -. . -..- - / . -. - .-. -.--
with d as
    (
        select
             ds.dst_store_id store_id
            ,ds.pno
            ,ds.p_date stat_date
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
            ds.should_delevry_type = '1派应派包裹'
            and ds.p_date = '2023-09-11'
    )
    , t as
    (
        select
             ds.store_id
            ,ds.pno
            ,ds.stat_date
        from d ds
        left join
            (
                select
                    pr.pno
                    ,ds.stat_date
                    ,max(convert_tz(pr.routed_at,'+00:00','+08:00')) remote_marker_time
                from ph_staging.parcel_route pr
                join d ds on pr.pno = ds.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date, interval 8 hour)
                    and pr.routed_at < date_add(ds.stat_date, interval 16 hour)
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and pr.marker_category in (42,43) ##岛屿,偏远地区
                group by 1,2
            ) pr1  on ds.pno = pr1.pno and ds.stat_date = pr1.stat_date  #当日留仓标记为偏远地区留待次日派送
        left join
            (
                select
                   pr.pno
                    ,ds.stat_date
                   ,convert_tz(pr.routed_at,'+00:00','+08:00') reschedule_marker_time
                   ,row_number() over(partition by ds.stat_date, pr.pno order by pr.routed_at desc) rk
                from ph_staging.parcel_route pr
                join d ds on ds.pno = pr.pno
                where 1=1
                    and pr.routed_at >= date_sub(ds.stat_date ,interval 15 day)
                    and pr.routed_at <  date_sub(ds.stat_date ,interval 8 hour) #限定当日之前的改约
                    and pr.route_action = 'DETAIN_WAREHOUSE'
                    and from_unixtime(json_extract(pr.extra_value,'$.desiredat')) > date_add(ds.stat_date, interval 16 hour)
                    and pr.marker_category in (9,14,70) ##客户改约时间
            ) pr2 on ds.pno = pr2.pno and pr2.stat_date = ds.stat_date and  pr2.rk = 1 #当日之前客户改约时间
        left join ph_bi.dc_should_delivery_today ds1 on ds.pno = ds1.pno and ds1.state = 6 and ds1.stat_date = date_sub(ds.stat_date,interval 1 day)
        where
            case
                when pr1.pno is not null then 'N'
                when pr2.pno is not null then 'N'
                when ds1.pno is not null  then 'N'  else 'Y'
            end = 'Y'
    )
    select
        a.stat_date 日期
        ,a.store_id 网点ID
        ,dp.store_name 网点名称
        ,dp.opening_at 开业时间
        ,case
            when dp.region_name in ('Area3', 'Area6') then '彭万松'
            when dp.region_name in ('Area4', 'Area9') then '韩钥'
            when dp.region_name in ('Area7','Area10', 'Area11','FHome') then '张可新'
            when dp.region_name in ( 'Area8') then '黄勇'
            when dp.region_name in ('Area1', 'Area2','Area5', 'Area12','Area13') then '李俊'
        end 区域
        ,dp.region_name 大区
        ,dp.piece_name 片区
        ,a.应交接
        ,a.已交接
        ,concat(round(a.交接率*100,2),'%') as 交接率
        ,concat(ifnull(a.a_check,''), ifnull(a.b_check,''), ifnull(a.d_check,''), ifnull(a.e_check,''),if(a.a_check is null  and a.d_check is null and a.b_check is null and a.e_check is null, 'C', '')) 交接评级
        ,concat(round(a.A_rate * 100,2),'%')  'A时段（<0930 ）'
        ,concat(round(a.B_rate * 100,2),'%') 'B时段（0930<=X<1200）'
        ,concat(round(a.C_rate * 100,2),'%')'C时段（1200<=X<1600 ）'
        ,concat(round(a.D_rate * 100,2),'%')'D时段（>=1600）'
    from
        (
            select
                t1.store_id
                ,t1.stat_date
                ,count(t1.pno) 应交接
                ,count(if(sc.pno is not null , t1.pno, null)) 已交接
                ,count(if(sc.pno is not null , t1.pno, null))/count(t1.pno) 交接率
                ,count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as A_rate
                ,count(if(time(sc.route_time) >= '09:30:00' and time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as B_rate
                ,count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as C_rate
                ,count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) as D_rate

                ,if(count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.95, 'A', null ) a_check
                ,if(count(if(time(sc.route_time) < '12:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.98 and count(if(time(sc.route_time) < '09:30:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) <= 0.95, 'B', null ) b_check
                ,if(count(if(time(sc.route_time) >= '12:00:00' and time(sc.route_time) < '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03, 'D', null ) d_check
                ,if(count(if(time(sc.route_time) >= '16:00:00', t1.pno, null))/count(if(sc.pno is not null , t1.pno, null)) > 0.03 , 'E', null ) e_check
            from t t1
            left join
                (
                    select
                        sc.*
                    from
                        (
                            select
                                pr.pno
                                ,pr.store_id
                                ,pr.store_name
                                ,t1.stat_date
                                ,convert_tz(pr.routed_at, '+00:00', '+08:00') route_time
                                ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) route_date
                                ,row_number() over (partition by pr.pno,t1.stat_date order by pr.routed_at) rk
                            from ph_staging.parcel_route pr
                            join t t1 on t1.pno = pr.pno
                            where
                                pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
                               and pr.routed_at >= date_sub(t1.stat_date, interval 8 hour)
                              and pr.routed_at < date_add(t1.stat_date, interval 16 hour )
                        ) sc
                    where
                        sc.rk = 1
                ) sc on sc.pno = t1.pno and t1.stat_date = sc.stat_date
            group by 1,2
        ) a
    join
        (
            select
                sd.store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.store_id is not null
            group by 1

            union all

            select
                sd.separation_store_id store_id
            from ph_staging.sys_district sd
            where
                sd.deleted = 0
                and sd.separation_store_id is not null
            group by 1
        ) sd on sd.store_id = a.store_id
    left join dwm.dim_ph_sys_store_rd dp on dp.store_id = a.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
    where
        dp.store_category in (1,10);
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id as store_id
        ,pr.pno
        ,hst.sys_store_id hr_store_id
        ,hst.formal
        ,pr.staff_info_id
        ,pi.state
        ,hst.job_title
    from dwm.dwd_ph_dc_should_be_delivery ds
    left join ph_staging.parcel_route pr on pr.pno = ds.pno and pr.route_action = 'DELIVERY_TICKET_CREATION_SCAN'
    left join ph_staging.parcel_info pi on pi.pno = pr.pno
    left join ph_bi.hr_staff_info hst on hst.staff_info_id = pr.staff_info_id
#     left join ph_bi.hr_staff_transfer hst  on hst.staff_info_id = pr.staff_info_id
    where
        ds.p_date = '2023-09-11'
        and pr.routed_at >= date_sub('2023-09-11', interval 8 hour )
        and pr.routed_at < date_add('2023-09-11', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and hst.stat_date = '${date}'
#         and ds.dst_store_id in ('PH35300N06', 'PH35172804')
)
    select
        dr.store_id 网点ID
        ,dr.store_name 网点
        ,coalesce(dr.opening_at, '未记录') 开业时间
        ,case dr.store_category
            when 1 then 'SP'
            when 2 then 'DC'
            when 4 then 'SHOP'
            when 5 then 'SHOP'
            when 6 then 'FH'
            when 7 then 'SHOP'
            when 8 then 'Hub'
            when 9 then 'Onsite'
            when 10 then 'BDC'
            when 11 then 'fulfillment'
            when 12 then 'B-HUB'
            when 13 then 'CDC'
            when 14 then 'PDC'
        end 网点类型
        ,dr.piece_name 片区
        ,dr.region_name 大区
        ,coalesce(emp_cnt.staf_num, 0) 总快递员人数_在职
        ,coalesce(a3.self_staff_num, 0) 自有快递员出勤数
        ,coalesce(a3.other_staff_num, 0) '外协+支援快递员出勤数'
        ,coalesce(a3.dco_dcs_num, 0) 仓管主管_出勤数

        ,coalesce(a3.avg_scan_num, 0) 快递员平均交接量
        ,coalesce(a3.avg_del_num, 0) 快递员平均妥投量
        ,coalesce(a3.dco_dcs_avg_scan, 0) 仓管主管_平均交接量

        ,coalesce(sdb.code_num, 0) 网点三段码数量
        ,coalesce(a2.self_avg_staff_code, 0) 自有快递员三段码平均交接量
        ,coalesce(a2.other_avg_staff_code, 0) '外协+支援快递员三段码平均交接量'
        ,coalesce(a2.self_avg_staff_del_code, 0) 自有快递员三段码平均妥投量
        ,coalesce(a2.other_avg_staff_del_code, 0) '外协+支援快递员三段码平均妥投量'
        ,coalesce(a2.avg_code_staff, 0) 三段码平均交接快递员数
        ,if(a3.self_staff_num + other_staff_num > coalesce(sdb.code_num, 0),
           case
            when a2.avg_staff_code < 2 then 'A'
            when a2.avg_staff_code >= 2 and a2.avg_staff_code < 3 then 'B'
            when a2.avg_staff_code >= 3 and a2.avg_staff_code < 4 then 'C'
            when a2.avg_staff_code >= 4 then 'D'
        end,
           case
            when a2.avg_code_staff < 2 then 'A'
            when a2.avg_code_staff >= 2 and a2.avg_code_staff < 3 then 'B'
            when a2.avg_code_staff >= 3 and a2.avg_code_staff < 4 then 'C'
            when a2.avg_code_staff >= 4 then 'D'
        end ) 评级
#         ,a2.code_num
#         ,a2.staff_code_num
#         ,a2.staff_num
#         ,a2.fin_staff_code_num
    from
        (
            select
                a1.store_id
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) staff_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null)) fin_staff_code_num
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.job_title in (13,110,1000), a1.staff_info_id, null)) avg_staff_code
                ,count(distinct if(a1.job_title in (13,110,1000), a1.staff_code, null))/ count(distinct if(a1.job_title in (13,110,1000), a1.third_sorting_code, null)) avg_code_staff
                ,count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_code
                ,count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'y' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) self_avg_staff_del_code
                ,count(distinct if(a1.state = 5 and a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_code, null))/count(distinct if(a1.is_self = 'n' and a1.job_title in (13,110,1000), a1.staff_info_id, null)) other_avg_staff_del_code
            from
                (
                select
                    a1.*
                    ,concat(a1.staff_info_id, a1.third_sorting_code) staff_code
                from
                    (
                        select
                            t1.store_id
                            ,t1.pno
                            ,t1.staff_info_id
                            ,if(t1.formal = 1 and t1.store_id = t1.hr_store_id, 'y', 'n') is_self
                            ,t1.state
                            ,t1.job_title
                            ,ps.third_sorting_code
                            ,rank() over (partition by t1.pno order by ps.created_at desc) rk
                        from t t1
                        join ph_drds.parcel_sorting_code_info ps on  ps.pno = t1.pno and ps.dst_store_id = t1.store_id and ps.third_sorting_code != 'XX'
                    ) a1
                where
                    a1.rk = 1
            ) a1
        left join ph_staging.parcel_info pi on pi.pno = a1.pno
        group by 1
    ) a2
left join
    (
        select
            hr.sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.is_sub_staff= 0
            and hr.state = 1
            and hr.job_title in (13,110,1000)
        group by 1
    ) emp_cnt on emp_cnt.sys_store_id = a2.store_id
# left join
#     (
#         select
#            ad.sys_store_id
#            ,count(distinct ad.staff_info_id) as atd_emp_cnt -- 出勤人数
#        from ph_bi.attendance_data_v2 ad
#        left join ph_bi.hr_staff_info hr on hr.staff_info_id =ad.staff_info_id
#        where
#            (ad.attendance_started_at is not null or ad.attendance_end_at is not null)
#             and hr.job_title in (13,110,1000)
# #             and ad.stat_date = curdate()
#             and ad.stat_date = '${date}'
#        group by 1
#     ) att on att.sys_store_id = a2.store_id
left join dwm.dim_ph_sys_store_rd dr on dr.store_id = a2.store_id and dr.stat_date = date_sub(curdate(), interval 1 day)
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.formal = 1  and t1.job_title in (13,110,1000), t1.staff_info_id, null))  self_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000) and ( t1.hr_store_id != t1.store_id or t1.formal != 1  ), t1.staff_info_id, null )) other_staff_num
            ,count(distinct if(t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000),  t1.staff_info_id, null)) avg_scan_num
            ,count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5, t1.pno, null))/count(distinct if(t1.job_title in (13,110,1000) and t1.state = 5,  t1.staff_info_id, null)) avg_del_num

            ,count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.job_title in (37,16), t1.pno, null))/count(distinct if(t1.job_title in (37,16), t1.staff_info_id, null)) dco_dcs_avg_scan
        from t t1
        group by 1
    ) a3  on a3.store_id = a2.store_id
left join
    (
        select
            sdb.store_id
            ,count(distinct sdb.delivery_code) code_num
        from ph_staging.store_delivery_barangay_group_info sdb
        where
            sdb.deleted = 0
            and sdb.delivery_code != 'XX'
        group by 1
    ) sdb on sdb.store_id = a2.store_id
where
    dr.store_category = 1
    and sdb.store_id is not null;
;-- -. . -..- - / . -. - .-. -.--
select -- 基于当日应派取扫描率
    tt.store_id 网点ID
    ,tt.store_name 网点名称
    ,tt.store_type 网点分类
    ,tt.piece_name 片区
    ,tt.region_name 大区
    ,tt.shoud_counts 应派总数
    ,tt.scan_fished_counts 分拣扫描数
    ,ifnull(tt.scan_fished_counts/shoud_counts,0) 分拣扫描率

    ,tt.youxiao_counts 有效分拣扫描数
    ,ifnull(tt.youxiao_counts/tt.scan_fished_counts,0) 有效分拣扫描率

    ,tt.1pai_counts 一派应派数
    ,tt.1pai_scan_fished_counts 一派分拣扫描数
    ,ifnull(tt.1pai_scan_fished_counts/tt.1pai_counts,0) 一派分拣扫描率

    ,tt.1pai_youxiao_counts 一派有效分拣扫描数
    ,ifnull(tt.1pai_youxiao_counts/tt.1pai_scan_fished_counts,0) 一派有效分拣扫描率

    ,case
	    when tt.1pai_youxiao_counts/tt.1pai_counts>=0.95 then 'A'
	    when tt.1pai_youxiao_counts/tt.1pai_counts>=0.90 then 'B'
	    when tt.1pai_youxiao_counts/tt.1pai_counts>=0.85 then 'C'
	    when tt.1pai_youxiao_counts/tt.1pai_counts>=0.80 then 'D'
	    else 'E'
	 end 一派有效分拣评级 -- 一派有效分拣

	 ,case
        when tt.1pai_hour_8_fished_counts/tt.1pai_counts>=0.95  then 'A'
        when tt.1pai_hour_8ban_fished_counts/tt.1pai_counts>=0.95  then 'B'
        when tt.1pai_hour_9_fished_counts/tt.1pai_counts>=0.95  then 'C'
        when tt.1pai_hour_9ban_fished_counts/tt.1pai_counts>=0.95  then 'D'
        else 'E'
    end 一派分拣评级

    ,ifnull(tt.1pai_hour_8_fished_counts/tt.1pai_counts,0) 一派8点前扫描占比
    ,ifnull(tt.1pai_hour_8ban_fished_counts/tt.1pai_counts,0) 一派8点半前扫描占比
    ,ifnull(tt.1pai_hour_9_fished_counts/tt.1pai_counts,0) 一派9点前扫描占比
    ,ifnull(tt.1pai_hour_9ban_fished_counts/tt.1pai_counts,0) 一派9点半前扫描占比
	,if(tt2.late_proof_counts is null , '否', '是') 是否有迟到超过规划时间20分钟的常规车
    ,tt2.max_real_arrive_time_normal 一派常规车最晚实际到达时间
#     ,tt2.max_real_arrive_proof_id 一派常规车最晚实际到达车线
#     ,tt2.max_real_arrive_vol 一派常规车最晚实际到达车线包裹量
    ,tt2.line_1_latest_plan_arrive_time 一派常规车最晚规划到达时间
    ,tt2.max_real_arrive_time_innormal 一派加班车最晚实际到达时间
#     ,tt2.max_real_arrive_innormal_proof_id  一派加班车最晚实际到达车线
#     ,tt2.max_real_arrive_innormal_vol  一派加班车最晚实际到达包裹量
    ,tt2.max_actual_plan_arrive_time_innormal 一派加班车最晚规划到达时间


from
(
    select
       base.store_id
       ,base.store_name
       ,base.store_type
       ,base.piece_name
       ,base.region_name
       ,count(distinct base.pno) shoud_counts
       ,count(distinct case when base.min_fenjian_scan_time is not null then base.pno else null end ) scan_fished_counts
       ,count(distinct case when base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then base.pno else null end ) youxiao_counts

       ,count(distinct case when base.type='一派' then  base.pno else null end ) 1pai_counts
       ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null then  base.pno else null end ) 1pai_scan_fished_counts
       ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then  base.pno else null end ) 1pai_youxiao_counts

       ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:00:00' then base.pno else null end) 1pai_hour_8_fished_counts
       ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:30:00' then base.pno else null end) 1pai_hour_8ban_fished_counts
       ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:00:00' then base.pno else null end) 1pai_hour_9_fished_counts
       ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:30:00' then base.pno else null end) 1pai_hour_9ban_fished_counts

    from
    (
       select
       t.*,
       case when t.should_delevry_type='1派应派包裹' then '一派' else null end 'type'
       from dwm.dwd_ph_dc_should_be_delivery_sort_scan t
       join ph_staging.sys_store ss
       on t.store_id =ss.id
    ) base
    group by base.store_id,base.store_name,base.store_type,base.piece_name,base.region_name
) tt

left join
(
    select
       bl.store_id
       ,bl.max_real_arrive_time_normal
       ,bl.max_real_arrive_proof_id
       ,bl.max_real_arrive_vol
       ,bl.line_1_latest_plan_arrive_time
       ,bl.max_actual_plan_arrive_time_innormal
       ,bl.max_actual_plan_arrive_innormal_proof_id
       ,bl.max_actual_plan_arrive_innormal_vol
       ,bl.max_real_arrive_time_innormal
       ,bl.max_real_arrive_innormal_proof_id
       ,bl.max_real_arrive_innormal_vol
	   ,late_proof_counts
    from dwm.fleet_real_detail_today bl
    group by 1,2,3,4,5,6,7,8,9,10,11
) tt2 on tt.store_id=tt2.store_id;
;-- -. . -..- - / . -. - .-. -.--
with t as
(
    select
        ds.dst_store_id store_id
        ,ss.name
        ,ds.pno
        ,convert_tz(pi.finished_at, '+00:00', '+08:00') finished_time
        ,pi.ticket_delivery_staff_info_id
        ,pi.state
        ,coalesce(hsi.store_id, hs.sys_store_id) hr_store_id
        ,coalesce(hsi.job_title, hs.job_title) job_title
        ,coalesce(hsi.formal, hs.formal) formal
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at) rk1
        ,row_number() over (partition by ds.dst_store_id, pi.ticket_delivery_staff_info_id order by pi.finished_at desc) rk2
    from dwm.dwd_ph_dc_should_be_delivery ds
    join ph_staging.parcel_info pi on pi.pno = ds.pno
    left join ph_staging.sys_store ss on ss.id = ds.dst_store_id
    left join ph_bi.hr_staff_transfer hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id and hsi.stat_date = '2023-09-11'
    left join ph_bi.hr_staff_info hs on hs.staff_info_id = pi.ticket_delivery_staff_info_id and if(hs.leave_date is null, 1 = 1, hs.leave_date >= '2023-09-11')
#     left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
    where
        pi.state = 5
#         and pi.finished_at >= '2023-08-01 16:00:00'
#         and pi.finished_at < '2023-08-02 16:00:00'
        and ds.p_date = '2023-09-11'
        and pi.finished_at >= date_sub('2023-09-11', interval 8 hour )
        and pi.finished_at < date_add('2023-09-11', interval 16 hour)
        and ds.should_delevry_type != '非当日应派'
#         and ds.dst_store_id = 'PH81180100'
)
select
    dp.store_id 网点ID
    ,dp.store_name 网点
    ,coalesce(dp.opening_at, '未记录') 开业时间
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,coalesce(cour.staf_num, 0) 本网点所属快递员数
    ,coalesce(ds.sd_num, 0) 应派件量
    ,coalesce(del.pno_num, 0) '妥投量(快递员+仓管+主管)'
    ,coalesce(del_cou.self_staff_num, 0) 参与妥投快递员_自有
    ,coalesce(del_cou.other_staff_num, 0) 参与妥投快递员_外协支援
    ,coalesce(del_cou.dco_dcs_num, 0) 参与妥投_仓管主管

    ,coalesce(del_cou.self_effect, 0) 当日人效_自有
    ,coalesce(del_cou.other_effect, 0) 当日人效_外协支援
    ,coalesce(del_cou.dco_dcs_effect, 0) 仓管主管人效
    ,coalesce(del_hour.avg_del_hour, 0) 派件小时数

    ,coalesce(backlog.in_house_count, 0) 在仓包裹数
    ,coalesce(backlog.big_in_house_count, 0) 在仓大件包裹数
    ,coalesce(backlog.big_client_count, 0) 在仓平台客户包裹数
    ,coalesce(backlog.small_client_count, 0) 在仓非平台客户包裹数
    ,coalesce(backlog.3_within_backlog_bigclient, 0) 平台客户在仓积压3天内包裹数
    ,coalesce(backlog.3_5_backlog_bigclient, 0) 平台客户在仓积压3_5天内包裹数
    ,coalesce(backlog.5_more_backlog_bigclient, 0) 平台客户在仓积压5天以上包裹数
    ,coalesce(backlog.tt_overtime_count, 0) tiktok超时效包裹数
from
    (
        select
            dp.store_id
            ,dp.store_name
            ,dp.opening_at
            ,dp.piece_name
            ,dp.region_name
        from dwm.dim_ph_sys_store_rd dp
        where
            dp.state_desc = '激活'
            and dp.stat_date = date_sub(curdate(), interval 1 day)
            and dp.store_category in (1)
    ) dp
left join
    (
        select
            hr.sys_store_id sys_store_id
            ,count(distinct hr.staff_info_id) staf_num
        from  ph_bi.hr_staff_info  hr
        where
            hr.formal = 1
            and hr.state = 1
            and hr.job_title in (13,110,1000)
#             and hr.stat_date = '${date}'
        group by 1
    ) cour on cour.sys_store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) sd_num
        from dwm.dwd_ph_dc_should_be_delivery ds
        where
             ds.should_delevry_type != '非当日应派'
            and ds.p_date = '2023-09-11'
        group by 1
    ) ds on ds.dst_store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct t1.pno) pno_num
        from t t1
        group by 1
    ) del on del.store_id = dp.store_id
left join
    (
        select
            t1.store_id
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_staff_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (13,110,1000) and t1.formal = 1, t1.ticket_delivery_staff_info_id, null)) self_effect
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_staff_num
            ,count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.pno, null))/count(distinct if((t1.hr_store_id != t1.store_id or t1.formal != 1) and t1.job_title in (13,110,1000), t1.ticket_delivery_staff_info_id, null)) other_effect

            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_num
            ,count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.pno, null))/count(distinct if(t1.hr_store_id = t1.store_id and t1.job_title in (16,37), t1.ticket_delivery_staff_info_id, null)) dco_dcs_effect
        from t t1
        group by 1
    ) del_cou on del_cou.store_id = dp.store_id
left join
    (
        select
            a.store_id
            ,a.name
            ,sum(diff_hour)/count(distinct a.ticket_delivery_staff_info_id) avg_del_hour
        from
            (
                select
                    t1.store_id
                    ,t1.name
                    ,t1.ticket_delivery_staff_info_id
                    ,t1.finished_time
                    ,t2.finished_time finished_at_2
                    ,timestampdiff(second, t1.finished_time, t2.finished_time)/3600 diff_hour
                from
                    (
                        select * from t t1 where t1.rk1 = 1
                    ) t1
                join
                    (
                        select * from t t2 where t2.rk2 = 2
                    ) t2 on t2.store_id = t1.store_id and t2.ticket_delivery_staff_info_id = t1.ticket_delivery_staff_info_id
            ) a
        group by 1,2
    ) del_hour on del_hour.store_id = dp.store_id
left join
    (
        select
            ds.dst_store_id
            ,count(distinct ds.pno) in_house_count
            ,count(distinct if(pi.exhibition_weight > 5000 or pi.exhibition_length + pi.exhibition_width + pi.exhibition_height > 80, ds.pno, null)) big_in_house_count
            ,count(distinct if(bc.client_id is not null, ds.pno, null)) big_client_count
            ,count(distinct if(bc.client_id is null, ds.pno, null)) small_client_count
            ,count(distinct if(datediff(now(), ds.first_valid_routed_at) <= 3 and bc.client_id is not null, ds.pno, null)) 3_within_backlog_bigclient
            ,count(distinct if(datediff(now(), ds.first_valid_routed_at) > 3 and datediff(now(), ds.first_valid_routed_at) <= 5 and bc.client_id is not null, ds.pno, null)) 3_5_backlog_bigclient
            ,count(distinct if(datediff(now(), ds.first_valid_routed_at) > 5 and bc.client_id is not null, ds.pno, null)) 5_more_backlog_bigclient
            ,count(distinct if(tsd.end_date < curdate(), ds.pno, null)) tt_overtime_count
        from dwm.dwd_ph_dc_should_be_delivery ds
        join ph_staging.parcel_info pi on pi.pno = ds.pno and pi.state not in (5,7,8,9)
        left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
        left join dwm.dwd_ex_ph_tiktok_sla_detail tsd on tsd.pno = ds.pno
        where
            ds.p_date = '2023-09-11'
        group by 1
    ) backlog on backlog.dst_store_id = dp.store_id;
;-- -. . -..- - / . -. - .-. -.--
select -- 基于当日应派取扫描率
    tt.store_id 网点ID
    ,tt.store_name 网点名称
    ,tt.store_type 网点分类
    ,tt.piece_name 片区
    ,tt.region_name 大区
    ,tt.shoud_counts 应派总数
    ,tt.scan_fished_counts 分拣扫描数
    ,ifnull(tt.scan_fished_counts/shoud_counts,0) 分拣扫描率

    ,tt.youxiao_counts 有效分拣扫描数
    ,ifnull(tt.youxiao_counts/tt.shoud_counts,0) 有效分拣扫描率

    ,tt.1pai_counts 一派应派数
    ,tt.1pai_scan_fished_counts 一派分拣扫描数
    ,ifnull(tt.1pai_scan_fished_counts/tt.1pai_counts,0) 一派分拣扫描率

    ,tt.1pai_youxiao_counts 一派有效分拣扫描数
    ,ifnull(tt.1pai_youxiao_counts/tt.1pai_counts,0) 一派有效分拣扫描率

    ,case
	    when tt.1pai_youxiao_counts/tt.1pai_counts>=0.95 then 'A'
	    when tt.1pai_youxiao_counts/tt.1pai_counts>=0.90 then 'B'
	    when tt.1pai_youxiao_counts/tt.1pai_counts>=0.85 then 'C'
	    when tt.1pai_youxiao_counts/tt.1pai_counts>=0.80 then 'D'
	    else 'E'
	 end 一派有效分拣评级 -- 一派有效分拣

	 ,case
        when tt.1pai_hour_8_fished_counts/tt.1pai_counts>=0.95  then 'A'
        when tt.1pai_hour_8ban_fished_counts/tt.1pai_counts>=0.95  then 'B'
        when tt.1pai_hour_9_fished_counts/tt.1pai_counts>=0.95  then 'C'
        when tt.1pai_hour_9ban_fished_counts/tt.1pai_counts>=0.95  then 'D'
        else 'E'
    end 一派分拣评级

    ,ifnull(tt.1pai_hour_8_fished_counts/tt.1pai_counts,0) 一派8点前扫描占比
    ,ifnull(tt.1pai_hour_8ban_fished_counts/tt.1pai_counts,0) 一派8点半前扫描占比
    ,ifnull(tt.1pai_hour_9_fished_counts/tt.1pai_counts,0) 一派9点前扫描占比
    ,ifnull(tt.1pai_hour_9ban_fished_counts/tt.1pai_counts,0) 一派9点半前扫描占比
	,if(tt2.late_proof_counts is null , '否', '是') 是否有迟到超过规划时间20分钟的常规车
    ,tt2.max_real_arrive_time_normal 一派常规车最晚实际到达时间
#     ,tt2.max_real_arrive_proof_id 一派常规车最晚实际到达车线
#     ,tt2.max_real_arrive_vol 一派常规车最晚实际到达车线包裹量
    ,tt2.line_1_latest_plan_arrive_time 一派常规车最晚规划到达时间
    ,tt2.max_real_arrive_time_innormal 一派加班车最晚实际到达时间
#     ,tt2.max_real_arrive_innormal_proof_id  一派加班车最晚实际到达车线
#     ,tt2.max_real_arrive_innormal_vol  一派加班车最晚实际到达包裹量
    ,tt2.max_actual_plan_arrive_time_innormal 一派加班车最晚规划到达时间


from
(
    select
       base.store_id
       ,base.store_name
       ,base.store_type
       ,base.piece_name
       ,base.region_name
       ,count(distinct base.pno) shoud_counts
       ,count(distinct case when base.min_fenjian_scan_time is not null then base.pno else null end ) scan_fished_counts
       ,count(distinct case when base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then base.pno else null end ) youxiao_counts

       ,count(distinct case when base.type='一派' then  base.pno else null end ) 1pai_counts
       ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null then  base.pno else null end ) 1pai_scan_fished_counts
       ,count(distinct case when base.type='一派' and base.min_fenjian_scan_time is not null and base.min_fenjian_scan_time<tiaozheng_scan_deadline_time then  base.pno else null end ) 1pai_youxiao_counts

       ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:00:00' then base.pno else null end) 1pai_hour_8_fished_counts
       ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='08:30:00' then base.pno else null end) 1pai_hour_8ban_fished_counts
       ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:00:00' then base.pno else null end) 1pai_hour_9_fished_counts
       ,count(distinct case when base.type='一派' and date_format(base.min_fenjian_scan_time,'%H:%i:%s')<='09:30:00' then base.pno else null end) 1pai_hour_9ban_fished_counts

    from
    (
       select
       t.*,
       case when t.should_delevry_type='1派应派包裹' then '一派' else null end 'type'
       from dwm.dwd_ph_dc_should_be_delivery_sort_scan t
       join ph_staging.sys_store ss
       on t.store_id =ss.id
    ) base
    group by base.store_id,base.store_name,base.store_type,base.piece_name,base.region_name
) tt

left join
(
    select
       bl.store_id
       ,bl.max_real_arrive_time_normal
       ,bl.max_real_arrive_proof_id
       ,bl.max_real_arrive_vol
       ,bl.line_1_latest_plan_arrive_time
       ,bl.max_actual_plan_arrive_time_innormal
       ,bl.max_actual_plan_arrive_innormal_proof_id
       ,bl.max_actual_plan_arrive_innormal_vol
       ,bl.max_real_arrive_time_innormal
       ,bl.max_real_arrive_innormal_proof_id
       ,bl.max_real_arrive_innormal_vol
	   ,late_proof_counts
    from dwm.fleet_real_detail_today bl
    group by 1,2,3,4,5,6,7,8,9,10,11
) tt2 on tt.store_id=tt2.store_id;