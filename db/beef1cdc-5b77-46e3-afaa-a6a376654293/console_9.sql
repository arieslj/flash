with t as
(
    select
        plt.pno
    from fle_dwd.dwd_bi_parcel_lose_task_di plt
    where
        plt.p_date >= '2023-02-28'
        and plt.state = '6'
        and plt.duty_result = '1'
        and plt.updated_at >= '2023-05-01'
        and plt.updated_at < '2023-06-01'
    group by 1
)
select
    count(`if`(inv.inv_num = 1, inv.pno, null)) `改约1次`
    ,count(`if`(inv.inv_num = 2, inv.pno, null)) `改约2次`
    ,count(`if`(inv.inv_num = 3, inv.pno, null)) `改约3次`
    ,count(`if`(inv.inv_num = 4, inv.pno, null)) `改约4次`
    ,count(`if`(inv.inv_num = 5, inv.pno, null)) `改约5次`
    ,count(`if`(inv.inv_num = 6, inv.pno, null)) `改约6次`
    ,count(`if`(inv.inv_num >= 7, inv.pno, null)) `改约7次以上`
from
    (
        select
            dpr.pno
            ,count(distinct to_date(dpr.routed_at) ) inv_num
        from fle_dwd.dwd_wide_fle_route_and_parcel_created_at dpr
        where
            dpr.p_date in ('2023-05-18','2023-05-16','2023-05-13','2023-05-26','2023-05-20','2023-05-17','2023-03-23','2023-02-27','2023-04-27','2023-05-12','2023-05-14','2023-05-06','2023-05-21','2023-05-11','2023-05-15','2023-05-09','2023-03-31','2023-05-05','2023-05-27','2023-05-22','2023-05-24','2023-04-20','2023-05-19','2023-05-08','2023-04-08','2023-05-10','2023-04-21','2023-03-25','2023-04-10','2023-04-30','2023-04-19','2023-04-12','2023-04-14','2023-05-07','2023-04-09','2023-05-04','2023-05-01','2023-04-29','2023-03-30','2023-05-03','2023-03-12','2023-03-09','2023-05-02','2023-04-26','2023-04-03','2023-04-17','2023-04-25','2023-04-28','2023-03-20','2023-04-05','2023-04-22','2023-03-29','2023-04-01','2023-04-11','2023-04-23','2023-04-13','2023-04-24','2023-04-07','2023-04-18','2023-03-18','2023-02-24','2023-04-02','2023-04-04','2023-04-06','2023-01-20','2023-04-16','2023-03-28','2023-02-09','2023-04-15','2023-05-25','2023-03-22','2023-03-08','2023-03-16','2023-03-26','2023-03-11','2023-02-28','2023-03-21','2023-05-23','2023-02-18','2023-03-07','2023-03-27','2023-03-05','2023-03-02','2023-03-03','2023-03-10','2023-03-19','2023-03-17','2023-03-01','2023-03-24','2023-02-07','2023-02-17','2022-11-15','2023-01-24','2023-03-06','2023-03-15','2023-02-05','2023-01-31','2023-02-11','2023-03-13','2023-02-14','2023-03-04','2023-02-01','2023-02-08','2022-12-15','2023-03-14','2022-09-01','2022-12-26','2022-11-16','2022-12-08','2023-01-23','2023-05-28','2023-01-26','2022-09-06','2022-10-28','2022-08-09','2023-02-21','2022-12-12','2023-01-28','2022-08-23','2023-01-03','2023-02-04','2023-02-03','2022-12-29','2023-02-23','2023-01-14','2023-05-29','2023-02-22','2023-02-25','2023-02-20','2023-02-19','2022-12-06','2022-11-28','2023-02-12','2023-02-16','2022-12-24','2023-02-15','2023-01-05','2023-02-13','2022-08-14','2023-01-07','2022-11-30','2023-01-27','2023-01-04','2022-07-17','2022-12-14','2022-12-01','2022-11-12','2022-12-25')
            and dpr.route_action = 'DELIVERY_MARKER'
            and dpr.marker_category in ('9','14','70')
        group by 1
    ) inv
join t t1 on t1.pno = inv.pno

;


with t as
(
    select
        plt.pno
    from fle_dwd.dwd_bi_parcel_lose_task_di plt
    where
        plt.p_date >= '2023-02-28'
        and plt.state = '6'
        and plt.duty_result = '1'
        and plt.updated_at >= '2023-05-01'
        and plt.updated_at < '2023-06-01'
    group by 1
)
select
    count(`if`(inv.inv_num = 1, inv.pno, null)) `盘库1次`
    ,count(`if`(inv.inv_num = 2, inv.pno, null)) `盘库2次`
    ,count(`if`(inv.inv_num = 3, inv.pno, null)) `盘库3次`
    ,count(`if`(inv.inv_num = 4, inv.pno, null)) `盘库4次`
    ,count(`if`(inv.inv_num = 5, inv.pno, null)) `盘库5次`
    ,count(`if`(inv.inv_num = 6, inv.pno, null)) `盘库6次`
    ,count(`if`(inv.inv_num >= 7, inv.pno, null)) `盘库7次以上`
from
    (
        select
            dpr.pno
            ,count(dpr.id) inv_num
        from fle_dwd.dwd_wide_fle_route_and_parcel_created_at dpr
        where
            dpr.p_date in ('2023-05-18','2023-05-16','2023-05-13','2023-05-26','2023-05-20','2023-05-17','2023-03-23','2023-02-27','2023-04-27','2023-05-12','2023-05-14','2023-05-06','2023-05-21','2023-05-11','2023-05-15','2023-05-09','2023-03-31','2023-05-05','2023-05-27','2023-05-22','2023-05-24','2023-04-20','2023-05-19','2023-05-08','2023-04-08','2023-05-10','2023-04-21','2023-03-25','2023-04-10','2023-04-30','2023-04-19','2023-04-12','2023-04-14','2023-05-07','2023-04-09','2023-05-04','2023-05-01','2023-04-29','2023-03-30','2023-05-03','2023-03-12','2023-03-09','2023-05-02','2023-04-26','2023-04-03','2023-04-17','2023-04-25','2023-04-28','2023-03-20','2023-04-05','2023-04-22','2023-03-29','2023-04-01','2023-04-11','2023-04-23','2023-04-13','2023-04-24','2023-04-07','2023-04-18','2023-03-18','2023-02-24','2023-04-02','2023-04-04','2023-04-06','2023-01-20','2023-04-16','2023-03-28','2023-02-09','2023-04-15','2023-05-25','2023-03-22','2023-03-08','2023-03-16','2023-03-26','2023-03-11','2023-02-28','2023-03-21','2023-05-23','2023-02-18','2023-03-07','2023-03-27','2023-03-05','2023-03-02','2023-03-03','2023-03-10','2023-03-19','2023-03-17','2023-03-01','2023-03-24','2023-02-07','2023-02-17','2022-11-15','2023-01-24','2023-03-06','2023-03-15','2023-02-05','2023-01-31','2023-02-11','2023-03-13','2023-02-14','2023-03-04','2023-02-01','2023-02-08','2022-12-15','2023-03-14','2022-09-01','2022-12-26','2022-11-16','2022-12-08','2023-01-23','2023-05-28','2023-01-26','2022-09-06','2022-10-28','2022-08-09','2023-02-21','2022-12-12','2023-01-28','2022-08-23','2023-01-03','2023-02-04','2023-02-03','2022-12-29','2023-02-23','2023-01-14','2023-05-29','2023-02-22','2023-02-25','2023-02-20','2023-02-19','2022-12-06','2022-11-28','2023-02-12','2023-02-16','2022-12-24','2023-02-15','2023-01-05','2023-02-13','2022-08-14','2023-01-07','2022-11-30','2023-01-27','2023-01-04','2022-07-17','2022-12-14','2022-12-01','2022-11-12','2022-12-25')
            and dpr.route_action = 'INVENTORY'
        group by 1
    ) inv
join t t1 on t1.pno = inv.pno