select
    pi.pno 单号
    ,pi.customary_pno 正向单号
    ,ss2.name 正向揽收网点
    ,ss.name 退件妥投网点
    ,pai.cogs_amount/100 cogs
    ,pi2.cod_amount/100 cod
    ,pi.ticket_delivery_staff_info_id 妥投员工
    ,hsi.name 妥投员工
    ,hsi.hire_date 入职日期
    ,pi.client_id 客户ID
    ,kp.name 客户名称
    ,pi.exhibition_weight 重量
    ,concat_ws('*', pi.exhibition_length, pi.exhibition_width, pi.exhibition_height) 尺寸
    ,st_distance_sphere(point(pi.ticket_delivery_staff_lng, pi.ticket_delivery_staff_lat), point(ss.lng, ss.lat)) 距离妥投网点距离
    ,st_distance_sphere(point(pi.ticket_delivery_staff_lng, pi.ticket_delivery_staff_lat), point(pi2.ticket_pickup_staff_lng, pi2.ticket_pickup_staff_lat)) 距离仓库距离
    ,if(p1.pno is not null, '是', '否') 是否有拨打电话
    ,if(p2.pno is not null, '是', '否') 是否有播通的电话
from ph_staging.parcel_info pi
left join ph_staging.parcel_info pi2 on pi2.pno = pi.customary_pno
left join ph_staging.parcel_additional_info pai on pai.pno = pi.customary_pno
left join ph_bi.hr_staff_info hsi on hsi.staff_info_id = pi.ticket_delivery_staff_info_id
left join ph_staging.ka_profile kp on kp.id = pi.client_id
left join ph_staging.ka_warehouse kw on kw.id = pi2.ka_warehouse_id
left join ph_staging.sys_store ss on ss.id = pi.ticket_delivery_store_id
left join ph_staging.sys_store ss2 on ss2.id = pi2.ticket_pickup_store_id
# left join ph_staging.sys_store ss3 on ss3.id = pi.ticket_pickup_store_id
left join
    (
        select
            pi.pno
        from ph_staging.parcel_info pi
        join ph_staging.parcel_route pr on pr.pno = pi.pno
        where
            pr.route_action = 'PHONE'
            and pr.routed_at < pi.finished_at
            and pi.pno in ('P61012NEHG3FY','P61012NDNC4FY','P61012NEGYYFY','P61012NDBE2FY','P61012NEGK1FY','P61012NDBY1FY','P61012NE4F3FY','P61012MYZFVFY','P61012MX6TBFY','P61012MY2TNFY','P61012KPMZSFY','P61012NDHP6FY','P61012KPMXJFY','P61012KPG2XFY','P61012NE47XFY','P61012KNVAJFY','P61012KNU1PFY','P61012KPW08FY','P61012KNRMBFY','P61012KNND5FY','P61012KNXNAFY','P61012KNBU1FY','P61012KZKY3FY','P61012KMZ5UFY','P61012K45E3FY','P61012JKD61FY','P61012MMX8MFY','P61012K2Z4WFY','P61012K20MUFY','P61012K25GKFY','P61012K2BCEFY','P61012JT0HEFY','P61012MVWDKFY','P61012KQ739FY','P61012KBYFJFY','P61012KACGVFY','P61012KAZVQFY','P61012HGUHCFY','P61012JGP0YFY','P61012H40FRFY','P61012JF6SYFY','P61012H3AZMFY','P61012KMJYJFY','P61012KNBQHFY','P61012MSRXWFY','P61012MAD44FY','P61012MB3PCFY','P61012MA3SZFY','P61012MBYCAFY','P61012MBZV5FY','P61012MACSDFY','P61012MAN9UFY','P61012MAS6CFY','P61012M99W3FY','P61012MBB47FY','P61012MB0W4FY','P61012MBJ0PFY','P61012MAE6HFY','P61012MBA3SFY','P61012MBBZXFY','P61012MB8GNFY','P61012MB1F3FY','P61012MA91AFY','P61012MBG9QFY','P61012MB8ZYFY','P61012MBBEPFY','P61012MAYC0FY','P61012M95TUFY','P61012MB4UHFY','P61012MBE5RFY','P61012MAZZGFY','P61012MBV9UFY','P61012MBAV0FY','P61012KPW9BFY','P61012KAH9DFY','P61012KZZYWFY','P61012KQ2UHFY','P61012KZWEFFY','P61012K2R15FY','P61012JTCVYFY','P61012JG1P3FY','P61012MB449FY','P61012K5G35FY','P61012KP0ZWFY','P61012KZWAHFY','P61012MA2ZFFY','P61012K2ZEEFY','P61012KARPYFY','P61012MAZDMFY','P61012MAFXMFY','P61012JH18EFY','P61012J5UEXFY','P61012HFREZFY','P61012J4SFFFY','P61012HGBQAFY','P61012HJQZ2FY','P61012GKBZYFY','P61012GK2S7FY','P61012H30ZEFY','P61012FXXUEFY','P61012HDMA3FY','P61012K4DV3FY','P61012GN35WFY','P61012GKA8BFY','P61012H29FEFY','P61012GVXQKFY','P61012H5KRXFY','P61012HWUPVFY','P61012KANGYFY','P61012GJM7SFY','P61012GK4HUFY','P61012GK6JVFY','P61012JH9UNFY','P61012G04EMFY','P61012MYNYJFY','P61012MMQ3NFY','P61012H2EXMFY','P61012MMP0SFY','P61012MP1VHFY','P61012MYKEVFY','P61012M96SVFY','P61012KPWHXFY','P61012JGD9ZFY','P61012MN71EFY','P61012J4E16FY','P61012JH1ASFY','P61012JD99KFY','P61012JFC47FY','P61012H3Q9WFY','P61012J7VQ6FY')
            and json_extract(pr.extra_value, '$.diaboloDuration') > 0
        group by 1
    ) p1 on p1.pno = pi.pno
left join
    (
        select
            pi.pno
        from ph_staging.parcel_info pi
        join ph_staging.parcel_route pr on pr.pno = pi.pno
        where
            pr.route_action = 'PHONE'
            and pr.routed_at < pi.finished_at
            and pi.pno in ('P61012NEHG3FY','P61012NDNC4FY','P61012NEGYYFY','P61012NDBE2FY','P61012NEGK1FY','P61012NDBY1FY','P61012NE4F3FY','P61012MYZFVFY','P61012MX6TBFY','P61012MY2TNFY','P61012KPMZSFY','P61012NDHP6FY','P61012KPMXJFY','P61012KPG2XFY','P61012NE47XFY','P61012KNVAJFY','P61012KNU1PFY','P61012KPW08FY','P61012KNRMBFY','P61012KNND5FY','P61012KNXNAFY','P61012KNBU1FY','P61012KZKY3FY','P61012KMZ5UFY','P61012K45E3FY','P61012JKD61FY','P61012MMX8MFY','P61012K2Z4WFY','P61012K20MUFY','P61012K25GKFY','P61012K2BCEFY','P61012JT0HEFY','P61012MVWDKFY','P61012KQ739FY','P61012KBYFJFY','P61012KACGVFY','P61012KAZVQFY','P61012HGUHCFY','P61012JGP0YFY','P61012H40FRFY','P61012JF6SYFY','P61012H3AZMFY','P61012KMJYJFY','P61012KNBQHFY','P61012MSRXWFY','P61012MAD44FY','P61012MB3PCFY','P61012MA3SZFY','P61012MBYCAFY','P61012MBZV5FY','P61012MACSDFY','P61012MAN9UFY','P61012MAS6CFY','P61012M99W3FY','P61012MBB47FY','P61012MB0W4FY','P61012MBJ0PFY','P61012MAE6HFY','P61012MBA3SFY','P61012MBBZXFY','P61012MB8GNFY','P61012MB1F3FY','P61012MA91AFY','P61012MBG9QFY','P61012MB8ZYFY','P61012MBBEPFY','P61012MAYC0FY','P61012M95TUFY','P61012MB4UHFY','P61012MBE5RFY','P61012MAZZGFY','P61012MBV9UFY','P61012MBAV0FY','P61012KPW9BFY','P61012KAH9DFY','P61012KZZYWFY','P61012KQ2UHFY','P61012KZWEFFY','P61012K2R15FY','P61012JTCVYFY','P61012JG1P3FY','P61012MB449FY','P61012K5G35FY','P61012KP0ZWFY','P61012KZWAHFY','P61012MA2ZFFY','P61012K2ZEEFY','P61012KARPYFY','P61012MAZDMFY','P61012MAFXMFY','P61012JH18EFY','P61012J5UEXFY','P61012HFREZFY','P61012J4SFFFY','P61012HGBQAFY','P61012HJQZ2FY','P61012GKBZYFY','P61012GK2S7FY','P61012H30ZEFY','P61012FXXUEFY','P61012HDMA3FY','P61012K4DV3FY','P61012GN35WFY','P61012GKA8BFY','P61012H29FEFY','P61012GVXQKFY','P61012H5KRXFY','P61012HWUPVFY','P61012KANGYFY','P61012GJM7SFY','P61012GK4HUFY','P61012GK6JVFY','P61012JH9UNFY','P61012G04EMFY','P61012MYNYJFY','P61012MMQ3NFY','P61012H2EXMFY','P61012MMP0SFY','P61012MP1VHFY','P61012MYKEVFY','P61012M96SVFY','P61012KPWHXFY','P61012JGD9ZFY','P61012MN71EFY','P61012J4E16FY','P61012JH1ASFY','P61012JD99KFY','P61012JFC47FY','P61012H3Q9WFY','P61012J7VQ6FY')
            and json_extract(pr.extra_value, '$.callDuration') > 0
        group by 1
    ) p2 on p2.pno = pi.pno
where
    pi.pno in ('P61012NEHG3FY','P61012NDNC4FY','P61012NEGYYFY','P61012NDBE2FY','P61012NEGK1FY','P61012NDBY1FY','P61012NE4F3FY','P61012MYZFVFY','P61012MX6TBFY','P61012MY2TNFY','P61012KPMZSFY','P61012NDHP6FY','P61012KPMXJFY','P61012KPG2XFY','P61012NE47XFY','P61012KNVAJFY','P61012KNU1PFY','P61012KPW08FY','P61012KNRMBFY','P61012KNND5FY','P61012KNXNAFY','P61012KNBU1FY','P61012KZKY3FY','P61012KMZ5UFY','P61012K45E3FY','P61012JKD61FY','P61012MMX8MFY','P61012K2Z4WFY','P61012K20MUFY','P61012K25GKFY','P61012K2BCEFY','P61012JT0HEFY','P61012MVWDKFY','P61012KQ739FY','P61012KBYFJFY','P61012KACGVFY','P61012KAZVQFY','P61012HGUHCFY','P61012JGP0YFY','P61012H40FRFY','P61012JF6SYFY','P61012H3AZMFY','P61012KMJYJFY','P61012KNBQHFY','P61012MSRXWFY','P61012MAD44FY','P61012MB3PCFY','P61012MA3SZFY','P61012MBYCAFY','P61012MBZV5FY','P61012MACSDFY','P61012MAN9UFY','P61012MAS6CFY','P61012M99W3FY','P61012MBB47FY','P61012MB0W4FY','P61012MBJ0PFY','P61012MAE6HFY','P61012MBA3SFY','P61012MBBZXFY','P61012MB8GNFY','P61012MB1F3FY','P61012MA91AFY','P61012MBG9QFY','P61012MB8ZYFY','P61012MBBEPFY','P61012MAYC0FY','P61012M95TUFY','P61012MB4UHFY','P61012MBE5RFY','P61012MAZZGFY','P61012MBV9UFY','P61012MBAV0FY','P61012KPW9BFY','P61012KAH9DFY','P61012KZZYWFY','P61012KQ2UHFY','P61012KZWEFFY','P61012K2R15FY','P61012JTCVYFY','P61012JG1P3FY','P61012MB449FY','P61012K5G35FY','P61012KP0ZWFY','P61012KZWAHFY','P61012MA2ZFFY','P61012K2ZEEFY','P61012KARPYFY','P61012MAZDMFY','P61012MAFXMFY','P61012JH18EFY','P61012J5UEXFY','P61012HFREZFY','P61012J4SFFFY','P61012HGBQAFY','P61012HJQZ2FY','P61012GKBZYFY','P61012GK2S7FY','P61012H30ZEFY','P61012FXXUEFY','P61012HDMA3FY','P61012K4DV3FY','P61012GN35WFY','P61012GKA8BFY','P61012H29FEFY','P61012GVXQKFY','P61012H5KRXFY','P61012HWUPVFY','P61012KANGYFY','P61012GJM7SFY','P61012GK4HUFY','P61012GK6JVFY','P61012JH9UNFY','P61012G04EMFY','P61012MYNYJFY','P61012MMQ3NFY','P61012H2EXMFY','P61012MMP0SFY','P61012MP1VHFY','P61012MYKEVFY','P61012M96SVFY','P61012KPWHXFY','P61012JGD9ZFY','P61012MN71EFY','P61012J4E16FY','P61012JH1ASFY','P61012JD99KFY','P61012JFC47FY','P61012H3Q9WFY','P61012J7VQ6FY')