select
    a.next_store_id
    ,count(distinct a.proof_id) num
from
    (
        select
            ft.next_store_id
            ,ft.proof_id
            ,if(ft.sign_time is null , ft.real_arrive_time, least(ft.sign_time, ft.real_arrive_time)) arr_time
            ,ft.plan_arrive_time
        from ph_bi.fleet_time ft
        where
            ft.fleet_status = 1
            and ft.real_arrive_time >= '2023-08-01 16:00:00'
            and ft.real_arrive_time < '2023-08-02 16:00:00'
            and ft.arrive_type in (3,5)
    ) a
where
    timestampdiff(minute , a.plan_arrive_time, a.arr_time) > 20
group by 1



;



with ttt_p as
    (select
		ft.line_id
		,ft.line_name
		,ft.real_arrive_time
		,ft.next_store_id
		,ft.next_store_name
		,ft.sign_time
		,ft.plan_arrive_time
		,ft.proof_id

		,case when ft.real_arrive_time is not null and ft.sign_time is not null and ft.real_arrive_time < ft.sign_time then ft.real_arrive_time
		  when ft.real_arrive_time is not null and ft.sign_time is not null and ft.real_arrive_time > ft.sign_time then ft.sign_time
		  when ft.real_arrive_time is not null then ft.real_arrive_time
		  when ft.real_arrive_time is null then ft.sign_time else null
		 end as real_real_arrive_time
        ,timestampdiff(minute,ft.plan_arrive_time,case when ft.real_arrive_time is not null and ft.sign_time is not null and ft.real_arrive_time < ft.sign_time then ft.real_arrive_time
		  when ft.real_arrive_time is not null and ft.sign_time is not null and ft.real_arrive_time > ft.sign_time then ft.sign_time
		  when ft.real_arrive_time is not null then ft.real_arrive_time
		  when ft.real_arrive_time is null then ft.sign_time else null
		 end ) as diff_mi
		,if(ft.line_mode=1,'常规车','加班车') as mode_type

		from ph_staging.fleet_van_line fvl
		left join ph_staging.fleet_van_line_timetable fvlt on fvl.id=fvlt.line_id and fvlt.deleted=0
		left join ph_bi.fleet_time ft on ft.line_id=fvlt.line_id and ft.next_store_id=fvlt.store_id and ft.fleet_status=1 # 完成
		left join ph_staging.sys_store ss on fvl.origin_id=ss.id
		left join ph_staging.sys_store ss1 on fvl.target_id=ss1.id
		left join ph_staging.sys_store ss2 on fvlt.store_id=ss2.id

		where
		date(case when ft.real_arrive_time is not null and ft.sign_time is not null and ft.real_arrive_time < ft.sign_time then ft.real_arrive_time
					when ft.real_arrive_time is not null and ft.sign_time is not null and ft.real_arrive_time > ft.sign_time then ft.sign_time
					when ft.real_arrive_time is not null then ft.real_arrive_time
					when ft.real_arrive_time is null then ft.sign_time else null end)='2023-08-02'
		and fvl.deleted=0
		and fvl.mode in(1,2,3)
		and ss1.category in(1,14)
		and (ss.category=8 or ss.id in ( 'PH20180101', 'PH26110100', 'PH59020701','PH42030J00', 'PH36100100','PH76190100', 'PH34420100', 'PH73020100', 'PH81161D00', 'PH80050100'))
		and fvlt.order_no>=2
		and ss2.category in(1,14)
		and ft.line_mode in(1,2,3)
		and ft.arrive_type in(3,5)
)

select
    t.next_store_id
	,count(if(t.diff_mi>20,t.proof_id,null)) as pnm_cn
from ttt_p as t
where t.mode_type='常规车'
group by 1
;





with t as
(
        select
            pr.pno
            ,pr.routed_at
        from ph_staging.parcel_route pr
        join dwm.dwd_dim_dict ddd on ddd.element = pr.route_action and ddd.db = 'ph_staging' and ddd.tablename = 'parcel_route' and ddd.remark = 'valid'
        where
            pr.routed_at > '2023-08-07 16:00:00'
        group by 1,2
)
select
    pr.pno
from ph_staging.parcel_route pr
join t t1 on t1.pno = pr.pno and pr.routed_at < t1.routed_at
where
    pr.route_action = 'CHANGE_PARCEL_CLOSE'
group by 1

;





select
    pi.pno
    ,pi.dst_phone
    ,pi.dst_home_phone
from ph_staging.parcel_info pi
where
    pi.pno in ('PT140922B3X03AM','PT140922ADAN9AM','PT140922C23G8AM','PT1409229SFX0AK','PT140922DQC48AK','PT140922D2M31AE','PT140922B7YV5AE','PT140122C09S2AL','PT1401228U2A4AC','PT140122BDN03AB','PT140122AWKS3AC','PT140122CM3T1BC','PT1401228PA10BC','PT140122DWWH9BC','PT140122CYAU1AQ','PT140122BWNU6AW','PT140122D3TJ8BC','PT260522BQWS4AZ','PT140122D4SW7AY','PT140122D1P67AF','PT140122ACKQ1AD','PT140122AH2W3AO','PT140122DFPB4AF','PT140122CX9D5AD','PT140922BR612AK','PT140122CUWF9AM','PT1401229FHN2AM','PT1401228XC25AM','PT140122D5W66BC','PT140122CPN10BF','PT140122BY8T1BC','PT140122CDD27BF','PT140122BYBT7AV','PT140122CYJ36AC','PT140122B3601AC','PT140122AYVV4AC','PT140122BR0V4AL','PT140122ADSF6AM','PT140122E74M7AL','PT1401229Q7R5AM','PT140922CN3A0AK','PT140922AM030AE','PT140122BWDD5BE','PT140922DN1W7AK','PT140122CAPD7AL','PT140122A5K93AC','PT140122C7PJ9AC','PT140122AFXB0AL','PT140122CGNH7AG','PT140122D0EF0AC','PT1401229NED5AM','PT140122BWRF8AO','PT140122C9PV1AF','PT140922C20Y2AP','PT14092293SW5AE','PT140922A5ST3AP','PT1409228TNU1AM','PT140922CGBC3AP','PT1401229QXZ2AO','PT1409229UW79AM','PT140922CWWM7AM','PT1409228YPD6AE','PT140922BT6X8AP','PT140122DG872AO','PT140122E5XT0AM','PT140122CRUX2AM','PT140122AGPM6AL','PT140122D1KX5AM','PT611022DJAD2AE','PT140122APYV5AM','PT140122C12D2AH','PT140122C0VV8AM','PT1401229YNR5AL','PT140122DK4V2AC','PT140122CYEY8AC','PT140122DCDX5AL','PT140122AP6Q1AM','PT1401229Z1Z1AM','PT140122CMG29AF','PT140122CZ7F7AM','PT140122DJ8J4BF','PT140122AMR15AM','PT140122ACVW4AM','PT140122B9ED4AL','PT140922A9PH2AK','PT140122C71J8AC','PT140122BTA63AM','PT140122CKN02AM','PT140122B0573AM','PT140122DKGW3AM','PT140122CQ045AM','PT14092211KY6AP','PT140122CX2D9AM','PT140122CKAW4AG','PT140922E5GT5AK','PT140122DFH02AC','PT140122CBMX0AC','PT140122D9DS8AC','PT140122CYZG0AC','PT140122AMWF7AB','PT1401222YPN6AB','PT1401228NFF3AB','PT140122C97U4AB','PT1401229ZXR0AS','PT140122C2Y13AM','PT140122CYNV1AB','PT140122DDDN9BF','PT140122CG1Z4BC','PT140122C8EC1BC','PT140122ATK35BC','PT140122DG275AO','PT140122C8JB6BF','PT140122CXW39BC','PT140922DMKX4AE','PT140922BSG57AP','PT140922AF234AM','PT1409228Z101AE','PT140922E70R4AM','PT140122DMQ73AM','PT140122CX4K8AM','PT140122DPF72AL','PT140922DN050AH','PT140122BZZQ5AL','PT140922DK7K8AK','PT140122BRD65AC','PT140122CA5X1AL','PT140122D0741BF','PT140122E1PY9BF','PT141522BE3Z9AX','PT140122E1N97BF','PT140122CERT2AC','PT140122AZD00AC','PT140122APNF2AM','PT1401228X3Z9AC','PT140122BF6Q9AM','PT140122DU3Z9BA','PT140122CQSJ9AO','PT140122DD788BA','PT1401229W5V6AP','PT140122BQRH0AB','PT140122AJ3W4AF','PT140122CX359AF','PT140122BEKH8AO','PT140122CV519AF','PT140122CGTB2AP','PT140122APNT7AO','PT140122E7MA9AG','PT140122AHY19AF','PT140922E57X6AE','PT1409229TN38AP','PT140922C57Y5AP','PT1409225ERK0AM','PT150722AB5Q8AR','PT1409229TJK1AM','PT140922CRM36AP','PT140122BP2Y6AM','PT140122BAXS1AM','PT140122CX6Y5AC','PT140122C7RN0AC','PT14012294UY6AC','PT140122AM5X2AC','PT140122DHB40AM','PT140922A1D51AK','PT140122CQFG4AL','PT140122E6RV3AM','PT140122D8373AC','PT140122C9321AL','PT1401229KDJ4AM','PT140122D4T36AB','PT140122B0393AL','PT140122C1D95AS','PT140122DFKX0AB','PT1401229SWX9AB','PT140122BX6Q6BF','PT140922BKZY7AB','PT140122AJ1K2BF','PT140122CEU36BC','PT140922A9F09AM','PT140922BNJ16AE','PT140922CFP90AM','PT140922AV4Y0AM','PT140122C2JF8AC','PT140122C2RX3AM','PT140122E8Y85AM','PT140122DUC50AM','PT140122C8C68AM','PT140122D4Q61AC','PT140122CK175AC','PT140122CVMW4AM','PT140122D5W49AM','PT140122D0J79BF','PT14092291RH8AK','PT140122B6RE6AM','PT140122E8JM6AM','PT140122DA2Z5AC','PT140922AKDK1AS','PT140122E2S40AM','PT140122CY7T5AL','PT1409229SGR6AK','PT140922A4EY3AK','PT140122D4MN6BC','PT1401221FTA3AQ','PT140922BTH43AK','P14011YPUVJAQ','PT140122CD3E8BC','PT140122BQF70BF','PT140122BKRB0AM','PT140122CXG69AC','PT140122C78M7AM','PT140122E6728AM','PT140122B72P0AM','PT140122AB249AL','PT140122BEJR0AM','PT140122B5BP9AM','PT140122AJ756AM','PT140122AKKR3AM','PT140122AQFS9AC','PT140122DMPR3AC','PT140122CJ4C4AL','PT140122D1B98AM','PT140122AN4V3AM','PT140122CM7D9AF','PT140122BWVZ8AC','PT1401228GJ35AC','PT140922AH7F3AK','PT140122DG0S3AR','PT140122CP7M9AB','PT140122BPN89AB','PT140122CR6J4AB','PT140122AKEZ4BC','PT1401228N408AB','PT140122DPM84BB','PT140122CGP17AB','PT140122AZDU5AB','PT140122CDAJ2AW','PT140122BXZ43BF','PT140122DP4Y7BF','PT140122DNV48BF','PT140122BS0H4BC','PT140122C8UH1BF','PT140122AMGT3AH','PT140122BKM33BG','PT140122E6S99AM','PT140122DXEY0AC','PT140122DKTK5AM','PT140122CD7A4AM','PT140122ADA93AL','PT140122C7MH9BC','PT140122D6PU3BC','PT140122AN2B2AM','PT140122B0AZ7BC','PT1401229TB83AL','PT140122CJCK3AB','PT140122D6TW5AN','PT140122CD202BF','PT1401229GHU7AS','PT140122E0895AB','PT140122CW7Y9AC','PT1401221G2E5AO','PT140922AE5G5AP','PT140922BQS41AE','PT140922D60X3AP','PT140922AHRV5AP','PT140122BBJU0AB','PT140922ANFR8AK','PT140922CKZP1AK','PT140922CVGV3AK','PT140122AYHP1AE','PT140122CRHT2BF','PT140122DAYZ4BC','PT140122B18W5AB','PT140122AXHC9AB','PT140122CY7P0AB','PT140122C3C21AM','PT1401228GXR3AS','PT140122DUCV5AB','PT1401229SB39AB','PT140122EEU79AC','PT140122CCQ34AK','PT1409228X5W5AE','PT140922D0F68AM','PT140922B4CB7AP','PT1401229YCQ7BC','PT140122A4CV6AP','PT140122BAT41AO','PT140122DD5D0BA','PT044322C66V4AT','PT140922CGEP1AP','PT140922C8S65AM','PT140122D1P89AF','PT140922AV650AM','PT1409229CWS7AP','PT14092284QD2AP','PT140922BGYD4AE','PT140922CNHD8AE','PT140922CHCE4AK','PT140122D44S3AC','PT140122BJWY8AM','PT140122DMBF3AG','PT140122DWBV1AH','PT140122CU1H0AW','PT140122D8JD2AC','PT1401229KKP2AL','PT140122DTQZ2AC','PT1401229FWZ2AM','PT140122DZED7AH','PT140122EEB94AH','PT140122BPN24AC','PT140122CNU68AM','PT140122AUMR9AB','PT140122CGM70AC','PT140122AH2Q6AM','PT140122CGB47AM','PT140122DTGP9AM','PT140122AREZ4AM','PT140122A7UP4AC','PT140922BW3R4AP','PT140122E6Q43AC','PT140122A0BT7AM','PT140122B2KR0AC','PT140122BA241AM','PT140122C7889AS','PT140122BM3B1AM','PT140122C7X74AM','PT140122DWV16AM','PT140122D5U07AM','PT1409229RAD9AK','PT140122C4MX6AM','PT140122DSCK7AM','PT14012283EC6AM','PT140122BYQV7AC','PT1401229AZS2AM','PT140122BBDF8AC','PT140122C9YA1AI','PT140122E7M86AM','PT140122A3DK0AS','PT140122BYHX6AB','PT140122BSQX0AS','PT140122DKF05AB','PT140122D7V28BF','PT140122B93W5BF','PT14092299B22AM','PT14092293HV5AP','PT140122BV7H1AL','PT140122BS4B1AH','PT1401229GWM4AM','PT140922AKMX1AK','PT140122DGXD1AQ','PT140122BZ6Z7BF','PT140122CM5Q7BC','PT140122BBR48BF','PT1401229TPD4BC','PT140122AV2R6AQ','PT140122D2QX7AF','PT140122DTPJ5AM','PT140122C7439AM','PT140122D7E46AL','PT1401229QNT5AC','PT140122AGJ05AL','PT140122AU1W9AL','PT1401229ZTE9AC','PT141522B9V15AX','PT140122DM499AM','PT140122BQCU3AM','PT140922AJ3N7AK','PT141522D5GU9AX','PT140122DHKZ7AM','PT140122AKCW1AC','PT140122CV6B5AM','PT141522AM8Z4AX','PT141522AM8Z4AX','PT140122BFPG7AC','PT140122BPF00BD','PT140122A3642AB','PT140922BBEZ1AK','PT140122DY7Q7AQ','PT140122CKBX4BF','PT1401229N9D1AM','PT140122C7WG1AB','PT140122CD2R3AC','PT140122CZWR7AB','PT140122CVJH7AF','PT140122AYDT0AM','PT140122A3NB2AB','PT140122B0C14AS','PT140922BBFU8AK','PT1409229SKU9AK','PT140122905Z3AC','PT140122DKJM2BC','PT140122CYKK6AB','PT140922A5DR5AM','PT140122BZA53AT','PT140922E2057AK','PT140922BA879AK','PT140122BSDV3AB','PT140122BPJC3AB','PT140122EFHT6AC','PT140122B00F3AS','PT140122B5C99AB','PT140122DYYP9AB','PT140122ADD29AB','PT140122AMZU3AB','PT140122B8659AC','PT140122ASWE7AE','PT140122CAHN8BC','PT140122BN7R1AM','PT140122CZ8K8BF','P14011YPXAKAQ','PT140122AEFH5AQ','PT140122BZNF5BC','PT140122BQM21AC')
;







select
    pr.pno
    ,convert_tz(pi.created_at, '+00:00', '+08:00')  揽收时间
    ,convert_tz(pr.routed_at, '+00:00', '+08:00')  标记拒收时间
    ,date(convert_tz(pr.routed_at, '+00:00', '+08:00')) 标记拒收日期
    ,pi.client_id 客户ID
    ,ddd.CN_element 拒收二级原因
    ,pr.store_id 操作网点ID
    ,dp.store_name 操作网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
from ph_staging.parcel_route pr
left join ph_staging.parcel_info pi on pi.pno = pr.pno
join ph_staging.ka_profile kp on kp.id = pi.client_id
left join dwm.dwd_dim_dict ddd on ddd.element = json_extract(pr.extra_value, '$.rejectionCategory') and ddd.db = 'ph_staging' and ddd.tablename = 'diff_info' and ddd.fieldname = 'rejection_category'
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = pr.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
where
    pr.route_action = 'DELIVERY_MARKER'
    and pr.routed_at >= '2023-07-31 16:00:00'
    and pr.routed_at < '2023-08-13 16:00:00'
    and pr.marker_category in (2,17)
    and pi.client_id in ('CA3691','BA0643','CA2953','BA0588','BA0631','CA3535','BA0546','BA0663','BA0632','BA0543','BA0496','BA0660','BA0617','BA0642','BA0658','BA0646','AA0150','BA0659','BA0592','CA3362','BA0544','BA0622','CA0590','CA0198','BA0700','CA2853','CA3473','BA0682','CA3689','BA0388','BA0459')
# group by 1,2

;




select
    date(vrv.ticket_created_at) 日期
    ,count(distinct if(bc.client_name = 'lazada', vrv.link_id, null)) lazada需回访总量
    ,count(distinct if(bc.client_name = 'shopee', vrv.link_id, null)) shopee需回访总量
    ,count(distinct if(bc.client_name = 'tiktok' and vrv.violation_remark = 3, vrv.link_id, null )) tiktok3次派送需回访量
    ,count(distinct if(bc.client_name = 'tiktok' and vrv.violation_remark > 3, vrv.link_id, null )) tiktok超3次派送需回访量
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
where
    vrv.type = 8
    and vrv.ticket_created_at >= '2023-08-01'
group by 1


;



with t as
(
    select
        de.pno
        ,de.dst_store_id
        ,de.dst_store
        ,de.dst_region
        ,de.dst_piece
        ,pi.state
        ,pi.dst_phone
        ,pi.dst_home_phone
        ,if(pcd.pno is not null , 'y', 'n') change_store
        ,max(pcd.created_at) pcd_create_at
    from ph_staging.parcel_info pi
    left join dwm.dwd_ex_ph_parcel_details de on de.pno = pi.pno
    left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
    left join ph_staging.parcel_route pr on pr.pno = de.pno and pr.route_action = 'PENDING_RETURN'
    left join ph_staging.parcel_change_detail pcd on pcd.pno = pi.pno and pcd.field_name = 'dst_store_id' and pcd.new_value != pcd.old_value
    where
        pi.state not in (5,7,8,9)
        and bc.client_id is null
        and pr.pno is null
    group by 1
)
select
    count(if(a.尝试天数 = 3, a.pno, null)) 3次派送量
    ,count(if(a.尝试天数 > 3, a.pno, null)) 3次以上派送量
from
    (
        select
            t1.pno
            ,t1.dst_store 目的地网点
            ,t1.dst_store_id 目的网点ID
            ,t1.dst_piece 目的地片区
            ,t1.dst_region 目的地大区
            ,case t1.state
                when '1' then '已揽收'
                when '2' then '运输中'
                when '3' then '派送中'
                when '4' then '已滞留'
                when '5' then '已签收'
                when '6' then '疑难件处理中'
                when '7' then '已退件'
                when '8' then '异常关闭'
                when '9' then '已撤销'
            end as `包裹状态`
            ,t1.dst_phone 收件人电话
            ,t1.dst_home_phone 收件人家庭电话
            ,count(distinct ppd.mark_date) 尝试天数
        from t t1
        left join
            (
                select
                    td.pno
                    ,date(convert_tz(tdm.created_at, '+00:00', '+08:00')) mark_date
                from ph_staging.ticket_delivery td
                join t t1 on t1.pno = td.pno
                left join ph_staging.ticket_delivery_marker tdm on tdm.delivery_id = td.id
                where
                    if(t1.change_store = 'n', 1 = 1, tdm.created_at > t1.pcd_create_at)
                group by 1,2
            ) mark on mark.pno = t1.pno
        left join
            (
                select
                    ppd.pno
                    ,date(convert_tz(ppd.created_at, '+00:00', '+08:00')) mark_date
                from ph_staging.parcel_problem_detail ppd
                join t t1 on t1.pno = ppd.pno
                where
                    ppd.diff_marker_category not in (7,22,5,20,6,21,15,71)
                    and if(t1.change_store = 'n', 1 = 1, ppd.created_at > t1.pcd_create_at)
                group by 1,2
            ) ppd on ppd.pno = mark.pno and mark.mark_date = ppd.mark_date
        where
            ppd.mark_date is not null
        group by 1
    ) a
;








select
    hsi.staff_info_id 员工ID
    ,hsi.name 姓名
    ,ss.name  网点
    ,hjt.job_name 职级
    ,hsi.mobile 联系电话
from ph_bi.hr_staff_info hsi
left join ph_staging.sys_store ss on ss.id = hsi.sys_store_id
left join ph_bi.hr_job_title hjt on hjt.id = hsi.job_title
where
    ss.name  in ('CLK_SP' ,'CUT_SP')
    and hsi.state = 1
    and is_sub_staff = 0

;







select
    t.*
    ,case
        when cdt.state != 1 and cdt.created_at > date_add(t.date_d, interval 16 hour ) then 'n'
        when cdt.state != 1 and cdt.created_at <= date_add(t.date_d, interval 16 hour ) then 'y'
        when cdt.state = 1 and cdt.created_at < date_add(t.date_d, interval 16 hour ) and cdt.updated_at > date_sub(t.date_d, interval 8 hour) then 'y'
        else 'n'
    end diff_or_not
from tmpale.tmp_ph_pno_lj_0808 t
left join ph_staging.diff_info di on di.pno = t.pno
left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id


;



select
    vrv.link_id 单号
    ,bc.client_name 客户
    ,ss.name 网点
    ,vrv.violation_remark 尝试派送次数
    ,vrv.mobile 客户联系方式
    ,smp.name 片区
    ,smr.name 大区
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on vrv.client_id = bc.client_id
left join ph_staging.sys_store ss on ss.id = vrv.store_id
left join ph_staging.sys_manage_piece smp on smp.id = ss.manage_piece
left join ph_staging.sys_manage_region smr on smr.id = ss.manage_region
where
    vrv.type = 8
    and ss.province_code = 'PH14'
    and vrv.visit_state = 1

;


with t as
(
    select
        pi.pno
        ,pi.dst_store_id
        ,pi.state
        ,pi.dst_phone
        ,pi.dst_home_phone
        ,if(pcd.pno is not null , 'y', 'n') change_store
        ,max(pcd.created_at) pcd_create_at
    from ph_staging.parcel_info pi
    left join dwm.dwd_ex_ph_parcel_details de on de.pno = pi.pno
    left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
    left join ph_staging.parcel_route pr on pr.pno = de.pno and pr.route_action = 'PENDING_RETURN'
    left join ph_staging.parcel_change_detail pcd on pcd.pno = pi.pno and pcd.field_name = 'dst_store_id' and pcd.new_value != pcd.old_value
    where
        pi.state not in (5,7,8,9)
        and bc.client_id is null
        and pr.pno is null
    group by 1
)
select
    t1.pno
    ,dp.store_name 目的地网点
    ,t1.dst_store_id 目的网点ID
    ,dp.piece_name 目的地片区
    ,dp.region_name 目的地大区
    ,case t1.state
        when '1' then '已揽收'
        when '2' then '运输中'
        when '3' then '派送中'
        when '4' then '已滞留'
        when '5' then '已签收'
        when '6' then '疑难件处理中'
        when '7' then '已退件'
        when '8' then '异常关闭'
        when '9' then '已撤销'
    end as `包裹状态`
    ,t1.dst_phone 收件人电话
    ,t1.dst_home_phone 收件人家庭电话
    ,count(distinct ppd.mark_date) 尝试天数
from t t1
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = t1.dst_store_id and   dp.stat_date = date_sub(curdate(),interval 1 day)
left join
    (
        select
            td.pno
            ,date(convert_tz(tdm.created_at, '+00:00', '+08:00')) mark_date
        from ph_staging.ticket_delivery td
        join t t1 on t1.pno = td.pno
        left join ph_staging.ticket_delivery_marker tdm on tdm.delivery_id = td.id
        where
            if(t1.change_store = 'n', 1 = 1, tdm.created_at > t1.pcd_create_at)
        group by 1,2
    ) mark on mark.pno = t1.pno
left join
    (
        select
            ppd.pno
            ,date(convert_tz(ppd.created_at, '+00:00', '+08:00')) mark_date
        from ph_staging.parcel_problem_detail ppd
        join t t1 on t1.pno = ppd.pno
        where
            ppd.diff_marker_category not in (7,22,5,20,6,21,15,71)
            and if(t1.change_store = 'n', 1 = 1, ppd.created_at > t1.pcd_create_at)
        group by 1,2
    ) ppd on ppd.pno = mark.pno and mark.mark_date = ppd.mark_date
where
    ppd.mark_date is not null
    and dp.province_code = 'PH14'
group by 1
having count(distinct ppd.mark_date) >= 3


;



select
    vrv.link_id 单号
    ,bc.client_name 客户
    ,vrv.client_id 客户ID
    ,vrv.violation_remark 尝试派送次数
    ,ddd.CN_element 计入多次尝试派送回访前的标记
    ,ss.name 网点
    ,smp.name 片区
    ,smr.name 大区
    ,vrv.ticket_created_at 回访任务创建时间
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
left join dwm.dwd_dim_dict ddd on ddd.element = json_extract(vrv.extra_value, '$.marker_category') and ddd.db = 'ph_staging' and ddd.tablename = 'diff_info' and ddd.fieldname = 'diff_marker_category'
left join ph_staging.sys_store ss on ss.id =vrv.store_id
left join ph_staging.sys_manage_piece smp on smp.id = vrv.piece
left join ph_staging.sys_manage_region smr on smr.id = vrv.region
where
    bc.client_name = 'tiktok'
    and vrv.ticket_created_at >= '2023-08-01'
    and vrv.type = 8
    and vrv.violation_remark > 3
;
select json_extract(vrv.extra_value, '$.marker_category')  from nl_production.violation_return_visit vrv where vrv.id = 4360323

;

select
    pi.pno
    ,pi.dst_phone
    ,pi.dst_home_phone
from ph_staging.parcel_info pi
where
    pi.pno in ('PT073122DJR94BF','PT370422DBQ18AS','PT520722BTH36AK','PT151622FAR19CB','PT150422GBGJ7AO','PT190522FMFX6AS','PT271522DRPZ8AK','PT390622BSPA7AT','PT121122G6795AH','PT020622CHZR2AP','PT071422E3J26AC','PT062622FNJF6AG','PT401922CB7F0BB','PT630222CWBT5AC','PT401422D2AZ4AF','PT210222EVNE7AK','PT070322CTH06AC','PT080422FMJY4AF','PT241922EC6K8AW','PT192522ENRX2AN','PT240622B1YD8AQ','PT160422DF056AC','PT203922CT9Y0BQ','PT344522DAJ97BE','PT612622DZDD5AH','PT192422FWY79BO','PT160722EXKZ0AI','PT150522F37C5BJ','PT150222CYRQ5AA','PT062522FHVR0AA','PT110322EYRV2AN','PT5207229CWG6AK','PT242422D7Y86AM','PT240522BEB62AJ','PT210422ES542BA','PT180622G5BX3CB','PT791122FRAU3AI','PT241822EBJF9AK','PT180222FBKS3AI','PT613022FR8P7AN','PT261222DR9M9AS','PT612522EDB28AP','PT610622E0Y96AV','PT140922G72V2AR','PT641022BM982AH','PT611822FWB08BQ','PT612022FPUM1CU','PT612722DHZP5AH','PT611822DB9T4AV','PT611722G00E3BA','PT611722F2QF1AO','PT070122D5HW3AQ','PT612022G2PA3EK','PT612722EEFH0AF','PT260122DDVX5AT','PT131722FA814AD','PT611822CBKB5AS','PT612722D1884AK','PT612722GCET9AD','PT044222FJNB8AN','PT611622G0HX0AJ','PT611622DH5E8AE','PT070822DSV98AZ','PT044222G9B20AA','PT171422FR1C5CF','PT612022FHW97FC','PT612322CWYJ1AK','PT611822DBR94EU','PT611822EU3N0EW','PT611822DBH34DX','PT611822FP365BE','PT611822E2NB4EK','PT261122DWKX8AS','PT612022FG970GF','PT800322FPPV7BG','PT800522FJ312BH','PT010522EN488BB','PT350622BS6K7AP','PT230322EVAU2AH','PT070222FT3N4BS','PT072422FC182AR','PT072422FC0C4AR','PT350822AKUE6AF','PT120722E3H33AB','PT390622BA2F5AX','PT390922DA4T9CE','PT080322F6SX9AM','PT660622D5QG6AH','PT132722ESKA0AD','PT611722E4XR6AE','PT612722DN3H3AA','PT612322G0CH8BD','PT611822CUNS6AW','PT611022FSDG9BQ','PT611822FM8N7AC','PT611822E6W92AF','PT261222D2MZ1AY','PT041422ETA37AM','PT331722CGFC3AI','PT122022FGSC2AG','PT800822DP9G1AM','PT352722DDZ09AN','PT122322FXEV1AF','PT062922FNTV0BV','PT070822CPJ73BO','PT490122CHD06AN','PT370422DGMV8AS','PT230522DDS68AZ','PT090122F8TH8AD','PT150422EN6C4AQ','PT192522FNSN2AO','PT150922FPD49AN','PT141622F7HB9AD','PT141622FM6W4AJ','PT611822D06B1FI','PT611822G6E88AW','PT140922EBNC7AP','PT612522FNY58AE','PT612722G84G4AL','PT612722DSFS4AL','PT610622G1EX2FG','PT612822DSGA3BR','PT613022FR4W6AE','PT612522CCME8AM','PT230322BQPK1AL','PT073522FUGQ5AY','PT192522FNWN0AN','PT151622FNFA2BP','PT210222DJND6AC','PT251122E1NX8AZ','PT122022F6MG1AG','PT080322FA0R2AQ','PT612022FSXD4GS','PT350222CQNM5AE','PT122022FQ522BS','PT660222D4H42AH','PT612822F8VV6CX','PT140122DS6B7AV','PT611822FAZZ3EP','PT141522FD9P3AL','PT141522F2A99AJ','PT140122EHP54AO','PT660622D7925AV','PT121222EV8E1AA','PT062922FHT87BB','PT062922FDRJ0AM','PT270922D8ND8AT','PT122322G9XS1AI','PT660622EGW69AH','PT180322EC2R1BJ','PT790122CBTW8AF','PT010522EENU9AC','PT180622G3G25AX','PT180422FKBT8AN','PT181522FKKB1AG','PT210222EDDQ0AE','PT402122CAQ64AM','PT181922F6TS3AF','PT210522EBVZ3AA','PT210522FGZZ5AA','PT400222C4665BD','PT240622D7390AN','PT630522F4DF2AT','PT630222D0FR0AJ','PT790922FR0W3AB','PT141622FNVP3AH','PT611822F9Y24FI','PT611822FGP43FI','PT612022F7YS1CL','PT612722F8327AL','PT170622FQX30AM','PT130822F3JY5AM','PT140922FS9D5AL','PT191122D74V2AA','PT150222FD8G9AL','PT062922EYRC8AG','PT062922F8Y28AY','PT090322EBMW7AN','PT800822DQ9R4CG','PT801222F7C88AA','PT121022F11M5AH','PT210822F5CB9AJ','PT210822G78V8AJ','PT0430229FUH3AJ','PT192522EF515AB','PT613022EZA50AB','PT611722DBA02AI','PT610822FKRV2AI','PT262122B3EM8AI','PT140122FF604BF','PT301522DKYZ1AD','PT062922FDMQ1AL','PT190422F4D68AL','PT204122CHS79AS','PT611822FZWJ7EO','PT640222F96F9EE','PT640222F0PD8AA','PT611822F1V50AE','PT044122FUVK8AQ','PT141522EW1S8AL','PT043122D38H2AA','PT130322F2TZ7CB','PT612722FZZU9AE','PT613022G4SE8AO','PT610622GBGU8EE','PT110622FYKJ3AD','PT790122DEA51AE','PT070822FRT92AA','PT231122EDJY3AF','PT071322FEE76AG','PT110322FMSA3AF','PT160522BR819AA','PT161422D5826AH','PT161422EE3S9AH','PT210522FH3W2AA','PT322122BSF59FD','PT140722FZHJ8AX','PT612322FU5H3AS','PT140122ERNQ3AG','PT612322G6BX0AS','PT612422F5HB6AJ','PT613022FCM14AJ','PT140922G5GB5AC','PT062922F7MU4BO','PT230322CA9C5AM','PT072622E9UT6AT','PT070822CV1P3BM','PT800822CEWU2CK','PT801222CNXR6AN','PT121322EC3T8AF','PT021422FBP90AZ','PT390922B1NF1AN','PT380822B7PU9AO','PT340422D2E21AG','PT221222CJ3B0AY','PT201822E8W86AB','PT611822FHJU2DK','PT362022D2PT4AE','PT341922CP2R5AJ','PT341922DRQX1AK','PT190222FG9X7AK','PT150222F1U64AA','PT150522FJ705BH','PT230322DWEZ7AO','PT071322F3YC7AJ','PT062922F1D66BO','PT110622FKFW4AB','PT061722DYNN3BC','PT190522DYZW9AU','PT121022E8GK7AA','PT121722G67X9AB','PT122022FRB18AG','PT420722B7YQ7CJ','PT122022F7S12BE','PT801122EHXP0AI','PT800422CHJR6AF','PT352422CD7C0BJ','PT271522DBZN5BL','PT121522FS7N7AQ','PT190322DZHT3AM','PT621022EWMH5AF','PT181022D1XB5AE','PT611022DF441AK','PT243722EHSM0AL','PT210522ETS09AB','PT141622GACU3AI','PT261222C6689AS','PT612722G0996AA','PT612722FWZ30AD','PT140422FGT15AS','PT171422CCFS2BY','PT611322ERCY8AB','PT641022EZR93AH','PT611822DZA69EU','PT611822F9C74ET','PT611822FG7T9CN','PT611822G2HX5BQ','PT611522FTND3AA','PT612022FPZD6GR','PT182222DKYP6AB','PT242422B8W59AI','PT182322F3512AF','PT210222G1169AI','PT011222EC467CZ','PT321522APUT0BB','PT243022CSUD3AU','PT230322ET7E9AO','PT370422B1A89AI','PT230322BAPZ4AG','PT111022ESNX9AS','PT062322D2466AC','PT230722BUYQ5AB','PT110722ED7P0AI','PT060822D1DD8AY','PT073522EKM95AO','PT612022F0BT0HF','PT140122EV1K3AD','PT611522FJGQ6AE','PT262122B9KT3AM','PT612022FQ1X2CS','PT610922FS0Z1AE','PT261522AT1E0AP','PT261122A76D5AH','PT141622F83C7AZ','PT042522DGMW2AR','PT140622G3MK2AI','PT610322DFNU1AC','PT612022DUZE6GD','PT140122ERQS1AV','PT611822E2WK4AY','PT611822G6FE7FH','PT611822G95X9DR','PT611822E9T72DD','PT611122D89X4AT','PT611822FRHP2EI','PT130222DQ945AF','PT611822E5VX1DW','PT611022EX944AF','PT640222EU6J2AX','PT612322F0YF1AH','PT044822DPPA2AO','PT260622B5P77AG','PT190322G4V92AV','PT180622DH1E2AN','PT241522EFH61AR','PT243722CFKS1AK','PT230322DTWP8AT','PT072222EB2M1AC','PT110422E1J85AZ','PT062922F91R4BP','PT230322DGTB7AM','PT230722C9AA9AY','PT210222FWAR1AB','PT321522D16A4AJ','PT211322FQU16AA','PT210222DFWT2AE','PT180822FVRT5AP','PT211322D2GH5AE','PT612322F1R73AD','PT612722E6SN8AH','PT613022DF5Q3AB','PT140722FFTG3AP','PT611622FUD96AN','PT611622EP3C8AB','PT140122F3060AE','PT140122EUZJ2AD','PT043822GFG16AC','PT611722G8A75AM','PT211322FEKU7AE','PT611722FVE75AG','PT612022DH3P7GV','PT260522B1MJ9AH','PT141822FG5E7AD','PT260122CM921AA','PT611822G7WB5AH','PT640222D0EG8DS','PT611522FBT85AA','PT612022G4JS5GT','PT791022F9SN8AR','PT791022EVW47AO','PT240622DMCK6BF','PT210222GG110AD','PT073522EC1R4AS','PT140322FKHC5AS','PT070822F41U6BJ','PT150522EKXH8BC','PT192822FQRM6AR','PT031422DJNG3AZ','PT160722EG302AJ','PT221122E0R82AM','PT342522D63D3AK','PT192522CF4T8AF','PT160122FTJR6AE','PT031422CSYJ0BZ','PT170422CESE3AI','PT610322FPKB3AA','PT611822FVAK3AQ','PT611822FMCJ2CN','PT611622G8VN4AH','PT612022FR3R4CU','PT611822DQEY8AV','PT612022FNPS1FL','PT612822GBTV8GQ','PT612822FWWF2GX','PT611522FP5J1AA','PT062922CC4E6BD','PT061322FAPY3BM','PT061222EPC54AJ','PT170522EJ937CF','PT031122DDRV6BI','PT151622G65U4BZ','PT151122CFQN9AO','PT161422FNGS0AH','PT790922FF7T1AL','PT182022FKJQ5AS','PT180222DD1M2AX','PT210822E9VN1AA','PT190322FP9A7AX','PT192422EHKP2BU','PT140122FFCX5AH','PT612322FZWA4AS','PT612022ESMA1HF','PT612022FSVD6AQ','PT610122EFX32DW','PT612122FGRA8AU','PT140922F4PX5AE','PT180322CWVB9BQ','PT612722FEC33AA','PT612022F5F24AK','PT613022E3AE0AM','PT611022G7AE2BI','PT640222F46K3BI','PT132822CFRA8BF','PT612022FV9B1GO','PT122022FJN53AP','PT023322FBCU5AQ','PT800922D4MK7AM','PT402322CE9Z4AL','PT192422G07H4AH','PT160722F37B1AG','PT160722EUTZ1AI','PT160722CA915AF','PT150422G87G5AP','PT170522DN4V1BY','PT040422FBAW0AC','PT611822FSPU2FI','PT611822FN262DA','PT611822EFBB6FI','PT044522G2FW0AA','PT641022DH5R6AH','PT130322FAE60AY','PT140922F7R83AK','PT042822F0N28AK','PT132122FNT54AI','PT640222FMVC0BL','PT611822G8G17DS','PT640222DBUG2AP','PT612522DFE05AB','PT140122EWW12AF','PT182022DPU71AS','PT151222FTWT1AC','PT391522CZSN5AR','PT140522D6HM7BE','PT121822FBVN8AD','PT800522E5U53AP','PT080522F9ME3AB','PT100722DHAB9AA','PT241522EUX86AI','PT242422CZ1E8AD','PT180322F87D5CU','PT210222G9576AD','PT210522ESW44AB','PT402722CZG42AW','PT241122CMN01AH','PT19282270QQ0AQ','PT192822G0Y88AQ','PT031422CFWW2CD','PT160122FTJY7AE','PT150522EWRD6BM','PT613022FV8M1AH','PT140922G4VZ7AG','PT610122G1G84GQ','PT611822E46C4CN','PT471722C38N4AZ','PT142122DZK92AB','PT640222F8GP5AB','PT141622F4TW5AO','PT171422EV400BY','PT171422F6VF2AC','PT610222DVFZ3AE','PT130322FDEJ3BA','PT641022FH534AK','PT611822G7X07BR','PT140622G26F8AU','PT240122EWE82AR','PT362022CBFN2AI','PT161422FPR27AI','PT161322C8WU9AB','PT640222FATP2CV','PT640222EYN25EA','PT611622FZXG8AM','PT611722FWVS2AS','PT611622DBUM3AA','PT140922DX365AE','PT043022F8W81AY','PT610122FF001BB','PT261122CYR31AX','PT611822ETNX6EQ','PT611822DF0A5DB','PT611822FG2C6EC','PT612822F6WB0AN','PT611822FC4A6EH','PT141322FQAG4AM','PT612022FFKW2CN','PT611722E6F95AQ','PT612522F1H20AB','PT140722FSNG1AF','PT043522EUWR3AC','PT612822EF6F7CX','PT044622C8CS0AZ','PT140922FSB89AL','PT031422ESF50AQ','PT7301229W4W5AF','PT243722CEP06AG','PT100322DUVV6AI','PT151622G8ND3CU','PT220322DHS38BQ','PT201822F96J7AZ','PT203822FEE01BE','PT612322FJ0H0AQ','PT042222DT499AB','PT611822FXW72BN','PT640222F4062AE','PT611822E7W11EG','PT613022F2RF3AH','PT042022G5XZ4AF','PT130322E5N16CQ','PT261522AWUR2AN','PT171922DRMM7BL','PT130422EME07AU','PT612722FC9F2AH','PT261222B2DA7BA','PT613022DJ662AH','PT141322F2Q83BO','PT612722FE244AG','PT612022FD108CW','PT042222EQEN9AY','PT172322DGQ63AX','PT4710229H6R5AM','PT612122G6CU5AG','PT130822FFRD6AJ','PT611822DDEE7CV','PT041822E9D90AT','PT640622FM3P6AG','PT261022D4N93AF','PT611822G1RV5EF','PT640222DT363DN','PT611822G1A16CP','PT612022FR209AH','PT612022FG3F7GF','PT612622FBHB7AF','PT612622FR361AF','PT150622G6973AY','PT230322EVB08AH','PT110522E5ZK6AD','PT110622FRZM4AH','PT073722DG2Q3BI','PT073522ET1Y9AZ','PT060622F7A10AA','PT022022FE7A5AE','PT122022G3BM2BW','PT331722BHCU6AK','PT660422D7Y56AT','PT080522DB8F8AJ','PT243622D4VP0AM','PT791022FEF81AR','PT012122F1X97AC','PT630522E7KQ1AE','PT630522DPBZ2AT','PT180622G5982CB','PT011122ETF56AJ','PT430922AGK50BB','PT200722ECQE3AE','PT220222D0CZ3AH','PT192822FHZJ8AP','PT160722FEZA8AJ','PT161222F8EE8AB','PT612622D8166AF','PT612322DNWK2AQ','PT612522E8ZP1BE','PT613022G3YV2AM','PT612822DZJ76BI','PT6121226ZXC7AJ','PT650922EGVQ8AF','PT612722D30D5AA','PT613022FJDN2AM','PT140322D7QZ4AU','PT641022FE421AE','PT042422FU1R5BU','PT611822EW7F2BC','PT611822FU181BI','PT612722708D2AF','PT171722FRU65AE','PT130322FH079CA','PT171422DTEC6AK','PT611522DJ2Y0AC','PT612322E8B71AR','PT800922CYW70BG','PT230822CZD85AZ','PT070822F8S97BH','PT060522F3UF0AZ','PT150922FWMF5AR','PT610622DG4K8AY','PT410522A9W59BR','PT150422EJD56AQ','PT190422FKQC1AJ','PT191922E9PJ4AN','PT402322D6MB8AH','PT203822F4YS5AR','PT344422DCYU6AN','PT660622DVYQ3BJ','PT420222B75D1BV','PT241522EWX20BA','PT023422FP3X8AA','PT140122EECH5AH','PT140122CZWP2AL','PT612322FHZA0AQ','PT140122ENNJ0AM','PT261222CX282AA','PT612122EKTZ0AJ','PT611822D6JC7EG','PT140922E9Q13AM','PT612522F9CF6BC','PT612822DKK75AN','PT072522EW390AN','PT060522FF5W9AS','PT120722FB4T8AH','PT021222EWR39AK','PT010522D05D8AB','PT431822D8YS6AS','PT210422FVC96AM','PT243022DJFD6AD','PT151622FCPQ9CB','PT201822FKA12AT','PT192822FP2K1AO','PT360222C0EW1AW','PT161422EEKH7AH','PT402322D5UQ5AH','PT612822D9T27HA','PT613022FCT69AO','PT130322DY7T0AP','PT611822EHHN5DE','PT612122GD8H5AK','PT141122FYEP9AU','PT130322EU169BJ','PT140922FPC84AX','PT610622CU8C7GM','PT140122EJCB5BF','PT611822FQH41BI','PT611822E7WV3AC','PT612522FWE47AP','PT044122EFDC7AW','PT610422DXFR8AI','PT190322G8FF5AS','PT180422FX9Q5AA','PT010522EWDP6BH','PT242422EFHP4AU','PT060222D5E30AH','PT073522DCWX6AY','PT280722BPDP3AI','PT080322EXK81AF','PT271522EXC32BL','PT190322FJR58AV','PT242522CW5J3AA','PT243122D3HE0AI','PT210822G61A2AJ','PT243722EBDZ4BO','PT210622EFHV7AH','PT181222EZF60AE','PT790822EVPM0AG','PT431022BF2J4AH','PT160722DGGV8AC','PT160922F51E6AF','PT150222FJTF6AL','PT362322BVSZ5AA','PT160122F5GS8AP','PT190422DVP58AE','PT161422C2G40AC','PT343322AAQ45AD','PT611822FSAT4DA','PT611822EH3U7CN','PT611822FNP48FI','PT611822FRN26BK','PT612522DKXZ5BC','PT612722DJQW6AJ','PT611922FJRH9AU','PT612822G55R5AY','PT260322BBV24AO','PT041122FW2Y6AW','PT610322EJSK6AF','PT612022DSQF2FY','PT042422D1TY9AY','PT611522D00R2AV','PT612022GE7M7GV','PT041822DGNH1AH','PT130322FJCM7CK','PT640222E72W7AA','PT612122D5VM9AI','PT390622BP2D4AZ','PT071222FRZX5AV','PT110722E3MJ3AP','PT073522F3KC7AY','PT070122F2725AW','PT331222CF773AA','PT121122FV6H3AA','PT122022F7SF0BE','PT7309229NEE0AD','PT180222FYJ00AC','PT400122D0FV2CB','PT210222FG888AO','PT790922EM0N5AI','PT211322G3Z17AE','PT180822F8FR7BD','PT210222FD228AD','PT210222FW1W9AB','PT210522DVRV3AF','PT211122FRHP1AH','PT612022FGED6BE','PT171422DMRX7BJ','PT141722EE5S0AM','PT611822EBR91BJ','PT171922DRCE2BL','PT611622FRF84AG','PT611722D6BD3AS','PT132322EE270AK','PT611922E97W4AM','PT130222CU6R2AL','PT613022DMHX3AR','PT613022DMHP4AL','PT612522FHBJ2AP','PT140722FZGX8AX','PT133122EH6B7AN','PT611422FZ5F4CN','PT261522D9Y74AR','PT611822EBAT2EO','PT261722CFDA6AL','PT611822D6PE4BN','PT640222DE3V6BP','PT130322FJHV8AG','PT044722D93X4AF','PT611822FSV95AR','PT611822EWK54AJ','PT130322EK9S0AF','PT141522FTRK4AD','PT640222CUV98EL','PT613022G3AR5AO','PT170522CN890EA','PT612022G5W57AL','PT041822D2623AF','PT142222FSVK3AI','PT043822FVJ06AQ','PT170522CN8A4EA','PT612722DAHE2AM','PT141022DJX54AO','PT611822F8CJ5CC','PT260522AEPZ2AZ','PT611722FK089AW','PT180322ENJ91CB','PT210222CX9Y4AB','PT210222CZ4G6AB','PT343022D5H64BY','PT160422F6BU1AC','PT271122DV138AM','PT611822EFW17BE','PT611822FR0D4BE','PT044522ENE21AC','PT611822DY9G0EC','PT611822FYAD7AK','PT611822G5BW5CR','PT641022DHRH0AH','PT611822DDER3CR','PT641022DUP58AH','PT140622EXXX5BE','PT140922FS7C1AL','PT612822FD593CX','PT610122FWDG3GN','PT612522FXHK7AR','PT640222FGDD8AD','PT130322FGVB7CT','PT042622EJ855AM','PT011222EUQ57BZ','PT180922FS3V6CV','PT180322FMB28AY','PT520322A5CA6AL','PT072622FF6P0AV','PT031422CFVU0CD','PT190122EXTT3AE','PT221022D72A8AK','PT192822FP065AO','PT161422ER6C1AH','PT611422EUPK9AA','PT140122EUXT4AG','PT041922FGCU0AM','PT612822CYX10AA','PT261222DN5C9AA','PT641022FNZM4AH','PT641022ESJ91AH','PT612022DUV40BH','PT641222EX8R5AH','PT611822F9QV4EP','PT611822EMW20AW','PT611822DQCH9AF','PT641222F6H59AE','PT140622EEYP6AS','PT130322DZHF8AX','PT612722GGK51AP','PT612022E5702GT','PT260522DPYH3AZ','PT612722EGQW3AN','PT612022DKQV9FU','PT132622BRP03AY','PT610522FN537AH','PT611622FZHJ0AE','PT260522DBVV7AZ','PT173122FHDD1BB','PT612022EGS34FU','PT061322FAM38AC','PT110822EN642AA','PT230722CE882AB','PT322122B0YR1BB','PT210122E4FD4AJ','PT180122G04S6AO','PT181922CZ657AF','PT210222F7VN1AB','PT122322E0UK7AK','PT801522D4R22AF','PT354722D88H9AO','PT141622F5D07AA','PT612122FDBZ3AN','PT612122DN6V4AR','PT611822DQ9Y2FI','PT130322CF076AM','PT130322FG514AI','PT611822EX082AJ','PT612522FHMX8AP','PT140122EPS04BF','PT172322DDDT6AX','PT170522FEKR8AL','PT612422G36H2AQ','PT132122FNJK7AI','PT043522EV6A4AC','PT010422FFVY1AM','PT071422CH033AE','PT230522CBSC0AN','PT110722DPKM1AN','PT073522CVZX4AG','PT150222FRY25AA','PT150222G75R1AO','PT150822CDKN5AV','PT410122C9MT1AF','PT151622EJ6Z1AN','PT160722EUAV0AJ','PT151622FG849CF','PT361922CMMZ0AQ','PT121122G9H22AF','PT800522ET0D9BC','PT122222FX5A6AI','PT121022G3QH3AA','PT122222G7336AC','PT132722CX3E8AO','PT130422CG6T1AL','PT612422FVWX5AR','PT042422F0PK8AD','PT261222BT8Y6AZ','PT611622G2XA7AH','PT613022EC900AR','PT790622EZMR9AC','PT790522F2C19AI','PT241222DR4X0AL','PT230722C5FY9AY','PT343122AYVT8AN','PT160122EKEH0BD','PT612722G4ME1AM','PT261222BQGW0AA','PT041722FYXD3AB','PT132622FHQK2AK','PT261022DM799AF','PT611622G2NT2AG','PT132922FKKY0AN','PT611722FT8W2AO','PT041822E0HZ0AT','PT613022FW875AA','PT611822E6HZ4EU','PT611822EP590CK','PT640222E0JF6AN','PT611122DMEG1BO','PT612022F6XQ7FZ','PT612022FG972GF','PT011222DVKG2CW','PT011222F8GN8BJ','PT210522G3X67AE','PT210822G3MJ6AJ','PT150522FDX82BL','PT271522DPT51AG','PT121222ENC91AB','PT023422EU735AM','PT660622F3CD7AR','PT800522FKVU5BH','PT120922E3876AM','PT021422F2HW0BG','PT660422F9BE6AT','PT780422F0P56AM','PT130322E8K75AI','PT130322CV7J4CZ','PT611822DMQV1CR','PT611822F6UY1DD','PT140122G6YZ5AG','PT260622AGYA3AU','PT141522EVZS5AL','PT043122BKD00AR','PT131922F4HE8AB','PT612422FRTN4AP','PT612022EGHG3AH','PT612822F98X2ED','PT180622G3KT4AX','PT431822CHME2AA','PT790222EZX06AE','PT242422EFAA4AN','PT182022EU4F8AX','PT620122FU8H7AB','PT211322GE024AE','PT790922FGYT9AI','PT011222DT3M3BX','PT210222G8966AD','PT610522G6TX5CS','PT612122G87M7AO','PT171422CBYB3CB','PT612022FCQ73GS','PT612722ETPG7AA','PT612722F30Q4AA','PT612722FF2U3AA','PT612722FGZ48AI','PT130322CYSR8CI','PT044622EUMB9BC','PT260522D2G72BF')
;


SELECT
    vrv.link_id
    ,case pi.state
        when 1 then '已揽收'
        when 2 then '运输中'
        when 3 then '派送中'
        when 4 then '已滞留'
        when 5 then '已签收'
        when 6 then '疑难件处理中'
        when 7 then '已退件'
        when 8 then '异常关闭'
        when 9 then '已撤销'
    end 包裹状态
     , IF( vrv.type = 3, '收件人拒收','多次尝试派送') AS 回访类型
    ,vrv.visit_num 回访次数
    ,dp.store_name 上报网点
    ,dp.piece_name 片区
    ,dp.region_name 大区
    ,convert_tz(di.created_at, '+00:00', '+08:00') 上报时间
    ,date(convert_tz(di.created_at, '+00:00', '+08:00')) 上报日期
    ,case cdt.state
        when 0 then '未处理'
        when 1 then '已处理'
        when 2 then '沟通中'
        when 3 then '支付驳回'
        when 4 then '客户未处理'
        when 5 then '转交闪速系统'
        when 6 then '转交QAQC'
    end 问题件处理状态
FROM nl_production.violation_return_visit vrv
left join ph_staging.parcel_info pi on pi.pno = vrv.link_id
left join ph_staging.diff_info di on di.id = json_extract(vrv.extra_value, '$.diff_id')
left join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di.id
left join dwm.dim_ph_sys_store_rd dp on dp.store_id = di.store_id and dp.stat_date = date_sub(curdate(), interval 1 day)
WHERE vrv.id IN (SELECT MAX(vrv1.id)
                 FROM nl_production.violation_return_visit vrv1
                 WHERE vrv1.type IN (3, 8)
                   AND vrv1.visit_state = 6
                   AND vrv1.overtime IS NOT NULL
                 #AND link_id = 'P61281YC2SKDG'
                 GROUP BY vrv1.link_id)








;




select
    case
        when bc.`client_id` is not null then bc.client_name
        when kp.id is not null and bc.client_id is null then '普通ka'
        when kp.`id` is null then '小c'
    end as  客户类型
    ,pi.pno
    ,ddd.CN_element 问题件类型
    ,case ss2.category
        when 1 then 'SP'
        when 2 then 'DC'
        when 4 then 'SHOP'
        when 5 then 'SHOP'
        when 6 then 'FH'
        when 7 then 'SHOP'
        when 8 then 'Hub'
        when 9 then 'Onsite'
        when 10 then 'BDC'
        when 11 then 'fulfillment'
        when 12 then 'B-HUB'
        when 13 then 'CDC'
        when 14 then 'PDC'
    end 揽收网点类型
from ph_staging.parcel_info pi
left join ph_staging.sys_store ss on ss.id = pi.dst_store_id
left join ph_staging.sys_store ss2 on ss2.id = pi.ticket_pickup_store_id
left join ph_staging.ka_profile kp on kp.id = pi.client_id
left join dwm.dwd_dim_bigClient bc on bc.client_id = pi.client_id
left join ph_staging.diff_info di on di.pno = pi.pno and di.state != 1
left join dwm.dwd_dim_dict ddd on ddd.element = di.diff_marker_category and ddd.db = 'ph_staging' and ddd.tablename = 'diff_info' and ddd.fieldname = 'diff_marker_category'
where
    pi.state = 6
    and pi.dst_store_id in ('PH14010F01', 'PH17080300')

;


select
    ds.pno
    ,pi.duty_store_id
from ph_bi.dc_should_delivery_today ds
left join ph_staging.parcel_info pi on pi.pno = ds.pno
where
    ds.store_id=  'PH14010F01'
    and ds.stat_date = curdate()

;




select
    vrv.link_id
    ,vrv.type
    ,case cdt.state
		  when 0 then '未处理'
		  when 1 then '已处理'
		  when 2 then '正在沟通中'
		  when 3 then '财务驳回'
		  when 4 then '客户未处理'
		  when 5 then '转交闪速系统'
		  when 6 then '转交QAQC'
		  else cdt.state
		  end '客服处理情况'
    ,date_add(di.created_at, interval 8 hour) di_time
from nl_production.violation_return_visit vrv
left join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
left join ph_staging.parcel_info pi on pi.pno = vrv.link_id
left join ph_staging.diff_info di on di.id = json_extract(vrv.extra_value, '$.diff_id')
left join ph_staging.diff_info di2 on di2.pno = pi.pno
join ph_staging.customer_diff_ticket cdt on cdt.diff_info_id = di2.id
where
    vrv.type in (3,8)
    and vrv.visit_state in (3,4,5,6,7)
    and di.state = 0

;

select
    bc.client_name
#     ,vrv.link_id
#     ,vrv.visit_state
#     ,vrv.created_at
    ,count(if(vrv.visit_state = 1, vrv.mobile, null)) 待回访
    ,count(if(vrv.visit_state = 2, vrv.mobile, null)) 沟通中
    ,min(convert_tz(di.created_at, '+00:00', '+08:00')) 最早创建时间
from nl_production.violation_return_visit vrv
join dwm.dwd_dim_bigClient bc on bc.client_id = vrv.client_id
left join ph_staging.diff_info di on di.id = json_extract(vrv.extra_value, '$.diff_id')
where
    vrv.visit_state in (1,2)
    and vrv.type = 8
    and vrv.created_at >= date_sub(curdate() , interval 7 day )
group by 1
;


